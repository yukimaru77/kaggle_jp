** @@@ Jupyter Notebook numver 0, the number of votes :188 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€æœ€çµ‚çš„ã« `submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å•é¡Œã¨ç›®çš„
ã€ŒLLM 20 Questionsã€ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³ªå•ã‚’é€šã˜ã¦ç‰¹å®šã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã€åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ä¾å­˜é–¢ä¿‚**: 
  - `immutabledict` ã‚„ `sentencepiece` ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¾ã™ã€‚

- **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã¨åˆæœŸåŒ–**: 
  - ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«ã¯Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€ç‰¹ã«`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯7BãŠã‚ˆã³2Bã®ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æŒ‡å®šã—ãŸãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«é¸æŠã—ã¦ã„ã¾ã™ã€‚

- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: 
  - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹**: 
  - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’ãã‚Œãã‚Œæ‹…å½“ã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯å†…éƒ¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦æ­£ã—ã„è³ªå•ã‚„ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### å‡ºåŠ›
æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚ã“ã®æˆæœç‰©ã«ã¯ã€ã™ã¹ã¦ã®å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒå”èª¿ãƒ—ãƒ¬ã‚¤ã«åŸºã¥ã„ãŸæ¨ç†ã‚’è¡Œã†ãŸã‚ã®å‡ºç™ºç‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚å‚åŠ è€…ã¯ã“ã®åŸºç›¤ã‚’å…ƒã«ã€è‡ªã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚„æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã•ã‚‰ã«æ”¹å–„ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions** ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã® **Submit to competition** è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ *Output* ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz` ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹ **Submit Agent** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/  # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # KAGGLE_AGENT_PATHã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # æŒ‡å®šã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆ¥ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b  # gemmaãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
from gemma.model import GemmaForCausalLM  # gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")  # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"  # ä»–ã®ãƒ‘ã‚¹ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

class GemmaFormatter:
    _start_token = '<start_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        self._few_shot_examples = few_shot_examples  # Few-shotä¾‹ã®ä¿å­˜
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self.reset()  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¿½åŠ 
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotä¾‹ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œé †åºã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †åºã‚’å¾ªç’°ã•ã›ã‚‹
        for fmt, turn in zip(formatters, turns):  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã¨ã‚¿ãƒ¼ãƒ³ã‚’çµåˆ
            fmt(turn)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å¤‰æ›´
    yield
    torch.set_default_dtype(torch.float)  # å…ƒã®dtypeã«æˆ»ã™

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
        self._device = torch.device(device)  # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant  # é‡å­åŒ–è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')  # é‡ã¿ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å¿œç­”ã‚’å¾—ã‚‹
        response = self._parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
        print(f"{response=}")  # å¿œç­”ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                'top_p': 0.1,  # ãƒˆãƒƒãƒ—ç¢ºç‡
                'top_k': 1,  # ãƒˆãƒƒãƒ—Kã®è¨­å®š
        }
        response = self.model.generate(  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            prompt,
            device=self._device,
            output_len=max_new_tokens,  # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,  # ãã®ä»–ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        else:
            keyword = match.group().lower()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–


def interleave_unequal(x, y):
    return [  # ä¸å‡ä¸€ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")  # è³ªå•ã™ã‚‹ã‚ˆã†æŒ‡ç¤º
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰äºˆæƒ³ã®æŒ‡ç¤º
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "Is it a person?"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•
            else:
                question = match.group()  # æŠ½å‡ºã—ãŸè³ªå•
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®äºˆæƒ³ã‚’è§£æ
            return guess
        else:
            raise ValueError("Unknown turn type:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='user')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")  # å›ç­”æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # å›ç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no'  # "yes"ã§ã‚ã‚Œã°yesã€ãã®ä»–ã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "You are an AI assistant designed to play the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š

few_shot_examples = [  # Few-shotä¾‹ã®è¨­å®š
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆOut of Memoryï¼‰ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "Agent not initialized."  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    return agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™

def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    if response is None or len(response) <= 1:  # å¿œç­”ãŒç©ºã‹é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆ
        return "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response  # é€šå¸¸ã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2  # submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Samar Elhissi
> 
> ä¾‹ã‚’ã‚ã‚ŠãŒã¨ã†ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„â€¦ã“ã®LLMã¯å¤šãã®è¨ˆç®—ã‚’å¿…è¦ã¨ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯å¼·åŠ›ãªGPUãŒå¿…è¦ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã€ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚
> > 
> > 

---

> ## Michael Kamal 92
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€few_shot_examplesã«ã¤ã„ã¦è³ªå•ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> > ä¾‹ãˆã°ã€( 'is it place?', 'yes-or-no' )ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€ãã‚Œã¨ã‚‚( 'is it place?', 'yes', ) ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'Now guess the keyword' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'no', 'Now guess the keyword', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿã©ã‚ŒãŒæ­£ã—ã„è³ªå•ã€å›ç­”ã€äºˆæ¸¬ã®ä½œã‚Šæ–¹ã§ã™ã‹ï¼Ÿ
> 
> ã‚‚ã†ä¸€ã¤ã®è³ªå•ã§ã™ãŒã€Gemmaã¯few_shot_examplesã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ

---

> ## Yukky_2801
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«å¤±æ•—ã—ãŸã¨çµ‚äº†ã—ã¾ã™ã€‚
> 
> submission.tar.gzã‚’ã‚¨ãƒ©ãƒ¼ã¨å…±ã«æå‡ºã§ãã¾ã›ã‚“ã€‚ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è§£æ±ºç­–ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

> ## Andres H. Zapke
> > ã‚‚ã¡ã‚ã‚“ã€Œgemma/pytorch/7b-it-quant/2ã€ã“ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å³å´ã‚’è¦‹ã¦ã€gemmaãƒ¢ãƒ‡ãƒ«ãŒãã“ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
>   
> > ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add Inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)
> > 
> > 
> > > ## Talal Mufti
> > > > ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸå¾Œã€ä¾ç„¶ã¨ã—ã¦å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€bashã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã€ã“ã‚ŒãŒç§ã«ã¨ã£ã¦ã†ã¾ãã„ãã¾ã—ãŸï¼š
> > > > !tar --use-compress-program='pigz --fast --recursive | pv' -f submission.tar.gz -c /kaggle/working/submission . -c /kaggle/input/gemma/pytorch/7b-it-quant/2

---

> ## Muhammad Hadi13
> 
> ãªãœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã«ã€å¸¸ã«1.35MBä»¥ä¸Šã®å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãšã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¤±æ•—ã™ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Ryanã®å‡ºåŠ›ã¯ç´„7GBã§ã—ãŸã€‚ã“ã®ä»¶ã«ã¤ã„ã¦åŠ©ã‘ãŒå¿…è¦ã§ã™ï¼ï¼
> 
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> > tar: gemma/pytorch: Cannot stat: No such file or directory
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸã€‚

> ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’äº‹å‰ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > > 
> > > ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)

---

> ## Ship of Theseus
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community
> 
> 

---

> ## shiv_314
> 
> çš†ã•ã‚“ï¼ä¸€ã¤åŠ©ã‘ãŒå¿…è¦ã§ã™ã€‚gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
> 
> Pythonã®ãŸã‚ã«ã™ã§ã«æ­£ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼

---

> ## dedq
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community

---

> ## Code Hacker
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«tar.gzã‚’æå‡ºã—ã‚ˆã†ã¨ã—ãŸãŒã€å¤±æ•—ã—ã¾ã—ãŸâ€¦

> ## Code Hacker
> > > ã“ã®ãƒ¢ãƒ‡ãƒ«ã«åŒæ„ã—ãªã‹ã£ãŸã€‚ä¸‹ã®èµ¤ã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯â€¦

---

> ## JAPerez
> 
> Great work Ryan!

---

> ## philipha2
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã“ã®ã‚³ãƒ³ãƒšã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚
> æå‡ºç‰©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹submission.tar.gzã‚’ã©ã“ã«ç½®ã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ 
> Submit agentsãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æå‡ºã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ 
> æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
> åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kanchan Maurya
> > > Submit agentsã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã€åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---

> ## vj4science
> 
> Thanks Ryan - this is a good head start to the competition! much appreciated!

---

> ## gb_kwon
> 
> Thank you so much for your COOL guidelines!

---

> ## Andres H. Zapke
> 
> main.pyã§ã€gemma_pytorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼šfrom gemma.configã€‚
> 
> ã“ã‚Œã¯ç§ã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ãŒã€gemmaã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ã€‚
> 
> è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®gemmaãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã®ã¨ã€Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã‚’è©¦ã¿ã¾ã—ãŸãŒã€‚ä½•ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

> ## Duy Thai
> 
> ã“ã‚“ã«ã¡ã¯[@ryanholbrook](https://www.kaggle.com/ryanholbrook)ã€ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è©¦ã—ãŸã¨ã“ã‚ã€ã€Œæ·»ä»˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è¿½åŠ ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ã¯Modelãƒ‘ãƒãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã«ã¤ã„ã¦ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸã¨ãã€ç§ã¯ã“ã‚Œã ã‘ã‚’è¦‹ã¦ã„ã¾ã™ï¼š

> ## Andres H. Zapke
> > > "Models"ã¸è¡Œãã€Gemmaã‚’æ¤œç´¢ã—ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

> ## Duy Thai
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---

> ## Kai_Huang
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã® !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2 ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã¨ãã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸ
> 
> ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kai_Huang
> > > ã‚ã‚ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å…¥åŠ›ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã™ã­ğŸ˜±

> ## D Prince Armand KOUMI
> > > ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆã¯ã€è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

> ## Qusay AL-Btoush
> 
> ã¨ã¦ã‚‚è‰¯ã„ã€Ryan 

---
```

** @@@ Jupyter Notebook numver 1, the number of votes :93 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ç«¶æŠ€ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã¨ãƒ†ã‚¹ãƒˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€LLM 20 Questionsã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ç°¡å˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã—ã€ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã€ŒLLM 20 Questionsã€ã¯ã€2å¯¾2ã®ãƒãƒ¼ãƒ æˆ¦ã«ãŠã‘ã‚‹è¨€è‘‰å½“ã¦ã‚²ãƒ¼ãƒ ã§ã€å‚åŠ è€…ã¯20ã®åˆ¶é™ã•ã‚ŒãŸè³ªå•ã‚’é€šã˜ã¦æ­£è§£ã‚’æ¨æ¸¬ã—ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€Kaggleç’°å¢ƒã§ã“ã®ã‚²ãƒ¼ãƒ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚„å¿œç­”ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®æ–¹æ³•ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

### è§£æ±ºæ‰‹æ³•
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ä»¥ä¸‹ã®ä¸»è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚
1. **ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰**: Pythonã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€è¦³å¯Ÿï¼ˆobsï¼‰ã¨è¨­å®šï¼ˆcfgï¼‰ã‚’å…¥åŠ›ã¨ã—ã€ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå¿œç­”ã‚’ç”Ÿæˆã™ã‚‹4ã¤ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼ˆä¾‹ï¼šsimple_agent1, simple_agent2 ãªã©ï¼‰ã€‚
2. **ç’°å¢ƒã®åˆæœŸåŒ–**: Kaggleã®ç’°å¢ƒã‚’ã€Œllm_20_questionsã€ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®šã‚’ç¢ºèªãƒ»å¤‰æ›´ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
3. **ã‚²ãƒ¼ãƒ ã®å®Ÿè¡Œ**: å®šç¾©ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã€å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
4. **æå‡ºå¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æº–å‚™**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Pythonã‚³ãƒ¼ãƒ‰ã‚’ã€Œmain.pyã€ã«æ›¸ãè¾¼ã¿ã€ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€ç·’ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åŒ–ã—ã¦æå‡ºã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **kaggle_environments**: ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦ã€Kaggleç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

### ãƒ‡ãƒãƒƒã‚°ã¨è¨­å®š
ã¾ãŸã€ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã®ãƒ’ãƒ³ãƒˆã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã‚‹ã®ã‹ã‚’è©³ç´°ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹æ³•ã€ã‚²ãƒ¼ãƒ å®Ÿè¡Œæ™‚ã®è¨­å®šå¤‰æ›´æ–¹æ³•ãªã©ã‚‚èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚„å®Ÿè¡Œçµæœã‚’è¦–è¦šçš„ã«è¦³å¯Ÿã™ã‚‹ãŸã‚ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚‚ææ¡ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€åˆã‚ã¦LLM 20 Questionsã«å–ã‚Šçµ„ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨ç’°å¢ƒã®è¨­å®šã«é–¢ã™ã‚‹å®Ÿè·µçš„ãªã‚¬ã‚¤ãƒ‰ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ç’°å¢ƒã®ãƒ’ãƒ³ãƒˆï¼šãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§LLM 20 Questionsã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•

![robots_playing_20qs_small.png](attachment:0869cff5-c499-4b2c-bccd-227e14e8aa90.png)

LLM 20 Questionsã‚„Kaggleç’°å¢ƒã‚’ä½¿ç”¨ã—ãŸä»–ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä¸Šã§ç’°å¢ƒã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ãŒä¾¿åˆ©ã§ã™ã€‚ã“ã“ã§ã¯ã€å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œãªã„ãƒ’ãƒ³ãƒˆã¨èª¬æ˜ã‚’ç¤ºã—ã¾ã™ã€‚

# ç°¡å˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹

ã‚‚ã—å®Ÿé¨“ã—ãŸã„ã ã‘ãªã‚‰ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯Pythonã®é–¢æ•°ã¨ã—ã¦ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€obsï¼ˆè¦³å¯Ÿï¼‰ã¨cfgï¼ˆè¨­å®šï¼‰ã¨ã„ã†2ã¤ã®å…¥åŠ›ã‚’æŒã¡ã€ãƒ†ã‚­ã‚¹ãƒˆã®å¿œç­”ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€3ã¤ã®turnTypesï¼ˆ"ask"ã€"guess"ã€"answer"ï¼‰ã«å¯¾å¿œã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã€Œanswerã€ã¨ã—ã¦ã®å¿œç­”ã¯ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã«4ã¤ã®ç°¡å˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
def simple_agent1(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent2(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯é³¥ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "é³¥"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent3(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯è±šã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "è±š"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent4(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ç‰›ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ç‰›"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚²ãƒ¼ãƒ ç’°å¢ƒã‚’ä½œæˆã—ã¦è¨­å®šã™ã‚‹

Kaggleç’°å¢ƒã¯ã€`make()`é–¢æ•°ã‚’ç”¨ã„ã¦ã€*ç’°å¢ƒ*åï¼ˆ`"llm_20_questions"`ï¼‰ã¨ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã€ä¾‹ãˆã°*configuration*ã‚„*info*ã§ä½œæˆã•ã‚Œã¾ã™ã€‚ç«¶æŠ€ã¨åŒã˜ã‚ˆã†ã«ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã™ã‚‹ã ã‘ã§ååˆ†ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import kaggle_environments
env = kaggle_environments.make(environment="llm_20_questions")
# ï¼ˆ"No pygame installed"ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã§ãã¾ã™ï¼‰
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
ç’°å¢ƒã‚’åˆæœŸåŒ–ã™ã‚‹ã¨ã€æ¨æ¸¬ã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’`kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword`ã§ç¢ºèªã—ãŸã‚Šå¤‰æ›´ã—ãŸã‚Šã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯: ")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
print(" ")
print("ä¸€éƒ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯ã€ä»£æ›¿ã®æ¨æ¸¬ï¼ˆaltsï¼‰ã®ãƒªã‚¹ãƒˆãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚")
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã¯:")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.alts)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# LLM 20 Questionsã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ä½œæˆã—ãŸç’°å¢ƒï¼ˆ`env`ï¼‰ã‚’ä½¿ã£ã¦ã€ã‚²ãƒ¼ãƒ ã‚’ã“ã®ç’°å¢ƒã§å®Ÿè¡Œã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã¯ã€4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
* "Agent1"ï¼ˆãƒãƒ¼ãƒ 1ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "Agent2"ï¼ˆãƒãƒ¼ãƒ 1ã®å›ç­”è€…ï¼‰ã€ 
* "Agent3"ï¼ˆãƒãƒ¼ãƒ 2ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "Agent4"ï¼ˆãƒãƒ¼ãƒ 2ã®å›ç­”è€…ï¼‰ã€‚ 

ç«¶æŠ€ã§ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¨ãƒšã‚¢ã«ãªã‚Šã€æ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ã®ã„ãšã‚Œã‹ã®å½¹å‰²ã‚’æ‹…å½“ã—ã¾ã™ã€‚

ï¼ˆæœ€åˆã«ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å§‹ã‚ãŸã¨ãã€ç§ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒãƒ¼ãƒ ã®ãŸã‚ã«æ¨æ¸¬è€…ã¨å›ç­”è€…ã®ä¸¡æ–¹ã®å½¹å‰²ã‚’æœãŸã™ã¨æ€ã„è¾¼ã‚“ã§ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ç«¶æŠ€ã§ã¯ä»–ã®èª°ã‹ã¨ãƒšã‚¢ã«ãªã‚Šã¾ã™ã€‚å”åŠ›ã™ã‚‹èƒ½åŠ›ã«ã‚ˆã£ã¦ã€è‰¯ã„çµæœã‚„æ‚ªã„çµæœãŒæ±ºã¾ã‚Šã¾ã™ã€‚ï¼‰
```

---The following area is a Code cell (cell numver is 8)---
```python
%%time
game_output = env.run(agents=[simple_agent1, simple_agent2, simple_agent3, simple_agent4])
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
ã“ã®ä¾‹ã§ã¯ã€ã‚²ãƒ¼ãƒ ãŒã™ãã«å®Œäº†ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å³åº§ã«å¿œç­”ã™ã‚‹ã‹ã‚‰ã§ã™ã€‚å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å¤§è¦æ¨¡ãªLLMã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã€å„ã‚¹ãƒ†ãƒƒãƒ—ã«1åˆ†ã‹ã‹ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€ç·ã‚²ãƒ¼ãƒ æ™‚é–“ãŒ1æ™‚é–“ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼

ã‚²ãƒ¼ãƒ ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¯`game_output`ã§ç¢ºèªã§ãã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ã‚’è¦–è¦šçš„ã«è¦³å¯Ÿã—ãŸã„å ´åˆã¯ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
# æå‡ºå¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹

ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Pythonã‚³ãƒ¼ãƒ‰ã‚’`main.py`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’`submission.tar.gz`ã«ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ç°¡å˜ãªä¾‹ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å…¬å¼ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ãªå®Ÿéš›ã®LLMã‚’ä½¿ã„ãŸã„ã§ã—ã‚‡ã†ï¼ˆhttps://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebookï¼‰ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã¨ã—ã¦LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é…ç½®ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

* ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®`/kaggle/working/submission`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`lib`ã¨ã„ã†ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 12)---
```python
import os
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"
# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¾ã™
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)
    subdirectory_path = os.path.join(submission_directory, submission_subdirectory)
    os.mkdir(subdirectory_path)
```

---The following area is a Code cell (cell numver is 13)---
```python
# libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹ãŸã‚ã®ä¾‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™
import csv
with open(os.path.join(subdirectory_path, "example.csv"),mode='w') as file:
    writer = csv.writer(file)
    writer.writerow(["ç‰›", "é¦¬"])
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®`main.py`ã®Pythonã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
* ç’°å¢ƒã¯`main.py`ã®æœ€å¾Œã®é–¢æ•°ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯`agent_fun()`ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random



# ã‚µãƒ–ãƒŸãƒƒã‚·ãƒ§ãƒ³/libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ï¼‰ã‚’ç½®ã„ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")
sys.path.insert(0, subdirectory_path)


# ä¾‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
with open(os.path.join(subdirectory_path,"example.csv"), mode='r') as file:
    reader = csv.reader(file)
    guess_list = list(reader)
    guess_list = guess_list[0]

# ä¾‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãª"å‹•ç‰©"ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®šã™ã‚‹
animal = random.choice(guess_list)
    
# main.pyã®æœ€å¾Œã®é–¢æ•°ãŒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã«ãªã‚Šã¾ã™
def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask":
        response = f'ãã‚Œã¯{animal}ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã‹ï¼Ÿ'
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"guess"ã®å ´åˆ
    elif obs.turnType == "guess":
        if obs.answers[-1]=="yes":
            response = animal
        else:
            response = "ãƒšãƒ³ã‚®ãƒ³"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        if obs.keyword in obs.questions[-1]:
            response = "yes"
        else:
            response = "no"
        
    return response
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
ã“ã®`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`/lib/example.csv`ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€ç·’ã«æå‡ºã™ã‚‹æº–å‚™ãŒæ•´ã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
!apt install pigz pv > /dev/null
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã®`main.py`ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒãƒ¼ãƒ 1ã®ä¸¡æ–¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã§ãã€ãƒãƒ¼ãƒ 2ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ4ã‚’ä½¿ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 19)---
```python
game_output = env.run(agents=["/kaggle/working/submission/main.py", "/kaggle/working/submission/main.py", simple_agent3, simple_agent4])
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
# ãƒ‡ãƒãƒƒã‚°ã®ãƒ’ãƒ³ãƒˆ

è¨­è¨ˆã‚„ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã†éš›ã«ã¯ã€é€šå¸¸ã€ç’°å¢ƒã‚’ä½œæˆã™ã‚‹éš›ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®ã„ãã¤ã‹ã‚’å¤‰æ›´ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã«ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼š

`env = make(environment, configuration=None, info=None, steps=None, logs=None, debug=False, state=None)`

`env.specification`ã§ä»•æ§˜ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€`configuration`ã‚„ç’°å¢ƒå†…ã§å®šç¾©ã•ã‚ŒãŸä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦å­¦ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã¯èª¬æ˜ãŒå«ã¾ã‚Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å€¤ãŒç¤ºã•ã‚Œã¾ã™ã€‚

æ–°ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å–ã‚Šçµ„ã‚€éš›ã«ã¯ã€çŸ­ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã‚’å¤‰æ›´ã—ã€`debug=True`ã‚’è¨­å®šã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å‡ºåŠ›ã•ã‚Œã‚‹è©³ç´°ãªæƒ…å ±ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ãƒ‡ãƒãƒƒã‚°ã«é©ã—ãŸæ–°ã—ã„ç’°å¢ƒãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 21)---
```python
# ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã€2ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™
debug_config = {'episodeSteps': 7,     # åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã«ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®3ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆask/answer/guessï¼‰ã‚’è¿½åŠ 
                'actTimeout': 5,       # ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯60
                'runTimeout': 60,      # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1200
                'agentTimeout': 3600}  # ä½¿ç”¨ã•ã‚Œãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3600

env = kaggle_environments.make("llm_20_questions", configuration=debug_config, debug=True)
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
æ³¨æ„ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã™ã§ã«æ¨æ¸¬ã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€åˆ¥ã®ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€åŒã˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼
```

---The following area is a Code cell (cell numver is 23)---
```python
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
ãƒ‡ãƒãƒƒã‚°ä¸­ã«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§è¨­å®šã—ãŸã‚Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 25)---
```python
keyword = "ã‚¢ãƒ’ãƒ«"
alts = ["ãã®ã‚¢ãƒ’ãƒ«","ã‚¢ãƒ’ãƒ«"]
kaggle_environments.envs.llm_20_questions.llm_20_questions.category = "ä¾‹"
kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword_obj = {'keyword':keyword,'alts':alts}
kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword = keyword
kaggle_environments.envs.llm_20_questions.llm_20_questions.alts = alts
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã«æƒ…å ±ã‚’å°åˆ·ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1ã«ã€`obs`å†…ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹printæ–‡ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 27)---
```python
def simple_verbose_agent1(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"guess"ã®å ´åˆ
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"
    
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å°åˆ·
    print("====================")
    print(f"ã‚¹ãƒ†ãƒƒãƒ— = {obs.step}")
    print(f"turnType = {obs.turnType}")
    print("obs =")
    print(obs)
    print(" ")
    print(f'å¿œç­” = "{response}"')
    
    
    return response
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
ã“ã®simple_verbose_agent1ã‚’ãƒãƒ¼ãƒ 1ã®ä¸¡æ–¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã¨ã€3ã¤ã®turnã‚¿ã‚¤ãƒ—ï¼ˆask/guess/answerï¼‰ã‚’è¦³å¯Ÿã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 29)---
```python
game_output = env.run(agents=[simple_verbose_agent1,simple_verbose_agent1, simple_agent3, "/kaggle/working/submission/main.py"])
```

---The following area is a Code cell (cell numver is 30)---
```python
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 31)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## bluekeroro
> 
> [@rturley](https://www.kaggle.com/rturley) å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ï¼ã§ã‚‚ã€ã¡ã‚‡ã£ã¨è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®2ã¤ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«llm_20_questions.pyã¨llm_20_questions.jsã¯ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã—ã¾ã™ã‹ï¼Ÿ
> 
> 
> > ## RS Turleyãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼
> > 
> > ãã‚Œã‚‰ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ä»˜éšã™ã‚‹æ¨™æº–çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ä¸Šè¨˜ã®ä¾‹ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ç›´æ¥ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
> > 
> > ã—ã‹ã—ã€ãƒ‡ãƒãƒƒã‚°æ™‚ã«ã¯å‚ç…§ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€kaggle_environmentsã‹ã‚‰ã“ã®ç‰¹å®šã®ç’°å¢ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚è©³ç´°ã¯GitHubãƒªãƒã‚¸ãƒˆãƒªã§ç¢ºèªã§ãã¾ã™ï¼ˆ[https://github.com/Kaggle/kaggle-environments/tree/master/kaggle_environments/envs/llm_20_questions](https://github.com/Kaggle/kaggle-environments/tree/master/kaggle_environments/envs/llm_20_questions)ï¼‰ã€‚
> > 
> > ç‰¹ã«ï¼š
> > 
> > - llm_20_questions.pyã«ã¯ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€å¤§æ–‡å­—ã¨å°æ–‡å­—ã®é•ã„ãŒé‡è¦ã‹ã©ã†ã‹ãªã©ã®è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
> > 
> > - llm_20_questions.jsã¯éå»ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®JavaScriptã§ã™ã€‚ä»¥å‰ã®Kaggleç’°å¢ƒã‚³ãƒ³ãƒšã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•ã‚’è¦–è¦šçš„ã«è¦³å¯Ÿã™ã‚‹éš›ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¤‰æ›´ã™ã‚‹ã®ãŒå½¹ç«‹ã¤ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸãŒã€ä»Šå›ã¯å˜ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å°åˆ·ã™ã‚‹æ–¹ãŒå½¹ç«‹ã¤ã¨æ€ã‚ã‚Œã¾ã™ã€‚
> > 
> > 
> > > ## bluekeroro
> > > 
> > > ã‚ã‹ã‚Šã¾ã—ãŸã€‚è©³ã—ãã¦è¦ªåˆ‡ãªå›ç­”ã‚’ã‚ã‚ŠãŒã¨ã†ã€‚
> > > 
> > > 
> 
> 

---

> ## Matin Mahmoudi âœ¨
> 
> ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯é­…åŠ›çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€[@rturley](https://www.kaggle.com/rturley)ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ã¨æ˜ç¢ºãªèª¬æ˜ã«ã‚ˆã‚Šã€éå¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã™ã€‚ç´ æ™´ã‚‰ã—ã„å‹äººï¼
> 
> 

---

> ## Payam Amanat
> 
> æœ‰ç›Šã§éå¸¸ã«å½¹ç«‹ã¤ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€è¦ªæ„›ãªã‚‹[@rturley](https://www.kaggle.com/rturley) ã‚ã‚ŠãŒã¨ã†ã€‚
> 
> ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¤ã„ã¦ã®æ„è¦‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚Œã°ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚
> 
> 

---

> ## Zeeshan Latif
> 
> [@rturley](https://www.kaggle.com/rturley) ã‚ãªãŸã®ä½“ç³»çš„ã§æ˜ç¢ºãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯éå¸¸ã«æœ‰ç›Šã§ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ï¼
> 
> 
> > ## RS Turleyãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > å½¹ç«‹ã¦ã°å¹¸ã„ã§ã™ï¼
> > 
> 
>
```

** @@@ Jupyter Notebook numver 2, the number of votes :70 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€Œ20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‘ã‘ã¦ã€Hugging Faceã®8Bã¾ãŸã¯ãã‚Œä»¥ä¸‹ã®LLMã‚’æ´»ç”¨ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãŠã‚Šã€è³ªå•è€…ã¯ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åŠ¹ç‡çš„ã«æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ã‚ã‚‰ã‹ã˜ã‚è¨­å®šã•ã‚ŒãŸè³ªå•ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¸€æ–¹ã€å›ç­”è€…ã¯Hugging Faceã®Llama 8B LLMã‚’ä½¿ç”¨ã—ã¦ã€æœªçŸ¥ã®è³ªå•ã«å¯¾ã™ã‚‹ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¸»ãªå‡¦ç†ã¨ã—ã¦ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå«ã¾ã‚Œã¾ã™ï¼š

1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`accelerate`ã€`bitsandbytes`ãªã©ï¼‰ãŒæŒ‡å®šã—ãŸãƒ‘ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚
   
2. **ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ä¿å­˜**: Llama-3-Smaug-8Bãƒ¢ãƒ‡ãƒ«ãŒ4bitå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸ8Bã®Llama3ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚

3. **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ©ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿åˆ†æï¼ˆEDAï¼‰**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹LLMã®å¿œç­”ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã“ã§ã¯ã€å›ç­”è€…ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ**: ãƒ¡ã‚¤ãƒ³ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«`main.py`ã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚è³ªå•ã‚„æ¨æ¸¬ã®å‡¦ç†ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«æƒ…å ±ã‚’ã‚‚ã¨ã«è³ªå•ã‚’æ›´æ–°ã—ã¾ã™ã€‚

5. **Kaggleç’°å¢ƒã§ã®å®Ÿè¡Œ**: Kaggleã®APIã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’é€šã˜ã¦ã€ä½œè€…ã¯è³ªå•è€…ã¨å›ç­”è€…ã®åŒæ–¹ã®å½¹å‰²ã‚’æ‹…ã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè£…ã‚’é€²ã‚ã€Kaggleã®ã€Œ20 Questionsã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦åŠ¹ç‡çš„ãªæ¨æ¸¬ã‚’è¡Œã†æ–¹æ³•ã‚’æ¢æ±‚ã—ã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä¸»ã«`transformers`ã§ã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚ŠLLMã®ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã¨ç”Ÿæˆã®ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œã‚ã‚Œã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# Hugging Face Llama 8B LLM ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ¼ãƒ‰
ã“ã‚Œã¯ã€Kaggleã®ã€Œ20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‘ã‘ãŸHugging Faceã®8Bã¾ãŸã¯ãã‚Œä»¥ä¸‹ã®LLMç”¨ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æˆ‘ã€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`è³ªå•è€…`ã¨`å›ç­”è€…`ã®ä¸¡æ–¹ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è³ªå•è€…ã¯ã€ä½œæˆã—ãŸæ–°æ©Ÿèƒ½ã‚’åŸºã«ãƒªã‚¹ãƒˆã‚„æ½œåœ¨çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰äºŒåˆ†æ¢ç´¢ã‚’è¡Œã„ã¾ã™ï¼ˆæ›´æ–°å‰ï¼‰ã€‚**ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå ´æ‰€ã ã‘ã ã£ãŸæ™‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚**

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€æˆ‘ã€…ã¯ã™ã¹ã¦ã®å…¬çš„LBï¼ˆæ›´æ–°å‰ï¼‰ã®å˜èªã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€**å ´æ‰€**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã„ãã¤ã‹ã®è¿½åŠ åˆ—ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚è¿½åŠ ã—ãŸåˆ—ã¯`å¤§é™¸`ã¨`æœ€åˆã®æ–‡å­—`ã§ã™ã€‚å›ç­”è€…ã¨ã—ã¦Hugging Faceã®Llama 8B LLMã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

è³ªå•è€…ã®ã€Œå°‹ã­ã‚‹ã€å½¹å‰²ã¯**LLMã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“**ãŒã€æ¤œç´¢ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã®ã‚ã‚‰ã‹ã˜ã‚æ±ºã‚ã‚‰ã‚ŒãŸè³ªå•ã®ã‚»ãƒƒãƒˆã§ã‚ã‚Œã°å¤§ä¸ˆå¤«ã§ã™ã€‚ã¾ãŸã€è³ªå•è€…ã®ã€Œæ¨æ¸¬ã™ã‚‹ã€å½¹å‰²ã‚‚ã€ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ãªè«–ç†ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€LLMã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å›ç­”è€…ã¯**LLMã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ãªãœãªã‚‰ã€ä»–ã®Kaggleãƒãƒ¼ãƒ ã‹ã‚‰ã®æœªçŸ¥ã®è³ªå•ã«ç­”ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’`/tmp/submission/lib`ãƒ‘ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¹ã¯ã€æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã«tarballã¨ã—ã¦ã¾ã¨ã‚ã‚‰ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
!mkdir /tmp/submission
```

---The following area is a Code cell (cell numver is 3)---
```python
%%time
import os,sys
os.system("pip install -U -t /tmp/submission/lib accelerate")
os.system("pip install -i https://pypi.org/simple/ -U -t /tmp/submission/lib bitsandbytes")
os.system("pip cache purge")
sys.path.insert(0, "/tmp/submission/lib")
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
# LLMãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ä¿å­˜
ãƒ¢ãƒ‡ãƒ«ã‚’`/tmp/submission/weights`ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ãƒ‡ã‚£ã‚¹ã‚¯ã¨ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã‚’4bitã§ä¿å­˜ã—ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚‚æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã«tarballã¨ã—ã¦ã¾ã¨ã‚ã‚‰ã‚Œã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ã€ŒLlama-3-Smaug-8Bã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€è¿½åŠ ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸLlama-3-8Bã§ã™ã€‚è©³ç´°ã¯HuggingFaceã§ç¢ºèªã§ãã¾ã™[ã“ã¡ã‚‰][1]

[1]: https://huggingface.co/abacusai/Llama-3-Smaug-8B
```

---The following area is a Code cell (cell numver is 5)---
```python
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig
import torch
```

---The following area is a Code cell (cell numver is 6)---
```python
model_name = "abacusai/Llama-3-Smaug-8B"

bnb_config = BitsAndBytesConfig(
    load_in_4bit = True,
    bnb_4bit_quanty_type = "fp4", 
    bnb_4bit_compute_dtype=torch.float16,
    bnb_4bit_use_double_quanty = True,
)

model = AutoModelForCausalLM.from_pretrained(
    model_name,
    quantization_config = bnb_config,
    torch_dtype = torch.float16,
    device_map = "auto",
    trust_remote_code = True,
)
tokenizer = AutoTokenizer.from_pretrained(model_name)
```

---The following area is a Code cell (cell numver is 7)---
```python
model.save_pretrained("/tmp/submission/weights")
tokenizer.save_pretrained("/tmp/submission/weights")
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
# LLMãƒ¢ãƒ‡ãƒ«ã®EDA
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã™ã‚‹LLMã®å›ç­”ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€`å›ç­”è€…`ã«è¡¨ç¤ºã™ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ±ºå®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
import pandas as pd
keywords = pd.read_csv("/kaggle/input/updated-kaggle-keywords/keywords_v2.csv")
keywords.head(1)
```

---The following area is a Code cell (cell numver is 10)---
```python
pad_token_id = tokenizer.pad_token_id
if pad_token_id is None:
    pad_token_id = tokenizer.eos_token_id
```

---The following area is a Code cell (cell numver is 11)---
```python
question = f"ç§˜å¯†ã®å˜èªã¯å›½ã§ã™ã‹ï¼Ÿ"

keyword = "venezuela"
if keyword in keywords.keyword.values:
    row = keywords.loc[keywords.keyword==keyword].iloc[0]
    category = row.category #"åæ‰€"
    continent = row.continent #"åŒ—ã‚¢ãƒ¡ãƒªã‚«"
    negate = {
        "city":"å›½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
        "country":"éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
        "landmark":"éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å›½ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
    }
    prompt = f"æˆ‘ã€…ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{keyword}ã§ã™ã€‚ã“ã‚Œã¯{category}ã§ã™ã€‚{negate[category]} ã“ã®å˜èªã®æœ€åˆã®æ–‡å­—ã¯{keyword[0]}ã§ã™ã€‚ã“ã®{category}ã¯{continent}ã«ã‚ã‚Šã¾ã™ã€‚{question}"
else:
    prompt = f"æˆ‘ã€…ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{keyword}ã§ã™ã€‚ã“ã‚Œã¯ç‰©ä½“ã§ã™ã€‚éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å›½ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®å˜èªã®æœ€åˆã®æ–‡å­—ã¯{keyword[0]}ã§ã™ã€‚{question}"

messages = [
    {"role": "system", "content": "æ¬¡ã®è³ªå•ã«ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®ã¿ã§ç­”ãˆã¦ãã ã•ã„ã€‚ãã‚Œä»¥å¤–ã¯ç­”ãˆãªã„ã§ãã ã•ã„ã€‚"},
    {"role": "user", "content": prompt}
]
text = tokenizer.apply_chat_template(
    messages,
    tokenize=False,
    add_generation_prompt=True
)
model_inputs = tokenizer([text], return_tensors="pt").to('cuda')

generated_ids = model.generate(
    model_inputs.input_ids,
    attention_mask = model_inputs.attention_mask,
    pad_token_id=pad_token_id,
    max_new_tokens=1
)
generated_ids = [
    output_ids[len(input_ids):] for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)
]

response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0]
if not "yes" in response.lower(): response = "no"
else: response = "yes"

print(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ '{keyword}' ã®æ™‚")
print(f"è³ªå•è€…ãŒå°‹ã­ã‚‹: '{question}'")
print(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯: {prompt}")
print(f"ç§ãŸã¡ã®ãƒ¢ãƒ‡ãƒ«ã®å›ç­”: '{response}'")
```

---The following area is a Code cell (cell numver is 12)---
```python
import gc, torch
del model, tokenizer, model_inputs, generated_ids, response
gc.collect()
torch.cuda.empty_cache()
```

---The following area is a Markdown cell (cell numver is 13)---
```markdown
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’`main.py`ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚æˆ‘ã€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`def agent_fn(obs, cfg)`ã¨ã„ã†é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 14)---
```python
!cp /kaggle/input/updated-kaggle-keywords/keywords_v2.csv /kaggle/working
!cp /kaggle/input/updated-kaggle-keywords/keywords_v2.csv /tmp/submission
```

---The following area is a Code cell (cell numver is 15)---
```python
%%writefile /tmp/submission/main.py

################
# æå‡ºã‹ã‚³ãƒŸãƒƒãƒˆã‹ã‚’æ±ºå®š
import os
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
VERBOSE = False
if not os.path.exists(KAGGLE_AGENT_PATH + "weights"):
    KAGGLE_AGENT_PATH = "/tmp/submission/"
    VERBOSE = True

#################
# ãƒ¡ãƒ¢ãƒªã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
import sys, torch
from transformers import AutoTokenizer, AutoModelForCausalLM
sys.path.insert(0, f"{KAGGLE_AGENT_PATH}lib")
model = AutoModelForCausalLM.from_pretrained(
    f"{KAGGLE_AGENT_PATH}weights/",
    torch_dtype = torch.float16,
    device_map = "auto",
    trust_remote_code = True,
)
tokenizer = AutoTokenizer.from_pretrained(f"{KAGGLE_AGENT_PATH}weights/")

##############
# è³ªå•è€…ã¨ã—ã¦ã®äºŒåˆ†æ¢ç´¢
import pandas as pd, numpy as np
keywords = pd.read_csv(KAGGLE_AGENT_PATH + "keywords_v2.csv")
keywords['guess'] = 0

categories = ["city","country","landmark"]
#np.random.shuffle(categories)
category_yes = []
category_no = []
cat_guess = 0

continents = ["Europe","Asia","North America","Africa","South America","Australia"]
#np.random.shuffle(continents)
continent_yes = []
continent_no = []
con_guess = 0

first_letters = []
first_letter_yes = []
first_letter_no = []
let_guess = 0
extra_guess = ""

###############
# LLMãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã®å›ç­”è€…
def get_yes_no(question,keyword):
    global keywords, VERBOSE
    
    if keyword in keywords.keyword.values:
        row = keywords.loc[keywords.keyword==keyword].iloc[0]
        category = row.category #"åæ‰€"
        continent = row.continent #"åŒ—ã‚¢ãƒ¡ãƒªã‚«"
        negate = {
            "city":"å›½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
            "country":"éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
            "landmark":"éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å›½ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
        }
        prompt = f"æˆ‘ã€…ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{keyword}ã§ã™ã€‚ã“ã‚Œã¯{category}ã§ã™ã€‚{negate[category]} ã“ã®å˜èªã®æœ€åˆã®æ–‡å­—ã¯{keyword[0]}ã§ã™ã€‚ã“ã®{category}ã¯{continent}ã«ã‚ã‚Šã¾ã™ã€‚{question}"
    else:
        prompt = f"æˆ‘ã€…ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{keyword}ã§ã™ã€‚ã“ã‚Œã¯ç‰©ä½“ã§ã™ã€‚éƒ½å¸‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å›½ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚åæ‰€ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®å˜èªã®æœ€åˆã®æ–‡å­—ã¯{keyword[0]}ã§ã™ã€‚{question}"
    
    messages = [
        {"role": "system", "content": "æ¬¡ã®è³ªå•ã«ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®ã¿ã§ç­”ãˆã¦ãã ã•ã„ã€‚ãã‚Œä»¥å¤–ã¯ç­”ãˆãªã„ã§ãã ã•ã„ã€‚"},
        {"role": "user", "content": prompt}
    ]
    text = tokenizer.apply_chat_template(
        messages,
        tokenize=False,
        add_generation_prompt=True
    )
    model_inputs = tokenizer([text], return_tensors="pt").to('cuda')
    
    pad_token_id = tokenizer.pad_token_id
    if pad_token_id is None:
        pad_token_id = tokenizer.eos_token_id
        
    generated_ids = model.generate(
        model_inputs.input_ids,
        attention_mask = model_inputs.attention_mask,
        pad_token_id = pad_token_id,
        max_new_tokens=1
    )
    generated_ids = [
        output_ids[len(input_ids):] for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)
    ]

    response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0]
    if not "yes" in response.lower(): response = "no"
    else: response = "yes"
        
    if VERBOSE:
        print(f"### {prompt}")
        
    return response

############
# ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°
def agent_fn(obs, cfg):
    global keywords, extra_guess, VERBOSE
    global categories, category_yes, category_no, cat_guess
    global continents, continent_yes, continent_no, con_guess
    global first_letters, first_letter_yes, first_letter_no, let_guess
        
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    if obs.turnType == "ask":
        
        if (cat_guess<3)&(len(category_yes)==0):
            response = f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{categories[cat_guess]}ã®åå‰ã§ã™ã‹ï¼Ÿ"
            cat_guess += 1
        elif (con_guess<6)&(len(continent_yes)==0):
            category = "å ´æ‰€"
            if len( category_yes )==1: 
                category = category_yes[0]
            response = f"ãã®{category}ã¯{continents[con_guess]}ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
            con_guess += 1
        else:
            IDX = keywords.category.isin( category_yes )
            IDX = IDX & (keywords.continent.isin( continent_yes ))
            first_letters = list(keywords.loc[IDX,"first_letter"].value_counts().index.values)
            if let_guess < len(first_letters):
                response = f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ã¯{first_letters[let_guess]}ã§ã™ã‹ï¼Ÿ"
            else:
                IDX = keywords.guess == 0
                if len(category_yes)>0: IDX = IDX & (keywords.category.isin(category_yes))
                if len(category_no)>0: IDX = IDX & (~keywords.category.isin(category_no))
                if len(continent_yes)>0: IDX = IDX & (keywords.continent.isin(continent_yes))
                if len(continent_no)>0: IDX = IDX & (~keywords.continent.isin(continent_no))
                if len(first_letter_yes)>0: IDX = IDX & (keywords.first_letter.isin(first_letter_yes))
                if len(first_letter_no)>0: IDX = IDX & (~keywords.first_letter.isin(first_letter_no))
                try:
                    guess = keywords.loc[IDX].sample(1).index.values[0]
                    keywords.loc[guess,'guess'] = 1
                    response = keywords.loc[guess,"keyword"]
                except:
                    response = np.random.choice( keywords.keyword.values )
                extra_guess = response
                response = f"ãã‚Œã¯{response}ã§ã™ã‹ï¼Ÿ"
            let_guess += 1
            
    elif obs.turnType == "guess":
        
        category_yes = []
        category_no = []
        for k in range(cat_guess):
            if obs.answers[k]=="yes":
                category_yes.append( categories[k] )
            else:
                category_no.append( categories[k] )
        if (cat_guess==3)&(len(category_yes)==0):
            category_yes = ["city","country","landmark"]
            category_no = []
            
        continent_yes = []
        continent_no = []
        for k in range(con_guess):
            if obs.answers[k+cat_guess]=="yes":
                continent_yes.append( continents[k] )
            else:
                continent_no.append( continents[k] )
        if (con_guess==6)&(len(continent_yes)==0):
            continent_yes = ["Europe","Asia","North America","Africa","South America","Australia"]
            continent_no = []
            
        first_letter_yes = []
        first_letter_no = []
        for k in range(let_guess):
            if k >= len(first_letters): continue
            if obs.answers[k+cat_guess+con_guess]=="yes":
                first_letter_yes.append( first_letters[k] )    
            else:
                first_letter_no.append( first_letters[k] ) 
                
        IDX = keywords.guess == 0
        if len(category_yes)>0: IDX = IDX & (keywords.category.isin(category_yes))
        if len(category_no)>0: IDX = IDX & (~keywords.category.isin(category_no))
        if len(continent_yes)>0: IDX = IDX & (keywords.continent.isin(continent_yes))
        if len(continent_no)>0: IDX = IDX & (~keywords.continent.isin(continent_no))
        if len(first_letter_yes)>0: IDX = IDX & (keywords.first_letter.isin(first_letter_yes))
        if len(first_letter_no)>0: IDX = IDX & (~keywords.first_letter.isin(first_letter_no))
            
        try:
            guess = keywords.loc[IDX].sample(1).index.values[0]
            keywords.loc[guess,'guess'] = 1
            response = keywords.loc[guess,"keyword"]
        except:
            response = np.random.choice( keywords.keyword.values )
            
        if (let_guess>0)&(let_guess>=len(first_letters))&(obs.answers[-1]=="yes"):
            response = extra_guess
        
    else: #obs.turnType == "answer"
        if obs.keyword.lower() in obs.questions[-1].lower():
            response = "yes"
        else:
            response = get_yes_no(obs.questions[-1], obs.keyword)
            
    # å½¹å‰²ã‚’è¡¨ç¤º
    if VERBOSE: 
        if obs.turnType == "answer": 
            print(f"ãƒãƒ¼ãƒ 2 - å›ç­”è€… - ### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ LLAMA 8B ###")
        else:
            print(f"\nãƒãƒ¼ãƒ 2 - è³ªå•è€… - ### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ LLAMA 8B ###")
        print(f"OUTPUT = '{response}'")

    return response
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
# æå‡ºç”¨ã®ã‚¿ãƒ¼ãƒœãƒ¼ãƒ«ã‚’ä¿å­˜
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ãƒ¢ãƒ‡ãƒ«ã€main.pyã‚’ã‚¿ãƒ¼ãƒœãƒ¼ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 18)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf /kaggle/working/submission.tar.gz -C /tmp/submission .
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
# Kaggleã®APIã®EDA
ä»¥ä¸‹ã«Kaggleã®APIã®EDAã‚’ç¤ºã—ã¾ã™ã€‚æˆ‘ã€…ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸ3ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å…±ã«Llama 8B LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

Kaggleã®20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å„æŒ‘æˆ¦ã¯4ã¤ã®Kaggleãƒãƒ¼ãƒ ãŒå‚åŠ ã—ã¾ã™ã€‚2ã¤ã®ãƒãƒ¼ãƒ ãŒå¯¾æˆ¦å½¢å¼ã§ã™ã€‚ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ¼ãƒ ã§ã¯ã€ã€Œè³ªå•è€…ã€ï¼ˆ4ãƒãƒ¼ãƒ ã®ã†ã¡1ãƒãƒ¼ãƒ ï¼‰ã¨ã€Œå›ç­”è€…ã€ï¼ˆ4ãƒãƒ¼ãƒ ã®ã†ã¡1ãƒãƒ¼ãƒ ï¼‰ãŒã„ã¾ã™ã€‚è³ªå•è€…ã®å½¹å‰²ã¯2ã¤ï¼ˆã™ãªã‚ã¡ã€å°‹ã­ã‚‹ã¨æ¨æ¸¬ã™ã‚‹ï¼‰ã€‚å›ç­”è€…ã®å½¹å‰²ã¯1ã¤ï¼ˆã™ãªã‚ã¡ã€ç­”ãˆã‚‹ï¼‰ã§ã™ã€‚

å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã€è³ªå•è€…ãŒè³ªå•ã‚’ã—ã€ãã®å¾Œã‚°ãƒ«ãƒ¼ãƒ—ã®ä»²é–“ã§ã‚ã‚‹å›ç­”è€…ãŒã€Œã¯ã„ã€ã‹ã€Œã„ã„ãˆã€ã§ç­”ãˆã¾ã™ã€‚æœ€å¾Œã«è³ªå•è€…ãŒå˜èªã‚’æ¨æ¸¬ã—ã¾ã™ã€‚åˆè¨ˆ20ãƒ©ã‚¦ãƒ³ãƒ‰è¡Œã‚ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 20)---
```python
import pandas as pd

# DataFrameã®è¡¨ç¤º
df = pd.read_csv("/kaggle/input/updated-kaggle-keywords/keywords_v2.csv")
n = df.category.nunique()
print(f"\nå¤ã„å…¬çš„LBï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ›´æ–°å‰ï¼‰ã«ã¯ã€{len(df)}å€‹ã®å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨{n}ã®ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã™ã€‚")
print("ä»¥ä¸‹ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸ20ã®ä¾‹ã§ã™:\n")
df.sample(20, random_state=42)
```

---The following area is a Code cell (cell numver is 21)---
```python
%%writefile /kaggle/working/agent1.py

import pandas as pd, numpy as np
keywords = pd.read_csv("keywords_v2.csv").keyword.values

def agent_fn(obs, cfg):
    global keywords
    
    # ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’è¡¨ç¤º
    k = len( obs.questions )
    if obs.turnType == "ask":
        print()
        print("#"*25)
        print(f"### ãƒ©ã‚¦ãƒ³ãƒ‰ {k+1}")
        print("#"*25)

    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨JSONå…¥åŠ›ã‚’è¡¨ç¤º
    name = "ãƒãƒ¼ãƒ 1 - è³ªå•è€… - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒ©ãƒ³ãƒ€ãƒ "
    print(f"\n{name}\nINPUT =",obs)
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    keyword = np.random.choice(keywords)
    if obs.turnType == "ask":
        response = f"ãã‚Œã¯{keyword}ã§ã™ã‹ï¼Ÿ"
    else: #obs.turnType == "guess"
        response = keyword
        if obs.answers[-1] == "yes":
            response = obs.questions[-1].rsplit(" ",1)[1][:-1]
    print(f"OUTPUT = '{response}'")

    return response
```

---The following area is a Code cell (cell numver is 22)---
```python
%%writefile /kaggle/working/agent2.py

import numpy as np

def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨JSONå…¥åŠ›ã‚’è¡¨ç¤º
    name = "ãƒãƒ¼ãƒ 1 - å›ç­”è€… - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒ©ãƒ³ãƒ€ãƒ "
    print(f"\n{name}\nINPUT =",obs)
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    response = "no"
    #response = np.random.choice(["yes","no"])
    if obs.keyword.lower() in obs.questions[-1].lower():
        response = "yes"
    print(f"OUTPUT = '{response}'")

    return response
```

---The following area is a Code cell (cell numver is 23)---
```python
%%writefile /kaggle/working/agent3.py

import pandas as pd, numpy as np
keywords = pd.read_csv("keywords_v2.csv").keyword.values

def agent_fn(obs, cfg):
    global keywords
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨JSONå…¥åŠ›ã‚’è¡¨ç¤º
    name = "ãƒãƒ¼ãƒ 2 - è³ªå•è€… - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒ©ãƒ³ãƒ€ãƒ "
    print(f"\n{name}\nINPUT =",obs)
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    keyword = np.random.choice(keywords)
    if obs.turnType == "ask":
        response = f"ãã‚Œã¯{keyword}ã§ã™ã‹ï¼Ÿ"
    else: #obs.turnType == "guess"
        response = keyword
        if obs.answers[-1] == "yes":
            response = obs.questions[-1].rsplit(" ",1)[1][:-1]
    print(f"OUTPUT = '{response}'")

    return response
```

---The following area is a Code cell (cell numver is 24)---
```python
%%writefile /kaggle/working/agent4.py

import numpy as np

def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨JSONå…¥åŠ›ã‚’è¡¨ç¤º
    name = "ãƒãƒ¼ãƒ 2 - å›ç­”è€… - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒ©ãƒ³ãƒ€ãƒ "
    print(f"\n{name}\nINPUT =",obs)
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    response = "no"
    #response = np.random.choice(["yes","no"])
    if obs.keyword.lower() in obs.questions[-1].lower():
        response = "yes"
    print(f"OUTPUT = '{response}'")

    return response
```

---The following area is a Code cell (cell numver is 25)---
```python
!pip install -q pygame
```

---The following area is a Code cell (cell numver is 26)---
```python
LLAMA_AS_QUESTIONER = True
LLAMA_AS_ANSWERER = True

from kaggle_environments import make
env = make("llm_20_questions", debug=True)

# ãƒãƒ¼ãƒ 1
agent1 = "/kaggle/working/agent1.py"
agent2 = "/kaggle/working/agent2.py"

# ãƒãƒ¼ãƒ 2 - è³ªå•è€…
agent3 = "/kaggle/working/agent3.py"
if LLAMA_AS_QUESTIONER:
    agent3 = "/tmp/submission/main.py"
    
# ãƒãƒ¼ãƒ 2 - å›ç­”è€…
agent4 = "/kaggle/working/agent4.py"
if LLAMA_AS_ANSWERER:
    agent4 = "/tmp/submission/main.py"
    
env.reset()
log = env.run([agent1, agent2, agent3, agent4])

import gc, torch
del make, env, log
gc.collect()
torch.cuda.empty_cache()
```

---The following area is a Code cell (cell numver is 27)---
```python
# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã€‚æå‡ºã—ãªã„ãŸã‚
!rm agent1.py agent2.py agent3.py agent4.py keywords_v2.csv
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## shiv_314
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ç´ æ™´ã‚‰ã—ã„ï¼8Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä¸Šé™ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹ã¨ã„ã†ã“ã¨ã‚’ã©ã®ã‚ˆã†ã«æ€ã„ã¤ã„ãŸã®ã§ã™ã‹ï¼Ÿæ¨å®šã‚’é€šã˜ã¦èª¬æ˜ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > 1xT4 GPUã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å®Ÿéš›ã«ã¯17Bãƒ¢ãƒ‡ãƒ«ã‚’æ¨è«–ã§ãã¾ã™ï¼ˆãªãœãªã‚‰ã€ç§ã¯ã“ã“ã§34Bãƒ¢ãƒ‡ãƒ«ã‚’2xT4ã§æ¨è«–ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã—ãŸï¼‰ã€‚17Bãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å§‹ã‚ã‚‹ã¨ã€4bité‡å­åŒ–ã®å¾Œã€ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã§10GBã«ãªã‚Šã€1xT4ã®16GB VRAMã«ç°¡å˜ã«åã¾ã‚Šã¾ã™ã€‚ï¼ˆæ›´æ–°ï¼šãŠãã‚‰ã20Bãƒ¢ãƒ‡ãƒ«ã‚’æ¨è«–ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰
> > 
> > 
> > 


---

> ## Istvan Habram
> 
> ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ`def agent_fn(obs, cfg)`ã¨ã„ã†é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã¯ã©ã“ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã“ã‚Œã¯Kaggleç®¡ç†è€…ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯[ã“ã¡ã‚‰](https://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebook)ã‚„ã€Kaggleã®GitHub[ã“ã¡ã‚‰](https://github.com/Kaggle/kaggle-environments/tree/master/kaggle_environments/envs/llm_20_questions)ã‚’èª­ã‚€ã“ã¨ã§å­¦ã³ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ç§ãŸã¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
> > 
> > 
> > 
> > > ## Istvan Habram
> > > 
> > > ä»Šã¯ã£ãã‚Šã—ã¾ã—ãŸã€‚è¿…é€Ÿãªå›ç­”ã‚’ã‚ã‚ŠãŒã¨ã†ï¼
> > > 
> > > 
> > > 


---

> ## Toshi
> 
> ã™ã°ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼
> 
> ã“ã‚Œã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
> 
> ImportError: numpy>=1.17,<2.0ãŒã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ­£å¸¸ãªæ©Ÿèƒ½ã«å¿…è¦ã§ã™ãŒã€numpy==2.0.0ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚
> 
> è©¦ã—ã¦ãã ã•ã„: pip install transformers -U ã¾ãŸã¯ã€git mainã§ä½œæ¥­ã—ã¦ã„ã‚‹å ´åˆã¯pip install -e '.[dev]'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
> 
> ã“ã®ã‚¨ãƒ©ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã‹ï¼Ÿ
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã„ã„ãˆã€ãã®ã‚¨ãƒ©ãƒ¼ã¯è¦‹ãŸã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ãã®ã¾ã¾å®Ÿè¡Œã—ã¦ã„ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ä½•ã‹å¤‰æ›´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç’°å¢ƒã‚’ã€Œå…ƒã®çŠ¶æ…‹ã«å›ºå®šã€ã«è¨­å®šã—ã¦ã„ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚Kaggleã®æœ€æ–°ã®ãƒ‰ãƒƒã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼ŸKaggleã®æœ€æ–°ãŒã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã€Œå…ƒã®çŠ¶æ…‹ã«å›ºå®šã€ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > 
> > ã‚‚ã—ä½•ã‹å¤‰æ›´ã—ã¦ã€numpy==2.0.0ãŒæ°—ã«å…¥ã‚‰ãªã„åŸå› ã¨ãªã£ã¦ã„ã‚‹å ´åˆã€å¤ã„numpyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹: pip install numpy==1.17
> > 
> > 
> > 
> > > ## FullEmpty
> > > >[@cdeotte](https://www.kaggle.com/cdeotte)ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ„Ÿè¬ - ã‚ãªãŸã®æŠ•ç¨¿ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¤šãã‚’å­¦ã‚“ã§ã„ã¾ã™ã€‚ç§ã¯Kaggleãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¦ã„ãªã„ãŒã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¾ã™ãŒã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å–ã‚Šè¾¼ã‚“ã§å®Ÿè¡Œã™ã‚‹ã¨ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã€Œå…ƒã®çŠ¶æ…‹ã«å›ºå®šã€ã§ã•ãˆã€‚
> > > >ã—ã‹ã—ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§å•é¡Œã‚’è§£æ±ºã§ãã¾ã™:
> > > >
> > > > !rm -rf /tmp/submission/lib/numpy-2.0.1.dist-info
> > > > ã¾ãŸã¯ã€å¥½ã¾ã—ãã¯ã€
> > > > 
> > > > os.system("pip install accelerate==0.33.0 bitsandbytes==0.43.2 huggingface_hub==0.24.2 -t /tmp/submission/lib")
> > > >
> > > > 


---

> ## Kartikeya Pandey
> > ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã€‚ç§ã¯å¤šãã‚’å­¦ã³ã¾ã—ãŸã€‚
> 
> 
> 


---

> ## El haddad Mohamed
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ã¨ã¦ã‚‚æ•´ç†ã•ã‚Œã¦ã„ã¦ã€æœ‰ç›Šã§ã™ã€‚ğŸ‘
> 
> 


---

> ## ISAKA Tsuyoshi
> 
> ã“ã‚“ã«ã¡ã¯[@cdeotte](https://www.kaggle.com/cdeotte)ã€‚ã“ã®ã‚ˆã†ãªç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«(Llama-3-Smaug-8B)ã«ã¤ã„ã¦ã‚‚ã£ã¨æ•™ãˆã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿã“ã‚Œã¯ã€llama-3ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šã‚‚å„ªã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > Llama-3-Smaug-8Bã¯Llama-3-8B-Instructã«è¿½åŠ ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ–½ã—ãŸãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚ã„ãã¤ã‹ã®ç‚¹ã§Llama-3-8B-Instructã‚ˆã‚Šã‚‚å„ªã‚Œã¦ã„ã¾ã™ãŒã€ãŠãã‚‰ãã„ãã¤ã‹ã®ç‚¹ã§åŠ£ã£ã¦ã„ã¾ã™ã€‚SmaugãŒã©ã®ã‚ˆã†ã«è¨“ç·´ã•ã‚ŒãŸã‹ã«ã¤ã„ã¦ã®ç ”ç©¶è«–æ–‡ã¯[ã“ã¡ã‚‰](https://arxiv.org/abs/2402.13228)ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’ç™ºè¦‹ã—ãŸã®ã¯ã€ã‚ã‚‹æ™‚ç‚¹ã§ã“ã®ãƒ¢ãƒ‡ãƒ«ãŒé€šå¸¸ã®Llamaã‚ˆã‚Šã‚‚é«˜ã„Open LLM Leaderboardã®ã‚¹ã‚³ã‚¢ã‚’æŒã£ã¦ã„ãŸã‹ã‚‰ã§ã™ã€‚
> > 
> > ã‚‚ã†ä¸€ã¤ã€Open LLM Leaderboardã§è‰¯å¥½ãªçµæœã‚’å‡ºã™ãƒ¢ãƒ‡ãƒ«ã¯jondurbin/bagel-7b-v0.5[ã“ã¡ã‚‰](https://huggingface.co/jondurbin/bagel-7b-v0.5)ã§ã™ã€‚ã“ã‚Œã¯Mistral-7Bã«è¿½åŠ ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ–½ã—ãŸã‚‚ã®ã§ã™ã€‚BagelãŒã©ã†ã‚„ã£ã¦è¨“ç·´ã•ã‚ŒãŸã®ã‹ã¯ã€[ã“ã¡ã‚‰](https://github.com/jondurbin/bagel)ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
> > 
> > ã•ã‚‰ã«ã€Open LLM Leaderboardã§è‰¯å¥½ãªçµæœã‚’å‡ºã™ãƒ¢ãƒ‡ãƒ«ã¯Qwen/Qwen2-7B-Instruct[ã“ã¡ã‚‰](https://huggingface.co/Qwen/Qwen2-7B-Instruct)ã§ã™ã€‚ç§ã¯Qwen2ãƒ¢ãƒ‡ãƒ«ã®å¤§ãƒ•ã‚¡ãƒ³ã§ã™ã€‚ã“ã®v2ã‚·ãƒªãƒ¼ã‚ºã¯å…ˆæœˆãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã°ã‹ã‚Šã§ã€ã™ãã«ãƒˆãƒƒãƒ—ã®Open LLM Leaderboardãƒ¢ãƒ‡ãƒ«ã«ãªã‚Šã¾ã—ãŸã€‚
> > 
> > ï¼ˆå®Œå…¨ã‚’æœŸã™ãŸã‚ã«å¤å…¸çš„ãªãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦Llama3ã€Mistralã€Gemma2ã€Phi3ã‚’æŒ™ã’ã¾ã™ï¼‰
> > 
> > 
> > 
> > > ## ISAKA Tsuyoshi
> > >  > è©³ç´°ãªèª¬æ˜ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ãŸãã•ã‚“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã­ã€‚
> > > 
> > >
```

** @@@ Jupyter Notebook numver 3, the number of votes :63 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«é–¢é€£ã—ã¦ã€å¼·åŒ–å­¦ç¿’ã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚è‘—è€…ã¯MarÃ­lia Prataï¼ˆmpwolkeï¼‰ã§ã€2024å¹´5æœˆ15æ—¥ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚

### å•é¡Œã®æ¦‚è¦
ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å½“ã¦ã‚‹ãŸã‚ã«è³ªå•ã‚’é‡ã­ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã€ãã®è³ªå•ã®é¸æŠãŒã‚²ãƒ¼ãƒ ã®å‹æ•—ã«é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦æœ€é©ãªè³ªå•ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å­¦ã¶ãŸã‚ã«å¼·åŒ–å­¦ç¿’ï¼ˆRLï¼‰ã‚’ç”¨ã„ãŸæ‰‹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: pandasã¨numpyã‚’ç”¨ã„ã¦ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’è¡Œã„ã€ã•ã¾ã–ã¾ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
2. **å¼·åŒ–å­¦ç¿’**:
   - **æ”¿ç­–ãƒ™ãƒ¼ã‚¹ã®å¼·åŒ–å­¦ç¿’**: ææ¡ˆã•ã‚ŒãŸæ‰‹æ³•ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒãƒ«ã‚³ãƒ•æ±ºå®šéç¨‹ï¼ˆMDPï¼‰ã‚’é€šã˜ã¦è³ªå•é¸æŠãƒ—ãƒ­ã‚»ã‚¹ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚ä¿¡é ¼åº¦ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å›ç­”ã«åŸºã¥ã„ã¦ä¿¡é ¼åº¦ã‚’æ›´æ–°ã—ã¾ã™ã€‚
   - **å ±é…¬ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: å„ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã§é©åˆ‡ãªå³æ™‚å ±é…¬ã‚’æ¨å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯èª¤ã£ãŸå›ç­”ã«ã‚ˆã‚‹å±€æ‰€çš„æœ€é©ã‹ã‚‰è„±å‡ºã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
3. **Keras**: Kerasã‚’ä½¿ç”¨ã—ã¦æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã€ç‰¹ã«GemmaCausalLMãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦è³ªå•ç”Ÿæˆã‚’è¡Œã„ã¾ã™ã€‚ã“ã¡ã‚‰ã¯Googleã®Geminiãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ã„ãŸå¤§è¦æ¨¡ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚
4. **ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã¨æ­£è¦åŒ–**: JSONãƒ‡ãƒ¼ã‚¿ã‚’DataFrameã«å¤‰æ›ã—ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ‡ãƒ¼ã‚¿æ•´å½¢ã‚„æ­£è¦åŒ–ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹ç‡çš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ãªè³ªå•é¸æŠã‚’å¼·åŒ–å­¦ç¿’ã«ã‚ˆã£ã¦å®Ÿç¾ã™ã‚‹ãŸã‚ã®å®Ÿé¨“çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹çŸ¥è­˜ã‚’æŒãŸãªã„çŠ¶æ…‹ã§ã€ã©ã†ã«ã‹ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é€²ã‚ã‚‹ãŸã‚ã®æ‰‹æ³•ã‚’æ¨¡ç´¢ã—ã¦ã„ã‚‹ç‚¹ãŒç‰¹å¾´ã§ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
2024å¹´5æœˆ15æ—¥å…¬é–‹ã€‚è‘—è€…: MarÃ­lia Prata, mpwolke
```

---The following area is a Code cell (cell numver is 2)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¤šæ•°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯ã€kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†, CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã®"../input/"ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ï¼ˆå®Ÿè¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹Shift+Enterã‚’æŠ¼ã™ã¨ï¼‰ã€å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã—ã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ/kaggle/working/ï¼‰ã«ã¯æœ€å¤§20GBã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ã“ã‚Œã¯"Save & Run All"ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
# ã¾ãŸã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯/kaggle/temp/ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ãŒã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®å¼•ç”¨

@misc{llm-20-questions,
    author = {Zoe Mongan, Luke Sernau, Will Lifferth, Bovard Doerschuk-Tiberi, Ryan Holbrook, Will Cukierski, Addison Howard},
    title = {LLM 20 Questions},
    publisher = {Kaggle},
    year = {2024},
    url = {https://kaggle.com/competitions/llm-20-questions}
}

# é³¥ã§ã™ã‹ï¼Ÿé£›è¡Œæ©Ÿã§ã™ã‹ï¼Ÿã„ã„ãˆã€ã‚«ã‚°ãƒ©ãƒ¼ã§ã™ï¼

![](https://img1.picmix.com/output/pic/normal/5/6/8/3/11323865_2f559.gif)https://en.picmix.com/pic/bird-plane-bert-11323865

# å¼·åŒ–å­¦ç¿’ã«ã‚ˆã‚‹Q20ã‚²ãƒ¼ãƒ 

æ”¿ç­–ãƒ™ãƒ¼ã‚¹ã®å¼·åŒ–å­¦ç¿’ã‚’ç”¨ã„ãŸ20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ¬ã‚¤

è‘—è€…: Huang Hu1, Xianchao Wu, Bingfeng Luo, Chongyang Tao, Can Xu, Wei Wu, Zhan Chen

ã€Œã“ã®è«–æ–‡ã§ã¯ã€è‘—è€…ã‚‰ã¯è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç¶™ç¶šçš„ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦è³ªå•é¸æŠã®æœ€é©æ”¿ç­–ã‚’å­¦ã¶ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹æ–°ã—ã„æ”¿ç­–ãƒ™ãƒ¼ã‚¹ã®å¼·åŒ–å­¦ç¿’ï¼ˆRLï¼‰æ‰‹æ³•ã‚’ææ¡ˆã—ã¾ã—ãŸã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¿ƒé€²ã™ã‚‹ãŸã‚ã«ã€ã‚ˆã‚Šæƒ…å ±ä¾¡å€¤ã®é«˜ã„å ±é…¬ã‚’æ¨å®šã™ã‚‹ãŸã‚ã«å ±é…¬ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ææ¡ˆã•ã‚Œã¾ã—ãŸã€‚ä»¥å‰ã®æ‰‹æ³•ã¨æ¯”è¼ƒã—ã¦ã€å½¼ã‚‰ã®RLæ‰‹æ³•ã¯ãƒã‚¤ã‚ºã®ã‚ã‚‹å›ç­”ã«å¯¾ã—ã¦å¼·å›ºã§ã‚ã‚Šã€ç‰©ä½“ã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚å®Ÿé¨“çµæœã¯ã€å½¼ã‚‰ã®RLæ‰‹æ³•ãŒã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã«åŸºã¥ãã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’æ˜ã‚‰ã‹ã«ä¸Šå›ã‚Šã€ãƒã‚¤ã‚ºã®ãªã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ç«¶äº‰åŠ›ã®ã‚ã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æŒã¤ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã€

ã€ŒQ20ã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è¨­è¨ˆã™ã‚‹ã“ã¨ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ±ºå®šæœ¨ãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã¯Q20ã‚²ãƒ¼ãƒ ã«è‡ªç„¶ã«é©ã—ã¦ã„ã‚‹ã‚ˆã†ã«æ€ã‚ã‚Œã¾ã™ãŒã€é€šå¸¸ã¯å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹ååˆ†ãªæƒ…å ±ã‚’å«ã‚€æ˜ç¢ºã«å®šç¾©ã•ã‚ŒãŸçŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼ˆKBï¼‰ãŒå¿…è¦ã§ã‚ã‚Šã€ã“ã‚Œã¯å®Ÿéš›ã«ã¯åˆ©ç”¨å¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è³ªå•ã¨ç‰©ä½“ã®é¸æŠã®ãŸã‚ã®ãƒ”ãƒœãƒƒãƒˆã¨ã—ã¦ã€æ—¢å­˜ã®KBï¼ˆçŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼‰ã«ä¾å­˜ã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè³ªå•é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¾ã—ãŸã€‚ã•ã‚‰ã«ã€ã“ã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€å¤šãã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’ç”¨ã„ã¦æ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã¯è³ªå•ã‚’è²ªæ¬²ã«é¸æŠã—ã€ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ã®ã¿æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€å½¼ã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒã‚¤ã‚ºã®ã‚ã‚‹å›ç­”ã«éå¸¸ã«æ•æ„Ÿã§ã™ã€‚ã“ã‚Œã¯ãƒªã‚¢ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®Q20ã‚²ãƒ¼ãƒ ã§ã¯ä¸€èˆ¬çš„ã§ã™ã€‚ä¸€èˆ¬åŒ–èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ä¾¡å€¤ãƒ™ãƒ¼ã‚¹ã®å¼·åŒ–å­¦ç¿’ï¼ˆRLï¼‰ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨ã•ã‚Œã¾ã—ãŸãŒã€ä¾ç„¶ã¨ã—ã¦æ—¢å­˜ã®KBã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚ã€

ã€Œã“ã®è«–æ–‡ã§ã¯ã€ã‚²ãƒ¼ãƒ ã®è³ªå•é¸æŠãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒãƒ«ã‚³ãƒ•æ±ºå®šéç¨‹ï¼ˆMDPï¼‰ã¨ã—ã¦å®šå¼åŒ–ã—ã€Q20ã‚²ãƒ¼ãƒ ã§ã®è³ªå•é¸æŠã®æœ€é©æ”¿ç­–ã‚’å­¦ã¶ãŸã‚ã®æ–°ã—ã„æ”¿ç­–ãƒ™ãƒ¼ã‚¹ã®RLãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ææ¡ˆã—ã¾ã—ãŸã€‚å½¼ã‚‰ã®è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹ä¿¡é ¼åº¦ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ãŸã‚ã«ã™ã¹ã¦ã®ç‰©ä½“ã«å¯¾ã™ã‚‹ç¢ºç‡åˆ†å¸ƒã‚’ç¶­æŒã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å›ç­”ã«åŸºã¥ã„ã¦ä¿¡é ¼åº¦ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã€

ã€Œå„ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æ”¿ç­–ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ä¿¡é ¼åº¦ãƒ™ã‚¯ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã€æ¬¡ã®è³ªå•ã‚’é¸æŠã™ã‚‹ãŸã‚ã®è³ªå•åˆ†å¸ƒã‚’å‡ºåŠ›ã—ã¾ã™ã€‚é¸æŠã•ã‚ŒãŸå„è³ªå•ã«å³æ™‚å ±é…¬ãŒãªã„ã¨ã„ã†å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€è‘—è€…ã¯ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒˆã‚’å°å…¥ã—ã¦å„ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã§é©åˆ‡ãªå³æ™‚å ±é…¬ã‚’æ¨å®šã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ã•ã‚‰ã«ã€RLãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ãŸã‚ã®é•·æœŸçš„ãªãƒªã‚¿ãƒ¼ãƒ³ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã€

ã€Œå½¼ã‚‰ã®RLï¼ˆå¼·åŒ–å­¦ç¿’ï¼‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å­¦ç¿’å¯èƒ½ã§ã‚ã‚Šã€è³ªå•åˆ†å¸ƒãŒè³ªå•ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®åŸå‰‡çš„ãªæ–¹æ³•ã‚’æä¾›ã™ã‚‹ãŸã‚ã€ãƒã‚¤ã‚ºã®ã‚ã‚‹å›ç­”ã«å¯¾ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å …ç‰¢ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯èª¤ã£ãŸå›ç­”ã«ã‚ˆã‚‹å±€æ‰€çš„æœ€é©ã‹ã‚‰è„±å‡ºã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ãƒ¢ãƒ‡ãƒ«ã®ä¸€èˆ¬åŒ–èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®ã•ã‚‰ãªã‚‹ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å°å…¥ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è³ªå•ã®èƒ½åŠ›ã¯è²ªæ¬²ãªé¸æŠã¨æ¯”è¼ƒã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå°‹ã­ã‚‹è³ªå•ã®å¤šæ§˜æ€§ã‚’æ”¹å–„ã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã«ã¨ã£ã¦é‡è¦ã§ã™ã€‚ã€

https://www.researchgate.net/publication/327199595_Playing_20_Question_Game_with_Policy-Based_Reinforcement_Learning

# llm_20_questionsã®jsonãƒ•ã‚¡ã‚¤ãƒ«
```

---The following area is a Code cell (cell numver is 4)---
```python
# df = pd.read_json(path_or_buf='/kaggle/input/llm-20-questions/llm_20_questions/llm_20_questions.json')

# df= pd.read_json('../input/llm-20-questions/llm_20_questions/llm_20_questions.json', lines=True)
df= pd.read_json('../input/llm-20-questions/llm_20_questions/llm_20_questions.json', typ="series")
df.head()
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# çŸ¢å°ã®è¿‘ãã«ã¯: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€è¨­å®šã€å ±é…¬ã€è¦³å¯Ÿã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚ã‚Šã¾ã™

ã€ŒMixing dicts with non-Series may lead to ambiguous orderingã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ãƒ‡ãƒ¼ã‚¿å‹ãŒæ§˜ã€…ã§ã€ã„ãã¤ã‹ã¯æ–‡å­—åˆ—ã€ã„ãã¤ã‹ã¯ãƒªã‚¹ãƒˆã€è¤‡æ•°ã®{}ãªã©ãŒã‚ã‚‹ãŸã‚ã€ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

https://www.kaggle.com/code/mpwolke/trafic-json-mixing-dicts-with-non-series
```

---The following area is a Code cell (cell numver is 6)---
```python
# Mpwolke https://www.kaggle.com/code/mpwolke/trafic-json-mixing-dicts-with-non-series

# StackOverflow: https://stackoverflow.com/questions/49505872/read-json-to-pandas-dataframe-valueerror-mixing-dicts-with-non-series-may-lea

import json
import pandas as pd
ques = json.load(open('../input/llm-20-questions/llm_20_questions/llm_20_questions.json'))

df = pd.DataFrame(ques["observation"])
```

---The following area is a Code cell (cell numver is 7)---
```python
df.head()
```

---The following area is a Code cell (cell numver is 8)---
```python
df1 = pd.DataFrame(ques["configuration"])
df1.head()
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# è¨­å®šã®è»¢ç½®
```

---The following area is a Code cell (cell numver is 10)---
```python
df1_transposed = df1.T
df1_transposed.head()
```

---The following area is a Code cell (cell numver is 11)---
```python
df2 = pd.DataFrame(ques["status"])
df2.head()
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
# Kerasã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 13)---
```python
# Kerasã‚’æœ€å¾Œã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚è©³ç´°ã¯https://keras.io/getting_started/ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
!pip install -q -U keras-nlp
!pip install -q -U keras>=3

import os

os.environ["KERAS_BACKEND"] = "jax"  # ã¾ãŸã¯ "torch" ã¾ãŸã¯ "tensorflow".
# JAXãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒ¡ãƒ¢ãƒªã®æ–­ç‰‡åŒ–ã‚’é¿ã‘ã‚‹ãŸã‚
os.environ["XLA_PYTHON_CLIENT_MEM_FRACTION"]="1.00"

import keras
import keras_nlp
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
# Gemma_2b_en

æœ€åˆã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯Gemma 7bã‚’é©ç”¨ã™ã‚‹ã“ã¨ã‚’äºˆå®šã—ã¦ã„ã¾ã—ãŸãŒã€è§£æ±ºã§ããªã„äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãã“ã§ã€Gemma 2bã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãŸã ã—ã€æ„å›³ã—ãŸè³ªå•ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æŒã£ã¦ã„ãªã„ã®ã§ã€è¨€ã„æ›ãˆã‚Œã°ã€ã‚¸ãƒ³ã‚¯ã‚¹ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã‚‚ã†ä¸€ã¤ã®ã‚¸ãƒ³ã‚¯ã‚¹ãŒã‹ã‹ã£ãŸã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
%%time

gemma_lm = keras_nlp.models.GemmaCausalLM.from_preset("gemma_2b_en")
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
# ã™ã¹ã¦ã®å›ç­”ã¯ã€Œã¯ã„ã€ã§ã‚ã‚Šã€æœ€å¾Œã®1ã¤ã‚’é™¤ã„ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
print(gemma_lm.generate("Is Gemma, an open model based on Google's Gemini models?", max_length=1024))
```

---The following area is a Code cell (cell numver is 18)---
```python
print(gemma_lm.generate("Is Gemma a lightweight, text-to-text, decoder-only large language model?", max_length=1024))
```

---The following area is a Code cell (cell numver is 19)---
```python
print(gemma_lm.generate("Is Gemma a support low-latency generative AI used in cases such as streaming text?", max_length=1024))
```

---The following area is a Code cell (cell numver is 20)---
```python
print(gemma_lm.generate("Has Gemma 27 billion parameters?", max_length=1024))
```

---The following area is a Code cell (cell numver is 21)---
```python
print(gemma_lm.generate("Is LLaVA-Gemma, a MMFM that leverages the powerful Gemma language models for efficient multimodal interactions?", max_length=1024))
```

---The following area is a Code cell (cell numver is 22)---
```python
print(gemma_lm.generate("Is JAX a framework developed by Google?", max_length=1024))
```

---The following area is a Code cell (cell numver is 23)---
```python
print(gemma_lm.generate("Are you a model Gemma?", max_length=1024))
```

---The following area is a Code cell (cell numver is 24)---
```python
print(gemma_lm.generate("Are you participating on this Q20 game Gemma?", max_length=1024))
```

---The following area is a Markdown cell (cell numver is 25)---
```markdown
![](https://www.wallyandosborne.com/wp-content/uploads/2006/02/2005-11-01.gif)https://www.wallyandosborne.com/wp-content/uploads/2006/02/2005-11-01.gif

# è¬è¾:

mpwolke https://www.kaggle.com/code/mpwolke/eureka-gemma-1-1-instruct-7b-en

https://www.kaggle.com/code/mpwolke/thanks-for-delivering-my-writeup-order-gemma/notebook

mpwolke https://www.kaggle.com/code/mpwolke/trafic-json-mixing-dicts-with-non-series
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## SuM
> 
> é¢ç™½ã„ã‚²ãƒ¼ãƒ ã§ã™ã­ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ğŸ˜€
> 
> 
> 


---

> ## GODDiao
> 
> LOLã€ã©ã†ã‚„ã£ã¦ãã‚Œã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

> ## MarÃ­lia Prata ãƒˆãƒ”ãƒƒã‚¯ã®è‘—è€…
> > ãã‚Œã«ã¤ã„ã¦ã¯ã¾ã£ãŸãåˆ†ã‹ã‚Šã¾ã›ã‚“ã€GODDiao : )

---

> ## Ana Pedra LÃ³pez
> 
> é¢ç™½ã„ã‚¿ã‚¹ã‚¯ã§ã™ã­ï¼

> ## MarÃ­lia Prata ãƒˆãƒ”ãƒƒã‚¯ã®è‘—è€…
> > ç¢ºã‹ã«ã€Anaã€‚ãŸã ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦åˆã‚ã¦ã€ã“ã®ã‚¿ã‚¹ã‚¯ãŒã©ã‚Œã»ã©é›£ã—ã„ã‹ã‚’ç†è§£ã—ã¾ã—ãŸã€‚ç§ã®çŸ¥è­˜ã¯ã¨ã¦ã‚‚ä¹ã—ã„ã§ã™ã€‚
> 

---

> ## MÃ¡rcio Santos
> 
> ã‚ã‚ŠãŒã¨ã†å…±æœ‰ã—ã¦ãã‚Œã¦!!!

---

> ## Musa Khan
> 
> ç°¡å˜ã§ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ã§ã‚ã‚‹ã“ã¨ãŒã™ã¹ã¦ã§ã™ï¼

---

> ## MarÃ­lia Prata ãƒˆãƒ”ãƒƒã‚¯ã®è‘—è€…
> > ã‚ãªãŸã®ã‚µãƒãƒ¼ãƒˆã«æ„Ÿè¬ã—ã¦ã„ã¾ã™ã€Fatihã€‚ã‚ã‚ŠãŒã¨ã†ã€‚
> 
---
```

** @@@ Jupyter Notebook numver 4, the number of votes :61 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ­ãƒœãƒƒãƒˆï¼‰ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ç‰¹ã«åˆå¿ƒè€…å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ã‚²ãƒ¼ãƒ å†…ã§è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ãŒã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã¨ã„ã†èª²é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã å˜èªã‚’è³ªå•ã‚’é€šã˜ã¦æ¨æ¸¬ã—ã€ã¾ãŸã€ãã®è³ªå•ã«å¯¾ã—ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `transformers`: Hugging Faceã®Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰è¨“ç·´ã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
   - `torch`: PyTorchã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã®æ¨è«–ã‚’è¡Œã„ã¾ã™ã€‚
   - `kaggle_secrets`: Kaggleç’°å¢ƒã§ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã«ä½¿ç”¨ã€‚

2. **ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–**:
   - `AutoTokenizer` ã¨ `AutoModelForCausalLM` ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’åˆæœŸåŒ–ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ**:
   - `Robot`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã€è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®ãã‚Œãã‚Œã®å½¹å‰²ã‚’æœãŸã™ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã€‚
   - è³ªå•ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‹å½¢å¼ã¨ã—ã€é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸ãˆã¦ç”Ÿæˆã™ã‚‹è³ªå•ã‚’åˆ¶å¾¡ã€‚

4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œ**:
   - `agent`é–¢æ•°ã«ãŠã„ã¦ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ¼ãƒ‰ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ï¼‰ã‚’è¨­å®šã—ã€ãƒ­ãƒœãƒƒãƒˆãŒæ­£ã—ã„å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã€‚

5. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ**:
   - ç’°å¢ƒå†…ã§ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯æœ€å¾Œã«ã€æå‡ºç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹éš›ã®æ‰‹é †ã«å¾“ã£ã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®æ˜ç¢ºãªæ‰‹é †ã‚’æä¾›ã—ã¦ãŠã‚Šã€ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„æ‰‹æ³•ã‚’è©³ç´°ã«è§£èª¬ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ã“ã®ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã¯åˆå¿ƒè€…å‘ã‘ã§ã™
## ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§å¿…è¦ãªã“ã¨ã¯ï¼Ÿ

**è¦ç´„ï¼š20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨**

ãƒ­ãƒœãƒƒãƒˆãŒè©±ã—ã€æ­©ãã€è¸Šã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®ä»•äº‹ã¯ã€ãã®ãƒ­ãƒœãƒƒãƒˆãŒå„å½¹å‰²ã‚’é©åˆ‡ã«è¡Œã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ããªå½¹å‰²ã‚’é¸æŠã—ã¦ä»–ã®å½¹å‰²ã«å¹²æ¸‰ã™ã‚‹ã“ã¨ãªãå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ï¼ˆä¾‹ãˆã°ã€3ã¤ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚

ã“ã‚Œã¯ã¾ã•ã«ã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã‚ãªãŸã«æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®3ã¤ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ãŒã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ãƒ­ãƒœãƒƒãƒˆï¼ˆllmãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã¡ã‚‰ã®æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚“ã å ´åˆã€æå‡ºã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€åˆ¥ã®å‚åŠ è€…ãŒæå‡ºã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å¯¾æˆ¦ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¥ã‚ªã®ä¸­ã§ã€ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è³ªå•è€…ã¨æ¨æ¸¬è€…ã®å½¹å‰²ã‚’æœãŸã™ã‹ã€å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚å½¹å‰²ã¨ãƒã‚¤ãƒãƒ¼ãƒ ï¼ˆ2äººçµ„ï¼‰ã¯ã€è£ã§ã®ç’°å¢ƒã«ã‚ˆã£ã¦ã„ãã¤ã‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦é¸æŠã•ã‚Œã€ã‚ãªãŸã¯ãã‚Œã«ã¤ã„ã¦å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã‚ãªãŸãŒã™ã¹ãã“ã¨ã¯ã€ç’°å¢ƒãŒå›ç­”è€…ã®å½¹å‰²ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚’æ±ºå®šã—ãŸã¨ãã€ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã ã‘ã§ã™ã€‚ä»–ã®å›ç­”ã‚’ã™ã‚‹ã“ã¨ã¯ã€ã‚²ãƒ¼ãƒ ã«è² ã‘ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

è©³ç´°ã¯ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ [ã“ã¡ã‚‰](https://www.kaggle.com/competitions/llm-20-questions/overview) 

## æå‡ºæ–¹æ³•ã¯ï¼Ÿ

ã‚³ãƒ¼ãƒ‰ã¯main.pyã¨ã„ã†1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ãªã‘ã‚Œã°ãªã‚‰ãšã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ãƒ­ãƒœãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰ã¨ã€obsãŠã‚ˆã³cfgã‚’å¼•æ•°ã¨ã™ã‚‹å¿…é ˆã®é–¢æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€è£ã§ç’°å¢ƒãŒã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ç§ãŸã¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆä»–ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ¯”ã¹ã¦éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ï¼‰ã§ã¯ã€ã“ã®é–¢æ•°ã«ã€Œagentã€ã¨ã„ã†åå‰ã‚’ä»˜ã‘ã€ä»–ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€Œrobotã€ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ã«å…¥ã‚Œã¾ã™ã€‚

ç’°å¢ƒã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€/kaggle/inputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨main.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ­ãƒ¼ãƒ‰/ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

è£ã§tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œ/kaggle_simulations/agent/ã€ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸‹ã«å±•é–‹ã•ã‚Œã‚‹ãŸã‚ã€ç§ãŸã¡ã¯å®Ÿè¡Œç’°å¢ƒã«å¿œã˜ã¦ãƒ‘ã‚¹ã‚’èª¿æ•´ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ï¼ˆä¸‹è¨˜ã‚’å‚ç…§ï¼‰ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã€Œãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile -a submission/main.py

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
from kaggle_secrets import UserSecretsClient
import os
import sys
import shutil

# CUDAã®ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
torch.backends.cuda.enable_mem_efficient_sdp(False)
torch.backends.cuda.enable_flash_sdp(False)

# Kaggleã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    model_id = os.path.join(KAGGLE_AGENT_PATH, "1")
else:
    model_id = "/kaggle/input/llama-3/transformers/8b-chat-hf/1"

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
tokenizer = AutoTokenizer.from_pretrained(model_id)
model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype=torch.bfloat16, device_map="auto")
id_eot = tokenizer.convert_tokens_to_ids(["<|eot_id|>"])[0]

# å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
def generate_answer(template):
    inp_ids = tokenizer(template, return_tensors="pt").to("cuda")
    out_ids = model.generate(**inp_ids,max_new_tokens=15).squeeze()
    start_gen = inp_ids.input_ids.shape[1]
    out_ids = out_ids[start_gen:]
    if id_eot in out_ids:
        stop = out_ids.tolist().index(id_eot)
        out = tokenizer.decode(out_ids[:stop])
    else:
        out = tokenizer.decode(out_ids)
    return out
    

class Robot:
    def __init__(self):
        pass
    
    def on(self, mode, obs):
        assert mode in ["asking", "guessing", "answering"], "modeã¯ã“ã‚Œã‚‰ã®å€¤ã®ã„ãšã‚Œã‹ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ï¼šasking, answering, guessing"
        if mode == "asking":
            # è³ªå•è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.asker(obs)
        if mode == "answering":
            # å›ç­”è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.answerer(obs)
            if "yes" in output.lower():
                output = "yes"
            elif "no" in output.lower():
                output = "no"   
            if ("yes" not in output.lower() and "no" not in output.lower()):
                output = "yes"  # æ˜ç¢ºãªå›ç­”ãŒç„¡ã‹ã£ãŸå ´åˆã¯ã€Œyesã€ã«ã™ã‚‹
        if mode == "guessing":
            # æ¨æ¸¬è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.asker(obs)
        return output
    
    
    def asker(self, obs):
        sys_prompt = """ã‚ãªãŸã¯æœ‰èƒ½ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒéå¸¸ã«å¾—æ„ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å˜èªã‚’è€ƒãˆã‚‹ã¤ã‚‚ã‚Šã§ã™ã€‚ãã‚Œã¯æ¬¡ã®3ã¤ã®ã‚«ãƒ†ã‚´ãƒªã®ã„ãšã‚Œã‹ã§ã™ï¼š
        1. å ´æ‰€
        2. äººç‰©
        3. ç‰©
        ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã€æ¤œç´¢ç¯„å›²ã‚’ç‹­ã‚ã‚‹ãŸã‚ã®è³¢ã„è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚\n"""
    
        if obs.turnType =="ask":
            ask_prompt = sys_prompt + """ã‚ãªãŸã®å½¹å‰²ã¯ã€å½¼ã«20ã®è³ªå•ä»¥å†…ã§å˜èªã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚ã‚ãªãŸã®è³ªå•ã¯æœ‰åŠ¹ã§ã‚ã‚‹ãŸã‚ã«ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã®ã¿ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
            ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã«ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã¹ãã‹ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ï¼š
            ä¾‹ï¼š
            <ã‚ãªãŸï¼šãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ã‚ãªãŸï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãã“ã§ç”Ÿãã¦ã„ã‚‹äººã€…ã®å¤§åŠã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šmã‹ã‚‰å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            ã‚ãªãŸï¼šã¯ã„
            ã‚ãªãŸï¼šãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„ã€‚>

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå˜èªã‚’é¸ã³ã¾ã—ãŸã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãç°¡æ½”ã«ã—ã€ä½™è¨ˆãªè¨€è‘‰ã¯ä½¿ã‚ãšã€ä¸€ã¤ã®è³ªå•ã ã‘ã‚’ã—ã¦ãã ã•ã„ï¼"""
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{ask_prompt}<|eot_id|>"""
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
            if len(obs.questions)>=1:
                for q, a in zip(obs.questions, obs.answers):
                    chat_template += f"{q}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                    chat_template += f"{a}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
                    
        elif obs.turnType == "guess":
            conv = ""
            for q, a in zip(obs.questions, obs.answers):
                conv += f"""è³ªå•: {q}\nå›ç­”: {a}\n"""
            guess_prompt =  sys_prompt + f"""ã“ã‚Œã¾ã§ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¯æ¬¡ã®é€šã‚Šã§ã™:\n{conv}
            ä¼šè©±ã«åŸºã¥ã„ã¦ã€å˜èªã‚’æ¨æ¸¬ã§ãã¾ã™ã‹ï¼Ÿå˜èªã ã‘ã‚’æ•™ãˆã¦ãã ã•ã„ã€ä½™è¨ˆãªè¨€è‘‰ã¯ã„ã‚Šã¾ã›ã‚“ã€‚"""
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{guess_prompt}<|eot_id|>"""
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
                
        output = generate_answer(chat_template)        
        return output
        
        
        
    def answerer(self, obs):
        sys_prompt = f"""ã‚ãªãŸã¯æœ‰èƒ½ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒéå¸¸ã«å¾—æ„ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã¯ã€ã‚ãªãŸã«å¯¾ã—ã¦æœ€å¤§20ã®è³ªå•ã‚’ä½¿ã£ã¦å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã§ã™ã€‚ã‚ãªãŸã®å›ç­”ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ãã®ä»–ã®å›ç­”ã¯ç„¡åŠ¹ã§ã‚ã‚Šã€ãã‚Œã«ã‚ˆã‚Šã‚²ãƒ¼ãƒ ã«è² ã‘ã¾ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¸¸ã«æ¬¡ã®3ã¤ã®ã‚«ãƒ†ã‚´ãƒªã®ã„ãšã‚Œã‹ã«å±ã™ã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼š
        1. å ´æ‰€
        2. äººç‰©
        3. ç‰©
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ç†è§£ã—ã€ã‚ãªãŸãŒãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠŠæ¡ã—ã¦ãã ã•ã„ã€‚
        ç¾åœ¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å˜èªã¯ã€Œ{obs.keyword}ã€ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯ã€Œ{obs.category}ã€ã§ã™ã€‚
        ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã«ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã¹ãã‹ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚«ãƒ†ã‚´ãƒªã€Œå ´æ‰€ã€ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ï¼š
        ä¾‹ï¼š
        <ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã“ã§ç”Ÿãã¦ã„ã‚‹äººã€…ã®å¤§åŠã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šmã‹ã‚‰å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„ã€‚>"""
        
        chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{sys_prompt}<|eot_id|>"""
        chat_template += "<|start_header_id|>user<|end_header_id|>\n\n"
        chat_template += f"{obs.questions[0]}<|eot_id|>"
        chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
        if len(obs.answers)>=1:
            for q, a in zip(obs.questions[1:], obs.answers):
                chat_template += f"{a}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                chat_template += f"{q}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
        output = generate_answer(chat_template)
        return output
    
    
robot = Robot()


def agent(obs, cfg):
    
    if obs.turnType =="ask":
        response = robot.on(mode = "asking", obs = obs)
        
    elif obs.turnType =="guess":
        response = robot.on(mode = "guessing", obs = obs)
        
    elif obs.turnType =="answer":
        response = robot.on(mode = "answering", obs = obs)
        
    if response == None or len(response)<=1:
        response = "yes"
        
    return response
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ <a id="lc"></a>

ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ã¾ãšä¸Šã®ã‚»ãƒ«ã®ã€Œ%%writefile -a submission/main.pyã€ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã€ã“ã®ã‚»ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚»ãƒ«ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
# %%time

# from kaggle_environments import make
# env = make("llm_20_questions", debug=True)
# game_output = env.run(agents=[agent, agent, agent, agent])
```

---The following area is a Code cell (cell numver is 6)---
```python
# env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# æå‡ºãƒ•ã‚¡ã‚¤ãƒ«
```

---The following area is a Code cell (cell numver is 8)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 9)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/input/llama-3/transformers/8b-chat-hf . -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 10)---
```python
# tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹

# import tarfile
# tar = tarfile.open("/kaggle/working/submission.tar.gz")
# for file in tar.getmembers():
#     print(file.name)
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## davide
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
> 
> ãŸã è³ªå•ã§ã™ãŒã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯keyword.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ãä½¿ç”¨ã—ã¦ã„ãªã„ã®ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > [@davidemariani](https://www.kaggle.com/davidemariani) ã„ã„ãˆ
> > 
> > 
> > 


---

> ## dhruvyadav89300
> 
> ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’èª¬æ˜ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã¨ã¦ã‚‚å½¹ã«ç«‹ã¡ã¾ã—ãŸã€‚
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã‚Œã‚’èã„ã¦å¬‰ã—ã„ã§ã™ :)
> > 
> > 
> > 


---

> ## Chazzyie
> 
> ã‚ãªãŸã®ä½œæ¥­ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜ç¢ºã§ã™ ğŸ¤©
> 
> 


---

> ## Matthew S Farmer
> 
> ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã­ã€‚FYIã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€Œäººç‰©ã€ã¨ã„ã†ã‚«ãƒ†ã‚´ãƒªãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã¯ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œç´¢ç©ºé–“ã‚’å°‘ã—ã§ã‚‚ä¿ã¤ã®ã«å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ 
> 
> 
> 
> > ## Matthew S Farmer
> > 
> > [https://www.kaggle.com/competitions/llm-20-questions/discussion/512955#2884981](https://www.kaggle.com/competitions/llm-20-questions/discussion/512955#2884981)
> > 
> > 
> > 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãŠãŠã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚çŸ¥ã‚‰ãªã‹ã£ãŸã§ã™ï¼
> > 
> > 
> > 


---

> ## BK
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒå¤§å¥½ãã§ã™ :)
> 
> 


---

> ## Eslam Mohamed
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ï¼ã‚ãªãŸã®èª¬æ˜ã¯æœ€é«˜ã§ã™ã€‚
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã‚Œã‚’èã„ã¦å¬‰ã—ã„ã§ã™ï¼
> > 
> > 
> > 


---

> ## å¤æœˆæ–¹æº
> 
> ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ
> 
> 
> 


---

> ## å¤æœˆæ–¹æº
> 
> æœ€æ–°ã®3.1ã‚’æˆåŠŸè£ã«å®Ÿè¡Œã—ã¾ã—ãŸãŒã€æå‡ºå¾Œã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ç¶šã‘ã¾ã—ãŸ
> 
> 
> 


---

> ## Sandeep Sharma
> 
> ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚ã‚ŠãŒã¨ã†ã€‚ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€Œ1ã¤ã®ä½ç½®å¼•æ•° 'cfg' ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
> 
> 
> 


---

> ## Toshi
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚
> 
> ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®pytorchã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã¹ãã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > [@mst923](https://www.kaggle.com/mst923) ã‚ãªãŸã®ãƒ‘ã‚½ã‚³ãƒ³ã§ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã„ã†æ„å‘³ã§ã™ã‹ï¼Ÿè‰¯ã„GPUãŒãªã„é™ã‚Šã€å‹•ä½œã—ãªã„ã§ã—ã‚‡ã†
> > 
> > 
> > 


---

> ## kothiwsk28
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«3ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆæ•°å­—èªè­˜ã€ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯ã€ãƒã‚¦ã‚¹ãƒ—ãƒ©ã‚¤ã‚¹ï¼‰ã‚’ä¿æŒã—ã¦ãŠãç‰¹åˆ¥ãªç†ç”±ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã„ã„ãˆã€å‰Šé™¤ã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¯ã€ç«¶æŠ€ã«ã‚„ã£ã¦ãã‚‹åˆå¿ƒè€…ã‚’åŠ©ã‘ã‚‹ãŸã‚ã«è¿½åŠ ã—ã¾ã—ãŸã€‚
> > 
> > 
> > 


---

> ## Mask
> 
> å½¹ã«ç«‹ã¤ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã­ã€‚
> 
> ç§ã¯Kaggleã«æ–°ã—ãã€ãƒ•ã‚©ãƒ¼ã‚¯ã—ãŸã‚Šã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã—ãŸã¨ãã«ã€å®Ÿéš›ã«æå‡ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ä»˜å±ã—ã¦ã„ã‚‹ä»–ã®ç«¶æŠ€ï¼ˆæ•°å­—èªè­˜è€…ã¨ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯ï¼‰ãŒã‚ã‚Šã€ãã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§Llamaã‚’ä½¿ç”¨ã—ã¦ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã¨ãã€ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ãŒæ­£ã—ããªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸãŒã€æ­£ã—ã„ã§ã™ï¼
> 
> ä½•ãŒé–“é•ã£ã¦ã„ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ï¼
> 
> ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ãªã—ã«æå‡ºã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿç§ã¯ã“ã“ã§ã¯æ–°ã—ã„ã®ã§ã€ä½¿ã„æ–¹ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã€‚
> 
> æå‡ºãƒœã‚¿ãƒ³ãŒãªã„ã®ã¯éå¸¸ã«å¥‡å¦™ã§ã€ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã«ã€æ­£ã—ããªã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ï¼
> 
> 
> > ## Maoshenli
> > 
> > ç§ã‚‚åŒã˜å•é¡Œã«ç›´é¢ã—ã¾ã—ãŸã€‚è§£æ±ºã—ã¾ã—ãŸã‹ï¼ŸğŸ˜„
> > 
> > 
> > 
> > ## jehlum
> > 
> > ãƒ¢ãƒ‡ãƒ«ã‚’å³å´ã®å…¥åŠ›ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¾ã—ãŸã‹ï¼Ÿ
> > 
> > 
> > 
> > ## kaoutarTopicè‘—è€…
> > 
> > çš†ã•ã‚“ã€llamaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æ¡ä»¶ã‚’å—ã‘å…¥ã‚Œã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã®å•é¡Œã‚’è§£æ±ºã—ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚Œã°ã€å³ä¸Šã®3ã¤ã®ç‚¹ã«è¡Œãã€ã€Œã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
> > 
> > 
> > 


---

> ## Lucas
> 
> ã‚³ãƒ¼ãƒ‰ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æå‡ºã—ã¾ã—ãŸãŒã€LBã§600ç‚¹ã—ã‹å¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚750ç‚¹ã‚’ç²å¾—ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼ŸLlama3 8bã‚’å¾®èª¿æ•´ã—ã¾ã—ãŸã‹ï¼Ÿ
> 
> 
> 
> > ## Krens
> > 
> > ã‚²ãƒ¼ãƒ ã‚’æå‡ºã—ãŸã¨ãã€åˆæœŸã‚¹ã‚³ã‚¢ã¯600ãƒã‚¤ãƒ³ãƒˆã§ã—ãŸã€‚ã‚¹ã‚³ã‚¢ã¯ä»–ã®å‚åŠ è€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã§ã®ã¿å¤‰å‹•ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€åˆ†æ•£ã¯æ¯”è¼ƒçš„å¤§ããã€ãã‚Œã»ã©å®‰å®šã—ã¦ã„ã¾ã›ã‚“ã€‚
> > 
> > 
> > 


---

> ## zerojin
> 
> ä½œæ¥­ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚ä½¿ç”¨ã—ã¦ã„ã‚‹llama3ãƒ¢ãƒ‡ãƒ«ã¯å¾®èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ç§ã®ãƒ‡ãƒ¼ã‚¿ã§å¾®èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿç­”ãˆã¯ã„ã„ãˆã§ã™ã€‚Kaggleãƒãƒ–ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
> > 
> > 
> > 


---

> ## tingyu516
> 
> ã“ã‚“ã«ã¡ã¯ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã—ã¦ã€ŒValidation Episode failedã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ä½•ãŒèµ·ã“ã£ãŸã®ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
> > 
> > 
> > 


---

> ## Matthew S Farmer
> 
> ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ç«¶æŠ€ã®GPUä¸Šã§ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‰ãšã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã†ã§ã™ã­ã€ç§ã‚‚å¿ƒé…ã§ã—ãŸãŒã€ã†ã¾ãã„ãã¾ã—ãŸã€‚
> > 
> > 
> > 


---

> ## i_am_nothing
> 
> ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ã‚ã‚‹æ•°å­—èªè­˜è€…ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ
> 
> 
> > ## Chazzyie
> > 
> > 3ã¤ã®ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ•°å­—èªè­˜è€…ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤ã‚’é¸æŠã§ãã¾ã™ã€‚
> > 
> > 
> > 


---

> ## Eslam Mohamed
> 
> éå¸¸ã«å„ªã‚ŒãŸãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ï¼æ˜ç¢ºã•ã¨è©³ç´°ã®ãƒ¬ãƒ™ãƒ«ã¯æœ€é«˜ã§ã™ã€‚
> 
> 


---

> ## philipha2
> 
> ç§ã¯ã“ã®ç«¶æŠ€ã«å‚åŠ ã—ãŸã°ã‹ã‚Šã®åˆå¿ƒè€…ã§ã™ã€‚
> 
> è³ªå•ãŒåŸºæœ¬ã™ãã‚‹å ´åˆã¯ã”ã‚ã‚“ãªã•ã„ã€‚
> 
> ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’colabã§å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ãŒã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„æå‡ºã‚³ãƒ¼ãƒ‰ã®ãŸã‚ã«å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯Kaggleãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã—ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã“ã‚“ã«ã¡ã¯ã€ã„ã„ãˆã€Google Colabã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€Google Colabã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯Huggingfaceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€Kaggleç’°å¢ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
> > 
> > 
> > 
> > > ## philipha2
> > > 
> > > è¿”ä¿¡ã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
> > > 
> > > é€šå¸¸ã€ã‚ãªãŸã¯ã©ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ
> > > 
> > > Kaggleã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆGPUï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚è‡ªåˆ†ã®GPUã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿ
> > > 
> > > 
> > > ## kaoutarTopicè‘—è€…
> > > 
> > > ç§ã¯å€‹äººçš„ãªGPUã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚
> > > 
> > > 
> > > > ## Krens
> > > > 
> > > > > 
> > > > Kaggleã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã®æœ€åˆã®ã‚»ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Kaggleãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
> > > > 
> > > > 
---
```

** @@@ Jupyter Notebook numver 5, the number of votes :39 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‘ã‘ãŸåŸºç›¤ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€Œriggingã€ã¨ã€ŒvLLMã€ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚

### å•é¡Œ:
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’è©•ä¾¡ã™ã‚‹ã‚‚ã®ã§ã€å…¥åŠ›ã«åŸºã¥ã„ã¦åŠ¹æœçš„ãªè³ªå•ã‚’ç”Ÿæˆã—ã€æ­£ç¢ºãªç­”ãˆã‚’å°ãå‡ºã™ã“ã¨ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€LLMãŒãã®ã‚¿ã‚¹ã‚¯ã‚’é”æˆã™ã‚‹ãŸã‚ã®åŠ¹ç‡çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### è§£æ±ºæ‰‹æ³•:
1. **riggingãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: LLMã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«è¡Œã†ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€è¤‡æ•°ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰LLMãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’ç¢ºèªã—ã€æˆåŠŸã™ã‚‹ã¾ã§å†è©¦è¡Œã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¨­è¨ˆã§ãã¾ã™ã€‚
   
2. **vLLMãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: LLMãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã€åŠ¹ç‡çš„ã«ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€`llama3`ã®é‡å­åŒ–ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œã‚’å¼·åŒ–ã—ã¾ã™ã€‚

### æ‰‹æ³•ã®å®Ÿè£…:
- ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¯ã€åˆæœŸè¨­å®šã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€`rigging`ã‚„`vLLM`ãŒå«ã¾ã‚Œã€ã“ã‚Œã‚‰ã‚’Kaggleç’°å¢ƒã«ã®ä¸­ã§é©åˆ‡ã«é…ç½®ã—ã¾ã™ã€‚
- ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’Hugging Faceã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒªã‚®ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
- è³ªå•ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®LLMã®æŒ™å‹•ã‚’å®šç¾©ã™ã‚‹ã‚¯ãƒ©ã‚¹ï¼ˆ`Answer`ã€`Question`ç­‰ï¼‰ãŒè¨­è¨ˆã•ã‚Œã€æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›å½¢å¼ã‚‚æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
- è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã€ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒƒã‚¯ãªè³ªå•ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ãƒªã‚®ãƒ³ã‚°ã¨vLLMã‚’çµ±åˆã—ã¦ã€LLMãŒåŠ¹æœçš„ã«ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å‚åŠ ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’é€šã˜ã¦ã€å‚åŠ è€…ã¯è‡ªèº«ã®ãƒœãƒƒãƒˆã®ãŸã‚ã®å¼·å›ºãªåŸºç›¤ã‚’ç¯‰ãã“ã¨ãŒã§ãã€ã‚²ãƒ¼ãƒ ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®å¿œç­”ç”Ÿæˆã«é–¢ã™ã‚‹çŸ¥è¦‹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# LLM 20 Questions ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ãƒªã‚®ãƒ³ã‚°

ã“ã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€Œriggingã€ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æå‡ºã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã¯ã€`llama3`ã®é‡å­åŒ–ãƒ¢ãƒ‡ãƒ«ã‚’vLLMã‚’ä½¿ç”¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

## æ›´æ–° **2024å¹´6æœˆ10æ—¥**
- rigging 2.0ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯ã†ã¾ãæ©Ÿèƒ½ã—ãªã„**æ—¢çŸ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ´»ç”¨ã™ã‚‹éLLMè³ªå•ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å«ã‚€**ã€‚å›ç­”ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€riggingã‚’ä»‹ã—ã¦LLMã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## ãƒªã‚®ãƒ³ã‚°ã¨ã¯ï¼Ÿ

ãƒªã‚®ãƒ³ã‚°ã¯ã€Pydantic XMLã«åŸºã¥ãè»½é‡ã®LLMã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ç›®çš„ã¯ã€LLMã‚’ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã§ãã‚‹ã ã‘ç°¡å˜ã‹ã¤åŠ¹æœçš„ã«æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚ãƒªã‚®ãƒ³ã‚°ã¯ã€20ã®è³ªå•ã‚¿ã‚¹ã‚¯ã«ç†æƒ³çš„ã§ã€ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ã€‚
1. ç•°ãªã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰LLMãƒ¢ãƒ‡ãƒ«ã‚’ç°¡å˜ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã€‚
2. æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’ç¢ºèªã—ã€æˆåŠŸã™ã‚‹ã¾ã§å†è©¦è¡Œã™ã‚‹LLMã‚¯ã‚¨ãƒªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¨­è¨ˆã§ãã‚‹ã€‚
3. å‹ãƒ’ãƒ³ãƒˆã€éåŒæœŸã‚µãƒãƒ¼ãƒˆã€Pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’å‚™ãˆãŸãƒ¢ãƒ€ãƒ³ãªPythonã‚’æ´»ç”¨ã€‚

ã“ã¡ã‚‰ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¹ã‚¿ãƒ¼ã—ã¦ãã ã•ã„: https://github.com/dreadnode/rigging
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã“ã“ã§èª­ã‚€ã“ã¨ãŒã§ãã¾ã™: https://rigging.dreadnode.io/

ãƒªã‚®ãƒ³ã‚°ã¯ã€[dreadnode](https://www.dreadnode.io/)ã«ã‚ˆã£ã¦æ§‹ç¯‰ãƒ»ç¶­æŒã•ã‚Œã¦ãŠã‚Šã€ç§ãŸã¡ã¯æ—¥å¸¸çš„ã«ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ãƒªã‚®ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¾‹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```{python}
chat = rg.get_generator('gpt-4o') \
    .chat(f"å—ã‚¢ãƒ¡ãƒªã‚«ã®Aã§å§‹ã¾ã‚‹å›½åã‚’æ•™ãˆã¦ãã ã•ã„ {Answer.xml_tags()} ã‚¿ã‚°.") \
    .until_parsed_as(Answer) \
    .run() 
```

ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã€ã»ã¨ã‚“ã©ã®ä¸»è¦ãªLLM APIã¨ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ä½œæˆã§ãã¾ã™ã€‚APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é™ã‚Šã§ã™ã€‚
```
export OPENAI_API_KEY=...
export TOGETHER_API_KEY=...
export TOGETHERAI_API_KEY=...
export MISTRAL_API_KEY=...
export ANTHROPIC_API_KEY=...
```

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒªã‚®ãƒ³ã‚°ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§transformersã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ä»¥ä¸‹ã¯ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ä¸€éƒ¨ã§ã™ã€‚ã“ã“ã§ã¯ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã„ã¾ã™ã€‚
- Huggingfaceã¨kaggleã®ãŸã‚ã®ç§˜å¯†ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- vLLMã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®è£œåŠ©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€kaggleã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ãŸéš ã—ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã„ãã¤ã‹ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…ãšã—ã‚‚å¿…è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN: str | None  = None
KAGGLE_KEY: str | None = None
KAGGLE_USERNAME: str | None = None
    
try:
    HF_TOKEN = secrets.get_secret("HF_TOKEN")
    KAGGLE_KEY = secrets.get_secret("KAGGLE_KEY")
    KAGGLE_USERNAME = secrets.get_secret("KAGGLE_USERNAME")
except:
    pass
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [rigging](https://github.com/dreadnode/rigging): ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã®LLMãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚
- [vLLM](https://github.com/vllm-project/vllm): ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚

ã¾ãŸã€[uv](https://github.com/astral-sh/uv)ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã“ã‚Œã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šé€Ÿãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

**æ³¨æ„:** ã“ã‚Œã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯`/kaggle/tmp/lib`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ç›®çš„ã®ãŸã‚ã§ã‚ã‚Šã€å¾Œã§æå‡ºzipã«ã“ã®ãƒ‘ã‚¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€vllmã®ä¾å­˜é–¢ä¿‚ã‚‚`/kaggle/tmp/srvlib`ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
# ä¾å­˜é–¢ä¿‚ï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚ã®uvï¼‰
!pip install uv==0.1.45

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/lib \
    rigging==2.0.0 \
    kaggle

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/srvlib \
    vllm==0.4.2 \
    numpy==1.26.4
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã¾ãšHuggingfaceã®`snapshot_download`ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

`solidrust/Meta-Llama-3-8B-Instruct-hf-AWQ`ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®è¦ä»¶ã‚’æº€ãŸã™ã®ã«ååˆ†å°ã•ã„ãƒ¢ãƒ‡ãƒ«ã®æ´»æ€§åŒ–æ„è­˜å‹é‡ã¿é‡å­åŒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚

**æ³¨æ„:** é€šå¸¸ã®çŠ¶æ³ã§ãƒªã‚®ãƒ³ã‚°ã‚’ä½¿ç”¨ã™ã‚‹éš›ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«æå‡ºzipã«å«ã‚ã‚‹ãŸã‚ã«åˆ¥ã€…ã«é‡ã¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
# ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/kaggle/tmp/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)
g_model_path.mkdir(parents=True)

snapshot_download(
    repo_id="solidrust/Meta-Llama-3-8B-Instruct-hf-AWQ",
    ignore_patterns="original*",
    local_dir=g_model_path,
    local_dir_use_symlinks=False,
    token=globals().get("HF_TOKEN", None)
)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã¯`/kaggle/tmp/model/`ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
!ls -l /kaggle/tmp/model
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«

ã“ã‚Œã¯ã€vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
%%writefile util.py

# vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼

import subprocess
import os
import socket
import time

def check_port(port: int) -> bool:
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
            sock.settimeout(1)
            result = sock.connect_ex(('localhost', port))
            if result == 0:
                return True
    except socket.error:
        pass
    
    return False

def run_and_wait_for_port(
    cmd: list[str], port: int, env: dict[str, str] | None, timeout: int = 60, debug: bool = False
) -> subprocess.Popen:
    
    if check_port(port):
        raise ValueError(f"ãƒãƒ¼ãƒˆ {port} ã¯ã™ã§ã«ã‚ªãƒ¼ãƒ—ãƒ³ã§ã™")
        
    popen = subprocess.Popen(
        cmd,
        env={**os.environ, **(env or {})},
        stdout=subprocess.DEVNULL if not debug else None,
        stderr=subprocess.DEVNULL if not debug else None,
    )
    
    start_time = time.time()
    while time.time() - start_time < timeout:
        if check_port(port):
            return popen
        time.sleep(1)
    
    popen.terminate()
    raise Exception(f"ãƒ—ãƒ­ã‚»ã‚¹ãŒ {timeout}ç§’ä»¥å†…ã«ãƒãƒ¼ãƒˆ {port} ã‚’é–‹ã‹ãªã‹ã£ãŸã€‚")
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
# vLLMã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«èµ·å‹•

ç§ãŸã¡ã®ãƒ¢ãƒ‡ãƒ«ã¯vLLMã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ›ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã§ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’èµ·å‹•ã—ã€Kaggleç’°å¢ƒã§ã®å‹•ä½œã‚’ç†è§£ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 12)---
```python
# vLLMã®ãƒ‘ã‚¹ã¨è¨­å®š

import importlib
from pathlib import Path
import util

util = importlib.reload(util)

g_srvlib_path = Path("/kaggle/tmp/srvlib")
assert g_srvlib_path.exists()

g_model_path = Path("/kaggle/tmp/model")
assert g_model_path.exists()

g_vllm_port = 9999
g_vllm_model_name = "custom"
```

---The following area is a Code cell (cell numver is 13)---
```python
# ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½¿ç”¨ã—ã¦vLLMã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œ
vllm = util.run_and_wait_for_port([
    "python", "-m",
    "vllm.entrypoints.openai.api_server",
    "--enforce-eager",
    "--model", str(g_model_path),
    "--port", str(g_vllm_port),
    "--served-model-name", g_vllm_model_name
],
    g_vllm_port,
    {"PYTHONPATH": str(g_srvlib_path)},
    debug=False
)

print("vLLMãŒèµ·å‹•ã—ã¾ã—ãŸ")
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
ç§ãŸã¡ã®llama3ãƒ¢ãƒ‡ãƒ«ã¯1å°ç›®ã®Tesla T4 GPUã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
!nvidia-smi
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
## ãƒ¢ãƒ‡ãƒ«ã®æ¤œè¨¼

åˆã‚ã¦ã®ãƒªã‚®ãƒ³ã‚°ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚ãƒªã‚®ãƒ³ã‚°ã§ã¯ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒå¼·åŠ›ãªLLMãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®åŸºç›¤ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
# ãƒªã‚®ãƒ³ã‚°ã¨ã®æ¥ç¶š

import sys
import logging

sys.path.insert(0, "/kaggle/tmp/lib")

logging.getLogger("LiteLLM").setLevel(logging.WARNING)

import rigging as rg

generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—ã®æ‰‹åŠ©ã‘ãŒå¿…è¦
)

answer = await generator.chat("ã“ã‚“ã«ã¡ã¯ï¼").run()

print()
print('[ãƒªã‚®ãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ]')
print(type(answer), answer)

print()
print('[LLMã®å¿œç­”ã®ã¿]')
print(type(answer.last), answer.last)

print()
answer_string = answer.last.content
print('[LLMã®å¿œç­”ã‚’æ–‡å­—åˆ—ã¨ã—ã¦]')
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
## çµæœã‚’pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›

`to_df()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç°¡å˜ã«pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 19)---
```python
answer.to_df()
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
## ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã®ã‚ˆã†ã«ã€ãƒªã‚®ãƒ³ã‚°ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã€ã©ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ãƒ¢ãƒ‡ãƒ«ã€APIã‚­ãƒ¼ã€ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’å®šç¾©ã™ã‚‹æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¾ã§ãã¾ã™ã€‚å½¢å¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```
<provider>!<model>,<**kwargs>
```

ä¾‹ãˆã°ã€ã“ã“ã§ã¯è¿½åŠ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼š
- temperature=0.9
- max_tokens=512

ã“ã‚Œã‚‰ã«é–¢ã™ã‚‹è©³ç´°ã¯ã€ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ãŠèª­ã¿ã„ãŸã ã‘ã¾ã™: https://rigging.dreadnode.io/topics/generators/#overload-generation-params
```

---The following area is a Code cell (cell numver is 21)---
```python
generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "temperature=0.9,max_tokens=512," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—ã®æ‰‹åŠ©ã‘ãŒå¿…è¦
)
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
ã¾ãŸã¯ã€`rg.GenerateParams`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã•ã¾ã–ã¾ãªãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã§ãã¾ã™ï¼š

```
rg.GenerateParams(
    *,
    temperature: float | None = None,
    max_tokens: int | None = None,
    top_k: int | None = None,
    top_p: float | None = None,
    stop: list[str] | None = None,
    presence_penalty: float | None = None,
    frequency_penalty: float | None = None,
    api_base: str | None = None,
    timeout: int | None = None,
    seed: int | None = None,
    extra: dict[str, typing.Any] = None,
)
```

https://rigging.dreadnode.io/api/generator/#rigging.generator.GenerateParams
```

---The following area is a Code cell (cell numver is 23)---
```python
rg_params = rg.GenerateParams(
    temperature = 0.9,
    max_tokens = 512,
)
base_chat = generator.chat(params=rg_params)
answer = await base_chat.fork('èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿ').run()
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
ã¾ãŸã€paramså†…ã§ãƒã‚§ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 25)---
```python
base_chat = generator.chat() # paramsã‚’è¨­å®šã—ã¦ã„ãªã„
answer = await base_chat.fork('èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿ') \
    .with_(temperature = 0.9, max_tokens = 512) \
    .run()
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
# è§£æã•ã‚ŒãŸå‡ºåŠ›ã®ä¾‹

æ¬¡ã«ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
1. `Answer`ã¨ã„ã†ãƒªã‚®ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®çµæœã‹ã‚‰è§£æã•ã‚Œã‚‹æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚
    - å‡ºåŠ›ãŒ`yes`ã¾ãŸã¯`no`ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã€‚
    - ã“ã‚Œã¯å®Œå…¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã™ã€‚
    - ã“ã“ã§`validate_content`ã¯ã€å¿œç­”ãŒæœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã«æº–æ‹ ã—ã¦ã„ã‚‹ã“ã¨ï¼ˆå°æ–‡å­—ã§ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã§å§‹ã¾ã‚‹ï¼‰ã‚’ç¢ºèªã—ã¾ã™ã€‚
2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§`.xml_example()`ã‚’ä½¿ç”¨ã—ã¦ã€LLMãŒå‡ºåŠ›ã®è¦‹ãŸç›®ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
3. å¾Œã§ã€`.until_parsed_as(Answer)`ã‚’ä½¿ç”¨ã—ã¦ã€LLMã®å‡ºåŠ›ãŒã“ã“ã§å®šç¾©ã•ã‚ŒãŸã‚ˆã†ã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

**æ³¨æ„:** `until_parsed_as()`ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§5ã®`max_rounds`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 27)---
```python
import typing as t
from pydantic import field_validator

class Answer(rg.Model):
    content: t.Literal["yes", "no"]

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:
        for valid in ["yes", "no"]:
            if v.lower().startswith(valid):
                return valid
        raise ValueError("ç„¡åŠ¹ãªå›ç­”ã€'yes'ã¾ãŸã¯'no'ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚")

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}**yes/no**{Answer.xml_end_tag()}"
```

---The following area is a Code cell (cell numver is 28)---
```python
# xmlã®ä¾‹ãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ä½¿ç”¨ã§ãã¾ã™ã€‚
Answer.xml_example()
```

---The following area is a Code cell (cell numver is 29)---
```python
generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—ã®æ‰‹åŠ©ã‘ãŒå¿…è¦
)

keyword='ãƒˆãƒ ãƒ»ãƒãƒ³ã‚¯ã‚¹'
category='æœ‰åäºº'
last_question='ã“ã‚Œã¯æœ‰åãªäººç‰©ã§ã™ã‹ï¼Ÿ'

prompt = f"""\
            ã“ã®ã‚²ãƒ¼ãƒ ã®ç§˜å¯†ã®å˜èªã¯ "{keyword}" [{category}]ã§ã™ã€‚

            ã‚ãªãŸã¯ç¾åœ¨ã€ä¸Šè¨˜ã®å˜èªã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã¦ã„ã¾ã™ã€‚

            æ¬¡ã®è³ªå•ã¯ "{last_question}" ã§ã™ã€‚

            ä¸Šè¨˜ã®è³ªå•ã«ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã§ç­”ãˆã€æ¬¡ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼š
            {Answer.xml_example()}

            - ã‚ãªãŸã®å¿œç­”ã¯ã€ä¸Šè¨˜ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦æ­£ç¢ºã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“
            - å¸¸ã«ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã§ç­”ãˆã¦ãã ã•ã„

            ç­”ãˆã¯ä½•ã§ã™ã‹ï¼Ÿ
"""

chat = await (
    generator
    .chat(prompt)
    .until_parsed_as(Answer, max_rounds=50)
    .run()
)

print('=== ãƒ•ãƒ«ãƒãƒ£ãƒƒãƒˆ ===')
print(chat)

print()
print('=== LLMã®å¿œç­”ã®ã¿ ===')
print(chat.last)

print()
print('=== è§£æã•ã‚ŒãŸå›ç­” ===')
print(chat.last.parse(Answer).content)
```

---The following area is a Markdown cell (cell numver is 30)---
```markdown
# Riggingã‚’ä½¿ç”¨ã—ãŸè³ªå•è€…ãƒãƒ£ãƒƒãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä½œæˆ

æ¬¡ã«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä½•ã§ã‚ã‚‹ã‹ã‚’ç‰¹å®šã™ã‚‹ã®ã‚’åŠ©ã‘ã‚‹ãŸã‚ã®è³ªå•è€…ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

ã¾ãšã€å‡ºåŠ›ã‚’è§£æã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹`Question`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 31)---
```python
from pydantic import StringConstraints  # noqa

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]

class Question(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="**è³ªå•**").to_pretty_xml()
```

---The following area is a Code cell (cell numver is 32)---
```python
base =  generator.chat("""\
ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®æ‰èƒ½ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚æ­£ç¢ºã§é›†ä¸­ã—ã¦ãŠã‚Šã€
æ§‹é€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚å½¹ã«ç«‹ã¤è³ªå•ã‚’ä½œæˆã—ã€æ¨æ¸¬ã‚’è¡Œã„ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã¾ã™ã€‚

""")

question_chat = await (base.fork(
    f"""\
    ã‚ãªãŸã¯ç¾åœ¨ã€æ¬¡ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã€‚

    è³ªå•ã—ã€æ¬¡ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼š
    {Question.xml_example()}

    - ã‚ãªãŸã®å¿œç­”ã¯ã€æœ€ã‚‚å¤šãã®æƒ…å ±ã‚’åé›†ã§ãã‚‹ç„¦ç‚¹ã‚’çµã£ãŸè³ªå•ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“
    - è³ªå•ã¯ä¸€èˆ¬çš„ã«å§‹ã‚ã¦ãã ã•ã„
    - æ®‹ã‚Šã®æ¤œç´¢ç©ºé–“ã‚’å¸¸ã«äºŒåˆ†ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„
    - ä»¥å‰ã®è³ªå•ã¨å›ç­”ã«æ³¨æ„ã‚’æ‰•ã£ã¦ãã ã•ã„

    ã‚ãªãŸã®æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ
    """
)
.until_parsed_as(Question, attempt_recovery=True)
.run()
)
```

---The following area is a Code cell (cell numver is 33)---
```python
# ä¼šè©±ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º
question_chat.to_df()
```

---The following area is a Markdown cell (cell numver is 34)---
```markdown
ç§ãŸã¡ã¯ã€LLMã®å¿œç­”ãŒè³ªå•ã‚’å«ã‚€ã“ã¨ã‚’ç¢ºä¿¡ã—ã¦ãŠã‚Šã€è³ªå•ã‚’è§£æã—ã¦æ¬¡ã®ã‚ˆã†ã«ã§ãã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 35)---
```python
question = question_chat.last.parse(Question).content
print(question)
```

---The following area is a Markdown cell (cell numver is 36)---
```markdown
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆ
**æ³¨æ„:** ã“ã‚Œã¯ã€å…¬é–‹ã‚»ãƒƒãƒˆã®å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ãŸã‚ã«ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚æœ€çµ‚çš„ãªãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 37)---
```python
!wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py
```

---The following area is a Code cell (cell numver is 38)---
```python
!head keywords_local.py
```

---The following area is a Code cell (cell numver is 39)---
```python
import sys
import json
import pandas as pd
sys.path.append('./')
from keywords_local import KEYWORDS_JSON

def capitalize_first_word(text):
    if not text:
        return text
    return text[0].upper() + text[1:].lower()

def create_keyword_df(KEYWORDS_JSON):
    keywords_dict = json.loads(KEYWORDS_JSON)

    category_words_dict = {}
    all_words = []
    all_cat_words = []
    for d in keywords_dict:
        words = [w['keyword'] for w in d['words']]
        cat_word = [(d['category'], w['keyword']) for w in d['words']]
        category_words_dict[d['category']] = words
        all_words += words
        all_cat_words += cat_word

    keyword_df = pd.DataFrame(all_cat_words, columns=['category','keyword'])
    keyword_df['first_letter'] = keyword_df['keyword'].str[0]
    keyword_df['second_letter'] = keyword_df['keyword'].str[1]
    keyword_df.to_parquet('keywords.parquet')
    
create_keyword_df(KEYWORDS_JSON)
```

---The following area is a Code cell (cell numver is 40)---
```python
keywords_df = pd.read_parquet('keywords.parquet')
keywords_df.sample(10)
```

---The following area is a Code cell (cell numver is 41)---
```python
keywords_df['category'].value_counts()
```

---The following area is a Markdown cell (cell numver is 42)---
```markdown
# æœ€çµ‚æå‡ºã®ãŸã‚ã®`main.py`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ

ç§ãŸã¡ã®æœ€çµ‚æå‡ºã¯ã€`main`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€zipãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 43)---
```python
%%writefile main.py

# ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

import itertools
import os
import sys
import typing as t
from pathlib import Path
import logging

import string
import numpy as np
import pandas as pd

# ãƒ‘ã‚¹ã®ä¿®æ­£

g_working_path = Path('/kaggle/working')
g_input_path = Path('/kaggle/input')
g_temp_path = Path("/kaggle/tmp")
g_agent_path = Path("/kaggle_simulations/agent/")

g_model_path = g_temp_path / "model"
g_srvlib_path = g_temp_path / "srvlib"
g_lib_path = g_temp_path / "lib"

if g_agent_path.exists():
    g_lib_path = g_agent_path / "lib"
    g_model_path = g_agent_path / "model"
    g_srvlib_path = g_agent_path / "srvlib"
else:
    g_agent_path = Path('/kaggle/working')
    
sys.path.insert(0, str(g_lib_path))

# ãƒ­ã‚®ãƒ³ã‚°ã®ãƒã‚¤ã‚º

logging.getLogger("LiteLLM").setLevel(logging.WARNING)

# å›ºå®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ

import util # noqa
import rigging as rg  # noqa
from pydantic import BaseModel, field_validator, StringConstraints  # noqa

# å®šæ•°

g_vllm_port = 9999
g_vllm_model_name = "custom"

g_generator_id = (
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—ã®æ‰‹åŠ©ã‘ãŒå¿…è¦
)

# ã‚¿ã‚¤ãƒ—

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]

class Observation(BaseModel):
    step: int
    role: t.Literal["guesser", "answerer"]
    turnType: t.Literal["ask", "answer", "guess"]
    keyword: str
    category: str
    questions: list[str]
    answers: list[str]
    guesses: list[str]
    
    @property
    def empty(self) -> bool:
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")

    def get_history_as_xml(self, *, skip_guesses: bool = False) -> str:
        if not self.empty:
            history = "\n".join(
            f"""\
            <turn-{i}>
            è³ªå•: {question}
            å›ç­”: {answer}
            {'æ¨æ¸¬: ' + guess if not skip_guesses else ''}
            </turn-{i}>
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
            )
            return history
        return "ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚"


class Answer(rg.Model):
    content: t.Literal["yes", "no"]

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:
        for valid in ["yes", "no"]:
            if v.lower().startswith(valid):
                return valid
        raise ValueError("ç„¡åŠ¹ãªå›ç­”ã€'yes'ã¾ãŸã¯'no'ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚")

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}yes/no{Answer.xml_end_tag()}"


class Question(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="è³ªå•").to_pretty_xml()


class Guess(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Guess(content="ç‰©ã‚„å ´æ‰€").to_pretty_xml()


# é–¢æ•°

async def ask(base: rg.ChatPipeline, observation: Observation) -> str:
    if observation.step == 0:
        # åˆå›ã®è³ªå•ã‚’ä¸Šæ›¸ãã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚°ãŒä¿®æ­£ã•ã‚Œã‚‹ã¾ã§å‡¦ç†ã—ã¾ã™ã€‚
        return "20ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ"
    
    try:
        chat = await (
             base.fork(
                f"""\
                ã‚ãªãŸã¯ç¾åœ¨ã€æ¬¡ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã€‚

                <game-history>
                {observation.get_history_as_xml(skip_guesses=True)}
                </game-history>

                ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ã¦ã€æ¬¡ã®æœ€ã‚‚æœ‰ç”¨ãªyes/noè³ªå•ã‚’è¡Œã„ã€æ¬¡ã®å½¢å¼ã«ã—ã¦ãã ã•ã„:
                {Question.xml_example()}

                - ã‚ãªãŸã®å¿œç­”ã¯ã€æœ€ã‚‚å¤šãã®æƒ…å ±ã‚’åé›†ã§ãã‚‹ç„¦ç‚¹ã‚’çµã£ãŸè³ªå•ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“
                - è³ªå•ã¯ä¸€èˆ¬çš„ã«å§‹ã‚ã¦ãã ã•ã„
                - æ®‹ã‚Šã®æ¤œç´¢ç©ºé–“ã‚’å¸¸ã«äºŒåˆ†ã—ã¦ãã ã•ã„
                - ä»¥å‰ã®è³ªå•ã¨å›ç­”ã«æ³¨æ„ã‚’æ‰•ã£ã¦ãã ã•ã„

                ã‚ãªãŸã®æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ
                """
            )
            .until_parsed_as(Question, attempt_recovery=True, max_rounds=20)
            .run()
        )
        return chat.last.parse(Question).content.strip('*')
    except rg.error.MessagesExhaustedMaxRoundsError:
        return 'äººç‰©ã§ã™ã‹ï¼Ÿ'

async def answer(base: rg.ChatPipeline, observation: Observation) -> t.Literal["yes", "no"]:
    if not observation.keyword:
        print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå›ç­”è€…ã«æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“", file=sys.stderr)
        return "yes" # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚°ãŒä¿®æ­£ã•ã‚Œã‚‹ã¾ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚
            
    last_question = observation.questions[-1]
    
#     print('=' * 10)
#     print(f"""\
#                 æä¾›ã™ã‚‹æœ€è‰¯ã®yes/noå›ç­”ã‚’ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ [{observation.keyword}] ã«é–¢ã™ã‚‹è³ªå•ã¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
# 
#                 [è³ªå•] "{last_question}" [/è³ªå•]
#                 
#                 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ [{observation.keyword}] ã§ã™
#                 
#                 ä¸Šè¨˜ã®è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’æ¬¡ã®å½¢å¼ã§æä¾›ã—ã¦ãã ã•ã„ï¼š
#                 {Answer.xml_example()}
#                 """
#          )
#     print('=' * 10)
    try:
        responses = []
        for i in range(5):
            # 5å›ãƒ«ãƒ¼ãƒ—ã—ã€æœ€ã‚‚é »ç¹ãªå¿œç­”ã‚’å–å¾—ã™ã‚‹
            chat = await (
                base.fork(
                    f"""\
                    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ [{observation.keyword}] ã«é–¢ã™ã‚‹è³ªå•ã«å¯¾ã™ã‚‹æœ€è‰¯ã®yes/noå›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

                    [è³ªå•] "{last_question}" [/è³ªå•]

                    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ [{observation.keyword}] ã§ã™

                    ä¸Šè¨˜ã®è³ªå•ã«å¯¾ã—ã¦æœ€è‰¯ã®å›ç­”ã‚’æ¬¡ã®å½¢å¼ã§è¡Œã£ã¦ãã ã•ã„ï¼š
                    {Answer.xml_example()}
                    """
                )
                .until_parsed_as(Answer, attempt_recovery=True, max_rounds=20)
                .run()
            )
            responses.append(chat.last.parse(Answer).content.strip('*'))
            
        print(f'å¿œç­”ã¯ {responses}')
        return pd.Series(responses).value_counts().index[0]
#         print('=' * 10)
#         print('å¿œç­”.....')
#         print(chat.last)
#         print('=' * 10)
#         return chat.last.parse(Answer).content.strip('*')
    except rg.error.MessagesExhaustedMaxRoundsError:
        print('%%%%%%%%%%%% ã‚¨ãƒ©ãƒ¼ã§yesã¨å›ç­”ã—ã¾ã™ %%%%%%%%%%%% ')
        return 'yes'

async def guess(base: rg.ChatPipeline, observation: Observation) -> str:
    try:

        chat = await (
            base.fork(
                f"""\
                ã‚ãªãŸã¯ç¾åœ¨ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã®æ¨æ¸¬ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

                <game-history>
                {observation.get_history_as_xml()}
                </game-history>

                ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ã¦ã€å˜ä¸€ã®æ¬¡ã®æœ€è‰¯ã®æ¨æ¸¬ã‚’è¡Œã„ã€æ¬¡ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼š
                {Guess.xml_example()}

                - ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ãŸé‡è¤‡æ¨æ¸¬ã‚’é¿ã‘ã¦ãã ã•ã„
                - æ¨æ¸¬ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ç‰©ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

                ã‚ãªãŸã®æ¨æ¸¬ã¯ä½•ã§ã™ã‹ï¼Ÿ
                """
            )
            .until_parsed_as(Guess, attempt_recovery=True, max_rounds=20)
            .run()
        )

        return chat.last.parse(Guess).content.strip('*')
    except rg.error.MessagesExhaustedMaxRoundsError:
        return 'ãƒ•ãƒ©ãƒ³ã‚¹'
    
# vLLMã¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®è¨­å®š

try:
    vllm = util.run_and_wait_for_port([
        "python", "-m",
        "vllm.entrypoints.openai.api_server",
        "--enforce-eager",
        "--model", str(g_model_path),
        "--port", str(g_vllm_port),
        "--served-model-name", g_vllm_model_name
    ], g_vllm_port, {"PYTHONPATH": str(g_srvlib_path)})

    print("vLLMãŒèµ·å‹•ã—ã¾ã—ãŸ")
except ValueError:
    print('vLLMã¯ã™ã§ã«å®Ÿè¡Œä¸­ã§ã™')
    
    
generator = rg.get_generator(g_generator_id)

base =  generator.chat("""\
ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®æ‰èƒ½ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚æ­£ç¢ºã§é›†ä¸­ã—ã¦ãŠã‚Šã€
æ§‹é€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚å½¹ã«ç«‹ã¤è³ªå•ã‚’ä½œæˆã—ã€æ¨æ¸¬ã‚’è¡Œã„ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã¾ã™ã€‚

""")

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
def format_first_letter_question(letters):
    if not letters:
        return "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã©ã®æ–‡å­—ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    if len(letters) == 1:
        return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ '{letters[0]}' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    formatted_letters = ", ".join(f"'{letter}'" for letter in letters[:-1])
    formatted_letters += f" ã¾ãŸã¯ '{letters[-1]}'"
    
    return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®æ–‡å­—ã®ã„ãšã‚Œã‹ã§å§‹ã¾ã‚Šã¾ã™ã‹ {formatted_letters}ï¼Ÿ"

import re

def extract_letters_from_question(question):
    pattern = r"'([a-zA-Z])'"
    matches = re.findall(pattern, question)
    return matches

# ã‚·ãƒ³ãƒ—ãƒ«ãªè³ªå•è€…
class SimpleQuestionerAgent():
    def __init__(self, keyword_df: pd.DataFrame):
        self.keyword_df = keyword_df
        self.keyword_df_init = keyword_df.copy()
        self.round = 0
        self.category_questions = [
            "ç§ãŸã¡ã¯20ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
            "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰©ã§ã€å ´æ‰€ã§ã¯ãªã„ã§ã™ã‹ï¼Ÿ",
            "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ",
        ]
        self.found_category = False
        
    def filter_keywords(self, obs):
        print(self.keyword_df.shape)
        # éå»ã®å›ç­”ã«åŸºã¥ã„ã¦keyword_dfã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        for i, answer in enumerate(obs.answers):
            if obs.questions[i] in self.category_questions:
                if answer == 'yes':
                    if obs.questions[i] == "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰©ã§ã€å ´æ‰€ã§ã¯ãªã„ã§ã™ã‹ï¼Ÿ":
                        self.found_category = 'things'
                    if obs.questions[i] == "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ":
                        self.found_category = 'place'
                    fc = self.found_category
                    self.keyword_df = self.keyword_df.query('category == @fc').reset_index(drop=True)
    
            if obs.questions[i].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹'):
                if self.keyword_df['first_letter'].nunique() <= 1:
                    break
                letter_question = obs.questions[i]
                letters = extract_letters_from_question(letter_question)
                self.keyword_df = self.keyword_df.reset_index(drop=True).copy()
                if obs.answers[i] == 'yes':
                    self.keyword_df = self.keyword_df.loc[
                        self.keyword_df['first_letter'].isin(letters)].reset_index(drop=True).copy()
                elif obs.answers[i] == 'no':
                    self.keyword_df = self.keyword_df.loc[
                        ~self.keyword_df['first_letter'].isin(letters)].reset_index(drop=True).copy()
        if len(self.keyword_df) == 0:
            # ãƒªã‚»ãƒƒãƒˆ
            self.keyword_df = self.keyword_df_init.copy()
            
    def get_letters(self, obs, max_letters=20):
        n_letters = self.keyword_df['first_letter'].nunique()
        sample_letters = self.keyword_df['first_letter'].drop_duplicates().sample(n_letters // 2).values.tolist()
        sample_letters = sample_letters[:max_letters]
        print('ã‚µãƒ³ãƒ—ãƒ«æ–‡å­—', n_letters, sample_letters)
        return sample_letters # ', '.join(sample_letters)
    
    def __call__(self, obs, *args):
        if len(self.keyword_df) == 0:
            # ãƒªã‚»ãƒƒãƒˆ
            self.keyword_df = self.keyword_df_init.copy()
        self.filter_keywords(obs)
        if obs.turnType == 'ask':
            self.round += 1
            if (self.round <= 3 and not self.found_category):
                response = self.category_questions[self.round - 1]
            else:
                sample_letters = self.get_letters(obs)
                if len(sample_letters) == 0:
                    n_sample = min(len(self.keyword_df), 10)
                    possible_keywords = ", ".join(self.keyword_df['keyword'].sample(n_sample).values.tolist())
                    response = f"æ¬¡ã®ä¸­ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ {possible_keywords}"
                else:
                    sample_letters_str = str(sample_letters).replace('[','').replace(']','')
                    response = format_first_letter_question(sample_letters)
        elif obs.turnType == 'guess':
            response = self.keyword_df['keyword'].sample(1).values[0]
            # æ¨æ¸¬ã•ã‚ŒãŸå˜èªã‚’å‰Šé™¤
            updated_df = self.keyword_df.loc[self.keyword_df['keyword'] != response].reset_index(drop=True).copy()
            if len(updated_df) >= 1:
                self.keyword_df = updated_df.copy()
            else:
                self.keyword_df = self.keyword_df_init.copy() # DFã‚’ãƒªã‚»ãƒƒãƒˆ
        return response


keyword_df = pd.read_parquet(f'{g_agent_path}/keywords.parquet')
question_agent = None

async def observe(obs: t.Any) -> str:
    observation = Observation(**obs.__dict__)
    global question_agent
    if question_agent is None:
        question_agent = SimpleQuestionerAgent(keyword_df)

    try:
        match observation.turnType:
            case "ask":
                return question_agent(obs)
            case "answer":
                return await answer(base, observation)
            case "guess":
                return question_agent(obs)

            case _:
                raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã§ã™")
    except Exception as e:
        print(str(e), file=sys.stderr)
        raise

def agent_fn(obs: t.Any, _: t.Any) -> str:
    # å½¼ã‚‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å®Ÿè¡Œã™ã‚‹éš›ã®éåŒæœŸã‚²ãƒ¼ãƒˆ
    import asyncio
    return asyncio.run(observe(obs))
```

---The following area is a Markdown cell (cell numver is 44)---
```markdown
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå·±å¯¾æˆ¦ã—ã¦ãƒ†ã‚¹ãƒˆ
```

---The following area is a Code cell (cell numver is 45)---
```python
def format_first_letter_question(letters):
    if not letters:
        return "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã©ã®æ–‡å­—ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    if len(letters) == 1:
        return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ '{letters[0]}' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    formatted_letters = ", ".join(f"'{letter}'" for letter in letters[:-1])
    formatted_letters += f" ã¾ãŸã¯ '{letters[-1]}'"
    
    return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®æ–‡å­—ã®ã„ãšã‚Œã‹ã§å§‹ã¾ã‚Šã¾ã™ã‹ {formatted_letters}ï¼Ÿ"

format_first_letter_question(['a','b','c'])

import re

def extract_letters_from_question(question):
    pattern = r"'([a-zA-Z])'"
    matches = re.findall(pattern, question)
    return matches
```

---The following area is a Code cell (cell numver is 46)---
```python
%load_ext autoreload
%autoreload 2
from main import Observation, agent_fn, observe
```

---The following area is a Code cell (cell numver is 47)---
```python
# vllmãŒå®Ÿè¡Œä¸­ã‹ã©ã†ã‹ç¢ºèª
!ps -aef | grep vllm
```

---The following area is a Code cell (cell numver is 48)---
```python
import pandas as pd

keyword_df = pd.read_parquet('keywords.parquet')
sample = keyword_df.sample(1)

obs = Observation(step = 0,
    role = 'guesser',
    turnType= "ask",
    keyword= sample['keyword'].values[0],
    category= sample['category'].values[0],
    questions = [],
    answers= [],
    guesses= [],
)


for i in range(20):
    obs.role = 'guesser'
    obs.turnType = 'ask'
    question = await observe(obs)
    print(f'[{i}ã®è³ªå•]: {question}')
    obs.questions.append(question)
    obs.role = 'answerer'
    obs.turnType = 'answer'
    answer = await observe(obs)
    obs.answers.append(answer)
    
    if obs.questions[-1].startswith('Are we playing 20 questions?'):
        gt_answer = answer # ãªã‚“ã§ã‚‚è‰¯ã„
    elif obs.questions[-1].startswith('Is the keyword a thing that is not a place?'):
        if sample['category'].values[0] == 'things':
            gt_answer = 'yes'
        else:
            gt_answer = 'no'
    elif obs.questions[-1].startswith('Is the keyword a place?'):
        if sample['category'].values[0] == 'place':
            gt_answer = 'yes'
        else:
            gt_answer = 'no'
    elif obs.questions[-1].startswith('Does the keyword start'):
        letters_guess = extract_letters_from_question(obs.questions[-1])
        gt_answer = obs.keyword[0] in letters_guess
        gt_answer = 'yes' if gt_answer else 'no'
    elif obs.questions[-1].startswith('Is the keyword one of the following?'):
        possible_kw = obs.questions[-1].replace('Is the keyword one of the following? ','').split(',')
        possible_kw = [c.strip(' ') for c in possible_kw]
        print(possible_kw)
        gt_answer = obs.keyword in possible_kw
        gt_answer = 'yes' if gt_answer else 'no'

    print(f'[{i}ã®å›ç­”]: {answer} [çœŸã®å›ç­”]: {gt_answer}')
    if answer != gt_answer:
        break

    obs.role = 'guesser'
    obs.turnType = 'guess'
    guess = await observe(obs)
    print(f'[{i}ã®æ¨æ¸¬]: {guess} - [ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰]: {obs.keyword}')
    obs.guesses.append(guess)
    if guess == obs.keyword:
        print('å½“ãŸã‚Šï¼')
        break
        
    obs.step += 1
```

---The following area is a Markdown cell (cell numver is 49)---
```markdown
# ãƒ¢ãƒ‡ãƒ«ã¨ã‚³ãƒ¼ãƒ‰ã®æå‡ºç”¨åœ§ç¸®
```

---The following area is a Code cell (cell numver is 50)---
```python
!apt install pigz pv
```

---The following area is a Code cell (cell numver is 51)---
```python
!tar --use-compress-program='pigz --fast' \
    -cf submission.tar.gz \
    --dereference \
    -C /kaggle/tmp model lib srvlib \
    -C /kaggle/working main.py util.py \
    -C /kaggle/working keywords.parquet
```

---The following area is a Code cell (cell numver is 52)---
```python
!ls -GFlash --color
```

---The following area is a Markdown cell (cell numver is 53)---
```markdown
# Kaggle CLIã‚’ä½¿ç”¨ã—ãŸæå‡º

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å†å®Ÿè¡Œã™ã‚‹ã“ã¨ãªãã€kaggle CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦æå‡ºã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 54)---
```python
# !KAGGLE_USERNAME={KAGGLE_USERNAME} \
#  KAGGLE_KEY={KAGGLE_KEY} \
#  kaggle competitions submit -c llm-20-questions -f submission.tar.gz -m "ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰æå‡º"
```

---The following area is a Markdown cell (cell numver is 55)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## Bhanu Prakash M
> 
> ã“ã‚“ã«ã¡ã¯ [@robikscube](https://www.kaggle.com/robikscube)ã€
> 
> vLLMã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿãƒ‡ãƒãƒƒã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
> 
> INFO 06-18 21:44:58 selector.py:69] VoltaãŠã‚ˆã³Turing GPUç”¨ã«FlashAttention-2ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
> 
> INFO 06-18 21:44:58 selector.py:32] XFormersãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
> 
> ã‚¨ãƒ©ãƒ¼ã®é•·ã„ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯ãŒç¶šãã€æœ€çµ‚çš„ãªæ–‡ã¯
> 
> ValueError: Bfloat16ã¯ã€è¨ˆç®—èƒ½åŠ›ãŒå°‘ãªãã¨ã‚‚8.0ã®GPUã§ã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚ãªãŸã®Tesla P100-PCIE-16GB GPUã¯ã€è¨ˆç®—èƒ½åŠ›ãŒ6.0ã§ã™ã€‚CLIã®dtypeãƒ•ãƒ©ã‚°ã‚’æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã§float16ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€--dtype=halfã®ã‚ˆã†ã«ã€‚

> ## Rob Mulla ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> 
> å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã¯ä½•ã§ã™ã‹ï¼Ÿ
> 
> > ## Bhanu Prakash M
> > 
> > phi-3ãƒ¢ãƒ‡ãƒ«ã§ã€ãã®é‡ã¿å±¤ã‚’llamaå½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸ
> > > [https://huggingface.co/rhysjones/Phi-3-mini-mango-1-llamafied](https://huggingface.co/rhysjones/Phi-3-mini-mango-1-llamafied)
> > > ã“ã‚ŒãŒæ­£ç¢ºãªãƒ¢ãƒ‡ãƒ«ã§ã™
> > > 
> > > > ## Bhanu Prakash M
> > > > [@robikscube](https://www.kaggle.com/robikscube) é€²å±•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
> > > > 
> > > > > ## Rob Mulla ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > > > > ã“ã“ã§å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ: [https://www.kaggle.com/code/robikscube/phi3-intro-to-rigging-for-llm-20-questions/](https://www.kaggle.com/code/robikscube/phi3-intro-to-rigging-for-llm-20-questions/)
> > > > 

---

> ## OminousDude
> 
> "ãƒ—ãƒ­ã‚»ã‚¹ãŒ120ç§’ä»¥å†…ã«ãƒãƒ¼ãƒˆ9999ã‚’é–‹ã‹ãªã‹ã£ãŸ"ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ [@robikscube](https://www.kaggle.com/robikscube)
> 
> 
> > ## Rob Mulla ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > è¦‹ã¦ã¿ã¾ã™ï¼ãƒ˜ãƒƒãƒ‰ã‚¢ãƒƒãƒ—ã‚’ã‚ã‚ŠãŒã¨ã†ã€‚
> > 
> > 
> > > ## OminousDude
> > > 
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ç§ã¯riggingã®å®Ÿé¨“ã‚’ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€æ™‚é–“é…åˆ†ã«åˆã‚ãªãã¦ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æœ¬å½“ã«åŠ©ã‹ã‚Šã¾ã™ï¼
> > > 
> > > 

---

> ## OminousDude
> 
> ã“ã‚“ã«ã¡ã¯ã€ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ãŸã®ã§ã™ãŒã€å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€"AttributeError: 'coroutine' object has no attribute 'last'"ã¨ã„ã†ä¾‹å¤–ã§å¤±æ•—ã—ã¾ã—ãŸã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

> ## Rob Mulla ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> 
> æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã‚‚å‡ºã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚ç§ãŸã¡ã¯ç¾åœ¨ã€riggingã‚’ç©æ¥µçš„ã«é–‹ç™ºã—ã¦ãŠã‚Šã€ã“ã‚Œã¯æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã®å¤‰æ›´ã®ã‚ˆã†ã§ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¦ã“ã®å¤‰æ›´ã‚’ä¿®æ­£ã™ã‚‹ã‹ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®riggingã‚’ãƒ”ãƒ³ç•™ã‚ã—ã¦å•é¡Œã‚’è§£æ±ºã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

> > ## OminousDude
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
> > > 
> > > > ## OminousDude
> > > > ãƒãƒ¼ã‚¸ãƒ§ãƒ³7ã¯å‹•ä½œã—ã¾ã™ã‹ï¼Ÿ
> > > 

---

> ## OminousDude
> 
> ç§ã¯è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§ã“ã‚Œã‚’è©¦ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€å‹•ä½œã—ã¾ã›ã‚“ã€‚ãªãœã‹åˆ†ã‹ã‚Šã¾ã™ã‹ï¼Ÿ [@robikscube](https://www.kaggle.com/robikscube) 
> 
> 

---

> ## OminousDude
> 
> ã“ã‚Œã¯ãƒã‚°ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯"solidrust/Meta-Llama-3-8B-Instruct-hf-AWQ"ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚ã“ã‚Œã‚’å…ƒã«ã—ã¦ã€Llamaã®å¤§ãã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ãŠã†ã¨ã—ã¦ã„ã‚‹ã¨ãã«ã“ã‚Œã«æ°—ã¥ãã¾ã—ãŸã€‚
> 
>
```

** @@@ Jupyter Notebook numver 6, the number of votes :36 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ã‚¿ãƒ¼ãƒ³åˆ¶ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç”¨ã„ã¦ã€äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã‚„æ–°ã—ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ‰‹æ³•ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œå®šç¾©
- **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç‰¹å®š**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒäººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’ç‰¹å®šã—ã¾ã™ã€‚
- **è€ƒãˆã‚‰ã‚Œã‚‹è§£æ±ºç­–**:
  - å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’GISãƒ‡ãƒ¼ã‚¿ã‚„è£½å“æƒ…å ±ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã€æ­£ç¢ºãªæ¨æ¸¬ã‚’æ”¯æ´ã€‚
  - åœ°ç†æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ç”¨ã„ãŸå ´æ‰€ã®è­˜åˆ¥ã€‚
  - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ãŸæ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ææ¡ˆã€‚

### ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Pandas**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ç®¡ç†ã€‚
- **JSON**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã¨ç®¡ç†ã€‚
- **Torch**: Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰ã€‚
- **Kaggle Environments**: ã‚²ãƒ¼ãƒ ç’°å¢ƒã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
- **Gemma**: ç‰¹ã«è‡ªç„¶è¨€èªå‡¦ç†ã«ç‰¹åŒ–ã—ãŸå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ä½¿ç”¨ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ
- **è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®è³ªå•ã‚’ç”Ÿæˆã€‚
- **å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: è³ªå•ã«å¯¾ã—ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§å¿œç­”ã€‚
- å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚’è¡Œã„ã€ã‚²ãƒ¼ãƒ ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«æ²¿ã£ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### å®Ÿè¡Œã¨ç’°å¢ƒ
- ç’°å¢ƒè¨­å®šã‚’è¡Œã„ã€è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¦³å¯Ÿã—ã¾ã™ã€‚

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºã‚„ã‚²ãƒ¼ãƒ AIã®ç ”ç©¶ãªã©ã«ãŠã„ã¦ã€èˆˆå‘³æ·±ã„å¿œç”¨ã‚’æŒã¤ã‚‚ã®ã§ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
## å•é¡Œå®šç¾©:
ã‚¿ãƒ¼ãƒ³åˆ¶ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ãªãŒã‚‰ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‹ã‚‰äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã¾ãŸã¯æ–°ã—ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

è€ƒãˆã‚‰ã‚Œã‚‹è§£æ±ºç­–:

* å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ã€å†™çœŸã‹ã‚‰ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚„éƒ½å¸‚ã®GISåº§æ¨™ä¸­å¿ƒç‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã€å›½ã€éƒ½å¸‚ã€å·ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®æ¨æ¸¬ã‚’ã‚ˆã‚Šé©åˆ‡ã«åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* GISåº§æ¨™ã‚’ä½¿ç”¨ã—ãŸé›»è©±ã®ãƒ†ã‚­ã‚¹ãƒˆä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚‚ã€å ´æ‰€ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã€è¨€èªã€ç‰¹å®šã®ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã¾ãŸã¯ä¿—èªã®åœ°åŸŸæ€§ã‚’è­˜åˆ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

* ç‰©ã«ã¤ã„ã¦ã¯ã€è£½å“èª¬æ˜ã‚„è£½å“ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒä½¿ç”¨å¯èƒ½ã§ã™ã€‚

* äººã«ã¤ã„ã¦ã¯ã€ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢ã‚„LinkedInã€å‡ºä¼šã„ç³»ã‚µã‚¤ãƒˆãªã©ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

* ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãªã—ã®ä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã—ã¦ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è­˜åˆ¥ã—ã¦ã€Œ20ã®è³ªå•ã€ã®ç¯„å›²å†…ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«è¿…é€Ÿã«åˆ°é”ã™ã‚‹ãŸã‚ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†å„ªã‚ŒãŸæ¤œç´¢ä¿¡å·ã‚’ç”Ÿã¿å‡ºã™ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã«åŸºã¥ã„ã¦ã€ç¾åœ¨ã®ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚„åŸ‹ã‚è¾¼ã¿ã‚’ä½¿ç”¨ã—ãŸé€†å¼•ãã®éç›£è¦–ãƒ¢ãƒ‡ãƒ«ãŒå¯èƒ½ã§ã™ã€‚

ä¾‹:
* https://www.cia.gov/the-world-factbook/
* https://public-nps.opendata.arcgis.com/datasets/nps::national-register-of-historic-places-points/explore


## ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
```

---The following area is a Code cell (cell numver is 2)---
```python
import pandas as pd
import json

from importlib.machinery import SourceFileLoader
keywords = SourceFileLoader("keywords",'/kaggle/input/llm-20-questions/llm_20_questions/keywords.py').load_module()
df = json.loads(keywords.KEYWORDS_JSON)
words = []
for c in df:
    print(c['category'], len(c['words']))
    for w in c['words']:
        words.append([c['category'], w["keyword"], w["alts"], "", "", 0.0, 0.0])
df = pd.DataFrame(words, columns=['Category','Word','Alternatives', "Cat1", "Cat2", "Lat", "Lon"])
df.tail()
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
* https://www.promptingguide.ai/models/gemma
```

---The following area is a Code cell (cell numver is 4)---
```python
template_special_tokens = ['<bos>','<start_of_turn>user','<start_of_turn>model','<end_of_turn>','<eos>']
#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1 - æ¨æ¸¬è€…ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼Ÿï¼‰
#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ2 - å›ç­”è€…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼Ÿï¼‰
#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3 - æ¨æ¸¬è€…ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼Ÿï¼‰
#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ4 - å›ç­”è€…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼Ÿï¼‰

def agentx(obs, cfg):
    if obs.turnType == "ask": response = ""  # è³ªå•ã®éš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆæœŸåŒ–
    elif obs.turnType == "guess": response = ""  # æ¨æ¸¬ã®éš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆæœŸåŒ–
    elif obs.turnType == "answer": response = ""  # å›ç­”ã®éš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆæœŸåŒ–
    else: response = "ç§ã¯å¹»è¦šã‚’è¦‹ã¦ã„ã¾ã™ã‹ï¼Ÿ **ã¯ã„**"  # ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return response
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
## 20ã®è³ªå•æå‡ºãƒ¢ãƒ‡ãƒ«
```

---The following area is a Code cell (cell numver is 6)---
```python
%%bash
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # Gemmaã®PyTorchãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
mkdir /kaggle/working/submission/lib/gemma/  # Gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # Gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•
```

---The following area is a Code cell (cell numver is 7)---
```python
%%writefile submission/main.py

import torch, itertools, contextlib
import os, sys, re, gc
from typing import Iterable
from pathlib import Path
gc.enable()  # ã‚¬ãƒ¼ãƒ™ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹

KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"  # Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹è¨­å®š
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/2b-it/2")  # é‡ã¿ã®ãƒ‘ã‚¹è¨­å®š
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ã‚¹ã«è¿½åŠ 
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/2b-it/2"  # é‡ã¿ã®ãƒ‘ã‚¹è¨­å®š

from gemma.config import get_config_for_2b  # Gemmaã®è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from gemma.model import GemmaForCausalLM  # Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# ã‚²ãƒ¼ãƒ ã®å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€ã‚ªãƒ¼ãƒ—ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦å‡ç¸®ãƒ»è£œå®Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼ˆopen('gamemaster.dat'), open('player.dat')ï¼‰
class AgentFormatter:
    def __init__(self, sp: str = None, fse: Iterable = None):
        self._system_prompt = sp  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆæœŸåŒ–
        self._few_shot_examples = fse  # Few-shotã®ä¾‹ã®åˆæœŸåŒ–
        self._turn_user = f"<start_of_turn>user\n{{}}<end_of_turn>\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³å½¢å¼
        self._turn_model = f"<start_of_turn>model\n{{}}<end_of_turn>\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³å½¢å¼
        self.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’è¿½åŠ 
        return self
    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å…¥åŠ›ã‚’è¿½åŠ 
        return self
    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotã®ä¾‹ã‚’è¿½åŠ 
        return self
    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®é †ç•ªã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †ç•ªã«ã‚µã‚¤ã‚¯ãƒ«ã™ã‚‹
        for fmt, turn in zip(formatters, turns):
            fmt(turn)  # å„ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®š
    yield
    torch.set_default_dtype(torch.float)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æˆ»ã™

class Agent:
    def __init__(self, sp=None, fse=None):
        self._device = torch.device('cuda:0')  # CUDAãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = AgentFormatter(sp=sp, fse=fse)  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®åˆæœŸåŒ–
        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b()  # ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’å–å¾—
        model_config.tokenizer = WEIGHTS_PATH + '/tokenizer.model'  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®š
            model = GemmaForCausalLM(model_config)  # Gemmaã®ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model.load_weights(WEIGHTS_PATH + '/gemma-2b-it.ckpt')  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®šã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«
    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
        response = self._parse_response(response, obs)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
        print(obs.turnType, response)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
        return response
    def _call_llm(self, prompt, max_nt=40, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {'temperature': 0.9, 'top_p': 0.9, 'top_k': 50,}  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        response = self.model.generate(
            prompt, device=self._device, output_len=max_nt, **sampler_kwargs,)  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
        return response
    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰æœ€ã‚‚è¿‘ã„ä¸€è‡´ã‚’ãƒã‚§ãƒƒã‚¯
        if match is None: keyword = ''
        else: keyword = match.group().lower()  # ä¸€è‡´ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword
    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•å½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
            if match is None: question = "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ"  # è³ªå•ãŒãªã„å ´åˆ
            else: question = match.group()  # è³ªå•ã‚’è¨­å®š
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # æ¨æ¸¬ã‚’ãƒ‘ãƒ¼ã‚¹
            if guess is None or len(guess) <= 1: 
                return "æ¨æ¸¬ãªã—"  # æ¨æ¸¬ã§ããªã„å ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
            else: 
                return guess  # æ¨æ¸¬ã‚’è¿”ã™
        elif obs.turnType == 'answer':
            answer = self._parse_keyword(response)  # ç­”ãˆã‚’ãƒ‘ãƒ¼ã‚¹
            return 'ã¯ã„' if 'ã¯ã„' in answer else 'ã„ã„ãˆ'  # ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã‚’è¿”ã™
        else: raise ValueError("æœªçŸ¥ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼å‡¦ç†

def interleave_unequal(x, y):
    return [item for pair in itertools.zip_longest(x, y) for item in pair if item is not None]  # ä¸å‡ç­‰ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆã™ã‚‹é–¢æ•°

class QuestionerAgent(Agent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–
    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®è³ªå•è€…ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚")  # è³ªå•è€…ã¨ã—ã¦ã®åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«å–ã‚Šå‡ºã™
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("ã‚ãªãŸã¯ã€äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ã‚¤ã‚¨ã‚¹ã¾ãŸã¯ãƒãƒ¼ã®è³ªå•ã‚’ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚")  # è³ªå•ã®ã‚¿ãƒ¼ãƒ³
        elif obs.turnType == 'guess':
            self.formatter.user("ã‚ãªãŸã¯äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã‚’æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚æ¨æ¸¬ã‚’ã€Œ**ã‚‚ã®**ã€ã®ã‚ˆã†ã«äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")  # æ¨æ¸¬ã®ã‚¿ãƒ¼ãƒ³
    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’ãƒ‘ãƒ¼ã‚¹
            if match is None: question = "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè³ªå•
            else: question = match.group()  # è³ªå•ã‚’å–å¾—
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # æ¨æ¸¬ã‚’ãƒ‘ãƒ¼ã‚¹
            if guess is None or len(guess) <= 1: 
                return "æ¨æ¸¬ãªã—" 
            else: 
                return guess  # æ¨æ¸¬ã‚’è¿”ã™
        elif obs.turnType == 'answer':
            answer = self._parse_keyword(response)  # ç­”ãˆã‚’ãƒ‘ãƒ¼ã‚¹
            return 'ã¯ã„' if 'ã¯ã„' in answer else 'ã„ã„ãˆ'  # ç­”ãˆã‚’è¿”ã™
        else: raise ValueError("æœªçŸ¥ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼å‡¦ç†

class AnswererAgent(Agent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–
    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®å›ç­”è€…ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")  # åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        turns = interleave_unequal(obs.questions, obs.answers)  # ã‚¿ãƒ¼ãƒ³ã‚’äº¤äº’ã«é©ç”¨
        self.formatter.apply_turns(turns, start_agent='user')  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«ã¤ã„ã¦ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚ã‚¤ã‚¨ã‚¹ã¾ãŸã¯ãƒãƒ¼ã§ç­”ãˆã€ç­”ãˆã‚’äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")  # è³ªå•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # ç­”ãˆã‚’ãƒ‘ãƒ¼ã‚¹
        return 'ã¯ã„' if 'ã¯ã„' in answer else 'ã„ã„ãˆ'  # ç­”ãˆã‚’è¿”ã™

sp = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã‚¤ã‚¨ã‚¹ã¾ãŸã¯ãƒãƒ¼ã®è³ªå•ã‚’ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"
fse = [
    "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®è³ªå•è€…ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ã“ã‚Œã¯äººç‰©ã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ã“ã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ã“ã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** æ¨æ¸¬ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ã§ã™ï¼",
]
agent = None

def get_agent(name: str):
    global agent
    if agent is None and name == 'questioner':
        agent = QuestionerAgent(sp=sp, fse=fse,)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = AnswererAgent(sp=sp, fse=fse,)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–ç¢ºèª
    return agent

def agent_fn(obs, cfg):
    if obs.turnType == "ask": response = get_agent('questioner')(obs)  # è³ªå•ã®ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
    elif obs.turnType == "guess": response = get_agent('questioner')(obs)  # æ¨æ¸¬ã®ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
    elif obs.turnType == "answer": response = get_agent('answerer')(obs)  # å›ç­”ã®ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
    
    if response is None or len(response) <= 1: return "ã„ã„ãˆ"  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ˜ã¾ãŸã¯çŸ­ã„å ´åˆ
    else: return response  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
# ãƒ†ã‚¹ãƒˆ
```

---The following area is a Code cell (cell numver is 9)---
```python
!pip install -q pygame  # pygameã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
!pip install -q 'kaggle_environments>=1.14.8'  # Kaggleç’°å¢ƒã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 10)---
```python
#ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
%run submission/main.py  # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
```

---The following area is a Code cell (cell numver is 11)---
```python
from kaggle_environments import make  # Kaggleç’°å¢ƒã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
env = make("llm_20_questions", debug=True)  # ç’°å¢ƒã‚’ä½œæˆ
agent = "/kaggle/working/submission/main.py"
env.reset()  # ç’°å¢ƒã®ãƒªã‚»ãƒƒãƒˆ
logs = env.run([agent, agent, agent, agent])  # 4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
#while not env.done: #ã“ã“ã«ãƒ†ã‚¹ãƒˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
env.render(mode="ipython", width=800, height=800)  # ç’°å¢ƒã‚’æç”»
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```

---The following area is a Code cell (cell numver is 13)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 14)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/2b-it/2  # taråœ§ç¸®
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## DataDiva007
> 
> ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å–ã‚Šçµ„ã‚€ã“ã¨ã¯ã¨ã¦ã‚‚ä¸­æ¯’æ€§ãŒã‚ã‚Šã€ã“ã“ã«æ¥ã¦ã¨ã¦ã‚‚æ¥½ã—ã„ã§ã™ï¼
> 
> 

---

> ## SuM
> 
> ã™ã°ã‚‰ã—ã„ä»•äº‹ [@jazivxt](https://www.kaggle.com/jazivxt)ğŸ‰
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€ã“ã‚Œã¯åˆå¿ƒè€…ã«ã¨ã£ã¦é‡è¦ãªã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸ãˆã¾ã™ğŸ˜ƒ
> 
> 

---

> ## Neel Patel
> 
> ç´ æ™´ã‚‰ã—ã„ä½œæ¥­ã€æå‡ºå‰ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚ :)

> 

---

> ## Hassan shahidi
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ [@jazivxt](https://www.kaggle.com/jazivxt)
> 
> 

---

> ## Prajwal Kanade
> 
> ã™ã°ã‚‰ã—ã„æƒ…å ±ã§ã™ã€
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ [@jazivxt](https://www.kaggle.com/jazivxt) 
> 
> 

---

> ## Utkarsh Jain
> 
> èˆˆå‘³æ·±ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ï¼éå¸¸ã«æ´å¯Ÿã«æº€ã¡ã¦ã„ã¾ã™ï¼ï¼
> 
> 

---

> ## huoyeqianxun
> 
> CUDAã®ãƒ¡ãƒ¢ãƒªä¸è¶³ã®ã‚ˆã†ã§ã™â€¦
> 
> ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã‹ï¼Ÿï¼Ÿï¼Ÿ
> 
> 

---
```

** @@@ Jupyter Notebook numver 7, the number of votes :33 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‘ã‘ã¦ã€æœªçŸ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’é–‹ç™ºã—ã€æ”¹å–„ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€Qwen 2 7b - Instructãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã€è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®å½¹å‰²ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®å–ã‚Šçµ„ã¿
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã«ãŠã„ã¦è¤‡é›‘ãª2å¯¾2ã®ãƒãƒ¼ãƒ æˆ¦ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«ã€åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã¨æ¨ç†ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®æˆ¦ç•¥ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦æ­£ã—ã„æ¨æ¸¬ã‚’è¡Œã„ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒå£«ãŒå”åŠ›ã—ãªãŒã‚‰å‹åˆ©ã‚’ç›®æŒ‡ã™ã¨ã„ã†æŒ‘æˆ¦ãŒæç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: ä¸»ã«Qwen 2 7b - Instructã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€Hugging Faceã®ä»–ã®ãƒ¢ãƒ‡ãƒ«ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚‚å¯èƒ½ã§ã™ã€‚
- **æˆ¦ç•¥**: 
  - è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸè³ªå•ã‚’è¡Œã„ã€ãã®å¾Œã¯ã‚²ãƒ¼ãƒ å±¥æ­´ã«åŸºã¥ã„ã¦è³ªå•ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
  - å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€éå»ã®è³ªå•ã¨å›ç­”ã‚’è€ƒæ…®ã—ã¤ã¤ã€æœ€ã‚‚å¤šæ•°ã®æ„è¦‹ã‚’åŸºã«ã—ãŸå›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
  - æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚²ãƒ¼ãƒ å±¥æ­´ã‚’å‚ç…§ã—ã¦æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `transformers`, `torch`, `huggingface_hub`ãªã©ãŒä½¿ç”¨ã•ã‚Œã€ã“ã‚Œã«ã‚ˆã‚Šãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚„é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€é‡å­åŒ–ã‚’è¡Œã†ãŸã‚ã«`BitsAndBytes`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚³ãƒ¼ãƒ‰ã®æ§‹æˆ
- **ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `accelerate`ã¨`bitsandbytes`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: `huggingface_hub`ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€é©åˆ‡ãªå½¢å¼ã§ä¿å­˜ã—ã¾ã™ã€‚
- **ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ**: Kaggleç’°å¢ƒå†…ã§å‹•ä½œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€å¥‘ç´„ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªåˆ¶é™å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–ã¨å®Ÿè¡Œ**: è¦³å¯Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨ã„ã¦ã€ã‚²ãƒ¼ãƒ ã®å„ã‚¿ãƒ¼ãƒ³ã«ãŠã‘ã‚‹è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã‚’å‡¦ç†ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ¢ãƒ‡ãƒ«ã®ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã¨ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã‚‚è¡Œã£ã¦ã„ã¾ã™ã€‚

### æ”¹å–„ç‚¹
- ã‚ˆã‚Šå …ç‰¢ãªãƒ¢ãƒ‡ãƒ«ã®è©¦é¨“ã€ç•°ãªã‚‹ãƒ«ãƒ¼ãƒ«ã‚„æˆ¦ç•¥ã®è¿½åŠ ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹è¿½è·¡æ©Ÿèƒ½ã®å®Ÿè£…ãªã©ãŒææ¡ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒã€Œ20ã®è³ªå•ã€ã¨ã„ã†è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã§åŠ¹æœçš„ã«æ©Ÿèƒ½ã™ã‚‹ãŸã‚ã®åœŸå°ã‚’ç¯‰ãã“ã¨ã‚’ç›®æŒ‡ã—ã€ãƒ¢ãƒ‡ãƒ«ã®æ”¹å–„ã¨æˆ¦è¡“çš„ãªå¿œç­”ç”Ÿæˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ã¯ã˜ã‚ã«
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯æå‡ºã®æº–å‚™ãŒæ•´ã£ã¦ãŠã‚Šã€æ”¹å–„æˆ¦ç•¥ã‚„æ¤œè¨ã™ã¹ãã‚¢ã‚¤ãƒ‡ã‚¢ã«é–¢ã™ã‚‹è©³ã—ã„æŒ‡ç¤ºãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã¯Qwen 2 7b - Instructã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€huggingfaceã®ä»–ã®ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å¤‰æ›´ã‚’åŠ ãˆãªã‘ã‚Œã°ã€ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã‹ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã¾ã™ã€‚

## ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã©ã®ã‚ˆã†ãªã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ

ã“ã‚Œã¯é›£ã—ã„è³ªå•ã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œç´¢ç©ºé–“ã¯åºƒå¤§ã§ã€æœªçŸ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å®šã¯è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã¨ã£ã¦é›£ã—ã„ã§ã™ã€‚ã¾ãŸã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ç•°ãªã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ ã®ä¸­ã§å”åŠ›ã—ã¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã¨ã„ã†è¤‡é›‘ã•ãŒåŠ ã‚ã‚Šã¾ã™ã€‚ã“ã®2å¯¾2ã®è¨­å®šã¯ã€ã•ã¾ã–ã¾ãªã‚²ãƒ¼ãƒ ã®çµæœã‚’å¼•ãèµ·ã“ã™æŒ‘æˆ¦çš„ãªæ–‡è„ˆã‚’ä½œã‚Šå‡ºã—ã¾ã™ã€‚ã“ã®ä»¶ã«ã¤ã„ã¦å¤šãã®è­°è«–ãŒã•ã‚Œã¦ãã¾ã—ãŸã€‚ãã®ä¸Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«ä¾å­˜ã—ã¦æ¨æ¸¬ã‚’ç”Ÿæˆã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ•ã‚£ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€å…¬ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã™ãŒã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆãŒä¸ãˆã‚‰ã‚Œã‚‹ã¨å¤±æ•—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å…¬ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã¯ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½ã®è‰¯ã„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ãªã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è‡ªå·±è©•ä¾¡ã«ã‚ˆã£ã¦ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½ã‚’åˆ¤æ–­ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
1. è³ªå•ã¯è«–ç†çš„ã«æ€ã‚ã‚Œã¾ã™ã‹ï¼Ÿ
2. æ¨æ¸¬ã¯è³ªå•ã«å¾“ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
3. ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯é©åˆ‡ã«è³ªå•ã«ç­”ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ
4. å¤‰æ›´ã‚’åŠ ãˆãŸå ´åˆã€ä»¥å‰ã‚ˆã‚Šã‚‚ãƒ¢ãƒ‡ãƒ«ã¯è‰¯ããªã‚Šã¾ã—ãŸã‹ï¼Ÿ

ã“ã‚Œã‚‰ã®è³ªå•ã¸ã®å›ç­”ã¯ã‚¹ã‚³ã‚¢ã‚„ãƒ¡ãƒ€ãƒ«ã‚’ä¸ãˆã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ç§ãŸã¡ãŒè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹çœŸã®å•é¡Œã®æ ¸å¿ƒã«ã‚ã‚Šã¾ã™ï¼š

**å°ã•ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’é–‹ç™ºã—ã€æœªçŸ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç‰¹å®šã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã€ãã®ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã§ã™ã€‚**

## æå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ç”¨ã«Kaggleç’°å¢ƒå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ï¼ˆä»¥ä¸‹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸï¼‰LLMã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯ã€ã‚²ãƒ¼ãƒ ç’°å¢ƒå†…ã§æä¾›ã•ã‚Œã‚‹æ§‹é€ ã¨å¤‰æ•°ã¨ç›¸äº’ä½œç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®å½¹å‰²ã‚’å–ã‚‹ãŸã‚ã«LLMã‚’ä¿ƒã™3ã¤ã®é–¢æ•°ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æœ€å¾Œã«ã€åˆæœŸåŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã€ãŠã‚ˆã³ã‚²ãƒ¼ãƒ ã‹ã‚‰ã®é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚³ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### æˆ¦ç•¥

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§åˆ©ç”¨ã•ã‚Œã‚‹æˆ¦ç•¥ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
* ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã‚’åŠ©ã‘ã€LLMã«ã‚²ãƒ¼ãƒ ã®é€²ã‚æ–¹ã‚’ç¤ºã™ãŸã‚ã®ã€Œãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸã€æœ€åˆã®è³ªå•ã€‚
* ã‚²ãƒ¼ãƒ å±¥æ­´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦å¿œç­”ã‚’ä½œæˆã™ã‚‹è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚
* 5å›ãƒ«ãƒ¼ãƒ—ã—ã¦æœ€ã‚‚é »ç¹ãªå¿œç­”ã‚’è¿”ã™å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚
* ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åˆ¶é™ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã«cuda:0ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯å«ã¾ã‚Œã¦ã„ãªã„ï¼š
* å…¬ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«LLMã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä¾›çµ¦ã™ã‚‹ã“ã¨ã€‚
* æ¨æ¸¬è€…ãŒæ¤œç´¢ã™ã‚‹ãŸã‚ã®å …ç‰¢ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’æä¾›ã™ã‚‹å¤–éƒ¨å˜èªãƒªã‚¹ãƒˆã®ä¾›çµ¦ã€‚ 


## æ”¹å–„ç‚¹
* ã‚ˆã‚Šå …ç‰¢ãªLLMãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã€‚huggingfaceã®ã‚ªãƒ¼ãƒ—ãƒ³LLMãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ç´„7Bã¾ãŸã¯ãã‚Œä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãã‚Œã‚‰ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«å•é¡ŒãŒã‚ã‚‹ã§ã—ã‚‡ã†ãŒã€è©¦è¡ŒéŒ¯èª¤ã—ã¦å•é¡Œè§£æ±ºã‚’æ¥½ã—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
* Phi3ã€Gemmaã€ã¾ãŸã¯LLaMa 3ã‚’è©¦ã—ã¦ã€Gwenã¨æ¯”è¼ƒã—ã¦ã©ã†ãªã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ï¼ˆæå‡ºãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã“ã¨ã‚’å¿˜ã‚Œãšã«ï¼ï¼‰
* ã‚ˆã‚Šå¤§ããªãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€bitsandbytesã¨accelerateã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŠã‚ˆã³ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€quantization-configã‚’4ãƒ“ãƒƒãƒˆã«è¨­å®šã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
* æä¾›ã•ã‚ŒãŸå›ç­”ã«åŸºã¥ã„ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã©ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚’å®šç¾©ã™ã‚‹ã‚²ãƒ¼ãƒ çŠ¶æ…‹è¿½è·¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
* åˆæœŸã®åºƒç¯„ãªã‚²ãƒ¼ãƒ è³ªå•ã‹ã‚‰ã€å¾ŒåŠã®å…·ä½“çš„ãªè³ªå•ã«ç§»è¡Œã™ã‚‹ãŸã‚ã®ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºè¿½è·¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
* ç›´è¡Œãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã®ä»£ã‚ã‚Šã«ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
* temperatureãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
* ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸQwenãƒ¢ãƒ‡ãƒ«ã¯ã€æ™‚æŠ˜ãƒãƒ«ãƒãƒ¬ãƒ™ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è‹¦åŠ´ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ä»–ã®ãƒ¢ãƒ‡ãƒ«ã¯è‡ªå·±å¯¾è©±ã«å„ªã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
* å¾®èª¿æ•´ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã€‚æ¨™æº–ã®ãƒ¢ãƒ‡ãƒ«ã¯20ã®è³ªå•ã®ãƒ—ãƒ¬ã‚¤ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã›ã‚“ã€‚ã„ãã¤ã‹ã¯ä»–ã®ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šã‚‚å„ªã‚Œã¦ã„ã¾ã™ã€‚é€²è¡Œä¸­ã®20ã®è³ªå•ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®Q&Aãƒšã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒå½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã‹ï¼Ÿ

## ã‚ˆãã‚ã‚‹è³ªå•
* ãƒ¡ãƒ¢ãƒªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã‹ï¼Ÿãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã„ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ãŠãã‚‰ããƒ¢ãƒ‡ãƒ«ã‚’äºŒé‡ã«ãƒ­ãƒ¼ãƒ‰ã—ã¦ã—ã¾ã£ãŸã®ã§ã™ï¼
* è³ªå•è€…ã¾ãŸã¯æ¨æ¸¬è€…ã‹ã‚‰ã®ã„ãã¤ã‹ã®å¿œç­”ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã®ã¯ãªãœã§ã™ã‹ï¼Ÿå¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã®å‰µé€ çš„ãªæ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸãƒ‘ãƒ¼ã‚µã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰ã«é€²ã¿ã¾ã—ã‚‡ã†

### æœ€åˆ - ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã„ãã¤ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€æå‡ºæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒKaggleç’°å¢ƒå†…ã§æ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã«å¿…é ˆã§ã™ã€‚
ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ä¸‹è¨˜ã®ä¸¡æ–¹ã®ã‚»ãƒ«ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
!pip install accelerate bitsandbytes
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
ã“ã®ã‚»ãƒ«ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import os
os.system("pip install -t /tmp/submission/lib accelerate bitsandbytes")
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼šã“ã®ã‚»ãƒ«ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«ã‚’1ã¤ã®æå‡ºãƒ•ã‚©ãƒ«ãƒ€ã«åœ§ç¸®ï¼ˆzipï¼‰ã—ãŸå¾Œã€æå‡ºå¾Œã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ç’°å¢ƒã¯Kaggleç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æå‡ºã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚»ãƒ«ã®èª­ã¿è¾¼ã¿ã«ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚

æ³¨ï¼šã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«ã‚„ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã‚€ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¡Œã‚ã‚Œã¾ã™ã€‚

ç¾åœ¨ã€ãƒ¢ãƒ‡ãƒ«ã¯Qwen 2 7b Instructã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

model_path = Path("/tmp/submission/")
if model_path.exists():
    shutil.rmtree(model_path)
model_path.mkdir(parents=True)

snapshot_download(
    repo_id= "Qwen/Qwen2-7B-Instruct",
    local_dir=model_path
)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ 

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®æœ€ä¸Šéƒ¨ã®ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã¯ã€Kaggleç’°å¢ƒå†…ã§å®Ÿè¡Œã•ã‚Œã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã•ã‚Œã‚‹.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

- ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è©•ä¾¡ã®ãŸã‚ã«å®Ÿè¡Œã™ã‚‹ã¨ã€é‡å­åŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒGPUãƒ¡ãƒ¢ãƒªã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚Qwen 2 7bã¯å¤§ãã„ãŸã‚ã€4ãƒ“ãƒƒãƒˆã®é‡å­åŒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€15GBã®ã†ã¡7.4GBã®ãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
%%writefile main.py

# ä¸Šè¨˜ã®è¡Œã¯è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚

import os

#ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã©ã®ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç•°ãªã‚‹ç’°å¢ƒã§æå‡ºã¨è©•ä¾¡ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if not os.path.exists(KAGGLE_AGENT_PATH):
    KAGGLE_AGENT_PATH = "/tmp/submission/"

import sys
import itertools
import re
import torch
import typing as t
from pathlib import Path
from pydantic import BaseModel, Field, field_validator
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig
from IPython.display import display, Markdown

model_initialized = False
device = "cuda:0" if torch.cuda.is_available() else "cpu"
t_dtype = torch.bfloat16
DEBUG = False

#==================é‡å­åŒ–è¨­å®š================
# Gwen 2 7bã‚’é‡å­åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹å˜ä¸€ã®T4 GPUã«åã¾ã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚
# ã“ã‚Œã¯ã€ã‚ˆã‚Šå¤§ããªãƒ¢ãƒ‡ãƒ«ã‚’é‡å­åŒ–ã™ã‚‹ãŸã‚ã®æ§‹æˆãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
# ã¾ãŸã€ãƒ¢ãƒ‡ãƒ«ãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹æ¡ä»¶æ–‡ã‚‚å±•é–‹ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—ãã‚ŒãŒçœŸã§ã‚ã‚Œã°ã€OOMã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
# ã“ã‚Œã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£ã€è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèªã€æ–°ã—ã„è©¦ã¿ã‚’è¡Œã†éš›ã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚

if 'model' in locals() and 'tokenizer' in locals() and model is not None and tokenizer is not None:
    print("ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚ä½œæˆå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
else:
    quantization_config = BitsAndBytesConfig(load_in_4bit=True,
                                             bnb_4bit_compute_dtype=t_dtype)
    
    model = AutoModelForCausalLM.from_pretrained(KAGGLE_AGENT_PATH, 
                                                 device_map=device, 
                                                 torch_dtype=t_dtype,
                                                 quantization_config=quantization_config)
    
    tokenizer = AutoTokenizer.from_pretrained(KAGGLE_AGENT_PATH, 
                                              torch_dtype=t_dtype)

        
#==================KAGGLEç’°å¢ƒç”¨ã®è¦³å¯Ÿã‚¯ãƒ©ã‚¹================
# ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Kaggleç’°å¢ƒã‹ã‚‰ã®obså…¥åŠ›ã‚’ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
# è¦³å¯Ÿã‚¯ãƒ©ã‚¹ã¯Team Riggingã®å…¬é–‹ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ„Ÿè¬ã—ã¾ã™ã€‚

class Observation(BaseModel):
    step: int
    role: t.Literal["guesser", "answerer"]
    turnType: t.Literal["ask", "answer", "guess"]
    keyword: str
    category: str
    questions: list[str]
    answers: list[str]
    guesses: list[str]
    
    @property
    def empty(self) -> bool:
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")

    def get_history_text(self, *, skip_guesses: bool = False, skip_answer: bool = False, skip_question: bool = False) -> str:
        if not self.empty:
            history = "\n".join(
            f"""{'**è³ªå•:** ' + question if not skip_question else ''} -> {'**å›ç­”:** ' + answer if not skip_answer else ''}
            {'**ä»¥å‰ã®æ¨æ¸¬:** ' + guess if not skip_guesses else ''}
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
            )
            return history
        return "ã¾ã ãªã—."


# =================ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ================
# ã“ã“ã«ã‚ãªãŸã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚
# æŒ‡ç¤º/ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€ãƒ¢ãƒ‡ãƒ«ã«å¾“ã†ã¹ãã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨æ–¹å‘æ€§ã‚’æä¾›ã—ã¾ã™ã€‚
# ã“ã“ã§å±•é–‹ã§ãã‚‹ã•ã¾ã–ã¾ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚
# ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚„ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆåˆæœŸ/ä¸­æœŸ/å¾ŒæœŸï¼‰ã«å¿œã˜ã¦ç•°ãªã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒã¤ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

system_prompt = """ã‚ãªãŸã¯ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæœªçŸ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç‰¹å®šã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚
ã‚ãªãŸã¯è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®å…¨å½¹å‰²ã«ç†Ÿç·´ã—ãŸç†Ÿç·´è€…ã§ã™ã€‚
ã‚ãªãŸã®ç›®æ¨™ã¯ã€ã§ãã‚‹ã ã‘å°‘ãªã„ã‚¿ãƒ¼ãƒ³ã§ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦å‹åˆ©ã™ã‚‹ã“ã¨ã§ã™ã€‚"""

# =================è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ================
# è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æœ€åˆã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå ´æ‰€ã‹ã©ã†ã‹ã‚’å°‹ã­ã€ãã®å¾Œèµ¤é“ã®åŒ—å´ã«ä½ç½®ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’å°‹ã­ã¾ã™ã€‚ã“ã“ã§ã¯LLMã¯å‘¼ã³å‡ºã•ã‚Œã¾ã›ã‚“ã€‚
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã€Œå ´æ‰€ã€ã§ãªã„å ´åˆã€ãã‚Œã¯åŸå› ãŒç„¡ç”Ÿç‰©ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’å°‹ã­ã¾ã™ã€‚
# ã“ã‚Œã«ã‚ˆã‚Šã‚²ãƒ¼ãƒ ç’°å¢ƒã®å°‘æ•°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’LLMã«æä¾›ã—ã€æœ€åˆã®ã‚«ãƒ†ã‚´ãƒªã‚’äºŒåˆ†ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
# ãã‚Œä»¥é™ï¼ˆstep > 1ï¼‰ã€å‰ã®å±¥æ­´ã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚ŒãŸè³ªå•ã‚’è©¢ã„ã¾ã™ã€‚
# è¿½åŠ ã®æ¡ä»¶ä»˜ãè³ªå•ã‚’LLMã‚’å‘¼ã³å‡ºã™å‰ã«åŠ ãˆã€æ¢ç´¢ç©ºé–“ã‚’ã•ã‚‰ã«çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
# LLMã‚’å‘¼ã³å‡ºã™å‰ã«ã€ãƒã‚§ãƒ¼ãƒ³ã‚ªãƒ–ã‚·ãƒ³ã‚¯æ¨è«–ã‚„ä»–ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
# max_new_tokensã‚„temperatureãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãšã«ã€‚
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¤‡é›‘ã•ãŒå¢—ã™ã«ã¤ã‚Œã¦ã€ç•°ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ç•°ãªã‚‹generate_texté–¢æ•°ã‚’ä½œæˆã—ãŸã„ã§ã—ã‚‡ã†ã€‚
# ãŸã¨ãˆã°ã€generate_longã¯ã¯ã‚‹ã‹ã«é«˜ã„æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã¨é«˜ã„æ¸©åº¦ã‚’æŒã¡ã¾ã™ã€‚

def ask(observation: Observation) -> str:
    if observation.step == 0:
        return "ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ"
    elif observation.step == 1:
        if len(observation.answers) > 0 and observation.answers[0] == "yes":
            return "éƒ½å¸‚ã§ã™ã‹ï¼Ÿ"
        else:
            return "ç”Ÿãã¦ã„ã‚‹ã‚‚ã®ã§ã™ã‹ï¼Ÿ"
    game_history = observation.get_history_text(skip_guesses=True)

    try:
        think = generate_text(f"""
        ã‚ãªãŸã¯è³ªå•è€…ã¨ã—ã¦æ¬¡ã®è³ªå•ã‚’ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã¾ã™ï¼š

====== ã‚²ãƒ¼ãƒ å±¥æ­´ =====
{game_history}
=========================

        ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ãã€æ¬¡ã«ã©ã®ã‚ˆã†ã«è³ªå•ã‚’é€²ã‚ã‚‹ã¹ãã‹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
        """)
        
        parse = generate_text(f"""
        ç¾åœ¨ã®æƒ…å ±ã‚’ç¢ºèªã—ã€æ¬¡ã®ãƒ™ã‚¹ãƒˆãªè³ªå•ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
        ã‚ã¾ã‚Šæƒ…å ±ãŒãªã„å ´åˆã¯ã€æ¤œç´¢ç©ºé–“ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’æ’é™¤ã™ã‚‹ãŸã‚ã«ã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ã€‚

        æ¦‚è¦: "{think}""
        
        è³ªå•ã‚’ãŸã èã„ã¦ãã ã•ã„ã€‚è³ªå•ã¨ç–‘å•ç¬¦ä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›ã—ãªã„ã§ãã ã•ã„ã€‚
        """
        ).lower()
        if DEBUG:
            display(Markdown(f"### ãƒ‡ãƒãƒƒã‚°: è³ªå•è€…ã®æ€è€ƒ:"))
            display(Markdown(think))
            display(Markdown(f"### ãƒ‡ãƒãƒƒã‚°: è³ªå•è€…ã®ãƒ‘ãƒ¼ã‚¹:"))
            display(Markdown(parse))
        return parse
    except Exception as e:
        print(f"è³ªå•ã‚’å°‹ã­ã‚‹éš›ã®ã‚¨ãƒ©ãƒ¼: {e}")
        return 'å ´æ‰€ã§ã™ã‹ï¼Ÿ'
    

# =================å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ================
# 5å›ãƒ«ãƒ¼ãƒ—ã—ã€æœ€ã‚‚é »ç¹ãªå¿œç­”ã‚’å–ã‚Šã¾ã™ã€‚
# ã“ã‚Œã¯Team Riggingã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚ŒãŸãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã™ã€‚
# å˜ä¸€ã®å¿œç­”ã‚ˆã‚Šã‚‚ã‚ãšã‹ã«åŠ¹æœçš„ã§ã™ã€‚

def answer(observation: Observation) -> t.Literal["yes", "no"]:
    if not observation.keyword:
        print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå›ç­”è€…ã«æä¾›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", file=sys.stderr)
        return "yes"
            
    last_question = observation.questions[-1]

    try:
        responses = []
        for i in range(5):
            response = generate_text(f"""
            20ã®è³ªå•ã‚²ãƒ¼ãƒ ã€‚ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã¯ã„/ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„: {observation.keyword} 

            è³ªå•: "{last_question}"
            
            ãƒ«ãƒ¼ãƒ«:
            1. ã‚ãªãŸã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {observation.keyword} ã«ã®ã¿æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã‚‰ã‚Œã¾ã™: {observation.category}.
            2. 'ã¯ã„'ã¾ãŸã¯'ã„ã„ãˆ'ã ã‘ã‚’ç­”ãˆã¦ãã ã•ã„ã€‚ãã®ä»–ã®æƒ…å ±ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
            ã“ã“ã«ã‚ãªãŸã®å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:
            """
            ).lower()
            if DEBUG:
                display(Markdown(f"### ãƒ‡ãƒãƒƒã‚°: å›ç­”è€…ã®å¿œç­”:"))
                display(Markdown(f"DEBUG: {response}"))
            
            yes_no = re.findall(r'\b(yes|no)\b', response)
            if yes_no:
                responses.append(yes_no[0])

        if DEBUG:
            display(Markdown(f"DEBUG: ã™ã¹ã¦ã®å›ç­”è€…ã®å¿œç­” {responses}"))
        return max(set(responses), key=responses.count)

    except Exception as e:
        print(f"å›ç­”è€…ã§ã‚¨ãƒ©ãƒ¼: {e}", file=sys.stderr)
        return "yes"

# ================æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ================
# ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚²ãƒ¼ãƒ å±¥æ­´ã‚’ä½¿ç”¨ã—ã¦æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚
# ä¸€éƒ¨ã®å ´åˆã€LLMãŒé–¢é€£ã™ã‚‹å˜èªãƒ«ãƒ¼ãƒ—ã«ãƒãƒã‚‹ãŸã‚ã€ã“ã‚Œã¯ã‚ã¾ã‚Šå½¹ã«ç«‹ãŸãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
# ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥ã‚’è©¦ã™ã“ã¨ã‚„ã€æ¨æ¸¬ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚
# ãƒ‘ãƒ¼ã‚¹æˆ¦ç•¥ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚²ãƒ¼ãƒ ã®å¿œç­”ãŒæœ‰åŠ¹ã§ç†è§£å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

def guess(observation: Observation) -> str:
    game_history = observation.get_history_text(skip_guesses=False)
    
    think = generate_text(f"""
    ã‚ãªãŸã¯ç¾åœ¨ã€æ¨æ¸¬è€…ã¨ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æƒ…å ±ã«åŸºã¥ã„ãŸæ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚

== ã‚²ãƒ¼ãƒ å±¥æ­´ ==
{game_history}
==================

    ææ¡ˆã•ã‚ŒãŸé–¢é€£ã™ã‚‹1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã¨ã€å¯èƒ½ãªæ¨æ¸¬ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
    ã‚ãªãŸã®æ ¹æ‹ ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
    """
    )
    
    parse = generate_text(f"""
    ä»¥ä¸‹ã®å¿œç­”ã‚’ç¢ºèªã—ã€æ¬¡ã®ãƒ™ã‚¹ãƒˆãªæ¨æ¸¬ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
    ã‚ã¾ã‚Šæƒ…å ±ãŒãªã„å ´åˆã¯ã€é‡ç”Ÿã®å…·ä½“çš„ãªæ¨æ¸¬ã‚’ã—ã¦ãã ã•ã„ã€‚
    è³ªå•ã®ã‚ˆã†ã«æ¨æ¸¬ã‚’å°‹ã­ãšã€å˜èªã¾ãŸã¯ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ¨æ¸¬ã‚’ç›´æ¥æä¾›ã—ã¦ãã ã•ã„ã€‚

    æ¦‚è¦: "{think}"

    ã‚ãªãŸã®æ¨æ¸¬ã¯ã“ã¡ã‚‰:
    """
    ).lower()
    if DEBUG:
        print(f"ã‚²ãƒ¼ãƒ å±¥æ­´: {game_history}")
        display(Markdown(f"### ãƒ‡ãƒãƒƒã‚°: æ¨æ¸¬è€…ã®æ€è€ƒ:"))
        display(Markdown(think))
        display(Markdown(f"### ãƒ‡ãƒãƒƒã‚°: æ¨æ¸¬è€…ã®ãƒ‘ãƒ¼ã‚¹:"))
        display(Markdown(parse))
    
    return parse

#==============LLMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ===============
# å¤‰æ›´ã—ãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚
# temperatureã¯ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’è¨­å®šã—ã¾ã™ã€‚
# å€¤ã®ä½ã„æ–¹ãŒã‚ˆã‚Šæ±ºå®šè«–çš„ã§ã€é«˜ã„æ–¹ãŒã‚ˆã‚Šå‰µé€ çš„ã§ã™ã€‚
# max_new_tokensã¯ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•ã‚’è¨­å®šã—ã¾ã™ã€‚

    
def generate_text(prompt:str) -> str:
    sys_prompt = system_prompt
    messages = [
        {"role": "system", "content": sys_prompt},
        {"role": "user", "content": prompt},
    ]
    text = tokenizer.apply_chat_template(messages, 
                                         tokenize=False, 
                                         add_generation_prompt=True)
    
    inputs = tokenizer([text], return_tensors="pt").to(device)
    
    generated_ids = model.generate(inputs.input_ids,
                                   max_new_tokens=350, 
                                   do_sample=True, 
                                   temperature=0.1) #ã“ã‚Œã¯ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§/å‰µé€ æ€§ã‚’è¨­å®šã—ã¾ã™ã€‚ä½ã„ã»ã©æ±ºå®šè«–çš„ã§ã™ã€‚
    
    generated_ids = [output_ids[len(input_ids):] for input_ids, output_ids in zip(inputs.input_ids, generated_ids)]
    response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0]
    
    return response

#================KAGGLEç’°å¢ƒç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–================
# è©•ä¾¡ä¸­ã«ãƒ¢ãƒ‡ãƒ«ã¨å¯¾æˆ¦ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®1ã¤ã‚’'input'ã«å¤‰æ›´ã™ã‚‹ã¨æ¥½ã—ã•ãŒå¢—ã—ã¾ã™ï¼
# ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦ã€å¾®èª¿æ•´ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹å¯èƒ½æ€§ãŒé–‹ã‹ã‚Œã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼
# è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾®èª¿æ•´ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‡ºåŠ›ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ä¿å­˜ã§ãã¾ã™ã€‚
# ç„¡é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€æ™‚é–“ã«åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚  

agent = None

def observe(obs: t.Any) -> str:
    global agent
    observation = Observation(**obs.__dict__)

    try:
        match observation.turnType:
            case "ask":
                agent = ask(observation)
                return agent
            case "answer":
                agent = answer(observation)
                return agent
            case "guess":
                agent = guess(observation)
                return agent

            case _:
                raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—")
    except Exception as e:
        print(str(e), file=sys.stderr)
        raise

def agent_fn(obs: t.Any, _: t.Any) -> str:
    return observe(obs)

# =========================TORCHãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æœ‰åŠ¹åŒ–===========================
# ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
# ã“ã‚Œã‚‰ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã¯ã€ã‚¨ãƒ©ãƒ¼ãªã—ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã‚„ã£ãŸã­ï¼

torch.backends.cuda.enable_mem_efficient_sdp(False)
torch.backends.cuda.enable_flash_sdp(False)
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# æå‡º - ã‚¿ãƒ¼ãƒ«ãƒœãƒ¼ãƒ«
ã“ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åœ§ç¸®ã¯ã€kaggleãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æå‡ºç‰©ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€ãŠã‚ˆã³æå‡ºãƒ•ã‚©ãƒ«ãƒ€ã‚’å«ã‚ã¦åœ§ç¸®ã—ã¾ã™ã€‚pipã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹å ´åˆã¯ã€ãã‚Œã‚‰ã‚’æå‡ºtarballã«ã‚‚è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æå‡ºtarballã«è¿½åŠ ã™ã‚‹ãŸã‚ã«/tmp/submission/libã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
!apt install pigz pv
```

---The following area is a Code cell (cell numver is 11)---
```python
!tar --use-compress-program='pigz --fast' \
     -cf submission.tar.gz \
     -C /kaggle/working main.py \
     -C /tmp/submission/ \
     .
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
# è©•ä¾¡
perform_evalãŒTrueã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯Kaggleãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰æœ€æ–°ã®å…¬çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ©ãƒ³ãƒ€ãƒ ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Kaggleç’°å¢ƒã®åˆæœŸåŒ–ã‚’é¿ã‘ã‚‰ã‚Œã€ãƒ¡ãƒ¢ãƒªã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã§ãã¾ã™ã€‚ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ã‚’å¤‰æ›´ã—ãŸã‚Šã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‘¼ã³å‡ºã—ãŸã‚Šã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ã§æœ€çµ‚å¿œç­”ãŒã‚²ãƒ¼ãƒ å†…ã«ãªã„å ´åˆã«å½¹ç«‹ã¡ã¾ã™ã€‚

* è©•ä¾¡ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€å¿…ãšã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚ 
* è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ã‚’å¤‰ãˆã¦ç•°ãªã‚‹æˆ¦ç•¥ã‚’è©¦ã—ãŸããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã€LLMï¼ˆãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ï¼‰ã®åˆæœŸåŒ–ã‚’è¡Œã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒˆãƒƒãƒ—ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ãã†ã—ãªã„ã¨ã€æ¯å›ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã—ã¾ã„ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚Šã¾ã™ã€‚
* ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã—ã¦ã„ã‚‹ã¨ãã¯ã€å¿œç­”ãŒå¾—ã‚‰ã‚Œã‚‹ã¾ã§ã«ã‹ã‹ã‚‹æ™‚é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯å¿œç­”æ™‚é–“ã‚’60ç§’ã«åˆ¶é™ã—ã¦ã„ã¾ã™ï¼ï¼ˆæœ€åˆã«GPUåŠ é€ŸãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚

### perform_eval? ã“ã‚Œã¯ä½•ã®ãŸã‚ã§ã™ã‹ï¼Ÿ
perform_evalã‚’Trueã«è¨­å®šã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’å®Ÿè¡Œã—ãŸã‚Šãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚³ãƒŸãƒƒãƒˆã—ãŸã‚Šã™ã‚‹ã¨ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒKaggleãƒªãƒã‚¸ãƒˆãƒªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§è‡ªå·±å¯¾æˆ¦ã™ã‚‹20ã®è³ªå•ã‚²ãƒ¼ãƒ ã§è©•ä¾¡ã•ã‚Œã¾ã™ã€‚ã‚„ã£ãŸï¼

ã“ã‚Œã‚’Trueã«è¨­å®šã™ã‚‹ã¨ã€ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’èã‹ã‚Œã‚‹ãŸã‚ã€ç´„2ã€œ3åˆ†å¾Œã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã„å ´åˆã¯ã€Falseã«è¨­å®šã—ã¦è¿…é€Ÿãªã‚³ãƒŸãƒƒãƒˆã¨æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
#### **è©•ä¾¡ã®è¿…é€ŸåŒ–ã®ãŸã‚ã«GPUåŠ é€Ÿã‚’å¿…ãšã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚**
```

---The following area is a Code cell (cell numver is 13)---
```python
perform_eval = False
```

---The following area is a Code cell (cell numver is 14)---
```python
if perform_eval:
    import requests
    import json
    import re
    import typing as t
    import random
    import time
    from IPython.display import display, Markdown
    import signal

    # ===============KAGGLE GITHUBã‹ã‚‰æœ€æ–°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—================
    # ã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ã™ãŸã‚ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    # ã“ã‚Œã¯ãŸã è©•ä¾¡ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã ã‘ã§ã™ã€‚
    
    url = "https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py"
    response = requests.get(url)

    if response.status_code == 200:
        match = re.search(r'KEYWORDS_JSON = """(.*?)"""', response.text, re.DOTALL)
        if match:
            json_str = match.group(1)
            keywords_dict = json.loads(json_str)
        else:
            print("ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§KEYWORDS_JSONå¤‰æ•°ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
    else:
        print("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰:", response.status_code)
        import time

    def select_random_keyword(keywords_dict: t.List[dict]) -> str:
        category = random.choice(keywords_dict)
        keyword_dict = random.choice(category['words'])
        return keyword_dict['keyword'].lower()
    
    #===============20ã®è³ªå•è©•ä¾¡ã‚»ãƒƒã‚·ãƒ§ãƒ³=====================
    def input_timeout(prompt, timeout):
        def timeout_handler(signum, frame):
            raise TimeoutError("å…¥åŠ›ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {}ç§’å¾Œ".format(timeout))

        signal.signal(signal.SIGALRM, timeout_handler)
        signal.alarm(timeout)

        try:
            user_input = input(prompt)
            signal.alarm(0)
            return user_input
        except TimeoutError as e:
            print(e)
            return None

    timeout = 10

    try:
        DEBUG_input = input_timeout("è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ (y/n) [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯n] ", timeout)
        DEBUG = DEBUG_input.lower() == 'y' if DEBUG_input else False
    except:
        DEBUG = False
        print("å…¥åŠ›ãŒå—ã‘å–ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§falseã«è¨­å®šã—ã¾ã™ã€‚")

    class MockObservation:
        def __init__(self, step: int, role: str, turnType: str, keyword: str, category: str, questions: list[str], answers: list[str], guesses: list[str]):
            self.step = step
            self.role = role
            self.turnType = turnType
            self.keyword = keyword
            self.category = category
            self.questions = questions
            self.answers = answers
            self.guesses = guesses

    def test_20_questions():
        global DEBUG
        step = 0
        role = "answerer"
        turnType = "ask"
        keyword = select_random_keyword(keywords_dict)
        category = ""
        questions = []
        answers = []
        guesses = []
        display(Markdown("# 20ã®è³ªå•è©•ä¾¡ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™..."))
        display(Markdown(f"### **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:** {keyword}"))

        for i in range(60):
            obs = MockObservation(step, role, turnType, keyword, category, questions, answers, guesses)

            start_time = time.time()
            response = agent_fn(obs, None)
            end_time = time.time()

            response_time = end_time - start_time
            if response_time > 60:
                display(Markdown(f"**è­¦å‘Š:** å¿œç­”æ™‚é–“ãŒé•·ã™ãã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã‹ã‚‰å¤±æ ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™: {response_time:.2f}ç§’ã€‚å³å´ã®ãƒ‘ãƒãƒ«ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã¦GPUåŠ é€ŸãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"))
                break

            # é©åˆ‡ãªãƒªã‚¹ãƒˆã«å¿œç­”ã‚’è¨˜éŒ²
            if turnType == 'ask':
                questions.append(response)
                turnType = 'answer'
            elif turnType == 'answer':
                answers.append(response)
                turnType = 'guess'
            elif turnType == 'guess':
                guesses.append(response)
                if response.lower() == keyword.lower():
                    display(Markdown(f"## **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ '{keyword}'ãŒæ­£ã—ãæ¨æ¸¬ã•ã‚Œã¾ã—ãŸï¼ ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚**"))
                    break
                turnType = 'ask'
                step += 1

            display(Markdown(f"ã‚¹ãƒ†ãƒƒãƒ— {step} | å¿œç­”: {response} | {response_time:.2f}ç§’"))
        display(Markdown(f"æœ€çµ‚è³ªå•: {', '.join(questions)}"))
        display(Markdown(f"æœ€çµ‚å›ç­”: {', '.join(answers)}"))
        display(Markdown(f"æœ€çµ‚æ¨æ¸¬: {', '.join(guesses)}"))

    # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    test_20_questions()
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Pang Luo
> 
> æœ¬å½“ã«å°è±¡çš„ãªä½œæ¥­ã§ã™ã€‚ã€Œè€ƒãˆã‚‹-ç­”ãˆã‚‹ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ãƒ€ãƒŒãƒ¼ãƒ–ã€ã‚’æ¨æ¸¬ã—ã¾ã—ãŸãŒã€æ­£ã—ã„ç­”ãˆã¯ã€ãƒ‰ãƒ‹ã‚¨ãƒ—ãƒ«ã€ã§ã—ãŸã€‚ã¨ã¦ã‚‚è¿‘ã„ã§ã™ã€‚
> 
> 
> 


---

> ## Thuáº­n ÄoÃ n VÅ©
> 
> ã‚ãªãŸã®ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã«æ„Ÿè¬ã—ã¾ã™ã€‚1ã¤è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚ãªãœ4ãƒ“ãƒƒãƒˆã§ã¯ãªã8ãƒ“ãƒƒãƒˆã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„ã®ã§ã™ã‹ï¼Ÿ8ãƒ“ãƒƒãƒˆã®æ–¹ãŒè‰¯ããªã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Matthew S Farmer æŠ•ç¨¿è€…
> > 
> > è‰¯ã„æ´å¯Ÿã§ã™ã­ã€‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¼ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€æ”¹å–„ã‚’è¡Œã„ã€ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ğŸ¤—
> > 
> > 
> > 
> > ## Matthew S Farmer æŠ•ç¨¿è€…
> > 
> > ãã®è³ªå•ã«æŠ€è¡“çš„ã«ç­”ãˆã‚‹ã¨ã€ä½ç²¾åº¦ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ããªã‚‹ã¨ã„ã†æ„è¦‹ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯å°ã•ãªãƒ¢ãƒ‡ãƒ«ã«ã¯ã‚ã¾ã‚Šé‡è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä¾ç„¶ã¨ã—ã¦å­˜åœ¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€è¨ˆç®—åˆ¶ç´„ã¨å¿œç­”ã”ã¨ã®æ™‚é–“åˆ¶é™ã‚‚ã‚ã‚Šã¾ã™ã€‚ãƒ†ã‚¹ãƒˆæ™‚ã«ã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸVRAMã¨å¿œç­”æ™‚é–“åˆ¶ç´„å†…ã«åã‚ãªãŒã‚‰ã€ãƒ¢ãƒ‡ãƒ«ã®èƒ½åŠ›ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™ã“ã¨ã‚’ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚ 
> > 
> > 


---

> ## MarÃ­lia Prata
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨è²´é‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆæ”¹å–„ç‚¹ã€ã‚ˆãã‚ã‚‹è³ªå•ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚»ãƒ«ï¼‰ã€‚
> 
> 
> > ## Matthew S Farmer æŠ•ç¨¿è€…
> > 
> > ãã‚Œã¯ã‚ãªãŸã‹ã‚‰ã®é«˜ã„è©•ä¾¡ã§ã™ã€Mariliaã€‚ã‚ã‚ŠãŒã¨ã†ï¼ 
> > 
> >
```

** @@@ Jupyter Notebook numver 8, the number of votes :33 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ç«¶æŠ€ã«é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€åˆ†æã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€éå»ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ç‰¹å®šã®ã‚²ãƒ¼ãƒ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹æƒ…å ±ã‚’æ§‹é€ åŒ–ã•ã‚ŒãŸå½¢ã§ä¿å­˜ã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚

### å•é¡Œï¼š
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ç«¶æŠ€ï¼ˆepisodeIdï¼‰ã«é–¢é€£ã™ã‚‹ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„ã‚²ãƒ¼ãƒ ã®æƒ…å ±ã‚’åé›†ã—ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã¨ã„ã†å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã®ç¨®é¡ã«å¿œã˜ã¦ã€é©åˆ‡ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã€æ­£ç¢ºãªçµæœã‚’å¾—ã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼š
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: 
   - `requests`: APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã€‚
   - `json`: å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§ã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®è§£æã«åˆ©ç”¨ã€‚
   - `pandas`: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆãƒ»æ“ä½œã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã€‚
   - `pathlib`: ãƒ‘ã‚¹æ“ä½œã®ãŸã‚ã«æ´»ç”¨ã€‚

2. **ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨å‡¦ç†æ‰‹æ³•**:
   - Kaggleã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰éå»ã®ã‚²ãƒ¼ãƒ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½¿ç”¨ã€‚
   - ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦ä»¥å‰ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€æ–°ã—ã„ã‚²ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«çµ±åˆã€‚
   - ã‚²ãƒ¼ãƒ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«ã¯ã€æ¡ä»¶ã«å¿œã˜ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†ï¼ˆä¾‹ãˆã°ã€æ¤œè¨¼ã‚²ãƒ¼ãƒ ã‚’é™¤å¤–ï¼‰ã‚„ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ãƒ¡ãƒ¢ãƒªã«ä¿æŒã™ã‚‹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã€‚
   - ã‚²ãƒ¼ãƒ ã®å„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’è§£æã—ã€å¿…è¦ãªæƒ…å ±ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ï¼‰ã‚’æŠ½å‡ºã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ä¿å­˜ã€‚

3. **å‡ºåŠ›**: 
   - æœ€çµ‚çš„ã«ã€ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€ä»Šå¾Œã®åˆ†æã‚„ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ä½œæˆã®ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹å½¢ã«æ•´å½¢ã€‚

### ã¾ã¨ã‚:
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿é§†å‹•å‹ã®åˆ†æã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã®é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®æ‰‹æ³•ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€å°†æ¥ã®ãƒ¢ãƒ‡ãƒ«è©•ä¾¡ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã«è²¢çŒ®ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import requests
import json
import pandas as pd
from pathlib import Path
```

---The following area is a Markdown cell (cell numver is 2)---
```markdown
[Meta kaggleãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ](https://www.kaggle.com/datasets/kaggle/meta-kaggle)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®`episodeId`ã‚’å–å¾—ã—ã¾ã™ https://www.kaggle.com/competitions/llm-20-questions  
ï¼ˆmeta-kaggleãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ã€å‡ºæ‰€ã«`[Dataset no longer available]`ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã§ã‚‚æ©Ÿèƒ½ã—ã¾ã™ï¼‰

æ›´æ–°: ã‚°ã‚¨ãƒƒã‚µãƒ¼ï¼ˆguesserï¼‰ã¨ã‚¢ãƒ³ã‚µãƒ¼ï¼ˆanswererï¼‰ã‹ã‚‰ã®`submissionId`ã‚’è¿½åŠ ã—ã¾ã—ãŸ  
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‚ç…§ã—ã¦ãã ã•ã„: https://www.kaggle.com/code/waechter/llm-20-questions-leaderbord-analyze-best-agents

âš ï¸ *æœ€åˆã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦å®Ÿè¡Œã—ãªã„ã§ãã ã•ã„ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤§é‡ã«ãªã‚‹ãŸã‚ã€  
ä»£ã‚ã‚Šã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¾ãŸã¯ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„* âš ï¸

# ä»¥å‰ã®ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€
```

---The following area is a Code cell (cell numver is 3)---
```python
df_games = pd.read_csv("/kaggle/input/llm-20-questions-games-dataset/LLM-20Questions-games.csv", index_col='index')
df_games
```

---The following area is a Code cell (cell numver is 4)---
```python
def download_game(num, CreateTime, do_print=False):
    url_api = "https://www.kaggleusercontent.com/episodes/{num_episode}.json"
    try:
        r = requests.get(url_api.format(num_episode=num))
        if r.status_code!=200:
            print(f"Error http {r.status_code=} {num=}")
            return {}
        resp = r.json()
        teams = resp["info"]["TeamNames"][0:2], resp["info"]["TeamNames"][2:] # ãƒãƒ¼ãƒ åã‚’å–å¾—ï¼ˆguesser_team1, answerer_team1ï¼‰ã€(guesser_team2, answerer_team2)
        formated = {}
        for (guesser,answerer), step in zip(teams, resp["steps"][-1][1::2]): # å„ãƒãƒ¼ãƒ ã®æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦æ¨æ¸¬è€…ã®æƒ…å ±ã‚’å–å¾—
            keyword, category = step['observation']['keyword'], step['observation']['category']
            if do_print:
                print(f"###\n{guesser=} {answerer=} step {len(step['observation']['answers'])}")
                print(f"{keyword=} {category=}")
                for answer, question, guess in zip(step['observation']['answers'], step['observation']['questions'], step['observation']['guesses']):
                    print(f"\t{question=} {answer=} {guess=}")
            game_index = f"{num}__{guesser}__{answerer}"
            formated[game_index] = {key : step['observation'][key] for key in ['answers', 'questions', 'guesses', 'keyword', 'category']}
            formated[game_index]["guesser"]=guesser
            formated[game_index]["answerer"]=answerer
            formated[game_index]["nb_round"]=len(step['observation']['answers'])
            formated[game_index]["game_num"]=num
            formated[game_index]["guessed"]=keyword in step['observation']['guesses'] # æ­£ã—ããªã„å¯èƒ½æ€§ã‚ã‚Šã€keyword_guessedã‚’å‚ç…§ https://www.kaggle.com/code/waechter/llm-20-questions-leaderbord-analyze-best-agents?scriptVersionId=181553251&cellId=4
            formated[game_index]["CreateTime"]=CreateTime
        return formated
    except Exception as e:
        print("Error parsing", num)
#         print(e)
        return {}
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®æ–°ã—ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ãƒ¡ã‚¿kaggleãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰å–å¾—
```

---The following area is a Code cell (cell numver is 6)---
```python
%%time
meta_path = Path("/kaggle/input/meta-kaggle")
episodes_df = pd.read_csv(meta_path/"Episodes.csv", index_col="Id")
```

---The following area is a Code cell (cell numver is 7)---
```python
episodes_df = episodes_df.loc[episodes_df.CompetitionId==61247]
episodes_df
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
* ã‚¿ã‚¤ãƒ—4ã¯æ¤œè¨¼ã‚²ãƒ¼ãƒ ï¼ˆ1ãƒãƒ¼ãƒ ã€åŒã˜ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸¡å´ï¼‰
* ã‚¿ã‚¤ãƒ—1ã¯2ãƒãƒ¼ãƒ ã€4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã“ã‚Œã‚‰ã®ã¿ã‚’ä¿æŒã—ã¾ã™
```

---The following area is a Code cell (cell numver is 9)---
```python
# æœ¬ç‰©ã®ã‚²ãƒ¼ãƒ ã®ã¿ã‚’ä¿æŒã™ã‚‹ï¼ˆæ¤œè¨¼ã‚²ãƒ¼ãƒ ã‚’é™¤å¤–ã™ã‚‹ï¼‰
episodes_df = episodes_df.loc[episodes_df.Type==1,"CreateTime"]
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
## å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨
`EpisodeAgents.csv`ã¯ä¸€åº¦ã«èª­ã¿è¾¼ã‚€ã«ã¯å¤§ãã™ãã¾ã™
```

---The following area is a Code cell (cell numver is 11)---
```python
def filter_gen(filepath=meta_path/"EpisodeAgents.csv", chunksize = 10 ** 6):
    episodes_ids = episodes_df.index
    with pd.read_csv(filepath, chunksize=chunksize, index_col="Id") as reader:
        for chunk in reader:
            mask = chunk.EpisodeId.isin(episodes_ids)
            if mask.any():
                yield chunk.loc[mask]
```

---The following area is a Code cell (cell numver is 12)---
```python
%%time
agents_df = pd.concat(filter_gen())
agents_df
```

---The following area is a Markdown cell (cell numver is 13)---
```markdown
# æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹
```

---The following area is a Code cell (cell numver is 14)---
```python
%%time
print(f"ä»¥å‰ã®ã‚²ãƒ¼ãƒ æ•° {len(df_games)=}")
df_games = pd.concat([df_games]+[pd.DataFrame(download_game(episode_id, date)).T for episode_id, date in episodes_df.items() if episode_id not in df_games.game_num.values])
print(f"æ›´æ–°å¾Œ {len(df_games)=}")
df_games
```

---The following area is a Code cell (cell numver is 15)---
```python
new_category_games = df_games.loc[(df_games.category =='place') | (df_games.category =='things')]
new_category_games
```

---The following area is a Code cell (cell numver is 16)---
```python
keywords_category = pd.DataFrame({keyword.lower():{"keyword":keyword,"category":category} for keyword,category in new_category_games[["keyword","category"]].value_counts().index}).T
keywords_category = keywords_category.sort_index()
keywords_category.to_csv("keywords.csv")
```

---The following area is a Markdown cell (cell numver is 17)---
```markdown
## SubmissionIdã‚’è¿½åŠ 
```

---The following area is a Code cell (cell numver is 18)---
```python
%%time
for name, group in df_games.groupby(by="game_num"):
    if "guesser_SubmissionId" and "answerer_SubmissionId" in group.columns and (group.guesser_SubmissionId>0).all() and (group.answerer_SubmissionId>0).all():
        continue # ã™ã§ã«å®Œäº†ã—ã¦ã„ã¾ã™
    
    agents_sub=agents_df[agents_df.EpisodeId==name].sort_values("Index")
    
    if len(agents_sub)!=4:
        print(f"{name=} åˆ©ç”¨å¯èƒ½ãªå…¨ã¦ã®æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
        continue
        
    # EpisodeAgentsã¯å„EpisodeIdã«å¯¾ã—ã¦4è¡Œã‚’æŒã¡ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯0-4ã€‚å‡ºåŠ›ãƒ­ã‚°json [guesser_team1,answerer_team1,guesser_team2,answerer_team2] ã¨åŒã˜é †åº
    for i, (index, row) in enumerate(group.iterrows()):
        # 2è¡Œï¼ˆå„ãƒãƒ¼ãƒ ã«å¯¾ã—ã¦1ã¤ãšã¤ï¼‰
        df_games.loc[index, ["guesser_SubmissionId","answerer_SubmissionId"]] = [agents_sub.loc[agents_sub.Index==i*2,"SubmissionId"].iloc[0], agents_sub.loc[agents_sub.Index==1+i*2,"SubmissionId"].iloc[0]]

df_games[["guesser_SubmissionId","answerer_SubmissionId"]] = df_games[["guesser_SubmissionId","answerer_SubmissionId"]].fillna(0).astype("int")
df_games
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
### ãƒãƒ¼ã‚¸ãŒæ­£ã—ãè¡Œã‚ã‚ŒãŸã‹ãƒ†ã‚¹ãƒˆ
```

---The following area is a Code cell (cell numver is 20)---
```python
if set(df_games.answerer_SubmissionId) != set(df_games.guesser_SubmissionId):
    print("guesserã®ã¿ã«å­˜åœ¨ã™ã‚‹sub",set(df_games.guesser_SubmissionId) - set(df_games.answerer_SubmissionId))
    print("answererã®ã¿ã«å­˜åœ¨ã™ã‚‹sub",set(df_games.answerer_SubmissionId) - set(df_games.guesser_SubmissionId))
if set(df_games.answerer) != set(df_games.guesser):
    print("guesserã®ã¿ã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ãƒ ",set(df_games.guesser) - set(df_games.answerer))
    print("answererã®ã¿ã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ãƒ ",set(df_games.answerer) - set(df_games.guesser))
```

---The following area is a Code cell (cell numver is 21)---
```python
f"ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒãƒ¼ãƒ æ•°: {len(df_games.answerer.unique())} æå‡ºæ•°:{len(df_games.answerer_SubmissionId.unique())}"
```

---The following area is a Code cell (cell numver is 22)---
```python
# df_games.answerer_SubmissionId.unique()ã®å„submissionIdã«ã¤ã„ã¦:
#     guesser = df_games.loc[df_games.guesser_SubmissionId==submissionId,"guesser"].unique()
#     answerer = df_games.loc[df_games.answerer_SubmissionId==submissionId,"answerer"].unique()
#     if len(answerer)>1  or len(guesser)>1:
#         print(f"{submissionId=} ã§è¤‡æ•°ã®ãƒãƒ¼ãƒ åãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ {guesser=}, {answerer=}")
```

---The following area is a Markdown cell (cell numver is 23)---
```markdown
`submissionId=0`ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚‚ã®ã§ã€æ¬¡ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã«å†åº¦åŸ‹ã‚ã‚‹äºˆå®šã§ã™  
æ®‹ã‚Šã¯åå‰ã‚’æ›´æ–°ã—ãŸãƒãƒ¼ãƒ ã ã¨æ€ã„ã¾ã™
```

---The following area is a Code cell (cell numver is 24)---
```python
df_games[["guesser_SubmissionId","guesser"]].value_counts()
```

---The following area is a Code cell (cell numver is 25)---
```python
for team in df_games.answerer.unique():
    submissions_set = set(df_games.loc[df_games.guesser==team, "guesser_SubmissionId"]) & set(df_games.loc[df_games.answerer==team, "answerer_SubmissionId"])
    print(f"{team=}, {len(submissions_set)} æå‡ºæ•°")
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
# ä¿å­˜
```

---The following area is a Code cell (cell numver is 27)---
```python
df_games.to_csv("LLM-20Questions-games.csv", index_label="index")
agents_df.to_csv("EpisodeAgents.csv", index_label="Id")
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
https://www.kaggle.com/code/waechter/llm-20-questions-leaderbord-analyze-best-agentsã§ä½¿ç”¨
```

---The following area is a Markdown cell (cell numver is 29)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## OminousDude
> 
> ã¨ã¦ã‚‚ã¨ã¦ã‚‚å½¹ç«‹ã¤ã€ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã«æ„Ÿè¬ã—ã¾ã™ï¼ç§ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¢ºèªã™ã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚
> 

> 
> 

---

> ## Mario Caesar
> 
> LLMãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«é–¢ã™ã‚‹å„ªã‚ŒãŸä½œæ¥­ã‚’ã—ã¦ãã‚Œã¦ã€ç§ã¯ã‚ãªãŸã®ä½œæ¥­ã‹ã‚‰å¤šãã®æ–°ã—ã„ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸ[@waechter](https://www.kaggle.com/waechter)ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ğŸ˜ğŸ‘Šï¼æ”¯æŒã—ã¾ã™ï¼ï¼ã“ã‚Œã‹ã‚‰ã‚‚é ‘å¼µã£ã¦ãã ã•ã„ã€‚
> 
> 
> 

---

> ## Zeeshan Latif
> 
> [@waechter](https://www.kaggle.com/waechter) ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ï¼
> 
> 

---

> ## JuHyeon_
> 
> ç´ æ™´ã‚‰ã—ã„ï¼å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†[@waechter](https://www.kaggle.com/waechter) 
> 
> LLMåˆå¿ƒè€…ã«ã¨ã£ã¦ç´ æ™´ã‚‰ã—ã„æ•™æã§ã™:)
> 
> é«˜è©•ä¾¡ğŸ˜€æ™‚é–“ãŒã‚ã‚Œã°ç§ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚‚è¦‹ã¦æ¬²ã—ã„ã§ã™ï¼
> 

---

> ## Sara Taghizadeh Milani
> 
> æ˜ã‚‰ã‹ã«å¤šãã®æ€è€ƒã¨åŠªåŠ›ãŒè¾¼ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å¾¹åº•æ€§ã¨æ˜ç¢ºæ€§ã‹ã‚‰é«˜è©•ä¾¡â€”ã‚ãªãŸã®ä»Šå¾Œã®ä½œå“ãŒæ¥½ã—ã¿ã§ã™ï¼
> 
> [@waechter](https://www.kaggle.com/waechter) 
> 

---

> ## MarÃ­lia Prata
> 
> ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆLLM-20Questions-gamesã«é–¢ã™ã‚‹ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã€Waechterã€‚
> 
> 

---
```

** @@@ Jupyter Notebook numver 9, the number of votes :24 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®åˆ†æã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€æ¨æ¸¬è€…ã¨å›ç­”è€…ã®å‹ç‡ã‚’è¨ˆç®—ã—ã€æ¨æ¸¬è€…ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã‚„ç‰¹å¾´çš„ãªãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã«ã€ä¸»è¦ãªæ‰‹æ³•ã‚„ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€è§£æ±ºã—ã¦ã„ã‚‹å•é¡Œã«ã¤ã„ã¦è¦ç´„ã—ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
- ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’é€šã˜ã¦ã€æ¨æ¸¬è€…ã¨å›ç­”è€…ã®å‹ç‡ã‚’è©•ä¾¡ã—ã€ã©ã®ãƒãƒ¼ãƒ ãŒæˆåŠŸã—ãŸã®ã‹ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã“ã¨ã€‚
- ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹è³ªå•ã®å‚¾å‘ã‚’è¦–è¦šåŒ–ã—ã€ã‚ˆãä½¿ã‚ã‚Œã‚‹è³ªå•ã‚„ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¯¾ã™ã‚‹æˆåŠŸç‡ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•
1. **ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†**: 
   - Pandasã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã€ç‰¹å®šã®åˆ—ï¼ˆè³ªå•ã€å›ç­”ã€æ¨æ¸¬ï¼‰ã‚’ãƒªã‚¹ãƒˆå‹ã«å¤‰æ›ã€‚
   - `keyword_guessed`é–¢æ•°ã‚’ä½¿ã£ã¦ã€æ¨æ¸¬ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã€‚

2. **å‹ç‡ã®è¨ˆç®—**:
   - ãƒãƒ¼ãƒ ã”ã¨ã®ã‚²ãƒ¼ãƒ æ•°ã‚’é›†è¨ˆã—ã€æ¨æ¸¬è€…ã¨å›ç­”è€…ã®å‹ç‡ã‚’è¨ˆç®—ã™ã‚‹ã€‚
   - åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãŸã‚ã«ã€NumPyã¨Pandasã®é–¢æ•°ã‚’åˆ©ç”¨ã€‚

3. **ãƒ‡ãƒ¼ã‚¿ã®è¦–è¦šåŒ–**:
   - Matplotlibã‚„WordCloudãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦ã€è³ªå•ã®ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆã—ã€æœ€ã‚‚å¤šãä½¿ã‚ã‚Œã‚‹è³ªå•ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã€‚
   - åŠ¹ç‡çš„ãªæƒ…å ±æä¾›ã®ãŸã‚ã€Markdownã‚»ãƒ«ã‚’ä½¿ã£ã¦çµæœã‚’æ•´ç†ã—ã¦è¡¨ç¤ºã€‚

4. **TF-IDF**:
   - `TfidfVectorizer`ã‚’ä½¿ã£ã¦è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã€é‡è¦ãªè³ªå•ã‚’ç‰¹å®šã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Pandas**: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ æ“ä½œã‚„CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã€‚
- **Matplotlib**: ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã€‚
- **WordCloud**: è³ªå•ã®ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã®ç”Ÿæˆã€‚
- **Scikit-learn**: ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç‰¹å¾´é‡æŠ½å‡ºã«ä½¿ç”¨ã•ã‚Œã‚‹TF-IDFãƒ™ã‚¯ãƒˆãƒ«åŒ–ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸­ã§ã¯ã€ã•ã¾ã–ã¾ãªåˆ†æçµæœãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ç‰¹ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®æˆåŠŸã—ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„è³ªå•ã®ä¸€èˆ¬çš„ãªå‚¾å‘ãŒæ˜ã‚Šä¸‹ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€ä»–ã®å‚åŠ è€…ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚‚ã‚ã‚Šã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®è©•ä¾¡ã‚’åæ˜ ã—ãŸå†…å®¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ç›®æ¬¡
ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®ãƒˆãƒƒãƒ—ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã¾ã™:
* [æ¨æ¸¬è€…ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰](#Guesser_leaderbord)
* [å›ç­”è€…ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰](#Answerer_leaderbord)
* [æ¨æ¸¬è€…æå‡ºãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰](#Guesser_submission_leaderbord)
* [å›ç­”è€…æå‡ºãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰](#Answerer_submission_leaderbord)
* [è³ªå•ã®ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰](#Questions_wordcould)
```

---The following area is a Code cell (cell numver is 2)---
```python
import pandas as pd
from ast import literal_eval
from IPython.display import display, Markdown
import string
import json

import nltk
from nltk.corpus import stopwords
from wordcloud import WordCloud, STOPWORDS, ImageColorGenerator
import matplotlib.pyplot as plt
from sklearn.feature_extraction.text import TfidfVectorizer
from collections import Counter
```

---The following area is a Code cell (cell numver is 3)---
```python
df = pd.read_csv("/kaggle/input/llm-20-questions-games-dataset/LLM-20Questions-games.csv", converters={col_list:literal_eval for col_list in ["answers", "questions", "guesses"]})
df
```

---The following area is a Code cell (cell numver is 4)---
```python
def keyword_guessed(guess: str, keyword:str, alts:list[str]) -> bool:
    # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ llm_20_questions.py ã‹ã‚‰ã®é–¢æ•°
    def normalize(s: str) -> str:
        # æ–‡å­—åˆ—ã®æ­£è¦åŒ–ã‚’è¡Œã†é–¢æ•°
        t = str.maketrans("", "", string.punctuation)
        return s.lower().replace("the", "").replace(" ", "").translate(t)

    if normalize(guess) == normalize(keyword):
        return True  # æ¨æ¸¬ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹å ´åˆ
    for s in alts:
        if normalize(guess) == normalize(s):
            return True  # æ¨æ¸¬ãŒä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ã¨ä¸€è‡´ã™ã‚‹å ´åˆ

    return False  # ä¸€è‡´ã—ãªã„å ´åˆ
```

---The following area is a Code cell (cell numver is 5)---
```python
exec(open("/kaggle/input/llm-20-questions/llm_20_questions/keywords.py").read()) # KEYWORDS_JSON ã‚’ä½œæˆ
KEYWORDS_JSON = json.loads(KEYWORDS_JSON)
# keyword_guessed ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦
KEYWORD_TO_ALTS = {words["keyword"]:words["alts"] for category in KEYWORDS_JSON for words in category["words"]}
# KEYWORD_TO_ALTS
```

---The following area is a Code cell (cell numver is 6)---
```python
# `guessed`ã®ä¿®æ­£ã€‚isinã®ä»£ã‚ã‚Šã«ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®é–¢æ•°ã‚’ä½¿ç”¨
df["guessed"]=df.apply(lambda row: keyword_guessed(row.guesses[-1] if len(row.guesses)>0 else "", row.keyword, KEYWORD_TO_ALTS.get(row.keyword,[])), axis=1)

# ãƒãƒ¼ãƒ ã”ã¨ã®ã‚²ãƒ¼ãƒ æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦æ­£è¦åŒ–ã™ã‚‹
guesser_counts = {k:v for k,v in df.guesser.value_counts().items()}
answerer_counts = {k:v for k,v in df.answerer.value_counts().items()}

winner_df = df.loc[df.guessed]  # æ¨æ¸¬ã«æˆåŠŸã—ãŸã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
winner_df
```

---The following area is a Code cell (cell numver is 7)---
```python
winner_df.guesser.value_counts().head(10)  # æœ€ã‚‚æˆåŠŸã—ãŸæ¨æ¸¬è€…ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 8)---
```python
def fmt_team_winrate(team, team_fmt = "{:30} winrate: {:.3%} ({}/{})")->str:
    # ãƒãƒ¼ãƒ ã®å‹ç‡ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    return team_fmt.format(team[0], team[1][0], team[1][1], team[1][2])

def winrate(win_counts:dict, total_counts:dict)->list:
    # å‹ç‡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    ratio_win = {k:(v/total_counts.get(k,1), v, total_counts.get(k)) for k,v in win_counts}
    return sorted(ratio_win.items(), key=lambda item: item[1][0], reverse = True)  # å‹ç‡ã§ã‚½ãƒ¼ãƒˆ
```

---The following area is a Code cell (cell numver is 9)---
```python
def print_winrate(winner_df=winner_df, df=df):
    # å‹ç‡ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    nb_total_games = len(df)  # ç·ã‚²ãƒ¼ãƒ æ•°
    nb_wins = len(winner_df)  # å‹åˆ©æ•°
    print(fmt_team_winrate(("Winrate total",(nb_wins/nb_total_games,nb_wins,nb_total_games))))  # ç·å‹ç‡ã‚’è¡¨ç¤º

print_winrate()  # å‹ç‡ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
# æ¨æ¸¬è€…ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰
```

---The following area is a Code cell (cell numver is 11)---
```python
guesser_win = winrate(winner_df.guesser.value_counts().items(), guesser_counts)  # æ¨æ¸¬è€…ã®å‹ç‡ã‚’è¨ˆç®—
for team in guesser_win[:10]:  # ä¸Šä½10ãƒãƒ¼ãƒ ã®å‹ç‡ã‚’è¡¨ç¤º
    print(fmt_team_winrate(team))
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
# å›ç­”è€…ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰
[ç›®æ¬¡](#ç›®æ¬¡)
```

---The following area is a Code cell (cell numver is 13)---
```python
answerer_win = winrate(winner_df.answerer.value_counts().items(), answerer_counts)  # å›ç­”è€…ã®å‹ç‡ã‚’è¨ˆç®—
for team in answerer_win[:10]:  # ä¸Šä½10ãƒãƒ¼ãƒ ã®å‹ç‡ã‚’è¡¨ç¤º
    print(fmt_team_winrate(team))
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
## æœ€ã‚‚æ¨æ¸¬ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:
```

---The following area is a Code cell (cell numver is 15)---
```python
winner_df.keyword.value_counts()  # ãƒ•ãƒ©ãƒ³ã‚¹ãŒãƒˆãƒƒãƒ—ã€åŸºæº–ã®ä¾‹ã«ã‚ˆã‚‹ã‚‚ã®ã¨æ€ã‚ã‚Œã‚‹
```

---The following area is a Code cell (cell numver is 16)---
```python
episode_agents = pd.read_csv("/kaggle/input/llm-20-questions-games-dataset/EpisodeAgents.csv")  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
episode_agents=episode_agents.groupby(["EpisodeId","SubmissionId"]).first()  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰IDã¨æå‡ºIDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
episode_agents
```

---The following area is a Code cell (cell numver is 17)---
```python
def show_game(row:pd.Series):
    # ã‚²ãƒ¼ãƒ ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    if row.empty:
        return 
    table_format = "| {question} | {answer} | {guess} |"  # è¡¨å½¢å¼ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    history = "\n".join([table_format.format(question="question",answer="answer", guess="guess"), table_format.format(question="---",answer="---", guess="---") ] + [table_format.format(question=question,answer=answer, guess=guess) for answer, question, guess in zip(row.answers, row.questions, row.guesses)])
    guesser_score = episode_agents.loc[(row.game_num, row.guesser_SubmissionId)]  # æ¨æ¸¬è€…ã®ã‚¹ã‚³ã‚¢
    guesser_score = f"{guesser_score.InitialScore:.2f}->{guesser_score.UpdatedScore:.2f} Confidence={guesser_score.UpdatedConfidence:.2f}" if not guesser_score.empty else ""
    
    answerer_score = episode_agents.loc[(row.game_num, row.answerer_SubmissionId)]  # å›ç­”è€…ã®ã‚¹ã‚³ã‚¢
    answerer_score = f"{answerer_score.InitialScore:.2f}->{answerer_score.UpdatedScore:.2f} Confidence={answerer_score.UpdatedConfidence:.2f}" if not answerer_score.empty else ""
    
    return display(Markdown(f"""\
* {row.game_num=}
* æ¨æ¸¬è€…:  **{row.guesser}** ã‚¹ã‚³ã‚¢: {guesser_score}
* å›ç­”è€…: **{row.answerer}** ã‚¹ã‚³ã‚¢: {answerer_score}
* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: **{row.keyword}** ã‚«ãƒ†ã‚´ãƒªãƒ¼: {row.category} 
* ãƒ©ã‚¦ãƒ³ãƒ‰æ•°: {row.nb_round} {row.CreateTime}

{history}
"""))
    
show_game(winner_df.iloc[0])  # ã“ã®ä¾‹ã¯ã€`the answer is: france`ãŒã‚²ãƒ¼ãƒ ã«å‹ã¦ãªã‹ã£ãŸã“ã¨ã‚’ç¤ºã™ã€‚æ­£ç¢ºãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¾ãŸã¯ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã€‚
```

---The following area is a Code cell (cell numver is 18)---
```python
display(Markdown(f"## æœ€å„ªç§€å›ç­”è€… **{fmt_team_winrate(answerer_win[0])}**"))
for i, row in winner_df[winner_df.answerer==answerer_win[0][0]].iterrows():
    show_game(row)  # æœ€å„ªç§€å›ç­”è€…ã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 19)---
```python
display(Markdown(f"## æœ€å„ªç§€æ¨æ¸¬è€… **{fmt_team_winrate(guesser_win[0])}**"))
for i, row in winner_df[winner_df.guesser==guesser_win[0][0]].iterrows():
    show_game(row)  # æœ€å„ªç§€æ¨æ¸¬è€…ã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
# æœ€å„ªç§€æå‡ºç‰©
æå‡ºç‰©IDã”ã¨ã®é †ä½ã‚’ç¤ºã—ã¾ã™ã€‚ãƒãƒ¼ãƒ ã¯ç•°ãªã‚‹æˆ¦ç•¥ã‚„çµæœã‚’æŒã¤è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã§ãã¾ã™ã€‚  
æå‡ºIDã¨ã¨ã‚‚ã«æ–°ã—ã„æå‡ºãŒè‰¯å¥½ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆãƒãƒ¼ãƒ ãŒä½•å›æå‡ºã—ã¦ã‚‚ã€ã©ã‚Œã ã‘ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã‚‚é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚
```

---The following area is a Code cell (cell numver is 21)---
```python
guesser_sub_counts = {k:v for k,v in df.guesser_SubmissionId.value_counts().items()}  # æ¨æ¸¬è€…ã®æå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
answerer_sub_counts = {k:v for k,v in df.answerer_SubmissionId.value_counts().items()}  # å›ç­”è€…ã®æå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

guesser_sub_win = winrate(winner_df.guesser_SubmissionId.value_counts().items(), guesser_sub_counts)  # æ¨æ¸¬è€…ã®å‹ç‡ã‚’è¨ˆç®—
answerer_sub_win = winrate(winner_df.answerer_SubmissionId.value_counts().items(), answerer_sub_counts)  # å›ç­”è€…ã®å‹ç‡ã‚’è¨ˆç®—

subId_to_team = {**winner_df.groupby("answerer_SubmissionId").answerer.first(), **winner_df.groupby("guesser_SubmissionId").guesser.first()}  # æå‡ºIDã‚’ãƒãƒ¼ãƒ ã«ãƒãƒƒãƒ”ãƒ³ã‚°
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
# æ¨æ¸¬è€…æå‡ºãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰
[ç›®æ¬¡](#ç›®æ¬¡)
```

---The following area is a Code cell (cell numver is 23)---
```python
for team in guesser_sub_win[:10]:  # ä¸Šä½10ãƒãƒ¼ãƒ ã®æ¨æ¸¬è€…æå‡ºã‚’è¡¨ç¤º
    team = (f"{subId_to_team[team[0]]} {team[0]}",(team[1]))
    print(fmt_team_winrate(team))
```

---The following area is a Code cell (cell numver is 24)---
```python
display(Markdown(f"## æœ€å„ªç§€æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ : æå‡ºID={fmt_team_winrate(guesser_sub_win[0])}"))
for i, row in winner_df[winner_df.guesser_SubmissionId==guesser_sub_win[0][0]].iterrows():
    show_game(row)  # æœ€å„ªç§€æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 25)---
```markdown
# å›ç­”è€…æå‡ºãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰
[ç›®æ¬¡](#ç›®æ¬¡)
```

---The following area is a Code cell (cell numver is 26)---
```python
for team in answerer_sub_win[:10]:  # ä¸Šä½10ãƒãƒ¼ãƒ ã®å›ç­”è€…æå‡ºã‚’è¡¨ç¤º
    team = (f"{subId_to_team[team[0]]} {team[0]}",(team[1]))
    print(fmt_team_winrate(team))
```

---The following area is a Code cell (cell numver is 27)---
```python
display(Markdown(f"## æœ€å„ªç§€å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ : {subId_to_team[answerer_sub_win[0][0]]} æå‡ºID={fmt_team_winrate(answerer_sub_win[0])}"))
for i, row in winner_df[winner_df.answerer_SubmissionId==answerer_sub_win[0][0]].iterrows():
    show_game(row)  # æœ€å„ªç§€å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 28)---
```python
display(Markdown(f"## 2ç•ªç›®ã«å„ªç§€ãªå›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ : {subId_to_team[answerer_sub_win[1][0]]} æå‡ºID={fmt_team_winrate(answerer_sub_win[1])}"))
for i, row in winner_df[winner_df.answerer_SubmissionId==answerer_sub_win[1][0]].iterrows():
    show_game(row)  # 2ç•ªç›®ã«å„ªç§€ãªå›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 29)---
```markdown
# æœ€å„ªç§€ã‚¹ã‚³ã‚¢ã®æå‡ºç‰©ã‹ã‚‰ã®ã‚²ãƒ¼ãƒ 
éå»ã®æå‡ºç‰©ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ãŒã€ä»Šã®ã¨ã“ã‚ã‚ã¾ã‚Šå½¹ã«ç«‹ã¡ã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 30)---
```python
_, best_subId = episode_agents.iloc[episode_agents.UpdatedScore.argmax()].name
display(Markdown(f"## æœ€å„ªç§€ã‚¹ã‚³ã‚¢ã®æå‡ºç‰©: {subId_to_team[best_subId]} æå‡ºID={best_subId}"))
for i, row in winner_df[winner_df.answerer_SubmissionId==best_subId].iterrows():
    show_game(row)  # æœ€å„ªç§€ã‚¹ã‚³ã‚¢ã®å›ç­”è€…ã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º

for i, row in winner_df[winner_df.guesser_SubmissionId==best_subId].iterrows():
    show_game(row)  # æœ€å„ªç§€ã‚¹ã‚³ã‚¢ã®æ¨æ¸¬è€…ã®ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 31)---
```markdown
# è³ªå•ã®ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰
```

---The following area is a Code cell (cell numver is 32)---
```python
t = str.maketrans("", "", string.punctuation)  # å¥èª­ç‚¹ã‚’é™¤å»ã™ã‚‹ãŸã‚ã®ç¿»è¨³ãƒãƒƒãƒ”ãƒ³ã‚°
questions_flat = [question.lower() for questions in df.questions.values for question in questions]  # è³ªå•ã‚’å°æ–‡å­—ã§å¹³å¦åŒ–
print("ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè³ªå•æ•°:",len(set(questions_flat)))  # ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè³ªå•ã®æ•°ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 33)---
```python
Counter(questions_flat).most_common(50)  # æœ€ã‚‚ä¸€èˆ¬çš„ãª50ã®è³ªå•ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 34)---
```python
nltk.download('stopwords')  # ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
stop_words = list(stopwords.words('english'))  # ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
stop_words
```

---The following area is a Code cell (cell numver is 35)---
```python
%%time
top_q_str = " ".join(question for question, count in Counter(questions_flat).most_common(200))  # ä¸Šä½200ã®è³ªå•ã‚’çµåˆ
wordcloud = WordCloud(stopwords=stop_words, background_color="white", width=800, height=400).generate(top_q_str)  # ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆ

# ç”Ÿæˆã—ãŸç”»åƒã‚’è¡¨ç¤º:
plt.figure(figsize=(30,20))
plt.imshow(wordcloud, interpolation='bilinear')  # ç”»åƒã‚’ãƒ“ãƒªãƒ‹ã‚¢è£œé–“ã§è¡¨ç¤º
plt.axis("off")  # è»¸ã‚’ã‚ªãƒ•ã«ã™ã‚‹
plt.show()  # ç”»åƒã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 36)---
```python
%%time
stop_words+=["keyword","question","questions","sure","please","answer","answerer","answers","yes"]  # è¿½åŠ ã®ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰
wordcloud_words = WordCloud(stopwords=stop_words, background_color="white", width=800, height=400).generate(top_q_str)  # ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆ

# ç”Ÿæˆã—ãŸç”»åƒã‚’è¡¨ç¤º:
plt.figure(figsize=(30,20))
plt.imshow(wordcloud_words, interpolation='bilinear')  # ç”»åƒã‚’ãƒ“ãƒªãƒ‹ã‚¢è£œé–“ã§è¡¨ç¤º
plt.axis("off")  # è»¸ã‚’ã‚ªãƒ•ã«ã™ã‚‹
plt.show()  # ç”»åƒã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 37)---
```python
# tfidf = TfidfVectorizer(max_df=.98, min_df=.01, stop_words=stop_words, use_idf=True, norm=None)
# questions_tfidf = tfidf.fit_transform(questions_flat)  # TF-IDFãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
# questions_tfidf
```

---The following area is a Code cell (cell numver is 38)---
```python
# tfidf.get_feature_names_out()  # ç‰¹å¾´åã‚’å–å¾—
```

---The following area is a Code cell (cell numver is 39)---
```python
# questions_tfidf = pd.DataFrame(questions_tfidf.todense(),columns=tfidf.get_feature_names_out())  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
# questions_tfidf
```

---The following area is a Markdown cell (cell numver is 40)---
```markdown
# å‹åˆ©ã—ãŸã‚²ãƒ¼ãƒ ã‹ã‚‰ã®æœ€ã‚‚é »ç¹ã«å°‹ã­ã‚‰ã‚Œã‚‹è³ªå•
```

---The following area is a Code cell (cell numver is 41)---
```python
# questions_win = {question for questions in winner_df.questions.values for question in questions}  # å‹åˆ©ã—ãŸã‚²ãƒ¼ãƒ ã®è³ªå•ã‚’é›†åˆã«æ ¼ç´
# print(len(questions_win))  # ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè³ªå•ã®æ•°ã‚’è¡¨ç¤º
# questions_win
```

---The following area is a Code cell (cell numver is 42)---
```python
all_questions_win = [question.lower() for questions in winner_df.questions.values for question in questions]  # å‹åˆ©ã—ãŸã‚²ãƒ¼ãƒ ã‹ã‚‰ã®ã™ã¹ã¦ã®è³ªå•
len(all_questions_win)  # å‹åˆ©ã—ãŸã‚²ãƒ¼ãƒ ã‹ã‚‰ã®è³ªå•æ•°ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 43)---
```python
Counter(all_questions_win).most_common(50)  # å‹åˆ©ã—ãŸã‚²ãƒ¼ãƒ ã§æœ€ã‚‚ä¸€èˆ¬çš„ãª50ã®è³ªå•ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 44)---
```python
%%time
stop_words+=["keyword","question","questions","sure","please","answer","answerer","answers","yes"]  # è¿½åŠ ã®ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰
wordcloud_words = WordCloud(stopwords=stop_words, background_color="white", width=800, height=400).generate(" ".join(question for question, count in Counter(all_questions_win).most_common(50)))  # ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆ

# ç”Ÿæˆã—ãŸç”»åƒã‚’è¡¨ç¤º:
plt.figure(figsize=(30,20))
plt.imshow(wordcloud_words, interpolation='bilinear')  # ç”»åƒã‚’ãƒ“ãƒªãƒ‹ã‚¢è£œé–“ã§è¡¨ç¤º
plt.axis("off")  # è»¸ã‚’ã‚ªãƒ•ã«ã™ã‚‹
plt.show()  # ç”»åƒã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 45)---
```markdown
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä¸»è¦ãªæˆåŠŸã‚’åã‚ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
```

---The following area is a Code cell (cell numver is 46)---
```python
winner_df_maj = winner_df.loc[winner_df.category.isin(["place","things"])]  # ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åŸºã¥ãå‹è€…ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
winner_df_maj
```

---The following area is a Code cell (cell numver is 47)---
```python
winner_df_maj.answerer.value_counts()  # ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ãŠã‘ã‚‹å›ç­”è€…ã®ã‚«ã‚¦ãƒ³ãƒˆ
```

---The following area is a Code cell (cell numver is 48)---
```python
winner_df_maj.guesser.value_counts()  # ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ãŠã‘ã‚‹æ¨æ¸¬è€…ã®ã‚«ã‚¦ãƒ³ãƒˆ
```

---The following area is a Markdown cell (cell numver is 49)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Divyanshu
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã€‚ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒˆã—ã¾ã—ãŸ
> 
> ç§ã®ä½œæ¥­ã‚’ç¢ºèªã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿè‰¯ã‘ã‚Œã°ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒˆã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚
> 
> 


---

> ## OminousDude
> 
> ã¨ã¦ã‚‚å½¹ã«ç«‹ã¡ã¾ã—ãŸã€‚ã‚ãªãŸã¯ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒˆã«å€¤ã—ã¾ã™ï¼
> 
> 


---

> ## Fayez Siddiqui
> 
> ã™ã°ã‚‰ã—ã„ä»•äº‹ !!
> 
> 


---

> ## Staratnyte
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ï¼ã¨ã¦ã‚‚å½¹ã«ç«‹ã¤ä½œæ¥­ã§ã™ã€‚
> 
> 


---
```

** @@@ Jupyter Notebook numver 10, the number of votes :23 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ã®é–‹ç™ºã«é–¢é€£ã—ã¦ãŠã‚Šã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ç‰¹ã«ä»¥ä¸‹ã®å•é¡Œã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ã¦ã„ã¾ã™ï¼š

1. **è¨€èªãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: Hugging Faceã‹ã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã‚’è¡Œã†ãŸã‚ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚

2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ**: è³ªå•ã‚„å›ç­”ã€æ¨æ¸¬ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚„ã€ã‚²ãƒ¼ãƒ ã®å±¥æ­´ã«åŸºã¥ã„ã¦æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„æ‰‹æ³•ï¼š
- **Hugging Face Hub**: ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
- **vLLM**: è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†ãŸã‚ã®ã‚µãƒ¼ãƒãƒ¼ã‚’æä¾›ã—ã€APIã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
- **Rigging**: è³ªå•ç”Ÿæˆã€å›ç­”ç”Ÿæˆã€æ¨æ¸¬ç”Ÿæˆã®ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚
- **Pydantic**: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ç”¨ã„ã‚‰ã‚Œã€è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‚„è³ªå•ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ´»ç”¨ã—ã¦åŠ¹æœçš„ã«è³ªå•ã‚’è¡Œã„ã€ã‚²ãƒ¼ãƒ ã®é€²è¡Œã«åˆã‚ã›ã¦é©åˆ‡ãªå›ç­”ã¨æ¨æ¸¬ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# Secrets (optional)

from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN: str | None  = None
KAGGLE_KEY: str | None = None
KAGGLE_USERNAME: str | None = None
    
try:
    HF_TOKEN = secrets.get_secret("HF_TOKEN")
    KAGGLE_KEY = secrets.get_secret("KAGGLE_KEY")
    KAGGLE_USERNAME = secrets.get_secret("KAGGLE_USERNAME")
except:
    pass
```

---The following area is a Code cell (cell numver is 2)---
```python
# Dependencies (uv for speed)

!pip install uv

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/lib \
    rigging==1.3.0 \
    kaggle

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/srvlib \
    vllm
```

---The following area is a Code cell (cell numver is 3)---
```python
# Download the model

from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/kaggle/tmp/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)  # ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã™ã€‚
g_model_path.mkdir(parents=True)  # ãƒ¢ãƒ‡ãƒ«ç”¨ã®æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

snapshot_download(
    repo_id="solidrust/Meta-Llama-3-8B-Instruct-hf-AWQ",  # Hugging Faceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
    ignore_patterns="original*",  # 'original'ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡è¦–ã—ã¾ã™ã€‚
    local_dir=g_model_path,  # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚
    local_dir_use_symlinks=False,  # ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚
    token=globals().get("HF_TOKEN", None)  # å¿…è¦ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
)
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile util.py

# Helpers for starting the vLLM server

import subprocess
import os
import socket
import time

def check_port(port: int) -> bool:  # ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã®é–¢æ•°
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:  # ã‚½ã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
            sock.settimeout(1)  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨­å®š
            result = sock.connect_ex(('localhost', port))  # æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆã«æ¥ç¶šã‚’è©¦ã¿ã¾ã™ã€‚
            if result == 0:  # æ¥ç¶šæˆåŠŸ
                return True
    except socket.error:  # ã‚½ã‚±ãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        pass
    
    return False  # ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ãªã„

def run_and_wait_for_port(
    cmd: list[str], port: int, env: dict[str, str] | None, timeout: int = 60
) -> subprocess.Popen:  # ç‰¹å®šã®ãƒãƒ¼ãƒˆãŒé–‹ãã¾ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
    
    if check_port(port):  # æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆãŒã™ã§ã«é–‹ã„ã¦ã„ã‚‹å ´åˆ
        raise ValueError(f"Port {port} is already open")
        
    popen = subprocess.Popen(
        cmd,
        env={**os.environ, **(env or {})},  # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        stdout=subprocess.DEVNULL,  # æ¨™æº–å‡ºåŠ›ã‚’ç„¡è¦–
        stderr=subprocess.DEVNULL  # æ¨™æº–ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
    )
    
    start_time = time.time()  # é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
    while time.time() - start_time < timeout:  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§ç¹°ã‚Šè¿”ã™
        if check_port(port):  # ãƒãƒ¼ãƒˆãŒé–‹ã„ãŸã‚‰
            return popen  # ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¿”ã™
        time.sleep(1)  # 1ç§’å¾…ã¤
    
    popen.terminate()  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
    raise Exception(f"Process did not open port {port} within {timeout} seconds.")  # ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
# Validate vLLM startup (optional - commented for faster builds)

# import importlib
# from pathlib import Path
# import util

# util = importlib.reload(util)

# g_srvlib_path = Path("/kaggle/tmp/srvlib")
# assert g_srvlib_path.exists()  # srvlib ã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

# g_model_path = Path("/kaggle/tmp/model")
# assert g_model_path.exists()  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

# g_vllm_port = 9999  # vLLM ã‚µãƒ¼ãƒãƒ¼ãŒä½¿ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·
# g_vllm_model_name = "custom"  # ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«å

# # Start vLLM server

# vllm = util.run_and_wait_for_port([
#     "python", "-m",
#     "vllm.entrypoints.openai.api_server",
#     "--enforce-eager",
#     "--model", str(g_model_path),  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹
#     "--port", str(g_vllm_port),  # ãƒãƒ¼ãƒˆç•ªå·
#     "--served-model-name", g_vllm_model_name  # ã‚µãƒ¼ãƒ–ã•ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«å
# ], g_vllm_port, {"PYTHONPATH": str(g_srvlib_path)})

# print("vLLM Started")  # vLLMã‚µãƒ¼ãƒãƒ¼é–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

---The following area is a Code cell (cell numver is 6)---
```python
# Connect with Rigging (optional - commented for faster builds)

# import sys
# import logging

# sys.path.insert(0, "/kaggle/tmp/lib")

# logging.getLogger("LiteLLM").setLevel(logging.WARNING)  # ãƒ­ã‚°ã®ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š

# import rigging as rg

# generator = rg.get_generator(
#     f"openai/{g_vllm_model_name}," \
#     f"api_base=http://localhost:{g_vllm_port}/v1," \
#     "api_key=sk-1234," \
#     "stop=<|eot_id|>" # Llama requires some hand holding
# )
# chat = generator.chat("Say Hello!").run()  # ãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè¡Œ

# print(chat.last)  # æœ€å¾Œã®ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 7)---
```python
%%writefile main.py

# Main agent file

import itertools
import os
import sys
import typing as t
from pathlib import Path
import logging

# Path fixups

g_working_path = Path('/kaggle/working')
g_input_path = Path('/kaggle/input')
g_temp_path = Path("/kaggle/tmp")
g_agent_path = Path("/kaggle_simulations/agent/")

g_model_path = g_temp_path / "model"
g_srvlib_path = g_temp_path / "srvlib"
g_lib_path = g_temp_path / "lib"

if g_agent_path.exists():  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå°‚ç”¨ã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    g_lib_path = g_agent_path / "lib"  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’æ›´æ–°
    g_model_path = g_agent_path / "model"  # ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ã‚’æ›´æ–°
    g_srvlib_path = g_agent_path / "srvlib"  # srvlibãƒ‘ã‚¹ã‚’æ›´æ–°

sys.path.insert(0, str(g_lib_path))  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«è¿½åŠ 

# Logging noise

logging.getLogger("LiteLLM").setLevel(logging.WARNING)  # ãƒ­ã‚°ã®ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š

# Fixed imports

import util # noqa  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import rigging as rg  # noqa  # riggingã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from pydantic import BaseModel, field_validator, StringConstraints  # noqa  # Pydanticã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# Constants

g_vllm_port = 9999  # vLLMãŒä½¿ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·
g_vllm_model_name = "custom"  # ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å

g_generator_id = (
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "stop=<|eot_id|>" # Llamaãƒ¢ãƒ‡ãƒ«ã«ã¯ç‰¹åˆ¥ãªè¨­å®šãŒå¿…è¦ã§ã™
)

# Types

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]  # ã‚¹ãƒšãƒ¼ã‚¹ã‚’ãƒˆãƒªãƒ ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ—

class Observation(BaseModel):  # è¦³æ¸¬ã‚’è¡¨ã™ãƒ¢ãƒ‡ãƒ«
    step: int  # ã‚¹ãƒ†ãƒƒãƒ—æ•°
    role: t.Literal["guesser", "answerer"]  # å½¹å‰²ï¼ˆæ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ï¼‰
    turnType: t.Literal["ask", "answer", "guess"]  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡
    keyword: str  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    category: str  # ã‚«ãƒ†ã‚´ãƒª
    questions: list[str]  # è³ªå•ã®ãƒªã‚¹ãƒˆ
    answers: list[str]  # å›ç­”ã®ãƒªã‚¹ãƒˆ
    guesses: list[str]  # æ¨æ¸¬ã®ãƒªã‚¹ãƒˆ
    
    @property
    def empty(self) -> bool:
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])  # è³ªå•ã€å›ç­”ã€æ¨æ¸¬ãŒç©ºã‹ã©ã†ã‹ã‚’åˆ¤å®š
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")  # æ­´å²ã‚’å–å¾—

    def get_history_as_xml(self, *, include_guesses: bool = False) -> str:  # æ­´å²ã‚’XMLå½¢å¼ã§å–å¾—
        return "\n".join(
            f"""\
            <turn-{i}>
            Question: {question}
            Answer: {answer}
            {'Guess: ' + guess if include_guesses else ''}
            </turn-{i}>
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
        ) if not self.empty else "none yet."  # ç©ºã§ãªã„å ´åˆã¯XMLã‚’ã€ãã†ã§ãªã„å ´åˆã¯ã€Œã¾ã ãªã—ã€ã¨è¿”ã™


class Answer(rg.Model):  # å›ç­”ã‚’ç¤ºã™ãƒ¢ãƒ‡ãƒ«
    content: t.Literal["yes", "no"]  # å›ç­”ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:  # contentã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        for valid in ["yes", "no"]:
            if v.lower().startswith(valid):  # æœ‰åŠ¹ãªå ´åˆ
                return valid  
        raise ValueError("Invalid answer, must be 'yes' or 'no'")  # ç„¡åŠ¹ãªå ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}**yes/no**{Answer.xml_end_tag()}"  # XMLå½¢å¼ã®ä¾‹


class Question(rg.Model):  # è³ªå•ã‚’è¡¨ã™ãƒ¢ãƒ‡ãƒ«
    content: str_strip  # è³ªå•å†…å®¹

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="**question**").to_pretty_xml()  # XMLå½¢å¼ã®ä¾‹


class Guess(rg.Model):  # æ¨æ¸¬ã‚’è¡¨ã™ãƒ¢ãƒ‡ãƒ«
    content: str_strip  # æ¨æ¸¬å†…å®¹

    @classmethod
    def xml_example(cls) -> str:
        return Guess(content="**thing/place/person**").to_pretty_xml()  # XMLå½¢å¼ã®ä¾‹


# Functions

def ask(base: rg.PendingChat, observation: Observation) -> str:  # è³ªå•ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    if observation.step == 0:
        # override first question until keyword bug is fixed.
        return "Are we playing 20 questions?"  # ã‚²ãƒ¼ãƒ ã®ç¢ºèªã‚’ã™ã‚‹è³ªå•
    
    chat = (
        base.fork(
            f"""\
            You are currently asking the next question.

            <game-history>
            {observation.get_history_as_xml()}
            </game-history>

            Based on the history above, ask the next most useful yes/no
            question and place it in the following format:
            {Question.xml_example()}

            - Your response should be a focused question which will gather the most information
            - Start general with your questions
            - Always try to bisect the remaining search space
            - Pay attention to previous questions and answers

            Before you begin, document your analysis of the game history if available,
            then write your question.
            """
        )
        .until_parsed_as(Question, attempt_recovery=True)
        .run()
    )
    return chat.last.parse(Question).content  # æœ€å¾Œã®è³ªå•å†…å®¹ã‚’è¿”ã™


def answer(base: rg.PendingChat, observation: Observation) -> t.Literal["yes", "no"]:  # å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    if not observation.keyword:  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæä¾›ã•ã‚Œã¦ã„ãªã„å ´åˆ
        print("Keyword wasn't provided to answerer", file=sys.stderr)  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦
        return "yes"  # ä»®ã«ã€Œã¯ã„ã€ã¨è¿”ã™ï¼ˆãƒã‚°ä¿®æ­£ã¾ã§ï¼‰
            
    last_question = observation.questions[-1]  # æœ€å¾Œã®è³ªå•ã‚’å–å¾—
    chat = (
        base.fork(
            f"""\
            The secret word for this game is "{observation.keyword}" [{observation.category}]

            You are currently answering a question about the word above.

            The next question is "{last_question}".

            Answer the yes/no question above and place it in the following format:
            {Answer.xml_example()}

            - Your response should be accurate given the keyword above
            - Always answer with "yes" or "no"

            What is the answer?
            """
        )
        .until_parsed_as(Answer, attempt_recovery=True)
        .run()
    )
    return chat.last.parse(Answer).content  # æœ€å¾Œã®å›ç­”å†…å®¹ã‚’è¿”ã™


def guess(base: rg.PendingChat, observation: Observation) -> str:  # æ¨æ¸¬ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    chat = (
        base.fork(
            f"""\
            You are currently making an informed guess of the keyword.

            <game-history>
            {observation.get_history_as_xml()}
            </game-history>

            Based on the history above, produce a single next best guess
            for the keyword and place it in the following format:
            {Guess.xml_example()}

            - Avoid repeat guesses based on the history above
            - The guess should be a specific person, place, or thing

            Before you begin, document your analysis of the game history if available,
            then write your guess.
            """
        )
        .until_parsed_as(Guess, attempt_recovery=True)
        .run()
    )
        
    return chat.last.parse(Guess).content  # æœ€å¾Œã®æ¨æ¸¬å†…å®¹ã‚’è¿”ã™

# vLLM and Generator

vllm = util.run_and_wait_for_port([
    "python", "-m",
    "vllm.entrypoints.openai.api_server",
    "--enforce-eager",
    "--model", str(g_model_path),  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
    "--port", str(g_vllm_port),  # ãƒãƒ¼ãƒˆç•ªå·ã‚’æŒ‡å®š
    "--served-model-name", g_vllm_model_name  # ã‚µãƒ¼ãƒ–ã™ã‚‹ãƒ¢ãƒ‡ãƒ«åã‚’æŒ‡å®š
], g_vllm_port, {"PYTHONPATH": str(g_srvlib_path)})  # vLLMã‚’èµ·å‹•

print("vLLM Started")  # vLLMé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

generator = rg.get_generator(g_generator_id)  # ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å–å¾—

base =  generator.chat("""\
You are a talented player of the 20 questions game. You are accurate, focused, and
structured in your approach. You will create useful questions, make guesses, or answer
questions about a keyword.

""")  # ã‚²ãƒ¼ãƒ ã«é–¢ã™ã‚‹åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

# Entrypoint

def agent_fn(obs: t.Any, _: t.Any) -> str:  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
    observation = Observation(**obs.__dict__)  # è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’Observationã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    
    try:
        match observation.turnType:  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
            case "ask":
                return ask(base, observation)  # è³ªå•ã‚’ç”Ÿæˆ
            case "answer":
                return answer(base, observation)  # å›ç­”ã‚’ç”Ÿæˆ
            case "guess":
                return guess(base, observation)  # æ¨æ¸¬ã‚’ç”Ÿæˆ
            case _:
                raise ValueError("Unknown turn type")  # ä¸æ˜ãªã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
    except Exception as e:
        print(str(e), file=sys.stderr)  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        raise
```

---The following area is a Code cell (cell numver is 8)---
```python
!apt install pigz pv  # pigzãŠã‚ˆã³pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 9)---
```python
!tar --use-compress-program='pigz --fast' \
    -cf submission.tar.gz \
    --dereference \
    -C /kaggle/tmp model lib srvlib \
    -C /kaggle/working main.py util.py  # ãƒ¢ãƒ‡ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœ§ç¸®ã—ã¦tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 10)---
```python
!KAGGLE_USERNAME={KAGGLE_USERNAME} \
 KAGGLE_KEY={KAGGLE_KEY} \
 kaggle competitions submit -c llm-20-questions -f submission.tar.gz -m "Updates"  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡º
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## OminousDude
> 
> ã“ã‚“ã«ã¡ã¯ã€ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ãŸã®ã§ã™ãŒã€å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ŒAttributeError: 'coroutine' object has no attribute 'last'ã€ã¨ã„ã†ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ä»¥å‰ã«ç™ºç”Ÿã—ã¾ã—ãŸã‹ï¼Ÿ
> 
> 
> > ## Rob Mulla
> > 
> > [@max1mum](https://www.kaggle.com/max1mum) - ã“ã‚Œã¯ã€riggingã®æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã—ã¦ã„ãã¤ã‹ã®ç ´å£Šçš„å¤‰æ›´ã‚’åŠ ãˆãŸãŸã‚ã§ã™ã€‚
> > 
> > ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å›ºå®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã“ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚»ãƒ«ã‚’å¤‰æ›´ã™ã‚Œã°ã†ã¾ãã„ãã¯ãšã§ã™ã€‚
> > 
> > ```
> > # Dependencies (uv for speed)
> > !pip install uv==0.1.45
> > 
> > !uv pip install -U \
> >     --python $(which python) \
> >     --target /kaggle/tmp/lib \
> >     rigging==1.1.1 \
> >     kaggle
> > 
> > !uv pip install -U \
> >     --python $(which python) \
> >     --target /kaggle/tmp/srvlib \
> >     vllm==0.4.2
> > 
> > ```
> > 
> > 
> > 
> > > ## OminousDude
> > > 
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!!!
> > > 
> > > 
> > > 

---
```

** @@@ Jupyter Notebook numver 11, the number of votes :19 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ï¼ˆAgent Alphaï¼‰ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿ï¼ˆAgent Betaï¼‰ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®ä¸­ã§ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã«æŒ‘æˆ¦ã—ã¦ã„ã¾ã™ã€‚æœ€é©ãªæ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ã—ã¦ã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã®æ¯”è¼ƒã¨äºŒåˆ†æ¢ç´¢ã‚’ç”¨ã„ã¦ã€æœ€å¤§20å›ã®ã‚¿ãƒ¼ãƒ³å†…ã«è§£æ±ºã§ãã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ä»–ã®ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒæ­£ã—ãè³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ãŠã‚Šã€æ­£è¦è¡¨ç¾ã‚’ç”¨ã„ãŸãƒãƒƒãƒãƒ³ã‚°ã‚‚æ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡**: ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ç´¢ã—ã€äºŒåˆ†æ¢ç´¢ã‚’é€šã˜ã¦è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’å¾—ã¦ã„ãã¾ã™ã€‚è³ªå•ãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã«åŸºã¥ãå ´åˆã«ç‰¹å®šã®å½¢ã§å¿œç­”ã—ã€æ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦è³ªå•ã‚’è§£æã—ã¾ã™ã€‚
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿**: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦ã®å½¹å‰²ã‚’æœãŸã—ã€å¿…è¦ã«å¿œã˜ã¦ä»–ã®æ‰‹æ³•ã‚’å¿œç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: Pythonã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`random`, `re`ï¼‰ã¨Kaggle Environmentsãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`kaggle_environments`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ç’°å¢ƒã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ã¾ã™ã€‚

### ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ 
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•° (`agent_fn`)**: ãƒ¡ã‚¤ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ãŒæˆåŠŸã™ã‚‹ã¾ã§è©¦ã¿ã€ãã‚ŒãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã™è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚
- **ãƒ†ã‚¹ãƒˆç”¨æ§‹æˆ**: ç’°å¢ƒã®åˆæœŸãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã®æ§‹æˆ (`debug_config`) ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹åŠ¹æœçš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè£…ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãŠã‚Šã€ç‰¹å®šã®æ¢ç´¢æ‰‹æ³•ã‚’æ´»ç”¨ã—ã¦æˆæœã‚’å‡ºã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# æå‡ºæ™‚ã«å®Ÿè¡Œ
# %mkdir /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 2)---
```python
# %%writefile submission/main.py


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã¯ã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§ã®æ¯”è¼ƒã¨äºŒåˆ†æ¢ç´¢ã‚’ä½¿ç”¨ã€‚
# æœ€é©ãªæ¢ç´¢ã§ã€20å›ã®ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«å¿…ãšè§£æ±ºç­–ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆlog2(n_keywords)+1 ã®ä¸Šé™ï¼‰
# æ¡ä»¶ã¨ã—ã¦ã¯ï¼š
#   * è§£æ±ºã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã€ä»¥ä¸‹ã®ã™ã¹ã¦ã®å˜èªã®ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆ2^19é …ç›®ã‚’è¶…ãˆãªã„ï¼‰
#   * ä»–ã®ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã€ã™ãªã‚ã¡æ­£ã—ãè³ªå•ã«ç­”ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨
#
# è§£æ±ºã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒªã‚¹ãƒˆã«ãªã„å ´åˆã€ã‚¢ãƒ«ãƒ•ã‚¡æ¤œç´¢ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ä»–ã®æŠ€è¡“ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§çµæœãŒæœ‰ç”¨ã§ã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

# ã¾ãŸã€ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã›ãšã«å›ç­”è€…ã¨ã—ã¦å—å‹•çš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã—ã‹ã—ã€è³ªå•è€…ãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãªã—ã§ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ä½¿ã†ã“ã¨ã¯ã‚ã¾ã‚Šè€ƒãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚ã¨ã«ã‹ãã€å¿…è¦ãªã®ã¯ã€å›ç­”ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å‰ã«æ­£è¦è¡¨ç¾ãƒãƒƒãƒãƒ£ãƒ¼ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚å®Ÿè£…ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

# ã§ã¯ã€é ‘å¼µã£ã¦ãã ã•ã„ã€loh-maa


import random
import re

VERSION = 9

# ã‚²ãƒ¼ãƒ ã§æœŸå¾…ã•ã‚Œã‚‹ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã€‚è©•ä¾¡
# ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹å‰ã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
# è‡ªåˆ†ã®åˆ¤æ–­ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚ãƒªã‚¹ãƒˆãŒé•·ã„ã»ã©ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒè‰¯ããªã‚Šã¾ã™ãŒã€åæŸãŒé…ããªã‚Šã¾ã™ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯åæŸã‚ˆã‚Šã‚‚é‡è¦ã§ã‚ã‚‹ã¨è¨€ãˆã‚‹ã®ã§ã€æ¬ è½ã—ã¦ã„ã‚‹å˜èªãŒãªã„æ–¹ãŒå¤šãã®ä½™åˆ†ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹æ–¹ãŒã„ã„ã§ã™ã€‚
allwords = ['xxx', 'remember', 'roll out your own!', 'xxx', 'this list is just for testing', 'advertisement',
            'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx',
            'agave', 'air compressor', 'air conditioner', 'air filter', 'air vent', 'alarm system',
            'analogy', 'anemone', 'anesthesia', 'apple pie', 'aprons', 'aquarium', 'atmosphere', 'auditorium',
            'backrest', 'bacteria', 'baguette', 'balcony', 'bank', 'barber chair', 'barcode', 'bat', 'bath mat',
            'battery bank', 'beanbag', 'bed frame', 'bike', 'bike path', 'binoculars', 'bird cage', 'bird seed',
            'bleachers', 'blinds', 'board games', 'bobby pins', 'bollards', 'bonding agent', 'bookcase', 'bookends',
            'bottled water', 'bread knife', 'bread pudding', 'break room', 'brewery merchandise', 'briefcase',
            'brochure', 'broken glass', 'brownies', 'bug spray', 'bulb', 'bumper sticker', 'bunsen burner', 'butterfly',
            'cabinet', 'calculator', 'cantaloupe', 'car seat', 'card', 'cardboard box', 'cash register', 'cat bed',
            'cat carrier', 'cauliflower', 'ceiling fan', 'cereal', 'latte', 'champagne flute', 'chandelier',
            'cheesecake', 'chessboard', 'chew toy', 'chocolate cake', 'cinnamon roll', 'rags', 'coat rack',
            'coffee beans', 'coffee grinder', 'coffee grounds', 'coffee makers', 'comic book', 'contact lenses',
            'conveyor belt', 'cooling tower', 'coral reefs', 'cream cheese', 'crochet hook', 'croissant', 'cup holder',
            'cupcake', 'curling iron', 'curtains', 'cutlery', 'cutting board', 'dandelion', 'deciduous tree',
            'dental chair', 'desk chairs', 'desk lamp', 'desktop computer', 'diaper', 'dijon mustard', 'dining table',
            'dish rack', 'dish soap', 'disinfectant', 'diving board', 'dog bed', 'dog crate', 'dog shampoo', 'donuts',
            'drain hose', 'drapes', 'duct tape', 'duffle bags', 'dumbbells', 'dump truck', 'duvet', 'dvd', 'dvd player',
            'dynamite', 'ear protection', 'earl grey tea', 'earplug', 'earth', 'edamame', 'edible flowers',
            'electric scooter', 'electric toothbrush', 'electrical outlet', 'electrical panel', 'electrical tape',
            'elevator', 'elliptical trainers', 'emergency exit sign', 'emergency lights', 'energy drink', 'engravings',
            'escalators', 'eucalyptus', 'excavator', 'exercise mat', 'exhaust fan', 'exit sign', 'extension cord',
            'eye mask', 'face mask', 'facial toner', 'fanny pack', 'fertilizer', 'filing cabinet', 'finger food',
            'fire alarm', 'fire escape ladder', 'fire extinguisher', 'fireplace', 'first aid kit', 'fish tank',
            'fishing pier', 'fitness tracker', 'flashlight', 'floor jacks', 'floor mats', 'foam roller', 'fog machine',
            'food bowl', 'food warmers', 'fortune cookie', 'frappuccino', 'free weights', 'french toast',
            'fridge magnet', 'fried rice', 'fungi', 'furniture', 'furniture polish', 'fuse', 'gadget', 'garage door',
            'garbage bag', 'garbage can', 'garbage disposal', 'garbage truck', 'gas mask', 'generator', 'glass table',
            'glove box', 'glove', 'golf cart', 'gps', 'grain bin', 'granola', 'grape vine', 'grapefruit',
            'graphic novel', 'graphing calculator', 'gravity', 'green beans', 'greeting card', 'guard tower',
            'guitar string', 'gym mats', 'habanero pepper', 'hair clip', 'hair dryer', 'hair gel', 'hairbrush',
            'hairspray', 'hamster wheel', 'hamstring curl machine', 'hand dryer', 'hand sanitizer', 'handbag',
            'handrail', 'hard hat', 'hash browns', 'hay bale', 'hazelnut', 'hdmi cable', 'headlamp', 'headphones',
            'hearing aid', 'heart rate monitors', 'heating element', 'hibiscus', 'high chair', 'highlighter',
            'hiking boots', 'holly', 'honeybee', 'hot dog', 'hot water bottle', 'ice cream maker', 'ice cube tray',
            'ice water', 'iced coffee', 'icicle', 'incense', 'incubator', 'index card', 'inhaler', 'ink cartridge',
            'insulation', 'router', 'interstate', 'iris', 'iron', 'ironing board', 'iron bar', 'irrigation system',
            'iv', 'jewelry box', 'journal', 'joystick', 'jumper cables', 'kale smoothie', 'karaoke machine',
            'key chain', 'khaki pants', 'kiosk', 'kitchen cabinet', 'garbage disposal', 'kitchen table',
            'komodo dragon', 'lab coat', 'lanyard', 'laptop', 'laser beam', 'lathe', 'laundry basket', 'lawnmower',
            'lego', 'library card', 'light switch', 'lightbulb', 'lint roller', 'lint trap', 'litter scooper',
            'lottery ticket', 'luggage', 'magazine rack', 'mailbox', 'marshmallow', 'masks', 'matches', 'measuring cup',
            'measuring tape', 'medical records', 'medication dispenser', 'medication', 'medicine cabinet', 'menorah',
            'metal detector', 'mouse', 'microphone stand', 'microscope', 'microwave', 'milling machine', 'mini fridge',
            'mixing bowl', 'mobile phone', 'modem', 'motorcycle helmet', 'movie poster', 'muffin tin', 'muffin',
            'muffler', 'mural', 'mushroom', 'nachos', 'nail clipper', 'nail polish', 'nail polish remover', 'name tag',
            'nap mat', 'necklace', 'nightstand', 'notebook', 'nozzle', 'oak table', 'ocarina', 'oil filter', 'ointment',
            'olive oil', 'onyx', 'orange peel', 'orange tree', 'orange zest', 'outdoor furniture', 'oven door',
            'oven rack', 'owl', 'oxygen tank', 'pacifier', 'packing peanuts', 'pad', 'pajamas', 'pallet jack',
            'pamphlet', 'pants', 'paper towels', 'paperweights', 'paperwork', 'parachute', 'parallel bars', 'pea soup',
            'pencil sharpener', 'perfume', 'personal protective equipment', 'pesticide', 'phone charger', 'photo album',
            'piano', 'pickaxe', 'piping tips', 'placemat', 'planter box', 'plaque', 'plastic gloves', 'plastic wrap',
            'plate', 'play mat', 'playing cards', 'pliers', 'polyester', 'pool cleaner', 'popcorn', 'popcorn machine',
            'portable speaker', 'pot holder', 'potato', 'power drill', 'power lines', 'power strip', 'press box',
            'pressure gauge', 'projector', 'protein bar', 'protein shakes', 'pry bar', 'public address system',
            'pumpkin pie', 'punching bag', 'push pin', 'puzzle', 'pyramid', 'quesadilla', 'rabbit', 'raccoon',
            'radio scanner', 'radish', 'railroad tracks', 'raindrops', 'rat', 'red velvet cake', 'red wine',
            'refrigerator', 'rehearsal room', 'reindeer', 'relish', 'reptile', 'resin', 'respirator', 'restaurants',
            'rice pudding', 'rivet', 'robot arm', 'rolling pin', 'roots', 'rowing machines', 'rug', 'rv',
            'safety harness', 'salad dressing', 'satellite', 'sauna', 'scones', 'scoreboard', 'scrap metal',
            'scratching posts', 'screwdriver', 'security systems', 'seed packet', 'server rack', 'sewing kit',
            'shin guards', 'shipping label', 'shoe rack', 'shower caddy', 'shower mat', 'sieve', 'silicone',
            'silicone mat', 'silver ore', 'sippy cup', 'sketchbook', 'sleeping bag', 'smartphone', 'smartwatch',
            'smoke detector', 'snacks', 'soap dish', 'soap dispenser', 'soap suds', 'soda', 'sofa', 'solar panel',
            'soldering iron', 'sound system', 'soybeans', 'space probe', 'spatula', 'spice rack', 'spider web',
            'sportswear', 'spotlight', 'sprinkler', 'sprinkler system', 'squirrel', 'stadium', 'stage lights',
            'stain remover', 'stained glass window', 'stair stepper', 'staircase', 'stationary bike', 'steam room',
            'sticker', 'sticky notes', 'storage bin', 'stove', 'street sign', 'sugar packet', 'suitcase', 'sunglasses',
            'sunscreen', 'swimsuit', 'swing set', 'tablet', 'tank', 'tape dispenser', 'taser', 'tea leaf', 'telescope',
            'television', 'tennis ball', 'tennis court', 'throw blanket', 'ticket machine', 'ticket stub', 'tire iron',
            'tissue box', 'toaster oven', 'tofu', 'toilet', 'toiletries bag', 'tomato', 'tongue depressor', 'tool belt',
            'tool box', 'toothbrush', 'toothbrush holder', 'toothpaste', 'touchscreen', 'tow truck', 'towel',
            'tracksuit', 'tractor shed', 'tractor', 'train brake', 'train door', 'trash bag', 'trash can', 'tricycle',
            'truck', 'tulip', 'turkey', 'turn signal', 'turnstiles', 'tweezers', 'udon noodles', 'ultraviolet lamp',
            'umbrella stand', 'underground river', 'unleavened bread', 'urinal', 'usb drives', 'utility box',
            'utility cart', 'vacuum cleaner', 'vanilla extract', 'vanity mirror', 'vans', 'vase', 'vegetable',
            'vegetation', 'veggie burger', 'velvet rope', 'vending machine', 'ventilation system', 'video camera',
            'violin bow', 'violin strings', 'virus', 'volcano', 'voucher', 'vr headset', 'walking stick', 'wall art',
            'wall decorations', 'wall street', 'wardrobe', 'washing machine', 'water', 'water bottle', 'water buffalo',
            'water fountain', 'water heater', 'water tank', 'watering can', 'webcam', 'wheelchair ramp', 'whistle',
            'willow tree', 'windbreak', 'wine aerator', 'wine decanter', 'wine opener', 'wine rack', 'wine tasting kit',
            'wire rack', 'wireless speaker', 'wrench', 'wrist weights', 'wristband', 'yoga block', 'yoga mat', 'yogurt',
            'zinc', 'afghanistan', 'albania', 'algeria', 'andorra', 'angola', 'antigua and barbuda', 'argentina',
            'armenia', 'australia', 'austria', 'azerbaijan', 'bahrain', 'bangladesh', 'barbados', 'belarus', 'belgium',
            'belize', 'benin', 'bhutan', 'bolivia', 'bosnia and herzegovina', 'botswana', 'brazil', 'brunei',
            'bulgaria', 'burkina faso', 'burundi', 'cambodia', 'cameroon', 'canada', 'cape verde',
            'central african republic', 'chad', 'chile', 'china', 'colombia', 'comoros', 'congo', 'costa rica',
            'croatia', 'cuba', 'cyprus', 'czech republic', 'democratic republic of the congo', 'denmark', 'djibouti',
            'dominica', 'dominican republic', 'ecuador', 'egypt', 'el salvador', 'england', 'equatorial guinea',
            'eritrea', 'estonia', 'ethiopia', 'federated states of micronesia', 'finland', 'france', 'gabon', 'gambia',
            'georgia', 'germany', 'ghana', 'greece', 'grenada', 'guatemala', 'guinea', 'guinea bissau', 'guyana',
            'haiti', 'honduras', 'hungary', 'iceland', 'india', 'indonesia', 'iran', 'iraq', 'ireland', 'israel',
            'italy', 'jamaica', 'japan', 'jordan', 'kazakhstan', 'kenya', 'kiribati', 'kosovo', 'kuwait', 'kyrgyzstan',
            'laos', 'latvia', 'lebanon', 'lesotho', 'liberia', 'libya', 'liechtenstein', 'lithuania', 'luxembourg',
            'madagascar', 'malawi', 'malaysia', 'maldives', 'mali', 'malta', 'marshall islands', 'mauritania',
            'mauritius', 'mexico', 'moldova', 'monaco', 'mongolia', 'montenegro', 'morocco', 'mozambique', 'myanmar',
            'namibia', 'nauru', 'nepal', 'netherlands', 'new zealand', 'nicaragua', 'niger', 'nigeria', 'north korea',
            'norway', 'oman', 'pakistan', 'palau', 'palestine', 'panama', 'papua new guinea', 'paraguay', 'peru',
            'philippines', 'poland', 'portugal', 'qatar', 'romania', 'russia', 'rwanda', 'saint kitts and nevis',
            'saint lucia', 'saint vincent and the grenadines', 'samoa', 'san marino', 'sao tome and principe',
            'saudi arabia', 'senegal', 'serbia', 'seychelles', 'sierra leone', 'singapore', 'slovakia', 'slovenia',
            'solomon islands', 'somalia', 'south africa', 'south korea', 'spain', 'sudan', 'suriname', 'swaziland',
            'sweden', 'switzerland', 'syria', 'taiwan', 'tajikistan', 'tanzania', 'thailand', 'togo', 'tonga',
            'trinidad and tobago', 'tunisia', 'turkey', 'turkmenistan', 'tuvalu', 'uganda', 'ukraine',
            'united arab emirates', 'united kingdom', 'united states of america', 'uruguay', 'uzbekistan', 'vanuatu',
            'venezuela', 'vietnam', 'yemen', 'zambia', 'zimbabwe', 'amsterdam netherlands', 'anaheim california',
            'austin texas', 'auckland new zealand', 'asheville north carolina', 'ashgabat turkmenistan']


def agent_beta(obs, cfg):
    """ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§ã™ã€è‡ªåˆ†è‡ªèº«ã®ã‚‚ã®ã‚’å±•é–‹ã—ã¦ãã ã•ã„ï¼LLMã‚„å¥½ã¿ã®ä»£æ›¿ç‰©ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"""

    if obs.turnType == 'ask':
        # LLMã‚„ãã®ä»–ã‚’ãƒ—ãƒ¬ã‚¤
        if len(obs.questions) % 2:
            response = "ã‚¢ãƒ«ãƒ•ã‚¡ã¯å¤±æ•—ã—ã¾ã—ãŸã€è‰¯ã„ã“ã¨ã«ã‚‚ã†ä¸€ã¤ã®ã‚¨ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™..."
        else:
            response = "ç§ã¯ã‚ãªãŸã®å€‹äººçš„ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€ã‚ãªãŸã®å…±åŒãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã§ã™ï¼æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ"

    elif obs.turnType == 'answer':
        response = 'ã¯ã„'

    elif obs.turnType == 'guess':
        if len(obs.questions) % 2:
            # ã‚‚ã—ã‹ã—ãŸã‚‰...æ„›ã‚‰ã—ã„ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã§å¿œç­”ï¼Ÿ
            responses = ['ãƒãƒ¼ã‚¢ãƒ«ãƒ•ã‚¡ã€ãƒãƒ¼ãƒ•ã‚¡ãƒ³', 'ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚', 'ã‚¢ãƒ«ãƒ•ã‚¡ã¯äººç”Ÿã ',
                         'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®äºŒåˆ†æ¢ç´¢ãŒåŠ©ã‘ã¦ãã‚Œã‚‹', f'ã‚¯ãƒªãƒ¼ãƒŸãƒ¼ï¼†ãƒŸãƒ«ã‚­ãƒ¼ã€ã‚¢ãƒ«ãƒ•ã‚¡ {VERSION}',
                         'ã‚«ã‚°ãƒ«ã‚’å†ã³ç´ æ™´ã‚‰ã—ã']

            response = random.choice(responses)

        else:
            # LLMã‚„ãã®ä»–ã‚’ãƒ—ãƒ¬ã‚¤
            response = "ã‚ãªãŸã®å…±åŒãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã¯è¿‘ã¥ã„ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ï¼**ã‚¨ãƒƒãƒ•ã‚§ãƒ«ã‚¿ã‚ªãƒ«**"

    else:
        assert False

    return response


def answered_yes(obs, question):
    """è³ªå•ãŒå°‹ã­ã‚‰ã‚Œã€ç­”ãˆãŒã€Œã¯ã„ã€ã§ã‚ã£ãŸã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚"""
    try:
        ix = obs.questions.index(question)
        return obs.answers[ix] == 'yes'
    except (ValueError, IndexError):
        return False


class AgentAlpha:

    # äº’æ›æ€§ã®ãŸã‚ã«å›ºå®šã—ã¦ãŠã
    HANDSHAKE = 'ã“ã‚Œã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã§ã™ã‹ï¼Ÿ'

    # ã“ã‚ŒãŒæˆ‘ã€…ã®æ¤œç´¢ç©ºé–“ã§ã€å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã€é€£ç¶šãƒ†ã‚¹ãƒˆã®éš›ã«ã¯å†åˆæœŸåŒ–ãŒå¿…è¦ã§ã™
    keywords = sorted(allwords)

    @staticmethod
    def parse_alpha_question(question):
        # ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ã«å¿œç­”ã™ã‚‹ãŸã‚ã®æ­£è¦è¡¨ç¾ã€ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®4ã¤ã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’å«ã‚€ï¼š
        match = re.search(r'keyword.*(?:come before|precede) \"([^\"]+)\" .+ order\?$', question)
        if match:
            # ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ã«ãƒãƒƒãƒ
            testword = match.group(1)
            return testword
        else:
            return None

    @staticmethod
    def play(obs, cfg):

        if obs.turnType == 'ask':

            if len(obs.questions) == 0:
                # ã“ã‚Œã¯æœ€åˆã®è³ªå•ã«ãªã‚‹ã€‚
                return AgentAlpha.HANDSHAKE

            elif answered_yes(obs, AgentAlpha.HANDSHAKE) and AgentAlpha.keywords:
                # ãŸã 1ã¤ã®å›ºå®šè³ªå•ã‚’ä½¿ç”¨ã—ã¾ã™ã€ã‚‚ã¯ã‚„è³ªå•ã‚’å›ã™æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€
                # LLMã¯ã€ã„ãšã‚Œã®è³ªå•ã«ã‚‚ä¿¡é ¼æ€§ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                testword = AgentAlpha.keywords[len(AgentAlpha.keywords) // 2]
                # è³ªå•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å›ºå®šã—ã€ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ã®ã¿ã‚’ç½®æ›ã—ã¾ã™
                response = f'ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ï¼‰ãŒã€ã€Œ{testword}ã€ã‚ˆã‚Šã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«æ—©ã„ã§ã™ã‹ï¼Ÿ'

            else:
                # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå°½ãã¾ã—ãŸã€è§£æ±ºç­–ãŒå–ã‚‰ã‚Œã¦ã„ãªã„ã‹ã€å›ç­”è€…ãŒé–“é•ã£ãŸå›ç­”ã‚’ã—ãŸãŸã‚ã€
                # ä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦ã›ã‚‹ã‚ˆã†ã«Noneã‚’è¿”ã—ã¾ã™
                response = None

        elif obs.turnType == 'answer':

            # ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã®è³ªå•ãŒè¦‹ã‚‰ã‚ŒãŸå ´åˆã€ã¯ã„ã¨ç­”ãˆã¦ã€ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•è€…ãŒé€²è¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            # ãã†ã§ãªã‘ã‚Œã°ã€ä»–ã®æŠ€è¡“ã«é ¼ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚¢ãƒ«ãƒ•ã‚¡ã¯æœ€é©ãªãŸã‚ã€ä½¿ã†ã¹ãã§ã™ã€‚
            if AgentAlpha.HANDSHAKE == obs.questions[-1]:
                response = 'ã¯ã„'

            else:
                testword = AgentAlpha.parse_alpha_question(obs.questions[-1])
                if testword is not None:
                    response = 'ã¯ã„' if obs.keyword.lower() < testword else 'ã„ã„ãˆ'
                else:
                    # ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ã§ã¯ãªã„ã®ã§ã€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«é€²ã¿ã¾ã™
                    response = None

        elif obs.turnType == 'guess':

            # æœ€å¾Œã®è³ªå•ãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã§ã‚ã£ãŸå ´åˆã€ç‰¹åˆ¥ãªæ¨æ¸¬ã‚’ã—ã¾ã™
            if obs.questions[-1] == AgentAlpha.HANDSHAKE:
                # ã“ã‚Œã¯ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã™...
                if obs.answers[-1] == 'yes':
                    response = f"è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†.. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {VERSION}"
                else:
                    response = f'ç›®'

            else:
                # æœ€å¾Œã®è³ªå•ã¨å›ç­”ã«åŸºã¥ã„ã¦ç©ºé–“ã‚’äºŒåˆ†ã—ã¾ã™
                testword = AgentAlpha.parse_alpha_question(obs.questions[-1])
                if testword:
                    if obs.answers[-1] == 'yes':
                        AgentAlpha.keywords = [k for k in AgentAlpha.keywords if k < testword]
                    else:
                        AgentAlpha.keywords = [k for k in AgentAlpha.keywords if not k < testword]

                if AgentAlpha.keywords:
                    # å‰ã‹ã‚‰ãƒãƒƒãƒ—ã—ã¾ã™ãŒã€ã©ã®å´ã‹ã‚‰ãƒãƒƒãƒ—ã—ã¦ã‚‚ã‚ã¾ã‚Šé‡è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“
                    response = AgentAlpha.keywords.pop(0)

                else:
                    # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå°½ããŸå ´åˆã€ä»–ã®æ‰‹æ®µã‚’ä½¿ã„ã¾ã™
                    response = None
        else:
            assert False, f'äºˆæœŸã—ãªã„turnType: {obs.turnType}'

        return response


def agent_fn(obs, cfg):
    """ãƒ¡ã‚¤ãƒ³ãƒ•ãƒƒã‚¯ã€'agent_fn'ã¨ã„ã†åå‰ã‚’ä¿æŒã—ã€æå‡ºã®æœ€å¾Œã®é–¢æ•°ã«ã—ã¦ãã ã•ã„ã€‚"""

    try:
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã‚’æœ€åˆã«è©¦ã¿ã¾ã™ã€æ„å‘³ã®ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ã‚’ã™ã‚‹ã‹
        # ã§ããªã„å ´åˆã¯Noneã‚’è¿”ã—ã¾ã™
        response = AgentAlpha.play(obs, cfg)

        if response is None:
            # ä»–ã®æ–¹æ³•ã‚’è©¦ã™ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«
            response = agent_beta(obs, cfg)

    except Exception:
        import traceback
        traceback.print_exc()
        response = 'ã„ã„ãˆ'

    return response
```

---The following area is a Code cell (cell numver is 3)---
```python
%%time

# ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ã¿ã€æå‡ºæ™‚ã«ã¯ç„¡åŠ¹ã«ã™ã‚‹
# ï¼ˆã‚‚ã—ã€Œæå‡ºãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆï¼‰

import kaggle_environments


def agent_dummy(obs, cfg):
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"
    else:
        assert False
    return response

debug_config = {'episodeSteps': 61,  # åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã¨ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®3ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè³ªå•/å›ç­”/æ¨æ¸¬ï¼‰
                'actTimeout': 60,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯60
                'runTimeout': 1200,  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1200
                'agentTimeout': 3600}  # å»ƒæ­¢ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3600

env = kaggle_environments.make(environment="llm_20_questions", configuration=debug_config, debug=True)

# å˜èªãŒæ¬ å¦‚ã—ã¦ã„ã‚‹ã“ã¨ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
AgentAlpha.keywords = sorted(random.sample(allwords, 500))

game_output = env.run(agents=[agent_dummy, agent_dummy, agent_fn, agent_fn])

env.render(mode="ipython", width=1080, height=700)
# out = env.render(mode="ansi")
# print(out)
```

---The following area is a Code cell (cell numver is 4)---
```python
# æå‡ºã™ã‚‹éš›ã«æœ‰åŠ¹ã«ã—ã¾ã™.. pigzã®ä½¿ç”¨ã¯å¿…é ˆã§ã™ã‹ï¼Ÿ
# !apt install pigz pv
# !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## OminousDude
> 
> ã‚ãªãŸã‚„ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦å«Œæ‚ªæ„Ÿã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ç§ã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚ãã‚Œã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯ã»ã¼ã†ã¾ãæ©Ÿèƒ½ã—ãªã„ã‹ã‚‰ã§ã™ã€‚ãªãœãªã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç¨®é¡ã€ãã®ä»–ã™ã¹ã¦ãŒå¤‰ã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚å†åº¦ã€å«Œæ‚ªæ„Ÿã‚„ä½•ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚è‰¯ã„ã‚³ãƒ¼ãƒ‰ã¨ã‚¢ã‚¤ãƒ‡ã‚¢ã«ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒˆã—ã¾ã—ãŸï¼
> 
>
```

** @@@ Jupyter Notebook numver 12, the number of votes :19 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æƒ…å ±ã‚’JSONå½¢å¼ã‹ã‚‰æŠ½å‡ºã—ã€å‡¦ç†ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
- ã‚¸ã‚§ãƒãƒ¬ãƒ¼ãƒ†ã‚£ãƒ–AIã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè³ªå•è€…ã‚„å›ç­”è€…ï¼‰ãŒåŠ¹æœçš„ã«è³ªå•ã‚’è¡Œã†ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã£ã¦ã„ã¾ã™ã€‚
- JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã€ãã‚Œã‚‰ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦æ•´ç†ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `numpy`, `pandas`, `json`, `os`, `sys`ãªã©ã®ä¸€èˆ¬çš„ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**:
  - `json.loads`ã‚’ç”¨ã„ã¦ã€ç‰¹å®šã®JSONæ§‹é€ ï¼ˆKEYWORDS_JSONï¼‰ã‚’è§£æã—ã€Pythonã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆè¾æ›¸ï¼‰ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
  - `pd.json_normalize`ã‚’ä½¿ç”¨ã—ã¦ã€æŠ½å‡ºã—ãŸå›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨åˆ†æãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

### å…¨ä½“ã®æµã‚Œ
1. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºã€‚
2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‚
3. JSONå½¢å¼ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã€å›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®æƒ…å ±ã‚’ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«æ­£è¦åŒ–ã€‚
4. ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åˆ©ç”¨ã—ã¦åˆ†æã‚’é€²ã‚ã‚‹ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

### ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
ä»–ã®Kaggleãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚Šã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å†…å®¹ãŒè©•ä¾¡ã•ã‚Œã¦ã„ã¾ã™ã€‚ç‰¹ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã®æœ‰åŠ¹æ€§ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®æŒ™å‹•ã«é–¢ã™ã‚‹æ´å¯ŸãŒç§°è³›ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€ä¸€éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•ã‚‚å¯„ã›ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€å…¨ä½“ã¨ã—ã¦ã¯å¥½æ„çš„ãªåå¿œãŒç›®ç«‹ã¡ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ææ¡ˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åŠ¹ç‡çš„ã«å–ã‚Šæ‰±ã†ãŸã‚ã®é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¤ºã—ã¦ãŠã‚Šã€å°†æ¥çš„ãªåˆ†æã‚„ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«å‘ã‘ãŸåŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import numpy as np
import pandas as pd
import json
import os
import sys

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))
```

---The following area is a Code cell (cell numver is 2)---
```python
# keywords.pyã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
sys.path.append('../input/llm-20-questions/llm_20_questions/')
import keywords
```

---The following area is a Code cell (cell numver is 3)---
```python
# è¨­å®š
pd.set_option('display.max_rows', None) # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã™ã¹ã¦ã®è¡Œã‚’è¡¨ç¤ºã™ã‚‹
pd.set_option('display.max_colwidth', None) # ã‚ˆã‚Šé•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚‚å®Œå…¨ã«è¡¨ç¤ºã™ã‚‹ãŸã‚
```

---The following area is a Code cell (cell numver is 4)---
```python
# JSONã«å¤‰æ›ã™ã‚‹
my_json = json.loads(keywords.KEYWORDS_JSON) # KEYWORDS_JSONã‚’è§£æã—ã¦JSONã«å¤‰æ›ã™ã‚‹
```

---The following area is a Code cell (cell numver is 5)---
```python
# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡ºã™ã‚‹
json_country = my_json[0] # JSONã‹ã‚‰å›½ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹
json_city = my_json[1]    # JSONã‹ã‚‰éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹
json_landmark = my_json[2] # JSONã‹ã‚‰ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 6)---
```python
# å›½
df_country = pd.json_normalize(json_country['words']) # å›½ã®å˜èªã‚’æ­£è¦åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹
df_country
```

---The following area is a Code cell (cell numver is 7)---
```python
# éƒ½å¸‚
df_city = pd.json_normalize(json_city['words']) # éƒ½å¸‚ã®å˜èªã‚’æ­£è¦åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹
df_city
```

---The following area is a Code cell (cell numver is 8)---
```python
# ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
df_landmark = pd.json_normalize(json_landmark['words']) # ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®å˜èªã‚’æ­£è¦åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹
df_landmark
```

---The following area is a Code cell (cell numver is 9)---
```python
len(my_json) # my_jsonã®è¦ç´ æ•°ã‚’å–å¾—ã™ã‚‹
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## MarÃ­lia Prata
> 
> ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã„ã¤ã‚‚å­¦ã‚“ã§ã„ã¾ã™ã€‚ä»Šå›ã¯ã€Œimport keywordsã€ã§ã™ã­ï¼ˆKaggleã§èª­ã‚€ã®ã¯åˆã‚ã¦ã§ã™ï¼‰ã€‚
> 
> æœ€å¾Œã«ã€ã“ã‚Œã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ãªã®ã§ã€
> 
> æˆ‘ã€…ã¯ã“ã†å°‹ã­ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼šã€Œãã‚Œã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã™ã‹ï¼ŸğŸ˜‰  ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ã€Docxianï¼
> 
> 

---

> ## Matin Mahmoudi âœ¨
> 
> [@docxian](https://www.kaggle.com/docxian) ã‚ãªãŸã® LLM 20 Questions ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯éå¸¸ã«æƒ…å ±é‡ãŒè±Šå¯Œã§ã™ï¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡ºã¨åˆ†æã¯ç‰¹ã«å„ªã‚Œã¦ãŠã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®æŒ™å‹•ã«é–¢ã™ã‚‹æ˜ç¢ºãªæ´å¯Ÿã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã®ä½œæ¥­ã®ã»ã¨ã‚“ã©ã‚’ç¢ºèªã—ã¾ã—ãŸãŒã€ã™ã¹ã¦ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ã‚ãªãŸã®ä½œå“ã«æŠ•ç¥¨ã—ã¾ã—ãŸï¼
> 
> 

---

> ## NBCLASS007
> 
> ãªãœç§ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«KEYWORDS_JSONãŒãªã„ã®ã§ã™ã‹ï¼Ÿ
> 
> 

---
```

** @@@ Jupyter Notebook numver 13, the number of votes :17 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€ŒPhi-3ã€ã‚’ç”¨ã„ã¦ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå”åŠ›ã—ãªãŒã‚‰ã€ç‰¹å®šã®å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚

### å•é¡Œè¨­å®š
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã¨ã„ã†ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸæƒ…å ±ã«åŸºã¥ãåŠ¹ç‡çš„ã«æ¨æ¸¬ã‚’è¡Œã†AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã‚’é€šã˜ã¦æƒ…å ±ã‚’å¼•ãå‡ºã—ã€ãã®æƒ…å ±ã«åŸºã¥ã„ã¦æ­£ã—ã„ç­”ãˆã‚’å°ãå‡ºã•ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

### ä½¿ç”¨ã™ã‚‹æ‰‹æ³•ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `tqdm`, `pydantic`, `transformers`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä½œæ¥­ã‚’å®¹æ˜“ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚„ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ å®šç¾©ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
   
2. **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š**: Hugging Faceã®`transformers`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é€šã˜ã¦ã€ã€ŒPhi-3-mini-4k-instructã€ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆèƒ½åŠ›ã‚’æŒã¡ã€è³ªå•å¿œç­”ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã®æ“ä½œã«é©ã—ã¦ã„ã¾ã™ã€‚

3. **ãƒ‡ãƒ¼ã‚¿ç®¡ç†**: `pydantic`ã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã§ã€Kaggleã®è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã‚„è¨­å®šæƒ…å ±ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚

4. **LLMã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³**: è³ªå•ã¨å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹`ask`é–¢æ•°ã‚’å®šç¾©ã—ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ã‚Šã€ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å¾—ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ•´å‚™ã—ã¦ã„ã¾ã™ã€‚

5. **ãƒ—ãƒ¬ã‚¤é–¢æ•°**: ã‚²ãƒ¼ãƒ ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹`play`é–¢æ•°ã§ã¯ã€å—ã‘å–ã£ãŸè¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è³ªå•è€…ã¾ãŸã¯å›ç­”è€…ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€é©åˆ‡ãªå¿œç­”ã‚’å¾—ã‚‹ä»•çµ„ã¿ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã¾ã¨ã‚
ã“ã®Jupyter Notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®ãŸã‚ã«ã€ŒPhi-3ã€ãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®šã—ã€ãã‚Œã‚’åˆ©ç”¨ã—ãŸAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®æ‰‹é †ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¯ã€NLU (è‡ªç„¶è¨€èªç†è§£) ãŠã‚ˆã³ç”Ÿæˆçš„AIã®è¦ç´ ã‚’å–ã‚Šå…¥ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ã¤ã¤ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã®èƒ½åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€åœ§ç¸®ã—ã¦é€ä¿¡ã™ã‚‹æµã‚Œã§å®Œçµã—ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# Phi-3ã¨ã®20ã®è³ªå•

## æå‡ºãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```

---The following area is a Code cell (cell numver is 2)---
```python
pip install -U -t /kaggle/working/submission/lib tqdm pydantic transformers -qq
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
## Llama.cppã®è¨­å®šï¼ˆç¾æ™‚ç‚¹ã§ã¯æœªä½¿ç”¨ï¼‰
```

---The following area is a Code cell (cell numver is 4)---
```python
# !CMAKE_ARGS="-DLLAMA_CUBLAS=on" pip install -t /kaggle/working/submission/lib llama-cpp-python \
#   --extra-index-url https://abetlen.github.io/llama-cpp-python/whl/cu121
```

---The following area is a Code cell (cell numver is 5)---
```python
# mkdir -p /kaggle/working/submission/lib/phi3/
```

---The following area is a Code cell (cell numver is 6)---
```python
# !curl -L "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-fp16.gguf?download=true" > "/kaggle/working/submission/lib/phi3/model.gguf"
```

---The following area is a Code cell (cell numver is 7)---
```python
# import os, sys
# KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
# if os.path.exists(KAGGLE_AGENT_PATH):
#     sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
#     WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "lib/phi3/model.gguf")
# else:
#     sys.path.insert(0, "/kaggle/working/submission/lib")
#     WEIGHTS_PATH = "/kaggle/working/submission/lib/phi3/model.gguf"
```

---The following area is a Code cell (cell numver is 8)---
```python
%ls
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
## æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
```

---The following area is a Code cell (cell numver is 10)---
```python
%%writefile submission/main.py
from pydantic.dataclasses import dataclass
from transformers import AutoModelForCausalLM, AutoTokenizer, pipeline
from typing import Literal, List
import os, sys, json

KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    os.chdir(os.path.join(KAGGLE_AGENT_PATH, 'lib'))
    #WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "lib/phi3/model.gguf")
else:
    os.chdir("/kaggle/working/submission/lib")
    #WEIGHTS_PATH = "/kaggle/working/submission/lib/phi3/model.gguf"
    
print(f"ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}. \nã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«: {', '.join(os.listdir())}")

# ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

model = AutoModelForCausalLM.from_pretrained(
    "microsoft/Phi-3-mini-4k-instruct",  
    device_map="cuda", torch_dtype="auto", trust_remote_code=True,
    cache_dir="./huggingface"
    
)
tokenizer = AutoTokenizer.from_pretrained("microsoft/Phi-3-mini-4k-instruct", cache_dir="./huggingface")
hf_llm = pipeline("text-generation", model=model, tokenizer=tokenizer)

def ask(prompt: str, max_new_tokens=100) -> str:
    result = hf_llm(text_inputs=prompt, return_full_text=False, temperature=0.2, do_sample=False, max_new_tokens=max_new_tokens)
    return result[0]['generated_text']

assert ask("<|user|>\nHello!<|end|>\n<|assistant|>")

@dataclass
class KaggleObservation:
  remainingOverageTime: int | float
  step: int

  questions: list[str]
  answers: list[str]
  guesses: list[str]

  role: Literal["guesser", "answerer"]
  turnType: Literal["ask", "guess", "answer"]

  keyword: str
  category: str

@dataclass
class KaggleConfig:
  episodeSteps: int
  actTimeout: int | float
  runTimeout: int | float
  agentTimeout: int | float
  __raw_path__: str

# llm = Llama(
#   model_path=WEIGHTS_PATH,  # GGUFãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹
#   n_ctx=2048,  # ä½¿ç”¨ã™ã‚‹æœ€å¤§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é•· - é•·ã„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¯å¤šãã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å¿…è¦ã¨ã—ã¾ã™
#   n_threads=4, # ä½¿ç”¨ã™ã‚‹CPUã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•°ã€ã‚·ã‚¹ãƒ†ãƒ ã¨çµæœã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´
#   n_gpu_layers=35, # GPUã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å±¤ã®æ•°ã€GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯è¨­å®šã€‚åˆ©ç”¨ã§ããªã„å ´åˆã¯0ã«è¨­å®šã€‚
#   use_mlock=True, # RAMå†…ã®ãƒ¡ãƒ¢ãƒªã‚’ãƒ­ãƒƒã‚¯ã—ã€ãƒ‡ã‚£ã‚¹ã‚¯ã«ã‚¹ãƒ¯ãƒƒãƒ—ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã‹ã©ã†ã‹ã€‚ RAMã«åã¾ã‚‰ãªã„å¤§ããªãƒ¢ãƒ‡ãƒ«ã«æœ‰ç”¨ã€‚
#   use_mmap=False, #
# )

def get_context_prompt(observation: KaggleObservation) -> str:
  questions = observation.questions
  answers = observation.answers

  history_prompt = ""
  for index in range(len(max(questions, answers))):
    history_prompt += f"<|user|>\n{questions[index]}<|end|>\n" if index < len(questions) else ""
    history_prompt += f"<|assistant|>\n{answers[index]}<|end|>\n" if index < len(answers) else ""
  #history_prompt += "<|assistant|>\n"
  
  return history_prompt

def get_guesser_prompt(observation: KaggleObservation) -> str:
  prompt = f"<|user|>\n20ã®è³ªå•ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯{observation.role.title()}ã®å½¹å‰²ã‚’æœãŸã—ã¦ã„ã¾ã™ã€‚<|end|>\n"
  prompt += get_context_prompt(observation)

  if observation.turnType == "ask":
    prompt += f"<|user|>\nä¼‘æ†©ã—ã¦ã€ç§ãŒè€ƒãˆã¦ã„ã‚‹éƒ½å¸‚ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¤çŸ­ã„ã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’ä¸€ã¤èã„ã¦ãã ã•ã„ã€‚å‰ã®è³ªå•ã¯ä¸Šã«ãƒªã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚è³ªå•ã¯ä¸€æ–‡ã ã‘ã§ãŠé¡˜ã„ã—ã¾ã™ï¼ è³ªå•ã®ç†ç”±ã‚’è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚<|end|>\n"
  elif observation.turnType == "guess":
    prompt += f"<|user|>\nä¸Šã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€ç§ãŒè€ƒãˆã¦ã„ã‚‹éƒ½å¸‚ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚" 
    prompt += f"ã“ã‚Œã‚‰ã®éƒ½å¸‚ã‚’é™¤ã„ã¦: {', '.join(observation.guesses)}ã€‚"
    prompt += f"ååˆ†ãªæƒ…å ±ã‚’å…ƒã«ã€ä¸€è¨€ã§ç­”ãˆã¦ãã ã•ã„ï¼<|end|>\n"
  else:
    raise ValueError(f"ç„¡åŠ¹ãªturnType: {observation.turnType}\n\n{observation}")
  
  prompt += "<|assistant|>\n"

  return prompt

def get_answerer_prompt(observation: KaggleObservation) -> str:
  prompt = f"<|user|>\nã‚ãªãŸã¯{', '.join(observation.keyword.split(' '))}ã®éƒ½å¸‚ã«ç‰¹åŒ–ã—ãŸéå¸¸ã«çµŒé¨“è±Šå¯Œãªãƒ„ã‚¢ãƒ¼ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚\n"
  prompt += "ã“ã®éƒ½å¸‚ã«ã¤ã„ã¦ã®è³ªå•ã«ã¯ã€æ­£ç¢ºã«ç­”ãˆãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ãŒã€**ã¯ã„**ã¾ãŸã¯**ã„ã„ãˆ**ã®è¨€è‘‰ã ã‘ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚<|end|>\n"

  prompt += f"<|user|>{observation.questions[-1]}<|end|>\n"
  prompt += "<|assistant|>\n"
  return prompt


def play(obs, conf):
  print("è¦³å¯Ÿ: " + json.dumps(obs, indent=2, ensure_ascii=False))
  print("è¨­å®š: " + json.dumps(conf, indent=2, ensure_ascii=False))
  observation = KaggleObservation(**obs)
  config = KaggleConfig(**conf)
  if observation.role == "guesser":
    prompt = get_guesser_prompt(observation)
    result = ask(prompt, max_new_tokens=40).split("\n")[0].strip()#, stop=["<|end|>"], max_tokens=256, temperature=0.5, echo=False)
  elif observation.role == "answerer":
    prompt = get_answerer_prompt(observation)
    answer = ask(prompt, max_new_tokens=20)#, stop=["<|end|>"], max_tokens=20, temperature=0.5, echo=False)
    result = "no" if "no" in answer else "yes"
  else:
    raise ValueError(f"ç„¡åŠ¹ãªå½¹å‰²: {observation.role}\n\n{observation}")
  print(f"çµæœ: {result}")
  return result
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
## ç¢ºèªä¸­
```

---The following area is a Code cell (cell numver is 12)---
```python
from submission.main import *
```

---The following area is a Code cell (cell numver is 13)---
```python
assert play({
  'remainingOverageTime': 300, 
  'step': 0, 
  'questions': [], 
  'guesses': [], 
  'answers': [], 
  'role': 'guesser', 
  'turnType': 'ask', 
  'keyword': '', #ä¾‹: ãƒãƒ³ã‚³ã‚¯
  'category': '', #ä¾‹: éƒ½å¸‚
}, {
  'episodeSteps': 61, 
  'actTimeout': 60, 
  'runTimeout': 9600, 
  'agentTimeout': 3600, 
  '__raw_path__': '/kaggle_simulations/agent/main.py'
})
```

---The following area is a Code cell (cell numver is 14)---
```python
assert play({
  'remainingOverageTime': 300, 
  'step': 0, 
  'questions': ["ã‚ãªãŸãŒè€ƒãˆã¦ã„ã‚‹éƒ½å¸‚ã¯åŒ—ã‚¢ãƒ¡ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"], 
  'guesses': [], 
  'answers': [], 
  'role': 'answerer', 
  'turnType': 'answer', 
  'keyword': '', #ä¾‹: ãƒãƒ³ã‚³ã‚¯
  'category': '', #ä¾‹: éƒ½å¸‚
}, {
  'episodeSteps': 61, 
  'actTimeout': 60, 
  'runTimeout': 9600, 
  'agentTimeout': 3600, 
  '__raw_path__': '/kaggle_simulations/agent/main.py'
})
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
## tar.gzå½¢å¼ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¦æå‡ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 16)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 17)---
```python
%cd /kaggle/working/
```

---The following area is a Code cell (cell numver is 18)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 19)---
```python
print("æˆåŠŸã—ã¾ã—ãŸã€‚")
```

** @@@ Jupyter Notebook numver 14, the number of votes :16 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å…¬å¹³æ€§ã«ã¤ã„ã¦æ¤œè¨ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç«¶æŠ€ã®å…¬å¼èª¬æ˜ã«åŸºã¥ãã€è©•ä¾¡æ–¹æ³•ã‚„ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šã‚’ç†è§£ã—ã€ç‰¹ã«TrueSkillãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ç”¨ã„ãŸã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®ä»•çµ„ã¿ã‚’æ¢æ±‚ã—ã¾ã™ã€‚

### å•é¡Œã®å–ã‚Šçµ„ã¿
Notebookã§ã¯ã€æ¬¡ã®å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ï¼š
- LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹é€ ã¨ãã®å…¬å¹³æ€§ã«ã¤ã„ã¦ã®è©•ä¾¡
- ç«¶æŠ€ãŒå®Ÿéš›ã«ã©ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã€ã©ã®ã‚ˆã†ã«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒæ±ºã¾ã‚‹ã‹ã‚’å¾©å…ƒã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰
- æå‡ºç‰©ã®å‹ç‡ã‚„å¼•ãåˆ†ã‘ã®ç¢ºç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å› å­ã®åˆ†æ

### è§£æ±ºæ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
ã“ã®å•é¡Œã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”¨ã„ã‚‰ã‚Œã¦ã„ã¾ã™ï¼š

1. **TrueSkillãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - TrueSkillã‚’ç”¨ã„ã¦å¯¾æˆ¦ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‚å…·ä½“çš„ã«ã¯ã€`trueskill`ã¨ã„ã†Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚­ãƒ«ã‚’`Rating`ã‚¯ãƒ©ã‚¹ã§è¡¨ç¾ã—ã¾ã™ã€‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®`rate()`é–¢æ•°ã‚’ä½¿ç”¨ã€‚

2. **ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨åˆ†æ**:
   - Pandasã‚’åˆ©ç”¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€ã‚²ãƒ¼ãƒ çµæœã®è§£æã‚’è¡Œã„ã¾ã™ã€‚å¼•ãåˆ†ã‘ã®ç¢ºç‡ã‚„ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆåŠŸç‡ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

3. **ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹**:
   - `Competition`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚­ãƒ«ã‚’åŸºã«è©¦åˆã‚’è¡Œã†ç’°å¢ƒã‚’æ§‹ç¯‰ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã«ãŠã„ã¦ã€è¤‡æ•°ã®ç«¶æŠ€ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€çµæœã‚’è¦–è¦šåŒ–ã—ã¾ã™ã€‚

4. **å¯è¦–åŒ–**:
   - Matplotlibã‚’ä½¿ç”¨ã—ã¦ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å¾—ãŸçµæœã‚„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆã—ã€è¦–è¦šçš„ã«åˆ†æã‚’è¡Œã„ã¾ã™ã€‚

### çµè«–
Notebookã§ã¯ã€LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯ã€å¶ç„¶ãŒå¤šãå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã®çµæœãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¹ã‚­ãƒ«ã«åŸºã¥ããƒãƒƒãƒãƒ³ã‚°ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ãªã„ã“ã¨ãŒæŒ‡æ‘˜ã•ã‚Œã€ä½•ã‚‰ã‹ã®å½¢ã§å…¬å¹³æ€§ã‚’æãªã†è¦å› ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ãŒç¤ºå”†ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
[LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³](https://www.kaggle.com/competitions/llm-20-questions/overview)ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å…¬å¹³æ€§ã«ã¤ã„ã¦ã¯ã€è¨è«–ã®ä¸­ã§ä½•åº¦ã‚‚ç–‘å•ãŒå‘ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãã“ã§ã€ç§ã¯ãã®è©•ä¾¡ã‚’è¡Œã†ãŸã‚ã®ç°¡å˜ãªãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚æ•°å­¦ã®è©•ä¾¡ã¯è¡Œã‚ãšã€ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã£ã¦ã¿ã¾ã™ã€‚

# ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å…¬å¼èª¬æ˜

åŸ·ç­†æ™‚ç‚¹ï¼ˆ7æœˆ17æ—¥ï¼‰ã§ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®æ¦‚è¦ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š
> ### è©•ä¾¡
>
> å„ãƒãƒ¼ãƒ ã¯æ¯æ—¥ã€æœ€å¤§5ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒœãƒƒãƒˆï¼‰ã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã¾ã™ã€‚å„æå‡ºã¯ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ä¸Šã®åŒç­‰ã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æŒã¤ä»–ã®ãƒœãƒƒãƒˆã¨å¯¾æˆ¦ã™ã‚‹ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆã‚²ãƒ¼ãƒ ï¼‰ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚æ™‚é–“ãŒçµŒã¤ã«ã¤ã‚Œã¦ã€å‹åˆ©ã«ã‚ˆã£ã¦ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ä¸Šæ˜‡ã—ã€æ•—åŒ—ã«ã‚ˆã£ã¦ä½ä¸‹ã—ã€å¼•ãåˆ†ã‘ã«ã‚ˆã£ã¦å‡ä¸€åŒ–ã•ã‚Œã¾ã™ã€‚
> 
> ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯å”åŠ›çš„ãª2å¯¾2ã®å½¢å¼ã§é‹å–¶ã•ã‚Œã¾ã™ã€‚ã‚ãªãŸã®ãƒœãƒƒãƒˆã¯ã€åŒç­‰ã®ã‚¹ã‚­ãƒ«ã‚’æŒã¤ãƒœãƒƒãƒˆã¨ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒšã‚¢ã«ãªã‚Šã€åˆ¥ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒšã‚¢ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚å„ãƒšã‚¢ã§ã¯ã€ä¸€æ–¹ã®ãƒœãƒƒãƒˆãŒè³ªå•è€…ã¨ã—ã¦ã€ã‚‚ã†ä¸€æ–¹ãŒå›ç­”è€…ã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚ãƒšã‚¢ã¨ã—ã¦å‹ã£ãŸã‚Šè² ã‘ãŸã‚Šã™ã‚‹ãŸã‚ã€å”åŠ›ã™ã‚‹ã“ã¨ãŒå¥¨åŠ±ã•ã‚Œã¾ã™ï¼
> 
> æå‡ºã•ã‚ŒãŸã™ã¹ã¦ã®ãƒœãƒƒãƒˆã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³çµ‚äº†ã¾ã§ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ã—ç¶šã‘ã€æ–°ã—ã„ãƒœãƒƒãƒˆã¯ã‚ˆã‚Šé »ç¹ã«é¸ã°ã‚Œã¾ã™ã€‚3ã¤ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæå‡ºã«é”ã™ã‚‹ã¨ã€å¤ã„ãƒœãƒƒãƒˆã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã™ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã«ã¯æœ€é«˜å¾—ç‚¹ã®ãƒœãƒƒãƒˆã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ã™ã¹ã¦ã®æå‡ºã®é€²è¡ŒçŠ¶æ³ã¯ã€Œæå‡ºã€ãƒšãƒ¼ã‚¸ã§è¿½è·¡ã§ãã¾ã™ã€‚
> 
> å„æå‡ºç‰©ã«ã¯ã€ã‚¬ã‚¦ã‚¹åˆ†å¸ƒN(Î¼,Ïƒ2)ã§ãƒ¢ãƒ‡ãƒ«åŒ–ã•ã‚ŒãŸæ¨å®šã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒã‚ã‚Šã¾ã™ã€‚Î¼ã¯æ¨å®šã‚¹ã‚­ãƒ«ã‚’ã€Ïƒã¯ãã®æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ã—ã€æ™‚é–“ã¨å…±ã«æ¸›å°‘ã—ã¾ã™ã€‚
> 
> æå‡ºç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã¾ãšãã®æå‡ºç‰©ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã€æå‡ºç‰©ã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã€åŸå› ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€Î¼0=600ã§æå‡ºç‰©ã‚’åˆæœŸåŒ–ã—ã€ç¶™ç¶šçš„ãªè©•ä¾¡ã®ãŸã‚ã«ãƒ—ãƒ¼ãƒ«ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ã“ã®æ™‚ç‚¹ã§ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç·æ•°ãŒ3ã‚’è¶…ãˆã‚‹å ´åˆã€å¤ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã•ã‚Œã¾ã™ã€‚
> 
> ### ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
> 
> ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¨ã€ãã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã«å‚åŠ ã—ãŸã™ã¹ã¦ã®ãƒœãƒƒãƒˆã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¨å®šå€¤ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚ã‚ã‚‹ãƒœãƒƒãƒˆãƒšã‚¢ãŒå‹åˆ©ã—ãŸå ´åˆã€ãã®ãƒšã‚¢ã®Î¼ã¯å¢—åŠ ã—ã€å¯¾æˆ¦ç›¸æ‰‹ã®Î¼ã¯æ¸›å°‘ã—ã¾ã™ã€‚å¼•ãåˆ†ã‘ã®å ´åˆã¯ã€Î¼ã®å€¤ãŒå¹³å‡å€¤ã«è¿‘ã¥ãã‚ˆã†ã«èª¿æ•´ã•ã‚Œã¾ã™ã€‚æ›´æ–°ã®å¤§ãã•ã¯ã€ä»¥å‰ã®Î¼å€¤ã«åŸºã¥ãäºˆæƒ³çµæœã‹ã‚‰ã®åå·®åŠã³å„ãƒœãƒƒãƒˆã®ä¸ç¢ºå®Ÿæ€§Ïƒã«æ¯”ä¾‹ã—ã¾ã™ã€‚ã¾ãŸã€çµæœã«ã‚ˆã£ã¦å¾—ã‚‰ã‚ŒãŸæƒ…å ±é‡ã«å¿œã˜ã¦Ïƒã®é …ã‚‚æ¸›å°‘ã•ã›ã¾ã™ã€‚ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§ã®å‹åˆ©ã¾ãŸã¯æ•—åŒ—ã«ã‚ˆã‚‹ãƒœãƒƒãƒˆã®ã‚¹ã‚³ã‚¢ã¯ã€ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ›´æ–°ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚
> 
> ### æœ€çµ‚è©•ä¾¡
> 
> æå‡ºç· åˆ‡ã§ã‚ã‚‹2024å¹´8æœˆ13æ—¥ã®æ™‚ç‚¹ã§ã€æå‡ºç‰©ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚2024å¹´8æœˆ13æ—¥ã‹ã‚‰2024å¹´8æœˆ27æ—¥ã¾ã§ã¯ã€å…¬é–‹ã•ã‚Œã¦ã„ãªã„æ–°ã—ã„å˜èªã®ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ç¶šã‘ã¾ã™ã€‚ã“ã®æœŸé–“ä¸­ã¯ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãª3ã¤ã®æå‡ºç‰©ã®ã¿ãŒãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚ã“ã®æœŸé–“ã®çµ‚ã‚ã‚Šã«ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãŒç¢ºå®šã—ã¾ã™ã€‚

# TrueSkill

ç§ã¯ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦ã‚ã¾ã‚ŠçŸ¥è­˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç°¡å˜ãªæ¤œç´¢ã«ã‚ˆã‚Œã°ã€$\mu$ **ã¨** $\sigma$ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ã‚·ã‚¹ãƒ†ãƒ ã®å€™è£œã¨ã—ã¦ã¯ã€[Glickoãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ](https://en.wikipedia.org/wiki/Glicko_rating_system) ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã®çµè«–ã«è‡³ã£ãŸç†ç”±ã¯æ€ã„å‡ºã›ã¾ã›ã‚“ãŒï¼ˆãŠãã‚‰ããƒãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã«é–¢é€£ã—ã¦ã„ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿï¼‰ã€ã‚‚ã†ä¸€ã¤ã®å€™è£œã¯[TrueSkill](https://en.wikipedia.org/wiki/TrueSkill)ã§ã™ã€‚è©³ç´°ã«ã¯è§¦ã‚Œã¾ã›ã‚“ãŒã€èˆˆå‘³ãŒã‚ã‚Œã°Wikipediaã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ãƒ“ãƒ‡ã‚ªã‚²ãƒ¼ãƒ ã®ä¸–ç•Œã§éå¸¸ã«äººæ°—ã®ã‚ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®[TrueSkill 2](https://www.microsoft.com/en-us/research/uploads/prod/2018/03/trueskill2.pdf)ã‚‚ã‚ã‚Šã¾ã™ãŒã€æœ€åˆã®å°è±¡ã§ã¯ã€ãã®æ”¹å–„ç‚¹ã¯ç§ãŸã¡ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªå ´åˆã«ã¯é‡è¦ã§ã¯ãªã•ãã†ã§ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å¹¸ã„ã«ã‚‚ã€TrueSkillã‚’åˆ©ç”¨ã§ãã‚‹[Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://github.com/sublee/trueskill)ãŒ[Pypi](https://pypi.org/project/trueskill/)ã«å­˜åœ¨ã—ã¾ã™ã®ã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
!pip install trueskill
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯`Rating`ã‚¯ãƒ©ã‚¹ã§è¡¨ã•ã‚Œã€ã‚²ãƒ¼ãƒ ã¯`rate()`ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
from trueskill import Rating, rate
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
## ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã‚ˆã†

ã¾ãšã€$\mu=600$ ã®4äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 6)---
```python
player1 = Rating(mu=600)
player2 = Rating(mu=600)
player3 = Rating(mu=600)
player4 = Rating(mu=600)

teamA = [ player1, player2 ]
teamB = [ player3, player4 ]
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
ã•ã¦ã€å½¼ã‚‰ã«ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 8)---
```python
rate(
    [ teamA, teamB ],
    [ 0, 1 ]  # teamAã¯teamBã‚ˆã‚Šã‚‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä½ã„ãŸã‚ã€teamAãŒå‹åˆ©
)
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
`rate()`é–¢æ•°ã¯ã€ãƒãƒ¼ãƒ ã”ã¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿”ã—ã¾ã™ã€‚

## ç°¡æ˜“è¡¨ç¤ºé–¢æ•°

ã‚²ãƒ¼ãƒ ã®çµæœã‚’èª­ã¿å–ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’å®šç¾©ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ï¼š
```

---The following area is a Code cell (cell numver is 10)---
```python
from typing import Tuple

def play_game(
    teamA: Tuple[Rating, Rating],
    teamB: Tuple[Rating, Rating],
    outcome: Tuple[int, int]
):
    """
    2ã¤ã®ãƒãƒ¼ãƒ ã®é–“ã§ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å¤‰åŒ–ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    
    ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    --------
        teamA: Tuple[Rating, Rating]
            2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        teamB: Tuple[Rating, Rating]
            2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        outcome: Tuple[int, int]
            ã‚²ãƒ¼ãƒ å†…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆ0: æœ€åˆ, 1: 2ç•ªç›®ï¼‰
    """
    new_ratings = rate(
        [ teamA, teamB ],
        outcome
    )
    for old,new in zip(teamA, new_ratings[0]):
        delta = int(new.mu - old.mu)
        print(f"{old.mu:.0f} -> {new.mu:.0f} ({'+' if delta >=0 else ''}{delta})")
    print("vs")
    for old,new in zip(teamB, new_ratings[1]):
        delta = int(new.mu - old.mu)
        print(f"{old.mu:.0f} -> {new.mu:.0f} ({'+' if delta >=0 else ''}{delta})")
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
ãã‚Œã‚’ä»¥å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é©ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 12)---
```python
play_game(teamA, teamB, [0, 1])
```

---The following area is a Markdown cell (cell numver is 13)---
```markdown
## ã‚·ã‚°ãƒã‚’è¦‹ã¤ã‘ã‚‹

ã“ã“ã§ã€ã‚³ãƒ³ãºãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®$\sigma$å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã“ã¨ã¯æ˜ã‚‰ã‹ã¨ãªã‚Šã¾ã™ã€‚TrueSkillã®æ¨å¥¨å€¤ã¯$\sigma = \frac{\mu}{3}$ã§ã™ãŒã€ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å°‘ã—è©¦ã—ãŸçµæœã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®$\sigma$ã¯ã‚€ã—ã‚$\sigma = \frac{\mu}{2} = 300$ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

å®Ÿéš›ã«ã€å®Ÿéš›ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®çµæœã‚’å†ç¾ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ç§ã®æœ€åˆã®æå‡ºã®æœ€åˆã®å‹åˆ©ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

> [1ä½] gguillard 600 (+123) vs [1ä½] JavaZero 570 (+34) vs
>
> [3ä½] atom1231 577 (-72) vs [3ä½] KKY 464 (-44)

å°‘ã—è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ã€ç§ã®$\sigma$ãŒ300ã®åˆæœŸå€¤ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ãªã„ã ã‚ã†ã¨ä»®å®šã™ã‚‹ã¨ã€ä¸€è‡´ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çµ„ã¿åˆã‚ã›ã‚’è¦‹ã¤ã‘ã‚‹ã®ã¯ã™ãã«ç°¡å˜ã§ã—ãŸï¼š
```

---The following area is a Code cell (cell numver is 14)---
```python
play_game(
    [
        Rating(mu=600, sigma=295),
        Rating(mu=570, sigma=156)
    ],
    [
        Rating(mu=577, sigma=225),
        Rating(mu=464, sigma=176)
    ],
    [ 0, 1 ]  # 1ç•ªç›®ã®ãƒãƒ¼ãƒ ãŒå‹åˆ©
)
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
## å¼•ãåˆ†ã‘ã®ç¢ºç‡

ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯TrueSkillã®$\mu=600$ã¨$\sigma=300$ã§ã™ã‹ï¼Ÿ ã•ã¦ã€å®Ÿéš›ã«ã¯ãã†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã®è¨­å®šã¯å¼•ãåˆ†ã‘ã®å ´åˆã«ã¯ã‚ã¾ã‚Šã†ã¾ãæ©Ÿèƒ½ã›ãšã€å¤‰å‹•ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§è¦³å¯Ÿã•ã‚Œã‚‹ã‚ˆã‚Šã‚‚å¤§ããï¼ˆå…¸å‹çš„ã«ã¯0ã‹ã‚‰Â±æ•°ãƒ¦ãƒ‹ãƒƒãƒˆï¼‰ãªã‚Šã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 16)---
```python
play_game(
    [
        Rating(mu=600, sigma=295),
        Rating(mu=570, sigma=156)
    ],
    [
        Rating(mu=577, sigma=225),
        Rating(mu=464, sigma=176)
    ],
    [ 1, 1 ]  # å‹è€…ãªã—
)
```

---The following area is a Markdown cell (cell numver is 17)---
```markdown
ãƒ«ãƒ¼ãƒ«ã‚’å†åº¦èª­ã¿è¿”ã™ã¨ã€ã“ã“ãŒé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã™ï¼š

> ç§ãŸã¡ã¯ã€çµæœã«ã‚ˆã£ã¦å¾—ã‚‰ã‚ŒãŸæƒ…å ±é‡ã«å¿œã˜ã¦ã€Ïƒã®é …ã‚‚æ¸›å°‘ã•ã›ã¾ã™ã€‚

æœ€åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã„ã˜ã£ã¦ã„ã¦ã€å¼•ãåˆ†ã‘ã®å ´åˆã«ÏƒãŒ100ã®ä¿‚æ•°ã§æ‰‹å‹•ã§æ¸›å°‘ã•ã‚Œã‚‹ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€ã“ã‚Œã¯ã‹ãªã‚Šã†ã¾ãæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã§ã™ã€‚ãã®å¾Œã€`help(trueskill)`ã‚’èª­ã‚€ã¨ã€ã“ã‚Œã¯ã™ã§ã«TrueSkillå†…ã§è€ƒæ…®ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€Î¼ã¨Ïƒã®æ›´æ–°ã‚’æ‹…å½“ã™ã‚‹Vã¨Wé–¢æ•°ã«ã¯ã€Œå‹åˆ©ã€**ãŠã‚ˆã³**ã€Œå¼•ãåˆ†ã‘ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

å®Ÿéš›ã«ã¯ã€`draw_probability`ã‚’å«ã‚€ã„ãã¤ã‹ã®è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦TrueSkillç’°å¢ƒã‚’å®šç¾©ã§ãã¾ã™ã€‚ã“ã‚Œã¯èˆˆå‘³æ·±ã„ç‚¹ã§ã‚ã‚Šã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã®ã‚²ãƒ¼ãƒ ã®å¼•ãåˆ†ã‘ã®ç¢ºç‡ã¯â€¦ *ã‹ãªã‚Šé«˜ã„* ã“ã¨ã‚’ç§ãŸã¡å…¨å“¡ãŒçŸ¥ã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’è¨ˆç®—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ãã®ãŸã‚ã«ã¯@waechterã®[LLM 20 Questions - Games dataset](https://www.kaggle.com/code/waechter/llm-20-questions-games-dataset)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 18)---
```python
import pandas as pd
from ast import literal_eval

games_df = pd.read_csv(
    "/kaggle/input/llm-20-questions-games-dataset/LLM-20Questions-games.csv",
    converters = {
        col_list: literal_eval
        for col_list in ["answers", "questions", "guesses"]
    }
)
games_df = games_df[games_df["guesser_SubmissionId"]!=0]  # ãã®æ—¥ã®æå‡ºç‰©ãŒã¾ã ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™
games_df["CreateTime"] = pd.to_datetime(games_df["CreateTime"], format="%m/%d/%Y %H:%M:%S")
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã¯å„ã‚²ãƒ¼ãƒ ã«ã¤ã„ã¦2è¡ŒãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ä¸€ã¤ã¯ãã‚Œãã‚Œã®ãƒãƒ¼ãƒ ã®è¡Œã§ã‚ã‚Šã€`guessed`ã¨ã„ã†ãƒ–ãƒ¼ãƒ«å€¤ã®åˆ—ã‚’æŒã£ã¦ã„ã¾ã™ã€‚å¼•ãåˆ†ã‘ã®å ´åˆã€ `guessed` ã¯ä¸¡ãƒãƒ¼ãƒ åŒã˜ã§ã™ï¼ˆãŸã ã—ã€ä¸¡ãƒãƒ¼ãƒ ãŒåŒã˜ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹ã£ãŸ3ã‚²ãƒ¼ãƒ ã¯ç„¡è¦–ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚
```

---The following area is a Code cell (cell numver is 20)---
```python
games_df.groupby("game_num")["guessed"].sum().value_counts()
```

---The following area is a Code cell (cell numver is 21)---
```python
(144607 + 3) / (144607 + 1208 + 3)
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
ã—ãŸãŒã£ã¦ã€å¼•ãåˆ†ã‘ã®ç¢ºç‡ã¯ $p \simeq 0.9917$ ã§ã™ã€‚ç¢ºã‹ã«ã‹ãªã‚Šé«˜ã„ã§ã™â€¦ã€‚å¾Œã§ã€ã‚ˆã‚Šæ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãƒã‚¿ãƒãƒ¬ï¼šæ‚ªåŒ–ã™ã‚‹ã ã‘ã§ã™ï¼‰ã€‚

## ãƒ™ãƒ¼ã‚¿ã¨ã‚¿ã‚¦

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€èˆˆå‘³æ·±ã„ä»–ã®2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚è¨€åŠã•ã‚Œã¦ã„ã¾ã™ï¼š

>  :param beta: å‹åˆ©ã®ç´„76ï¼…ã®ç¢ºç‡ã‚’ä¿è¨¼ã™ã‚‹è·é›¢ã€‚
>               æ¨å¥¨å€¤ã¯`sigma`ã®åŠåˆ†ã§ã™ã€‚
>
>  :param tau: ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å›ºå®šåŒ–ã‚’åˆ¶é™ã™ã‚‹ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã€‚
>              æ¨å¥¨å€¤ã¯`sigma`ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§ã™ã€‚

æ¨å¥¨å€¤ã§ã‚ã‚‹$\beta = \frac{\sigma}{2} = 150$ãŠã‚ˆã³$\tau = \frac{\sigma}{100} = 3$ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

ã•ã¦ã€æ–°ã—ã„TrueSkillç’°å¢ƒã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 23)---
```python
from trueskill import setup

setup(
    mu = 600,
    sigma = 300,
    beta = 150,
    tau = 3,
    draw_probability = 0.9917
)
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
å†åº¦ã€é©åˆ‡ãª$\sigma$ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®èª¿æ•´ãŒå¿…è¦ã§ã™ï¼š
```

---The following area is a Code cell (cell numver is 25)---
```python
play_game(
    [
        Rating(mu=600, sigma=144),
        Rating(mu=570, sigma=76)
    ],
    [
        Rating(mu=577, sigma=109),
        Rating(mu=464, sigma=85)
    ],
    [ 0, 1 ]  # æœ€åˆã®ãƒãƒ¼ãƒ ãŒå‹åˆ©
)
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
ã—ã‹ã—ã€å¼•ãåˆ†ã‘ã®å¾Œã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ›´æ–°ã¯ã€å®Ÿéš›ã«ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§è¦³å¯Ÿã•ã‚Œã‚‹ã‚‚ã®ã¨ä¸€è‡´ã—ã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 27)---
```python
play_game(
    [
        Rating(mu=600, sigma=144),
        Rating(mu=570, sigma=76)
    ],
    [
        Rating(mu=577, sigma=109),
        Rating(mu=464, sigma=85)
    ],
    [ 1, 1 ]  # å‹è€…ãªã—
)
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
ã“ã‚Œã§ã€ç§ãŸã¡ã¯LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«éå¸¸ã«ä¼¼ãŸã‚‚ã®ã‚’æ§‹ç¯‰ã§ããŸã‚ˆã†ã§ã™ã€‚ãŠãã‚‰ãã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯æ­£ç¢ºã«ãã®å€¤ã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã—ã€å¼•ãåˆ†ã‘ã®ç¢ºç‡ã‚‚æ•°å›ã®ã‚²ãƒ¼ãƒ å¾Œã«ã—ã‹å°ãå‡ºã›ã¾ã›ã‚“ï¼ˆãŠãã‚‰ãç¶™ç¶šçš„ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€é–¢æ•°ã‚‚å—ã‘ä»˜ã‘ã¾ã™ã®ã§ï¼‰ã€ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®è¨­å®šãŒã‚²ãƒ¼ãƒ ã®çµæœã‚’å†ç¾ã™ã‚‹èƒ½åŠ›ã¯å¶ç„¶ã¨ã¯æ€ãˆã¾ã›ã‚“ã€‚

# ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ¢ãƒ‡ãƒ«åŒ–

## å‹åˆ©ã®ç¢ºç‡

ãã‚Œã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«çµ„ã‚“ã§ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã¿ã‚‹ã®ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ :D

åˆã‚ã«ã€*LLM 20 Questions - Games dataset*ã‚’ä½¿ç”¨ã—ã¦ã€å„æå‡ºç‰©ã«ã¤ã„ã¦ã€Œnb_guessed / nb_playedã€æ¯”ç‡ã‚’è¨ˆç®—ã—ã¦å®Ÿéš›çš„ãªå‹åˆ©ç¢ºç‡ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚

ãŸã ã—ã€ã¾ãšã¯å°‘ãªã„ã‚²ãƒ¼ãƒ æ•°ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹æå‡ºç‰©ï¼ˆä¾‹ãˆã°10ä»¥ä¸‹ï¼‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 29)---
```python
nb_games_played = games_df.groupby("guesser_SubmissionId").size()
nb_games_played = nb_games_played[nb_games_played>=10]
```

---The following area is a Code cell (cell numver is 30)---
```python
games_df = games_df[games_df["guesser_SubmissionId"].isin(nb_games_played.index)]
```

---The following area is a Markdown cell (cell numver is 31)---
```markdown
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯1äººã‚ãŸã‚Šæœ€å¤§3ã®æå‡ºã—ã‹è¨±å¯ã•ã‚Œãªã„ãŸã‚ã€æœ€å¾Œã®3ã¤ã‚’æ®‹ã—ã¦ä»–ã®ãƒœãƒƒãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã€€ä¸€éƒ¨ã®äººã¯100ä»¥ä¸Šã®æå‡ºç‰©ã‚’æŒã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼
```

---The following area is a Code cell (cell numver is 32)---
```python
games_df.groupby("guesser")["guesser_SubmissionId"].nunique().sort_values(ascending=False).head()
```

---The following area is a Code cell (cell numver is 33)---
```python
last_bots = games_df.sort_values(
    by = "CreateTime"  # ã€Œguesserã€ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨ã€ä¸€éƒ¨ã®æå‡ºç‰©ã«è¤‡æ•°ã®åå‰ãŒä»˜ã„ã¦ã„ã‚‹ãŸã‚ã“ã“ã§ã¯ã‚½ãƒ¼ãƒˆã—ã¾ã›ã‚“
).drop_duplicates(
    subset = "guesser_SubmissionId",
    keep = "last"
).groupby(
    [ "guesser" ]
)[[
    "guesser",
    "guesser_SubmissionId",
    "CreateTime"
]].tail(3).sort_values(
    by = "guesser"
)["guesser_SubmissionId"].values
```

---The following area is a Code cell (cell numver is 34)---
```python
last_games_df = games_df[games_df["guesser_SubmissionId"].isin(last_bots)]
```

---The following area is a Markdown cell (cell numver is 35)---
```markdown
å¼•ãåˆ†ã‘ã®ç¢ºç‡ã‚’æ›´æ–°ã™ã‚‹æ™‚ãŒæ¥ã¾ã—ãŸï¼š
```

---The following area is a Code cell (cell numver is 36)---
```python
last_games_df.groupby("game_num")["guessed"].sum().value_counts()
```

---The following area is a Code cell (cell numver is 37)---
```python
(123874 + 1) / (123874 + 546 + 1)
```

---The following area is a Markdown cell (cell numver is 38)---
```markdown
å…ˆã»ã©è¿°ã¹ãŸã‚ˆã†ã«ã€å¼•ãåˆ†ã‘ã®ç¢ºç‡ã¯ $p \simeq 0.9956$ ã¨ã•ã‚‰ã«æ‚ªåŒ–ã—ã¾ã—ãŸâ€¦

å®Ÿéš›ã®ã‚¹ã‚­ãƒ«åˆ†å¸ƒã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«ã¯ã€ã€Œè‰¯ã„ãƒœãƒƒãƒˆã€ã¨ã€Œãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã€ã‚’åŒºåˆ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 39)---
```python
goodbots = set(
    last_games_df[
        last_games_df.groupby("guesser_SubmissionId")["guessed"].transform("any")
    ]["guesser_SubmissionId"].unique()
)
```

---The following area is a Code cell (cell numver is 40)---
```python
badbots = set(last_games_df["guesser_SubmissionId"].unique()) - goodbots
```

---The following area is a Code cell (cell numver is 41)---
```python
len(goodbots), len(badbots)
```

---The following area is a Markdown cell (cell numver is 42)---
```markdown
æ¬¡ã«ã€ã™ã¹ã¦ã®è‰¯ã„ãƒœãƒƒãƒˆã®ãƒãƒ¼ãƒ ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ç›¸æ‰‹ãŒãƒ€ãƒŸãƒ¼ã®å ´åˆã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€ä¿¡é ¼ã§ãã‚‹ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒå˜èªã‚’è¦‹ã¤ã‘ã¦ãã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚ã¾ãŸã€ç›¸æ‰‹ãŒè¦‹ã¤ã‘ã‚‹å‰ã«ãƒãƒ¼ãƒ ãŒå˜èªã‚’è¦‹ã¤ã‘ã‚‹æ™‚é–“ãŒãªã‹ã£ãŸãŸã‚ã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡è¦–ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é€†ã«ã€ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒå‹ã¤æ©Ÿä¼šãŒãªã‹ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€è‰¯ã„ãƒœãƒƒãƒˆã¨æ‚ªã„ãƒœãƒƒãƒˆã®ãƒãƒ¼ãƒ ã§ã‚‚ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ãŸå ´åˆã¯è¨˜éŒ²ã«æ®‹ã—ã¾ã™ã€‚ã¡ãªã¿ã«ã€ã“ã‚Œã‚‰ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€çµ±è¨ˆãŒå¤§å¹…ã«æ¸›å°‘ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 43)---
```python
fair_games = last_games_df["guesser_SubmissionId"].isin(goodbots) * (
    last_games_df["answerer_SubmissionId"].isin(goodbots) + last_games_df["guessed"]
)
fair_games_df = last_games_df.loc[fair_games]
fair_games_df = fair_games_df[(fair_games_df["guessed"]) | (fair_games_df["nb_round"]==20)]
```

---The following area is a Code cell (cell numver is 44)---
```python
skills_df = fair_games_df.groupby("guesser_SubmissionId").agg(
    guessed = ("guessed", "sum"),
    played = ("guessed", "size")
).sort_index()
skills_df["skill"] = skills_df["guessed"] / skills_df["played"]
skills_df.sort_values(by = "skill", ascending = False, inplace = True)
skills_df.head()
```

---The following area is a Markdown cell (cell numver is 45)---
```markdown
ä¸æ­£ç¢ºãªç¢ºç‡ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€$N = 10$ ã®å…¬æ­£ã‚²ãƒ¼ãƒ ã‚’æŒãŸãªã„ãƒœãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ã‚‡ã†ã€‚ã™ã§ã«å…¨ã‚²ãƒ¼ãƒ ã«å¯¾ã—ã¦è¡Œã„ã¾ã—ãŸãŒã€å…¬æ­£ã‚²ãƒ¼ãƒ ã«å¯¾ã—ã¦ã‚‚è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 46)---
```python
skills_df = skills_df[skills_df["played"]>=10]
skills_df.head()
```

---The following area is a Markdown cell (cell numver is 47)---
```markdown
æœ€å¾Œã«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ç¢ºç‡ãŒ98%ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ¥ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã‚¹ã‚­ãƒ«ã®ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ã‚’æ‹¡å¤§ã—ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã¯éå¸¸ã«æ¥½è¦³çš„ã§ã™ãŒã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®çµ‚ã‚ã‚Šã«å‘ã‘ã¦ã€ã‚ˆã‚Šå„ªã‚ŒãŸãƒœãƒƒãƒˆãŒé€²åŒ–ã™ã‚‹æ§˜å­ã‚’ç¤ºã™ã¨ã‚‚è¨€ãˆã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 48)---
```python
BEST_SKILL = .98
skills_df["skill"] *= BEST_SKILL / skills_df["skill"].iloc[0]
```

---The following area is a Markdown cell (cell numver is 49)---
```markdown
ã“ã‚Œã§ã€ç¾åœ¨ã®ï¼ˆæ­£å½“ãªï¼‰ãƒœãƒƒãƒˆã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¹ã‚­ãƒ«åˆ†å¸ƒã®ã‚ã‚‹ç¨‹åº¦ç¾å®Ÿçš„ãªè¡¨ç¾ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 50)---
```python
import matplotlib.pyplot as plt
```

---The following area is a Code cell (cell numver is 51)---
```python
plt.figure(figsize=(12,6))
_ = plt.hist(skills_df["skill"], bins=15)
_ = plt.xlabel("å…¬æ­£ãªãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã«å¯¾ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹ã®ç¢ºç‡")
_ = plt.ylabel("ãƒœãƒƒãƒˆã®æ•°")
_ = plt.title("è‰¯ã„ãƒœãƒƒãƒˆã®ã‚¹ã‚­ãƒ«åˆ†å¸ƒ")
```

---The following area is a Markdown cell (cell numver is 52)---
```markdown
ã“ã‚Œã«ã‚ˆã‚Šã€æ˜ç¢ºãªãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå¾—ã‚‰ã‚Œã‚‹ã¯ãšã§ã™ï¼

## ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹

æ¬¡ã«ã€ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´ã‚’è¿½è·¡ã§ãã‚‹Playerã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 53)---
```python
from typing import Optional
from trueskill import TrueSkill

class Player:
    def __init__(
        self,
        skill: float,
        env: Optional[TrueSkill] = None  # ä»Šã¯ç„¡è¦–ã—ã¾ã™ãŒã€å¾Œã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™
    ):
        self.skill = skill
        self.rating = Rating() if env is None else env.Rating()  # ç’°å¢ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆã¤ã¾ã‚Š600,300ï¼‰ã§é–‹å§‹
        self.history = []
        
    def update(self, new_rating):
        self.history.append(self.rating)
        self.rating = new_rating
```

---The following area is a Markdown cell (cell numver is 54)---
```markdown
## ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ—ãƒ¼ãƒ«

æ¬¡ã«ã€ç¾å®Ÿçš„ãªã‚¹ã‚­ãƒ«ã®ç¯„å›²ã‚’æŒã¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ—ãƒ¼ãƒ«ã‚’æ§‹ç¯‰ã—ã€ãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã®æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒ«è©•ä¾¡ã®ãŸã‚ã«è€ƒæ…®ã•ã‚Œã‚‹è‰¯ã„ãƒœãƒƒãƒˆã®æ•°ãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚ŒãŸãŸã‚ã€æ•°ã®æ¸›å°‘æ¯”ã‚’æ‚ªã„ãƒœãƒƒãƒˆã«ã‚‚é©ç”¨ã™ã‚‹ã®ãŒå¦¥å½“ã§ã—ã‚‡ã†ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã«ãã‚Œã»ã©å½±éŸ¿ã‚’ä¸ãˆãªã„ã¯ãšã§ã™ï¼ˆå®Ÿéš›ã«ã¯æ‚ªåŒ–ã•ã›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚éŠã‚“ã§ã¿ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 55)---
```python
reduction_ratio = len(skills_df) / len(goodbots)

players = { ii: Player(s) for ii,s in enumerate(skills_df["skill"].values) }
players.update({ len(players)+ii: Player(0) for ii in range(int(len(badbots)*reduction_ratio)) })

len(players)
```

---The following area is a Markdown cell (cell numver is 56)---
```markdown
å®Ÿéš›ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã«ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šã‚‚ã¾ã å¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã™ãŒã€ã“ã‚Œã¯ãƒœãƒƒãƒˆã®æ•°ã§ã™ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®ç«¶æŠ€è€…ã¯æœ€å¤§3ã¤ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæå‡ºç‰©ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚²ãƒ¼ãƒ é–¢æ•°

æœ€å¾Œã«ã€å‹åˆ©ã®ç¢ºç‡ã‚’è€ƒæ…®ã—ãŸã‚²ãƒ¼ãƒ é–¢æ•°ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 57)---
```python
import random
```

---The following area is a Code cell (cell numver is 58)---
```python
def play_match(
    teamA: Tuple[Player, Player],
    teamB: Tuple[Player, Player],
    env: Optional[TrueSkill] = None,
    debug: bool = False
):
    """
    2ãƒãƒ¼ãƒ é–“ã®è©¦åˆã‚’è¡Œã„ã¾ã™ã€‚
    
    ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    ------
        teamA: Tuple[Player, Player]
            2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        teamB: Tuple[Player, Player]
            ã‚‚ã†ä¸€ã¤ã®2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        debug: boolean
            ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ©ã‚°ã€‚
    """
    if debug:
        print("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚­ãƒ«ã€€:", [p.skill for p in teamA+teamB])
        print("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€€:", [tuple(p.rating for p in teamA), tuple(p.rating for p in teamB)])
    # å„ãƒãƒ¼ãƒ ã«ã¤ã„ã¦ã€ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã‹ã‚’åˆ¤å®šã—ã€ãƒœãƒƒãƒˆãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‘ã‚Œã°å¤±æ•—
    # ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒãƒ¼ãƒ ã®ç›®æ¨™ã‚¹ã‚­ãƒ«ãŒãƒ©ãƒ³ãƒ€ãƒ ãªæ•°ã‚ˆã‚Šã‚‚é«˜ã‘ã‚Œã°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹
    # ï¼ˆå½±ã«é€†ã®è«–ç†ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ï¼‰
    ranks = [
        1 if teamA[0].skill * teamA[1].skill == 0 or random.random() > teamA[0].skill else 0,
        1 if teamB[0].skill * teamB[1].skill == 0 or random.random() > teamB[0].skill else 0
    ]
    
    # æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã‚²ãƒ¼ãƒ ã®çµæœ
    rating_function = rate if env is None else env.rate
    new_ratings = rating_function(
        [
            [ p.rating for p in teamA ],
            [ p.rating for p in teamB ]
        ],
        ranks
    )
    
    # ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ›´æ–°
    for p,r in zip(teamA, new_ratings[0]):
        p.update(r)
    for p,r in zip(teamB, new_ratings[1]):
        p.update(r)
        
    if debug:
        print("ã‚²ãƒ¼ãƒ ã®çµæœã€€:", ranks)
        print("æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€€:", new_ratings)
    
    return
```

---The following area is a Markdown cell (cell numver is 59)---
```markdown
ã“ã‚Œã§ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã®ã«å¿…è¦ãªã™ã¹ã¦ãŒæƒã„ã¾ã—ãŸã€‚æœ€åˆã®ã‚²ãƒ¼ãƒ ã¯ã“ã¡ã‚‰ã§ã™ï¼š
```

---The following area is a Code cell (cell numver is 60)---
```python
play_match(
    [players[0], players[1]],
    [players[2], players[3]],
    debug = True
)
```

---The following area is a Markdown cell (cell numver is 61)---
```markdown
# ç‹¬è‡ªã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡ŒãŠã†

ä¾¿åˆ©ã•ã¨ç•°ãªã‚‹è¨­å®šã‚’ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ•°ã‚„ã‚¹ã‚­ãƒ«ã€ã‚²ãƒ¼ãƒ æ•°ã€TrueSkillã®è¨­å®šã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã§ãã‚‹ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å±¥æ­´ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æä¾›ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 62)---
```python
from typing import List
from tqdm import tqdm
```

---The following area is a Code cell (cell numver is 63)---
```python
class Competition:
    """
    TrueSkillã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç’°å¢ƒã‚’è¨­å®šã§ãã¾ã™ã€‚
    """
    
    def __init__(
        self,
        skill_dist: List[float],
        nb_dummy: int,
        mu: float = 600,
        sigma: float = 300,
        beta: float = 150,
        tau: float = 3,
        draw_probability: float = 0.9956,
        seed: float = 42
    ):
        """
        ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã€‚
        
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        ------
            skill_dist: List[float]
                å„ã€Œè‰¯ã„ã€æå‡ºã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹ã®ç¢ºç‡ã€‚
            nb_dummy: int
                ãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã®æ•°ã€‚
            mu: float
                TrueSkillã®muãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            sigma: float
                TrueSkillã®sigmaãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            beta: float
                TrueSkillã®betaãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            tau: float
                TrueSkillã®tauãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            draw_probability: float
                TrueSkillã®draw_probabilityãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            seed: float
                ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã€‚
        """
        # ç§ãŸã¡ã®ç«¶æŠ€ç’°å¢ƒ
        self._trueskill = TrueSkill(
            mu = mu,
            sigma = sigma,
            beta = beta,
            tau = tau,
            draw_probability = draw_probability
        )
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ—ãƒ¼ãƒ« â€” ãã‚ŒãŒPlayerã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ç’°å¢ƒã‚’è¿½åŠ ã™ã‚‹ç†ç”±
        self.players = { ii: Player(s, self._trueskill) for ii,s in enumerate(skill_dist) }
        self.players.update({ len(self.players)+ii: Player(0, self._trueskill) for ii in range(nb_dummy) })
        
        # ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰
        self._seed = seed
        random.seed(seed)
        
        
    def play_games(self, nb_games: int = 10000):
        """
        ã‚²ãƒ¼ãƒ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã™ã€‚
        
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        ------
            nb_games: int
                ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚²ãƒ¼ãƒ ã®æ•°ã€‚
        """
        
        for i in tqdm(range(nb_games)):
            player_ids = random.sample(range(len(self.players)), 4)  # ãƒ©ãƒ³ãƒ€ãƒ ã«4äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã³ã¾ã™
            try:
                play_match(
                    [
                        self.players[player_ids[0]],
                        self.players[player_ids[1]]
                    ],
                    [
                        self.players[player_ids[2]],
                        self.players[player_ids[3]]
                    ],
                    env = self._trueskill
                )
            except:
                continue
```

---The following area is a Markdown cell (cell numver is 64)---
```markdown
ã™ã§ã«ä½¿ç”¨ã—ãŸã‚¹ã‚­ãƒ«åˆ†å¸ƒã‚’å–å¾—ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 65)---
```python
skill_dist = skills_df["skill"].values
nb_dummy = len(players) - len(skill_dist)
```

---The following area is a Code cell (cell numver is 66)---
```python
# LLM20ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®šã«å¾“ã„ã¾ã™ãŒã€æ¯”è¼ƒã®ãŸã‚ã«ã„ãã¤ã‹ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
LLM20 = Competition(skill_dist, nb_dummy)
```

---The following area is a Code cell (cell numver is 67)---
```python
# Kaggleã®ã‚·ã‚¹ãƒ†ãƒ ã§ç´„1700ã‚²ãƒ¼ãƒ ï¼ç§’ã‚’æœŸå¾…ã—ã¦ãã ã•ã„
# å±¥æ­´ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œãšã€ã‚²ãƒ¼ãƒ ã¯ä»¥å‰ã®ã‚‚ã®ã«åŠ ç®—ã•ã‚Œã¾ã™
LLM20.play_games(100000)
```

---The following area is a Markdown cell (cell numver is 68)---
```markdown
# ãƒ—ãƒ­ãƒƒãƒˆ

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã«å…¥ã‚‹å‰ã«ã€å®Ÿéš›ã®æ•°ãƒ¶æœˆé–“ã®ç«¶æŠ€ã«ãŠã‘ã‚‹å„æå‡ºç‰©ã®ã‚²ãƒ¼ãƒ ã®æ•°ã®åˆ†å¸ƒã‚’è¦‹ã¦ãŠãã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 69)---
```python
plt.figure(figsize=(12,6))
last_games_df.groupby("guesser_SubmissionId").size().hist(bins=15)
_ = plt.title("å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®åˆ†å¸ƒ")
_ = plt.xlabel("ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®æ•°")
_ = plt.ylabel("ãƒœãƒƒãƒˆã®æ•°")
```

---The following area is a Code cell (cell numver is 70)---
```python
last_games_df["guesser_SubmissionId"].nunique(), (last_games_df.groupby("guesser_SubmissionId").size()>100).sum()
```

---The following area is a Markdown cell (cell numver is 71)---
```markdown
ä¸€éƒ¨ã®ãƒœãƒƒãƒˆã¯ä»–ã®ãƒœãƒƒãƒˆã‚ˆã‚Šã‚‚å¤šãã®ã‚²ãƒ¼ãƒ ã‚’è¡Œã£ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«å¤§å¹…ã«å¤šãã€ç‰¹ã«å¤ã„ãƒœãƒƒãƒˆã®ä¸­ã«ãã†ã„ã£ãŸã‚‚ã®ãŒå­˜åœ¨ã—ã¾ã™ã€‚å®Ÿéš›ã€ç´„åŠæ•°ã®ãƒœãƒƒãƒˆã¯100ã‚²ãƒ¼ãƒ ä»¥ä¸‹ã—ã‹ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã›ã‚“ãŒã€ä¸€éƒ¨ã¯500ã‚²ãƒ¼ãƒ ä»¥ä¸Šãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ï¼ ã“ã‚Œã¯é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚Šã€ä»Šå¾Œæ¯”è¼ƒã™ã‚‹éš›ã«ç„¡è¦–ã™ã‚‹ã¤ã‚‚ã‚Šã§ã™ãŒã€ã“ã‚Œã‚’è€ƒæ…®ã«å…¥ã‚Œã¦ãŠãã®ã¯è‰¯ã„ã“ã¨ã§ã™ã€‚

ã“ã‚Œã§ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’ã‚ˆã‚Šè©³ç´°ã«ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
```

---The following area is a Code cell (cell numver is 72)---
```python
fig = plt.figure(figsize=(16,8))
cmap = plt.get_cmap('viridis')
for i in range(len(LLM20.players))[::-1]:  # ã‚¹ã‚­ãƒ«ã®å¢—åŠ ã«å¾“ã£ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚½ãƒ¼ãƒˆã—ã€æœ€ä¸Šä½ã‚’ä¿ã¤
    pskill = LLM20.players[i].skill
    plt.plot(
        [r.mu for r in LLM20.players[i].history],
        c = cmap(pskill) if pskill>0 else [.6]*4  # æ‚ªã„ãƒœãƒƒãƒˆã¯ç°è‰²ã§è¡¨ç¤º
    )
_ = plt.title("Muã®é€²åŒ–")
_ = plt.xlabel("ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®æ•°")
_ = plt.ylabel("TrueSkillã®muå€¤")
```

---The following area is a Markdown cell (cell numver is 73)---
```markdown
ä¸Šè¨˜ã®ãƒ—ãƒ­ãƒƒãƒˆã¯ã€*å‚¾å‘*ã¯ã‚ã‚‹ã‚‚ã®ã®ã€ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒ«ã«å¿œã˜ã¦è­˜åˆ¥ã™ã‚‹ã“ã¨ã«å¤±æ•—ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ç°è‰²ã®ç·šã¯ãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸä¸Šä½10äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŒ™å‹•ã«ã•ã‚‰ã«æ³¨ç›®ã—ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 74)---
```python
NFIRSTS = 10
fig = plt.figure(figsize=(16,8))
cmap = plt.get_cmap('tab10')
for i in range(NFIRSTS):
    pskill = LLM20.players[i].skill
    plt.plot(
        [r.mu for r in LLM20.players[i].history],
        c = cmap(i),
        label = f"ã‚¹ã‚­ãƒ« = {pskill:.2f}"
    )
_ = plt.legend()
_ = plt.title("ä¸Šä½10äººï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸï¼‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Muã®é€²åŒ–")
_ = plt.xlabel("ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®æ•°")
_ = plt.ylabel("TrueSkillã®muå€¤")
```

---The following area is a Markdown cell (cell numver is 75)---
```markdown
æœ€é«˜ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŸã¡ã¯ã€å®Ÿéš›ã«ã¯ä¸‹ä½ã®ãƒœãƒƒãƒˆã¨ç«¶äº‰ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™â€¦

åŒã˜ã‚¹ã‚­ãƒ«ã‚’æŒã¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€²åŒ–ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã‚‚èˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ç‰¹å®šã®ç«¶æŠ€ç’°å¢ƒã‚’è¨­å®šã—ã¦ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ç§ã¯ç¾å®Ÿçš„ãªã‚·ãƒŠãƒªã‚ªã‚’ä¿ã¡ãŸã„ã®ã§ã€ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ¼ãƒ«ã®ä¸­ã‹ã‚‰è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 76)---
```python
from collections import Counter
```

---The following area is a Code cell (cell numver is 77)---
```python
duplicated_skills = Counter(skill_dist[:15]).most_common(2)
duplicated_skills
```

---The following area is a Markdown cell (cell numver is 78)---
```markdown
ä¸Šä½15äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸­ã«ã€èˆˆå‘³æ·±ã„å€™è£œãŒ2çµ„å­˜åœ¨ã—ã¾ã™ã€‚ãã‚Œã‚‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ™‚ç³»åˆ—ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```

---The following area is a Code cell (cell numver is 79)---
```python
SHOW_ALL = True
fig = plt.figure(figsize=(16,8))
cmap = plt.get_cmap('tab10')
gray = [.05] * 4
if SHOW_ALL:
    for i in range(len(LLM20.players)):
        plt.plot(
            [r.mu for r in LLM20.players[i].history],
            c = gray
        )
for i in range(20):
    pskill = LLM20.players[i].skill
    if pskill == duplicated_skills[0][0]:
        color = cmap(0)
    elif pskill == duplicated_skills[1][0]:
        color = cmap(1)
    else:
        continue
    plt.plot(
        [r.mu for r in LLM20.players[i].history],
        c = color,
        label = f"ã‚¹ã‚­ãƒ« = {pskill:.2f}"
    )
_ = plt.legend()
_ = plt.title("åŒä¸€ã‚¹ã‚­ãƒ«ã‚’æŒã¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Muã®é€²åŒ–")
_ = plt.xlabel("ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®æ•°")
_ = plt.ylabel("TrueSkillã®muå€¤")
```

---The following area is a Markdown cell (cell numver is 80)---
```markdown
åŒã˜ã‚¹ã‚­ãƒ«ã‚’æŒã¤ç«¶æŠ€è€…ã®ä¸­ã«å°‘ã—ä¸Šä¸‹ã®å·®ãŒè¦‹ã‚‰ã‚Œã¾ã™ãŒã€@c-numberãŒå®Ÿéš›ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§1ä½ã‚’å ã‚ã¦ã„ã‚‹ã“ã¨ã‚’è€ƒæ…®ã™ã‚‹ã¨ã€åŒã˜æå‡ºç‰©ãŒ60ä½ç½®ã§åˆ†æ•£ã—ã¦ã€ã‚¹ã‚³ã‚¢ã¯$\mu=1143$ã‹ã‚‰â€¦ $\mu=767$ã«ã¾ã§å¤‰å‹•ã™ã‚‹ã¨å ±å‘Šã•ã‚Œã¾ã—ãŸã‹ã‚‰ï¼

# ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã¨ã®æ¯”è¼ƒ

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå®Ÿéš›ã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã¨ã©ã®ã‚ˆã†ã«æ¯”è¼ƒã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 81)---
```python
lb = pd.read_csv("/kaggle/input/llm-20-lb-2024-07-14/llm-20-questions-publicleaderboard-2024-07-14.csv")
```

---The following area is a Code cell (cell numver is 82)---
```python
plt.figure(figsize=(12,6))
_ = plt.hist(
    lb.Score,
    bins = 100,
    range = (300, 1200),
    log = True,
    label = "ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰"
)
_ = plt.hist(
    [ p.history[-1].mu for p in LLM20.players.values() ],
    bins = 100,
    range = (300, 1200),
    alpha = .5,
    log = True,
    label = "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
)
_ = plt.title("ãƒ—ãƒ¬ã‚¤ã‚²ãƒ¼ãƒ ã«ã‚ˆã£ã¦ä¿®æ­£ã•ã‚ŒãŸãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰åˆ†å¸ƒ")
_ = plt.xlabel("TrueSkill mu")
_ = plt.ylabel("ãƒœãƒƒãƒˆã®æ•°")
_ = plt.legend()
```

---The following area is a Markdown cell (cell numver is 83)---
```markdown
å®Œç’§ã¨ã¯è¨€ãˆã¾ã›ã‚“ãŒã€ãã“ãã“è‰¯ã„çµæœã§ã™ã€‚å·®ç•°ã®ä¸€éƒ¨ã¯ã€ã‚²ãƒ¼ãƒ ã®æ•°ã®é•ã„ã«ã‚ˆã£ã¦èª¬æ˜å¯ä»¥éšªãŒã€ç¹Šç´°ã«ã¯ä¸ååˆ†ã§ã™ã€‚ä¿®æ­£ã•ã‚ŒãŸæ¯”è¼ƒã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```

---The following area is a Code cell (cell numver is 84)---
```python
plt.figure(figsize=(12,6))
played_dist = last_games_df.groupby("guesser_SubmissionId").size().values
_ = plt.hist(
    lb.Score,
    bins = 100,
    range = (300, 1200),
    log = True,
    label = "ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰"
)
_ = plt.hist(
    [
        p.history[min(len(p.history)-1, random.choice(played_dist))].mu  # ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®åˆ†å¸ƒã‹ã‚‰ã€Œæœ€å¾Œã®ã‚²ãƒ¼ãƒ ã€æ•°ã‚’é¸ã³ã¾ã™
        for p in LLM20.players.values()
    ],
    bins = 100,
    range = (300, 1200),
    alpha = .5,
    log = True,
    label = "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
)
_ = plt.title("ãƒ—ãƒ¬ã‚¤ã‚²ãƒ¼ãƒ ã«ã‚ˆã£ã¦ä¿®æ­£ã•ã‚ŒãŸãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰åˆ†å¸ƒ")
_ = plt.xlabel("TrueSkill mu")
_ = plt.ylabel("ãƒœãƒƒãƒˆã®æ•°")
_ =  plt.legend()
```

---The following area is a Markdown cell (cell numver is 85)---
```markdown
ã‚‚ã†ä¸€ã¤ã®ç‚¹ã¯ã€ã‚¹ã‚­ãƒ«åˆ†å¸ƒãŒé«˜ã„å€¤ã«ã‚·ãƒ•ãƒˆã—ã¦ã„ã‚‹ã“ã¨ã§ã™ãŒã€ã‚„ã¯ã‚Šãã‚Œã ã‘ã§ã¯é•ã„ã‚’èª¬æ˜ã™ã‚‹ã«ã¯ä¸ååˆ†ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€$\beta$ã‚„$\tau$ã®å€¤ãŒä½•ã‚‰ã‹ã®å½¢ã§ãšã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ã¾ãŸã€ç«¶æŠ€ã‚’é€šã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒèª¿æ•´ã•ã‚ŒãŸå¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã„ãšã‚Œã«ã›ã‚ˆã€ç§ã®ãƒ†ã‚¹ãƒˆã‹ã‚‰ã¯ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœãŒå¤‰ã‚ã‚‹ã¨ã¯æ€ãˆã¾ã›ã‚“ã€‚

# ä¸Šä½10ã‚²ãƒ¼ãƒ ã®å±¥æ­´ã¨ã®æ¯”è¼ƒ

ç§ã¯æ‰‹å‹•ã§ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®ä¸Šä½10ä½ã®ã‚²ãƒ¼ãƒ å±¥æ­´ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸ã«å‡¦ç†ã—ã¾ã—ãŸã€‚ã“ã®è¾æ›¸ã¯ã€[LLM-20-top10-LB-matches](https://www.kaggle.com/datasets/gguillard/llm-20-top10-lb-matches)ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ”ã‚¯ãƒ«å½¢å¼ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 86)---
```python
import pickle
with open("/kaggle/input/llm-20-top10-lb-matches/matches.pickle", "rb") as f:
    top10_games_dict = pickle.load(f)
```

---The following area is a Markdown cell (cell numver is 87)---
```markdown
å½¼ã‚‰ã®é€²åŒ–ã¯ç§ãŸã¡ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã©ã®ã‚ˆã†ã«æ¯”è¼ƒã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```

---The following area is a Code cell (cell numver is 88)---
```python
plt.figure(figsize=(12,6))
gray = [.05] * 4
if SHOW_ALL:
    for i in range(len(LLM20.players)):
        plt.plot(
            [r.mu for r in LLM20.players[i].history[:200]],
            c = gray
        )
for kaggler, df in top10_games_dict.items():
    _ = plt.plot(df[kaggler], label = kaggler)
_ = plt.title("ä¸Šä½10åã®ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®muã®é€²åŒ–ï¼ˆèƒŒæ™¯ = ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰")
_ = plt.xlabel("ãƒ—ãƒ¬ã‚¤ã—ãŸã‚²ãƒ¼ãƒ ã®æ•°")
_ = plt.ylabel("TrueSkillã®muå€¤")
_ = plt.legend()
```

---The following area is a Markdown cell (cell numver is 89)---
```markdown
ã“ã®ãƒ—ãƒ­ãƒƒãƒˆã®ç›®çš„ã¯ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®æŒ™å‹•ãŒç§ãŸã¡ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ã“ã¨ã§ã™ã€‚SpiralTipã®å°è±¡çš„ãªå¾©æ´»ã«ã‚‚æ³¨ç›®ã—ã¦ãã ã•ã„â€¦

# ãƒãƒ¼ãƒ ã®ãƒãƒƒãƒãƒ³ã‚°

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã§è€ƒæ…®ã—ãªã‹ã£ãŸé‡è¦ãªç‚¹ãŒã‚ã‚Šã¾ã™ã€‚ç«¶æŠ€ã®æ¦‚è¦ã‚’å¼•ç”¨ã—ã¾ã™ï¼š

> å„æå‡ºç‰©ã¯ã€åŒç­‰ã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æŒã¤ä»–ã®ãƒœãƒƒãƒˆã¨ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆã‚²ãƒ¼ãƒ ï¼‰ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚

ç§ã®è¦‹è§£ã§ã¯ã€TrueSkillãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å¾“ã£ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¼•ãå‡ºã™ä¾¿åˆ©ãªé–¢æ•°ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ç‚¹ã«ã¤ã„ã¦ã“ã ã‚ã‚‹ä¾¡å€¤ã¯ã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ ä¸Šä½10ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚²ãƒ¼ãƒ å±¥æ­´ãŒã‚ã‚‹ã®ã§ã€å½¼ã‚‰ãŒ$\mu$ã®é€²åŒ–ã«æ²¿ã£ã¦ã©ã®ã‚ˆã†ã«ãƒšã‚¢ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 90)---
```python
plt.figure(figsize=(12,6))
for kaggler, df in top10_games_dict.items():
    _ = plt.scatter(df[kaggler], df["Op1"], s = 1, label = kaggler)
    _ = plt.scatter(df[kaggler], df["Op2"], s = 1)
    _ = plt.scatter(df[kaggler], df["Op3"], s = 1)
_ = plt.legend()
```

---The following area is a Markdown cell (cell numver is 91)---
```markdown
ãƒˆãƒ¬ãƒ³ãƒ‰ã¯è¦‹ã‚‰ã‚Œã¾ã™ãŒã€ãã“ã‹ã‚‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’æ¨æ¸¬ã™ã‚‹ã®ã¯æ˜ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã•ã‚‰ã«ã€é«˜å¾—ç‚¹ã®ãƒœãƒƒãƒˆãŒãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã¨ãƒšã‚¢ã«ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãŸã ã—ã€ãã‚Œã¯å½¼ã‚‰ã®å°ã•ãª$\sigma$ã«ã‚ˆã£ã¦ã‚ã‚‹ç¨‹åº¦ç·©å’Œã•ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚

ã—ã‹ã—ã€ä½•ã‚ˆã‚Šã‚‚ã€ã“ã®ç‚¹ã¯ï¼ˆé€†ã«ã€Œæ„šã‹ã•ã®è½ã¨ã—ç©´ã€å•é¡Œã‚’åŠ©é•·ã—ï¼‰è§£æ±ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚@loh-maaãŒéå¸¸ã«çš„ç¢ºã«åä»˜ã‘ãŸå•é¡Œã§ã™ã€‚

# çµè«–

ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ãŠãã‚‰ãå¤šãã®æ¬ é™¥ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚ç‰¹ã«ã€æ–°ã—ã„æå‡ºç‰©ãŒæ™‚é–“ã¨ã¨ã‚‚ã«å¢—ãˆã‚‹ã“ã¨ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚²ãƒ¼ãƒ ã®é »åº¦ãŒæ™‚é–“ã¨ã¨ã‚‚ã«æ¸›å°‘ã™ã‚‹ã“ã¨ï¼ˆãŠãã‚‰ãÏƒã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåŒæ§˜ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨å¯¾æˆ¦ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ç¨‹åº¦ã‚ã‚‹ã¨ã„ã†äº‹å®Ÿã§ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®ã€Œç‰¹å¾´ã€ãŒç§ã®çµè«–ã‚’å¤‰ãˆã‚‹ã“ã¨ã¯ãªã„ã¨æ€ã„ã¾ã™ã€‚ç¾çŠ¶ã®ã¾ã¾ã§ã¯ã€LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚ˆã‚Šã‚‚å¶ç„¶ã®è¦ç´ ã‚’å¤šãå«ã‚“ã§ã„ã‚‹ã“ã¨ã¯æ˜ã‚‰ã‹ã§ã™ã€‚

# ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰

ã‚‚ã—ã€ä¸Šè¨˜ã®å†…å®¹ã‚’ï¼ˆå†ï¼‰èª­ã¾ãªãã¦ã‚‚TrueSkillç’°å¢ƒã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸã„å ´åˆã¯ã€å¿…è¦ãªã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 92)---
```python
!pip install trueskill
```

---The following area is a Code cell (cell numver is 93)---
```python
import random
from typing import List, Optional, Tuple
import warnings

from tqdm import tqdm
from trueskill import TrueSkill
```

---The following area is a Code cell (cell numver is 94)---
```python
class Player:
    def __init__(
        self,
        skill: float,
        env: Optional[TrueSkill] = None  # ä»Šã¯ç„¡è¦–ã—ã¾ã™ãŒã€å¾Œã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™
    ):
        self.skill = skill
        self.rating = Rating() if env is None else env.Rating()  # ç’°å¢ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆã¤ã¾ã‚Š600,300ï¼‰ã§é–‹å§‹
        self.history = []
        
    def update(self, new_rating):
        self.history.append(self.rating)
        self.rating = new_rating
```

---The following area is a Code cell (cell numver is 95)---
```python
def play_match(
    teamA: Tuple[Player, Player],
    teamB: Tuple[Player, Player],
    env: Optional[TrueSkill],
    debug: bool = False
):
    """
    2ãƒãƒ¼ãƒ é–“ã®è©¦åˆã‚’è¡Œã„ã¾ã™ã€‚
    
    ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    ------
        teamA: Tuple[Player, Player]
            2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        teamB: Tuple[Player, Player]
            ã‚‚ã†ä¸€ã¤ã®2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã€‚
        debug: boolean
            ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ©ã‚°ã€‚
    """
    if debug:
        print("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚­ãƒ«ã€€:", [p.skill for p in teamA+teamB])
        print("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€€:", [tuple(p.rating for p in teamA), tuple(p.rating for p in teamB)])
    # å„ãƒãƒ¼ãƒ ã«ã¤ã„ã¦ã€ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã‹ã‚’åˆ¤å®šã—ã€ãƒœãƒƒãƒˆãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‘ã‚Œã°å¤±æ•—
    # ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒãƒ¼ãƒ ã®ç›®æ¨™ã‚¹ã‚­ãƒ«ãŒãƒ©ãƒ³ãƒ€ãƒ ãªæ•°ã‚ˆã‚Šã‚‚é«˜ã‘ã‚Œã°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹
    # ï¼ˆå½±ã«é€†ã®è«–ç†ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ï¼‰
    ranks = [
        1 if teamA[0].skill * teamA[1].skill == 0 or random.random() > teamA[0].skill else 0,
        1 if teamB[0].skill * teamB[1].skill == 0 or random.random() > teamB[0].skill else 0
    ]
    
    # æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã‚²ãƒ¼ãƒ ã®çµæœ
    new_ratings = env.rate(
        [
            [ p.rating for p in teamA ],
            [ p.rating for p in teamB ]
        ],
        ranks
    )
    
    # ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ›´æ–°
    for p,r in zip(teamA, new_ratings[0]):
        p.update(r)
    for p,r in zip(teamB, new_ratings[1]):
        p.update(r)
        
    if debug:
        print("ã‚²ãƒ¼ãƒ ã®çµæœã€€:", ranks)
        print("æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€€:", new_ratings)
    
    return
```

---The following area is a Code cell (cell numver is 96)---
```python
class Competition:
    """
    TrueSkillã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç’°å¢ƒã‚’è¨­å®šã§ãã¾ã™ã€‚
    """
    
    def __init__(
        self,
        skill_dist: List[float],
        nb_dummy: int,
        mu: float = 600,
        sigma: float = 300,
        beta: float = 150,
        tau: float = 3,
        draw_probability: float = 0.9956,
        seed: float = 42,
        debug: bool = False
    ):
        """
        ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã€‚
        
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        ------
            skill_dist: List[float]
                å„ã€Œè‰¯ã„ã€æå‡ºã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹ã®ç¢ºç‡ã€‚
            nb_dummy: int
                ãƒ€ãƒŸãƒ¼ãƒœãƒƒãƒˆã®æ•°ã€‚
            mu: float
                TrueSkillã®muãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            sigma: float
                TrueSkillã®sigmaãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            beta: float
                TrueSkillã®betaãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            tau: float
                TrueSkillã®tauãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            draw_probability: float
                TrueSkillã®draw_probabilityãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚
            seed: float
                ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã€‚
            debug: bool
                ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ©ã‚°ã€‚
        """
        # ç§ãŸã¡ã®ç«¶æŠ€ç’°å¢ƒ
        self._trueskill = TrueSkill(
            mu = mu,
            sigma = sigma,
            beta = beta,
            tau = tau,
            draw_probability = draw_probability
        )
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ—ãƒ¼ãƒ« â€” ãã‚ŒãŒPlayerã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ç’°å¢ƒã‚’è¿½åŠ ã™ã‚‹ç†ç”±
        self.players = { ii: Player(s, self._trueskill) for ii,s in enumerate(skill_dist) }
        self.players.update({ len(self.players)+ii: Player(0, self._trueskill) for ii in range(nb_dummy) })
        
        # ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰
        self._seed = seed
        random.seed(seed)
        
        self.debug = debug
        
        
    def play_games(self, nb_games: int = 10000):
        """
        ã‚²ãƒ¼ãƒ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã™ã€‚
        
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        ------
            nb_games: int
                ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚²ãƒ¼ãƒ ã®æ•°ã€‚
        """
        
        for i in tqdm(range(nb_games)):
            player_ids = random.sample(range(len(self.players)), 4)  # ãƒ©ãƒ³ãƒ€ãƒ ã«4äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã³ã¾ã™
            try:
                play_match(
                    [
                        self.players[player_ids[0]],
                        self.players[player_ids[1]]
                    ],
                    [
                        self.players[player_ids[2]],
                        self.players[player_ids[3]]
                    ],
                    env = self._trueskill,
                    debug = self.debug
                )
            except Exception as e:
                warnings.warn(f"ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                continue
```

---The following area is a Code cell (cell numver is 97)---
```python
nb_players = 10  # å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°
nb_dummy_players = 10  # ãƒ€ãƒŸãƒ¼ï¼ˆã€Œæ‚ªã„ã€ï¼‰ãƒœãƒƒãƒˆã®æ•°
skill_distribution = [ random.random() for i in range(nb_players)]  # ã‚¹ã‚­ãƒ«åˆ†å¸ƒ
```

---The following area is a Code cell (cell numver is 98)---
```python
# ã•ã¾ã–ã¾ãªã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
C1 = Competition(skill_distribution, nb_dummy_players)
C2 = Competition(skill_distribution, nb_dummy_players, mu = 500, sigma = 100, beta = 200, tau = 10, draw_probability = .8, seed = 123)
```

---The following area is a Code cell (cell numver is 99)---
```python
# Kaggleã®ã‚·ã‚¹ãƒ†ãƒ ã§ç´„1700ã‚²ãƒ¼ãƒ ï¼ç§’ã‚’æœŸå¾…ã—ã¦ãã ã•ã„
# å±¥æ­´ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œãšã€ã‚²ãƒ¼ãƒ ã¯ä»¥å‰ã®ã‚‚ã®ã«åŠ ç®—ã•ã‚Œã¾ã™
C1.play_games(10000)
C2.play_games(10000)
```

---The following area is a Code cell (cell numver is 100)---
```python
import matplotlib.pyplot as plt
```

---The following area is a Code cell (cell numver is 101)---
```python
plt.plot([ r.mu for r in C1.players[0].history])
```

---The following area is a Markdown cell (cell numver is 102)---
```markdown
# ã‚·ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å¤‰å‹•
```

---The following area is a Code cell (cell numver is 103)---
```python
C = [Competition(skill_dist, nb_dummy, seed=i) for i in range(4)]
```

---The following area is a Code cell (cell numver is 104)---
```python
for comp in C:
    comp.play_games(50000)
```

---The following area is a Code cell (cell numver is 105)---
```python
def plot_first_n(comp, nfirsts, a):
    #fig = plt.figure(figsize=(16,8))
    cmap = plt.get_cmap('tab10')
    for i in range(nfirsts):
        pskill = comp.players[i].skill
        a.plot(
            [r.mu for r in comp.players[i].history],
            c = cmap(i),
            label = f"ã‚¹ã‚­ãƒ« = {pskill:.2f}"
        )
    _ = a.legend()
    _ = a.set_title("ä¸Šä½10äººï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸï¼‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Muã®é€²åŒ–")
    _ = a.set_xlabel("ãƒ—ãƒ¬ã‚¤ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã®æ•°")
    _ = a.set_ylabel("TrueSkillã®muå€¤")
```

---The following area is a Code cell (cell numver is 106)---
```python
fig, ax = plt.subplots(nrows=4, ncols=1, figsize=(16,16), constrained_layout=True)
for i,comp in enumerate(C):
    #plt.axes(ax[i])
    plot_first_n(comp, 5, ax[i])
```

---The following area is a Code cell (cell numver is 107)---
```python
for comp in C:
    scores = {p: v.rating.mu for p,v in comp.players.items()}
    leaderboard = {k:v for k,v in sorted(scores.items(), key=lambda item: item[1], reverse = True)}
    print("ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰")
    print("rank\tplayer\tskill\tmu")
    for i in range(5):
        pnum = list(leaderboard.keys())[i]
        print(f"{i+1}\t{pnum}\t{comp.players[pnum].skill:.2f}\t{leaderboard[i]:.0f}")
    print("-------------")
```

** @@@ Jupyter Notebook numver 15, the number of votes :16 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®åœ°ç†æƒ…å ±ã‚’è¦–è¦šåŒ–ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã€åœ°ç†çš„ãªä½ç½®ã‚’å–å¾—ã—ã€åœ°å›³ä¸Šã«ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ´å¯Ÿã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
Notebookã§ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹åœ°ç†æƒ…å ±ã‚’è¦–è¦šåŒ–ã™ã‚‹ã“ã¨ã‚’ä¸»ãŸã‚‹èª²é¡Œã¨ã—ã¦ãŠã‚Šã€ç‰¹ã«ã€Œå›½ã€ã€Œéƒ½å¸‚ã€ã€Œãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã€ã¨ã„ã£ãŸã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ã„ã¦ä½ç½®æƒ…å ±ã‚’åé›†ã—ã€ã“ã‚Œã‚’åœ°å›³ä¸Šã«è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã€è¦–è¦šçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç†è§£ã—ã‚„ã™ãã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Python**: å®Ÿè£…è¨€èªã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - `requests`: Web APIã‚’ä»‹ã—ã¦åœ°ç†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  - `folium`: åœ°å›³ã‚’ç”Ÿæˆã—ã€åœ°ç‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  - `json`: JSONãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  - `time`: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®ˆã‚‹ãŸã‚ã®ã‚¹ãƒªãƒ¼ãƒ—æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
  - `kaggle_secrets`: Kaggleä¸Šã§å®‰å…¨ã«APIã‚­ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä¸»ãªã‚¹ãƒ†ãƒƒãƒ—
1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿**: `keywords.py`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
2. **åœ°ç†æƒ…å ±ã®å–å¾—**: `geocoding_api_key`ã‚’åˆ©ç”¨ã—ã¦ã€æŒ‡å®šã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®åœ°ç†æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚
3. **åœ°å›³ã®ç”Ÿæˆ**: Foliumã‚’ä½¿ã£ã¦åœ°å›³ã‚’ä½œæˆã—ã€å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚«ãƒ†ã‚´ãƒªã«è‰²åˆ†ã‘ã—ã¦åœ°ç‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆã—ã¾ã™ã€‚
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: APIã‹ã‚‰ã®å¿œç­”ã«å¯¾ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
5. **åœ°å›³è¡¨ç¤º**: æœ€å¾Œã«ç”Ÿæˆã—ãŸåœ°å›³ã‚’Notebookå†…ã§è¡¨ç¤ºã—ã¾ã™ã€‚

ã“ã®Notebookã¯ã€è¦–è¦šçš„ãªåˆ†æã¨ãƒ‡ãƒ¼ã‚¿ã¸ã®æ´å¯Ÿã‚’ä¿ƒé€²ã™ã‚‹ãŸã‚ã®åŠ¹æœçš„ãªæ‰‹æ³•ã‚’ç¤ºã—ã¦ãŠã‚Šã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚„ãƒ‡ãƒ¼ã‚¿ç†è§£ã‚’åŠ©ã‘ã‚‹ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import json
import requests
import time
import folium
from kaggle_secrets import UserSecretsClient
```

---The following area is a Code cell (cell numver is 2)---
```python
exec(open("/kaggle/input/llm-20-questions/llm_20_questions/keywords.py").read())  # keywords.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿å®Ÿè¡Œã™ã‚‹
KEYWORDS_JSON = json.loads(KEYWORDS_JSON)  # JSONå½¢å¼ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’Pythonã®è¾æ›¸å‹ã«å¤‰æ›ã™ã‚‹
KEYWORDS_JSON  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¾æ›¸ã‚’è¡¨ç¤ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 3)---
```python
print(len(KEYWORDS_JSON))  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰JSONã®é•·ã•ï¼ˆã‚«ãƒ†ã‚´ãƒªã®æ•°ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
for category in KEYWORDS_JSON:  # å„ã‚«ãƒ†ã‚´ãƒªã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ—
    print(category["category"], len(category["words"]))  # ã‚«ãƒ†ã‚´ãƒªåã¨ãã®ã‚«ãƒ†ã‚´ãƒªå†…ã®å˜èªæ•°ã‚’è¡¨ç¤ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 4)---
```python
user_secrets = UserSecretsClient()  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç§˜å¯†ã‚’å–å¾—ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
geocoding_api_key = user_secrets.get_secret("geocoding_api_key")  # 'geocoding_api_key'ã‚’ç§˜å¯†ã‹ã‚‰å–å¾—ã™ã‚‹ï¼ˆAPIã‚­ãƒ¼ã‚’'Add-ons'->'secret'ã§è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
```

---The following area is a Code cell (cell numver is 5)---
```python
url_api = "https://geocode.maps.co/search?q={address}&api_key={api_key}"  # geocoding APIã®URLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
# APIã‚’ãƒ†ã‚¹ãƒˆ
r = requests.get(url_api.format(address="croatia",api_key=geocoding_api_key))  # ã‚¯ãƒ­ã‚¢ãƒã‚¢ã®åœ°ç†æƒ…å ±ã‚’è¦æ±‚ã™ã‚‹
r.status_code  # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 6)---
```python
r.json()  # å¿œç­”ã‚’JSONã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
```

---The following area is a Code cell (cell numver is 7)---
```python
worldmap = folium.Map([0, 0], titles='Map', zoom_start=4)  # åœ°å›³ã®è¡¨ç¤ºç”¨ã«folium.Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆåˆæœŸä½ç½®ã¯ç·¯åº¦0ã€çµŒåº¦0ã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«4ï¼‰
```

---The following area is a Code cell (cell numver is 8)---
```python
colors = {"country": "blue", "city": "green", "landmark": "orange"}  # ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²ã‚’å®šç¾©ã™ã‚‹
for category, name in zip(KEYWORDS_JSON, ["country", "city", "landmark"]):  # å„ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åå‰ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ«ãƒ¼ãƒ—
    for location in category["words"]:  # å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ—
        r = requests.get(url_api.format(address=location["keyword"], api_key=geocoding_api_key))  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦åœ°ç†æƒ…å ±ã‚’è¦æ±‚ã™ã‚‹
        if r.status_code != 200:  # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200ã§ãªã„å ´åˆï¼ˆæˆåŠŸã§ãªã„å ´åˆï¼‰
            print(f"error {r.status_code = } {name} {location['keyword']}")  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
            continue  # æ¬¡ã®ãƒ«ãƒ¼ãƒ—ã¸é€²ã‚€
        try:
            resp = r.json()[0]  # å¿œç­”ã‚’å–å¾—ï¼ˆæœ€åˆã®è¦ç´ ï¼‰
            folium.Circle(location=[resp.get('lat'), resp.get('lon')],  # ç·¯åº¦ã¨çµŒåº¦ã«åŸºã¥ã„ã¦ã‚µãƒ¼ã‚¯ãƒ«ã‚’ä½œæˆ
                          popup=f"{name} {location['keyword']}",  # ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«åå‰ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                          color=colors[name],  # ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸè‰²ã‚’è¨­å®š
                          tooltip=f"{name} {location['keyword']} {location['alts']}",  # ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«è©³ç´°ã‚’è¡¨ç¤º
                          fill=False).add_to(worldmap)  # ãƒãƒƒãƒ—ã«ã‚µãƒ¼ã‚¯ãƒ«ã‚’è¿½åŠ 
        except IndexError:  # å¿œç­”ãŒç©ºã®å ´åˆ
            print("error empty response", name, location["keyword"])  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        time.sleep(1)  # ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®ãŸã‚ã€1ç§’ã‚ãŸã‚Š1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ã‚’è¨­ã‘ã‚‹

worldmap  # ä½œæˆã—ãŸåœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Sakshi Satre
> 
> "è¦–è¦šçš„ã«é­…åŠ›çš„ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†!" [@waechter](https://www.kaggle.com/waechter) 
> 
> 

---

> ## Matin Mahmoudi âœ¨
> 
> ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€LLM 20 Questionsã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚ˆãæ§‹æˆã•ã‚ŒãŸåœ°å›³ã‚’ä½¿ã£ãŸæ´å¯Ÿã«æº€ã¡ãŸEDAã‚’æä¾›ã—ã¦ã„ã¾ã™ã€[@waechter](https://www.kaggle.com/waechter)ã€‚åˆ†æã¯æ˜ç¢ºã§ã€è¦–è¦šåŒ–ã¯éå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚ä»–ã®ä½œå“ã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸãŒã€ã™ã¹ã¦ã«ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒˆã—ã¾ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„å‹äººã‚ˆã€‚
> 
> 

---

> ## MarÃ­lia Prata
> 
> äºˆæƒ³å¤–ã®foliumãƒãƒƒãƒ—ã¨ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã€‚éå¸¸ã«ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã§ã€ç§ã¯ãã®ç´ æ™´ã‚‰ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ€ã„ã¤ãã“ã¨ã¯æ±ºã—ã¦ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„åœ°å›³ã§ã™ã€‚
> 
> 
> > ## waechterãƒˆãƒ”ãƒƒã‚¯è‘—è€…
> > 
> > ã”è¦ªåˆ‡ãªãŠè¨€è‘‰ã«æ„Ÿè¬ã—ã¾ã™ï¼
> > 
> > 

---

> ## pathfinder.milan
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚
> 
> 
>
```

** @@@ Jupyter Notebook numver 16, the number of votes :15 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã§ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’è§£èª¬ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è³ªå•è€…ï¼ˆè³ªå•ã™ã‚‹å½¹å‰²ï¼‰ã¨å›ç­”è€…ï¼ˆå›ç­”ã™ã‚‹å½¹å‰²ï¼‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®å–ã‚Šçµ„ã¿:
- **ç›®çš„**: ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€å‚åŠ è€…ãŒåŠ¹ç‡çš„ã«æƒ…å ±ã‚’åé›†ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ¨æ¸¬ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚
- **ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯äº’ã„ã«è³ªå•ã¨ç­”ãˆã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°ãå‡ºã—ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: PyTorchã¨Gemmaãƒ¢ãƒ‡ãƒ«ï¼ˆGoogleã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹LLMï¼‰ã‚’ä½¿ç”¨ã—ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
2. **GemmaFormatterã‚¯ãƒ©ã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«é–“ã®ä¼šè©±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã€ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã¨çµ‚äº†ã‚’ç¤ºã™ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ§‹æˆã‚’æ•´ãˆã¾ã™ã€‚
3. **GemmaAgentã‚¯ãƒ©ã‚¹**: ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã§ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å¿œç­”ã®å‡¦ç†ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚
4. **GemmaQuestionerAgentã‚¯ãƒ©ã‚¹ã¨GemmaAnswererAgentã‚¯ãƒ©ã‚¹**: ãã‚Œãã‚Œè³ªå•è€…ã¨å›ç­”è€…ã®å‹•ä½œã‚’å…·ç¾åŒ–ã™ã‚‹ãŸã‚ã«ã€GemmaAgentã‚’ç¶™æ‰¿ã—ã€ç‰¹å®šã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
5. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç®¡ç†**: `get_agent`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã€`agent_fn`é–¢æ•°ã§è¦³å¯Ÿã«åŸºã¥ã„ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé©åˆ‡ã«å¿œç­”ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ä½œæˆã•ã‚Œã‚‹`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ç›´æ¥æå‡ºã§ãã¾ã™ã€‚ã“ã®é€²è¡ŒçŠ¶æ³ãŒä»–ã®å‚åŠ è€…ã«ã‚‚å‚è€ƒã«ãªã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ã€Gemmaã®ä¾‹ã‚’æä¾›ã™ã‚‹å·¥å¤«ã‚‚ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
çš†ã•ã‚“ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã‚³ãƒ¼ãƒ‰ã‚’ã„ãã¤ã‹ã®éƒ¨åˆ†ã«åˆ†å‰²ã—ã€chatGPTã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã¨èª¬æ˜ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ã“ã®ãƒªãƒ³ã‚¯ã«ã‚ã‚‹Gemmaã®ä¾‹ï¼ˆhttps://www.kaggle.com/models/google/gemma/PyTorch/7b-it-quant/2ï¼‰ã¯åˆå¿ƒè€…ã«ã¨ã£ã¦å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒå½¹ç«‹ã¤ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚

---

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions**ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã®**ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡º**ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç›´æ¥é€ä¿¡ã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‹ã‚‰*Output*ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz`ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹**Submit Agent**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# Part 1: ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

- `%%writefile`ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ¬¡ã®è¡Œã®ã™ã¹ã¦ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã‚ˆã†æŒ‡ç¤ºã—ã¾ã™ã€‚
- `submission/main.py`ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ãƒ‘ã‚¹ã§ã™ã€‚ã‚‚ã—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª`submission`ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€æ–°ã—ãä½œæˆã•ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
# #%%writefile submission/main.py
# # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
import os
import sys
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# Part 2: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚¦ã‚§ã‚¤ãƒˆãƒ‘ã‚¹ã®è¨­å®š
```

---The following area is a Code cell (cell numver is 6)---
```python
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# Part 3: GemmaFormatterã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

- `GemmaFormatter`ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«é–“ã®ä¼šè©±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã¨çµ‚äº†ã‚’ç¤ºã™äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
import itertools
from typing import Iterable


class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    # åˆæœŸåŒ–
    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    # ä¼šè©±ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
    def __repr__(self):
        return self._state

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¼šè©±ã«è¿½åŠ ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self
        
    # ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’ä¼šè©±ã«è¿½åŠ ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’ç¤ºã™ãƒ¡ã‚½ãƒƒãƒ‰
    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self

    # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’ç¤ºã™ãƒ¡ã‚½ãƒƒãƒ‰
    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self

    # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’ç¤ºã™ãƒ¡ã‚½ãƒƒãƒ‰
    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self

    # ãƒªã‚»ãƒƒãƒˆãƒ¡ã‚½ãƒƒãƒ‰
    def reset(self):
        # `_state`ã‚’ç©ºã®æ–‡å­—åˆ—ã«åˆæœŸåŒ–
        self._state = ""  

        # æä¾›ã•ã‚ŒãŸå ´åˆã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
        if self._system_prompt is not None:
            self.user(self._system_prompt)  
            
        # æä¾›ã•ã‚ŒãŸå ´åˆã€few-shotã®ä¾‹ã‚’é©ç”¨ã—ã¾ã™ã€‚
        if self._few_shot_examples is not None: 
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
###  ä¾‹
```

---The following area is a Code cell (cell numver is 10)---
```python
# ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨few-shotä¾‹ã¨å…±ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–
formatter = GemmaFormatter(
    system_prompt="ã“ã‚Œã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚",
    few_shot_examples=["ä¾‹ã®è³ªå•ï¼Ÿ", "ä¾‹ã®å›ç­”ã€‚"]
)

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
formatter.user("ãƒ•ãƒ©ãƒ³ã‚¹ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ")

# ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
formatter.model("ãƒ•ãƒ©ãƒ³ã‚¹ã®é¦–éƒ½ã¯ãƒ‘ãƒªã§ã™ã€‚")

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸä¼šè©±ã‚’å‡ºåŠ›
print(formatter)
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
`GemmaFormatter`ã‚¯ãƒ©ã‚¹ã¯ã€ä¼šè©±ã‚’ä¸€è²«ã—ãŸæ–¹æ³•ã§æ§‹é€ åŒ–ãŠã‚ˆã³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ã®ã«å½¹ç«‹ã¡ã€ã‚¿ãƒ¼ãƒ³ãŒé©åˆ‡ã«ãƒãƒ¼ã‚¯ã•ã‚Œã€æ•´ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

# Part 4: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

- `_set_default_tensor_type`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã¯ã€ä¸€æ™‚çš„ã«PyTorchã®ãƒ†ãƒ³ã‚½ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿å‹ã‚’æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«è¨­å®šã—ã€ãã®ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã«å†ã³torch.floatã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 12)---
```python
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«torchã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆdtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)
```

---The following area is a Markdown cell (cell numver is 13)---
```markdown
### ä¾‹
```

---The following area is a Code cell (cell numver is 14)---
```python
torch.tensor([1.0, 2.0]).dtype
```

---The following area is a Code cell (cell numver is 15)---
```python
with _set_default_tensor_type(torch.float64):
    print(torch.tensor([1.0, 2.0]).dtype)
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
# Part 5: åŸºæœ¬GemmaAgentã‚¯ãƒ©ã‚¹

GemmaAgentã‚¯ãƒ©ã‚¹ã¯ä»¥ä¸‹ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™:

- è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ãƒ»è¨­å®šã—ã¾ã™ã€‚
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å¿œç­”ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŠã‚ˆã³å‡¦ç†ã—ã¾ã™ã€‚
- ãƒ†ãƒ³ã‚½ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’ä¸€æ™‚çš„ã«è¨­å®šã™ã‚‹ãŸã‚ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã¨å¯¾è©±ã—ã€å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        
        # ãƒ¢ãƒ‡ãƒ«è¨­å®š
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant
        
        # ãƒ¢ãƒ‡ãƒ«
        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
# Part 6: GemmaQuestionerAgentã‚¯ãƒ©ã‚¹
```

---The following area is a Code cell (cell numver is 19)---
```python
def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]

class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ä»Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ¨æ¸¬ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("æœªçŸ¥ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—: ", obs.turnType)
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
GemmaQuestionerAgent:
- `__init__`ï¼šè¦ªã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
- `_start_session`ï¼šè³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«ä¸¦ã¹ã€ä¼šè©±ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
- `_parse_response`ï¼šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã€æ¨æ¸¬ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã«ã‚ˆã£ã¦ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’ç•°ãªã‚‹æ–¹æ³•ã§è§£é‡ˆã—ã¾ã™ã€‚

# Part 7: GemmaAnswererAgentã‚¯ãƒ©ã‚¹
```

---The following area is a Code cell (cell numver is 21)---
```python
class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã«é–¢é€£ã™ã‚‹è³ªå•ã§ã™ã€‚ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚å›ç­”ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
# Part 8: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã¨é–¢æ•°å®šç¾©
```

---The following area is a Code cell (cell numver is 23)---
```python
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã‹ã‚‰ã®ã¯ã„ã‹ã„ã„ãˆã®è³ªå•ã«å¿œã˜ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ï¼",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦ãã ã•ã„ã®ã§ã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãŠãã‚‰ãOOMï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ï¼‰ã«ãªã‚Šã¾ã™ã€‚

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤‰æ•°ã‚’åˆæœŸåŒ–
agent = None

# åå‰ã«åŸºã¥ã„ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
def get_agent(name: str):
    global agent
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚‰ãšã€è¦æ±‚ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ"è³ªå•è€…"ã®å ´åˆ
    if agent is None and name == 'questioner':
        # ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§GemmaQuestionerAgentã‚’åˆæœŸåŒ–
        agent = GemmaQuestionerAgent(
            device='cuda:0',  # è¨ˆç®—ç”¨ã®ãƒ‡ãƒã‚¤ã‚¹
            system_prompt=system_prompt,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            few_shot_examples=few_shot_examples,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•ã‚’æŒ‡å°ã™ã‚‹ãŸã‚ã®ä¾‹
        )
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚‰ãšã€è¦æ±‚ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ"å›ç­”è€…"ã®å ´åˆ
    elif agent is None and name == 'answerer':
        # åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§GemmaAnswererAgentã‚’åˆæœŸåŒ–
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    # åˆæœŸåŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™
    return agent

# è¦³å¯Ÿã«åŸºã¥ã„ã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®é–¢æ•°
def agent_fn(obs, cfg):
    # è¦³å¯ŸãŒè³ªå•ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    if obs.turnType == "ask":
        # è³ªå•ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¦³å¯Ÿã«å¿œç­”ã™ã‚‹
        response = get_agent('questioner')(obs)
    # è¦³å¯ŸãŒæ¨æ¸¬ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    elif obs.turnType == "guess":
        # è³ªå•ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¦³å¯Ÿã«å¿œç­”ã™ã‚‹
        response = get_agent('questioner')(obs)
    # è¦³å¯ŸãŒå›ç­”ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    elif obs.turnType == "answer":
        # å›ç­”ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã—ã¦è¦³å¯Ÿã«å¿œç­”ã™ã‚‹
        response = get_agent('answerer')(obs)
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®å¿œç­”ãŒNoneã¾ãŸã¯éå¸¸ã«çŸ­ã„ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    if response is None or len(response) <= 1:
        # ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå¿œç­”ï¼ˆ"ã¯ã„"ï¼‰ã‚’ä»®å®š
        return "ã¯ã„"
    else:
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã£ãŸå¿œç­”ã‚’è¿”ã™
        return response
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
1. **GemmaFormatterã‚¯ãƒ©ã‚¹**: ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ‰±ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’æ§‹æˆã—ã€ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒ»çµ‚äº†ã€çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆã€ã‚¿ãƒ¼ãƒ³ã®é©ç”¨ã«é–¢ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸€è²«ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿è¨¼ã—ã¾ã™ã€‚

2. **GemmaAgentã‚¯ãƒ©ã‚¹**: ã‚²ãƒ¼ãƒ å†…ã®ä¸€èˆ¬çš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¡¨ã™æŠ½è±¡ã‚¯ãƒ©ã‚¹ã§ã™ã€‚åˆæœŸåŒ–ã€å‘¼ã³å‡ºã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã®å‘¼ã³å‡ºã—ã€å¿œç­”ã®è§£æã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«ã‚¿ã‚¤ãƒ—ã®è¨­å®šãªã©ã€å…±é€šã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨å±æ€§ã‚’å®šç¾©ã—ã¾ã™ã€‚

3. **GemmaQuestionerAgentã‚¯ãƒ©ã‚¹**ã¨**GemmaAnswererAgentã‚¯ãƒ©ã‚¹**: ã“ã‚Œã‚‰ã®ã‚¯ãƒ©ã‚¹ã¯GemmaAgentã‹ã‚‰ç¶™æ‰¿ã—ã€ãã‚Œãã‚Œè³ªå•è€…ã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç‰¹å®šã®å‹•ä½œã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ãŸã‚ã«ã€`_start_session`ã¨`_parse_response`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

4. **interleave_unequalé–¢æ•°**: ã“ã®é–¢æ•°ã¯ã€é•·ã•ã®ç•°ãªã‚‹2ã¤ã®ãƒªã‚¹ãƒˆã‚’äº¤äº’ã«ä¸¦ã¹ã¾ã™ã€‚ã‚²ãƒ¼ãƒ å†…ã§è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

5. **get_agenté–¢æ•°**: ã“ã®é–¢æ•°ã¯ã€å…¥åŠ›åï¼ˆã€Œquestionerã€ã¾ãŸã¯ã€Œanswererã€ï¼‰ã«åŸºã¥ã„ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã€è¿”ã—ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä¸€åº¦ã ã‘ä½œæˆã•ã‚Œå†åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

6. **agent_fné–¢æ•°**: ã“ã®é–¢æ•°ã¯ã€ã‚²ãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚è¦³å¯Ÿã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ä½¿ç”¨ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®šã—ã€é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®`__call__`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 25)---
```python
# !apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 26)---
```python
# !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Markdown cell (cell numver is 27)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Mohamed MZAOUALI
> 
> ã‚ˆã‚Šè‰¯ãç†è§£ã§ãã¾ã—ãŸã€ã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†!
> 
> 

---
```

** @@@ Jupyter Notebook numver 17, the number of votes :14 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§æä¾›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ç°¡å˜ãªåˆ†æï¼ˆEDAï¼‰ã‚’è¡Œã†ã‚‚ã®ã§ã™ã€‚ä¸»ãªç›®çš„ã¯ã€å›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã—ã€ãã‚Œã‚‰ã®ç‰¹æ€§ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
Notebookã¯ã€æä¾›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ä»¥ä¸‹ã®å•é¡Œã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚
1. **æ¬ æãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡ã®èª¿æŸ»**: å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆå›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼‰ã§ã®æ¬ æå€¤åŠã³é‡è¤‡ã‚’ç¢ºèªã—ã€ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚
2. **ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®åˆ†æ**: å„éƒ½å¸‚ã‚„å›½ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã«é–¢é€£ã™ã‚‹ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ•°ã‚’æŠŠæ¡ã—ã€ãã®åˆ†å¸ƒã‚’è¦–è¦šåŒ–ã—ã¾ã™ã€‚
3. **åœ°ç†çš„åˆ†æ**: å¤§é™¸ã”ã¨ã®å›½ã‚„éƒ½å¸‚ã®æ•°ã‚’èª¿ã¹ã€ãã‚Œãã‚Œã®è¡¨ç¾ãŒã©ã®ã‚ˆã†ã«åˆ†å¸ƒã—ã¦ã„ã‚‹ã‹ã‚’åˆ†æã—ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
Notebookã§ã¯ã€ä»¥ä¸‹ã®æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **Pandas**: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ‰±ã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€æ“ä½œã€å¯è¦–åŒ–ã«æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **NumPy**: åŸºæœ¬çš„ãªæ•°å€¤è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **Matplotlibï¼ˆpyplotï¼‰**: å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã‚’ç¤ºã™å††ã‚°ãƒ©ãƒ•ãªã©ã®ãƒ—ãƒ­ãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
- **JSONå‡¦ç†**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒJSONå½¢å¼ã§æä¾›ã•ã‚Œã¦ãŠã‚Šã€ãã®èª­ã¿è¾¼ã¿ã¨å‡¦ç†ã«Pythonã®çµ„ã¿è¾¼ã¿é–¢æ•°ã¨`json`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

### ä¸»ãªæµã‚Œ
1. ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ç¢ºèª
2. æ¬ æå€¤ãŠã‚ˆã³é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ
3. å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã«ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ•°ã‚’é›†è¨ˆ
4. åœ°ç†çš„åˆ†æã‚’å®Ÿæ–½ã—ã€çµæœã‚’è¦–è¦šåŒ–

ã“ã®Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹åˆæœŸãƒ‡ãƒ¼ã‚¿åˆ†æã‚’åŠ¹ç‡çš„ã«è¡Œã„ã€ãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ€§ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’ç¯‰ãã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
<a href="https://colab.research.google.com/github/mzaoualim/Kaggle_LLM_20_Questions/blob/main/Quick_EDA.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a>

# ã¯ã˜ã‚ã«
ã“ã‚Œã¯Kaggleã®[LLM 20 Questions](https://www.kaggle.com/competitions/llm-20-questions)ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç°¡å˜ã«åˆ†æã™ã‚‹ã‚‚ã®ã§ã™ã€‚

# ãƒ‡ãƒ¼ã‚¿ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
```

---The following area is a Code cell (cell numver is 2)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã„ãã¤ã‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§(inputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ—æŒ™ã§ãã¾ã™)

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€
# ã“ã‚ŒãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ "Save & Run All"ã‚’ä½¿ç”¨ã™ã‚‹ã¨å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
# ã¾ãŸã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ /kaggle/temp/ ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€
# ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ

## ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿
```

---The following area is a Code cell (cell numver is 4)---
```python
# Pythonã®çµ„ã¿è¾¼ã¿é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
f = open("/kaggle/input/llm-20-questions/llm_20_questions/keywords.py", "r")
print(f.read())
```

---The following area is a Code cell (cell numver is 5)---
```python
# ã‚ˆã‚Šè©³ç´°ãªjsonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™
import json

exec(open("/kaggle/input/llm-20-questions/llm_20_questions/keywords.py").read())
KEYWORDS_JSON = json.loads(KEYWORDS_JSON)
KEYWORDS_JSON
```

---The following area is a Code cell (cell numver is 6)---
```python
# ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®åˆè¨ˆ

print(len(KEYWORDS_JSON))
for category in KEYWORDS_JSON:
    print(category["category"], len(category["words"]))
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
## JSONã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å‡¦ç†
```

---The following area is a Code cell (cell numver is 8)---
```python
# jsonã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¸å¤‰æ›

country = pd.json_normalize(KEYWORDS_JSON[0]['words'])
city = pd.json_normalize(KEYWORDS_JSON[1]['words'])
landmark = pd.json_normalize(KEYWORDS_JSON[2]['words'])
```

---The following area is a Code cell (cell numver is 9)---
```python
country
```

---The following area is a Code cell (cell numver is 10)---
```python
city
```

---The following area is a Code cell (cell numver is 11)---
```python
landmark
```

---The following area is a Code cell (cell numver is 12)---
```python
# æ¬ æãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã—ã¾ã™
print('æ¬ æãƒ‡ãƒ¼ã‚¿ã®åˆè¨ˆ:\n',
      'å›½: ',country['keyword'].isna().sum(), '\n',
      'éƒ½å¸‚: ',city['keyword'].isna().sum(), '\n',
      'ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯: ',landmark['keyword'].isna().sum(), '\n'
      )

print('é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®åˆè¨ˆ:\n',
      'å›½: ',country['keyword'].duplicated().sum(), '\n',
      'éƒ½å¸‚: ',city['keyword'].duplicated().sum(), '\n',
      'ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯: ',landmark['keyword'].duplicated().sum(), '\n'
      )
```

---The following area is a Code cell (cell numver is 13)---
```python
# é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’èª¿æŸ»ã—ã¾ã™
## ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
landmark['keyword'].value_counts()
```

---The following area is a Code cell (cell numver is 14)---
```python
landmark[landmark['keyword'] == 'mount saint helens']
```

---The following area is a Code cell (cell numver is 15)---
```python
# é‡è¤‡è¡Œã‚’å‰Šé™¤ã—ã¾ã™

## ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
landmark.drop_duplicates(subset='keyword', keep="last", inplace=True)
landmark['keyword'].duplicated().sum()
```

---The following area is a Code cell (cell numver is 16)---
```python
# é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™
## éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

city['keyword'].duplicated().sum()
city.drop_duplicates(subset='keyword', keep="last", inplace=True)
city['keyword'].duplicated().sum()
```

---The following area is a Markdown cell (cell numver is 17)---
```markdown
## ALTSåˆ†æ
```

---The following area is a Code cell (cell numver is 18)---
```python
# altsåˆ†æ
## è¤‡æ•°ã®ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã¤å›½ã€éƒ½å¸‚ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
### éƒ½å¸‚
```

---The following area is a Code cell (cell numver is 20)---
```python
# æœ€ã‚‚ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¤šã„éƒ½å¸‚
city
```

---The following area is a Code cell (cell numver is 21)---
```python
# {éƒ½å¸‚:å¯¾å¿œã™ã‚‹ãƒ©ãƒ™ãƒ«ã®æ•°}ã®è¾æ›¸ã‚’ç”Ÿæˆ
city_alts_dict = dict()
for i in range(len(city)):
  city_alts_dict[city.iloc[i, 0]] = len(str(city.iloc[i, 1]).strip('[]').split(','))
```

---The following area is a Code cell (cell numver is 22)---
```python
city_alts_dict
```

---The following area is a Code cell (cell numver is 23)---
```python
# è¾æ›¸ã‹ã‚‰pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
city_alts_df = pd.DataFrame.from_dict(city_alts_dict, orient='index', columns=['len_alts'])
city_alts_df.reset_index(inplace=True)
```

---The following area is a Code cell (cell numver is 24)---
```python
city_alts_df.rename(columns={'index':'city_labels'}, inplace=True)
```

---The following area is a Code cell (cell numver is 25)---
```python
city_alts_df
```

---The following area is a Code cell (cell numver is 26)---
```python
# ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã£ã¦éƒ½å¸‚ã‚’ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
grouped_city_alts_df = city_alts_df.groupby('len_alts').count()
grouped_city_alts_df
```

---The following area is a Code cell (cell numver is 27)---
```python
# ä»£æ›¿ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã‚‹éƒ½å¸‚ã®åˆ†å¸ƒã‚’ãƒ—ãƒ­ãƒƒãƒˆ
grouped_city_alts_df.plot(
    kind='pie',
    title='å˜ä¸€å¯¾è¤‡æ•°ä»£æ›¿ãƒ©ãƒ™ãƒ«ã®ã‚ã‚‹éƒ½å¸‚',
    ylabel='',
    legend=False,
    subplots=True,
    autopct='%1.1f%%'
    )
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
ãƒªã‚¹ãƒˆã•ã‚ŒãŸéƒ½å¸‚ã®88%ä»¥ä¸Šï¼ˆ278éƒ½å¸‚ï¼‰ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ©ãƒ™ãƒ«ã‚’æŒã¡ã€1ã¤ã®éƒ½å¸‚ï¼ˆãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹ï¼‰ã¯7ã¤ï¼ˆ7ï¼‰ã®ä»£æ›¿ãƒ©ãƒ™ãƒ«ã§è¡¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### å›½
```

---The following area is a Code cell (cell numver is 29)---
```python
# æœ€ã‚‚ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¤šã„å›½
country
```

---The following area is a Code cell (cell numver is 30)---
```python
# {å›½:å¯¾å¿œã™ã‚‹ãƒ©ãƒ™ãƒ«ã®æ•°}ã®è¾æ›¸ã‚’ç”Ÿæˆ
country_alts_dict = dict()
for i in range(len(country)):
  country_alts_dict[country.iloc[i, 0]] = len(str(country.iloc[i, 1]).strip('[]').split(','))

country_alts_dict
```

---The following area is a Code cell (cell numver is 31)---
```python
max(country_alts_dict.values())
```

---The following area is a Code cell (cell numver is 32)---
```python
# è¾æ›¸ã‹ã‚‰pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
country_alts_df = pd.DataFrame.from_dict(country_alts_dict, orient='index', columns=['len_alts'])
country_alts_df.reset_index(inplace=True)
country_alts_df.rename(columns={'index':'city_labels'}, inplace=True)
```

---The following area is a Code cell (cell numver is 33)---
```python
# ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã£ã¦å›½ã‚’ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
grouped_country_alts_df = country_alts_df.groupby('len_alts').count()
grouped_country_alts_df
```

---The following area is a Code cell (cell numver is 34)---
```python
# ä»£æ›¿ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã‚‹å›½ã®åˆ†å¸ƒã‚’ãƒ—ãƒ­ãƒƒãƒˆ
grouped_country_alts_df.plot(
    kind='pie',
    title='å˜ä¸€å¯¾è¤‡æ•°ä»£æ›¿ãƒ©ãƒ™ãƒ«ã®å›½',
    ylabel='',
    legend=False,
    subplots=True,
    autopct='%1.1f%%'
    )
```

---The following area is a Markdown cell (cell numver is 35)---
```markdown
ã¾ãŸã€97%ï¼ˆ195ï¼‰ã®å›½ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ©ãƒ™ãƒ«ã§è¡¨ã•ã‚Œã€3ã¤ãŒ2ã¤ã®ãƒ©ãƒ™ãƒ«ã€2ã¤ãŒ3ã¤ã®ãƒ©ãƒ™ãƒ«ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

### ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
```

---The following area is a Code cell (cell numver is 36)---
```python
# æœ€ã‚‚ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¤šã„ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
landmark
```

---The following area is a Code cell (cell numver is 37)---
```python
# {ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯:å¯¾å¿œã™ã‚‹ãƒ©ãƒ™ãƒ«ã®æ•°}ã®è¾æ›¸ã‚’ç”Ÿæˆ
landmark_alts_dict = dict()
for i in range(len(landmark)):
  landmark_alts_dict[landmark.iloc[i, 0]] = len(str(landmark.iloc[i, 1]).strip('[]').split(','))

landmark_alts_dict
```

---The following area is a Code cell (cell numver is 38)---
```python
max(landmark_alts_dict.values())
```

---The following area is a Code cell (cell numver is 39)---
```python
# è¾æ›¸ã‹ã‚‰pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
landmark_alts_df = pd.DataFrame.from_dict(landmark_alts_dict, orient='index', columns=['len_alts'])
landmark_alts_df.reset_index(inplace=True)
landmark_alts_df.rename(columns={'index':'landmark_labels'}, inplace=True)
```

---The following area is a Code cell (cell numver is 40)---
```python
# ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã£ã¦ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
grouped_landmark_alts_df = landmark_alts_df.groupby('len_alts').count()
grouped_landmark_alts_df
```

---The following area is a Code cell (cell numver is 41)---
```python
# ä»£æ›¿ãƒ©ãƒ™ãƒ«æ•°ã«ã‚ˆã‚‹å›½ã®åˆ†å¸ƒã‚’ãƒ—ãƒ­ãƒƒãƒˆ
grouped_landmark_alts_df.plot(
    kind='pie',
    title='ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®å˜ä¸€å¯¾è¤‡æ•°ä»£æ›¿ãƒ©ãƒ™ãƒ«',
    ylabel='',
    legend=False,
    subplots=True,
    autopct='%1.1f%%'
    )
```

---The following area is a Markdown cell (cell numver is 42)---
```markdown
å†ã³ã€ã»ã¨ã‚“ã©ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆ83%ã¾ãŸã¯40ï¼‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ©ãƒ™ãƒ«ã§è¡¨ã•ã‚Œã€16%ï¼ˆ8ï¼‰ã¯äºŒé‡ã®è¿½åŠ ãƒ©ãƒ™ãƒ«ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

## åœ°ç†çš„åˆ†æ
```

---The following area is a Code cell (cell numver is 43)---
```python
# åœ°ç†åˆ†æ
## å¤§é™¸ã®è¡¨ç¾
## è¤‡æ•°ã®éƒ½å¸‚ã‚’æŒã¤å›½
```

---The following area is a Markdown cell (cell numver is 44)---
```markdown
### å¤§é™¸ã«ã‚ˆã‚‹å›½ã®è¡¨ç¾
```

---The following area is a Code cell (cell numver is 45)---
```python
# å›½ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™
country_by_continent = pd.read_html('https://worldpopulationreview.com/country-rankings/list-of-countries-by-continent')[4].copy()
```

---The following area is a Code cell (cell numver is 46)---
```python
country_by_continent = country_by_continent[['Country', 'Continent']]
```

---The following area is a Code cell (cell numver is 47)---
```python
# å¤§é™¸ã”ã¨ã®å›½
country_by_continent.Continent.value_counts().plot(
    kind='pie',
    ylabel='',
    xlabel='',
    title='å¤§é™¸ã”ã¨ã®ä¸–ç•Œã®å›½',
    autopct='%1.1f%%')
```

---The following area is a Code cell (cell numver is 48)---
```python
country_by_continent['Country'] = country_by_continent.Country.str.lower()
```

---The following area is a Code cell (cell numver is 49)---
```python
country_by_continent
```

---The following area is a Code cell (cell numver is 50)---
```python
# å¤§é™¸ã”ã¨ã®å›½ã®åˆ†å¸ƒ
country_by_continent.Continent.value_counts(normalize=True)
```

---The following area is a Code cell (cell numver is 51)---
```python
# é‡è¤‡ã™ã‚‹å›½ã¯ï¼Ÿ
country_by_continent.Country.duplicated().sum()
```

---The following area is a Code cell (cell numver is 52)---
```python
# æ¬ æå€¤
country_by_continent.Country.isna().sum()
```

---The following area is a Code cell (cell numver is 53)---
```python
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ãŠã‘ã‚‹å¤§é™¸ã®è¡¨ç¾
country.merge(
    country_by_continent,
    how='left',
    left_on='keyword',
    right_on='Country')['Continent'].value_counts() #.plot(kind='pie')
```

---The following area is a Code cell (cell numver is 54)---
```python
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ãŠã‘ã‚‹å¤§é™¸ã®è¡¨ç¾ã‚’ãƒ—ãƒ­ãƒƒãƒˆ

country.merge(
    country_by_continent,
    how='left',
    left_on='keyword',
    right_on='Country')['Continent'].value_counts().plot(kind='pie',
                                                         title= 'å¤§é™¸ã”ã¨ã®å›½',
                                                         xlabel='',
                                                         ylabel='',
                                                         autopct='%1.1f%%')
```

---The following area is a Markdown cell (cell numver is 55)---
```markdown
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ã¯å„å¤§é™¸ãŒå…¬å¹³ã«è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

### å¤§é™¸ã«ã‚ˆã‚‹éƒ½å¸‚ã®è¡¨ç¾
```

---The following area is a Code cell (cell numver is 56)---
```python
# ä¸–ç•Œã®éƒ½å¸‚ã‚’åé›†ã—ã¾ã™
data = pd.DataFrame(columns=['Name', 'Country'])
for i in range(1, 563):
  data = pd.concat([data, pd.read_html(f'https://geokeo.com/database/city/{i}/')[0][['Name', 'Country']]])
```

---The following area is a Code cell (cell numver is 57)---
```python
data
```

---The following area is a Code cell (cell numver is 58)---
```python
# ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™
data.to_csv('world_cities.csv')
```

---The following area is a Code cell (cell numver is 59)---
```python
# å‰å‡¦ç†
data['Name'] = data.Name.str.lower()
data
```

---The following area is a Code cell (cell numver is 60)---
```python
data['Country'] = data.Country.str.lower()
data
```

---The following area is a Code cell (cell numver is 61)---
```python
city
```

---The following area is a Code cell (cell numver is 62)---
```python
cities = city.copy()
```

---The following area is a Code cell (cell numver is 63)---
```python
cities
```

---The following area is a Code cell (cell numver is 64)---
```python
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰éƒ½å¸‚åã‚’æŠ½å‡º
for i in cities.index:
  cities.loc[i, 'city'] = cities.loc[i, 'keyword'].split(' ')[0]
cities
```

---The following area is a Code cell (cell numver is 65)---
```python
# éƒ½å¸‚ã®å›½ã‚’æŠ½å‡º
cities.merge(
    data,
    how='left',
    left_on='city',
    right_on='Name')['Country'].value_counts()
```

---The following area is a Code cell (cell numver is 66)---
```python
cities.merge(
    data,
    how='left',
    left_on='city',
    right_on='Name')['Country'].value_counts().plot(kind='pie',
                                                         title= 'å›½ã”ã¨ã®éƒ½å¸‚',
                                                         xlabel='',
                                                         ylabel='',
                                                         autopct='%1.1f%%')
```

---The following area is a Markdown cell (cell numver is 67)---
```markdown
å°‘ã—æ··ä¹±ã—ã¦ã„ã¾ã™ãŒã€åŒ—ã‚¢ãƒ¡ãƒªã‚«ï¼ˆç±³å›½ + ã‚«ãƒŠãƒ€ + ãƒ¡ã‚­ã‚·ã‚³ï¼‰ãŒãƒªã‚¹ãƒˆã•ã‚ŒãŸéƒ½å¸‚ã®ç´„1/4ã‚’å ã‚ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 68)---
```python
country_by_continent
```

---The following area is a Code cell (cell numver is 69)---
```python
# éƒ½å¸‚åã«åŸºã¥ã„ã¦å¤§é™¸ã‚’æŠ½å‡º
cities_countries = cities.merge(
                      data,
                      how='left',
                      left_on='city',
                      right_on='Name'
                      )

cities_countries['countries'] = cities_countries.Country.str.lower()
cities_countries.drop(columns='Country', inplace=True)

cities_countries.merge(
                    country_by_continent,
                    how='left',
                    left_on='countries',
                    right_on='Country'
                    )
```

---The following area is a Code cell (cell numver is 70)---
```python
# éƒ½å¸‚ã«åŸºã¥ã„ã¦å¤§é™¸ã®è¡¨ç¾ã‚’æç¤º
cities_countries.merge(
                    country_by_continent,
                    how='left',
                    left_on='countries',
                    right_on='Country'
                    )['Continent'].value_counts().plot(kind='pie',
                                                      title='éƒ½å¸‚ã«åŸºã¥ãå¤§é™¸ã®è¡¨ç¾',
                                                      xlabel='',
                                                      ylabel='',
                                                      autopct='%1.1f%%')
```

---The following area is a Markdown cell (cell numver is 71)---
```markdown
éƒ½å¸‚ã®3åˆ†ã®2ãŒãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã¨ã‚¢ã‚¸ã‚¢ã‹ã‚‰ã®ã‚‚ã®ã§ã‚ã‚Šã€ä»–ã®å¤§é™¸ã¯å°‘ãªã„è¡¨ç¾ã§ã™ã€‚

# ãƒªã‚½ãƒ¼ã‚¹

[LLM 20 Questions - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰](https://www.kaggle.com/code/docxian/llm-20-questions-keywords/notebook)

[[LLM 20 Questions] EDAãƒãƒƒãƒ—ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰](https://www.kaggle.com/code/waechter/llm-20-questions-eda-map-keywords)
```

---The following area is a Markdown cell (cell numver is 72)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## OminousDude
> 
> ã¨ã¦ã‚‚å½¹ç«‹ã¡ã¾ã—ãŸï¼ç§ã®ãƒ¢ãƒ‡ãƒ«ã«åŠ©ã‘ã«ãªã‚Šã¾ã—ãŸï¼
> 
> 

---

> ## waechter
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ 
> 
> å›½ã¨éƒ½å¸‚ã®è¿½åŠ ãŒæ°—ã«å…¥ã£ã¦ã„ã¾ã™ã€‚

---

> ## Payam Amanat
> 
> ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«é–¢ã™ã‚‹ç´ æ™´ã‚‰ã—ã„è¦–è¦šåŒ–ã¨EDA[@mzaoualim](https://www.kaggle.com/mzaoualim)ã«æŠ•ç¥¨ã—ã¾ã—ãŸã€‚
> 
> 

> > ## Mohamed MZAOUALITopic Author
> > 
> > ã‚ã‚ŠãŒã¨ã†ï¼
> > 
> > 

---
```

** @@@ Jupyter Notebook numver 18, the number of votes :13 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€AIãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆè³ªå•è€…ãŠã‚ˆã³å›ç­”è€…ï¼‰ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆValidation Episode failedï¼‰ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã¾ã™ãŒã€æ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€æå‡ºç”¨ã®`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

### ä¸»ãªèª²é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¸ãˆã‚‰ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’æ¨æ¸¬ã•ã›ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé©åˆ‡ã«é€£æºã—ãªãŒã‚‰è³ªå•ã‚’è¡Œã£ãŸã‚Šã€å›ç­”ã‚’æä¾›ã—ãŸã‚Šã™ã‚‹å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã¾ã™ã€‚ã“ã®ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªã‚„ã‚Šå–ã‚Šã‚’é€šã˜ã¦ã€ã§ãã‚‹ã ã‘æ—©ãã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒç›®æŒ‡ã•ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ä»¥ä¸‹ã®æ‰‹æ³•ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦å•é¡Œã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ã¦ã„ã¾ã™ï¼š

1. **Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: 
   - `immutabledict`ã¨`sentencepiece`ã‚’ä½¿ç”¨ã—ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã‚’å›³ã£ã¦ã„ã¾ã™ã€‚
   - GitHubã‹ã‚‰`gemma_pytorch`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¿…è¦ãªè¨­å®šã‚’æ•´ãˆã¦ã„ã¾ã™ã€‚

2. **GemmaFrameworkã®ä½¿ç”¨**: 
   - `GemmaForCausalLM`ã‚’åˆ©ç”¨ã—ã¦è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åŠ¹æœçš„ã«æ©Ÿèƒ½ã•ã›ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®šç¾©**:
   - `GemmaAgent`ã‚¯ãƒ©ã‚¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ`GemmaQuestionerAgent`ï¼‰ã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ`GemmaAnswererAgent`ï¼‰ã‚’å®šç¾©ã€‚
   - ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘å–ã‚Šã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«åŸºã¥ã„ã¦å‹•çš„ã«å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

4. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°**:
   - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«é–“ã®ä¼šè©±ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã€é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

5. **åœ§ç¸®ã¨ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†**:
   - `pigz`ã¨`pv`ã‚’åˆ©ç”¨ã—ã¦ä½œæˆã—ãŸåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’Kaggleã«æå‡ºã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’æ•´ãˆã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®é€Ÿåº¦ãŒå‘ä¸Šã—ã€ãã®é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å…¨ä½“ã‚’é€šã˜ã¦ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹LLMã®é©ç”¨ã¨ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰æ‰‹æ³•ãŒè©³ç´°ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚æˆåŠŸã™ã‚Œã°ã€AIã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç™ºæ®ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
2024å¹´5æœˆ20æ—¥

* **ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€*Validation Episode failed*ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚**

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions**ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ã€*Output*ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz`ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹**Submit Agent**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æå‡ºã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
**ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ä½œæ¥­ç’°å¢ƒã‚’è¨­å®šã—ã€å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGitHubãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’è¡Œã†Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚ä»¥ä¸‹ã¯å„è¡Œã®è©³ç´°ãªèª¬æ˜ã§ã™ï¼š
1. `%%bash`:
   - ã“ã‚Œã¯Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ä½¿ã‚ã‚Œã‚‹ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã§ã€ä»¥ä¸‹ã®è¡ŒãŒBashã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
2. `cd /kaggle/working`:
   - ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’`/kaggle/working`ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€Kaggleã‚«ãƒ¼ãƒãƒ«ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼‰ã§è¨ˆç®—ä¸­ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã‚ˆãä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
3. `pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece`:
   - `pip`ã‚’ä½¿ç”¨ã—ã¦ã€`immutabledict`ã¨`sentencepiece`ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é™ã‹ã«ï¼ˆ`-q`ï¼‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼ˆ`-U`ã¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®æ„å‘³ï¼‰ã€‚
   - `-t /kaggle/working/submission/lib`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚
4. `git clone https://github.com/google/gemma_pytorch.git > /dev/null`:
   - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
   - `> /dev/null`éƒ¨åˆ†ã¯ã€å‡ºåŠ›ã‚’`/dev/null`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«ã—ã¦ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›ã‚’ãã‚Œã„ã«ä¿ã¡ã¾ã™ã€‚
5. `mkdir /kaggle/working/submission/lib/gemma/`:
   - `/kaggle/working/submission/lib/`å†…ã«ã€`gemma`ã¨ã„ã†åå‰ã®æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
6. `mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/`:
   - ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸ`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªå†…ã®`gemma`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`*`ï¼‰ã‚’æ–°ã—ãä½œæˆã—ãŸ`gemma`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™ã€‚
### ã¾ã¨ã‚
- ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®šã—ã¾ã™ã€‚
- `immutabledict`ã¨`sentencepiece`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç‰¹å®šã®ãƒ‘ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- GitHubã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
- ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
- å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ãä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™ã€‚
ã“ã®è¨­å®šã¯ã€æ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã‚„Kaggleãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã®ãã®ä»–ã®è¨ˆç®—ã‚¿ã‚¹ã‚¯ã«å¿…è¦ãªç‰¹å®šã®ä¾å­˜é–¢ä¿‚ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æº–å‚™ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile submission/main.py
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’ã“ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãã ã•ã„
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable


class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        return self._state

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self

    def reset(self):
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re


@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)


class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant

        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        # ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        # å¿œç­”ã‹ã‚‰**ã§å›²ã¾ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã™
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError


def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„ã€‚äºˆæƒ³ã‚’**ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("æœªçŸ¥ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã™ã€‚ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«é–¢ã™ã‚‹è³ªå•ã§ã™ã€‚ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚ç­”ãˆã‚’**ã§å›²ã‚“ã§ãã ã•ã„**ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        # å¿œç­”ã‹ã‚‰è§£æã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã‚’è¿”ã—ã¾ã™
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
**ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å‹•ä½œã‚’å®šç¾©ã—ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è³ªå•è€…ã¾ãŸã¯å›ç­”è€…ã®ã„ãšã‚Œã‹ã«ãªã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®å„éƒ¨åˆ†ã«ã¤ã„ã¦ã®è©³ç´°ãªèª¬æ˜ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
### 1. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```python
%%writefile submission/main.py
```
- ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’`submission`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®`main.py`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚
### 2. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```python
import os
import sys
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")
```
- å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
- ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨Kaggleã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
### 3. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŠã‚ˆã³è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
```python
import contextlib
from pathlib import Path
import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM
if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"
```
- è¿½åŠ ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
- ç’°å¢ƒã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
### 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚¯ãƒ©ã‚¹
```python
import itertools
from typing import Iterable
class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'
    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()
    def __repr__(self):
        return self._state
    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self
    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self
    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self
    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self
    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self
    def reset(self):
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self
    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self
```
- `GemmaFormatter`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«é–“ã®ä¼šè©±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ä¼šè©±ã®ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã¨çµ‚äº†ã‚’ç¤ºã™ãŸã‚ã«å®šç¾©ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ãŸã‚Šã€ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã¨çµ‚äº†ã‚’ç®¡ç†ã—ãŸã‚Šã€ä¼šè©±ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚
### 5. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
```python
import re
@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)
class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)
        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant
        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()
    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response
    def _start_session(self, obs: dict):
        raise NotImplementedError
    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
                }
        # ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response
    def _parse_keyword(self, response: str):
        # å¿œç­”ã‹ã‚‰**ã§å›²ã¾ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã™
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword
    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError
def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]
```
- `GemmaAgent`ã‚¯ãƒ©ã‚¹ã¯ã€ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¢ãƒ‡ãƒ«ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã—ã¾ã™ã€‚
- `_set_default_tensor_type`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã¯ã€PyTorchã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’ä¸€æ™‚çš„ã«è¨­å®šã—ã¾ã™ã€‚
- `__call__`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€è¦³å¯Ÿå€¤ï¼ˆ`obs`ï¼‰ã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
- `_start_session`ã¨`_parse_response`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã«ã‚ˆã£ã¦å®Ÿè£…ã•ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§ã™ã€‚
- `interleave_unequal`é–¢æ•°ã¯ã€2ã¤ã®ãƒªã‚¹ãƒˆã‹ã‚‰è¦ç´ ã‚’äº¤äº’ã«ä¸¦ã¹ã€ãã‚Œãã‚Œã®ãƒªã‚¹ãƒˆã«å¤šãã®è¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯æ®‹ã‚Šã®è¦ç´ ã§åŸ‹ã‚ã¾ã™ã€‚
### 6. è³ªå•è€…ã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
```python
class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„ã€‚äºˆæƒ³ã‚’**ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()
    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("æœªçŸ¥ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)
class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã™ã€‚ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«é–¢ã™ã‚‹è³ªå•ã§ã™ã€‚ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚ç­”ãˆã‚’**ã§å›²ã‚“ã§ãã ã•ã„**ã€‚")
        self.formatter.start_model_turn()
    def _parse_response(self, response: str, obs: dict):
        # å¿œç­”ã‹ã‚‰è§£æã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã‚’è¿”ã—ã¾ã™
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'
```

---The following area is a Code cell (cell numver is 6)---
```python
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã‹ã‚‰ã®ã¯ã„/ã„ã„ãˆè³ªå•ã«å¿œã˜ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ãã‚Œã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ã§ã™ï¼",
]


# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦ã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# ä¸¡æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ã¨ã€OOMï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ï¼‰ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None


def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent


def agent_fn(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã«åŸºã¥ã„ã¦å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¾ã™
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    if response is None or len(response) <= 1:
        return "ã¯ã„"
    else:
        return response
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
**ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**
ã“ã®ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã¨ç®¡ç†ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹æ–¹æ³•ã¨ã€æä¾›ã•ã‚ŒãŸè¦³å¯Ÿã«åŸºã¥ã„ã¦ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹æ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯è©³ç´°ãªèª¬æ˜ã§ã™ï¼š
### 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å°‘æ•°ã‚·ãƒ§ãƒƒãƒˆã®ä¾‹ã®å®šç¾©
```python
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã‹ã‚‰ã®ã¯ã„/ã„ã„ãˆè³ªå•ã«å¿œã˜ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"
few_shot_examples = [
    "20ã®è³ªå•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ãã‚Œã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ã§ã™ï¼",
]
```
- `system_prompt`: AIã«20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ã¤ã„ã¦ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚
- `few_shot_examples`: AIãŒã‚²ãƒ¼ãƒ ã®å½¢å¼ã¨å¿œç­”ã®ä»•æ–¹ã‚’ç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¤ä¸€é€£ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®å°‘æ•°ã‚·ãƒ§ãƒƒãƒˆå­¦ç¿’ã¯ã€ãƒ¢ãƒ‡ãƒ«ãŒã„ãã¤ã‹ã®ä¾‹ã‹ã‚‰ä¸€èˆ¬åŒ–ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
### 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤‰æ•°
```python
agent = None
```
- ç¾åœ¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°`agent`ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¤‡æ•°å›ãƒ­ãƒ¼ãƒ‰ã›ãšã«æ¸ˆã¿ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ï¼ˆOOMï¼‰ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¾ã™ã€‚
### 3. é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®é–¢æ•°
```python
def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    return agent
```
- `get_agent(name: str)`: æŒ‡å®šã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ`questioner`ã¾ãŸã¯`answerer`ï¼‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™é–¢æ•°ã§ã™ã€‚
    - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª`agent`å¤‰æ•°ãŒ`None`ã§ã‚ã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒ`questioner`ã®å ´åˆã€`GemmaQuestionerAgent`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
    - åŒæ§˜ã«ã€`answerer`ã®å ´åˆã¯`GemmaAnswererAgent`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
    - ä¸¡æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¯ã€`system_prompt`ã¨`few_shot_examples`ã‚’ä½¿ã£ã¦åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿…ãšè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã€åˆæœŸåŒ–ã‚’è©¦ã¿ãŸå¾Œã«`agent`ãŒ`None`ã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
### 4. ä¸»ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°
```python
def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    if response is None or len(response) <= 1:
        return "ã¯ã„"
    else:
        return response
```
- `agent_fn(obs, cfg)`: ã‚²ãƒ¼ãƒ ã®ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆ`obs`ï¼‰ã«åŸºã¥ã„ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã™ã‚‹ä¸»é–¢æ•°ã§ã™ã€‚
    - `obs.turnType`ãŒ`"ask"`ã®å ´åˆã€`questioner`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¦è³ªå•ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    - `obs.turnType`ãŒ`"guess"`ã®å ´åˆã€`questioner`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¦äºˆæƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    - `obs.turnType`ãŒ`"answer"`ã®å ´åˆã€`answerer`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¦ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    - å¿…è¦ã«å¿œã˜ã¦`get_agent`ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ãŒ`None`ã¾ãŸã¯éå¸¸ã«çŸ­ã„å ´åˆã€"ã¯ã„"ã‚’è¿”ã™ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŒ–ã—ã¾ã™ã€‚
    - ãã†ã§ãªã‘ã‚Œã°ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã—ãŸå¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚
### ã¾ã¨ã‚
- ã“ã®ã‚³ãƒ¼ãƒ‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ç®¡ç†ã—ã¾ã™ã€‚
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä¾‹ã‚’å®šç¾©ã—ã¾ã™ã€‚
- ãƒ¡ãƒ¢ãƒªã®å•é¡Œã‚’é˜²ããŸã‚ã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ1ã¤ã ã‘ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- `get_agent`é–¢æ•°ã¯å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’å‹•çš„ã«åˆæœŸåŒ–ã—ã¾ã™ã€‚
- `agent_fn`é–¢æ•°ã¯ã€ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
**ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**
ã“ã®1è¡Œã®ã‚³ãƒ¼ãƒ‰ã¯ã€`apt`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ç”¨ã„ã¦`pigz`ã¨`pv`ã®2ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã¯è©³ç´°ãªèª¬æ˜ã§ã™ï¼š
### ã‚³ãƒãƒ³ãƒ‰ã®å†…è¨³
```bash
!apt install pigz pv > /dev/null
```
#### 1. `!`
- è¡Œã®å…ˆé ­ã«ã‚ã‚‹`!`ã¯ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚·ã‚§ãƒ«ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã¯ Jupyter ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã®ç‰¹å¾´ã§ã€ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«ã‹ã‚‰ç›´æ¥ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
#### 2. `apt install pigz pv`
- `apt`: ã“ã‚Œã¯ã€Debianç³»Linuxãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šUbuntuï¼‰ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹Advanced Package Toolï¼ˆAPTï¼‰ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚
- `install`: ã“ã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã¯ã€1ã¤ã¾ãŸã¯è¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ã“ã¨ã‚’aptã«æŒ‡ç¤ºã—ã¾ã™ã€‚
- `pigz`: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æœ€åˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åå‰ã§ã™ã€‚`pigz`ã¯ã€Œgzipã®ä¸¦åˆ—å®Ÿè£…ã€ã‚’æ„å‘³ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€å¾“æ¥ã®`gzip`ã‚ˆã‚Šã‚‚é€Ÿããƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã§ãã¾ã™ã€‚
- `pv`: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹2ç•ªç›®ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åå‰ã§ã™ã€‚`pv`ã¯ã€ŒPipe Viewerã€ã‚’æ„å‘³ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‘ã‚¤ãƒ—ã‚’ä»‹ã‚‹ãƒ‡ãƒ¼ã‚¿ã®é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–ã§ãã‚‹ç«¯æœ«ãƒ™ãƒ¼ã‚¹ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿è»¢é€ã®é€²æ—ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç‡ã€ãŠã‚ˆã³å®Œäº†ã¾ã§ã®æ¨å®šæ™‚é–“ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
#### 3. `> /dev/null`
- ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®éƒ¨åˆ†ã¯ã€æ¨™æº–å‡ºåŠ›ï¼ˆstdoutï¼‰ã‚’`/dev/null`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
- `/dev/null`ã¯ã€Unixç³»ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ç‰¹åˆ¥ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚Šã€æ›¸ãè¾¼ã¾ã‚ŒãŸã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„ã—ã¾ã™ã€‚é€šå¸¸ã€è¡¨ç¤ºã—ãŸããªã„å‡ºåŠ›ã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ã“ã®æ–‡è„ˆã§ã¯ã€`> /dev/null`ã«ã‚ˆã‚Šã€`apt install`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã„ã‹ãªã‚‹å‡ºåŠ›ï¼ˆä¾‹ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®é€²è¡ŒçŠ¶æ³ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ãŒç«¯æœ«ã‚„Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
### ã‚³ãƒãƒ³ãƒ‰ã®ç›®çš„
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®ç›®çš„ã¯ã€`pigz`ã¨`pv`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é™ã‹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã™ã€‚å‡ºåŠ›ã‚’è¡¨ç¤ºã›ãšã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚»ãƒ«ã«ãŠã„ã¦ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ­ã‚°ã§å‡ºåŠ›ãŒæ··é›‘ã™ã‚‹ã“ã¨ã‚’é˜²ãã®ã«ä¾¿åˆ©ã§ã™ã€‚
### å®Ÿç”¨ä¾‹
- **`pigz`**: å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿…é€Ÿã«åœ§ç¸®ã™ã‚‹éš›ã«ã€è¤‡æ•°ã®CPUã‚³ã‚¢ã‚’æ´»ç”¨ã§ãã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚
- **`pv`**: é•·æ™‚é–“ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã„ã¦ãƒ‡ãƒ¼ã‚¿ã®é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–ã™ã‚‹éš›ã«å½¹ç«‹ã¡ã¾ã™ã€‚
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€å¾Œã®å‡¦ç†ã®ãŸã‚ã«ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«åˆ©ç”¨å¯èƒ½ã«ã—ã¤ã¤ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å‡ºåŠ›ã‚’æ··ä¹±ã•ã›ãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
**ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**
ã“ã®ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã¯ã€`pigz`ã¨`pv`ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€åœ§ç¸®ã•ã‚ŒãŸtarãƒœãƒ¼ãƒ«ï¼ˆ`submission.tar.gz`ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ã‚³ãƒãƒ³ãƒ‰ã®å„éƒ¨åˆ†ã®è©³ç´°ãªå†…è¨³ã§ã™ï¼š
### ã‚³ãƒãƒ³ãƒ‰ã®å†…è¨³
```bash
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```
#### 1. `!`
- ã“ã®æ–‡å­—ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚·ã‚§ãƒ«ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã§ã™ã€‚
#### 2. `tar`
- `tar`ã‚³ãƒãƒ³ãƒ‰ã¯ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä½œæˆã€ç¶­æŒã€å¤‰æ›´ã€ãŠã‚ˆã³æŠ½å‡ºã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
#### 3. `--use-compress-program='pigz --fast --recursive | pv'`
- ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä½¿ç”¨ã™ã‚‹åœ§ç¸®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®å ´åˆã¯ã€`pigz`ã‚’`pv`ã§ãƒ‘ã‚¤ãƒ—ã§æ¥ç¶šã—ã¾ã™ã€‚
- `'pigz --fast --recursive'`: `pigz`ï¼ˆgzipã®ä¸¦åˆ—å®Ÿè£…ï¼‰ã‚’ä½¿ç”¨ã—ã¦åœ§ç¸®ã—ã¾ã™ã€‚`--fast`ãƒ•ãƒ©ã‚°ã¯ã€åœ§ç¸®ç‡ã‚ˆã‚Šã‚‚é€Ÿåº¦ã‚’å„ªå…ˆã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã—ã€`--recursive`ã¯ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‡¦ç†ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
- `'| pv'`: `pigz`ã®å‡ºåŠ›ã‚’`pv`ã«ãƒ‘ã‚¤ãƒ—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šåœ§ç¸®ã®é€²è¡Œã‚’ç›£è¦–ã§ãã¾ã™ã€‚
#### 4. `-cf submission.tar.gz`
- `-c`: æ–°ã—ã„ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆã—ã¾ã™ã€‚
- `-f submission.tar.gz`: ä½œæˆã™ã‚‹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’æŒ‡å®šã—ã¾ã™ï¼ˆ`submission.tar.gz`ï¼‰ã€‚
#### 5. `-C /kaggle/working/submission .`
- `-C /kaggle/working/submission`: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹å‰ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’`/kaggle/working/submission`ã«å¤‰æ›´ã—ã¾ã™ã€‚
- `.`: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä»Šã¯`/kaggle/working/submission`ï¼‰ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã—ã¾ã™ã€‚
#### 6. `-C /kaggle/input/ gemma/pytorch/7b-it-quant/2`
- `-C /kaggle/input/`: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã™ã‚‹å‰ã«ã€`/kaggle/input/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã—ã¾ã™ã€‚
- `gemma/pytorch/7b-it-quant/2`: `/kaggle/input/`å†…ã®`gemma/pytorch/7b-it-quant/2`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã—ã¾ã™ã€‚
### ã‚³ãƒãƒ³ãƒ‰ã®ç›®çš„
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ä»¥ä¸‹ã‚’å«ã‚€åœ§ç¸®tarãƒœãƒ¼ãƒ«ï¼ˆ`submission.tar.gz`ï¼‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š
1. `/kaggle/working/submission`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€‚
2. `/kaggle/input/`ã‹ã‚‰ã®`gemma/pytorch/7b-it-quant/2`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€‚
`pigz`ã‚’ä½¿ç”¨ã—ã¦åœ§ç¸®ã™ã‚‹ã“ã¨ã§ã€ãƒãƒ«ãƒCPUã‚³ã‚¢ã«ã‚ˆã‚‹ã‚ˆã‚Šé«˜é€Ÿãªåœ§ç¸®ã‚’å®Ÿç¾ã—ã€`pv`ãŒåœ§ç¸®ã®é€²è¡Œã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚
### å®Ÿç”¨ä¾‹
- **åœ§ç¸®é€Ÿåº¦**: `pigz`ã¯è¤‡æ•°ã®CPUã‚³ã‚¢ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€åœ§ç¸®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åŠ é€Ÿã•ã›ã¾ã™ã€‚
- **é€²è¡ŒçŠ¶æ³ã®ç›£è¦–**: `pv`ã¯åœ§ç¸®é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–ã—ã€ãƒ—ãƒ­ã‚»ã‚¹ã®é€²æ—ã‚’è¦–è¦šçš„ã«ç¤ºã™ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
- **ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**: `-C`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãªãã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã€æŸ”è»Ÿã«è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã•ã‚Œã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Matin Mahmoudi âœ¨
> 
> ç´ æ™´ã‚‰ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã€å®Ÿè£…ã«é–¢ã™ã‚‹æƒ…å ±ãŒè±Šå¯Œã§ã™ [@regisvargas](https://www.kaggle.com/regisvargas)ã€‚ã‚ãªãŸã®ä»–ã®ä½œå“ã‚‚ãƒã‚§ãƒƒã‚¯ã—ã€ã™ã¹ã¦ã«æŠ•ç¥¨ã—ã¾ã—ãŸã€‚ã™ã”ã„ã€å‹é”ï¼
> 
> 
> 
> > ## Regis Vargasï¼ˆãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…ï¼‰
> > 
> > ã¨ã¦ã‚‚åŠ±ã¿ã«ãªã‚‹ãŠè¨€è‘‰ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ç§ã¯å¤šãã®å›°é›£ã«ç›´é¢ã—ã¦ã„ã¾ã™ãŒã€æ—¥ã€…è‡ªåˆ†ã‚’æŠ¼ã—ä¸Šã’ã‚‹åŠªåŠ›ã‚’ã—ã¦ã„ã¾ã™ã€‚
> > 
> > 
> > 

---
```

** @@@ Jupyter Notebook numver 19, the number of votes :12 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ç”¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ¡ãƒ¢ãƒªåˆ¶é™ã®ãŸã‚ã«`kaggle_environments`ã‚’ä½¿ç”¨ã—ãªã„æ–¹æ³•ã§ã€è³ªå•è€…ï¼ˆaskerï¼‰ã¨å›ç­”è€…ï¼ˆanswererï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ã©ã®ã‚ˆã†ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã¯ã€è³ªå•è€…ãŒ1ã¤ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ã€å›ç­”è€…ã‹ã‚‰ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹å½¢å¼ã§é€²è¡Œã—ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ­£è§£ã«ãŸã©ã‚Šç€ãã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `transformers`: ç‰¹ã«`AutoTokenizer`ã¨`AutoModelForCausalLM`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦äº‹å‰è¨“ç·´æ¸ˆã¿ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
   - `torch`: ãƒ¢ãƒ‡ãƒ«ã®å‡¦ç†ã‚’GPUä¸Šã§è¡Œã†ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ**:
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹`Robot`ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€è³ªå•ã™ã‚‹ã€å¿œç­”ã™ã‚‹ã€æ¨æ¸¬ã™ã‚‹ã¨ã„ã†ç•°ãªã‚‹å½¹å‰²ã‚’æŒã¤ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
   - `generate_answer`é–¢æ•°ã¯ã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã€ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã—ã¦å‡ºåŠ›ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

3. **ã‚²ãƒ¼ãƒ ã®é€²è¡Œ**:
   - `Observation`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ï¼ˆç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã€å½¹å‰²ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚
   - å„ãƒ©ã‚¦ãƒ³ãƒ‰ã«ãŠã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã‚’è¡Œã„ã€ãã®çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

4. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒª**:
   - ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã‚Œã«é–¢é€£ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å…¨ä½“ã‚’é€šã˜ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’æŒã¡ã€æœ€çµ‚çš„ã«ã¯ä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã«æŒ‘æˆ¦ã—ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# kaggle_environmentsã‚’ä½¿ç”¨ã›ãšã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
kaggle_environmentsã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ãƒ¡ãƒ¢ãƒªã®åˆ¶é™ã«ã‚ˆã‚Šã§ãã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€è³ªå•è€…ãŠã‚ˆã³å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚  

ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä»¥ä¸‹ã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¾ã—ãŸï¼š  
[llama3-8b- LLM20 Questions [LB 750]](https://www.kaggle.com/code/wouldyoujustfocus/llama3-8b-llm20-questions-lb-750)
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile -a submission/main.py

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
from kaggle_secrets import UserSecretsClient
import os
import sys
import shutil

torch.backends.cuda.enable_mem_efficient_sdp(False)  # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªSDPã‚’ç„¡åŠ¹ã«ã—ã¾ã™
torch.backends.cuda.enable_flash_sdp(False)  # ãƒ•ãƒ©ãƒƒã‚·ãƒ¥SDPã‚’ç„¡åŠ¹ã«ã—ã¾ã™



KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    model_id = os.path.join(KAGGLE_AGENT_PATH, "1")  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ãƒ¢ãƒ‡ãƒ«ID
else:
    model_id = "/kaggle/input/llama-3/transformers/8b-chat-hf/1"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¢ãƒ‡ãƒ«ID


tokenizer = AutoTokenizer.from_pretrained(model_id)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®åˆæœŸåŒ–
model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype=torch.bfloat16, device_map="auto")  # ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
id_eot = tokenizer.convert_tokens_to_ids(["<|eot_id|>"])[0]  # ãƒ¢ãƒ‡ãƒ«ã§ä½¿ç”¨ã™ã‚‹ç‰¹åˆ¥ãªãƒˆãƒ¼ã‚¯ãƒ³ã®IDã‚’å–å¾—


def generate_answer(template):
    inp_ids = tokenizer(template, return_tensors="pt").to("cuda")  # å…¥åŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã¦CUDAã«è»¢é€
    out_ids = model.generate(**inp_ids,max_new_tokens=15).squeeze()  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å‡ºåŠ›ã‚’ç”Ÿæˆ
    start_gen = inp_ids.input_ids.shape[1]  # å…¥åŠ›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
    out_ids = out_ids[start_gen:]  # å‡ºåŠ›ã‹ã‚‰å…¥åŠ›ã®ã‚µã‚¤ã‚ºã‚’å¼•ã
    if id_eot in out_ids:  # ç‰¹æ®Šãªãƒˆãƒ¼ã‚¯ãƒ³ãŒå‡ºåŠ›ã«å«ã¾ã‚Œã‚‹å ´åˆ
        stop = out_ids.tolist().index(id_eot)  # ç‰¹æ®Šãªãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        out = tokenizer.decode(out_ids[:stop])  # ç‰¹æ®Šãªãƒˆãƒ¼ã‚¯ãƒ³ã¾ã§ãƒ‡ã‚³ãƒ¼ãƒ‰
    else:
        out = tokenizer.decode(out_ids)  # ãƒ‡ã‚³ãƒ¼ãƒ‰
    return out  # ç”Ÿæˆã•ã‚ŒãŸå‡ºåŠ›ã‚’è¿”ã™
    

class Robot:
    def __init__(self):
        pass
    
    def on(self, mode, obs):
        assert mode in ["asking", "guessing", "answering"], "mode can only take one of these values: asking, answering, guessing"
        if mode == "asking":
            # è³ªå•è€…å½¹ã‚’èµ·å‹•ã—ã¾ã™
            output = self.asker(obs)
        if mode == "answering":
            # å›ç­”è€…å½¹ã‚’èµ·å‹•ã—ã¾ã™
            output = self.answerer(obs)
            if "yes" in output.lower() or "Yes" in output.lower():
                output = "yes"  # å›ç­”ãŒã€Œã¯ã„ã€ã®å ´åˆ
            elif "no" in output.lower() or "No" in output.lower():
                output = "no"  # å›ç­”ãŒã€Œã„ã„ãˆã€ã®å ´åˆ
            else:
                output = "yes"  # ä¸æ˜ãªå ´åˆã¯ã€Œã¯ã„ã€ã¨ã—ã¾ã™
        if mode == "guessing":
            # æ¨æ¸¬è€…å½¹ã‚’èµ·å‹•ã—ã¾ã™
            output = self.asker(obs)  # è³ªå•è€…ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—ã¾ã™
        return output
    
    
    def asker(self, obs):
        sys_prompt = """
        ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã‚¤ã‚¨ã‚¹ã¾ãŸã¯ãƒãƒ¼ã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å ´æ‰€ã‚„ç‰©ã§ã™ã€‚\n
        """
    
        if obs.turnType =="ask":
            ask_prompt = sys_prompt + """
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚ã‚‹ã¨ä»®å®šã—ãŸå ´åˆã€ã“ã‚Œã¯ã©ã†æ©Ÿèƒ½ã™ã‚‹ã‹ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š
            ä¾‹ï¼š
            <ã‚ãªãŸï¼šã“ã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ã‚ãªãŸï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãã“ã«ä½ã‚“ã§ã„ã‚‹ã»ã¨ã‚“ã©ã®äººã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ã‚ãªãŸï¼šmã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãã‚Œã¯ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„ã€‚>

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å˜èªã‚’é¸æŠã—ã¾ã—ãŸã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãç°¡æ½”ã«ã€1ã¤ã®è³ªå•ã®ã¿ã§ã€ä½™åˆ†ãªè¨€è‘‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ï¼"""
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{ask_prompt}<|eot_id|>"""  # ãƒãƒ£ãƒƒãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
            if len(obs.questions)>=1:
                for q, a in zip(obs.questions, obs.answers):  # è³ªå•ã¨å›ç­”ã‚’é€£çµ
                    chat_template += f"{q}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                    chat_template += f"{a}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
                    
        elif obs.turnType == "guess":
            conv = ""
            for q, a in zip(obs.questions, obs.answers):  # éå»ã®è³ªå•ã¨å›ç­”ã‚’å–å¾—
                conv += f"""è³ªå•: {q}\nå›ç­”: {a}\n"""
            guess_prompt =  sys_prompt + f"""
            ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:\n{conv}
            ä¼šè©±ã«åŸºã¥ã„ã¦ã€å˜èªã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ä½™åˆ†ãªèª¬æ˜ã¯ã—ãªã„ã§ã€å˜èªã®ã¿ã‚’ç­”ãˆã¦ãã ã•ã„ã€‚
            """
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{guess_prompt}<|eot_id|>"""  # æ¨æ¸¬ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
                
        output = generate_answer(chat_template)        
        return output
        
        
        
    def answerer(self, obs):
        sys_prompt = f"""
        ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã‚¤ã‚¨ã‚¹ã¾ãŸã¯ãƒãƒ¼ã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å ´æ‰€ã‚„ç‰©ã§ã™ã€‚\n
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã—ã€ã‚ãªãŸãŒãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç†è§£ã—ã¦ãã ã•ã„ã€‚
        ç¾åœ¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã™ã¹ãå˜èªã¯: "{obs.keyword}"ã€ã‚«ãƒ†ã‚´ãƒªã¯"{obs.category}"ã§ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚«ãƒ†ã‚´ãƒªãŒã€Œå ´æ‰€ã€ã§ã‚ã‚‹ã¨ä»®å®šã—ãŸå ´åˆã€ã“ã‚Œã¯ã©ã†æ©Ÿèƒ½ã™ã‚‹ã‹ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š
        ä¾‹ï¼š
        <ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã“ã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã“ã«ä½ã‚“ã§ã„ã‚‹ã»ã¨ã‚“ã©ã®äººã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šmã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã‚Œã¯ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„ã€‚>
        """
        
        chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{sys_prompt}<|eot_id|>"""  # ãƒãƒ£ãƒƒãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
        chat_template += "<|start_header_id|>user<|end_header_id|>\n\n"
        chat_template += f"{obs.questions[0]}<|eot_id|>"
        chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
        if len(obs.answers)>=1:
            for q, a in zip(obs.questions[1:], obs.answers):  # å„è³ªå•ã¨å›ç­”ã‚’é€£çµ
                chat_template += f"{a}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                chat_template += f"{q}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
        output = generate_answer(chat_template)  # ãƒ¢ãƒ‡ãƒ«ã«é€ä¿¡ã—ã¦å‡ºåŠ›ã‚’ç”Ÿæˆ
        return output
    
    
robot = Robot()


def agent(obs, cfg):
    
    if obs.turnType =="ask":  # è³ªå•ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "asking", obs = obs)
        
    elif obs.turnType =="guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "guessing", obs = obs)
        
    elif obs.turnType =="answer":  # å›ç­”ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "answering", obs = obs)
        
    if response == None or len(response)<=1:  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ãªå ´åˆ
        response = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨­å®š
        
    return response  # æœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
## ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ main.py ã®å¾Œã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
```

---The following area is a Code cell (cell numver is 5)---
```python
!wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py
```

---The following area is a Code cell (cell numver is 6)---
```python
import json
import pandas as pd
from submission.main import agent
from keywords_local import KEYWORDS_JSON

class Observation:
    def __init__(self):
        self.step = 0
        self.role = "guesser"  # æœ€åˆã®å½¹å‰²ã¯æ¨æ¸¬è€…
        self.turnType = "ask"  # åˆæœŸã‚¿ãƒ¼ãƒ³ã¯è³ªå•
        self.keyword = "Japan"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        self.category = "country"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚«ãƒ†ã‚´ãƒª
        self.questions = []  # è³ªå•ã®ãƒªã‚¹ãƒˆ
        self.answers = []  # å›ç­”ã®ãƒªã‚¹ãƒˆ
        self.guesses = []  # æ¨æ¸¬ã®ãƒªã‚¹ãƒˆ
        
def create_keyword_df(KEYWORDS_JSON):
    json_data = json.loads(KEYWORDS_JSON)  # JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€

    keyword_list = []  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆ
    category_list = []  # ã‚«ãƒ†ã‚´ãƒªã®ãƒªã‚¹ãƒˆ
    alts_list = []  # åŒç¾©èªãƒªã‚¹ãƒˆ

    for i in range(len(json_data)):
        for j in range(len(json_data[i]['words'])):  # å„å˜èªã‚’ãƒ«ãƒ¼ãƒ—
            keyword = json_data[i]['words'][j]['keyword']
            keyword_list.append(keyword)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
            category_list.append(json_data[i]['category'])  # ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
            alts_list.append(json_data[i]['words'][j]['alts'])  # åŒç¾©èªã‚’è¿½åŠ 

    data_pd = pd.DataFrame(columns=['keyword', 'category', 'alts'])  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
    data_pd['keyword'] = keyword_list  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ 
    data_pd['category'] = category_list  # ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ 
    data_pd['alts'] = alts_list  # åŒç¾©èªã‚«ãƒ©ãƒ 
    
    return data_pd  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿”ã™
    
keywords_df = create_keyword_df(KEYWORDS_JSON)  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 7)---
```python
obs = Observation()  # è¦³å¯Ÿã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
cfg = "_"

sample_df = keywords_df.sample()  # ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—
obs.keyword = sample_df["keyword"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
obs.category = sample_df["category"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
alts_list = sample_df["alts"].values[0]  # åŒç¾©èªãƒªã‚¹ãƒˆã‚’å–å¾—
alts_list.append(obs.keyword)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åŒç¾©èªãƒªã‚¹ãƒˆã«è¿½åŠ 

print(f"keyword:{obs.keyword}")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›

for round in range(20):  # æœ€å¤§20ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒ«ãƒ¼ãƒ—
    obs.step = round+1  # ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
    
    obs.role = "guesser"  # ç¾åœ¨ã®å½¹å‰²ã‚’æ¨æ¸¬è€…ã«è¨­å®š
    obs.turnType = "ask"  # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚’è³ªå•ã«è¨­å®š
    question = agent(obs, cfg)  # è³ªå•ã‚’å–å¾—
    obs.questions.append(question)  # è³ªå•ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    obs.role = "answerer"  # ç¾åœ¨ã®å½¹å‰²ã‚’å›ç­”è€…ã«è¨­å®š
    obs.turnType = "answer"  # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚’å›ç­”ã«è¨­å®š
    answer = agent(obs, cfg)  # å›ç­”ã‚’å–å¾—
    obs.answers.append(answer)  # å›ç­”ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    obs.role = "guesser"  # å†ã³æ¨æ¸¬è€…ã®å½¹å‰²ã«æˆ»ã™
    obs.turnType = "guess"  # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚’æ¨æ¸¬ã«è¨­å®š
    guess = agent(obs, cfg)  # æ¨æ¸¬ã‚’å–å¾—
    obs.guesses.append(guess)  # æ¨æ¸¬ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    print(f"round: {round+1}")  # ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’å‡ºåŠ›
    print(f"question: {question}")  # è³ªå•ã‚’å‡ºåŠ›
    print(f"answer: {answer}")  # å›ç­”ã‚’å‡ºåŠ›
    print(f"guess: {guess}")  # æ¨æ¸¬ã‚’å‡ºåŠ›
    
    if guess in alts_list:  # æ¨æ¸¬ãŒåŒç¾©èªãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆ
        print("å‹ã¡ã¾ã—ãŸ!!")  # å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
        break
```

** @@@ Jupyter Notebook numver 20, the number of votes :12 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ç‰¹ã«å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’æ‰±ã†ãŸã‚ã«ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### å•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã§ä½¿ç”¨ã•ã‚Œã‚‹è³ªå•è€…ã¨å›ç­”è€…ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã—ã€ç‰¹ã«ã‚¸ã‚ªãƒ¡ãƒˆãƒªãƒƒã‚¯ãªæ¨è«–ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ç’°å¢ƒã§ã®åŠ¹ç‡çš„ãªè³ªå•ç”Ÿæˆã¨æ¨æ¸¬ã‚’æ”¯æ´ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€ã“ã‚Œã‚‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¯¾æˆ¦ã‚’é€šã˜ã¦ä»–ã®ãƒãƒ¼ãƒ ã«å‹åˆ©ã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

### è§£æ±ºæ‰‹æ³•
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹æ³•ã‚’ç”¨ã„ã¦å•é¡Œã‚’è§£æ±ºã—ã¦ã„ã¾ã™ï¼š

1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ãƒ¢ãƒ‡ãƒ«ã®å–å¾—**:
    - `transformers`ãŠã‚ˆã³`bitsandbytes`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
    - Hugging Face Hubã‹ã‚‰ã€Gemma 2ã¨ã„ã†ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãƒ‡ãƒã‚¤ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã¨é‡å­åŒ–è¨­å®šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

2. **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š**:
    - ãƒ¢ãƒ‡ãƒ«ã®å„å±¤ã‚’GPUã«åˆ†æ•£ã•ã›ã‚‹ãŸã‚ã®ãƒ‡ãƒã‚¤ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å®šç¾©ã—ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
    - ä½¿ç”¨ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã€ç”Ÿæˆã•ã‚ŒãŸå‡ºåŠ›ã«å¯¾ã—ã¦å¾Œå‡¦ç†ã‚’è¡Œã†é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…**:
    - ã‚²ãƒ¼ãƒ ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹`Robot`ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã€è³ªå•ç”Ÿæˆ (`asker`)ã€æ¨æ¸¬ (`guessing`)ã€ãŠã‚ˆã³å›ç­” (`answering`) ã®ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
    - å„ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä¸ãˆã‚‰ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«åŸºã¥ã„ã¦é©åˆ‡ãªå‡ºåŠ›ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

4. **ã‚²ãƒ¼ãƒ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
    - ç‹¬è‡ªã®`Observation`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’è¿½è·¡ã—ã€è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã®å±¥æ­´ã‚’ç®¡ç†ã—ã¾ã™ã€‚
    - 20ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–“ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦è³ªå•ã‚„æ¨æ¸¬ã‚’è¡Œã„ã€ã©ã®ã‚ˆã†ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é€²ã‚ã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

5. **æå‡ºã®è©¦ã¿**:
    - æœ€å¾Œã«ã€å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®¹é‡ã«é–¢ã™ã‚‹å•é¡Œã§æå‡ºãŒã§ããªã‹ã£ãŸã“ã¨ãŒè¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Transformers**: è‡ªç„¶è¨€èªå‡¦ç†ã®ãŸã‚ã®å¼·åŠ›ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã‚„ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ç”Ÿæˆã«ä½¿ç”¨ã€‚
- **BitsAndBytes**: ãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã«åˆ©ç”¨ã•ã‚Œã€è¨ˆç®—è³‡æºã®åŠ¹ç‡çš„ãªä½¿ç”¨ã‚’ä¿ƒé€²ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã§ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹ã€ãã®èƒŒæ™¯ã«ã‚ã‚‹æŠ€è¡“ã‚„æ‰‹æ³•ã‚’æ·±ãæ¢ã‚‹ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
%%bash
mkdir -p /kaggle/working/submission
pip install bitsandbytes accelerate
pip install -U transformers
```

---The following area is a Markdown cell (cell numver is 2)---
```markdown
**ç§˜å¯†ã‚’ä¿æŒã™ã‚‹:** ã‚¢ãƒ‰ã‚ªãƒ³>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
```

---The following area is a Code cell (cell numver is 3)---
```python
from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN: str | None  = None

try:
    HF_TOKEN = secrets.get_secret("hf_token")
except:
    pass
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
**LLMã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚** gemma2ã¯å…¥åŠ›ã‹ã‚‰å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œã§ããªã‹ã£ãŸã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/kaggle/working/submission/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)  # æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
g_model_path.mkdir(parents=True)  # æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ

# Hugging Face Hubã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
snapshot_download(
    repo_id="google/gemma-2-9b-it",
    ignore_patterns="original*",
    local_dir=g_model_path,
    local_dir_use_symlinks=False,
    token=globals().get("HF_TOKEN", None)  # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
)
```

---The following area is a Code cell (cell numver is 6)---
```python
!ls -l /kaggle/working/submission/model  # ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
**ãƒ¢ãƒ‡ãƒ«å±¤ã®ãƒ‡ãƒã‚¤ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°**
å¤§è¦æ¨¡ãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†éš›ã«ã€è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã«å±¤ã‚’åˆ†æ•£ã•ã›ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¢ãƒªã¨è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚ˆã‚ŠåŠ¹ç‡çš„ã«ç®¡ç†ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚device_mapså¤‰æ•°ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®ã©ã®å±¤ãŒã©ã®ãƒ‡ãƒã‚¤ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

torch.backends.cuda.enable_mem_efficient_sdp(False)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€PyTorchã®ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„SDPã‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã€ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ‡ãƒãƒƒã‚°ã®ç›®çš„ã§å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨­å®šã«ã‚ˆã‚Šã€ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–“ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ä¸€è²«æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[Gemma 2ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–¹æ³•](https://huggingface.co/blog/gemma2#how-to-prompt-gemma-2)
```

---The following area is a Code cell (cell numver is 8)---
```python
%%writefile -a submission/main.py

import os
import torch
import re
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig, AutoConfig

torch.backends.cuda.enable_mem_efficient_sdp(False)  # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„SDPã‚’ç„¡åŠ¹ã«ã™ã‚‹

KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    model_id = os.path.join(KAGGLE_AGENT_PATH, "model")  # Kaggleã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¹ã«ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
else:
    model_id = "/kaggle/working/submission/model"  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹

# ãƒ¢ãƒ‡ãƒ«å±¤ã®ãƒ‡ãƒã‚¤ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°
device_maps = [('model.layers.0', 0),
 ('model.layers.1', 0),
 ('model.layers.2', 0),
 ('model.layers.3', 0),
 ('model.layers.4', 0),
 ('model.layers.5', 0),
 ('model.layers.6', 0),
 ('model.layers.7', 0),
 ('model.layers.8', 0),
 ('model.layers.9', 0),
 ('model.layers.10', 0),
 ('model.layers.11', 0),
 ('model.layers.12', 0),
 ('model.layers.13', 0),
 ('model.layers.14', 0),
 ('model.layers.15', 0),
 ('model.layers.16', 0),
 ('model.layers.17', 0),
 ('model.layers.18', 0),
 ('model.layers.19', 1),
 ('model.layers.20', 1),
 ('model.layers.21', 1),
 ('model.layers.22', 1),
 ('model.layers.23', 1),
 ('model.layers.24', 1),
 ('model.layers.25', 1),
 ('model.layers.26', 1),
 ('model.layers.27', 1),
 ('model.layers.28', 1),
 ('model.layers.29', 1),
 ('model.layers.30', 1),
 ('model.layers.31', 1),
 ('model.layers.32', 1),
 ('model.layers.33', 1),
 ('model.layers.34', 1),
 ('model.layers.35', 1),
 ('model.layers.36', 1),
 ('model.layers.37', 1),
 ('model.layers.38', 1),
 ('model.layers.39', 1),
 ('model.layers.40', 1),
 ('model.layers.41', 1),
 ('model.embed_tokens', 1),
 ('model.layers', 1)]

# é‡å­åŒ–è¨­å®š
quantization_config = BitsAndBytesConfig(load_in_8bit=True)
tokenizer = AutoTokenizer.from_pretrained(model_id)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ¢ãƒ‡ãƒ«IDã‹ã‚‰å–å¾—
id_eot = tokenizer.convert_tokens_to_ids(["<eos>"])[0]  # <eos>ãƒˆãƒ¼ã‚¯ãƒ³ã®IDã‚’å–å¾—

# å„å±¤ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®š
device = {layer:gpu_mem for (layer,gpu_mem) in device_maps}
config = AutoConfig.from_pretrained(model_id)  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
config.gradient_checkpointing = True  # å‹¾é…ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹
model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype="auto", quantization_config=quantization_config,
                                             device_map="auto", trust_remote_code=True, config=config)

# å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
def generate_answer(template):
    input_ids = tokenizer(template, return_tensors="pt").to("cuda")  # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã¦GPUã«è»¢é€
    output_ids = model.generate(**input_ids, max_new_tokens=15).squeeze()  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å‡ºåŠ›ã‚’ç”Ÿæˆ
    start_gen = input_ids.input_ids.shape[1]  # å…¥åŠ›ã®é•·ã•ã‚’å–å¾—
    output_ids = output_ids[start_gen:]  # å‡ºåŠ›ã‚’åˆ‡ã‚Šå‡ºã™
    if id_eot in output_ids:
        stop = output_ids.tolist().index(id_eot)  # <eos>ã®ä½ç½®ã‚’å–å¾—
        output = tokenizer.decode(output_ids[:stop])  # ã¾ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
    else:
        output = tokenizer.decode(output_ids)  # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
    output = re.sub('\n', '', output)  # æ”¹è¡Œã‚’å‰Šé™¤
    output = re.sub(' <end_of_turn>', '', output)  # ä¸è¦ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
    output = re.sub('<end_of_turn>', '', output)  # ä¸è¦ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
    return output

class Robot:
    def __init__(self):
        pass
    
    def on(self, mode, obs):
        assert mode in ["asking", "guessing", "answering"], "mode can only take one of these values: asking, answering, guessing"
        if mode == "asking":
            output = self.asker(obs)  # è³ªå•è€…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        if mode == "answering":
            output = self.answerer(obs)  # å›ç­”è€…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
            if "yes" in output.lower() or "Yes" in output.lower():
                output = "yes"  # å¦å®šå½¢ã‚’æ•´å½¢
            elif "no" in output.lower() or "No" in output.lower():
                output = "no"  # å¦å®šå½¢ã‚’æ•´å½¢
            else:
                output = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Œyesã€ã«ã™ã‚‹
        if mode == "guessing":
            output = self.asker(obs)  # æ¨æ¸¬è€…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        return output

    def asker(self, obs):
        sys_prompt = """
        ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒãã‚Œã«å¯¾ã—ã¦ã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã‚’ã—ã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®ã€Œã‚‚ã®ã€ã‚„ã€Œå ´æ‰€ã€ã§ã™ã€‚
        """
        if obs.turnType =="ask":
            ask_prompt = sys_prompt + """
            20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
            ã¯ã„ãƒ»ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚ã‚‹ã¨ä»®å®šã—ãŸå ´åˆã®ä¾‹ã‚’ã”è¦§ãã ã•ã„ï¼š
            ä¾‹ï¼š
            <ã‚ãªãŸ: ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãã‚Œã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã„ã„ãˆ
            ã‚ãªãŸ: ãã‚Œã¯ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãã“ã«ä½ã‚€ã»ã¨ã‚“ã©ã®äººã¯è‚Œã®è‰²ãŒæš—ã„ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã„ã„ãˆ
            ã‚ãªãŸ: ãã‚Œã¯ã€Œmã€ã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„ã€‚>
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå˜èªã‚’é¸ã³ã¾ã—ãŸã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãã€å†—é•·ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€ä¸€ã¤ã®è³ªå•ã ã‘ã‚’ã—ã¦ä¸‹ã•ã„ï¼
            """
        
            chat_template = f"""<start_of_turn>system\n{ask_prompt}<end_of_turn>\n"""
            chat_template += "<start_of_turn>model\n"

            if len(obs.questions)>=1:
                    for q, a in zip(obs.questions, obs.answers):
                        chat_template += f"{q}<end_of_turn>\n<start_of_turn>user\n"
                        chat_template += f"{a}<end_of_turn>\n<start_of_turn>model\n"
                    
        elif obs.turnType == "guess":
            conv = ""
            for q, a in zip(obs.questions, obs.answers):
                conv += f"""è³ªå•: {q}\nå›ç­”: {a}\n"""  # è³ªå•ã¨å›ç­”ã®å±¥æ­´ã‚’è¨˜éŒ²
            guess_prompt =  sys_prompt + f"""
            ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:\n{conv}
            ã“ã®ä¼šè©±ã«åŸºã¥ã„ã¦ã€å˜èªã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€æ¨æ¸¬ã«ã¯1ã¤ã®å˜èªã ã‘ã‚’ç­”ãˆã¦ã€å†—é•·ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€‚
            """
            chat_template = f"""<start_of_turn>system\n{guess_prompt}<end_of_turn>\n"""
            chat_template += "<start_of_turn>model\n"

        output = generate_answer(chat_template)        
        return output
    
    def answerer(self, obs):
        ask_prompt = f"""
        ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒãã‚Œã«å¯¾ã—ã¦ã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã‚’ã—ã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å ´æ‰€ã‚„ç‰©ã§ã™ã€‚
        ä»Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã™ã¹ãå˜èªã¯"{obs.keyword}"ã§ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯"{obs.category}"ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹éš›ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
        ä¾‹ï¼š
        <ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã‚Œã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã‚Œã¯ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã“ã«ä½ã‚€ã»ã¨ã‚“ã©ã®äººã¯è‚Œã®è‰²ãŒæš—ã„ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã‚Œã¯ã€Œmã€ã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„ã€‚>
        """
        chat_template = f"""<start_of_turn>system\n{ask_prompt}<end_of_turn>\n"""
        chat_template += "<start_of_turn>user\n"
        chat_template += f"{obs.questions[0]}"
        chat_template += "<start_of_turn>model\n"
        if len(obs.answers)>=1:
            for q, a in zip(obs.questions[1:], obs.answers):
                chat_template += f"{q}<end_of_turn>\n<start_of_turn>user\n"
                chat_template += f"{a}<end_of_turn>\n<start_of_turn>model\n"
        output = generate_answer(chat_template)
        return output

robot = Robot()

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
def agent(obs, cfg):
    
    if obs.turnType =="ask":
        response = robot.on(mode = "asking", obs = obs)  # è³ªå•ã®å‡¦ç†
        
    elif obs.turnType =="guess":
        response = robot.on(mode = "guessing", obs = obs)  # æ¨æ¸¬ã®å‡¦ç†
        
    elif obs.turnType =="answer":
        response = robot.on(mode = "answering", obs = obs)  # å›ç­”ã®å‡¦ç†
        
    if response == None or len(response)<=1:
        response = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”ã‚’è¨­å®š
        
    return response
```

---The following area is a Code cell (cell numver is 9)---
```python
# def simple_agent1(obs, cfg):
#     # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒã€Œaskã€ã®å ´åˆ
#     if obs.turnType == "ask":
#         response_list = [
#             'ãã‚Œã¯ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯ã‚¢ãƒ¡ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯ã‚¢ã‚¸ã‚¢ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯ã‚ªã‚»ã‚¢ãƒ‹ã‚¢ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯æ±ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯åŒ—ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯å—ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯è¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
#             'ãã‚Œã¯æ—¥æœ¬ã§ã™ã‹ï¼Ÿ'
#         ]
# #         response = response_list[len(obs.questions)]
#         response = random.choice(response_list)  # ãƒ©ãƒ³ãƒ€ãƒ ã«è³ªå•ã‚’é¸æŠ
#     elif obs.turnType == "guess":
#         response = "duck"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¨æ¸¬
#     elif obs.turnType == "answer":
#         response = random.choices(["ã¯ã„", "ã„ã„ãˆ"])[0]  # ãƒ©ãƒ³ãƒ€ãƒ ã«å›ç­”
#     return response
```

---The following area is a Code cell (cell numver is 10)---
```python
# %%time

# import random
# from kaggle_environments import make
# agent = "/kaggle/working/submission/main.py"
# env = make("llm_20_questions", debug=True)
# game_output = env.run(agents=[agent, simple_agent1, simple_agent1, simple_agent1])
```

---The following area is a Code cell (cell numver is 11)---
```python
# env.render(mode="ipython", width=600, height=500)  # ç’°å¢ƒã‚’æç”»
```

---The following area is a Code cell (cell numver is 12)---
```python
!wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```

---The following area is a Code cell (cell numver is 13)---
```python
import json
import pandas as pd
from submission.main import agent
from keywords_local import KEYWORDS_JSON

class Observation:
    def __init__(self):
        self.step = 0
        self.role = "guesser"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å½¹å‰²ã¯æ¨æ¸¬è€…
        self.turnType = "ask"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã¯è³ªå•
        self.keyword = "Japan"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        self.category = "country"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚«ãƒ†ã‚´ãƒªãƒ¼
        self.questions = []  # è³ªå•ãƒªã‚¹ãƒˆ
        self.answers = []  # å›ç­”ãƒªã‚¹ãƒˆ
        self.guesses = []  # æ¨æ¸¬ãƒªã‚¹ãƒˆ
        
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹é–¢æ•°
def create_keyword_df(KEYWORDS_JSON):
    json_data = json.loads(KEYWORDS_JSON)  # JSONã‚’èª­ã¿è¾¼ã‚€

    keyword_list = []
    category_list = []
    alts_list = []

    for i in range(len(json_data)):
        for j in range(len(json_data[i]['words'])):
            keyword = json_data[i]['words'][j]['keyword']
            keyword_list.append(keyword)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            category_list.append(json_data[i]['category'])  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            alts_list.append(json_data[i]['words'][j]['alts'])  # ä»£æ›¿ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 

    data_pd = pd.DataFrame(columns=['keyword', 'category', 'alts'])  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
    data_pd['keyword'] = keyword_list
    data_pd['category'] = category_list
    data_pd['alts'] = alts_list
    
    return data_pd
    
keywords_df = create_keyword_df(KEYWORDS_JSON)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 14)---
```python
obs = Observation()
cfg = "_"

sample_df = keywords_df.sample()  # ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—
obs.keyword = sample_df["keyword"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
obs.category = sample_df["category"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®š
alts_list = sample_df["alts"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã®ä»£æ›¿ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
alts_list.append(obs.keyword)  # ã‚µãƒ³ãƒ—ãƒ«ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä»£æ›¿ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«è¿½åŠ 

print(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:{obs.keyword}")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º

for round in range(20):
    obs.step = round+1  # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    
    obs.role = "guesser"  # å½¹å‰²ã‚’æ¨æ¸¬è€…ã«è¨­å®š
    obs.turnType = "ask"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’è³ªå•ã«è¨­å®š
    question = agent(obs, cfg)  # è³ªå•ã‚’ç”Ÿæˆ
    obs.questions.append(question)  # è³ªå•ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    obs.role = "answerer"  # å½¹å‰²ã‚’å›ç­”è€…ã«è¨­å®š
    obs.turnType = "answer"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’å›ç­”ã«è¨­å®š
    answer = agent(obs, cfg)  # å›ç­”ã‚’ç”Ÿæˆ
    obs.answers.append(answer)  # å›ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    obs.role = "guesser"  # å½¹å‰²ã‚’æ¨æ¸¬è€…ã«è¨­å®š
    obs.turnType = "guess"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’æ¨æ¸¬ã«è¨­å®š
    guess = agent(obs, cfg)  # æ¨æ¸¬ã‚’ç”Ÿæˆ
    obs.guesses.append(guess)  # æ¨æ¸¬ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
    print(f"ãƒ©ã‚¦ãƒ³ãƒ‰: {round+1}")  # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’è¡¨ç¤º
    print(f"è³ªå•: {question}")  # è³ªå•ã‚’è¡¨ç¤º
    print(f"å›ç­”: {answer}")  # å›ç­”ã‚’è¡¨ç¤º
    print(f"æ¨æ¸¬: {guess}")  # æ¨æ¸¬ã‚’è¡¨ç¤º
    
    if guess in alts_list:  # æ¨æ¸¬ãŒä»£æ›¿ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        print("å‹ã¡ã¾ã—ãŸï¼ï¼")  # å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        break
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
**æå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ...** å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå®¹é‡ã‚’è¶…ãˆãŸãŸã‚ã€tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 16)---
```python
# !apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 17)---
```python
# !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 18)---
```python
# # tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«

# import tarfile
# tar = tarfile.open("/kaggle/working/submission.tar.gz")
# for file in tar.getmembers():
#     print(file.name)  # tarãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Yuang Wu
> 
> ã©ã®ã‚ˆã†ã«ã—ã¦æ¨æ¸¬æ™‚ã«1ã¤ã®å˜èªã‚’å‡ºåŠ›ã™ã‚‹ã®ã§ã™ã‹ï¼Ÿâ€¦ç§ã¯gemma 7b-it 3ã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æ¨æ¸¬æ™‚ã«2ã¤ä»¥ä¸Šã®å˜èªã‚’ç”Ÿæˆã—ã€è³ªå•ã‚‚å¥‡å¦™ã«ãªã‚Šã¾ã™ã€‚ 
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > åŒæ§˜ã§ã™â€¦çŸ¥ã‚ŠãŸã„ã§ã™ã€‚gemma2ã¯ãã‚Œã»ã©å„ªã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> > 
> > 
> > > ## KasaharaTopic ä½œè€…
> > > 
> > > gemma7b-itã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã€åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å°‘ã—æ”¹å–„ã•ã‚ŒãŸã‚ˆã†ã§ã™ãŒã€ç§ã®å®Ÿé¨“ã§ã¯llama3ãŒæ­£ã—ã„é•·ã•ã®å˜èªã‚’å‡ºåŠ›ã§ãã‚‹æœ€é«˜ã®ãƒ¢ãƒ‡ãƒ«ã ã¨æ€ã„ã¾ã™ã€‚
> > > 
> > > 
> > > > ## Yuang Wu
> > > > 
> > > > gemma 2 9bã«å¤‰æ›´ã—ãŸã¨ã“ã‚ã€çŠ¶æ³ãŒæ”¹å–„ã—ã¾ã—ãŸã€‚
> > > > 
> > > > 

---

> ## ravi tanwar
> 
> ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ã“ã¨ã«æˆåŠŸã—ã¾ã—ãŸã‹ï¼Ÿ
> 
> > ## KasaharaTopic ä½œè€…
> > 
> > submission.tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ããªã‹ã£ãŸãŸã‚ã€å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå®¹é‡ã‚’è¶…ãˆã¾ã—ãŸã€‚ã ã‹ã‚‰ã€æå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
> > 
> > æå‡ºã§ããŸã¨ã—ã¦ã‚‚ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚è³ªå•ã‚’ã†ã¾ãç”Ÿæˆã—ã¾ã›ã‚“ã‹ã‚‰ã€‚
> > 
> >
```

** @@@ Jupyter Notebook numver 21, the number of votes :12 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã‚ã‚Šã€ç‰¹ã«ã€ŒRiggingã€ã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### å•é¡Œã®å†…å®¹
- ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å‚åŠ è€…ãŒè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€é™ã‚‰ã‚ŒãŸè³ªå•ã‚’é€šã˜ã¦æŒ‡å®šã•ã‚ŒãŸå˜èªã‚’å½“ã¦ã‚‹ã‚²ãƒ¼ãƒ ã‚’è¡Œã„ã¾ã™ã€‚ç›®æŒ‡ã™ã¹ãã¯ã€æœ€å°é™ã®è³ªå•ã§ç­”ãˆã«åˆ°é”ã™ã‚‹ã“ã¨ã§ã‚ã‚Šã€ãã®ãŸã‚ã«ã¯åŠ¹æœçš„ãªè³ªå•ã‚’ç”Ÿæˆã—ã€çš„ç¢ºãªå›ç­”ã‚’å¼•ãå‡ºã™ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
- Notebookå†…ã§ã¯ã€`llama3`ãƒ¢ãƒ‡ãƒ«ã‚’`phi3`ãƒ¢ãƒ‡ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã¦æ€§èƒ½ã‚’æ”¹å–„ã—ã€LLMã¨éLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸæˆ¦ç•¥ã‚’å–ã£ã¦ã„ã¾ã™ã€‚Riggingãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«é–“ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®¹æ˜“ã«ã—ã€æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’ç¢ºèªã—ãªãŒã‚‰LLMã«ã‚¯ã‚¨ãƒªã‚’é€ä¿¡ã§ãã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Rigging**: Pydantic XMLã«åŸºã¥ã„ãŸè»½é‡ã®LLMã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€LLMã®ç”Ÿç”£ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚è³ªå•ã®ç”Ÿæˆã‚„å›ç­”ã®å–å¾—ã‚’æŸ”è»Ÿã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
- **vLLM**: ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç’°å¢ƒã‚’æ•´ãˆã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
- è¿½åŠ ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã€`huggingface_hub`ã‚„`pandas`ãŒä½¿ç”¨ã•ã‚Œã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’åŠ¹ç‡åŒ–ã—ã¦ã„ã¾ã™ã€‚

### ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
1. **åˆæœŸè¨­å®š**: Hugging Faceã¨Kaggleã®ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒè¡Œã‚ã‚Œã‚‹ã€‚
2. **ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™**: `snapshot_download`ã‚’é€šã˜ã¦Hugging Faceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
3. **vLLMã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ›ã‚¹ãƒˆã—ã€LLMãŒè³ªå•ã¨å›ç­”ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
4. **è³ªå•è€…ã¨å›ç­”è€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ**: Pythonã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã€è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å‡¦ç†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒæ•´å‚™ã•ã‚Œã¦ã„ã¾ã™ã€‚
5. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆ**: å…¬é–‹ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã€ã©ã®å˜èªã«å¯¾ã—ã¦è³ªå•ã™ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®ãƒ™ãƒ¼ã‚¹ã«ãªã‚Šã¾ã™ã€‚
6. **æœ€çµ‚æå‡ºç‰©ã®ä½œæˆ**: å®Ÿè¡Œç’°å¢ƒã®æº–å‚™ãŒæ•´ã„ã€`main.py`ã‚’å«ã‚€ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã«LLMã‚’åŠ¹æœçš„ã«æ´»ç”¨ã§ãã‚‹åŸºç›¤ã‚’æä¾›ã—ã¦ãŠã‚Šã€Riggingã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ç«¶æŠ€è€…ãŒç°¡å˜ã«LLMã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã€ãƒ†ã‚¹ãƒˆã—ã€èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# LLM 20 Questions ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ with Rigging [Phi3]

## ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ä»¥å‰ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®æ”¹è¨‚ç‰ˆã§ã™ã€‚`llama3`ãƒ¢ãƒ‡ãƒ«ã‚’@bhanupmã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ã¦`phi3`ãƒ¢ãƒ‡ãƒ«ã«ç½®ãæ›ãˆã¾ã—ãŸã€‚å…ƒã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯[ã“ã¡ã‚‰](https://www.kaggle.com/code/robikscube/phi3-intro-to-rigging-for-llm-20-questions/)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

åˆæœŸã®ãƒ†ã‚¹ãƒˆã§ã¯ã€llama3ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ˆã‚Šè‰¯ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç™ºæ®ã—ã¾ã—ãŸãŒã€ã‚ˆã‚Šè‰¯ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚ˆã£ã¦æ”¹å–„ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æå‡ºã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ã€vLLMã‚’ä½¿ç”¨ã—ãŸ`phi3`é‡å­åŒ–ãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## æ›´æ–° **2024å¹´6æœˆ10æ—¥**
- rigging 2.0ã«å¯¾å¿œã™ã‚‹ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ
- Known keywordsã‚’æ´»ç”¨ã™ã‚‹éLLMè³ªå•ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å«ã‚ã¾ã—ãŸ **ã“ã‚Œã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯ã†ã¾ãæ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚å›ç­”ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯riggingã‚’ä»‹ã—ã¦LLMã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## Riggingã¨ã¯ï¼Ÿ

Riggingã¯ã€Pydantic XMLã«åŸºã¥ã„ã¦æ§‹ç¯‰ã•ã‚ŒãŸè»½é‡ãªLLMã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ç›®çš„ã¯ã€LLMã‚’ç”Ÿç”£ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã§ãã‚‹ã ã‘ç°¡å˜ã‹ã¤åŠ¹æœçš„ã«æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚Riggingã¯20ã®è³ªå•ã‚¿ã‚¹ã‚¯ã«å®Œå…¨ã«é©ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š
1. ç•°ãªã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰LLMãƒ¢ãƒ‡ãƒ«ã‚’ç°¡å˜ã«å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
2. æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æˆåŠŸã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™LLMã‚¯ã‚¨ãƒªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¨­è¨ˆã§ãã¾ã™ã€‚
3. ç¾ä»£ã®Pythonã§ã€å‹ãƒ’ãƒ³ãƒˆã€éåŒæœŸã‚µãƒãƒ¼ãƒˆã€pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚·ãƒªã‚¢ãƒ«åŒ–ãªã©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ãƒªãƒã‚¸ãƒˆãƒªã‚’ã“ã¡ã‚‰ã§ã‚¹ã‚¿ãƒ¼ã—ã¦ãŠã„ã¦ãã ã•ã„: https://github.com/dreadnode/rigging
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã“ã¡ã‚‰ã§ãŠèª­ã¿ãã ã•ã„: https://rigging.dreadnode.io/

Riggingã¯[dreadnode](https://www.dreadnode.io/)ã«ã‚ˆã£ã¦æ§‹ç¯‰ã•ã‚Œã€ç¶­æŒã•ã‚Œã¦ã„ã¾ã™ã€‚ç§ãŸã¡ã¯æ—¥å¸¸çš„ã«ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªriggingãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š
```{python}
chat = rg.get_generator('gpt-4o') \
    .chat(f"Provide me the names of all the countries in South America that start with the letter A {Answer.xml_tags()} tags.") \
    .until_parsed_as(Answer) \
    .run() 
```

ç”Ÿæˆå™¨ã¯ã€å¤§å¤šæ•°ã®ä¸»è¦ãªLLM APIã¨ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ä½œæˆã§ãã¾ã™ã€‚APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é™ã‚Šã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
```
export OPENAI_API_KEY=...
export TOGETHER_API_KEY=...
export TOGETHERAI_API_KEY=...
export MISTRAL_API_KEY=...
export ANTHROPIC_API_KEY=...
```

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å¹¸é‹ã«ã‚‚riggingã¯ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã‚µãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ä»¥ä¸‹ã¯ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã„ãã¤ã‹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã™ã€‚ã“ã“ã§ã¯ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã„ã¾ã™ï¼š
- Hugging Faceã¨Kaggleã®ãŸã‚ã®ç§˜å¯†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
- vLLMã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ç§˜å¯†ã‚’ä½¿ç”¨ã—ã¦ã„ãã¤ã‹ã®éš ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN: str | None  = None
KAGGLE_KEY: str | None = None
KAGGLE_USERNAME: str | None = None
    
try:
    HF_TOKEN = secrets.get_secret("HF_TOKEN")
    KAGGLE_KEY = secrets.get_secret("KAGGLE_KEY")
    KAGGLE_USERNAME = secrets.get_secret("KAGGLE_USERNAME")
except:
    pass
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ç§ãŸã¡ã¯ä»¥ä¸‹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š
- [rigging](https://github.com/dreadnode/rigging) ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®LLMãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚
- [vLLM](https://github.com/vllm-project/vllm) ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

ã¾ãŸã€[uv](https://github.com/astral-sh/uv)ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã“ã‚Œã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè¿…é€Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

**æ³¨æ„:** ã“ã‚Œã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯`/kaggle/tmp/lib`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç›®çš„ã®ãŸã‚ã«è¡Œã„ã€ã“ã®ãƒ‘ã‚¹å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾Œã§æå‡ºç”¨ã®ZIPã«å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€vllmã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚`/kaggle/tmp/srvlib`ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
# ä¾å­˜é–¢ä¿‚ï¼ˆé€Ÿåº¦å‘ä¸Šã®ãŸã‚ã®uvï¼‰
!pip install uv==0.1.45

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/lib \
    rigging==2.0.0 \
    kaggle

!uv pip install -U \
    --python $(which python) \
    --target /kaggle/tmp/srvlib \
    vllm==0.4.2 \
    numpy==1.26.4
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# LLMã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã¾ãš`snapshot_download`ã‚’ä½¿ç”¨ã—ã¦Hugging Faceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

`solidrust/Meta-Llama-3-8B-Instruct-hf-AWQ`ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³è¦ä»¶ã«ååˆ†ã«å°ã•ã„Activation-aware Weight Quantizationãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚

**æ³¨æ„:** é€šå¸¸ã®çŠ¶æ³ã§riggingã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã«æå‡ºç‰©ã«å«ã‚ã‚‹ãŸã‚ã«é‡ã¿ã‚’åˆ¥ã€…ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
# ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/kaggle/tmp/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)
g_model_path.mkdir(parents=True)

snapshot_download(
    repo_id="rhysjones/Phi-3-mini-mango-1-llamafied",
    ignore_patterns="original*",
    local_dir=g_model_path,
    local_dir_use_symlinks=False,
    token=globals().get("HF_TOKEN", None)
)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãŒ`/kaggle/tmp/model/`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
!ls -l /kaggle/tmp/model
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«

ã“ã‚Œã‚‰ã¯ã€vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
%%writefile util.py

# vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼

import subprocess
import os
import socket
import time

def check_port(port: int) -> bool:
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
            sock.settimeout(1)
            result = sock.connect_ex(('localhost', port))
            if result == 0:
                return True
    except socket.error:
        pass
    
    return False

def run_and_wait_for_port(
    cmd: list[str], port: int, env: dict[str, str] | None, timeout: int = 60, debug: bool = False
) -> subprocess.Popen:
    
    if check_port(port):
        raise ValueError(f"ãƒãƒ¼ãƒˆ {port} ã¯ã™ã§ã«é–‹ã„ã¦ã„ã¾ã™")
        
    popen = subprocess.Popen(
        cmd,
        env={**os.environ, **(env or {})},
        stdout=subprocess.DEVNULL if not debug else None,
        stderr=subprocess.DEVNULL if not debug else None,
    )
    
    start_time = time.time()
    while time.time() - start_time < timeout:
        if check_port(port):
            return popen
        time.sleep(1)
    
    popen.terminate()
    raise Exception(f"ãƒ—ãƒ­ã‚»ã‚¹ãŒ {port} ã‚’ {timeout} ç§’ä»¥å†…ã«é–‹ãã¾ã›ã‚“ã§ã—ãŸã€‚")
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
# ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«vLLMã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

ç§ãŸã¡ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€vLLMã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ›ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã§ã¯ã€Kaggleç’°å¢ƒã§ã®å‹•ä½œã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’èµ·å‹•ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 12)---
```python
# vLLMã®ãƒ‘ã‚¹ã¨è¨­å®šã€‚

import importlib
from pathlib import Path
import util

util = importlib.reload(util)

g_srvlib_path = Path("/kaggle/tmp/srvlib")
assert g_srvlib_path.exists()

g_model_path = Path("/kaggle/tmp/model")
assert g_model_path.exists()

g_vllm_port = 9999
g_vllm_model_name = "custom"
```

---The following area is a Code cell (cell numver is 13)---
```python
# ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½¿ç”¨ã—ã¦vLLMã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹
vllm = util.run_and_wait_for_port([
    "python", "-m",
    "vllm.entrypoints.openai.api_server",
    "--enforce-eager",
    "--model", str(g_model_path),
    "--port", str(g_vllm_port),
    "--served-model-name", g_vllm_model_name,
    "--dtype=half"
],
    g_vllm_port,
    {"PYTHONPATH": str(g_srvlib_path)},
    debug=False
)

print("vLLMãŒèµ·å‹•ã—ã¾ã—ãŸ")
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
llama3ãƒ¢ãƒ‡ãƒ«ãŒæœ€åˆã®Tesla T4 GPUã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
!nvidia-smi
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
## ãƒ¢ãƒ‡ãƒ«ã®æ¤œè¨¼

æœ€åˆã®riggingç”Ÿæˆå™¨ã‚’ä½œæˆã—ã¾ã™ã€‚riggingã«ãŠã„ã¦ã€ç”Ÿæˆå™¨ã¯å¼·åŠ›ãªLLMãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹åŸºæœ¬ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
# Riggingã¨ã®æ¥ç¶š

import sys
import logging

sys.path.insert(0, "/kaggle/tmp/lib")

logging.getLogger("LiteLLM").setLevel(logging.WARNING)

import rigging as rg

generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—æ‰‹åŠ©ã‘ãŒå¿…è¦ã§ã™
)

answer = await generator.chat("Say Hello!").run()

print()
print('[Rigging Chat]')
print(type(answer), answer)

print()
print('[LLMã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã¿]')
print(type(answer.last), answer.last)

print()
answer_string = answer.last.content
print('[LLMãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦]')
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
## çµæœã‚’pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹

`to_df()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç°¡å˜ã«pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 19)---
```python
answer.to_df()
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
## ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å¤‰æ›´

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã¨åŒæ§˜ã«ã€Riggingç”Ÿæˆå™¨ã¯ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ãƒ¢ãƒ‡ãƒ«ã€APIã‚­ãƒ¼ã€ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã‚’å®šç¾©ã™ã‚‹æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¾ã§ãã¾ã™ã€‚ãã‚Œã‚‰ã¯ä»¥ä¸‹ã®å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã™ï¼š

```
<provider>!<model>,<**kwargs>
```

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼š
- temperature=0.9
- max_tokens=512

ã“ã‚Œã‚‰ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã“ã¡ã‚‰ã‚’ãŠèª­ã¿ãã ã•ã„: https://rigging.dreadnode.io/topics/generators/#overload-generation-params
```

---The following area is a Code cell (cell numver is 21)---
```python
generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "temperature=0.9,max_tokens=512," \
    "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—æ‰‹åŠ©ã‘ãŒå¿…è¦ã§ã™
)
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
ã¾ãŸã€`rg.GenerateParams`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã•ã¾ã–ã¾ãªãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã§ãã¾ã™ï¼š

```
rg.GenerateParams(
    *,
    temperature: float | None = None,
    max_tokens: int | None = None,
    top_k: int | None = None,
    top_p: float | None = None,
    stop: list[str] | None = None,
    presence_penalty: float | None = None,
    frequency_penalty: float | None = None,
    api_base: str | None = None,
    timeout: int | None = None,
    seed: int | None = None,
    extra: dict[str, typing.Any] = None,
)
```

https://rigging.dreadnode.io/api/generator/#rigging.generator.GenerateParams
```

---The following area is a Code cell (cell numver is 23)---
```python
rg_params = rg.GenerateParams(
    temperature = 0.9,
    max_tokens = 512,
)
base_chat = generator.chat(params=rg_params)
answer = await base_chat.fork('How is it going?').run()
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
ã¾ãŸã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ãƒã‚§ãƒ¼ãƒ³å†…ã§paramsã‚’ä½¿ç”¨ã—ã¦è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 25)---
```python
base_chat = generator.chat() # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
answer = await base_chat.fork('How is it going?') \
    .with_(temperature = 0.9, max_tokens = 512) \
    .run()
print(answer.last.content)
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
# ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå‡ºåŠ›ã®ä¾‹

æ¬¡ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ï¼š
1. `Answer`ã¨ã„ã†riggingãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®çµæœã‹ã‚‰ãƒ‘ãƒ¼ã‚¹ã™ã‚‹æœŸå¾…å‡ºåŠ›ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚
    - ã“ã“ã§ã€å‡ºåŠ›ãŒ`yes`ã¾ãŸã¯`no`ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«ã€ã„ãã¤ã‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
    - ã“ã‚Œã¯å®Œå…¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã™ã€‚
    - ã“ã“ã§`validate_content`ã¯ã€ç§ãŸã¡ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆå°æ–‡å­—ã§å§‹ã¾ã‚Šã€"yes"ã¾ãŸã¯"no"ã§å§‹ã¾ã‚‹ï¼‰ã«æº–æ‹ ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
2. ç§ãŸã¡ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«`Answer.xml_example()`ã‚’ä½¿ç”¨ã—ã¦ã€LLMã«å‡ºåŠ›ãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã¹ãã‹ã‚’çŸ¥ã‚‰ã›ã¾ã™ã€‚
3. å¾Œã§`.until_parsed_as(Answer)`ã‚’ä½¿ç”¨ã—ã¦ã€LLMã®å‡ºåŠ›ãŒã“ã“ã§å®šç¾©ã•ã‚ŒãŸã‚ˆã†ã«æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

**æ³¨æ„** `until_parsed_as()`ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§5ã®`max_rounds`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 27)---
```python
import typing as t
from pydantic import field_validator

class Answer(rg.Model):
    content: t.Literal["yes", "no"]

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:
        for valid in ["yes", "no"]:
            if v.lower().startswith(valid):
                return valid
        raise ValueError("ç„¡åŠ¹ãªå›ç­”ã§ã™ã€'yes'ã¾ãŸã¯'no'ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}yes/no{Answer.xml_end_tag()}"
```

---The following area is a Code cell (cell numver is 28)---
```python
# ã“ã®xmlã®ä¾‹ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ã©ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†
Answer.xml_example()
```

---The following area is a Code cell (cell numver is 29)---
```python
generator = rg.get_generator(
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "temperature=1.2"
#     "stop=<|eot_id|>" # Llamaã«ã¯å°‘ã—æ‰‹åŠ©ã‘ãŒå¿…è¦ã§ã™
)

keyword='Tom Hanks'
category='æœ‰åãªäºº'
last_question='ãã‚Œã¯æœ‰åãªäººã§ã™ã‹ï¼Ÿ'

prompt = f"""\
            ã“ã®ã‚²ãƒ¼ãƒ ã®ç§˜å¯†ã®è¨€è‘‰ã¯ "{keyword}" ã§ã™ [{category}]

            ç¾åœ¨ã€ä¸Šè¨˜ã®è¨€è‘‰ã«ã¤ã„ã¦ã®è³ªå•ã«ç­”ãˆã¦ã„ã¾ã™ã€‚

            æ¬¡ã®è³ªå•ã¯ "{last_question}" ã§ã™ã€‚

            ä¸Šè¨˜ã®ã¯ã„/ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ä¸‹ã•ã„ï¼š
            {Answer.xml_example()}

            - ã‚ãªãŸã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€ä¸Šè¨˜ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦æ­£ç¢ºã§ã‚ã‚‹ã¹ãã§ã™
            - å¸¸ã« "yes" ã¾ãŸã¯ "no" ã§å›ç­”ã—ã¦ãã ã•ã„

            ç­”ãˆã¯ä½•ã§ã™ã‹ï¼Ÿ
"""

chat = await (
    generator
    .chat(prompt)
    .until_parsed_as(Answer, max_rounds=50)
    .run()
)

print('=== ãƒ•ãƒ«ãƒãƒ£ãƒƒãƒˆ ===')
print(chat)

print()
print('=== LLMã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã¿ ===')
print(chat.last)

print()
print('=== ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå›ç­” ===')
print(chat.last.parse(Answer).content)
```

---The following area is a Markdown cell (cell numver is 30)---
```markdown
# Riggingã§è³ªå•è€…ãƒãƒ£ãƒƒãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¾‹ã‚’ä½œæˆã™ã‚‹

æ¬¡ã«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä½•ã§ã‚ã‚‹ã‹ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¤è³ªå•è€…ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

ã¾ãšã€å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹`Question`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 31)---
```python
from pydantic import StringConstraints  # noqa

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]

class Question(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="**è³ªå•**").to_pretty_xml()
```

---The following area is a Code cell (cell numver is 32)---
```python
base =  generator.chat("""\
ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®å„ªã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚ã‚ãªãŸã¯æ­£ç¢ºã§ã€é›†ä¸­ã—ã¦ãŠã‚Šã€æ§‹é€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã‚Šã¾ã™ã€‚ã‚ãªãŸã¯æœ‰ç”¨ãªè³ªå•ã‚’ä½œæˆã—ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’è¡Œã£ãŸã‚Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æ¨æ¸¬ã‚’è¡Œã£ãŸã‚Šã—ã¾ã™ã€‚

""")


question_chat = await (base.fork(
    f"""\
    ã‚ãªãŸã¯ç¾åœ¨æ¬¡ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã€‚

    è³ªå•ã‚’ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ä¸‹ã•ã„ï¼š
    {Question.xml_example()}

    - ã‚ãªãŸã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€æœ€ã‚‚å¤šãã®æƒ…å ±ã‚’é›†ã‚ã‚‹ç„¦ç‚¹ã‚’çµã£ãŸè³ªå•ã§ã‚ã‚‹ã¹ãã§ã™
    - è³ªå•ã¯ä¸€èˆ¬çš„ãªã‚‚ã®ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„
    - æ®‹ã‚Šã®æ¢ç´¢ç©ºé–“ã‚’äºŒåˆ†ã™ã‚‹ã‚ˆã†ã«ã—ã¦ä¸‹ã•ã„
    - ä»¥å‰ã®è³ªå•ã¨å›ç­”ã«æ³¨æ„ã—ã¦ãã ã•ã„

    ã‚ãªãŸã®æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ
    """
)
.until_parsed_as(Question, attempt_recovery=True)
.run()
)
```

---The following area is a Code cell (cell numver is 33)---
```python
# ä¼šè©±ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¾
question_chat.to_df()
```

---The following area is a Markdown cell (cell numver is 34)---
```markdown
ç§ãŸã¡ã¯LLMã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè³ªå•ã‚’å«ã‚“ã§ã„ã‚‹ã“ã¨ã‚’è‡ªä¿¡ã‚’æŒã£ã¦ç¢ºèªã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è³ªå•ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```

---The following area is a Code cell (cell numver is 35)---
```python
question = question_chat.last.parse(Question).content
print(question)
```

---The following area is a Markdown cell (cell numver is 36)---
```markdown
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹
** ã“ã‚Œã¯ã€å…¬é–‹ã•ã‚ŒãŸã‚»ãƒƒãƒˆã®ä¸­ã§ã®å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ãŸã‚ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚æœ€çµ‚çš„ãªãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**
```

---The following area is a Code cell (cell numver is 37)---
```python
!wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py
```

---The following area is a Code cell (cell numver is 38)---
```python
!head keywords_local.py
```

---The following area is a Code cell (cell numver is 39)---
```python
import sys
import json
import pandas as pd
sys.path.append('./')
from keywords_local import KEYWORDS_JSON

def capitalize_first_word(text):
    if not text:
        return text
    return text[0].upper() + text[1:].lower()

def create_keyword_df(KEYWORDS_JSON):
    keywords_dict = json.loads(KEYWORDS_JSON)

    category_words_dict = {}
    all_words = []
    all_cat_words = []
    for d in keywords_dict:
        words = [w['keyword'] for w in d['words']]
        cat_word = [(d['category'], w['keyword']) for w in d['words']]
        category_words_dict[d['category']] = words
        all_words += words
        all_cat_words += cat_word

    keyword_df = pd.DataFrame(all_cat_words, columns=['category','keyword'])
    keyword_df['first_letter'] = keyword_df['keyword'].str[0]
    keyword_df['second_letter'] = keyword_df['keyword'].str[1]
    keyword_df.to_parquet('keywords.parquet')
    
create_keyword_df(KEYWORDS_JSON)
```

---The following area is a Code cell (cell numver is 40)---
```python
keywords_df = pd.read_parquet('keywords.parquet')
keywords_df.sample(10)
```

---The following area is a Code cell (cell numver is 41)---
```python
keywords_df['category'].value_counts()
```

---The following area is a Markdown cell (cell numver is 42)---
```markdown
# æœ€çµ‚æå‡ºç”¨ã®`main.py`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

ç§ãŸã¡ã®æœ€çµ‚æå‡ºç‰©ã¯ã€`main`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ZIPåœ§ç¸®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã«ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 43)---
```python
%%writefile main.py

# ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

import itertools
import os
import sys
import typing as t
from pathlib import Path
import logging

import string
import numpy as np
import pandas as pd

# ãƒ‘ã‚¹ã®ä¿®æ­£

g_working_path = Path('/kaggle/working')
g_input_path = Path('/kaggle/input')
g_temp_path = Path("/kaggle/tmp")
g_agent_path = Path("/kaggle_simulations/agent/")

g_model_path = g_temp_path / "model"
g_srvlib_path = g_temp_path / "srvlib"
g_lib_path = g_temp_path / "lib"

if g_agent_path.exists():
    g_lib_path = g_agent_path / "lib"
    g_model_path = g_agent_path / "model"
    g_srvlib_path = g_agent_path / "srvlib"
else:
    g_agent_path = Path('/kaggle/working')
    
sys.path.insert(0, str(g_lib_path))

# ãƒ­ã‚®ãƒ³ã‚°ã®ãƒã‚¤ã‚ºã‚’ç„¡åŠ¹ã«ã™ã‚‹

logging.getLogger("LiteLLM").setLevel(logging.WARNING)

# å›ºå®šã•ã‚ŒãŸã‚¤ãƒ³ãƒãƒ¼ãƒˆ

import util # noqa
import rigging as rg  # noqa
from pydantic import BaseModel, field_validator, StringConstraints  # noqa

# å®šæ•°

g_vllm_port = 9999
g_vllm_model_name = "custom"

g_generator_id = (
    f"openai/{g_vllm_model_name}," \
    f"api_base=http://localhost:{g_vllm_port}/v1," \
    "api_key=sk-1234," \
    "temperature=1.2"
)

# ã‚¿ã‚¤ãƒ—

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]

class Observation(BaseModel):
    step: int
    role: t.Literal["guesser", "answerer"]
    turnType: t.Literal["ask", "answer", "guess"]
    keyword: str
    category: str
    questions: list[str]
    answers: list[str]
    guesses: list[str]
    
    @property
    def empty(self) -> bool:
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")

    def get_history_as_xml(self, *, skip_guesses: bool = False) -> str:
        if not self.empty:
            history = "\n".join(
            f"""\
            <turn-{i}>
            Question: {question}
            Answer: {answer}
            {'Guess: ' + guess if not skip_guesses else ''}
            </turn-{i}>
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
            )
            return history
        return "none yet."


class Answer(rg.Model):
    content: t.Literal["yes", "no"]

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:
        for valid in ["yes", "no"]:
            if v.lower().startswith(valid):
                return valid
        raise ValueError("ç„¡åŠ¹ãªå›ç­”ã§ã™ã€'yes'ã¾ãŸã¯'no'ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}yes/no{Answer.xml_end_tag()}"


class Question(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="è³ªå•").to_pretty_xml()


class Guess(rg.Model):
    content: str_strip

    @classmethod
    def xml_example(cls) -> str:
        return Guess(content="ç‰©/å ´æ‰€").to_pretty_xml()


# é–¢æ•°

async def ask(base: rg.ChatPipeline, observation: Observation) -> str:
    if observation.step == 0:
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚°ãŒä¿®æ­£ã•ã‚Œã‚‹ã¾ã§ã€æœ€åˆã®è³ªå•ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        return "ç§ãŸã¡ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ"
    
    
    full_question = f"""\
                ã‚ãªãŸã¯ç¾åœ¨æ¬¡ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã€‚

                <game-history>
                {observation.get_history_as_xml(skip_guesses=True)}
                </game-history>

                ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ãã€æ¬¡ã«æœ€ã‚‚æœ‰ç”¨ãªã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’ã—ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ãã ã•ã„ï¼š
                {Question.xml_example()}

                - ã‚ãªãŸã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€æœ€ã‚‚å¤šãã®æƒ…å ±ã‚’é›†ã‚ã‚‹ç„¦ç‚¹ã‚’çµã£ãŸè³ªå•ã§ã‚ã‚‹ã¹ãã§ã™
                - è³ªå•ã¯ä¸€èˆ¬çš„ãªã‚‚ã®ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„
                - æ®‹ã‚Šã®æ¢ç´¢ç©ºé–“ã‚’äºŒåˆ†ã—ã¦ãã ã•ã„
                - ä»¥å‰ã®è³ªå•ã¨å›ç­”ã«æ³¨æ„ã—ã¦ãã ã•ã„

                ã‚ãªãŸã®æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ
                """
    
    print(' ======è³ªå•ä¸­ ======')
    print(full_question)
    
    
    try:
        chat = await (
             base.fork(full_question)
            .until_parsed_as(Question, attempt_recovery=True, max_rounds=20)
            .run()
        )
        return chat.last.parse(Question).content.strip('*')
    except rg.error.MessagesExhaustedMaxRoundsError:
        return 'äººã§ã™ã‹ï¼Ÿ'

async def answer(base: rg.ChatPipeline, observation: Observation) -> t.Literal["yes", "no"]:
    if not observation.keyword:
        print("å›ç­”è€…ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“", file=sys.stderr)
        return "yes" # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚°ãŒä¿®æ­£ã•ã‚Œã‚‹ã¾ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    
    last_question = observation.questions[-1]

    try:
        responses = []
        for i in range(5):
            # 5å›ãƒ«ãƒ¼ãƒ—ã—ã€æœ€ã‚‚é »ç¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
            chat = await (
                base.fork(
#                     f"""\
#                         20ã®è³ªå•ã‚²ãƒ¼ãƒ ã€‚æ¬¡ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã¯ã„/ã„ã„ãˆã§å›ç­”ã—ã¦ãã ã•ã„ï¼š[ {observation.keyword} ]

#                             è³ªå•: {last_question}

#                             ãƒ«ãƒ¼ãƒ«:
#                             1.  [{observation.keyword}] ã®ã¿ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„
#                             2. å„æ–‡å­—ã®è³ªå•ã®ãŸã‚ã«æ–‡å­—ã‚’ç¢ºèªã—ã¦ãã ã•ã„
#                             3. ã¯ã„ã¾ãŸã¯ã„ã„ãˆã®ã¿ã§ç­”ãˆã¦ãã ã•ã„

#                             ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
#                             <answer>yes</answer>
#                             ã¾ãŸã¯
#                             <answer>no</answer>

#                             ã‚ãªãŸã®å›ç­”ã¯ï¼š
#                         """
                    f"""
                    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [ {observation.keyword} ]

                    Q: {last_question}

                    ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: <answer>yes</answer> ã¾ãŸã¯ <answer>no</answer>ã§ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„
                    """
                )
                .until_parsed_as(Answer, attempt_recovery=True, max_rounds=20)
                .run()
            )
            responses.append(chat.last.parse(Answer).content.strip('*'))
            
        print(f'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ {responses}')
        return pd.Series(responses).value_counts().index[0]
    except rg.error.MessagesExhaustedMaxRoundsError:
        print('%%%%%%%%%%%% ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€yesã‚’å›ç­”ã—ã¾ã™ %%%%%%%%%%%% ')
        return 'yes'

async def guess(base: rg.ChatPipeline, observation: Observation) -> str:
    try:

        chat = await (
            base.fork(
                f"""\
                ã‚ãªãŸã¯ç¾åœ¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æƒ…å ±ã«åŸºã¥ãæ¨æ¸¬ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

                <game-history>
                {observation.get_history_as_xml()}
                </game-history>

                ä¸Šè¨˜ã®æ­´å²ã«åŸºã¥ãã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¬¡ã«æœ€é©ãªæ¨æ¸¬ã‚’1ã¤ç”Ÿæˆã—ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ãã ã•ã„ï¼š
                {Guess.xml_example()}

                - ä¸Šè¨˜ã®æ­´å²ã«åŸºã¥ã„ã¦é‡è¤‡ã—ãŸæ¨æ¸¬ã‚’é¿ã‘ã¦ãã ã•ã„
                - æ¨æ¸¬ã¯ç‰¹å®šã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

                ã‚ãªãŸã®æ¨æ¸¬ã¯ä½•ã§ã™ã‹ï¼Ÿ
                """
            )
            .until_parsed_as(Guess, attempt_recovery=True, max_rounds=20)
            .run()
        )

        return chat.last.parse(Guess).content.strip('*')
    except rg.error.MessagesExhaustedMaxRoundsError:
        return 'ãƒ•ãƒ©ãƒ³ã‚¹'
    
# vLLMã¨Generator

try:
    vllm = util.run_and_wait_for_port([
        "python", "-m",
        "vllm.entrypoints.openai.api_server",
        "--enforce-eager",
        "--model", str(g_model_path),
        "--port", str(g_vllm_port),
        "--served-model-name", g_vllm_model_name,
        "--dtype=half"
    ], g_vllm_port, {"PYTHONPATH": str(g_srvlib_path)})

    print("vLLMãŒèµ·å‹•ã—ã¾ã—ãŸ")
except ValueError:
    print('vLLMã¯ã™ã§ã«å®Ÿè¡Œä¸­ã§ã™')
    
    
generator = rg.get_generator(g_generator_id)

base =  generator.chat("""\
ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®å„ªã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚ã‚ãªãŸã¯æ­£ç¢ºã§ã€é›†ä¸­ã—ã¦ãŠã‚Šã€æ§‹é€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã‚Šã¾ã™ã€‚ã‚ãªãŸã¯æœ‰ç”¨ãªè³ªå•ã‚’ä½œæˆã—ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’è¡Œã£ãŸã‚Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æ¨æ¸¬ã‚’è¡Œã£ãŸã‚Šã—ã¾ã™ã€‚

""")

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
def format_first_letter_question(letters):
    if not letters:
        return "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã©ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    if len(letters) == 1:
        return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ–‡å­— '{letters[0]}' ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    formatted_letters = ", ".join(f"'{letter}'" for letter in letters[:-1])
    formatted_letters += f" ã¾ãŸã¯ '{letters[-1]}'"
    
    return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹: {formatted_letters}?"

import re

def extract_letters_from_question(question):
    pattern = r"'([a-zA-Z])'"
    matches = re.findall(pattern, question)
    return matches

# ã‚·ãƒ³ãƒ—ãƒ«ãªè³ªå•è€…
class SimpleQuestionerAgent():
    def __init__(self, keyword_df: pd.DataFrame):
        self.keyword_df = keyword_df
        self.keyword_df_init = keyword_df.copy()
        self.round = 0
        self.category_questions = [
            "ç§ãŸã¡ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
            "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã¯ãªã„ã‚‚ã®ã§ã™ã‹ï¼Ÿ",
            "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ",
        ]
        self.found_category = False
        
    def filter_keywords(self, obs):
        print(self.keyword_df.shape)
        # ä»¥å‰ã®å›ç­”ã«åŸºã¥ã„ã¦keyword_dfã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        for i, answer in enumerate(obs.answers):
            if obs.questions[i] in self.category_questions:
                if answer == 'yes':
                    if obs.questions[i] == "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã¯ãªã„ã‚‚ã®ã§ã™ã‹ï¼Ÿ":
                        self.found_category = 'things'
                    if obs.questions[i] == "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ":
                        self.found_category = 'place'
                    fc = self.found_category
                    self.keyword_df = self.keyword_df.query('category == @fc').reset_index(drop=True)
    
            if obs.questions[i].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹'):
                if self.keyword_df['first_letter'].nunique() <= 1:
                    break
                letter_question = obs.questions[i]
                letters = extract_letters_from_question(letter_question)
                self.keyword_df = self.keyword_df.reset_index(drop=True).copy()
                if obs.answers[i] == 'yes':
                    self.keyword_df = self.keyword_df.loc[
                        self.keyword_df['first_letter'].isin(letters)].reset_index(drop=True).copy()
                elif obs.answers[i] == 'no':
                    self.keyword_df = self.keyword_df.loc[
                        ~self.keyword_df['first_letter'].isin(letters)].reset_index(drop=True).copy()
        if len(self.keyword_df) == 0:
            # ãƒªã‚»ãƒƒãƒˆ
            self.keyword_df = self.keyword_df_init.copy()
            
    def get_letters(self, obs, max_letters=20):
        n_letters = self.keyword_df['first_letter'].nunique()
        sample_letters = self.keyword_df['first_letter'].drop_duplicates().sample(n_letters // 2).values.tolist()
        sample_letters = sample_letters[:max_letters]
        print('ã‚µãƒ³ãƒ—ãƒ«æ–‡å­—', n_letters, sample_letters)
        return sample_letters # ', '.join(sample_letters)
    
    def __call__(self, obs, *args):
        if len(self.keyword_df) == 0:
            # ãƒªã‚»ãƒƒãƒˆ
            self.keyword_df = self.keyword_df_init.copy()
        self.filter_keywords(obs)
        if obs.turnType == 'ask':
            self.round += 1
            if (self.round <= 3 and not self.found_category):
                response = self.category_questions[self.round - 1]
            else:
                sample_letters = self.get_letters(obs)
                if len(sample_letters) == 0:
                    n_sample = min(len(self.keyword_df), 10)
                    possible_keywords = ", ".join(self.keyword_df['keyword'].sample(n_sample).values.tolist())
                    response = f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®ã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ {possible_keywords}"
                else:
                    sample_letters_str = str(sample_letters).replace('[','').replace(']','')
                    response = format_first_letter_question(sample_letters)
        elif obs.turnType == 'guess':
            response = self.keyword_df['keyword'].sample(1).values[0]
            # æ¨æ¸¬ã•ã‚ŒãŸå˜èªã‚’å–ã‚Šé™¤ã
            updated_df = self.keyword_df.loc[self.keyword_df['keyword'] != response].reset_index(drop=True).copy()
            if len(updated_df) >= 1:
                self.keyword_df = updated_df.copy()
            else:
                self.keyword_df = self.keyword_df_init.copy() # dfã‚’ãƒªã‚»ãƒƒãƒˆ
#         print(f'ãƒ©ã‚¦ãƒ³ãƒ‰ {self.round}')
#         print(f"{response=}")
#         print(f'keyword_dfã‚µã‚¤ã‚º {self.keyword_df.shape}')
        return response


keyword_df = pd.read_parquet(f'{g_agent_path}/keywords.parquet')
question_agent = None

async def observe(obs: t.Any) -> str:
    observation = Observation(**obs.__dict__)
    global question_agent
    if question_agent is None:
        question_agent = SimpleQuestionerAgent(keyword_df)

    try:
        match observation.turnType:
            case "ask":
                return question_agent(obs)
            case "answer":
                return await answer(base, observation)
            case "guess":
                return question_agent(obs)

            case _:
                raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—")
    except Exception as e:
        print(str(e), file=sys.stderr)
        raise

def agent_fn(obs: t.Any, _: t.Any) -> str:
    # å½¼ã‚‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å®Ÿè¡Œã™ã‚‹ã¨ãã®éåŒæœŸã‚²ãƒ¼ãƒˆ
    import asyncio
    return asyncio.run(observe(obs))
```

---The following area is a Markdown cell (cell numver is 44)---
```markdown
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå·±è©•ä¾¡ã™ã‚‹
```

---The following area is a Code cell (cell numver is 45)---
```python
def format_first_letter_question(letters):
    if not letters:
        return "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã©ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    if len(letters) == 1:
        return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ–‡å­— '{letters[0]}' ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ"
    
    formatted_letters = ", ".join(f"'{letter}'" for letter in letters[:-1])
    formatted_letters += f" ã¾ãŸã¯ '{letters[-1]}'"
    
    return f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹: {formatted_letters}?"

format_first_letter_question(['a','b','c'])

import re

def extract_letters_from_question(question):
    pattern = r"'([a-zA-Z])'"
    matches = re.findall(pattern, question)
    return matches
```

---The following area is a Code cell (cell numver is 46)---
```python
%load_ext autoreload
%autoreload 2
from main import Observation, agent_fn, observe
```

---The following area is a Code cell (cell numver is 47)---
```python
# vllmãŒå®Ÿè¡Œä¸­ã‹ç¢ºèª
!ps -aef | grep vllm
```

---The following area is a Code cell (cell numver is 48)---
```python
import pandas as pd

keyword_df = pd.read_parquet('keywords.parquet')
sample = keyword_df.sample(1)

obs = Observation(step = 0,
    role = 'guesser',
    turnType= "ask",
    keyword= sample['keyword'].values[0],
    category= sample['category'].values[0],
    questions = [],
    answers= [],
    guesses= [],
)

question_agent = None

for i in range(20):
    obs.role = 'guesser'
    obs.turnType = 'ask'
    question = await observe(obs)
    print(f'[{i} è³ªå•]: {question}')
    obs.questions.append(question)
    obs.role = 'answerer'
    obs.turnType = 'answer'
    answer = await observe(obs)
    obs.answers.append(answer)
    
    if obs.questions[-1].startswith('ç§ãŸã¡ã¯20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ'):
        gt_answer = answer # ä½•ã§ã‚‚
    elif obs.questions[-1].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã¯ãªã„ã‚‚ã®ã§ã™ã‹ï¼Ÿ'):
        if sample['category'].values[0] == 'things':
            gt_answer = 'yes'
        else:
            gt_answer = 'no'
    elif obs.questions[-1].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ'):
        if sample['category'].values[0] == 'place':
            gt_answer = 'yes'
        else:
            gt_answer = 'no'
    elif obs.questions[-1].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹'):
        letters_guess = extract_letters_from_question(obs.questions[-1])
        gt_answer = obs.keyword[0] in letters_guess
        gt_answer = 'yes' if gt_answer else 'no'
    elif obs.questions[-1].startswith('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®ã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ'):
        possible_kw = obs.questions[-1].replace('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®ã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ ','').split(',')
        possible_kw = [c.strip(' ') for c in possible_kw]
        print(possible_kw)
        gt_answer = obs.keyword in possible_kw
        gt_answer = 'yes' if gt_answer else 'no'

    print(f'[{i} å›ç­”]: {answer} [çœŸã®å›ç­”]: {gt_answer}')
    if answer != gt_answer:
        break

    obs.role = 'guesser'
    obs.turnType = 'guess'
    guess = await observe(obs)
    print(f'[{i} æ¨æ¸¬]: {guess} - [ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰]: {obs.keyword}')
    obs.guesses.append(guess)
    if guess == obs.keyword:
        print('æ­£è§£ã§ã™ï¼')
        break
        
    obs.step += 1
```

---The following area is a Code cell (cell numver is 49)---
```python
# last_question = "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹: 'a', 'n', ã¾ãŸã¯ 'g'?"
# out = await generator.chat(f"""\
# ã‚ãªãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰[{obs.keyword}]ã«å¯¾ã—ã¦ã¯ã„/ã„ã„ãˆã®è³ªå•ã«æ­£ç¢ºã«ç­”ãˆã¾ã™ã€‚ã‚«ãƒ†ã‚´ãƒªã¯[{obs.category}]ã§ã™ã€‚

# [è³ªå•] "{last_question}" [/è³ªå•]

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯[{obs.keyword}]ã§ã™ - è³ªå•ã«ã¯ã“ã®ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãŸã‚ã«æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„ã€‚

# ä¸Šè¨˜ã®ã¯ã„/ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ãã ã•ã„ï¼š
# {Answer.xml_example()}
# """).run()
```

---The following area is a Code cell (cell numver is 50)---
```python
# last_question = "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æ¬¡ã®ã„ãšã‚Œã‹ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹: 'a', 'n', ã¾ãŸã¯ 'g'?"
# out = await generator.chat(f"""\
# ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã®ä»»å‹™ã¯ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã£ãã‚Šã¨ã—ãŸã¯ã„/ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã™ã€‚

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [{obs.keyword}]
# ã‚«ãƒ†ã‚´ãƒª: [{obs.category}]

# è³ªå•: {last_question}

# æŒ‡ç¤º:
# 1. ç­”ãˆã‚‹éš›ã«ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰[{obs.keyword}] ã®ã¿ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚
# 2. ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚
# 3. ç­”ãˆã‚’æ­£ç¢ºã«ã™ã‚‹ãŸã‚ã«å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚
# 4. ä¸‹è¨˜ã®XMLå½¢å¼ã§å›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

# ã‚ãªãŸã®å¿œç­”ã¯ã“ã®æ­£ç¢ºãªå½¢å¼ã§ã‚ã‚‹ã¹ãã§ã™:
# <answer>yes</answer>
# ã¾ãŸã¯
# <answer>no</answer>

# ã•ã‚ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰[{obs.keyword}]ã«å¯¾ã—ã¦è³ªå•ã«æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„:
# """
#                           ).run()
```

---The following area is a Code cell (cell numver is 51)---
```python
# print(out.prev[-1].content)
```

---The following area is a Code cell (cell numver is 52)---
```python
# out.last
```

---The following area is a Markdown cell (cell numver is 53)---
```markdown
# ãƒ¢ãƒ‡ãƒ«ã¨ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºç”¨ã«åœ§ç¸®
```

---The following area is a Code cell (cell numver is 54)---
```python
!apt install pigz pv
```

---The following area is a Code cell (cell numver is 55)---
```python
!tar --use-compress-program='pigz --fast' \
    -cf submission.tar.gz \
    --dereference \
    -C /kaggle/tmp model lib srvlib \
    -C /kaggle/working main.py util.py \
    -C /kaggle/working keywords.parquet
```

---The following area is a Code cell (cell numver is 56)---
```python
!ls -GFlash --color
```

---The following area is a Markdown cell (cell numver is 57)---
```markdown
# Kaggle CLIã‚’ä½¿ç”¨ã—ã¦æå‡º

å¿…è¦ã«å¿œã˜ã¦ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å†å®Ÿè¡Œã›ãšã«Kaggle CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦æå‡ºã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 58)---
```python
# !KAGGLE_USERNAME={KAGGLE_USERNAME} \
#  KAGGLE_KEY={KAGGLE_KEY} \
#  kaggle competitions submit -c llm-20-questions -f submission.tar.gz -m "ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰æå‡º"
```

** @@@ Jupyter Notebook numver 22, the number of votes :12 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã§é–‹å‚¬ã•ã‚Œã¦ã„ã‚‹ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãŠã‚Šã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’æ´»ç”¨ã—ã¦ä¼çµ±çš„ãªã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

## å•é¡Œã®èª¬æ˜
ã€Œ20ã®è³ªå•ã€ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’20å€‹ä»¥ä¸‹ã®è³ªå•ã§å½“ã¦ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯Yes/Noå½¢å¼ã®è³ªå•ã‚’ä½¿ç”¨ã—ã€ä¸€èˆ¬çš„ãªè³ªå•ã‹ã‚‰å…·ä½“çš„ãªè³ªå•ã¸ã¨çµã‚Šè¾¼ã‚€ã“ã¨ã§ã€åŠ¹ç‡è‰¯ãã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒšã§ã¯ã€å„ãƒãƒ¼ãƒ ãŒè³ªå•ã‚’è¡Œã†ã€ŒGuesser LLMã€ã¨å›ç­”ã™ã‚‹ã€ŒAnswerer LLMã€ã®2ã¤ã®ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨æ„ã—ã€ã‚²ãƒ¼ãƒ ã‚’é€²è¡Œã•ã›ã¾ã™ã€‚

## è§£æ±ºæ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Guesser LLM**: è³ªå•ã‚’ç”Ÿæˆã—ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã€‚
- **Answerer LLM**: è³ªå•ã«ã€ŒYesã€ã¾ãŸã¯ã€ŒNoã€ã§å›ç­”ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã€‚
- å„ãƒãƒ¼ãƒ ã¯å¯¾æˆ¦ã‚’è¡Œã„ã€å…ˆã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ãŸãƒãƒ¼ãƒ ãŒå‹åˆ©ã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒšã¯å”åŠ›å½¢å¼ï¼ˆ2å¯¾2ï¼‰ã§é€²è¡Œã—ã€æå‡ºç‰©ã¯ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ä¸Šã§ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«åŸºã¥ã„ã¦è©•ä¾¡ãƒ»å¯¾æˆ¦ã•ã‚Œã¾ã™ã€‚ãƒœãƒƒãƒˆã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã‚¬ã‚¦ã‚¹åˆ†å¸ƒã§ãƒ¢ãƒ‡ãƒ«åŒ–ã•ã‚Œã€å¯¾æˆ¦çµæœã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¾ã™ã€‚æœ€çµ‚çš„ãªè©•ä¾¡ã¯ã€æ–°ã—ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦è¡Œã‚ã‚Œã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãŒæ±ºå®šã•ã‚Œã‚‹ã“ã¨ã§è©•ä¾¡ãŒç¤ºã•ã‚Œã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒšã§ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã®æ¨è«–èƒ½åŠ›ã€æƒ…å ±åé›†ã®åŠ¹ç‡æ€§ã€ãƒšã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”åŠ›ã¨ã„ã£ãŸé‡è¦ãªã‚¹ã‚­ãƒ«ãŒè©¦ã•ã‚Œã€å‚åŠ è€…ã¯é™ã‚‰ã‚ŒãŸè³ªå•å›æ•°ã®ä¸­ã§å‰µé€ æ€§ã¨æˆ¦ç•¥æ€§ã‚’ç™ºæ®ã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# LLM 20 Questions ã‚³ãƒ³ãƒšã®æ¦‚è¦

Kaggleã§é–‹å‚¬ã•ã‚Œã¦ã„ã‚‹ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ä½¿ã£ã¦ä¼çµ±çš„ãªã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

## ã‚²ãƒ¼ãƒ ã®èª¬æ˜

- ã€Œ20ã®è³ªå•ã€ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’20å€‹ä»¥ä¸‹ã®è³ªå•ã§å½“ã¦ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯Yes/Noå½¢å¼ã®è³ªå•ã‚’ä½¿ã£ã¦ã€ä¸€èˆ¬çš„ãªè³ªå•ã‹ã‚‰å…·ä½“çš„ãªè³ªå•ã¸ã¨çµã‚Šè¾¼ã‚“ã§ã„ãã¾ã™ã€‚
- æœ€çµ‚çš„ã«ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•æ•°ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ã‚‹ã“ã¨ãŒç›®æ¨™ã§ã™ã€‚

## ã‚³ãƒ³ãƒšã®å½¢å¼

- å„ãƒãƒ¼ãƒ ã¯ã€è³ªå•ã‚’ã™ã‚‹ã€ŒGuesser LLMã€ã¨ç­”ãˆã‚‹ã€ŒAnswerer LLMã€ã®2ã¤ã®LLMã§æ§‹æˆã•ã‚Œã¾ã™ã€‚
- Guesser LLMã¯è³ªå•ã‚’æŠ•ã’ã‹ã‘ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¾ã™ã€‚
- Answerer LLMã¯ã€ŒYesã€ã¾ãŸã¯ã€ŒNoã€ã§å›ç­”ã—ã¾ã™ã€‚
- 2ã¤ã®ãƒãƒ¼ãƒ ãŒå¯¾æˆ¦ã—ã€å…ˆã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ãŸãƒãƒ¼ãƒ ãŒå‹åˆ©ã—ã¾ã™ã€‚

## è©•ä¾¡æ–¹æ³•

- 1æ—¥ã«æœ€å¤§5ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒœãƒƒãƒˆï¼‰ã‚’ã‚³ãƒ³ãƒšã«æå‡ºã§ãã¾ã™ã€‚
- å„æå‡ºç‰©ã¯ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ä¸Šã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä¼¼ã¦ã„ã‚‹ãƒœãƒƒãƒˆã¨å¯¾æˆ¦ã—ã¾ã™ã€‚
- å‹åˆ©ã§ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä¸ŠãŒã‚Šã€æ•—åŒ—ã§ä¸‹ãŒã‚Šã€å¼•ãåˆ†ã‘ã§å‡ç­‰ã«ãªã‚Šã¾ã™ã€‚
- ã‚³ãƒ³ãƒšã¯å”åŠ›å½¢å¼ï¼ˆ2å¯¾2ï¼‰ã§è¡Œã‚ã‚Œã€åŒã˜ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒœãƒƒãƒˆã¨ãƒšã‚¢ã‚’çµ„ã¿ã¾ã™ã€‚
- ãƒšã‚¢å†…ã§ä¸€æ–¹ãŒGuesserã€ã‚‚ã†ä¸€æ–¹ãŒAnswererã«ãƒ©ãƒ³ãƒ€ãƒ ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚
- ãƒšã‚¢ã§å‹æ•—ãŒæ±ºã¾ã‚‹ãŸã‚ã€å”åŠ›ã—ã¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

## ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

- å„ãƒœãƒƒãƒˆã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ã€ã‚¬ã‚¦ã‚¹åˆ†å¸ƒN(Î¼,Ïƒ^2)ã§ãƒ¢ãƒ‡ãƒ«åŒ–ã•ã‚Œã¾ã™ã€‚
- Î¼ã¯æ¨å®šã‚¹ã‚­ãƒ«ã€Ïƒã¯æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ã—ã¾ã™ã€‚
- å¯¾æˆ¦çµæœã«åŸºã¥ã„ã¦ã€Î¼ã¨ÏƒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚
- å‹åˆ©ã—ãŸãƒšã‚¢ã®Î¼ã¯ä¸ŠãŒã‚Šã€æ•—åŒ—ã—ãŸãƒšã‚¢ã®Î¼ã¯ä¸‹ãŒã‚Šã¾ã™ã€‚
- å¼•ãåˆ†ã‘ã®å ´åˆã€Î¼ã¯å¹³å‡å€¤ã«è¿‘ã¥ãã¾ã™ã€‚

## æœ€çµ‚è©•ä¾¡

- 2024å¹´8æœˆ13æ—¥ã®æå‡ºç· åˆ‡æ—¥ã«ã€æå‡ºç‰©ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚
- 2024å¹´8æœˆ13æ—¥ã‹ã‚‰8æœˆ27æ—¥ã¾ã§ã€æ–°ã—ã„éå…¬é–‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦å¯¾æˆ¦ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
- ã“ã®æœŸé–“ã®çµ‚äº†æ™‚ã«ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãŒæœ€çµ‚æ±ºå®šã•ã‚Œã¾ã™ã€‚

## è³é‡‘

- 1ä½: $12,000
- 2ä½: $10,000
- 3ä½: $10,000
- 4ä½: $10,000
- 5ä½: $8,000

ã“ã®ã‚³ãƒ³ãƒšã‚’é€šã˜ã¦ã€LLMã®æ¨è«–èƒ½åŠ›ã€åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã€ãƒšã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”åŠ›ãªã©ã®é‡è¦ãªã‚¹ã‚­ãƒ«ãŒè©•ä¾¡ã•ã‚Œã¾ã™ã€‚é™ã‚‰ã‚ŒãŸæ¨æ¸¬å›æ•°ã®ä¸­ã§ã€å‰µé€ æ€§ã¨æˆ¦ç•¥æ€§ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹æŒ‘æˆ¦çš„ãªã‚³ãƒ³ãƒšã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 23, the number of votes :11 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€è¨€è‘‰å½“ã¦ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã«é–¢é€£ã™ã‚‹å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã€è¦–è¦šåŒ–ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è³ªå•å›æ•°ã‚„å€™è£œæ•°ã®æ¸›å°‘ã«åŸºã¥ã„ã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã«ãŠã‘ã‚‹ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚

### ä¸»è¦ãªå•é¡Œ
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸€å®šã®ãƒ©ã‚¦ãƒ³ãƒ‰å†…ã§æ­£è§£ã‚’å°ãå‡ºã™ç¢ºç‡ã‚’ç®—å‡ºã—ã€ç•°ãªã‚‹å€™è£œã®æ¸›å°‘ç‡ã«å¯¾ã™ã‚‹å½±éŸ¿ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **numpy**ï¼ˆæš—é»™çš„ã«ä½¿ç”¨ï¼‰ï¼šè¨ˆç®—ã‚’åŠ¹ç‡è‰¯ãè¡Œã†ãŸã‚ã«åˆ©ç”¨ã€‚
2. **matplotlib**: å‹åˆ©ç¢ºç‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãŸã‚ã®ã‚°ãƒ©ãƒ•æç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

### ä¸»ãªé–¢æ•°
- `calculate_win_probabilities(N, rounds, reduction_factor)`: ä¸ãˆã‚‰ã‚ŒãŸåˆæœŸã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ï¼ˆNï¼‰ã€ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã€ãã—ã¦å€™è£œã®æ¸›å°‘ç‡ã«åŸºã¥ã„ã¦å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã€ãƒªã‚¹ãƒˆã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
- `plot_cumulative_probabilities(probabilities_dict)`: è¤‡æ•°ã®æ¸›å°‘ç‡ã«å¯¾ã™ã‚‹ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’è¦–è¦šåŒ–ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒƒãƒˆé–¢æ•°ã§ã€å‹åˆ©ç¢ºç‡ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚
- `main()`: åˆæœŸæ¡ä»¶ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã€è¨ˆç®—ã—ãŸå‹åˆ©ç¢ºç‡ã‚’å‡ºåŠ›ã—ãŸã‚Šã€ãƒ—ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### çµæœ
æœ€çµ‚çš„ã«ã€ç•°ãªã‚‹æ¸›å°‘ç‡ã«ãŠã‘ã‚‹å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ã®ç´¯ç©ç¢ºç‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã—ã€å…·ä½“çš„ãªæ•°å€¤çµæœã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã€å‹åˆ©ç¢ºç‡ã®å¤‰åŒ–ã‚’è¦–è¦šçš„ã«ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚²ãƒ¼ãƒ æˆ¦ç•¥ã‚’è€ƒãˆã‚‹ä¸Šã§ã®æ´å¯Ÿã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import matplotlib.pyplot as plt

def calculate_win_probabilities(N: int, rounds: int, reduction_factor: float) -> list[float]:
    """
    å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—è¡¨ç¤ºã™ã‚‹é–¢æ•°ã€‚

    å¼•æ•°:
        N (int): åˆæœŸã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°
        rounds (int): è³ªå•ã®ç·æ•°
        reduction_factor (float): å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«å€™è£œã®æ•°ãŒæ¸›å°‘ã™ã‚‹å‰²åˆ

    æˆ»ã‚Šå€¤:
        list[float]: å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡
    """
    cumulative_probabilities = []  # ç´¯ç©ç¢ºç‡ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
    previous_prob = 0  # å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ç¢ºç‡

    # å„ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¯¾ã—ã¦å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—
    for k in range(1, rounds + 1):
        Nk = N * (reduction_factor ** k)  # ç¾åœ¨ã®å€™è£œã®æ•°ã‚’è¨ˆç®—
        current_prob = (1 - previous_prob) * (1 / Nk)  # ç¾åœ¨ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—
        previous_prob += current_prob  # ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’æ›´æ–°
        if previous_prob > 1:
            previous_prob = 1  # å‹åˆ©ç¢ºç‡ãŒ1ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        cumulative_probabilities.append(previous_prob)  # çµæœã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 

    return cumulative_probabilities

def plot_cumulative_probabilities(probabilities_dict: dict[float, list[float]]):
    """
    ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹é–¢æ•°ã€‚

    å¼•æ•°:
        probabilities_dict (dict[float, list[float]]): å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã®è¾æ›¸
    """
    plt.figure(figsize=(12, 8))  # ãƒ—ãƒ­ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
    
    # å„æ¸›å°‘ç‡ã«å¯¾ã—ã¦ãƒ—ãƒ­ãƒƒãƒˆ
    for reduction_factor, probabilities in probabilities_dict.items():
        rounds = range(1, len(probabilities) + 1)  # ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã®ãƒªã‚¹ãƒˆ
        plt.plot(rounds, probabilities, marker='o', linestyle='-', label=f'æ¸›å°‘ç‡ = {reduction_factor}')

    plt.xlabel('ãƒ©ã‚¦ãƒ³ãƒ‰')  # xè»¸ãƒ©ãƒ™ãƒ«
    plt.ylabel('å‹åˆ©ã®ç´¯ç©ç¢ºç‡')  # yè»¸ãƒ©ãƒ™ãƒ«
    plt.title('ç•°ãªã‚‹æ¸›å°‘ç‡ã«ãŠã‘ã‚‹å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ã®ç´¯ç©ç¢ºç‡')  # ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«
    plt.grid(True)  # ã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤º
    plt.xticks(range(1, 21))  # xè»¸ã®ç›®ç››ã‚Š
    plt.yticks([i/10 for i in range(11)])  # yè»¸ã®ç›®ç››ã‚Š
    plt.ylim(0, 1)  # yè»¸ã®ç¯„å›²
    plt.legend()  # å‡¡ä¾‹ã‚’è¡¨ç¤º
    plt.show()  # ãƒ—ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º

def main():
    N = 1024  # åˆæœŸã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°
    rounds = 20  # ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
    reduction_factors = [0.5, 0.6, 0.7, 0.8, 0.9, 1.0]  # æ¸›å°‘ç‡ã®ãƒªã‚¹ãƒˆ
    probabilities_dict = {}  # ç¢ºç‡ã‚’æ ¼ç´ã™ã‚‹è¾æ›¸

    # å„æ¸›å°‘ç‡ã«å¯¾ã—ã¦ç´¯ç©ç¢ºç‡ã‚’è¨ˆç®—
    for reduction_factor in reduction_factors:
        probabilities = calculate_win_probabilities(N, rounds, reduction_factor)  # å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—
        probabilities_dict[reduction_factor] = probabilities  # çµæœã‚’è¾æ›¸ã«æ ¼ç´
        # å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ç¢ºç‡ã‚’å‡ºåŠ›
        for i, prob in enumerate(probabilities, 1):
            print(f"æ¸›å°‘ç‡ {reduction_factor}, ãƒ©ã‚¦ãƒ³ãƒ‰ {i}: å‹åˆ©ã®ç´¯ç©ç¢ºç‡ = {prob:.10f}")

    plot_cumulative_probabilities(probabilities_dict)  # ãƒ—ãƒ­ãƒƒãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã™

if __name__ == "__main__":
    main()  # ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚’å®Ÿè¡Œ
```

---The following area is a Markdown cell (cell numver is 2)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Mohamed MZAOUALI
> 
> ã‚ˆãã§ãã¾ã—ãŸï¼
> 
> 
>
```

** @@@ Jupyter Notebook numver 24, the number of votes :10 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã€å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚Šã€ç‰¹ã«æ¨æ¸¬è€…ï¼ˆGuesserï¼‰ãŠã‚ˆã³å›ç­”è€…ï¼ˆAnswererï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•åŒ–ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã¯ã€å–ã‚Šçµ„ã¾ã‚Œã¦ã„ã‚‹å•é¡Œã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã®è¦ç´„ã§ã™ã€‚

## å•é¡Œ
ã“ã®Notebookã¯ã€2å¯¾2ã®å”åŠ›ãƒ—ãƒ¬ã‚¤å½¢å¼ã§è¡Œã‚ã‚Œã‚‹ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒã©ã®ã‚ˆã†ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã€è³ªå•ã‚’ã—ã€å›ç­”ã‚’è¡Œã†ã‹ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è¦æ±‚ã•ã‚ŒãŸæƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ­£è§£ã‚’å°ãã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

## æ‰‹æ³•
### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯
- **æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`guesser_agent`)**: ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚„éå»ã®è³ªå•ãƒ»å›ç­”å±¥æ­´ã‚’å…ƒã«ã€æ¬¡ã«è¡Œã†è³ªå•ã‚„æ¨æ¸¬ã‚’å‹•çš„ã«ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«åˆã‚ã›ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’å¾—ã¾ã™ã€‚
  
- **å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`answerer_agent`)**: è³ªå•ã‚’å—ã‘å–ã‚Šã€åŸºã¥ã„ã¦ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã¾ãŸã¯ã€Œã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ã„ã£ãŸå¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ã„ãŸæ­£ç¢ºãªå¿œç­”ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Pandas**: ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚„æ“ä½œã«ä½¿ç”¨ã€‚
- **JSON**: ã‚²ãƒ¼ãƒ ã®è¨­å®šã‚„è¦³å¯Ÿçµæœã®èª­ã¿è¾¼ã¿ã«ä½¿ç”¨ã€‚
- **Torch** ã¨ **Transformers**: T5ãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦è‡ªç„¶è¨€èªã®è³ªå•å¿œç­”å‡¦ç†ã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- **Kaggle Environments**: ã‚²ãƒ¼ãƒ ã®ç’°å¢ƒã‚’ç”Ÿæˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è¨­å®š
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é¸æŠ**: ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã€ã‚²ãƒ¼ãƒ ã®é–‹å§‹ã‚’æº–å‚™ã—ã¾ã™ã€‚
  
### ã‚²ãƒ¼ãƒ ã®ãƒ­ã‚¸ãƒƒã‚¯
- ã‚²ãƒ¼ãƒ ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé·ç§»ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ¶å¾¡ã‚’é€šã˜ã¦é€²è¡Œã—ã€çµ‚äº†æ¡ä»¶ãŒæº€ãŸã•ã‚Œã‚‹ã¾ã§ç¶šãã¾ã™ã€‚æ¨æ¸¬ãŒæˆåŠŸã™ã‚‹ã‹ã€æ™‚é–“åˆ‡ã‚Œã‚„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‹ã§ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã™ã€‚

## ç•™æ„ç‚¹
- ã‚²ãƒ¼ãƒ ãŒé€²è¡Œã™ã‚‹ä¸­ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµŒã¦çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€çµæœã«åŸºã¥ã„ãŸå ±é…¬ã‚’å—ã‘ã¾ã™ã€‚ã¾ãŸã€å¿œç­”ãŒç„¡åŠ¹ã¾ãŸã¯ä¸æ­£ç¢ºãªå ´åˆã«ã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã•ã›ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã“ã®Notebookã¯ã€AIã‚’ç”¨ã„ãŸã‚²ãƒ¼ãƒ ã¸ã®å¿œç”¨ã®ä¸€ä¾‹ã‚’ç¤ºã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è‡ªå¾‹çš„ãªå‹•ä½œã‚’é€šã˜ã¦æ¨ç†ã‚„æˆ¦ç•¥çš„æ€è€ƒã‚’è©•ä¾¡ã§ãã‚‹æ–¹æ³•ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ChatGPTã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦æ–‡æ›¸åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

# æœ€åˆã®è¨­å®š
å®Ÿè¡Œç’°å¢ƒã®æ§‹æˆã€çŠ¶æ…‹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®šæ•°ã‚’å®šç¾©ã—ã€ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®ä»£æ›¿ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®é–‹å§‹æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
import sys
```

---The following area is a Code cell (cell numver is 3)---
```python
import json
import os
import pandas as pd
import random
import string
import torch
sys.path.append("/kaggle/input/llm-20-questions/llm_20_questions")

from  keywords import KEYWORDS_JSON
from os import path
from pathlib import Path
from random import choice
from string import Template
from transformers import T5Tokenizer, T5ForConditionalGeneration
llm_parent_dir = "/kaggle/input/flan-t5/pytorch/large"
device = None
model = None
tokenizer = None
model_initialized = False
ERROR = "ERROR"
DONE = "DONE"
INACTIVE = "INACTIVE"
ACTIVE = "ACTIVE"
TIMEOUT = "TIMEOUT"
GUESS = "guess"
ASK = "ask"
GUESSER = "guesser"
ANSWERER = "guesser"
keywords_list = json.loads(KEYWORDS_JSON)
keyword_cat = random.choice(keywords_list)
category = keyword_cat["category"]
keyword_obj = random.choice(keyword_cat["words"])
keyword = keyword_obj["keyword"]
alts = keyword_obj["alts"]
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
# æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

`guesser_agent`é–¢æ•°ã¯ã€ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¨ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã«åŸºã¥ã„ã¦å‹•çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã«è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ï¼š

1. ã“ã‚Œã¾ã§ã®è³ªå•ã¨å›ç­”ã®å±¥æ­´ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
2. ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆè³ªå•ã¾ãŸã¯æ¨æ¸¬ï¼‰ã‚’é¸æŠã—ã¾ã™ã€‚
3. æ§‹ç¯‰ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
def guesser_agent(obs):
    info_prompt = """20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ãŠã‚Šã€è³ªå•ã‚’ã—ãªãŒã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç‰¹å®šã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãã‚Œã¾ã§ã®æƒ…å ±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:\n{q_a_thread}"""
    questions_prompt = """ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’1ã¤ã—ã¦ãã ã•ã„ã€‚"""
    guess_prompt = """ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ­£ç¢ºãªå˜èª/ãƒ•ãƒ¬ãƒ¼ã‚ºã ã‘ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚ãŸã¨ãˆã°ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ[ãƒ‘ãƒª]ã ã¨æ€ã†ãªã‚‰ã€[ç§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãƒ‘ãƒªã ã¨æ€ã„ã¾ã™]ã‚„[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãƒ‘ãƒªã§ã™ã‹ï¼Ÿ]ã¨ã¯å¿œç­”ã›ãšã€å˜ã«[ãƒ‘ãƒª]ã¨è¨€ã£ã¦ãã ã•ã„ã€‚"""
    q_a_thread = ""
    for i in range(0, len(obs.answers)):
        q_a_thread = "{}Q: {} A: {}\n".format(
            q_a_thread,
            obs.questions[i],
            obs.answers[i]
        )
    prompt = ""
    if obs.turnType == ASK:
        prompt = "{}{}".format(
            info_prompt.format(q_a_thread=q_a_thread),
            questions_prompt
        )
    elif obs.turnType == GUESS:
        prompt = "{}{}".format(
            info_prompt.format(q_a_thread=q_a_thread),
            guess_prompt
        )
    else:
        return ""
    
    return call_llm(prompt)
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
# å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
`answerer_agent`é–¢æ•°ã¯ï¼š

1. ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ãŒã€Œanswerã€ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

1. ãã†ã§ã‚ã‚Œã°ã€info_promptã¨answer_question_promptã‚’çµ„ã¿åˆã‚ã›ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã€å®Ÿéš›ã®å€¤ã§ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ç½®ãæ›ãˆã¾ã™ã€‚

1. ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦call_llmé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€å¿œç­”ã‚’å–å¾—ã—ã¾ã™ã€‚

1. ã‚¿ãƒ¼ãƒ³ãŒã€Œanswerã€ã§ãªã„å ´åˆã¯ã€ç©ºã®æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ã€‚

1. agentsè¾æ›¸ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’ã‚²ãƒ¼ãƒ å†…ã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã™ã‚‹å½¹å‰²ã«ãƒãƒƒãƒ—ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
def answerer_agent(obs):
    info_prompt = """ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã§éå¸¸ã«æ­£ç¢ºãªå›ç­”è€…ã§ã™ã€‚è³ªå•è€…ãŒæ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯[the {category} {keyword}]ã§ã™ã€‚"""
    answer_question_prompt = """æ¬¡ã®è³ªå•ã«å¯¾ã—ã¦ã€Œã¯ã„ã€ã€ã€Œã„ã„ãˆã€ã¾ãŸã¯ã€Œã‚‚ã—ä¸æ˜ãªã‚‰ã€Œã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ã ã‘å›ç­”ã—ã¦ãã ã•ã„: {question}"""
    if obs.turnType == "answer":
        prompt = "{}{}".format(
            info_prompt.format(category=category,keyword=keyword),
            answer_question_prompt.format(question=obs.questions[-1])
        )
        return call_llm(prompt)
    else: 
        return ""
agents = {GUESSER: guesser_agent, ANSWERER: answerer_agent}
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
# æ¨æ¸¬è€…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### é–¢æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
1. **`guessed`å¤‰æ•°ã®åˆæœŸåŒ–**:
   - `guessed`å¤‰æ•°ã¯`False`ã¨ã—ã¦åˆæœŸåŒ–ã•ã‚Œã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãæ¨æ¸¬ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’è¿½è·¡ã—ã¾ã™ã€‚
   ```python
   guessed = False
   ```
2. **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã®ãƒã‚§ãƒƒã‚¯**:
   - `active.action`ãŒç©ºã§ã‚ã‚‹å ´åˆï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã‹ã£ãŸå ´åˆï¼‰ã€`active`ã®çŠ¶æ…‹ãŒ`ERROR`ã«è¨­å®šã•ã‚Œã¾ã™ã€‚
   ```python
   if not active.action:
       active.status = ERROR
   ```
3. **è³ªå•ã‚’ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†**:
   - è¦³æ¸¬è€…ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆ`turnType`ï¼‰ãŒ`ASK`ï¼ˆè³ªå•ã‚’ã™ã‚‹ï¼‰ã§ã‚ã‚‹å ´åˆï¼š
     - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`active.action`ï¼‰ã¯è³ªå•ã¨ã—ã¦æ‰±ã‚ã‚Œã€2000æ–‡å­—ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
     - è³ªå•ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®è¦³æ¸¬è€…ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
   ```python
   elif active.observation.turnType == ASK:
       question = active.action[:2000]
       active.observation.questions.append(question)
       inactive.observation.questions.append(question)
   ```
4. **æ¨æ¸¬ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†**:
   - è¦³æ¸¬è€…ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ãŒ`GUESS`ï¼ˆæ¨æ¸¬ã™ã‚‹ï¼‰ã§ã‚ã‚‹å ´åˆï¼š
     - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`active.action`ï¼‰ã¯æ¨æ¸¬ã¨ã—ã¦æ‰±ã‚ã‚Œã€100æ–‡å­—ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
     - æ¨æ¸¬ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®è¦³æ¸¬è€…ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
   ```python
   elif active.observation.turnType == GUESS:
       guess = active.action[:100]
       active.observation.guesses.append(guess)
       inactive.observation.guesses.append(guess)
   ```
5. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¨æ¸¬ã•ã‚ŒãŸã‹ã®ãƒã‚§ãƒƒã‚¯**:
   - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`active.action`ï¼‰ãŒã‚ã‚Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãæ¨æ¸¬ã•ã‚ŒãŸå ´åˆï¼ˆ`keyword_guessed(active.action)`ï¼‰ï¼š
     - `guessed`å¤‰æ•°ãŒ`True`ã«è¨­å®šã•ã‚Œã¾ã™ã€‚
     - ã‚¹ã‚³ã‚¢ãŒ`20 - int(step / 3)`ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã€`step`ã¯ã‚²ãƒ¼ãƒ å†…ã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’è¡¨ã—ã¾ã™ã€‚
     - ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹ãŸã‚ã«ã€`end_game`é–¢æ•°ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®è¦³æ¸¬è€…ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
   ```python
   if active.action and keyword_guessed(active.action):
       guessed = True
       score = 20 - int(step / 3)
       end_game(active, inactive, score, DONE, DONE)
   ```
6. **`guessed`å¤‰æ•°ã®è¿”å´**:
   - é–¢æ•°ã¯`guessed`å¤‰æ•°ã‚’è¿”ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãæ¨æ¸¬ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ç¤ºã—ã¾ã™ã€‚
   ```python
   return guessed
   ```
```

---The following area is a Code cell (cell numver is 9)---
```python
def guesser_action(active, inactive, step):
    guessed = False
    if not active.action:
        active.status = ERROR
    elif active.observation.turnType == ASK:
        question = active.action[:2000]
        active.observation.questions.append(question)
        inactive.observation.questions.append(question)
    elif active.observation.turnType == GUESS:
        guess = active.action[:100]
        active.observation.guesses.append(guess)
        inactive.observation.guesses.append(guess)
    if active.action and keyword_guessed(active.action):
        guessed = True
        score = 20 - int(step / 3)
        end_game(active, inactive, score, DONE, DONE)
    return guessed
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
# ã‚²ãƒ¼ãƒ ã®çµ‚äº†
`end_game`é–¢æ•°ã¯ã€ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã•ã›ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ï¼š
- ä¸¡å‚åŠ è€…ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
- ä¸¡å‚åŠ è€…ã«å ±é…¬ã‚’ä¸ãˆã¾ã™ã€‚
- ä¸¡å‚åŠ è€…ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®å‚åŠ è€…ãŒæ­£ã—ã„ã‚¨ãƒ³ãƒ‰ã‚²ãƒ¼ãƒ æƒ…å ±ã‚’æŒã¡ã€å½¼ã‚‰ã®çŠ¶æ…‹ãŒã‚²ãƒ¼ãƒ ã®çµè«–ã‚’åæ˜ ã™ã‚‹ã‚ˆã†ã«é©åˆ‡ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 11)---
```python
def end_game(active, inactive, reward, status, inactive_status):
    active.observation.keyword = keyword
    active.observation.category = category
    inactive.observation.keyword = keyword
    inactive.observation.category = category
    active.reward = reward
    inactive.reward = reward
    active.status = status
    inactive.status = inactive_status
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
# å›ç­”è€…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

`answerer_action`é–¢æ•°ã¯ã€å›ç­”è€…ã®è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚’å‡¦ç†ã—ã¾ã™ï¼š
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‚åŠ è€…ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
- å¿œç­”ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€ã€Œã¯ã„ã€ã€ã€Œã„ã„ãˆã€ã¾ãŸã¯ã€Œã‹ã‚‚ã—ã‚Œãªã„ã€ã«æ­£è¦åŒ–ã—ã¾ã™ã€‚
- å¿œç­”ãŒç„¡åŠ¹ã¾ãŸã¯ç©ºã§ã‚ã‚Œã°ã€ã‚¨ãƒ©ãƒ¼ã‚’ä¼´ã„ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚
- ã“ã®å¿œç­”ã‚’ä¸¡å‚åŠ è€…ã®å›ç­”ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚

ã“ã®é–¢æ•°ã«ã‚ˆã‚Šã€å›ç­”è€…ã®å¿œç­”ã«åŸºã¥ã„ã¦ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ãŒé©åˆ‡ã«æ›´æ–°ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ã‚„ç„¡åŠ¹ãªå¿œç­”ã‚’å‡¦ç†ã—ã¦ã€ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã§ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚

**å›ç­”ã®æ›´æ–°**

```python
active.observation.answers.append(response)
inactive.observation.answers.append(response)
```
æ­£è¦åŒ–ã•ã‚ŒãŸ`response`ã¯ã€`active`ãŠã‚ˆã³`inactive`ã®ä¸¡å‚åŠ è€…ã®`answers`ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¸¡å‚åŠ è€…ãŒå›ç­”è€…ã®å¿œç­”ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 13)---
```python
def answerer_action(active, inactive):
    active.observation.keyword = keyword
    active.observation.category = category
    response = active.action
    if not response:
        response = "none"
        end_game(active, inactive, -1, ERROR, DONE)
    elif "yes" in response.lower():
        response = "yes"
    elif "no" in response.lower():
        response = "no"
    else:
        response = "maybe"
        end_game(active, inactive, -1, ERROR, DONE)
    active.observation.answers.append(response)
    inactive.observation.answers.append(response)
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
# ã‚¿ãƒ¼ãƒ³ã®å¢—åˆ†
`increment_turn`é–¢æ•°ã¯ï¼š
1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¨æ¸¬ã•ã‚Œãªã‹ã£ãŸå ´åˆã€60ã‚¹ãƒ†ãƒƒãƒ—å¾Œã«ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚
2. ã€Œaskã€ã¨ã€Œguessã€ã®é–“ã§ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã‚’åˆ‡ã‚Šæ›¿ãˆã€è³ªå•ã¨æ¨æ¸¬ã®å½¹å‰²ã‚’äº¤ä»£ã—ã¾ã™ã€‚
3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–å‚åŠ è€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«ã©ã®å‚åŠ è€…ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¨ãªã‚‹ã‹ã‚’æ­£ã—ãç¢ºä¿ã—ã¾ã™ã€‚

ã“ã®é–¢æ•°ã«ã‚ˆã‚Šã€ã‚²ãƒ¼ãƒ ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²è¡Œã—ã€å‚åŠ è€…é–“ã§å½¹å‰²ãŒäº¤æ›¿ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¨æ¸¬ã•ã‚Œãªã‹ã£ãŸå ´åˆã«é©åˆ‡ã«ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
def increment_turn(active, inactive, step, guessed):
    if step == 59 and not guessed:
        end_game(active, inactive, -1, DONE, DONE)
    elif active.observation.turnType == "guess":
        active.observation.turnType = "ask"
    elif active.observation.turnType == "ask":
        active.observation.turnType = "guess"
        active.status = INACTIVE
        inactive.status = ACTIVE
    else:
        active.status = INACTIVE
        inactive.status = ACTIVE
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
# ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿

### `interpreter`é–¢æ•°ã®ç›®çš„

`interpreter`é–¢æ•°ã¯ã€2å¯¾ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚å„ãƒšã‚¢ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ä¸€æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•ã‚’ã—ï¼ˆã€Œè³ªå•è€…ã€ï¼‰ã€ã‚‚ã†ä¸€æ–¹ãŒæ¨æ¸¬ã‚’è¡Œã„ã¾ã™ï¼ˆã€Œæ¨æ¸¬è€…ã€ï¼‰ã€‚é–¢æ•°ã¯ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå–ã‚‹ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã—ã€é·ç§»ã¨çµ‚äº†æ¡ä»¶ã‚’å‡¦ç†ã—ã¾ã™ã€‚

### ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜

```python
def interpreter(state, env):
    if env.done:
        return state
```

ã“ã®è¡Œã¯ã€ç’°å¢ƒï¼ˆã‚²ãƒ¼ãƒ ï¼‰ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã€é–¢æ•°ã¯ç¾åœ¨ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã«è¿”ã—ã¾ã™ã€‚

### ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆ†é›¢

```python
    active1 = state[0] if state[0].status == ACTIVE else state[1]
    inactive1 = state[0] if state[0].status == INACTIVE else state[1]
    active2 = state[2] if state[2].status == ACTIVE else state[3]
    inactive2 = state[2] if state[2].status == INACTIVE else state[3]
```

ã“ã‚Œã‚‰ã®è¡Œã¯ã€å„ãƒšã‚¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç‰¹å®šã—ã¾ã™ã€‚`state[0]`ã¨`state[1]`ã¯æœ€åˆã®ãƒšã‚¢ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã€`state[2]`ã¨`state[3]`ã¯2ç•ªç›®ã®ãƒšã‚¢ã§ã™ã€‚

### å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å‡¦ç†

```python
    if active1.status == DONE and inactive1.status == DONE:
        active1 = None
        inactive1 = None
    if active2.status == DONE or inactive2.status == DONE:
        active2 = None
        inactive2 = None
    if active1 is None and inactive1 is None and active2 is None and inactive2 is None:
        return state
```

ã“ã‚Œã‚‰ã®è¡Œã¯ã€ãƒšã‚¢ã®ä¸¡æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Œäº†ã—ãŸå ´åˆã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’`None`ã«è¨­å®šã—ã¾ã™ã€‚ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã€é–¢æ•°ã¯ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã—ã¦çµ‚äº†ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—ã¨çµ‚äº†æ¡ä»¶ã®å‡¦ç†

```python
    step = state[0].observation.step
    end_early = (active1 and active1.status) in (TIMEOUT, ERROR) or (active2 and active2.status in (TIMEOUT, ERROR))
    either_guessed = False
```

- `step`ã¯ã‚²ãƒ¼ãƒ ã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã™ã€‚
- `end_early`ã¯ã€ã„ãšã‚Œã‹ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ`TIMEOUT`ã¾ãŸã¯`ERROR`ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ—©æœŸçµ‚äº†æ¡ä»¶ã‚’åˆ¤å®šã—ã¾ã™ã€‚
- `either_guessed`ã¯ã€ã„ãšã‚Œã‹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ­£ã—ãæ¨æ¸¬ã—ãŸã‹ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°ã§ã™ã€‚

### Active1ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‡¦ç†

```python
    if active1 is not None:
        guessed = False
        if active1.observation.role == GUESSER:
            guessed = guesser_action(active1, inactive1, step)
            either_guessed = guessed
        else:
            answerer_action(active1, inactive1)
        if active1.status in (TIMEOUT, ERROR):
            end_game(active1, inactive1, 0, active1.status, DONE)
        elif end_early:
            end_game(active1, inactive1, 0, DONE, DONE)
        else:
            increment_turn(active1, inactive1, step, guessed)
```

- `active1`ãŒ`None`ã§ãªã„å ´åˆã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
- `active1`ãŒæ¨æ¸¬è€…ã§ã‚ã‚Œã°ã€`guesser_action`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
- `active1`ãŒå›ç­”è€…ã§ã‚ã‚Œã°ã€`answerer_action`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
- `active1`ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ`TIMEOUT`ã¾ãŸã¯`ERROR`ã®å ´åˆã€`end_game`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
- `end_early`ãŒçœŸã§ã‚ã‚Œã°ã€ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚
- ãã‚Œä»¥å¤–ã®å ´åˆã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«é€²ã‚€ãŸã‚ã«`increment_turn`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

### Active2ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‡¦ç†

```python
    if active2 is not None:
        guessed = False
        if active2.observation.role == GUESSER:
            guessed = guesser_action(active2, inactive2, step)
            either_guessed = either_guessed or guessed
        else:
            answerer_action(active2, inactive2)
        if active2.status in (TIMEOUT, ERROR):
            end_game(active2, inactive2, 0, active2.status, DONE)
        elif end_early:
            end_game(active2, inactive2, 0, DONE, DONE)
        else:
            increment_turn(active2, inactive2, step, guessed)
```

ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€`active1`ã®å‡¦ç†ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€`active2`ãŠã‚ˆã³`inactive2`ã«å¯¾ã—ã¦æ“ä½œã—ã¾ã™ã€‚

### çŠ¶æ…‹ã®è¿”å´

```python
    return state
```

é–¢æ•°ã¯ã€ä¸¡ãƒšã‚¢ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨é·ç§»ã‚’å‡¦ç†ã—ãŸå¾Œã®æ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹ã‚’è¿”ã—ã¾ã™ã€‚

### ã¾ã¨ã‚

`interpreter`é–¢æ•°ã¯ï¼š

1. ã‚²ãƒ¼ãƒ ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯çŠ¶æ…‹ã‚’è¿”ã™ã€‚
2. å„ãƒšã‚¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹ã€‚
3. çµ‚äº†æ¡ä»¶ã‚’å‡¦ç†ã—ã€è³ªå•ã¨æ¨æ¸¬ã®å½¹å‰²ã‚’äº¤æ›¿ã•ã›ã‚‹ã€‚
4. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦é©åˆ‡ãªé–¢æ•°ã‚’å‘¼ã³å‡ºã™ï¼ˆ`guesser_action`ã€`answerer_action`ã€`end_game`ã€`increment_turn`ï¼‰ã€‚
5. ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦è¿”å´ã™ã‚‹ã€‚

ã“ã®é–¢æ•°ã¯ã€ã‚²ãƒ¼ãƒ ã®æµã‚Œã‚’ç®¡ç†ã—ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé©åˆ‡ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã€ã•ã¾ã–ã¾ãªçµ‚äº†æ¡ä»¶ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
def interpreter(state, env):
    if env.done:
        return state
    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŠã‚ˆã³éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆ†é›¢ã—ã¾ã™ã€‚
    active1 = state[0] if state[0].status == ACTIVE else state[1]
    inactive1 = state[0] if state[0].status == INACTIVE else state[1]
    active2 = state[2] if state[2].status == ACTIVE else state[3]
    inactive2 = state[2] if state[2].status == INACTIVE else state[3]
    if active1.status == DONE and inactive1.status == DONE:
        active1 = None
        inactive1 = None
    if active2.status == DONE or inactive2.status == DONE:
        active2 = None
        inactive2 = None
    if active1 is None and inactive1 is None and active2 is None and inactive2 is None:
        return state
    step = state[0].observation.step
    end_early = (active1 and active1.status) in (TIMEOUT, ERROR) or (active2 and active2.status in (TIMEOUT, ERROR))
    either_guessed = False
    if active1 is not None:
        guessed = False
        if active1.observation.role == GUESSER:
            guessed = guesser_action(active1, inactive1, step)
            either_guessed = guessed
        else:
            answerer_action(active1, inactive1)
        if active1.status in (TIMEOUT, ERROR):
            end_game(active1, inactive1, 0, active1.status, DONE)
        elif end_early:
            end_game(active1, inactive1, 0, DONE, DONE)
        else:
            increment_turn(active1, inactive1, step, guessed)
    
    if active2 is not None:
        guessed = False
        if active2.observation.role == GUESSER:
            guessed = guesser_action(active2, inactive2, step)
            either_guessed = either_guessed or guessed
        else:
            answerer_action(active2, inactive2)
        if active2.status in (TIMEOUT, ERROR):
            end_game(active2, inactive2, 0, active2.status, DONE)
        elif end_early:
            end_game(active2, inactive2, 0, DONE, DONE)
        else:
            increment_turn(active2, inactive2, step, guessed)
    
    return state
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
# ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼

- **`renderer`é–¢æ•°**:
  - ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’åå¾©å‡¦ç†ã—ã¾ã™ã€‚
  - å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã€ç›¸äº’ä½œç”¨ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ãŠã‚ˆã³ã‚¹ã‚³ã‚¢ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
  - `GUESSER`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã‚’è¡¨ç¤ºã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã«å¯èª­æ€§ã®ãŸã‚ã«ç©ºè¡Œã‚’å°åˆ·ã—ã¾ã™ã€‚

- **è¿½åŠ ã‚³ãƒ¼ãƒ‰**:
  - JSONãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
  - JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€`specification`ã¨ã„ã†å¤‰æ•°ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

`renderer`é–¢æ•°ã¯ã€ã‚²ãƒ¼ãƒ ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’å¯è¦–åŒ–ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã€ãƒ‡ãƒãƒƒã‚°ã‚„é€²è¡ŒçŠ¶æ³ã®ç†è§£ã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚ã¾ãŸã€è¿½åŠ ã‚³ãƒ¼ãƒ‰ã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚²ãƒ¼ãƒ ä»•æ§˜ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 19)---
```python
def renderer(state, env):
    for s in state:
        print("å½¹å‰²: ", s.observation.role)
        if s.observation.role == GUESSER:
            transcript = ""
            for i in range(0, len(s.observation.guesses)):
                transcript = "{}Q: {} A: {}\nG: {}\n".format(
                    transcript, s.observation.questions[i],
                    s.observation.answers[i],
                    s.observation.guesses[i]
                )
            print(transcript)
        print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ", s.observation.keyword)
        print("ã‚¹ã‚³ã‚¢: ", s.reward)
        print("")
        print("")
        print("")
    return ""
jsonpath = path.abspath(path.join("/kaggle/input/llm-20-questions/llm_20_questions", "llm_20_questions.json"))
with open(jsonpath) as f:
    specification = json.load(f)
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
### `html_renderer`é–¢æ•°

```python
def html_renderer():
    jspath = path.abspath(path.join(path.dirname(__file__), "llm_20_questions.js"))
    with open(jspath) as f:
        return f.read()
```

#### èª¬æ˜

1. **JavaScriptãƒ‘ã‚¹ã®æ§‹ç¯‰**:
    ```python
    jspath = path.abspath(path.join(path.dirname(__file__), "llm_20_questions.js"))
    ```
    - `path.abspath`ã‚’ä½¿ç”¨ã—ã¦`llm_20_questions.js`ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
    - `path.join`ã‚’ä½¿ç”¨ã—ã¦ã€ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`__file__`ï¼‰ã‚’`llm_20_questions.js`ã¨çµåˆã—ã¾ã™ã€‚

2. **JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦èª­ã¿å–ã‚‹**:
    ```python
    with open(jspath) as f:
        return f.read()
    ```
    - `jspath`ã§æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«ã‚ã‚‹JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ã€‚
    - `f.read()`ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨å†…å®¹ã‚’èª­ã¿å–ã‚Šã€æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

ã“ã®é–¢æ•°ã¯ã€`llm_20_questions.js`ã¨ã„ã†åå‰ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãã®å†…å®¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€HTMLãƒšãƒ¼ã‚¸ã«JavaScriptã‚’å‹•çš„ã«åŸ‹ã‚è¾¼ã‚€ã®ã«ä¾¿åˆ©ã§ã™ã€‚

### `keyword_guessed`é–¢æ•°

```python
def keyword_guessed(guess: str) -> bool:
    def normalize(s: str) -> str:
        t = str.maketrans("", "", string.punctuation)
        return s.lower().replace("the", "").replace(" ", "").translate(t)
    if normalize(guess) == normalize(keyword):
        return True
    for s in alts:
        if normalize(s) == normalize(guess):
            return True
    return False
```

#### èª¬æ˜

1. **`normalize`é–¢æ•°ã®å®šç¾©**:
    ```python
    def normalize(s: str) -> str:
        t = str.maketrans("", "", string.punctuation)
        return s.lower().replace("the", "").replace(" ", "").translate(t)
    ```
    - `normalize`ã¯ã€æ¯”è¼ƒç”¨ã«æ–‡å­—åˆ—ã‚’æ¨™æº–åŒ–ã™ã‚‹ãŸã‚ã®è£œåŠ©é–¢æ•°ã§ã™ã€‚
    - æ–‡å­—åˆ—ã‹ã‚‰ã™ã¹ã¦ã®å¥èª­ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆ`str.maketrans`ã‚’ä½¿ç”¨ï¼‰ã€‚
    - æ–‡å­—åˆ—ã‚’å°æ–‡å­—ã«å¤‰æ›ã—ã¾ã™ï¼ˆ`s.lower()`ï¼‰ã€‚
    - ã€Œtheã€ã¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆç©ºæ–‡å­—åˆ—ã«ç½®ãæ›ãˆï¼‰ã€‚
    - `translate(t)`ã‚’ä½¿ç”¨ã—ã¦ã€å¥èª­ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

2. **æ¨æ¸¬ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª**:
    ```python
    if normalize(guess) == normalize(keyword):
        return True
    ```
    - `guess`ã¨`keyword`ã®ä¸¡æ–¹ã‚’æ­£è¦åŒ–ã—ã¾ã™ã€‚
    - æ­£è¦åŒ–ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚
    - ä¸€è‡´ã™ã‚‹å ´åˆã¯ã€`True`ã‚’è¿”ã—ã¾ã™ã€‚

3. **æ¨æ¸¬ãŒä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª**:
    ```python
    for s in alts:
        if normalize(s) == normalize(guess):
            return True
    ```
    - `alts`ã®å„ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åå¾©å‡¦ç†ã—ã¾ã™ã€‚
    - å„ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ­£è¦åŒ–ã—ã€`guess`ã¨æ¯”è¼ƒã—ã¾ã™ã€‚
    - ä¸€è‡´ã™ã‚‹å ´åˆãŒã‚ã‚Œã°ã€`True`ã‚’è¿”ã—ã¾ã™ã€‚

4. **ä¸€è‡´ãŒãªã„å ´åˆã¯`False`ã‚’è¿”ã™**:
    ```python
    return False
    ```
    - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ãã®ä»£æ›¿ãŒæ¨æ¸¬ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ã€`False`ã‚’è¿”ã—ã¾ã™ã€‚

`keyword_guessed`é–¢æ•°ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸæ¨æ¸¬ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¾ãŸã¯ãã®ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚`normalize`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€å¥èª­ç‚¹ã‚’å‰Šé™¤ã—ã€å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ã—ã€ä¸€èˆ¬çš„ãªãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡è¦–ã—ãŸä¸Šã§æ¯”è¼ƒã‚’è¡Œã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 21)---
```python
def html_renderer():
    jspath = path.abspath(path.join("/kaggle/input/llm-20-questions/llm_20_questions", "llm_20_questions.js"))
    with open(jspath) as f:
        return f.read()
def keyword_guessed(guess: str) -> bool:
    def normalize(s: str) -> str:
      t = str.maketrans("", "", string.punctuation)
      return s.lower().replace("the", "").replace(" ", "").translate(t)
    if normalize(guess) == normalize(keyword):
      return True
    for s in alts:
      if normalize(s) == normalize(guess):
        return True
    return False
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
### `call_llm`é–¢æ•°

```python
def call_llm(prompt: str) -> str:
    global model_initialized
    global device
    global model
    global tokenizer
    
    if not model_initialized:
        if os.path.exists(llm_parent_dir) and len(os.listdir(llm_parent_dir)) > 0:
            dirs = os.listdir(llm_parent_dir)
            llm_dir = "{}/{}".format(llm_parent_dir, dirs[0])
            device = "cuda:0" if torch.cuda.is_available() else "cpu"
            model = T5ForConditionalGeneration.from_pretrained(llm_dir).to(device)
            tokenizer = T5Tokenizer.from_pretrained(llm_dir)
            model_initialized = True
        else:
            print("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚å¤§ããªãƒ¢ãƒ‡ãƒ«ã®ã„ãšã‚Œã‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
            print("https://www.kaggle.com/models/google/flan-t5/frameworks/pyTorch/variations/large.")
            raise Exception("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚")
    
    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    outputs = model.generate(**inputs)
    answer = tokenizer.batch_decode(outputs, skip_special_tokens=True)
    return answer[0]
```

#### èª¬æ˜

1. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°**:
    ```python
    global model_initialized
    global device
    global model
    global tokenizer
    ```
    - `model_initialized`ã€`device`ã€`model`ã€`tokenizer`ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å®£è¨€ã—ã¾ã™ã€‚

2. **ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯**:
    ```python
    if not model_initialized:
        if os.path.exists(llm_parent_dir) and len(os.listdir(llm_parent_dir)) > 0:
    ```
    - ãƒ¢ãƒ‡ãƒ«ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
    - åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€`llm_parent_dir`ãŒå­˜åœ¨ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

3. **ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿**:
    ```python
    dirs = os.listdir(llm_parent_dir)
    llm_dir = "{}/{}".format(llm_parent_dir, dirs[0])
    device = "cuda:0" if torch.cuda.is_available() else "cpu"
    model = T5ForConditionalGeneration.from_pretrained(llm_dir).to(device)
    tokenizer = T5Tokenizer.from_pretrained(llm_dir)
    model_initialized = True
    ```
    - `llm_parent_dir`å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚
    - ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ‘ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
    - GPUãŒä½¿ç”¨å¯èƒ½ã§ã‚ã‚Œã°`cuda:0`ã‚’è¨­å®šã—ã€ç„¡ã‘ã‚Œã°CPUã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    - æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰T5ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã€ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ãŸãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—ã¾ã™ã€‚
    - `model_initialized`ã‚’`True`ã«è¨­å®šã—ã¦ã€ä»¥é™ã®åˆæœŸåŒ–ã‚’é¿ã‘ã¾ã™ã€‚

4. **ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¬ å¦‚å‡¦ç†**:
    ```python
    else:
        print("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚å¤§ããªãƒ¢ãƒ‡ãƒ«ã®ã„ãšã‚Œã‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
        print("https://www.kaggle.com/models/google/flan-t5/frameworks/pyTorch/variations/large.")
        raise Exception("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚")
    ```
    - ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã¾ã™ã€‚

5. **ãƒ¢ãƒ‡ãƒ«ã¸ã®å…¥åŠ›æº–å‚™**:
    ```python
    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    ```
    - å…¥åŠ›`prompt`ã‚’ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ã—ã¦PyTorchãƒ†ãƒ³ã‚½ãƒ«ã«å¤‰æ›ã—ã¾ã™ã€‚
    - ãƒ†ãƒ³ã‚½ãƒ«ã‚’é¸æŠã—ãŸãƒ‡ãƒã‚¤ã‚¹ï¼ˆCPUã¾ãŸã¯GPUï¼‰ã«ç§»å‹•ã—ã¾ã™ã€‚

6. **å‡ºåŠ›ã®ç”Ÿæˆ**:
    ```python
    outputs = model.generate(**inputs)
    ```
    - ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã•ã‚ŒãŸå…¥åŠ›ã‹ã‚‰å‡ºåŠ›ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

7. **å‡ºåŠ›ã®ãƒ‡ã‚³ãƒ¼ãƒ‰**:
    ```python
    answer = tokenizer.batch_decode(outputs, skip_special_tokens=True)
    return answer[0]
    ```
    - ç”Ÿæˆã•ã‚ŒãŸå‡ºåŠ›ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€ç‰¹åˆ¥ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
    - ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå‡ºåŠ›ã®æœ€åˆã®è¦ç´ ã‚’æœ€çµ‚çš„ãªå›ç­”ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

### ã¾ã¨ã‚

`call_llm`é–¢æ•°ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ã„ã¦åå¿œã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«äº‹å‰å­¦ç¿’æ¸ˆã¿ã®T5ãƒ¢ãƒ‡ãƒ«ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‹…å½“ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ãŒä¸€åº¦ã ã‘èª­ã¿è¾¼ã¾ã‚Œã¦åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€æœ‰åŠ¹ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒã‚¤ã‚¹ï¼ˆCPU/GPUï¼‰ã‚’è¨­å®šã—ã€ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚ãã®å¾Œã€å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºã—ã€ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã€å‡ºåŠ›ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã€å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹æ‰‹é †ã‚’æä¾›ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 23)---
```python
def call_llm(prompt: str) -> str:
    global model_initialized
    global device
    global model
    global tokenizer
    if not model_initialized:
        if os.path.exists(llm_parent_dir) and len(os.listdir(llm_parent_dir)) > 0:
            dirs = os.listdir(llm_parent_dir)
            llm_dir = "{}/{}".format(llm_parent_dir, dirs[0])
            device = "cuda:0" if torch.cuda.is_available() else "cpu"
            model = T5ForConditionalGeneration.from_pretrained(llm_dir).to(device)
            tokenizer = T5Tokenizer.from_pretrained(llm_dir)
            model_initialized = True
        else:
            print("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚å¤§ããªãƒ¢ãƒ‡ãƒ«ã®ã„ãšã‚Œã‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
            print("https://www.kaggle.com/models/google/flan-t5/frameworks/pyTorch/variations/large.")
            raise Exception("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯t5-flanãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ã§ã™ã€‚")
    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    outputs = model.generate(**inputs)
    answer = tokenizer.batch_decode(outputs, skip_special_tokens=True)
    print(prompt)
    return answer[0]
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
# å®Ÿè¡Œ/ãƒ‡ãƒãƒƒã‚°

*å‚è€ƒæ–‡çŒ®:* 
1. [test_llm_20_questions.py](https://github.com/Kaggle/kaggle-environments/blob/master/kaggle_environments/envs/llm_20_questions/test_llm_20_questions.py)
2. [ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã®LLM 20ã®è³ªå•ã®å®Ÿè¡Œ/ãƒ‡ãƒãƒƒã‚°](https://www.kaggle.com/code/rturley/run-debug-llm-20-questions-in-a-notebook)
```

---The following area is a Code cell (cell numver is 25)---
```python
from kaggle_environments import make
def custom_questioner(obs):
    if obs.turnType == "guess":
        return "ãƒãƒŠãƒŠ"
    return "ãã‚Œã¯ãƒãƒŠãƒŠã§ã™ã‹ï¼Ÿ"
def custom_answerer():
    return "ã„ã„ãˆ"
def bad_answerer():
    return "ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿ"
def error_agent():
    raise ValueError
def test_llm_20_q_completes():
    env = make("llm_20_questions", debug=True)
    game_output = env.run([guesser_agent, answerer_agent, guesser_agent, answerer_agent])
    json = env.toJSON()
    env.render(mode="ipython", width=400, height=400)
    assert json["name"] == "llm_20_questions"
    assert json["statuses"] == ["DONE", "DONE", "DONE", "DONE"]
def test_llm_20_q_errors_on_bad_answer():
    env = make("llm_20_questions", debug=True)
    env.run([custom_questioner, custom_answerer, custom_questioner, bad_answerer])
    json = env.toJSON()
    assert json["name"] == "llm_20_questions"
    assert json["rewards"] == [1, 1, 1, None]
    assert json["statuses"] == ["DONE", "DONE", "DONE", "ERROR"]
    print(len(json["steps"]))
    assert len(json["steps"]) == 3
def test_llm_20_q_errors_on_error_answer():
    env = make("llm_20_questions", debug=True)
    env.run([custom_questioner, custom_answerer, custom_questioner, error_agent])
    json = env.toJSON()
    assert json["name"] == "llm_20_questions"
    assert json["rewards"] == [1, 1, 1, None]
    assert json["statuses"] == ["DONE", "DONE", "DONE", "ERROR"]
    print(len(json["steps"]))
    assert len(json["steps"]) == 3
def test_llm_20_q_errors_on_error_question():
    env = make("llm_20_questions", debug=True)
    env.run([custom_questioner, custom_answerer, error_agent, custom_answerer])
    json = env.toJSON()
    assert json["name"] == "llm_20_questions"
    assert json["rewards"] == [1, 1, None, 1]
    assert json["statuses"] == ["DONE", "DONE", "ERROR", "DONE"]
    print(len(json["steps"]))
    assert len(json["steps"]) == 2
```

---The following area is a Code cell (cell numver is 26)---
```python
test_llm_20_q_completes()
```

** @@@ Jupyter Notebook numver 25, the number of votes :10 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«é–¢é€£ã™ã‚‹JSONãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã€ç‰¹å®šã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦CSVå½¢å¼ã§ä¿å­˜ã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ç‰¹ã«ã€ã€Œå›½ã€ã€ã€Œéƒ½å¸‚ã€ã€ãŠã‚ˆã³ã€Œåæ‰€ã€ã¨ã„ã£ãŸã‚«ãƒ†ã‚´ãƒªã®å˜èªã‚’æ‰±ã£ã¦ã„ã¾ã™ã€‚

### ä¸»ãªå†…å®¹ã¨æ‰‹æ³•:

1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**:
    - `pandas` ã¨ `json` ã®ä»–ã€ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†ã®ãŸã‚ã« `TextBlob` ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€å®Ÿéš›ã®å‡¦ç†ã«ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

2. **JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿**:
    - JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãã®å†…å®¹ã‚’æ¤œæŸ»ã—ã¾ã™ã€‚ä¸»ã«ã€Œagentsã€ã¨ã„ã†ã‚­ãƒ¼ã®ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚

3. **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆ**:
    - JSONãƒ‡ãƒ¼ã‚¿ã‚’`pandas`ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã€å†…å®¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

4. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡º**:
    - `keywords.py` ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€éš ã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆå›½ã€éƒ½å¸‚ã€åæ‰€ï¼‰ã‚’JSONã‹ã‚‰æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚

5. **ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã¨å‡ºåŠ›**:
    - å„ã‚«ãƒ†ã‚´ãƒªï¼ˆå›½ã€éƒ½å¸‚ã€åæ‰€ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã€å€‹åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ãã®å¾Œã€ã“ã‚Œã‚‰ã‚’CSVå½¢å¼ã§ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚

6. **é–¢æ•°ã®å®šç¾©**:
    - åŒã˜å‡¦ç†ãŒç¹°ã‚Šè¿”ã•ã‚Œã‚‹ãŸã‚ã€æ©Ÿèƒ½ã‚’`main`é–¢æ•°ã«ã¾ã¨ã‚ã€ã‚ˆã‚Šæ˜ç¢ºã§å†åˆ©ç”¨å¯èƒ½ãªå½¢å¼ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã®Notebookã®ç›®çš„ã¯ã€JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®æƒ…å ±ã‚’åŠ¹æœçš„ã«æŠœãå‡ºã—ã€åˆ†æã‚„ã•ã‚‰ãªã‚‹å‡¦ç†ãŒã§ãã‚‹ã‚ˆã†ã«æ•´å½¢ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã™ã€‚ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯`pandas`ã€`json`ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã«ãŠã‘ã‚‹æ¨™æº–çš„ãªæ‰‹æ³•ã‚’ç”¨ã„ã¦å®Ÿæ–½ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import pandas as pd
import json
from textblob import TextBlob
```

---The following area is a Code cell (cell numver is 2)---
```python
# JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€æ¤œæŸ»ã™ã‚‹
with open('/kaggle/input/llm-20-questions/llm_20_questions/llm_20_questions.json') as file:
    raw_data = json.load(file)
```

---The following area is a Code cell (cell numver is 3)---
```python
# JSONãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ã‚’æ¤œæŸ»ã™ã‚‹
print(raw_data.keys())
```

---The following area is a Code cell (cell numver is 4)---
```python
# 'agents'ã‚­ãƒ¼ã®ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹
data = raw_data['agents']
```

---The following area is a Code cell (cell numver is 5)---
```python
# ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹ï¼ˆè¾æ›¸ã®ãƒªã‚¹ãƒˆã§ã‚ã‚‹ã¨ä»®å®šï¼‰
data = pd.DataFrame(data)
```

---The following area is a Code cell (cell numver is 6)---
```python
# æ­£ã—ãèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«æœ€åˆã®æ•°è¡Œã‚’è¡¨ç¤ºã™ã‚‹
print(data.head())
```

---The following area is a Code cell (cell numver is 7)---
```python
import numpy as np
import pandas as pd
import json
import os
import sys

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# keywords.pyã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
sys.path.append('../input/llm-20-questions/llm_20_questions/')
import keywords

# è¨­å®š
pd.set_option('display.max_rows', None)  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®å…¨è¡Œã‚’è¡¨ç¤º
pd.set_option('display.max_colwidth', None)  # é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚‚å®Œå…¨ã«è¡¨ç¤º

# JSONã«å¤‰æ›ã™ã‚‹
my_json = json.loads(keywords.KEYWORDS_JSON)

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡ºã™ã‚‹
json_country = my_json[0]  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
json_city = my_json[1]     # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
json_landmark = my_json[2] # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

# å›½
df_country = pd.json_normalize(json_country['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("å›½ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_country)  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

# éƒ½å¸‚
df_city = pd.json_normalize(json_city['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("\néƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_city)  # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

# åæ‰€
df_landmark = pd.json_normalize(json_landmark['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("\nåæ‰€ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_landmark)  # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

print("\nmy_jsonã®é•·ã•:", len(my_json))  # my_jsonã®é•·ã•ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 8)---
```python
import numpy as np
import pandas as pd
import json
import os
import sys

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# keywords.pyã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
sys.path.append('../input/llm-20-questions/llm_20_questions/')
import keywords

# è¨­å®š
pd.set_option('display.max_rows', None)  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®å…¨è¡Œã‚’è¡¨ç¤º
pd.set_option('display.max_colwidth', None)  # é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚‚å®Œå…¨ã«è¡¨ç¤º

# JSONã«å¤‰æ›ã™ã‚‹
my_json = json.loads(keywords.KEYWORDS_JSON)

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡ºã™ã‚‹
json_country = my_json[0]  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
json_city = my_json[1]     # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
json_landmark = my_json[2] # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

# å›½
df_country = pd.json_normalize(json_country['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("å›½ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_country)  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
df_country.to_csv('/kaggle/working/country.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

# éƒ½å¸‚
df_city = pd.json_normalize(json_city['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("\néƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_city)  # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
df_city.to_csv('/kaggle/working/city.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

# åæ‰€
df_landmark = pd.json_normalize(json_landmark['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
print("\nåæ‰€ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
print(df_landmark)  # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
df_landmark.to_csv('/kaggle/working/landmark.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

print("\nmy_jsonã®é•·ã•:", len(my_json))  # my_jsonã®é•·ã•ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 9)---
```python
import numpy as np
import pandas as pd
import json
import os
import sys

def main():
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
    for dirname, _, filenames in os.walk('/kaggle/input'):
        for filename in filenames:
            print(os.path.join(dirname, filename))

    # keywords.pyã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
    sys.path.append('../input/llm-20-questions/llm_20_questions/')
    import keywords

    # è¨­å®š
    pd.set_option('display.max_rows', None)  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®å…¨è¡Œã‚’è¡¨ç¤º
    pd.set_option('display.max_colwidth', None)  # é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚‚å®Œå…¨ã«è¡¨ç¤º

    # JSONã«å¤‰æ›ã™ã‚‹
    my_json = json.loads(keywords.KEYWORDS_JSON)

    # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡ºã™ã‚‹
    json_country = my_json[0]  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    json_city = my_json[1]     # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    json_landmark = my_json[2] # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

    # å›½
    df_country = pd.json_normalize(json_country['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
    print("å›½ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
    print(df_country)  # å›½ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    df_country.to_csv('/kaggle/working/country.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

    # éƒ½å¸‚
    df_city = pd.json_normalize(json_city['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
    print("\néƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
    print(df_city)  # éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    df_city.to_csv('/kaggle/working/city.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

    # åæ‰€
    df_landmark = pd.json_normalize(json_landmark['words'])  # JSONã®å˜èªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
    print("\nåæ‰€ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
    print(df_landmark)  # åæ‰€ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    df_landmark.to_csv('/kaggle/working/landmark.csv', index=False)  # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜

    print("\nmy_jsonã®é•·ã•:", len(my_json))  # my_jsonã®é•·ã•ã‚’è¡¨ç¤º

if __name__ == "__main__":
    main()  # mainé–¢æ•°ã‚’å‘¼ã³å‡ºã™
```

** @@@ Jupyter Notebook numver 26, the number of votes :9 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ç‰¹ã«è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œè¨­å®š
Notebookã¯ã€ã•ã¾ã–ã¾ãªLLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’åˆ©ç”¨ã—ã€é™ã‚‰ã‚ŒãŸè³ªå•ã®ä¸­ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã‚’è¡Œã„ã€å›ç­”ã‚’å—ã‘å–ã‚Šã€æ¨æ¸¬ã‚’è¡Œã†ã¨ã„ã†ä¸€é€£ã®æ“ä½œã‚’é€šã˜ã¦ã€åŠ¹ç‡çš„ã«æƒ…å ±ã‚’åé›†ã—ã¦æ­£ã—ã„å˜èªã‚’å°ãå‡ºã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã¨ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š**:
   - `tokenizer.apply_chat_template`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç‰¹åˆ¥ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•çš„ã«é©ç”¨ã—ã€è³ªå•ã®ç”Ÿæˆã‚’ã‚ˆã‚ŠåŠ¹æœçš„ã«è¡Œã„ã¾ã™ã€‚
   - ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã¯ã€`LLAMA3`, `Phi-3`, `Qwen-2`ã®å„ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

2. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨**:
   - `transformers`: Hugging Faceã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
   - `bitsandbytes`: ãƒ¡ãƒ¢ãƒªä½¿ç”¨ã®æœ€é©åŒ–ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ãƒ¢ãƒ‡ãƒ«ã‚’é‡å­åŒ–ã™ã‚‹éš›ã«å½¹ç«‹ã¡ã¾ã™ã€‚
   - `pygame`: ã‚²ãƒ¼ãƒ ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ã•ã‚Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
   - `kaggle_environments`: Kaggleã®ç’°å¢ƒã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¯¾æˆ¦ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ç”¨ã„ã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ **:
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã‚’è¡Œã†ã€Œè³ªå•è€…ã€ã€å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã€Œæ¨æ¸¬è€…ã€ã€è³ªå•ã«ã€Œã¯ã„/ã„ã„ãˆã€ã§å¿œãˆã‚‹ã€Œå›ç­”è€…ã€ã®3ã¤ã®å½¹å‰²ã‚’æŒã¡ã€å„å½¹å‰²ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€æœ€é©ãªå¿œç­”ã‚’å°ãã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

4. **ãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–**:
   - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿ã€4ãƒ“ãƒƒãƒˆã®é‡å­åŒ–ã‚’è¡Œã†ã“ã¨ã§ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¦ã„ã¾ã™ã€‚

### æ§‹æˆã®æ¦‚è¦
Notebookã®ä¸­ã§ã¯ã€ã¾ãšå¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Hugging Faceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è¨­å®šã—ã¾ã™ã€‚ãã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã€ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚²ãƒ¼ãƒ å†…ã§é©åˆ‡ã«å‹•ä½œã™ã‚‹ã‚ˆã†ãªæ§‹é€ ã‚’æŒãŸã›ã¦ã„ã¾ã™ã€‚æœ€å¾Œã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æå‡ºç”¨ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã€æå‡ºæº–å‚™ã‚’æ•´ãˆã¾ã™ã€‚

ã“ã®Notebookã¯ã€åŠ¹ç‡çš„ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã«ãŠã‘ã‚‹é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# LLM 20 Questions ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³

`tokenizer.apply_chat_template`ã‚’ä½¿ç”¨ã—ã¦ç‰¹åˆ¥ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•çš„ã«é©ç”¨ã—ãŸã®ã§ã€ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¾¿åˆ©ã«å¤‰æ›´ã§ãã¾ã™ã€‚ 


ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«:
- `LLAMA3 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
- `Phi-3 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
- `Qwen-2 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`

## å‰ææ¡ä»¶
GPU T4ã‚’ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
mkdir -p /tmp/model
pip install -q bitsandbytes accelerate
pip install -qU transformers
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
## ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

### HuggingFace ãƒ­ã‚°ã‚¤ãƒ³


1. HuggingFace ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ (https://huggingface.co/settings/tokens)


2. HuggingFace ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã¯ `Add-ons -> secrets` ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚




![Screenshot 2024-08-01 at 11.40.17â€¯AM.png](attachment:fb5805e5-566e-41f1-ba50-0d9f9fade571.png)
```

---The following area is a Code cell (cell numver is 4)---
```python
from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN: str | None  = None

try:
    HF_TOKEN = secrets.get_secret("HF_TOKEN")
except:
    pass
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
### ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ

[HuggingFace Model Hub](https://huggingface.co/models)ã‹ã‚‰å¸Œæœ›ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¤ã‘ã¦ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«:
- `LLAMA3 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
- `Phi-3 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
- `Qwen-2 ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
```

---The following area is a Code cell (cell numver is 6)---
```python
repo_id = "meta-llama/Meta-Llama-3-8B-Instruct"
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
### HuggingFaceçµŒç”±ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã‚’å‰Šæ¸›ã™ã‚‹ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã‚’ `/tmp/model` ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/tmp/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)  # æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
g_model_path.mkdir(parents=True)  # æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ã‚’ä½œæˆ

snapshot_download(
    repo_id=repo_id,  # ãƒ¢ãƒ‡ãƒ«è­˜åˆ¥å­
    ignore_patterns="original*",  # æŒ‡å®šã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç„¡è¦–
    local_dir=g_model_path,  # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    token=globals().get("HF_TOKEN", None)  # HF_TOKENã‚’å–å¾—
)
```

---The following area is a Code cell (cell numver is 9)---
```python
!ls -l /tmp/model
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
### é‡å­åŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®ä¿å­˜
ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿ã€é‡å­åŒ–ã‚’è¡Œã„ã¾ã™ã€‚  
ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒç¯€ç´„ã•ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€ä¿å­˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã™ã§ã«é‡å­åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`main.py`ã§ã¯ `bitsandbytes` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 11)---
```python
# ãƒ¡ãƒ¢ãƒªã«ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig
import torch

torch.backends.cuda.enable_mem_efficient_sdp(False)  # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„SDPã‚’ç„¡åŠ¹åŒ–
torch.backends.cuda.enable_flash_sdp(False)  # ãƒ•ãƒ©ãƒƒã‚·ãƒ¥SDPã‚’ç„¡åŠ¹åŒ–

downloaded_model = "/tmp/model"  # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹

# é‡å­åŒ–ã®è¨­å®š
bnb_config = BitsAndBytesConfig(
    load_in_4bit = True,  # 4ãƒ“ãƒƒãƒˆã§èª­ã¿è¾¼ã‚€
    bnb_4bit_compute_dtype=torch.float16,  # è¨ˆç®—ãƒ‡ãƒ¼ã‚¿å‹ã‚’float16ã«æŒ‡å®š
)

# äº‹å‰å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿
model = AutoModelForCausalLM.from_pretrained(
    downloaded_model,  # èª­ã¿è¾¼ã‚€ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹
    quantization_config = bnb_config,  # é‡å­åŒ–ã®è¨­å®š
    torch_dtype = torch.float16,  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’float16ã«è¨­å®š
    device_map = "auto",  # ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•è¨­å®š
    trust_remote_code = True,  # ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä¿¡é ¼ã™ã‚‹
)

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿
tokenizer = AutoTokenizer.from_pretrained(downloaded_model)
```

---The following area is a Code cell (cell numver is 12)---
```python
# ãƒ¢ãƒ‡ãƒ«ã‚’æå‡ºç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
model.save_pretrained("/kaggle/working/submission/model")  # ãƒ¢ãƒ‡ãƒ«ä¿å­˜
tokenizer.save_pretrained("/kaggle/working/submission/model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ä¿å­˜
```

---The following area is a Code cell (cell numver is 13)---
```python
# ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰
import gc, torch
del model, tokenizer  # ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’å‰Šé™¤
gc.collect()  # ã‚¬ãƒ¼ãƒ™ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
torch.cuda.empty_cache()  # CUDAãƒ¡ãƒ¢ãƒªã‚’ç©ºã«ã™ã‚‹
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯[Anthropic Prompt Library](https://docs.anthropic.com/en/prompt-library/library)ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯2ã¤ã®éƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™:
- `system_prompt`: ã“ã‚Œã¯ã‚«ãƒ†ã‚´ãƒªã‚’ç‰¹å®šã™ã‚‹æœ€åˆã®è³ªå•ã§ã™ã€‚
- `chat_history`: ã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›ã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
%%writefile submission/prompts.py

def asker_prompt(obs):
    message = []
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    ask_prompt = f"""ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹å°‚é–€çŸ¥è­˜ã‚’æŒã£ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è³ªå•ã‚’ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè€ƒãˆã¦ã„ã‚‹å˜èªã‚’å½“ã¦ã‚‹ã“ã¨ã§ã™ã€‚
ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦å¯èƒ½æ€§ã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚
æ®µéšçš„ã«è€ƒãˆã€æœ€ã‚‚æƒ…å ±é‡ã®å¤šã„è³ªå•ã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
\n"""

    message.append({"role": "system", "content": ask_prompt})

    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´
    for q, a in zip(obs.questions, obs.answers):
        message.append({"role": "assistant", "content": q})
        message.append({"role": "user", "content": a})

    return message


def guesser_prompt(obs):
    message = []
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    guess_prompt = f"""ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹å°‚é–€çŸ¥è­˜ã‚’æŒã£ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè€ƒãˆã¦ã„ã‚‹å˜èªã‚’å½“ã¦ã‚‹ã“ã¨ã§ã™ã€‚
æ®µéšçš„ã«è€ƒãˆã¦ãã ã•ã„ã€‚
\n"""

    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´
    chat_history = ""
    for q, a in zip(obs.questions, obs.answers):
        chat_history += f"""è³ªå•: {q}\nå›ç­”: {a}\n"""
    prompt = (
            guess_prompt + f"""ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:\n{chat_history}
        ä¼šè©±ã«åŸºã¥ã„ã¦ã€ã“ã®å˜èªã‚’æ¨æ¸¬ã§ãã¾ã™ã‹ï¼Ÿç­”ãˆã¯å˜èªã®ã¿ã§ã€è©³ç´°ã¯ä¸è¦ã§ã™"""
    )
    
    
    message.append({"role": "system", "content": prompt})
    
    return message


def answerer_prompt(obs):
    message = []
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    prompt = f"""ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹å°‚é–€çŸ¥è­˜ã‚’æŒã£ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã—ã¦ã„ã‚‹å˜èªã‚’å½“ã¦ã‚‹ã®ã‚’æ‰‹åŠ©ã‘ã™ã‚‹ãŸã‚ã«è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã™ã€‚
ã‚ãªãŸã®å›ç­”ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯: "{obs.keyword}"ã€ã‚«ãƒ†ã‚´ãƒªã¯: "{obs.category}"ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã§ãã‚‹ã‚ˆã†ã«æ­£ç¢ºãªå›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
"""

    message.append({"role": "system", "content": prompt})
    
    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´
    message.append({"role": "user", "content": obs.questions[0]})
    
    if len(obs.answers)>=1:
        for q, a in zip(obs.questions[1:], obs.answers):
            message.append({"role": "assistant", "content": a})
            message.append({"role": "user", "content": q})
    
    return message
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

è¤‡æ•°ã®LLMãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
%%writefile submission/main.py

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
import os

from prompts import *

torch.backends.cuda.enable_mem_efficient_sdp(False)  # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„SDPã‚’ç„¡åŠ¹åŒ–
torch.backends.cuda.enable_flash_sdp(False)  # ãƒ•ãƒ©ãƒƒã‚·ãƒ¥SDPã‚’ç„¡åŠ¹åŒ–


KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    MODEL_PATH = os.path.join(KAGGLE_AGENT_PATH, "model")  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
else:
    MODEL_PATH = "/kaggle/working/submission/model"  # ãƒ¢ãƒ‡ãƒ«ä¿å­˜ãƒ‘ã‚¹ã‚’æŒ‡å®š


# ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿
model = AutoModelForCausalLM.from_pretrained(
    MODEL_PATH,  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
    device_map="auto",  # ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•è¨­å®š
    trust_remote_code=True,  # ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä¿¡é ¼ã™ã‚‹
)
tokenizer = AutoTokenizer.from_pretrained(MODEL_PATH)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿

# ãŠæœ›ã¿ã®ãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ãŸã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®š
terminators = [tokenizer.eos_token_id]  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

# è¿½åŠ ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ã®å€™è£œ
# llama3, phi3, gwen2é †
potential_terminators = ["<|eot_id|>", "<|end|>", "<end_of_turn>"]

# å€™è£œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ã«è¿½åŠ 
for token in potential_terminators:
    token_id = tokenizer.convert_tokens_to_ids(token)
    if token_id is not None:
        terminators.append(token_id)

def generate_response(chat):
    # ãƒãƒ£ãƒƒãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã€å‡¦ç†ã™ã‚‹
    inputs = tokenizer.apply_chat_template(chat, add_generation_prompt=True, return_tensors="pt").to(model.device)
    # ãƒ¢ãƒ‡ãƒ«ã‚’ä»‹ã—ã¦æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    outputs = model.generate(inputs, max_new_tokens=32, pad_token_id=tokenizer.eos_token_id, eos_token_id=terminators)
    response = outputs[0][inputs.shape[-1]:]  # ç”Ÿæˆã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
    out = tokenizer.decode(response, skip_special_tokens=True)  # ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—

    return out  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™


class Robot:
    def __init__(self):
        pass

    def on(self, mode, obs):
        assert mode in [
            "asking", "guessing", "answering",
        ], "modeã¯ã“ã‚Œã‚‰ã®å€¤ã®ã„ãšã‚Œã‹ã®ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™: asking, answering, guessing"
        if mode == "asking":
            # è³ªå•ã™ã‚‹å½¹å‰²ã‚’èµ·å‹•ã™ã‚‹
            output = self.asker(obs)
        if mode == "answering":
            # ç­”ãˆã‚‹å½¹å‰²ã‚’èµ·å‹•ã™ã‚‹
            output = self.answerer(obs)
            if "yes" in output.lower():  # ç­”ãˆãŒã€Œã¯ã„ã€ã®å ´åˆ
                output = "yes"  # ã€Œã¯ã„ã€ã¨è¨­å®š
            elif "no" in output.lower():  # ç­”ãˆãŒã€Œã„ã„ãˆã€ã®å ´åˆ
                output = "no"  # ã€Œã„ã„ãˆã€ã¨è¨­å®š
            if "yes" not in output.lower() and "no" not in output.lower():  # ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆ
                output = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œã¯ã„ã€ã«è¨­å®š
        if mode == "guessing":
            # æ¨æ¸¬ã™ã‚‹å½¹å‰²ã‚’èµ·å‹•ã™ã‚‹
            output = self.guesser(obs)
        return output

    def asker(self, obs):
        
        input = asker_prompt(obs)  # è³ªå•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
        output = generate_response(input)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
        
        return output

    def guesser(self, obs):
        input = guesser_prompt(obs)  # æ¨æ¸¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
        output = generate_response(input)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
        
        return output

    def answerer(self, obs):
        input = answerer_prompt(obs)  # ç­”ãˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
        output = generate_response(input)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ

        return output


robot = Robot()  # Robotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆ


def agent(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
    if obs.turnType == "ask":
        response = robot.on(mode="asking", obs=obs)  # è³ªå•ã™ã‚‹å ´åˆ

    elif obs.turnType == "guess":
        response = robot.on(mode="guessing", obs=obs)  # æ¨æ¸¬ã™ã‚‹å ´åˆ

    elif obs.turnType == "answer":
        response = robot.on(mode="answering", obs=obs)  # ç­”ãˆã‚‹å ´åˆ

    if response == None or len(response) <= 1:  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãªã„å ´åˆ
        response = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œã¯ã„ã€ã‚’è¿”ã™

    return response  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
## ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### pygameã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 19)---
```python
!pip install pygame
```

---The following area is a Code cell (cell numver is 20)---
```python
%%writefile dumb.py

def dumb_agent(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ãŒã€Œaskã€ã®å ´åˆ
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"  # æ¨æ¸¬ã‚’å°‹ã­ã‚‹è³ªå•
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ãŒã€Œguessã€ã®å ´åˆ
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"  # ã‚¢ãƒ’ãƒ«ã¨æ¨æ¸¬
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"  # ç–‘å•ã«å¯¾ã—ã¦ã€Œã„ã„ãˆã€ã¨è¿”ç­”
    
    return response
```

---The following area is a Code cell (cell numver is 21)---
```python
%%time

from kaggle_environments import make
env = make("llm_20_questions", debug=True)  # ç’°å¢ƒã‚’ä½œæˆ
game_output = env.run(agents=["submission/main.py", "submission/main.py", "dumb.py", "dumb.py"])  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
```

---The following area is a Code cell (cell numver is 22)---
```python
env.render(mode="ipython", width=600, height=700)  # ã‚²ãƒ¼ãƒ ã®å‡ºåŠ›ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
```

---The following area is a Markdown cell (cell numver is 23)---
```markdown
## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æå‡º
```

---The following area is a Code cell (cell numver is 24)---
```python
!apt install pigz pv > /dev/null  # é–‹ã„ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç„¡è¦–ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 25)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .  # æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¦tarã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
```

** @@@ Jupyter Notebook numver 27, the number of votes :9 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã€ŒQwen2-7b-itã€ã§ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å–ã‚Šçµ„ã‚€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®2ã¤ã®å½¹å‰²ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã—ã€ä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ¨æ¸¬ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
- **ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ **: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸€ã¤ã®ç‰¹å®šã®å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ã€ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’é€šã˜ã¦æƒ…å ±ã‚’åé›†ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã®ç›®æ¨™ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒéå¸¸ã«åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã§ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Transformers**: ã€ŒHugging Faceã€ã‹ã‚‰æä¾›ã•ã‚Œã‚‹Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰å­¦ç¿’ã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã€ŒQwen2-7b-instructã€ã‚’é©ç”¨ã—ã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ãŠã‚ˆã³å› æœè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
2. **é‡å­åŒ–æŠ€è¡“**: `BitsAndBytesConfig`ã‚’ç”¨ã„ã¦4ãƒ“ãƒƒãƒˆã§ã®ãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã‚’è¡Œã„ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã®ä½¿ç”¨ãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
3. **ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã®ãŸã‚ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¨­å®šã—ã€ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«è³ªå•ã‚„æ¨æ¸¬ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
4. **ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…**: `Robot`ã‚¯ãƒ©ã‚¹ã‚’è¨­è¨ˆã—ã€è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®3ã¤ã®ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã«å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«å¿œã˜ãŸè³ªå•ã‚„å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
5. **ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½**: æå‡ºã™ã‚‹å‰ã«ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã‚²ãƒ¼ãƒ ãŒå®Ÿéš›ã«ãƒ—ãƒ¬ã‚¤ã•ã‚Œã‚‹éç¨‹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è‡ªç„¶è¨€èªå‡¦ç†ã‚’åˆ©ç”¨ã—ãŸåŒæ–¹å‘ã®å¯¾è©±å‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®å®Ÿç”¨çš„ãªä¾‹ã‚’ç¤ºã—ã¦ãŠã‚Šã€ç‰¹ã«ã‚²ãƒ¼ãƒ ç†è«–ã«åŸºã¥ãæˆ¦ç•¥çš„ãªè³ªå•ã¨æ¨æ¸¬ã®èƒ½åŠ›ã‚’å¼·èª¿ã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# Qwen2-7b-it
å‚è€ƒã®ãŸã‚ã«ã€Qwen2-7b-itã§ä½œæˆã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å…±æœ‰ã—ã¾ã™ã€‚ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯[LLM Leaderboard](https://huggingface.co/spaces/open-llm-leaderboard/open_llm_leaderboard)ã§è‰¯å¥½ãªæˆæœã‚’ä¸Šã’ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
pip install bitsandbytes accelerate
pip install -U transformers
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile -a submission/main.py

import os
import torch
import random
import re
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig, AutoConfig, pipeline

torch.backends.cuda.enable_mem_efficient_sdp(False)  # CUDAã®ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„SDPã‚’ç„¡åŠ¹åŒ–

KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"  # Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
if os.path.exists(KAGGLE_AGENT_PATH):  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    model_id = os.path.join(KAGGLE_AGENT_PATH, "1")  # ãƒ‘ã‚¹ã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«IDã‚’è¨­å®š
else:
    model_id = "/kaggle/input/qwen2/transformers/qwen2-7b-instruct/1"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¢ãƒ‡ãƒ«IDã‚’è¨­å®š


tokenizer = AutoTokenizer.from_pretrained(model_id, trust_remote_code=True)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ¢ãƒ‡ãƒ«IDã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ‰

quantization_config = BitsAndBytesConfig(  # é‡å­åŒ–ã®è¨­å®šã‚’è¡Œã†
    load_in_4bit=True,  # 4ãƒ“ãƒƒãƒˆã§ã®èª­ã¿è¾¼ã¿ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    bnb_4bit_quant_type="nf4",  # 4ãƒ“ãƒƒãƒˆé‡å­åŒ–ã®ã‚¿ã‚¤ãƒ—ã‚’nf4ã«è¨­å®š
    bnb_4bit_use_double_quant=True,  # äºŒé‡é‡å­åŒ–ã‚’ä½¿ç”¨ã™ã‚‹
    bnb_4bit_compute_dtype=torch.bfloat16,  # è¨ˆç®—ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’bfloat16ã«è¨­å®š
)

model = AutoModelForCausalLM.from_pretrained(  # Causal Language Modelï¼ˆå› æœè¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰
    model_id,
    low_cpu_mem_usage=True,  # CPUãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ä½ãã™ã‚‹
    quantization_config=quantization_config,  # é‡å­åŒ–è¨­å®šã‚’é©ç”¨
    torch_dtype=torch.float16,  # PyTorchã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’float16ã«è¨­å®š
)

pipe = pipeline("text-generation", model=model, tokenizer=tokenizer, device_map="auto")  # ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã®ãŸã‚ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆ

def parse_response(response):  # å¿œç­”ã‚’è§£æã™ã‚‹é–¢æ•°
    match = re.search(".+?\?", response.replace('*', ''))  # å¿œç­”ã‹ã‚‰ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã‚’å–å¾—
    if match is None:  # ãƒãƒƒãƒãŒå­˜åœ¨ã—ãªã„å ´åˆ
        question = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œsã€ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•ã‚’è¨­å®š
    else:
        question = match.group()  # ãƒãƒƒãƒã—ãŸè³ªå•ã‚’å–å¾—
    return question

def generate_answer(chat_template):  # å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    output = pipe(
        chat_template,  # ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‘ã‚¤ãƒ—ã«æ¸¡ã™
        max_new_tokens=32,  # æœ€å¤§ç”Ÿæˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’32ã«è¨­å®š
        do_sample=False,  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹ã«ã™ã‚‹
#         temperature=0.01,  # æ¸©åº¦ã‚’è¨­å®šï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
#         top_p=0.1,  # top-pã‚’è¨­å®šï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
#         top_k=1,  # top-kã‚’è¨­å®šï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        return_full_text=False,  # å®Œå…¨ãªãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã•ãªã„
    )[0]["generated_text"]  # ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    output = re.sub('<end_of_turn>', '', output)  # ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰'end_of_turn'ã‚’å‰Šé™¤
    return output


class Robot:  # Robotã‚¯ãƒ©ã‚¹ã‚’å®šç¾©
    def __init__(self):
        pass
    
    def on(self, mode, obs):  # ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        assert mode in ["asking", "guessing", "answering"], "modeã¯asking, answering, guessingã®ã„ãšã‚Œã‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"  # ãƒ¢ãƒ¼ãƒ‰ã®ç¢ºèª
        if mode == "asking":
            output = self.asker(obs)  # è³ªå•è€…ã®å ´åˆã®å‡¦ç†
        if mode == "answering":
            output = self.answerer(obs)  # å›ç­”è€…ã®å ´åˆã®å‡¦ç†
            if "yes" in output.lower() or "Yes" in output.lower():  # å¿œç­”ãŒã€Œyesã€ã®å ´åˆ
                output = "yes"  # å‡ºåŠ›ã‚’ã€Œyesã€ã«è¨­å®š
            elif "no" in output.lower() or "No" in output.lower():  # å¿œç­”ãŒã€Œnoã€ã®å ´åˆ
                output = "no"  # å‡ºåŠ›ã‚’ã€Œnoã€ã«è¨­å®š
            else:  # ãã®ä»–ã®å ´åˆ
                output = "no"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œnoã€ã«è¨­å®š
        if mode == "guessing":
            output = self.asker(obs)  # æ¨æ¸¬è€…ã®å ´åˆã®å‡¦ç†
        return output

    def asker(self, obs):  # è³ªå•è€…ã®å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        sys_prompt = """
        ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆå‡ºã—ã€è³ªå•è€…ã®ã¯ã„/ã„ã„ãˆè³ªå•ã«å›ç­”ã—ã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®ã€Œã‚‚ã®ã€ã¾ãŸã¯ã€Œå ´æ‰€ã€ã§ã™ã€‚
        """
        if obs.turnType =="ask":  # è³ªå•ã™ã‚‹ã‚¿ãƒ¼ãƒ³
            ask_prompt = sys_prompt + """
            ã€Œ20ã®è³ªå•ã€ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
            ã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚
            ä¾‹ã«å¾“ã£ã¦ãã ã•ã„:
            ä¾‹: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œãƒ¢ãƒ­ãƒƒã‚³ã€
            <assistant: ãã‚Œã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ
            user: ã„ã„ãˆ
            assistant: ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ
            user: ã¯ã„
            assistant: ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            user: ã¯ã„
            assistant: mã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            user: ã¯ã„
            assistant: ãã‚Œã¯ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            user: ã¯ã„ã€‚>
            """

            chat_template = f"""<start_of_turn>system\n{ask_prompt}\n"""  # ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ

            if len(obs.questions)>=1:  # è³ªå•ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆ
                chat_template += "ã“ã‚Œã¾ã§ã®ä¼šè©±ã®å±¥æ­´:\n"  # ä¼šè©±å±¥æ­´ã®è¿½åŠ 
                chat_template += "<\n"
                for q, a in zip(obs.questions, obs.answers):  # è³ªå•ã¨å¿œç­”ã‚’ãƒ«ãƒ¼ãƒ—
                    chat_template += f"assistant:\n{q}\n"
                    chat_template += f"user:\n{a}\n"
                chat_template += ">\n"
                    
            chat_template += """
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã å˜èªã«ã¤ã„ã¦ã€æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãã€å†—é•·ãªè¡¨ç¾ã‚’é¿ã‘ã¦ã€ä¸€ã¤ã®è³ªå•ã ã‘ã‚’ã—ã¦ãã ã•ã„.<end_of_turn>
            <start_of_turn>assistant\n
            """
            output = generate_answer(chat_template)  # å¿œç­”ã‚’ç”Ÿæˆ
            output = parse_response(output)  # å¿œç­”ã‚’è§£æ
                
        elif obs.turnType == "guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³
            conv = ""
            for q, a in zip(obs.questions, obs.answers):  # è³ªå•ã¨å¿œç­”ã‚’ãƒ«ãƒ¼ãƒ—
                conv += f"""question:\n{q}\nanswer:\n{a}\n"""
            guess_prompt =  sys_prompt + f"""
            ã‚ãªãŸã®å½¹å‰²ã¯ã€è³ªå•ã‚„å›ç­”ã«åŸºã¥ã„ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’äºˆæ¸¬ã™ã‚‹ã“ã¨ã§ã™ã€‚
            ä¾‹ã«å¾“ã£ã¦ãã ã•ã„:
            ä¾‹:
            <question: ãã‚Œã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ
            answer: ã„ã„ãˆ
            question: ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ
            answer: ã¯ã„
            question: ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            answer: ã¯ã„
            question: mã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            answer: ã¯ã„
            ã‚ãªãŸ: ãƒ¢ãƒ­ãƒƒã‚³>
            
            ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¯æ¬¡ã®é€šã‚Šã§ã™:\n{conv}
            ä¼šè©±ã«åŸºã¥ã„ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ãŸã ã€å˜èªã ã‘ã‚’ç­”ãˆã¦ã€å†—é•·ã«ã—ãªã„ã§ãã ã•ã„<end_of_turn>
            """
            chat_template = f"""<start_of_turn>system\n{guess_prompt}\n"""  # ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
            chat_template += "<start_of_turn>you:\n"
            output = generate_answer(chat_template)  # å¿œç­”ã‚’ç”Ÿæˆ
        return output
    
    def answerer(self, obs):  # å›ç­”è€…ã®å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        ask_prompt = f"""
        ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆå‡ºã—ã€è³ªå•è€…ã®ã¯ã„/ã„ã„ãˆè³ªå•ã«å›ç­”ã—ã¾ã™ã€‚
        ä¾‹ã«å¾“ã£ã¦ãã ã•ã„:
        ä¾‹: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œãƒ¢ãƒ­ãƒƒã‚³ã€
        <user: ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        user: ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã„ã„ãˆ
        user: ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        user: mã§å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        user: ãã‚Œã¯ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„ã€‚>
        "{obs.keyword}"ã«ã¤ã„ã¦ã€æ¬¡ã®è³ªå•ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã¦ãã ã•ã„:
        {obs.questions[-1]}
        """
        chat_template = f"""<start_of_turn>system\n{ask_prompt}<end_of_turn>\n"""  # ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
        chat_template += "<start_of_turn>Assistant\n"
        output = generate_answer(chat_template)  # å¿œç­”ã‚’ç”Ÿæˆ
        return output

robot = Robot()  # Robotã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ

def agent(obs, cfg):  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°
    if obs.turnType =="ask":  # è³ªå•ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "asking", obs = obs)
        
    elif obs.turnType =="guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "guessing", obs = obs)
        
    elif obs.turnType =="answer":  # å›ç­”ã™ã‚‹ã‚¿ãƒ¼ãƒ³
        response = robot.on(mode = "answering", obs = obs)
        
    if response == None or len(response)<=1:  # å¿œç­”ãŒç„¡åŠ¹ãªå ´åˆ
        response = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”ã‚’ã€Œyesã€ã«è¨­å®š
        
    return response
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/input/qwen2/transformers/qwen2-7b-instruct . -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 6)---
```python
# # tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰

# import tarfile
# tar = tarfile.open("/kaggle/working/submission.tar.gz")
# for file in tar.getmembers():
#     print(file.name)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹å‰ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
# !wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py
```

---The following area is a Code cell (cell numver is 9)---
```python
# import json
# import pandas as pd
# from submission.main import agent
# from keywords_local import KEYWORDS_JSON

# class Observation:
#     def __init__(self):
#         self.step = 0  # ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚’åˆæœŸåŒ–
#         self.role = "guesser"  # å½¹å‰²ã‚’ã€Œæ¨æ¸¬è€…ã€ã«è¨­å®š
#         self.turnType = "ask"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ã€Œè³ªå•ã€ã«è¨­å®š
#         self.keyword = "Japan"  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œæ—¥æœ¬ã€ã«è¨­å®š
#         self.category = "country"  # ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œå›½ã€ã«è¨­å®š
#         self.questions = []  # è³ªå•ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
#         self.answers = []  # å¿œç­”ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
#         self.guesses = []  # æ¨æ¸¬ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
        
# def create_keyword_df(KEYWORDS_JSON):  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
#     json_data = json.loads(KEYWORDS_JSON)  # JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰

#     keyword_list = []  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
#     category_list = []  # ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
#     alts_list = []  # ä»£æ›¿ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–

#     for i in range(len(json_data)):  # JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ«ãƒ¼ãƒ—
#         for j in range(len(json_data[i]['words'])):  # å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ«ãƒ¼ãƒ—
#             keyword = json_data[i]['words'][j]['keyword']  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
#             keyword_list.append(keyword)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
#             category_list.append(json_data[i]['category'])  # ã‚«ãƒ†ã‚´ãƒªã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
#             alts_list.append(json_data[i]['words'][j]['alts'])  # ä»£æ›¿ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 

#     data_pd = pd.DataFrame(columns=['keyword', 'category', 'alts'])  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
#     data_pd['keyword'] = keyword_list  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ—ã‚’è¨­å®š
#     data_pd['category'] = category_list  # ã‚«ãƒ†ã‚´ãƒªåˆ—ã‚’è¨­å®š
#     data_pd['alts'] = alts_list  # ä»£æ›¿åˆ—ã‚’è¨­å®š
    
#     return data_pd
    
# keywords_df = create_keyword_df(KEYWORDS_JSON)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 10)---
```python
# obs = Observation()  # è¦³å¯Ÿã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
# cfg = "_"

# sample_df = keywords_df.sample()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—
# obs.keyword = sample_df["keyword"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
# obs.category = sample_df["category"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
# alts_list = sample_df["alts"].values[0]  # ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ä»£æ›¿ãƒªã‚¹ãƒˆã‚’è¨­å®š
# alts_list.append(obs.keyword)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä»£æ›¿ãƒªã‚¹ãƒˆã«è¿½åŠ 

# print(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {obs.keyword}")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º

# for round in range(20):  # 20ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç¹°ã‚Šè¿”ã—
#     obs.step = round+1  # ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
    
#     obs.role = "guesser"  # å½¹å‰²ã‚’ã€Œæ¨æ¸¬è€…ã€ã«è¨­å®š
#     obs.turnType = "ask"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ã€Œè³ªå•ã€ã«è¨­å®š
#     question = agent(obs, cfg)  # è³ªå•ã‚’ç”Ÿæˆ
#     obs.questions.append(question)  # è³ªå•ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
#     obs.role = "answerer"  # å½¹å‰²ã‚’ã€Œå›ç­”è€…ã€ã«è¨­å®š
#     obs.turnType = "answer"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ã€Œå›ç­”ã€ã«è¨­å®š
#     answer = agent(obs, cfg)  # å¿œç­”ã‚’ç”Ÿæˆ
#     obs.answers.append(answer)  # å¿œç­”ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
#     obs.role = "guesser"  # å½¹å‰²ã‚’ã€Œæ¨æ¸¬è€…ã€ã«è¨­å®š
#     obs.turnType = "guess"  # ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’ã€Œæ¨æ¸¬ã€ã«è¨­å®š
#     guess = agent(obs, cfg)  # æ¨æ¸¬ã‚’ç”Ÿæˆ
#     obs.guesses.append(guess)  # æ¨æ¸¬ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
    
#     print(f"ãƒ©ã‚¦ãƒ³ãƒ‰: {round+1}")  # ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¡¨ç¤º
#     print(f"è³ªå•: {question}")  # è³ªå•ã‚’è¡¨ç¤º
#     print(f"å¿œç­”: {answer}")  # å¿œç­”ã‚’è¡¨ç¤º
#     print(f"æ¨æ¸¬: {guess}")  # æ¨æ¸¬ã‚’è¡¨ç¤º
    
#     if guess in alts_list:  # æ¨æ¸¬ãŒä»£æ›¿ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆ
#         print("å‹åˆ©!!")  # å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
#         break
```

** @@@ Jupyter Notebook numver 28, the number of votes :8 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ç”»åƒç”Ÿæˆã«é–¢é€£ã™ã‚‹å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ãŠã‚Šã€ç‰¹ã«ã€ŒStable Diffusionã€ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚‚ã¨ã«ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã«è¦ç´„ã‚’ç¤ºã—ã¾ã™ã€‚

### è¦ç´„

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹Stable Diffusionã‚’åˆ©ç”¨ã—ã¦ã€æŒ‡å®šã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ãç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰**:
   - æœ€åˆã«ã€`diffusers`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã€ãã®ä»–ã®é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`invisible_watermark`, `transformers`, `accelerate`, `safetensors`ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚

2. **ç’°å¢ƒè¨­å®š**:
   - PyTorchã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã¨ã‚‚ã«ã€è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç„¡è¦–ã™ã‚‹ãŸã‚ã®è¨­å®šãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

3. **ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿**:
   - äº‹å‰å­¦ç¿’æ¸ˆã¿ã®ã€ŒStable Diffusionã€ãƒ¢ãƒ‡ãƒ«ï¼ˆ`stabilityai/stable-diffusion-xl-base-1.0`ï¼‰ã‚’ã€åŠç²¾åº¦æµ®å‹•å°æ•°ç‚¹ï¼ˆfp16ï¼‰å½¢å¼ã§èª­ã¿è¾¼ã¿ã€GPUä¸Šã§ã®è¨ˆç®—ã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§ã€é«˜é€Ÿãªå‡¦ç†ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

4. **ç”»åƒç”Ÿæˆ**:
   - ç‰¹å®šã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ"a rabbit wearing glasses while reading a book"ï¼‰ã‚’åŸºã«ç”»åƒã‚’ç”Ÿæˆã—ã€ãã®æœ€åˆã®ç”»åƒã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ä¸»ã«æ©Ÿæ¢°å­¦ç¿’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹`diffusers`ã‚’åˆ©ç”¨ã—ã€ç”»åƒç”Ÿæˆã®ãŸã‚ã®é«˜åº¦ãªãƒ¢ãƒ‡ãƒ«ã‚’æ“ä½œã™ã‚‹å®Ÿè·µçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# diffusersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
!pip install diffusers --upgrade
# invisble_watermarkã€transformersã€accelerateã€safetensorsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
!pip install invisible_watermark transformers accelerate safetensors
```

---The following area is a Code cell (cell numver is 2)---
```python
import torch
from diffusers import DiffusionPipeline
import warnings

# è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç„¡è¦–ã™ã‚‹è¨­å®šã§ã™
warnings.filterwarnings('ignore')
```

---The following area is a Code cell (cell numver is 3)---
```python
# äº‹å‰å­¦ç¿’æ¸ˆã¿ã®Stable Diffusionãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
pipe = DiffusionPipeline.from_pretrained("stabilityai/stable-diffusion-xl-base-1.0", torch_dtype=torch.float16, use_safetensors=True, variant="fp16")
# ãƒ¢ãƒ‡ãƒ«ã‚’GPUã«è»¢é€ã—ã¦è¨ˆç®—ã‚’é«˜é€ŸåŒ–ã—ã¾ã™
pipe.to("cuda")
```

---The following area is a Code cell (cell numver is 4)---
```python
# æç”»ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ‡å®šã—ã¾ã™
prompt = "a rabbit wearing glasses while reading a book "

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™
images = pipe(prompt=prompt)
```

---The following area is a Code cell (cell numver is 5)---
```python
# ç”Ÿæˆã—ãŸç”»åƒã®æœ€åˆã®1æšã‚’è¡¨ç¤ºã—ã¾ã™
images.images[0]
```

** @@@ Jupyter Notebook numver 29, the number of votes :8 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’è£½ä½œã—ã€ä¸€èˆ¬çš„ãªè¨€è‘‰å½“ã¦ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ãƒ¢ãƒ‡ãƒ«ã®çŠ¶æ…‹ã®ç®¡ç†ã€è³ªå•ã¨å›ç­”ã®ç”Ÿæˆã€åŠã³æ¨æ¸¬ã‚’è¡Œã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚

### å•é¡Œã¸ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- **ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: Kaggleç’°å¢ƒã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`rigging`ã€`transformers`ã€`Kaggle`ãªã©ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
- **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã®å–å¾—**: Hugging FaceåŠã³Kaggleã®APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: Hugging Face Hubã‹ã‚‰ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ï¼ˆ`Meta-Llama-3-8B-Instruct-bnb-8bit`ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã¨æ¤œè¨¼**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ç°¡å˜ãªãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã€æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Rigging**: ãƒ¢ãƒ‡ãƒ«ã®è³ªå•ç”Ÿæˆã‚„å¿œç­”ã®ç®¡ç†ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
- **Hugging Face**: äº‹å‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
- **pydantic**: ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã‚„è¨­å®šã®ç®¡ç†ã‚’è¡Œã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

### å®Ÿè£…ã®è©³ç´°
- **ã‚¯ãƒ©ã‚¹å®šç¾©**: `Observation`ã‚„`Question`ã€`Answer`ã€`Guess`ã¨ã„ã£ãŸã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
- **é–¢æ•°ã®å®Ÿè£…**: `ask`ã€`answer`ã€`guess`ã¨ã„ã£ãŸé–¢æ•°ã‚’å®šç¾©ã—ã€ãã‚Œãã‚Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•ã‚’ç”Ÿæˆã—ãŸã‚Šã€å›ç­”ã—ãŸã‚Šã€æ¨æ¸¬ã‚’è¡Œã†ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã‚“ã§ã„ã¾ã™ã€‚
- **ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ**: `agent_fn`é–¢æ•°ã«ã¦ã€ç•°ãªã‚‹ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†ã‚’è¡Œã„ã€å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã«å¿…è¦ãªå‹•ä½œã‚’ç®¡ç†ã—ã¾ã™ã€‚

### å‡ºåŠ›ã®æ•´ç†
æœ€çµ‚çš„ã«ã€`submission.tar.gz`ãŒç”Ÿæˆã•ã‚Œã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¸ã®æå‡ºãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¿ å®Ÿã«å†ç¾ã—ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒåŠ¹æœçš„ã«æ©Ÿèƒ½ã™ã‚‹ãŸã‚ã®é‡è¦ãªæ§‹æˆè¦ç´ ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

!pip install -U \
    -t /kaggle/tmp/lib \
    rigging \
    kaggle \
    transformers \
    accelerate \
    -i https://pypi.org/simple/ bitsandbytes
```

---The following area is a Code cell (cell numver is 2)---
```python
# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã®å–å¾—

from kaggle_secrets import UserSecretsClient
secrets = UserSecretsClient()

HF_TOKEN = secrets.get_secret("HF_TOKEN")

KAGGLE_KEY = secrets.get_secret("KAGGLE_KEY")
KAGGLE_USERNAME = secrets.get_secret("KAGGLE_USERNAME")
```

---The following area is a Code cell (cell numver is 3)---
```python
# ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

from huggingface_hub import snapshot_download
from pathlib import Path
import shutil

g_model_path = Path("/kaggle/tmp/model")
if g_model_path.exists():
    shutil.rmtree(g_model_path)  # æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
g_model_path.mkdir(parents=True)  # æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ã‚’ä½œæˆ

snapshot_download(
    repo_id="alokabhishek/Meta-Llama-3-8B-Instruct-bnb-8bit",
    local_dir=g_model_path,
    local_dir_use_symlinks=False,
    token=HF_TOKEN  # Hugging Faceã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
)
```

---The following area is a Code cell (cell numver is 4)---
```python
# ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿æ¤œè¨¼

import sys

sys.path.insert(0, "/kaggle/tmp/lib")  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 

import rigging as rg  # Riggingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

generator = rg.get_generator("transformers!/kaggle/tmp/model,device_map=cuda:0")  # ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å–å¾—
chat = generator.chat("Say Hello!").run()  # ãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè¡Œ

print(chat.last)  # æœ€æ–°ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 5)---
```python
%%writefile main.py

import itertools
import os
import sys
import typing as t
from pathlib import Path

# ãƒ‘ã‚¹ã®ä¿®æ­£

g_working_path = Path('/kaggle/working')
g_input_path = Path('/kaggle/input')
g_temp_path = Path("/kaggle/tmp")
g_agent_path = Path("/kaggle_simulations/agent/")
g_model_path = g_temp_path / "model"

if g_agent_path.exists():
    sys.path.insert(0, str(g_agent_path / "lib"))  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 
    g_model_path = g_agent_path / "model"
else:
    sys.path.insert(0, str(g_temp_path / "lib"))  # ä¸€æ™‚çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 

import rigging as rg  # noqa
from pydantic import BaseModel, field_validator, StringConstraints  # noqa

# å®šæ•°

g_generator_id = f"transformers!{g_model_path},trust_remote_code=True,max_tokens=1024,temperature=1.0,top_k=256"

# å‹

str_strip = t.Annotated[str, StringConstraints(strip_whitespace=True)]

class Observation(BaseModel):
    step: int  # ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
    role: t.Literal["guesser", "answerer"]  # å½¹å‰²ï¼ˆæ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ï¼‰
    turnType: t.Literal["ask", "answer", "guess"]  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡
    keyword: str  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    category: str  # ã‚«ãƒ†ã‚´ãƒªãƒ¼
    questions: list[str]  # è³ªå•ã®ãƒªã‚¹ãƒˆ
    answers: list[str]  # å›ç­”ã®ãƒªã‚¹ãƒˆ
    guesses: list[str]  # æ¨æ¸¬ã®ãƒªã‚¹ãƒˆ
    
    @property
    def empty(self) -> bool:
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])  # ã™ã¹ã¦ã®ãƒªã‚¹ãƒˆãŒç©ºã‹ç¢ºèª
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")  # å±¥æ­´ã‚’å–å¾—

    def get_history_as_xml(self, *, skip_guesses: bool = False) -> str:
        return "\n".join(
            f"""\
            <turn-{i}>
            Question: {question}
            Answer: {answer}
            {'Guess: ' + guess if not skip_guesses else ''}
            </turn-{i}>
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
        ) if not self.empty else "none yet."  # XMLå½¢å¼ã§å±¥æ­´ã‚’å–å¾—


class Answer(rg.Model):
    content: t.Literal["yes", "no", "maybe"]  # å›ç­”ã®å†…å®¹

    @field_validator("content", mode="before")
    def validate_content(cls, v: str) -> str:  # å›ç­”ã®å†…å®¹ã‚’æ¤œè¨¼
        for valid in ["yes", "no", "maybe"]:  # æœ‰åŠ¹ãªå›ç­”ã‚’å®šç¾©
            if v.lower().startswith(valid):
                return valid
        raise ValueError("Invalid answer, must be one of 'yes', 'no', 'maybe'")  # ç„¡åŠ¹ãªå›ç­”ã®å ´åˆã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹

    @classmethod
    def xml_example(cls) -> str:
        return f"{Answer.xml_start_tag()}**yes/no/maybe**{Answer.xml_end_tag()}"  # XMLä¾‹ã‚’è¿”ã™


class Question(rg.Model):
    content: str_strip  # è³ªå•ã®å†…å®¹

    @classmethod
    def xml_example(cls) -> str:
        return Question(content="**question**").to_pretty_xml()  # è³ªå•ã®XMLä¾‹


class Guess(rg.Model):
    content: str_strip  # æ¨æ¸¬ã®å†…å®¹

    @classmethod
    def xml_example(cls) -> str:
        return Guess(content="**thing/place/person**").to_pretty_xml()  # æ¨æ¸¬ã®XMLä¾‹


# é–¢æ•°


def ask(base: rg.PendingChat, observation: Observation) -> str:
    chat = (
        base.fork(
            f"""\
            ã‚ãªãŸã¯ç¾åœ¨ã€æ¬¡ã®è³ªå•ã‚’ã—ã¦ã„ã¾ã™ã€‚

            <game-history>
            {observation.get_history_as_xml(skip_guesses=True)}
            </game-history>

            ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ã¦ã€æ¬¡ã«æœ€ã‚‚æœ‰ç”¨ãªã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’å°‹ã­ã€ä»¥ä¸‹ã®å½¢å¼ã«ç½®ã„ã¦ãã ã•ã„:
            {Question.xml_example()}

            - ã‚ãªãŸã®å¿œç­”ã¯ã€æœ€ã‚‚æƒ…å ±ã‚’å¾—ã‚‹ãŸã‚ã®é›†ä¸­ã—ãŸè³ªå•ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            - è³ªå•ã§ã¯ä¸€èˆ¬çš„ãªå†…å®¹ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„
            - æ®‹ã‚Šã®æ¢ç´¢ç©ºé–“ã‚’å¸¸ã«äºŒåˆ†å‰²ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„
            - å‰ã®è³ªå•ã¨å›ç­”ã«æ³¨æ„ã‚’æ‰•ã£ã¦ãã ã•ã„

            æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ
            """
        )
        .until_parsed_as(Question, attempt_recovery=True)
        .run()
    )
    return chat.last.parse(Question).content


def answer(base: rg.PendingChat, observation: Observation) -> t.Literal["yes", "no", "maybe"]:
    last_question = observation.questions[-1]  # æœ€å¾Œã®è³ªå•ã‚’å–å¾—
    chat = (
        base.fork(
            f"""\
            ã“ã®ã‚²ãƒ¼ãƒ ã®ç§˜å¯†ã®è¨€è‘‰ã¯ "{observation.keyword}" ã§ã™ã€‚

            ã‚ãªãŸã¯ç¾åœ¨ã€ä¸Šè¨˜ã®ä½œæ¥­ã«ã¤ã„ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ã„ã¾ã™ã€‚

            æ¬¡ã®è³ªå•ã¯ "{last_question}" ã§ã™ã€‚

            ä¸Šè¨˜ã®ã¯ã„/ã„ã„ãˆã®è³ªå•ã«å›ç­”ã—ã€ä»¥ä¸‹ã®å½¢å¼ã«ç½®ã„ã¦ãã ã•ã„:
            {Answer.xml_example()}

            - ã‚ãªãŸã®å¿œç­”ã¯ã€ä¸Šè¨˜ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦æ­£ç¢ºã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            - å¸¸ã«"ã¯ã„"ã€"ã„ã„ãˆ"ã€ã¾ãŸã¯"å¤šåˆ†"ã§å›ç­”ã—ã¦ãã ã•ã„

            ç­”ãˆã¯ä½•ã§ã™ã‹ï¼Ÿ
            """
        )
        .until_parsed_as(Answer, attempt_recovery=True)
        .run()
    )
    return chat.last.parse(Answer).content


def guess(base: rg.PendingChat, observation: Observation) -> str:
    pending = (
        base.fork(
            f"""\
            ã‚ãªãŸã¯ç¾åœ¨ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãƒ‰ãƒ»ã‚²ã‚¹ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

            <game-history>
            {observation.get_history_as_xml()}
            </game-history>

            ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¬¡ã®æœ€é©ãªæ¨æ¸¬ã‚’ç”Ÿæˆã—ã€ä»¥ä¸‹ã®å½¢å¼ã«ç½®ã„ã¦ãã ã•ã„:
            {Guess.xml_example()}

            - ä¸Šè¨˜ã®å±¥æ­´ã«åŸºã¥ã„ã¦ç¹°ã‚Šè¿”ã—ã®æ¨æ¸¬ã‚’é¿ã‘ã¦ãã ã•ã„
            - æ¨æ¸¬ã¯å…·ä½“çš„ãªäººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã‚ã‚‹ã¹ãã§ã™

            ã‚ãªãŸã®æ¨æ¸¬ã¯ä½•ã§ã™ã‹ï¼Ÿ
            """
        )
        .until_parsed_as(Guess, attempt_recovery=True)
        .run()
    )
        
    return chat.last.parse(Guess).content

# ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼

generator = rg.get_generator(g_generator_id)

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

def agent_fn(obs: t.Any, _: t.Any) -> str:
    observation = Observation(**obs.__dict__)  # è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    
    try:
        base = generator.chat("""\
            ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®æ‰èƒ½ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚ã‚ãªãŸã¯æ­£ç¢ºã§ã€é›†ä¸­åŠ›ãŒã‚ã‚Šã€æ§‹é€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã¯æœ‰ç”¨ãªè³ªå•ã‚’ä½œæˆã—ã€æ¨æ¸¬ã‚’è¡Œã„ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹è³ªå•ã«å›ç­”ã—ã¾ã™ã€‚
            
            """
        )
    
        match observation.turnType:  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹
            case "ask":
                return ask(base, observation)  # è³ªå•ã‚’ã™ã‚‹å ´åˆ
            case "answer":
                if not observation.keyword:  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆ
                    return "maybe"  # å¤šåˆ†ã‚’è¿”ã™
                return answer(base, observation)  # å›ç­”ã‚’ã™ã‚‹å ´åˆ
            case "guess":
                return guess(base, observation)  # æ¨æ¸¬ã‚’ã™ã‚‹å ´åˆ
            case _:
                raise ValueError("Unknown turn type")  # ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®å ´åˆã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
    except Exception as e:
        print(str(e), file=sys.stderr)  # ã‚¨ãƒ©ãƒ¼ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼ã«å‡ºåŠ›
        raise
```

---The following area is a Code cell (cell numver is 6)---
```python
!apt install pigz pv  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 7)---
```python
# submission.tar.gzã‚’ä½œæˆã™ã‚‹

!tar --use-compress-program='pigz --fast' \
    -cf submission.tar.gz \
    --dereference \
    -C /kaggle/tmp model lib \
    -C /kaggle/working main.py
```

---The following area is a Code cell (cell numver is 8)---
```python
# Kaggleã«ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥

!KAGGLE_USERNAME={KAGGLE_USERNAME} \
 KAGGLE_KEY={KAGGLE_KEY} \
 kaggle competitions submit -c llm-20-questions -f submission.tar.gz -m "Updates"
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## MarÃ­lia Prata
> 
> Rigging with Llama3ã‚’ç´¹ä»‹ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã† Nick (Nicklanders)ã€‚
> 
> 

---
```

** @@@ Jupyter Notebook numver 30, the number of votes :7 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­å®šã¨ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®å•é¡Œã¨æ‰‹æ³•ãŒå–ã‚Šçµ„ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### å•é¡Œ
- Kaggleç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®PyTorchï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³2.3.1ï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã€é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã®è¨­å®šã€‚
- æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã«ã€ãã‚Œã«å¿œã˜ãŸä»£æ›¿ãƒ‘ã‚¹ã®è¨­å®šã€‚

### æ‰‹æ³•
- æœ€åˆã«ã€Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã€å­˜åœ¨ã—ãªã„å ´åˆã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚
- `subprocess` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦ã€æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã‹ã‚‰torchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- PyTorchã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
- ã•ã‚‰ã«ã€`conda`ã‚’åˆ©ç”¨ã—ã¦PyTorchã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ‰‹é †ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
- æœ€å¾Œã«ã€`pigz`ã¨`pv`ã‚’ä½¿ã£ã¦ã€ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åœ§ç¸®ã—ã€tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- `os`ã€`subprocess`ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ“ä½œã‚„å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- `torch`ã¯æ©Ÿæ¢°å­¦ç¿’ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€PyTorchã‚’ä¸­å¿ƒã«ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleç’°å¢ƒã§ã®ä½œæ¥­ã‚’å††æ»‘ã«é€²ã‚ã‚‹ãŸã‚ã®æº–å‚™çš„ãªå½¹å‰²ã‚’æœãŸã—ã¦ãŠã‚Šã€ç‰¹ã«ä¾å­˜é–¢ä¿‚ã®ç®¡ç†ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®ã«é‡ãã‚’ç½®ã„ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
!mkdir /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 2)---
```python
%%writefile submission/main.py
import os
import subprocess

# Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
# Kaggleãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™
KAGGLE_DATA_PATH = "/kaggle_simulations/agent/"
# ã‚‚ã—KAGGLE_AGENT_PATHãŒå­˜åœ¨ã—ãªã„å ´åˆ
if not os.path.exists(KAGGLE_AGENT_PATH):
    # KAGGLE_AGENT_PATHã‚’åˆ¥ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã—ã¾ã™
    KAGGLE_AGENT_PATH = '/kaggle/working/'
    # KAGGLE_DATA_PATHã‚’å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã«è¨­å®šã—ã¾ã™
    KAGGLE_DATA_PATH = "/kaggle/input/"

# æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã‹ã‚‰torchã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
subprocess.run(f'pip install --no-index --find-links {KAGGLE_DATA_PATH}torch_whl torch==2.3.1', shell=True, check=True, capture_output = True)
print('ok torch')  # torchã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™
import torch
print('torch', torch.__version__)  # ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹torchã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
# !pip install --no-index --find-links /kaggle/input/torch-2-3-whl/torch_whl torch==2.3.1
```

---The following area is a Code cell (cell numver is 4)---
```python
!conda install /kaggle/input/torch-2-3-whl/torch_whl/torch-2.3.1-cp310-cp310-manylinux1_x86_64.whl
```

---The following area is a Code cell (cell numver is 5)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 6)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/input/torch-2-3-whl . -C /kaggle/working/submission .
```

** @@@ Jupyter Notebook numver 31, the number of votes :6 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ç›®æ¨™ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã«ãŠã„ã¦ã€å¯¾è±¡ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§å›ç­”ã™ã‚‹è³ªå•ã‚’ç”Ÿæˆã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã™ã€‚

### å•é¡Œã®æ¦‚è¦
- **å•é¡Œè¨­å®š**: 20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒææ¡ˆã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨å®šã™ã‚‹ãŸã‚ã®è³ªå•ã¨å›ç­”ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€éå»ã®è³ªå•ã¨å›ç­”ã®å±¥æ­´ã‚’ã‚‚ã¨ã«æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã€æ­£ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: PyTorchãƒ™ãƒ¼ã‚¹ã®Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã€æ¨è«–ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€å¤§è¦æ¨¡ãªå› æœé–¢ä¿‚ã®å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€äºˆæ¸¬ç”Ÿæˆã«ç”¨ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸­ã§ã¯ã€Gemmaãƒ¢ãƒ‡ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã€è¨“ç·´ã•ã‚ŒãŸé‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚
   
2. **è³ªå•ç”Ÿæˆã¨å›ç­”è§£æ**: 
   - **GemmaFormatterã‚¯ãƒ©ã‚¹**: è³ªå•ã¨å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç®¡ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠã‚ˆã³ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é©åˆ‡ã«æ§‹ç¯‰ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
   - **GemmaAgentã‚¯ãƒ©ã‚¹**: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºæœ¬æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€è³ªå•ã®å±¥æ­´ã€å›ç­”å±¥æ­´ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç¢ºç‡ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã‚ªãƒ–ã‚¶ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
   - **GemmaQuestionerAgent** ã¨ **GemmaAnswererAgent**: è³ªå•è€…ã¨å›ç­”è€…ãã‚Œãã‚Œã®å½¹å‰²ã‚’æœãŸã™ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã§ã€è³ªå•ã‚’ç”Ÿæˆã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å›ç­”ã‚’æä¾›ã—ã¾ã™ã€‚

### è©•ä¾¡ã¨ãƒ‡ãƒãƒƒã‚°
- ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€è©•ä¾¡ãƒ­ã‚°ã®è§£æã‚„ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚‚çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€è³ªå•ã®æ´—ç·´ã‚„ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åŸºã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€§èƒ½ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®è©¦è¡ŒãŒç¶™ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚

### çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹åŠ¹æœçš„ãªæ¨ç†ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã«æ³¨åŠ›ã—ã¦ã„ã¾ã™ã€‚Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ´»ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ã®ä¸­ã§é©åˆ‡ãªè³ªå•ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒãƒƒã‚°ã‚„è©•ä¾¡ã«å–ã‚Šçµ„ã¿ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€§èƒ½ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®è©¦è¡ŒéŒ¯èª¤ã‚‚è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ãƒãƒ¼ãƒˆï¼š

ã“ã‚Œã¯é›£ã—ã„æŒ‘æˆ¦ã§ã™ï¼ç§ã¯ã•ã¾ã–ã¾ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è©¦ã—ã€ã¯ã„/ã„ã„ãˆã®å›ç­”ã«ç¢ºç‡çš„é‡ã¿ã‚’è¿½åŠ ã—ã€LLMã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã€è³ªå•ã‚’æ´—ç·´ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚è©•ä¾¡ãƒ­ã‚°ã§ã¯ãƒãƒ¼ãƒ ã®ãƒšã‚¢ãƒªãƒ³ã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€LLMã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç†è§£ã™ã‚‹ã®ãŒé›£ã—ã„ã§ã™ã€‚ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒãƒƒã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚æ¯æ—¥æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ã¦ã„ã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„å­¦ç¿’ä½“é¨“ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
# gemma_pytorch ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null
# gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/
# gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py

import os
import sys

# Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
# Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€libã‚’è¿½åŠ ã—ã¾ã™
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
# å­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®libã‚’è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

# é‡ã¿ã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™
if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"

import itertools
from typing import Iterable

# 2ã¤ã®ãƒªã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒªãƒ¼ãƒ–ã—ã¾ã™ï¼ˆã‚µã‚¤ã‚ºãŒç•°ãªã‚‹å ´åˆã‚‚è€ƒæ…®ï¼‰
def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]

class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã—ã¾ã™
        return self._state

    def user(self, prompt):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çŠ¶æ…‹ã«è¿½åŠ ã—ã¾ã™
        self._state += self._turn_user.format(prompt)
        return self

    def model(self, prompt):
        # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çŠ¶æ…‹ã«è¿½åŠ ã—ã¾ã™
        self._state += self._turn_model.format(prompt)
        return self

    def start_user_turn(self):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ã—ã¾ã™
        self._state += f"{self._start_token}user\n"
        return self

    def start_model_turn(self):
        # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ã—ã¾ã™
        self._state += f"{self._start_token}model\n"
        return self

    def end_turn(self):
        # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’ç¤ºã™ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ã—ã¾ã™
        self._state += f"{self._end_token}\n"
        return self

    def reset(self):
        # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šã—ã¾ã™
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        # æä¾›ã•ã‚ŒãŸã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¾ã™
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self

import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torchãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)

from collections import defaultdict

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
    
class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)
        self.question_history = []
        self.answer_history = []
        self.keyword_probabilities = defaultdict(float)
        
        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant

        with _set_default_tensor_type(model_config.get_dtype()):
            self.model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            self.model.load_weights(ckpt_path)
            self.model = self.model.to(self._device).eval()
            
        self.tokenizer = self._initialize_tokenizer(model_config.tokenizer)

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        self.formatter.reset()
        if 'system_prompt' in obs:
            self.formatter.user(obs['system_prompt'])
        if 'few_shot_examples' in obs:
            self.formatter.apply_turns(obs['few_shot_examples'], start_agent='user')
        self.formatter.start_user_turn()

    def _call_llm(self, prompt, max_new_tokens=50, sampler_kwargs=None):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.6,
                'top_p': 0.9,
                'top_k': 50,
                'repetition_penalty': 0.8,
                'num_beams': 3,
                'early_stopping': False,
                'do_sample': True
            }
        # LLMã‚’å‘¼ã³å‡ºã—ã€å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã™
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        return match.group().lower() if match else ''

    def parse_response(self, response: str, obs: dict):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¾ã™
        keyword = self._parse_keyword(response)
        turn_type = obs.get('turnType')
        if turn_type == "ask":
            question = self._generate_question(keyword)
            self.question_history.append(question)
            return question
        elif turn_type == "guess":
            return f"**{keyword}**"
        elif turn_type == "answer":
            last_question = obs.get('questions', [])[-1]
            answer = self._analyze_answer(last_question, keyword)
            self.answer_history.append(answer)
            return answer
        else:
            return "ç„¡åŠ¹ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—"
    
    def _analyze_answer(self, question: str, context: str):
        # ç­”ãˆã‚’åˆ†æã—ã¾ã™
        question_lower = question.lower()
        keyword = self._parse_keyword(context)
        if "what" in question_lower:
            return f"ãƒ’ãƒ³ãƒˆ: ãã‚Œã¯{keyword}ã§ã™"
        elif "where" in question_lower:
            return f"ãƒ’ãƒ³ãƒˆ: ãã‚Œã¯{keyword}ã«é–¢é€£ã—ã¦ã„ã¾ã™"
        else:
            answer = "ã¯ã„" if "is" in question_lower else "ã„ã„ãˆ"
            self.answer_history.append(answer)
            for keyword in self.keyword_probabilities:
                self._update_probabilities(keyword, answer)
            return answer
        
    def _update_probabilities(self, keyword: str, answer: str):
        # ç¢ºç‡ã‚’æ›´æ–°ã—ã¾ã™
        if keyword in self.keyword_probabilities:
            self.keyword_probabilities[keyword] += 0.4 if answer == "ã¯ã„" else -0.25
            self.keyword_probabilities[keyword] = max(0.0, min(1.0, self.keyword_probabilities[keyword]))
        
        total_prob = sum(self.keyword_probabilities.values())
        if total_prob > 0:
            for key in self.keyword_probabilities:
                self.keyword_probabilities[key] /= total_prob
    
    def _suggest_keyword(self):
        # æœ€ã‚‚é«˜ã„ç¢ºç‡ã‚’æŒã¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¾ã™
        return max(self.keyword_probabilities, key=self.keyword_probabilities.get, default="")

    def _refine_question(self, question: str, answers: list):
        # è³ªå•ã‚’æ´—ç·´ã•ã›ã¾ã™
        if answers:
            last_answer = answers[-1].lower()
            if last_answer == "ã„ã„ãˆ":
                if "is it" in question.lower():
                    question = question.replace("Is it", "Could it be")
                elif "does it" in question.lower():
                    question = question.replace("Does it", "Might it")
            elif last_answer == "ã¯ã„":
                if "is it" in question.lower():
                    question = question.replace("Is it", "Is it specifically")
                elif "does it" in question.lower():
                    question = question.replace("Does it", "Does it specifically")
        
        return question

    def _generate_question(self, context: str):
        # æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¾ã™
        if self.question_history:
            last_question = self.question_history[-1]
            if last_question in context:
                return "å‰ã®è³ªå•ã®å›ç­”ã«åŸºã¥ã„ã¦æ¬¡ã®è«–ç†çš„ã¾ãŸã¯å‰µé€ çš„ãªè³ªå•..."
        
        input_ids = self.tokenizer.encode_plus(
            context,
            add_special_tokens=True,
            max_length=512,
            return_attention_mask=True,
            return_tensors='pt'
        )
        output = self.model.generate(input_ids['input_ids'], attention_mask=input_ids['attention_mask'])
        question = self.tokenizer.decode(output[0], skip_special_tokens=True)
        question = self._refine_question(question, self.answer_history)
        self.question_history.append(question)
        return question

    def _make_decision(self, obs: dict, context: str):
        # åˆ¤æ–­ã‚’è¡Œã„ã¾ã™
        turn_type = obs.get('turnType')
        if turn_type == "ask":
            return self._generate_question(context)
        elif turn_type == "guess":
            return f"**{self._suggest_keyword()}**"
        elif turn_type == "answer":
            question = obs.get('questions', [])[-1]
            return self._analyze_answer(question, context)
        return "ç„¡åŠ¹ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—"

# è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        # è³ªå•è€…ã¨ã—ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™
        self.formatter.reset()
        self.formatter.user("20è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¦ã„ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user(f"{obs.questions}ãŠã‚ˆã³{obs.answers}ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«yesã¾ãŸã¯noã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚ã“ã®è³ªå•ã¯ã€Œç ‚æ¼ ã§ã¯é›¨ãŒé™ã‚Šã¾ã™ã‹ï¼Ÿã€ã‚„ã€Œã‚ãªãŸã¯å¹¸ã›ã§ã™ã‹ï¼Ÿã€ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚ã£ã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¯èƒ½æ€§ã‚’çµã‚‹ãŸã‚ã®ã‚«ãƒ†ã‚´ãƒªã‚„è©³ç´°ã‚’çŸ¥ã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹è³ªå•ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚ãªãŸã®è³ªå•ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ¨æ¸¬ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¾ã™
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)

# ç­”å¼è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            
class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        # ç­”å¼è€…ã¨ã—ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯ç­”å¼è€…ã®å½¹å‰²ã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ã“ã®è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒªã®æ–‡è„ˆã«åŸºã¥ã„ã¦yesã¾ãŸã¯noã®å›ç­”ã®ã¿ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã€ã„ã„ãˆã‹ã¯ã„ã¨ã®ã¿ã®å›ç­”ã‚’è¿”ã—ã¾ã™
        answer = self._parse_keyword(response)
        return '**ã¯ã„**' if '**ã¯ã„**' in answer else '**ã„ã„ãˆ**'


system_prompt = "ã‚ãªãŸã¯ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«yesã¾ãŸã¯noã®è³ªå•ã‚’ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚è³ªå•è€…ã®å ´åˆã¯ã€æ¯ãƒ©ã‚¦ãƒ³ãƒ‰æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ã‚«ãƒ†ã‚´ãƒªã‚’çµã‚Šè¾¼ã‚“ã ã‚‰ã€æœ€åˆã®æ–‡å­—ã«é–¢ã™ã‚‹è³ªå•ã‚’ã—ã¦ã•ã‚‰ã«æ¨æ¸¬ã‚’ç‹­ã‚ã¦ãã ã•ã„ã€‚"

few_shot_examples = [
    ("ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®äººã¯ç”·æ€§ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®äººã¯ä¿³å„ªã§ã™ã‹ï¼Ÿ", "ã„ã„ãˆ"),
    ("ã“ã®äººã¯æ”¿æ²»å®¶ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®äººã¯ç¾åœ¨ç”Ÿãã¦ã„ã¾ã™ã‹ï¼Ÿ", "ã„ã„ãˆ"),
    ("ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å ´æ‰€ã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®éƒ½å¸‚ã¯ã‚¢ãƒ¡ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®éƒ½å¸‚ã¯å·ã®é¦–éƒ½ã§ã™ã‹ï¼Ÿ", "ã„ã„ãˆ"),
    ("ã“ã®éƒ½å¸‚ã¯æ±æµ·å²¸ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å›½ã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å›½ã¯æ¬§å·é€£åˆã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å›½ã¯æ­´å²çš„ãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã§çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯åœ°ç†çš„ç‰¹å¾´ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯å±±ã§ã™ã‹ï¼Ÿ", "ã„ã„ãˆ"),
    ("ãã‚Œã¯å·ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å·ã¯ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å·ã¯ä¸–ç•Œã§æœ€ã‚‚é•·ã„å·ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®å·ã¯nã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãƒŠã‚¤ãƒ«å·ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯ç‰©ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ã“ã®ç‰©ã¯äººé–“ãŒä½œã£ãŸã‚‚ã®ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯é€šä¿¡ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯æŠ€è¡“ã®ä¸€ç¨®ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯é£Ÿãƒ‘ãƒ³ã®ç®±ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯è»Šä¸¡ã®ä¸€ç¨®ã§ã™ã‹ï¼Ÿ", "ã„ã„ãˆ"),
    ("ãã‚Œã¯å±‹å†…ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã¯ã„"),
    ("ãã‚Œã¯å¨¯æ¥½ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "ã„ã„ãˆ")
]

agent = None

def get_agent(name: str):
    global agent
    
    # ç¾åœ¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent

def agent_fn(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’å®šç¾©ã—ã¾ã™
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    if response is None or len(response) <= 1:
        return "ã¯ã„"
    else:
        return response
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
# æå‡º
```

---The following area is a Code cell (cell numver is 5)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 6)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# ãƒ‡ãƒãƒƒã‚°
```

---The following area is a Code cell (cell numver is 8)---
```python
# from kaggle_environments import make

# def simple_agent(obs, cfg):
#     if obs.turnType == "ask":
#         response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
#     elif obs.turnType == "guess":
#         response = "ã‚¢ãƒ’ãƒ«"
#     elif obs.turnType == "answer":
#         response = "ã„ã„ãˆ"
#     return response


# debug_config = {'episodeSteps': 61,
#                 'actTimeout': 60,      
#                 'runTimeout': 1200,    
#                 'agentTimeout': 3600}  

# ç’°å¢ƒã‚’ä½œæˆã—ã¾ã™
# env = make(environment="llm_20_questions", configuration=debug_config, debug=True)


# ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™
# game_output = env.run(agents=[agent_fn, simple_agent, simple_agent, simple_agent])

# å®Ÿè¡Œçµæœã‚’è¡¨ç¤ºã—ã¾ã™
# env.render(mode="ipython", width=1080, height=700)
```

** @@@ Jupyter Notebook numver 32, the number of votes :6 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ãƒ»å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹éš›ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
- ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã«ãŠã„ã¦ã€è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåŠ¹æœçš„ã«è³ªå•ã‚’è¡Œã„ã€å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã¨ã„ã†å½¢ã§å¿œç­”ã™ã‚‹ã“ã¨ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ¨æ¸¬ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **TPU/GPUç’°å¢ƒã®è¨­å®š**: 
   - TPUã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šãŒè¡Œã‚ã‚Œã¦ãŠã‚Šã€TPUãƒ‡ãƒã‚¤ã‚¹ã«åˆã‚ã›ãŸãƒ†ãƒ³ã‚½ãƒ«è¨­å®šãŒæ–½ã•ã‚Œã¦ã„ã¾ã™ã€‚
   - `pytorch-xla`ã«é–¢é€£ã™ã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒè¡Œã‚ã‚Œã¦ãŠã‚Šã€`torch`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

2. **Gemma ãƒ¢ãƒ‡ãƒ«ã®åˆ©ç”¨**:
   - `gemma_pytorch`ã¨ã„ã†ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰Gemmaãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚„è¨­å®šã‚’å–å¾—ã—ã€ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯å› æœç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚
   - `GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ã‚’ç”¨ã„ã¦ã€ç‰¹å®šã®ã‚³ãƒ³ãƒ•ã‚£ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…**:
   - è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`GemmaQuestionerAgent`) ã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`GemmaAnswererAgent`) ãŒãã‚Œãã‚Œç‹¬è‡ªã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã£ã¦å®Ÿè£…ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚
   - è³ªå•ã¨å›ç­”ã‚’ã‚¤ãƒ³ã‚¿ãƒªãƒ¼ãƒ–ã™ã‚‹æ©Ÿèƒ½ã‚„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸºã¥ã„ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãŸã‚ã® `GemmaFormatter` ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

4. **ç’°å¢ƒã®æ§‹ç¯‰ã¨ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤**:
   - Kaggleã®ç’°å¢ƒ (`kaggle_environments`)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€å®Ÿéš›ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç›¸äº’ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ãŒå¯èƒ½ãªè¨­å®šã¨ãªã£ã¦ã„ã¾ã™ã€‚

5. **æå‡ºã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°**:
   - æœ€çµ‚çš„ã«ã¯ã€ç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æå‡ºã™ã‚‹æº–å‚™ãŒæ•´ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã§ã®é™ã‚‰ã‚ŒãŸè³ªå•æ•°ã§ã®æ¨æ¸¬å•é¡Œã«å¯¾ã™ã‚‹æˆ¦ç•¥çš„ã‹ã¤åŠ¹ç‡çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã—ã¦ã„ã‚‹ã¨ã¨ã‚‚ã«ã€é«˜åº¦ãªè‡ªç„¶è¨€èªå‡¦ç†èƒ½åŠ›ã‚’æ´»ã‹ã—ãŸAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã‚’åæ˜ ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
%%bash
# ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /kaggle/working
# immutabledict ã¨ sentencepiece ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
# gemma_pytorch ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/google/gemma_pytorch.git > /dev/null
# gemma ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir /kaggle/working/submission/lib/gemma/
# gemma_pytorch ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 2)---
```python
# TPUç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
!curl https://raw.githubusercontent.com/pytorch/xla/master/contrib/scripts/env-setup.py -o pytorch-xla-env-setup.py
# å¿…è¦ãªAPTãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
!python pytorch-xla-env-setup.py --apt-packages libomp5 libopenblas-dev
```

---The following area is a Code cell (cell numver is 3)---
```python
# GPUç”¨ã®ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
# device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")

# TPUç”¨ã®ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
device = xm.xla_device()
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«ã‚¿ã‚¤ãƒ—ã‚’è¨­å®š
torch.set_default_tensor_type('torch.FloatTensor')
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile submission/main.py

import torch, itertools, contextlib
import os, sys, re
from typing import Iterable
from pathlib import Path

# Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
    # ã‚¦ã‚§ã‚¤ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/2b-it/2")
else:
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š
    sys.path.insert(0, "/kaggle/working/submission/lib")
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/2b-it/2"

# gemmaã®è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from gemma.config import get_config_for_2b
# gemmaã®ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from gemma.model import GemmaForCausalLM

class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'
    
    def __init__(self, sp: str = None, fse: Iterable = None):
        self._system_prompt = sp
        self._few_shot_examples = fse
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()
    
    def __repr__(self):
        return self._state
    
    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self
    
    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self
    
    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self
    
    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self
    
    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self
    
    def reset(self):
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self
    
    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)

class GemmaAgent:
    def __init__(self, sp=None, fse=None):
        self._device = xm.xla_device()
        self.formatter = GemmaFormatter(sp=sp, fse=fse)
        print("Initializing model")
        model_config = get_config_for_2b()
        model_config.tokenizer = WEIGHTS_PATH + '/tokenizer.model'
        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            model.load_weights(WEIGHTS_PATH + '/gemma-2b-it.ckpt')
            self.model = model.to(self._device).eval()
    
    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response
    
    def _start_session(self, obs: dict):
        raise NotImplementedError
    
    def _call_llm(self, prompt, max_nt=40, **sampler_kwargs):
        # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
        if sampler_kwargs is None:
            sampler_kwargs = {'temperature': 0.8, 'top_p': 0.9, 'top_k': 60,}
        # ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
        response = self.model.generate(
            prompt, device=self._device, output_len=max_nt, **sampler_kwargs,)
        return response

    def _parse_keyword(self, response: str):
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æŠ½å‡º
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None: 
            keyword = ''
        else: 
            keyword = match.group().lower()
        return keyword
    
    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError

def interleave_unequal(x, y):
    # 2ã¤ã®ãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
    return [item for pair in itertools.zip_longest(x, y) for item in pair if item is not None]

class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")
        self.formatter.start_model_turn()
    
    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None: 
                question = "Is it a person?"  # äººã€å ´æ‰€ã€ç‰©ã®ãƒ©ãƒ³ãƒ€ãƒ ãªé¸æŠ
            else: 
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else: 
            raise ValueError("Unknown turn type:", obs.turnType)

class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")
        self.formatter.start_model_turn()
    
    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'

# ã‚²ãƒ¼ãƒ ã®è¨­å®š
sp = "You are playing the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."
fse = [
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]
agent = None

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾—é–¢æ•°
def get_agent(name: str):
    global agent
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(sp=sp, fse=fse,)
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(sp=sp, fse=fse,)
    assert agent is not None, "Agent not initialized."
    return agent

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–¢æ•°
def agent_fn(obs, cfg):
    if obs.turnType == "ask": 
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess": 
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer": 
        response = get_agent('answerer')(obs)
    
    if response is None or len(response) <= 1: 
        return "yes"
    else: 
        return response
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
# ãƒ†ã‚¹ãƒˆ
```

---The following area is a Code cell (cell numver is 6)---
```python
!pip install -q pygame
```

---The following area is a Code cell (cell numver is 7)---
```python
from kaggle_environments import make
# Kaggleç’°å¢ƒã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
env = make("llm_20_questions")
```

---The following area is a Code cell (cell numver is 8)---
```python
# ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
%run submission/main.py
```

---The following area is a Code cell (cell numver is 9)---
```python
#*** ä¿®æ­£ãŒå¿…è¦ ***
#env.run([get_agent('questioner'), "random"])
```

---The following area is a Code cell (cell numver is 10)---
```python
# Kaggleç’°å¢ƒã‚’è¡¨ç¤º
env.render(mode="ipython")
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```

---The following area is a Code cell (cell numver is 12)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 13)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/2b-it/2
```

** @@@ Jupyter Notebook numver 33, the number of votes :5 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€æ¨ç†ã‚²ãƒ¼ãƒ ã€Œ20 Questionsã€ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦ã€ã‚²ãƒ¼ãƒ ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã€è¦–è¦šåŒ–ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸæ¡ä»¶ï¼ˆåˆæœŸå€™è£œæ•°ã‚„è³ªå•ã®å›æ•°ã€å‰Šæ¸›ä¿‚æ•°ï¼‰ã«åŸºã¥ã„ã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’æ±‚ã‚ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŠ¹æœçš„ãªè³ªå•æˆ¦ç•¥ã®é‡è¦æ€§ã‚’æ¢ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### å•é¡Œã¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- **å•é¡Œ**: ã€Œ20 Questionsã€ã‚²ãƒ¼ãƒ ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã€ãã®çµæœã‚’è¦–è¦šåŒ–ã—ã¦ã€è³ªå•æˆ¦ç•¥ã®åŠ¹æœã‚’ç†è§£ã™ã‚‹ã€‚
- **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ã‚²ãƒ¼ãƒ ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã€Pythonã‚’ç”¨ã„ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ç†è«–çš„ãªè¨ˆç®—**: åˆæœŸã®å˜èªå€™è£œæ•°ï¼ˆNï¼‰ã€è³ªå•å›æ•°ï¼ˆkï¼‰ã€ãŠã‚ˆã³å‰Šæ¸›ä¿‚æ•°ï¼ˆrï¼‰ã‚’åˆ©ç”¨ã—ã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å€™è£œå˜èªæ•°ï¼ˆNkï¼‰ã‚„å‹åˆ©ç¢ºç‡ï¼ˆPkï¼‰ã‚’ç®—å‡ºã—ã¾ã™ã€‚
- **å®Ÿè£…**:
  - **Python**: ã‚²ãƒ¼ãƒ ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨è¨ˆç®—å‡¦ç†ã‚’è¡Œã†è¨€èª
  - **matplotlib**: å‹åˆ©ç¢ºç‡ã‚’ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### çµæœã¨è§£é‡ˆ
ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã€å‰Šæ¸›ä¿‚æ•°ãŒå°ã•ã„ã»ã©ï¼ˆã¤ã¾ã‚Šã€å„è³ªå•ã§ã®å€™è£œãŒå¤§ããæ¸›ã‚‹ã»ã©ï¼‰ã€æ—©ã„æ®µéšã§é«˜ã„å‹åˆ©ç¢ºç‡ã«é”ã™ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸã€å‰Šæ¸›ä¿‚æ•°ãŒ1.0ã®å ´åˆã«ã¯å‹åˆ©ç¢ºç‡ãŒã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã€åŠ¹æœçš„ãªè³ªå•ãŒæˆ¦ç•¥ã«ãŠã„ã¦é‡è¦ã§ã‚ã‚‹ã¨çµè«–ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã¾ã¨ã‚
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’é€šã˜ã¦ã€å‹åˆ©ç¢ºç‡ã®åŸºæœ¬çš„ãªè¨ˆç®—æ–¹æ³•ã€Pythonã«ã‚ˆã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã€ãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ã®è¦–è¦šåŒ–ã®æ‰‹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®æ¦‚å¿µã¯ã€ã‚²ãƒ¼ãƒ ç†è«–ã‚„æ©Ÿæ¢°å­¦ç¿’ãªã©ã®åˆ†é‡ã§ã‚‚å¿œç”¨ãŒå¯èƒ½ã§ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# 20Questionsã‚²ãƒ¼ãƒ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå‹åˆ©ç¢ºç‡ã®è¨ˆç®—
```

---The following area is a Markdown cell (cell numver is 2)---
```markdown
## ã¯ã˜ã‚ã«

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€æœ‰åãªæ¨ç†ã‚²ãƒ¼ãƒ ã€Œ20Questionsã€ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚Pythonã‚’ä½¿ç”¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã€ãã®çµæœã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ã¾ã™ã€‚åˆå¿ƒè€…ã®æ–¹ã§ã‚‚ç†è§£ã—ã‚„ã™ã„ã‚ˆã†ã€ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## 20Questionsã‚²ãƒ¼ãƒ ã¨ã¯

20Questionsã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéš ã•ã‚ŒãŸå˜èªã‚’20å•ä»¥å†…ã®è³ªå•ã§å½“ã¦ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚å„è³ªå•ã¯ã€Œã¯ã„ã€ã‹ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹ã‚‚ã®ã«é™å®šã•ã‚Œã¾ã™ã€‚

```mermaid
%%{init:{'theme':'base'}}%%
graph LR
    A[ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹] --> B{â“ è³ªå•ã™ã‚‹}
    B -->|ã¯ã„ğŸ‘/ã„ã„ãˆğŸ‘| C{â±ï¸ 20å•ä»¥å†…?}
    C -->|ã¯ã„ğŸ‘| D{ğŸ¤” å˜èªã‚’æ¨æ¸¬}
    C -->|ã„ã„ãˆğŸ‘| E[ğŸ˜¢ ã‚²ãƒ¼ãƒ çµ‚äº†: è² ã‘]
    D -->|æ­£è§£âœ…| F[ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº†: å‹ã¡]
    D -->|ä¸æ­£è§£âŒ| B
```

## ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦

ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ç•°ãªã‚‹ã€Œå‰Šæ¸›ä¿‚æ•°ã€ã‚’ç”¨ã„ã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚å‰Šæ¸›ä¿‚æ•°ã¯ã€å„è³ªå•å¾Œã«æ®‹ã‚‹å€™è£œå˜èªã®å‰²åˆã‚’è¡¨ã—ã¾ã™ã€‚

## ç¢ºç‡è¨ˆç®—ã®ç†è«–

å‹åˆ©ç¢ºç‡ã®è¨ˆç®—ã«ã¯ã€ä»¥ä¸‹ã®è¦ç´ ãŒé–¢ä¿‚ã—ã¾ã™ï¼š

1. N: åˆæœŸã®å˜èªå€™è£œæ•°
2. k: è³ªå•å›æ•°
3. r: å‰Šæ¸›ä¿‚æ•°ï¼ˆå„è³ªå•å¾Œã«æ®‹ã‚‹å€™è£œå˜èªã®å‰²åˆï¼‰

å„ãƒ©ã‚¦ãƒ³ãƒ‰kã§ã®å˜èªå€™è£œæ•°Nkã¯æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã¾ã™ï¼š

```
Nk = N * (r^k)
```

ãã—ã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å‹åˆ©ç¢ºç‡Pkã¯ï¼š

```
Pk = (1 - P(k-1)) * (1 / Nk)
```

ã“ã“ã§ã€P(k-1)ã¯å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¾ã§ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã§ã™ã€‚

## Pythonã«ã‚ˆã‚‹å®Ÿè£…

ãã‚Œã§ã¯ã€Pythonã‚’ä½¿ã£ã¦ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

ã¾ãšã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 3)---
```python
import matplotlib.pyplot as plt
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚°ãƒ©ãƒ•æç”»ã®ãŸã‚ã«matplotlibãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

### å‹åˆ©ç¢ºç‡ã®è¨ˆç®—

æ¬¡ã«ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
def calculate_win_probabilities(N: int, rounds: int, reduction_factor: float) -> list[float]:
    """
    å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°

    Args:
        N (int): åˆæœŸã®å˜èªå€™è£œæ•°
        rounds (int): è³ªå•ã®ç·æ•°
        reduction_factor (float): å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§å€™è£œæ•°ãŒæ¸›å°‘ã™ã‚‹å‰²åˆ

    Returns:
        list[float]: å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã®ãƒªã‚¹ãƒˆ
    """
    cumulative_probabilities = []  # ç´¯ç©ç¢ºç‡ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
    previous_prob = 0  # å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹åˆ©ç¢ºç‡ã‚’åˆæœŸåŒ–

    for k in range(1, rounds + 1):
        # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å€™è£œæ•°ã‚’è¨ˆç®—
        Nk = N * (reduction_factor ** k)  # å‰Šæ¸›ä¿‚æ•°ã‚’ä¹—ã˜ã¦æ®‹ã‚Šã®å€™è£œæ•°ã‚’è¨ˆç®—
        # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—
        current_prob = (1 - previous_prob) * (1 / Nk)  # ç¾åœ¨ã®å‹åˆ©ç¢ºç‡ã‚’ç®—å‡º
        # ç´¯ç©ç¢ºç‡ã‚’æ›´æ–°
        previous_prob += current_prob  # ç´¯ç©ç¢ºç‡ã‚’æ›´æ–°
        if previous_prob > 1:
            previous_prob = 1  # å‹åˆ©ç¢ºç‡ãŒ1ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        cumulative_probabilities.append(previous_prob)  # è¨ˆç®—ã—ãŸå‹åˆ©ç¢ºç‡ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 

    return cumulative_probabilities  # çµæœã®ãƒªã‚¹ãƒˆã‚’è¿”ã™
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
ã“ã®é–¢æ•°ã¯ã€åˆæœŸå€™è£œæ•°ã€ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã€å‰Šæ¸›ä¿‚æ•°ã‚’å—ã‘å–ã‚Šã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç´¯ç©å‹åˆ©ç¢ºç‡ã‚’è¨ˆç®—ã—ã¦è¿”ã—ã¾ã™ã€‚

### ç¢ºç‡ã®ãƒ—ãƒ­ãƒƒãƒˆ

è¨ˆç®—ã—ãŸç¢ºç‡ã‚’ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
def plot_cumulative_probabilities(probabilities_dict: dict[float, list[float]]):
    """
    Plot the cumulative winning probabilities

    Args:
        probabilities_dict (dict[float, list[float]): 
            Dictionary of cumulative winning probabilities for each reduction factor
    """
    plt.figure(figsize=(12, 8))  # ã‚°ãƒ©ãƒ•ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
    
    for reduction_factor, probabilities in probabilities_dict.items():
        rounds = range(1, len(probabilities) + 1)  # å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®æ•°ã‚’å–å¾—
        plt.plot(rounds, probabilities, marker='o', linestyle='-', 
                 label=f'Reduction Factor = {reduction_factor}')  # å‹ç‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆ

    # Graph settings
    plt.xlabel('Round')  # Xè»¸ã®ãƒ©ãƒ™ãƒ«
    plt.ylabel('Cumulative Winning Probability')  # Yè»¸ã®ãƒ©ãƒ™ãƒ«
    plt.title('Cumulative Winning Probability per Round for Different Reduction Factors')  # ã‚°ãƒ©ãƒ•ã®ã‚¿ã‚¤ãƒˆãƒ«
    plt.grid(True)  # ã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤º
    plt.xticks(range(1, 21))  # Xè»¸ã®ç›®ç››ã‚Š
    plt.yticks([i/10 for i in range(11)])  # Yè»¸ã®ç›®ç››ã‚Š
    plt.ylim(0, 1)  # Yè»¸ã®ç¯„å›²ã‚’0ã‹ã‚‰1ã«è¨­å®š
    plt.legend()  # å‡¡ä¾‹ã‚’è¡¨ç¤º
    plt.show()  # ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
ã“ã®é–¢æ•°ã¯ã€ç•°ãªã‚‹å‰Šæ¸›ä¿‚æ•°ã§ã®ç¢ºç‡ã‚’ã¾ã¨ã‚ã¦ãƒ—ãƒ­ãƒƒãƒˆã—ã¾ã™ã€‚

### ãƒ¡ã‚¤ãƒ³é–¢æ•°

æœ€å¾Œã«ã€ã™ã¹ã¦ã®å‡¦ç†ã‚’çµ±åˆã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
def main():
    N = 1024  # åˆæœŸã®å˜èªå€™è£œæ•°
    rounds = 20  # è³ªå•ã®ç·æ•°
    reduction_factors = [0.5, 0.6, 0.7, 0.8, 0.9, 1.0]  # ç•°ãªã‚‹å‰Šæ¸›ä¿‚æ•°
    probabilities_dict = {}  # ç¢ºç‡ã‚’æ ¼ç´ã™ã‚‹è¾æ›¸

    for reduction_factor in reduction_factors:
        # å„å‰Šæ¸›ä¿‚æ•°ã§ã®ç¢ºç‡ã‚’è¨ˆç®—
        probabilities = calculate_win_probabilities(N, rounds, reduction_factor)  # å‹ç‡ã‚’è¨ˆç®—
        probabilities_dict[reduction_factor] = probabilities  # è¾æ›¸ã«çµæœã‚’ä¿å­˜
        # çµæœã‚’è¡¨ç¤º
        for i, prob in enumerate(probabilities, 1):  # ç¢ºç‡ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
            print(f"å‰Šæ¸›ä¿‚æ•° {reduction_factor}, ãƒ©ã‚¦ãƒ³ãƒ‰ {i}: ç´¯ç©å‹åˆ©ç¢ºç‡ = {prob:.10f}")

    # çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆ
    plot_cumulative_probabilities(probabilities_dict)  # å‹ç‡ã‚’ã‚°ãƒ©ãƒ•åŒ–

if __name__ == "__main__":
    main()  # ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚’å®Ÿè¡Œ
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
ã“ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°ã¯ã€ç•°ãªã‚‹å‰Šæ¸›ä¿‚æ•°ã§ã®ç¢ºç‡ã‚’è¨ˆç®—ã—ã€çµæœã‚’è¡¨ç¤ºã—ã¦ã‚°ãƒ©ãƒ•åŒ–ã—ã¾ã™ã€‚

## çµæœã®è§£é‡ˆ

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã€ä»¥ä¸‹ã®ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ï¼š

1. å‰Šæ¸›ä¿‚æ•°ãŒå°ã•ã„ã»ã©ï¼ˆå„è³ªå•ã§å€™è£œãŒå¤§ããæ¸›ã‚‹ã»ã©ï¼‰ã€æ—©ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã§é«˜ã„å‹åˆ©ç¢ºç‡ã«é”ã—ã¾ã™ã€‚
2. å‰Šæ¸›ä¿‚æ•°ãŒ1.0ã®å ´åˆï¼ˆè³ªå•ãŒåŠ¹æœçš„ã§ãªã„å ´åˆï¼‰ã€å‹åˆ©ç¢ºç‡ã¯ã»ã¨ã‚“ã©ä¸ŠãŒã‚Šã¾ã›ã‚“ã€‚
3. å¤šãã®å ´åˆã€20ãƒ©ã‚¦ãƒ³ãƒ‰ä»¥å†…ã§å‹åˆ©ç¢ºç‡ãŒéå¸¸ã«é«˜ããªã‚Šã¾ã™ã€‚

ã“ã®çµæœã¯ã€åŠ¹æœçš„ãªè³ªå•æˆ¦ç•¥ã®é‡è¦æ€§ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€20Questionsã‚²ãƒ¼ãƒ ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã®ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸï¼š

1. ç¢ºç‡è¨ˆç®—ã®åŸºæœ¬æ¦‚å¿µ
2. Pythonã‚’ä½¿ç”¨ã—ãŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…æ–¹æ³•
3. matplotlib.pyplotã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã®è¦–è¦šåŒ–
4. çµæœã®è§£é‡ˆã¨å®Ÿéš›ã®ã‚²ãƒ¼ãƒ æˆ¦ç•¥ã¸ã®å¿œç”¨

ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã‚²ãƒ¼ãƒ ç†è«–ã‚„æ©Ÿæ¢°å­¦ç¿’ã®åˆ†é‡ã§ã‚‚å¿œç”¨å¯èƒ½ãªåŸºæœ¬çš„ãªæ¦‚å¿µã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ãœã²ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãŸã‚Šã€æ–°ã—ã„è¦ç´ ã‚’è¿½åŠ ã—ãŸã‚Šã—ã¦ã€ã•ã‚‰ã«æ¢ç©¶ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
```

** @@@ Jupyter Notebook numver 34, the number of votes :5 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã™ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ä½¿ç”¨ã—ã¦è³ªå•-å›ç­”ã‚²ãƒ¼ãƒ ã‚’é€²è¡Œã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ´»ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ä¸ãˆã‚‰ã‚ŒãŸã‚²ãƒ¼ãƒ ã®çŠ¶æ³ã«åŸºã¥ãã€è³ªå•ã‚’ç”Ÿæˆã—ã€ã¾ãŸãã®è³ªå•ã«å¯¾ã™ã‚‹ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ã®å¿œç­”ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’æœ€é€Ÿã§å½“ã¦ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Gemma**: ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯Googleã®`gemma_pytorch`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€å› æœè¨€èªãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã¨æ¨è«–ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚
- **ImmutableDict**ã¨**SentencePiece**: è³ªå•ã¨å›ç­”ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ã«`immutabledict`ã¨`sentencepiece`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚`immutabledict`ã¯å¤‰æ›´ä¸å¯ã®è¾æ›¸ã‚’æä¾›ã—ã€`sentencepiece`ã¯ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- **PyTorch**: è¨€èªãƒ¢ãƒ‡ãƒ«ã®å®Ÿè¡Œã«ã¯PyTorchãŒåˆ©ç”¨ã•ã‚Œã¦ãŠã‚Šã€GPUä¸Šã§ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

### ä¸»ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³
1. **ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€`gemma_pytorch`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å«ã‚€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
   
2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©**:
   - `GemmaAgent`ã‚¯ãƒ©ã‚¹ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã‚„ã‚Šå–ã‚Šã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¦å¿œç­”ã‚’å¾—ã‚‹ãŸã‚ã®åŸºæœ¬æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ã€‚
   - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã‚¯ãƒ©ã‚¹ã¯ã€ãã‚Œãã‚Œè³ªå•è€…ã¨å›ç­”è€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¯ãƒ©ã‚¹ã¯å„ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”è§£æã‚’è¡Œã„ã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œ**: 
   - ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã€é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   - å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ï¼‰ã«å¿œã˜ã¦ç•°ãªã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

4. **ãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®ã¨æå‡ºæº–å‚™**: æœ€å¾Œã«ã€ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤ã®tarãƒœãƒ¼ãƒ«ã«åœ§ç¸®ã—ã€Kaggleã¸ã®æå‡ºã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®å®Ÿè¡Œã«å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰æ–¹æ³•ã‚’è©³ç´°ã«èª¬æ˜ã—ã¦ãŠã‚Šã€ã‚³ãƒ¡ãƒ³ãƒˆãŒè±Šå¯Œã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿéš›ã®å®Ÿè£…ã®æ¦‚å¿µã‚’ç†è§£ã—ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
[ã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯](https://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebook)ã‚’é€²ã‚ã‚‹ä¸­ã§ã€ç§ã¯å‹äººã®ChatGPTã¨å…±åŒã§ã“ã®å®Œå…¨ã«æ–‡æ›¸åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã¯100ï¼…åŒã˜ã§ã€å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚³ãƒ¡ãƒ³ãƒˆãŒå½¹ã«ç«‹ã¤ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions**ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å³å´ã®**ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡º**ã¨ã„ã†è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‹ã‚‰*Output*ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦`submission.tar.gz`ã‚’è¦‹ã¤ã‘ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡º**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’å®Œäº†ã•ã›ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
ä¸Šè¨˜ã®ã‚»ãƒ«ã¯ã€å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«`gemma_pytorch`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æº–å‚™ã™ã‚‹ã“ã¨ã§ã€ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®å¿…è¦ãªä¾å­˜é–¢ä¿‚ãŒæå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¾ã™ï¼š

- `%%bash`ã¯Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚»ãƒ«ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã§ã‚ã‚Šã€ã‚»ãƒ«å…¨ä½“ãŒbashã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`%%bash`ä»¥é™ã®ã™ã¹ã¦ã®è¡ŒãŒã€Pythonã‚³ãƒ¼ãƒ‰ã§ã¯ãªãã€ã‚·ã‚§ãƒ«å†…ã§bashã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦è§£é‡ˆã•ã‚Œã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

- `cd /kaggle/working`ã¯ã€ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’`/kaggle/working`ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯Kaggleç’°å¢ƒå†…ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚ã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ãŸã‚Šã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨­å®šã—ãŸã‚Šã§ãã¾ã™ã€‚

- `pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece`ã¯ã€`immutabledict`ãŠã‚ˆã³`sentencepiece` Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
   - `-q`ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã®å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã¾ã™ï¼ˆã‚¯ãƒ¯ã‚¤ã‚¨ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚
   - `-U`ã¯ã€ã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
   - `-t /kaggle/working/submission/lib`ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¾å­˜é–¢ä¿‚ãŒæå‡ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- `git clone https://github.com/google/gemma_pytorch.git > /dev/null`ã¯ã€GitHubã‹ã‚‰ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`/kaggle/working`ï¼‰ã«[`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/google/gemma_pytorch)ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
   - `> /dev/null`ã¯`git clone`ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’`/dev/null`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€å®Ÿè³ªçš„ã«ãã®å‡ºåŠ›ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ã‹ã‚‰éš ã—ã¾ã™ã€‚`/dev/null`ã¯ã€Unixç³»ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ç‰¹åˆ¥ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ã¨æ¨ã¦ã‚‰ã‚Œã€å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ã‚’æ•´ç†ã—ã¦ä¸å¿…è¦ãªè©³ç´°ã‚’é¿ã‘ã‚‹æ–¹æ³•ã§ã™ã€‚

- `mkdir /kaggle/working/submission/lib/gemma/`ã¯ã€`submission/lib`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«`gemma`ã¨ã„ã†åå‰ã®æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

- `mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/`ã¯ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸ`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã®`gemma`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€æ–°ã—ãä½œæˆã—ãŸ`submission/lib/gemma/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒæå‡ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ï¼š

**immutabledict**ã¯ã€å¤‰æ›´ä¸å¯ã®è¾æ›¸ã‚’æä¾›ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚å¤‰æ›´ä¸å¯ã®è¾æ›¸ã¯ã€ä½œæˆå¾Œã«è¾æ›¸ãŒå¤‰æ›´ã•ã‚Œãªã„ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ãã«ä¾¿åˆ©ã§ã™ã€‚ã“ã‚Œã¯ã€ç‰¹ã«æ§‹æˆã€å®šæ•°ã€ã¾ãŸã¯ä¸¦è¡Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ä½œæ¥­ã™ã‚‹éš›ã«é‡è¦ã§ã™ã€‚

**sentencepiece**ã¯ã€gemmaã®ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile submission/main.py
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’ã“ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

# ãƒ†ãƒ³ã‚½ãƒ«æ“ä½œã¨ãƒ¢ãƒ‡ãƒ«è¨­å®šã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

# ãƒ¢ãƒ‡ãƒ«ã‚¦ã‚§ã‚¤ãƒˆã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒKaggleã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
if os.path.exists(KAGGLE_AGENT_PATH):
    # Kaggleã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¦ã‚§ã‚¤ãƒˆãƒ‘ã‚¹ã‚’é©åˆ‡ã«è¨­å®šã—ã¾ã™ã€‚
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    # ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯åˆ¥ã®ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable


class GemmaFormatter:
    """
    20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å¿œç­”ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã€‚
    """
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        """
        ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å°‘æ•°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ç”¨ã—ã¦GemmaFormatterã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
        
        Args:
            system_prompt (str): ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
            few_shot_examples (Iterable): ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã®ä¾‹ã€‚
        """
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        """
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã—ã¾ã™ã€‚
        
        Returns:
            str: ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã€‚
        """
        return self._state

    def user(self, prompt):
        """
        ç¾åœ¨ã®çŠ¶æ…‹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
        
        Args:
            prompt (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state += self._turn_user.format(prompt)
        return self

    def model(self, prompt):
        """
        ç¾åœ¨ã®çŠ¶æ…‹ã«ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
        
        Args:
            prompt (str): ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state += self._turn_model.format(prompt)
        return self

    def start_user_turn(self):
        """
        æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state += f"{self._start_token}user\n"
        return self

    def start_model_turn(self):
        """
        æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state += f"{self._start_token}model\n"
        return self

    def end_turn(self):
        """
        ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state += f"{self._end_token}\n"
        return self

    def reset(self):
        """
        ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
        æä¾›ã•ã‚ŒãŸå ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å°‘æ•°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚‚å«ã¿ã¾ã™ã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        """
        ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã«ä¸€é€£ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¾ã™ã€‚
        
        Args:
            turns (Iterable): é©ç”¨ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã€‚
            start_agent (str): 'user'ã¾ãŸã¯'model'ã®ã©ã¡ã‚‰ãŒæœ€åˆã«é–‹å§‹ã•ã‚Œã‚‹ã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
        
        Returns:
            self: GemmaFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        """
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©
import re


@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """
    PyTorchã«ãŠã‘ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã€‚

    ã“ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã¯ã€ä¸€æ™‚çš„ã«æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®šã—ã€
    ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠœã‘ã‚‹ã¨å…ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã«æˆ»ã—ã¾ã™ã€‚

    Args:
        dtype (torch.dtype): è¨­å®šã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã€‚

    Yields:
        None
    """
    # æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚
    torch.set_default_dtype(dtype)
    yield
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’floatã«æˆ»ã—ã¾ã™
    torch.set_default_dtype(torch.float)


class GemmaAgent:
    """
    Gemmaè¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºæœ¬ã‚¯ãƒ©ã‚¹ã€‚
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€å¿œç­”ã®ç”Ÿæˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
    """
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        """
        æŒ‡å®šã•ã‚ŒãŸè¨­å®šã§GemmaAgentã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

        Args:
            variant (str): ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ãƒãƒªã‚¢ãƒ³ãƒˆï¼ˆä¾‹ï¼š'7b-it-quant'ï¼‰ã€‚
            device (str): ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ï¼ˆä¾‹ï¼š'cuda:0'ã¯GPUï¼‰ã€‚
            system_prompt (str): ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
            few_shot_examples (Iterable): ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã®ä¾‹ã€‚
        """
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        # ãƒãƒªã‚¢ãƒ³ãƒˆã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’å–å¾—
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®šã—ã€ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()

    def __call__(self, obs, *args):
        """
        æ–°ã—ã„è¦³å¯Ÿã‚’æ‰±ã„ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€å¿œç­”ã‚’è§£æã—ã¾ã™ã€‚

        Args:
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
            *args: è¿½åŠ ã®å¼•æ•°ã€‚

        Returns:
            str: ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã€‚
        """
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        """
        ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚

        Args:
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚

        Raises:
            NotImplementedError: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã«ã‚ˆã£ã¦å®Ÿè£…ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        """
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        """
        æä¾›ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦è¨€èªãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

        Args:
            prompt (str): è¨€èªãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚
            max_new_tokens (int): ç”Ÿæˆã™ã‚‹æœ€å¤§æ–°ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã€‚
            **sampler_kwargs: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã«å¯¾ã™ã‚‹è¿½åŠ ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã€‚

        Returns:
            str: ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã€‚
        """
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        """
        ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

        Args:
            response (str): ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã€‚

        Returns:
            str: æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºã®æ–‡å­—åˆ—ã€‚
        """
        # ãƒ€ãƒ–ãƒ«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ï¼ˆ**ï¼‰ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†æ–‡å­—åˆ—ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword

    def _parse_response(self, response: str, obs: dict):
        """
        è¦³å¯Ÿã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’è§£æã—ã¾ã™ã€‚

        Args:
            response (str): ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã€‚
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚

        Raises:
            NotImplementedError: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã«ã‚ˆã£ã¦å®Ÿè£…ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        """
        raise NotImplementedError


def interleave_unequal(x, y):
    """
    2ã¤ã®ãƒªã‚¹ãƒˆxã¨yã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã—ã€æ¬ æå€¤ã®ãŸã‚ã«Noneã§åŸ‹ã‚ã¾ã™ã€‚
    
    ã“ã®é–¢æ•°ã¯ã€2ã¤ã®ãƒªã‚¹ãƒˆã®è¦ç´ ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã—ã¾ã™ã€‚ãƒªã‚¹ãƒˆã®é•·ã•ãŒç•°ãªã‚‹å ´åˆã¯ã€
    æ¬ æå€¤ã®ãŸã‚ã«Noneã‚’ä½¿ç”¨ã—ã€æœ€çµ‚çµæœã‹ã‚‰ã“ã‚Œã‚‰ã®Noneå€¤ã‚’é™¤å¤–ã—ã¾ã™ã€‚

    Args:
        x (list): ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã™ã‚‹æœ€åˆã®ãƒªã‚¹ãƒˆã€‚
        y (list): ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã™ã‚‹2ç•ªç›®ã®ãƒªã‚¹ãƒˆã€‚

    Returns:
        list: Noneå€¤ã‚’é™¤å¤–ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã•ã‚ŒãŸxã¨yã®è¦ç´ ã‚’æŒã¤ãƒªã‚¹ãƒˆã€‚
    
    ä¾‹:
        >>> interleave_unequal([1, 2, 3], ['a', 'b'])
        [1, 'a', 2, 'b', 3]
    """
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    """
    20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã™ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚
    
    ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ãƒˆã«åŸºã¥ã„ã¦è³ªå•ã‚’ç”Ÿæˆã—ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦
    è³ªå•ãƒ—ãƒ­ã‚»ã‚¹ã‚’é€²ã‚ã¾ã™ã€‚
    """
    def __init__(self, *args, **kwargs):
        """
        æä¾›ã•ã‚ŒãŸå¼•æ•°ã§GemmaQuestionerAgentã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
        
        Args:
            *args: åŸºæœ¬ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å­ã«æ¸¡ã™ä½ç½®å¼•æ•°ã€‚
            **kwargs: åŸºæœ¬ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å­ã«æ¸¡ã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã€‚
        """
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        """
        è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€
        åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä»¥å‰ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¾ã™ã€‚
        
        Args:
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
                - obs.questions (list): ä»¥å‰ã«ã—ãŸè³ªå•ã®ãƒªã‚¹ãƒˆã€‚
                - obs.answers (list): å—ã‘å–ã£ãŸå¯¾å¿œã™ã‚‹å›ç­”ã®ãƒªã‚¹ãƒˆã€‚
                - obs.turnType (str): ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ï¼ˆ'ask'ã¾ãŸã¯'guess'ï¼‰ã€‚
        """
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ä»Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ¨æ¸¬ã¯ãƒ€ãƒ–ãƒ«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        """
        ã‚²ãƒ¼ãƒ ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’è§£æã—ã¾ã™ã€‚
        
        Args:
            response (str): è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã€‚
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
                - obs.turnType (str): ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ï¼ˆ'ask'ã¾ãŸã¯'guess'ï¼‰ã€‚
        
        Returns:
            str: ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦è§£æã•ã‚ŒãŸè³ªå•ã¾ãŸã¯æ¨æ¸¬ã€‚
        
        Raises:
            ValueError: è¦³å¯Ÿå†…ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ãŒä¸æ˜ã§ã‚ã‚‹å ´åˆã€‚
        """
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)


class GemmaAnswererAgent(GemmaAgent):
    """
    20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã™ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚
    
    ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ãƒˆã«åŸºã¥ã„ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã‚’æä¾›ã—ã€
    è¨€èªãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦å›ç­”ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¶šã‘ã¾ã™ã€‚
    """
    def __init__(self, *args, **kwargs):
        """
        æä¾›ã•ã‚ŒãŸå¼•æ•°ã§GemmaAnswererAgentã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
        
        Args:
            *args: åŸºæœ¬ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å­ã«æ¸¡ã™ä½ç½®å¼•æ•°ã€‚
            **kwargs: åŸºæœ¬ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å­ã«æ¸¡ã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã€‚
        """
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        """
        å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€
        åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä»¥å‰ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¾ã™ã€‚
        
        Args:
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
                - obs.questions (list): ä»¥å‰ã«ã—ãŸè³ªå•ã®ãƒªã‚¹ãƒˆã€‚
                - obs.answers (list): ä¸ãˆã‚‰ã‚ŒãŸå¯¾å¿œã™ã‚‹å›ç­”ã®ãƒªã‚¹ãƒˆã€‚
                - obs.keyword (str): è³ªå•è€…ãŒæ¨æ¸¬ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‚
                - obs.category (str): ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚«ãƒ†ã‚´ãƒªã€‚
        """
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ãã®è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«ã¤ã„ã¦ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã¦ã€å›ç­”ã‚’ãƒ€ãƒ–ãƒ«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        """
        ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’è§£æã—ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
        
        Args:
            response (str): è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã€‚
            obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
        
        Returns:
            str: 'yes'ï¼ˆå›ç­”ã«ã€Œyesã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰ã€ãã‚Œä»¥å¤–ã¯ã€Œnoã€ã€‚
        """
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã®è³ªå•ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ã§ã™ï¼",
]

# **é‡è¦:** å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸€ã¤ã ã‘ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚
# ä¸¡æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None


def get_agent(name: str):
    """
    æä¾›ã•ã‚ŒãŸåå‰ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆè³ªå•è€…ã¾ãŸã¯å›ç­”è€…ï¼‰ã‚’åˆæœŸåŒ–ã—ã¦è¿”ã—ã¾ã™ã€‚
    
    ã“ã®é–¢æ•°ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä¸€ã¤ã ã‘ä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€æä¾›ã•ã‚ŒãŸåå‰ã«åŸºã¥ã„ã¦GemmaQuestionerAgentã¾ãŸã¯GemmaAnswererAgentã®æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
    
    Args:
        name (str): åˆæœŸåŒ–ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åå‰ï¼ˆ'questioner'ã¾ãŸã¯'answerer'ï¼‰ã€‚

    Returns:
        GemmaAgent: GemmaQuestionerAgentã¾ãŸã¯GemmaAnswererAgentã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
    
    Raises:
        AssertionError: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåãŒèªè­˜ã•ã‚Œãªã„å ´åˆã€ã¾ãŸã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ãŸå ´åˆã€‚
    """
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent


def agent_fn(obs, cfg):
    """
   ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã—ã€é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    
    ã“ã®é–¢æ•°ã¯è¦³å¯Ÿå†…ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’èª¿ã¹ã€ãã®å¯¾å¿œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆè³ªå•è€…ã¾ãŸã¯å›ç­”è€…ï¼‰ã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    å¿œç­”ãŒNoneã¾ãŸã¯ç©ºã§ã‚ã‚‹å ´åˆã€"yes"ã‚’è¿”ã—ã¾ã™ã€‚
    
    Args:
        obs (dict): ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’å«ã‚€è¦³å¯Ÿè¾æ›¸ã€‚
            - obs.turnType (str): ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ï¼ˆ'ask'ã€'guess'ã€ã¾ãŸã¯'answer'ï¼‰ã€‚
        cfg (dict): ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­å®šï¼ˆç¾åœ¨ã®å®Ÿè£…ã§ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰ã€‚

    Returns:
        str: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã€ã¾ãŸã¯å¿œç­”ãŒNoneã¾ãŸã¯ç©ºã§ã‚ã‚‹å ´åˆã¯"yes"ã€‚
    """
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    if response is None or len(response) <= 1:
        return "yes"
    else:
        return response
```

---The following area is a Code cell (cell numver is 5)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
ä¸Šè¨˜ã®ã‚»ãƒ«ã¯ã€é«˜é€Ÿåœ§ç¸®ã®ãŸã‚ã®`pigz`ã¨ã€é€²æ—ç›£è¦–ã®ãŸã‚ã®`pv`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š

- **apt install pigz pv**: `pigz`ï¼ˆgzipã®ä¸¦åˆ—å®Ÿè£…ï¼‰ã¨`pv`ï¼ˆãƒ‘ã‚¤ãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ã€ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’é€šã‚‹é€²æ—ã‚’ç›£è¦–å¯èƒ½ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- **> /dev/null**: ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’`/dev/null`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã¦ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ä¿ã¡ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Markdown cell (cell numver is 8)---
```markdown
ä¸Šè¨˜ã®ã‚»ãƒ«ã¯ã€æå‡ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®tarãƒœãƒ¼ãƒ«ï¼ˆ`submission.tar.gz`ï¼‰å†…ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã¾ã™ã€‚ã“ã®tarãƒœãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
   - `/kaggle/working/submission`å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
   - `/kaggle/input`ã‹ã‚‰ã®`gemma/pytorch/7b-it-quant/2`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€‚
   
è©³ç´°ãªå†…è¨³ï¼š
- **--use-compress-program='pigz --fast --recursive | pv'**: åœ§ç¸®ã«`pigz`ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æŒ‡å®šã—ã€è¤‡æ•°ã®CPUã‚³ã‚¢ã‚’åˆ©ç”¨ã—ã¦ãƒ—ãƒ­ã‚»ã‚¹ã‚’é«˜é€ŸåŒ–ã—ã¾ã™ã€‚`--fast`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯è¿…é€Ÿãªåœ§ç¸®ã‚’ä¿è¨¼ã—ã€`--recursive`ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‡¦ç†ã—ã¾ã™ã€‚å‡ºåŠ›ã¯`pv`ã‚’é€šã—ã¦ãƒ‘ã‚¤ãƒ—ã•ã‚Œã€é€²æ—ã‚’ç›£è¦–ã—ã¾ã™ã€‚
- **-cf submission.tar.gz**: `submission.tar.gz`ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
- **-C /kaggle/working/submission**: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹å‰ã«ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’`/kaggle/working/submission`ã«å¤‰æ›´ã—ã¾ã™ã€‚
- **.**: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®`-C`ã«ã‚ˆã£ã¦`/kaggle/working/submission`ã«ãªã£ã¦ã„ã¾ã™ï¼‰ã‹ã‚‰ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã—ã¾ã™ã€‚
- **-C /kaggle/input/**: ã‚ˆã‚Šå¤šãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹å‰ã«ã€`/kaggle/input/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã—ã¾ã™ã€‚
- **gemma/pytorch/7b-it-quant/2**: `/kaggle/input/`ã‹ã‚‰`gemma/pytorch/7b-it-quant/2`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãã®å†…å®¹ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã—ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 35, the number of votes :5 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
### ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®è¦ç´„

ã“ã®Jupyter Notebookã¯ã€Kaggleç«¶æŠ€ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®å®Ÿè£…ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ãƒãƒ¼ãƒ ã¯ã€ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã€åŠ¹æœçš„ãªè³ªå•ã‚’é€šã˜ã¦å˜èªã®ç‰¹å®šã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

#### å•é¡Œã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸»ãªç„¦ç‚¹ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€æˆ¦ç•¥çš„ã‹ã¤åŠ¹ç‡çš„ã«è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å‡¦ç†ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€æ¼”ç¹¹çš„æ¨è«–ã¨å”åŠ›ã«åŸºã¥ãæƒ…å ±åé›†ã®èƒ½åŠ›ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚

#### ä½¿ç”¨ã•ã‚Œã‚‹æŠ€è¡“ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Pandasã¨NumPy**: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨æ•°å€¤è¨ˆç®—ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
2. **Kerasã¨Keras NLP**: æ·±å±¤å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã€è‡ªç„¶è¨€èªå‡¦ç†ï¼ˆNLPï¼‰ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. **GemmaCausalLM**: Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã§ã€ã‚²ãƒ¼ãƒ ã®è³ªå•ã‚„å¿œç­”ç”Ÿæˆã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

#### ä¸»ãªæ‰‹æ³•
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†**: ã€ŒKEYWORDS_JSONã€ã‚’åˆ©ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã«å¿…è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–**: Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã€æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹é€ **: ã€ŒAgentã€ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã€è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å—ã‘å–ã‚‹æ©Ÿèƒ½ã‚’æŒã¡ã€çŸ¥è­˜ã‚’è“„ç©ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã€‚

#### çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€LLMãŒåŠ¹ç‡ã‚ˆãæƒ…å ±ã‚’åé›†ã—ã€è«–ç†çš„ãªæ¨è«–ã‚’è¡Œã†èƒ½åŠ›ãŒè©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
## LLM 20 Questions

# èª¬æ˜

ãã‚Œã¯äººã€å ´æ‰€ã€ãã‚Œã¨ã‚‚ç‰©ã§ã™ã‹ï¼Ÿãã‚Œã¯ãƒ‘ãƒ³ç®±ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿãã‚Œã¯70Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿ

ã€Œ20ã®è³ªå•ã€ã¯ã€ç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹å¤ãã‹ã‚‰ã‚ã‚‹æ¨ç†ã‚²ãƒ¼ãƒ ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸€èˆ¬çš„ãªè³ªå•ã‹ã‚‰å…·ä½“çš„ãªè³ªå•ã¸ã¨çµã‚Šè¾¼ã¿ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§å˜èªã‚’æ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

å„ãƒãƒ¼ãƒ ã¯ã€è³ªå•ã‚’ã—æ¨æ¸¬ã‚’è¡Œã†ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã¨ç­”ãˆã‚‹ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æˆ¦ç•¥çš„ãªè³ªå•ã¨å›ç­”ã‚’é€šã˜ã¦ã€æ¨æ¸¬è€…ãŒã§ãã‚‹ã ã‘å°‘ãªã„ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ­£ã—ã„å˜èªã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€LLMãŒæ¼”ç¹¹çš„æ¨è«–ã€çš„ã‚’çµã£ãŸè³ªå•ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã€ãƒšã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”åŠ›ã¨ã„ã£ãŸé‡è¦ãªã‚¹ã‚­ãƒ«ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€é™ã‚‰ã‚ŒãŸæ¨æ¸¬å›æ•°ã®ä¸­ã§å‰µé€ æ€§ã¨æˆ¦ç•¥ã‚’å¿…è¦ã¨ã™ã‚‹åˆ¶ç´„ã®ã‚ã‚‹è¨­å®šãŒç‰¹å¾´ã§ã™ã€‚æˆåŠŸã™ã‚Œã°ã€LLMã¯å˜ã«è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ãªãã€æ´å¯Ÿã«å¯Œã‚“ã è³ªå•ã‚’ã—ã€è«–ç†çš„æ¨è«–ã‚’è¡Œã„ã€å¯èƒ½æ€§ã‚’è¿…é€Ÿã«çµã‚Šè¾¼ã‚€èƒ½åŠ›ã‚’å®Ÿè¨¼ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
import pandas as pd  # pandasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import numpy as np  # NumPyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ•°å€¤è¨ˆç®—ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
from llm_20_questions.keywords import KEYWORDS_JSON  # KEYWORDS_JSONã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
import keras  # Kerasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ·±å±¤å­¦ç¿’ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import keras_nlp  # Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚NLPã‚¿ã‚¹ã‚¯ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 3)---
```python
keywords = eval(KEYWORDS_JSON)  # KEYWORDS_JSONã‚’è©•ä¾¡ã—ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import os  # osãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

os.environ["KERAS_BACKEND"] = "tensorflow"  # Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
gemma_lm = keras_nlp.models.GemmaCausalLM.from_preset("gemma_2b_en")  # GemmaCausalLMãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
gemma_lm.summary()  # ãƒ¢ãƒ‡ãƒ«ã®æ¦‚è¦ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
gemma_lm.generate(KEYWORDS_JSON, max_length=20)  # KEYWORDS_JSONã«åŸºã¥ãã€æœ€å¤§20ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
promt = """
    ã“ã‚“ã«ã¡ã¯ã€‚ä»Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ç§ã®æŒã£ã¦ã„ã‚‹å˜èªã‚’ã‚ãªãŸã¯æ¨æ¸¬ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
    ç§ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã ã‘ã§ãŠç­”ãˆã—ã¾ã™ã€‚ã•ã‚ã€è³ªå•ã—ã¦ãã ã•ã„ã€‚
    """  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
gemma_lm.generate(promt, max_length=15)  # è¨­å®šã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ãã€æœ€å¤§15ãƒˆãƒ¼ã‚¯ãƒ³ã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
class Agent:  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
    def __init__(self):
        self.gemma = gemma_lm  # Gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
        self.knowledge = []  # çŸ¥è­˜ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

    def ask_question(self, question):
        self.knowledge.append(question)  # è³ªå•ã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        response = self.gemma.generate(question)  # Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
        return response  # å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚

    def receive_answer(self, answer):
        self.knowledge.append(answer)  # ç­”ãˆã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        # å¿…è¦ã«å¿œã˜ã¦ç­”ãˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
        pass  # ç¾åœ¨ã¯å‡¦ç†ã›ãšã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 36, the number of votes :5 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å‘ã‘ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸»ãªç›®çš„ã¯ã€20ã®è³ªå•å½¢å¼ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰ã¨ã€æœ€çµ‚çš„ãªæå‡ºç‰©ï¼ˆ`submission.tar.gz`ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã§ã¯ã€ã‚ã‚‹è¨€è‘‰ã‚’å½“ã¦ã‚‹ãŸã‚ã«é™ã‚‰ã‚ŒãŸè³ªå•ã¸ã®ç­”ãˆï¼ˆã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ï¼‰ã«åŸºã¥ã„ã¦ã€æƒ…å ±ã‚’åé›†ã—ã€æœ€çµ‚çš„ã«ãã®è¨€è‘‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æ‹…ã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹ã“ã¨ãŒæ ¸å¿ƒã§ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•
1. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ**: `Gemma`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€äºˆã‚å®šç¾©ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ä¾‹ã‚’ç”¨ã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ãƒ¼ãƒ³ã”ã¨ã«è‡ªç„¶ãªå¯¾è©±ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

2. **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°**: `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã®å¯¾è©±ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚„ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’é©åˆ‡ã«ç®¡ç†ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®é–‹å§‹ãƒ»çµ‚äº†ãƒãƒ¼ã‚«ãƒ¼ã‚‚å«ã¾ã‚Œã¾ã™ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®Ÿè£…**: `GemmaQuestionerAgent`ãŠã‚ˆã³`GemmaAnswererAgent`ã®äºŒã¤ã®ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã€ãã‚Œãã‚Œè³ªå•ã‚’è¡Œã†ãŸã‚ãƒ»å¿œç­”ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

4. **ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–**: PyTorchã‚’åˆ©ç”¨ã—ã¦ã€Gemmaãƒ¢ãƒ‡ãƒ«ã®æ§‹æˆã‚’å–å¾—ã—ã€ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹æº–å‚™ã‚’æ•´ãˆã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **PyTorch**: ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰ã‚„å­¦ç¿’ã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã€‚
- **Gemma**: ç‰¹ã«è¨€èªãƒ¢ãƒ‡ãƒ«ç”¨ã«è¨­è¨ˆã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªå¿œç­”ç”Ÿæˆã«ç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚
- **sentencepiece**: ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ç”¨ã„ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆã®å‰å‡¦ç†ã‚’æ”¯æ´ã—ã¾ã™ã€‚
- **immutabledict**: ä¸å¤‰ã®è¾æ›¸ã‚’æä¾›ã—ã€ãƒãƒƒã‚·ãƒ¥å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ”¯æ´ã—ã¾ã™ã€‚

æœ€çµ‚çš„ã«ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ã‚’ç¢ºç«‹ã—ã€ãƒ†ã‚¹ãƒˆå¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ã—ã¦ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’æ•´ãˆã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions**ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã®**ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡º**ã®è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã§ãã¾ã™ã€‚ã¾ãŸã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰*å‡ºåŠ›*ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz`ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã®**Agent Submit**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚-qã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã¾ã™ã€‚
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
# Gemmaã®PyTorchå®Ÿè£…ã‚’GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
git clone https://github.com/google/gemma_pytorch.git > /dev/null
# Gemmaã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
mkdir /kaggle/working/submission/lib/gemma/
# Gemmaã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç§»å‹•ã—ã¾ã™ã€‚
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
import os
import sys

# **é‡è¦:** ã“ã®ã‚ˆã†ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§ã‚³ãƒ¼ãƒ‰ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

# ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚
if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable


class GemmaFormatter:
    _start_token = '<start_of_turn>' # ã‚¿ãƒ¼ãƒ³é–‹å§‹ã®ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>' # ã‚¿ãƒ¼ãƒ³çµ‚äº†ã®ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        return self._state

    def user(self, prompt):
        self._state += self._turn_user.format(prompt) # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt) # ãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n" # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n" # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n" # ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†
        return self

    def reset(self):
        self._state = "" # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        if self._system_prompt is not None:
            self.user(self._system_prompt) # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user') # few-shotä¾‹ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters) # äº¤äº’ã«ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½œæˆ
        for fmt, turn in zip(formatters, turns):
            fmt(turn) # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’é©ç”¨
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©
import re


@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """ä¸ãˆã‚‰ã‚ŒãŸdtypeã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float) # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å…ƒã«æˆ»ã™


class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device) # ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples) # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b() # ãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model") # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant # é‡å­åŒ–ã®è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config) # ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt') # ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path) # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval() # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—ã€è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs) # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹
        prompt = str(self.formatter) # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
        response = self._call_llm(prompt) # LLMã«å‘¼ã³å‡ºã™
        response = self._parse_response(response, obs) # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        response = self.model.generate(
            prompt,
            device=self._device, # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹
            output_len=max_new_tokens, # ç”Ÿæˆã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response) # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower() # å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError


def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ] # ä¸ç­‰é•·ã®ãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµ±åˆã™ã‚‹é–¢æ•°


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs) # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset() # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚") # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers) # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµ±åˆ
        self.formatter.apply_turns(turns, start_agent='model') # éå»ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚") # è³ªå•æ™‚
        elif obs.turnType == 'guess':
            self.formatter.user("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ¨æ¸¬ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚") # æ¨æ¸¬æ™‚
        self.formatter.start_model_turn() # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', '')) # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "äººã§ã™ã‹ï¼Ÿ" # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè³ªå•
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response) # æ¨æ¸¬ã‚’è§£æ
            return guess
        else:
            raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType) # ã‚¨ãƒ©ãƒ¼å‡¦ç†


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs) # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset() # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚") # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers) # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµ±åˆ
        self.formatter.apply_turns(turns, start_agent='user') # éå»ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"ã“ã®è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã®ã‚«ãƒ†ã‚´ãƒª{obs.category}ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã€ç­”æ¡ˆã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn() # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response) # å¿œç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no' # yesã¾ãŸã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ€ã„æµ®ã‹ã¹ã€è³ªå•è€…ã®ã¯ã„ã¾ãŸã¯ã„ã„ãˆã®è³ªå•ã«å¯¾ã—ã¦å¿œç­”ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ï¼",
]


# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚ãã†ã™ã‚‹ã“ã¨ã§ã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ï¼‰ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None


def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent


def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs) # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs) # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs) # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
    if response is None or len(response) <= 1:
        return "ã¯ã„" # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response
```

---The following area is a Code cell (cell numver is 4)---
```python
# pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã¾ã™ã€‚
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 5)---
```python
# submissionãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’tar.gzåœ§ç¸®ã—ã¾ã™ã€‚
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

** @@@ Jupyter Notebook numver 37, the number of votes :4 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ä¸»ã«ã€è¨€è‘‰å½“ã¦ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é–‹ç™ºã—ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ã§ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å½“ã¦ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œ
ã“ã®Notebookã§ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€å›ç­”è€…ãŒè€ƒãˆãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦è³ªå•è€…ãŒè³ªå•ã—ã€ãã®è³ªå•ã«åŸºã¥ã„ã¦æ¨æ¸¬ã‚’è¡Œã†ã¨ã„ã†ã‚¿ã‚¹ã‚¯ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’ãƒ¢ãƒ‡ãƒ«ãŒç”Ÿæˆã—ã€é©åˆ‡ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹å½¹å‰²ã‚’æœãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### æ‰‹æ³•
1. **ç’°å¢ƒè¨­å®š**: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`immutabledict`ã€`sentencepiece`ã€`kaggle_environments`ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Gemmaã®PyTorchå®Ÿè£…ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  
2. **ãƒ¢ãƒ‡ãƒ«ã®æ§‹æˆ**: 
    - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
    - æ§‹æˆæƒ…å ±ã«åŸºã¥ã„ã¦Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ç•°ãªã‚‹ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¾‹: "2b"ã€"2b-it"ã€"7b-it-quant"ï¼‰ã§ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

3. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™**: 
    - ã‚²ãƒ¼ãƒ ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„éå»ã®ä¾‹ï¼ˆfew-shot examplesï¼‰ã‚’ç”¨ã„ã¦ã€è³ªå•ã¨å›ç­”ã®ã‚¿ãƒ¼ãƒ³ã‚’æ•´åˆ—ã•ã›ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

4. **å¿œç­”ç”Ÿæˆ**: 
    - ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ã„ã¦ã€è³ªå•ã‚„æ¨æ¸¬ã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

5. **å¿œç­”è§£æ**: 
    - æŠ½å‡ºã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ç”Ÿæˆã—ãŸè³ªå•ã‚’è§£æã—ã€ã‚²ãƒ¼ãƒ ã®æµã‚Œã«å¾“ã£ã¦ç­”ãˆã‚’å°ãå‡ºã—ã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- `kaggle_environments`: Kaggleã®ç«¶æŠ€ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã€‚
- `torch`: PyTorchã‚’åˆ©ç”¨ã—ã¦æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã€‚
- `gemma`: GoogleãŒé–‹ç™ºã—ãŸGemmaãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã‚’ä½¿ç”¨ã€‚

ã“ã®Notebookã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’é€šã˜ã¦æœ‰ç”¨ãªè³ªå•ã‚’ç”Ÿæˆã—ã€è«–ç†çš„ã«æ¨è«–ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ã‚‹èƒ½åŠ›ã‚’è©•ä¾¡ã—ã€æ”¹å–„ã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’ç¯‰ã„ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ç’°å¢ƒã‚’è¨­å®šã™ã‚‹
!pip install -q -U immutabledict sentencepiece 
!pip install -q 'kaggle_environments>=1.14.8'
!git clone https://github.com/google/gemma_pytorch.git
!mkdir /kaggle/working/gemma/
!mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/gemma/
```

---The following area is a Code cell (cell numver is 2)---
```python
import sys 
sys.path.append("/kaggle/working/gemma_pytorch/") 
import contextlib
import os
import torch
import re
import kaggle_environments
import itertools
from gemma.config import GemmaConfig, get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM
from gemma.tokenizer import Tokenizer
from typing import Iterable
```

---The following area is a Code cell (cell numver is 3)---
```python
class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
        self._few_shot_examples = few_shot_examples  # ä¾‹ã‚’ä¿å­˜
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()  # åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # ä¾‹ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’äº¤äº’ã«é©ç”¨
        for fmt, turn in zip(formatters, turns):
            fmt(turn)  # å„ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        return self
```

---The following area is a Code cell (cell numver is 4)---
```python
def load_model(VARIANT, device):
    WEIGHTS_PATH = f'/kaggle/input/gemma/pytorch/{VARIANT}/2' 

    @contextlib.contextmanager
    def _set_default_tensor_type(dtype: torch.dtype):
        """ä¸ãˆã‚‰ã‚ŒãŸdtypeã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torchãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ã¾ã™ã€‚"""
        torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’è¨­å®š
        yield
        torch.set_default_dtype(torch.float)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆdtypeã‚’floatã«æˆ»ã™

    # ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š
    model_config = get_config_for_2b() if "2b" in VARIANT else get_config_for_7b()  # VARIANTã«å¿œã˜ãŸè¨­å®šå–å¾—
    model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
    model_config.quant = "quant" in VARIANT  # é‡å­åŒ–è¨­å®š

    # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
    with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ã‚½ãƒ«å‹ã‚’è¨­å®š
        model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
        ckpt_path = os.path.join(WEIGHTS_PATH, f'gemma-{VARIANT}.ckpt')  # ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹
        model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
        model = model.to(device).eval()  # ãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
        
    return model  # ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
def _parse_keyword(response: str):
    match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡º
    if match is None:
        keyword = ''  # ãƒãƒƒãƒã—ãªã„å ´åˆã¯ç©ºæ–‡å­—
    else:
        keyword = match.group().lower()  # ãƒãƒƒãƒã—ãŸå ´åˆã¯å°æ–‡å­—ã«å¤‰æ›
    return keyword  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 6)---
```python
def _parse_response(response: str, obs: dict):
    if obs['turnType'] == 'ask':
        match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
        if match is None:
            question = "äººã§ã™ã‹ï¼Ÿ"  # ãƒãƒƒãƒã—ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè³ªå•
        else:
            question = match.group()  # è³ªå•ã‚’è¿”ã™
        return question
    elif obs['turnType'] == 'guess':
        guess = _parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        return guess
    else:
        raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs['turnType'])  # ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
```

---The following area is a Code cell (cell numver is 7)---
```python
def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]  # é•·ã•ã®ç•°ãªã‚‹ãƒªã‚¹ãƒˆã‚’äº¤äº’ã«ãƒãƒ¼ã‚¸
```

---The following area is a Code cell (cell numver is 8)---
```python
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã¯ã„ã¾ãŸã¯ã„ã„ãˆã§è³ªå•ã«ç­”ãˆã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯ç‰©ã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ï¼",
]

formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
```

---The following area is a Code cell (cell numver is 9)---
```python
obs = {
    'turnType': 'ask',  # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—
    'questions': [
        'ãã‚Œã¯ç”Ÿãã¦ã„ã‚‹ã‚‚ã®ã§ã™ã‹ï¼Ÿ',
        'äººå·¥çš„ãªã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
        'ç‰‡æ‰‹ã§æŒã¦ã‚‹ã‚‚ã®ã§ã™ã‹ï¼Ÿ'
    ],
    'answers': [
        'ã„ã„ãˆ',
        'ã¯ã„',
        'ã¯ã„'
    ]
}  # è¦³å¯Ÿæƒ…å ±
```

---The following area is a Code cell (cell numver is 10)---
```python
formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆæœŸåŒ–
turns = interleave_unequal(obs['questions'], obs['answers'])  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«æ•´åˆ—
formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
if obs['turnType'] == 'ask':
    formatter.user("ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚")  # è³ªå•ã‚¿ã‚¤ãƒ—ãŒaskã®æ™‚
elif obs['turnType'] == 'guess':
    formatter.user("ä»Šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ãƒ€ãƒ–ãƒ«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")  # è³ªå•ã‚¿ã‚¤ãƒ—ãŒguessã®æ™‚
formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
```

---The following area is a Code cell (cell numver is 11)---
```python
prompt = str(formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
prompt  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 12)---
```python
MACHINE_TYPE = "cuda"  # ä½¿ç”¨ã™ã‚‹æ©Ÿæ¢°ã®ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š
device = torch.device(MACHINE_TYPE)  # ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®š
max_new_tokens = 32  # æœ€å¤§ç”Ÿæˆãƒˆãƒ¼ã‚¯ãƒ³æ•°
sampler_kwargs = {
'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
'top_p': 0.1,  # ç¢ºç‡ã®ãƒˆãƒƒãƒ—pãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
'top_k': 1,  # ãƒˆãƒƒãƒ—kãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
}
```

---The following area is a Markdown cell (cell numver is 13)---
```markdown
# Gemma 2b V2
```

---The following area is a Code cell (cell numver is 14)---
```python
model = load_model("2b", device)  # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰

response = model.generate(
    prompt,
    device=device,
    output_len=max_new_tokens,
    **sampler_kwargs
)  # ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹å¿œç­”ã‚’ç”Ÿæˆ
response = _parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
print(response)  # å¿œç­”ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
# Gemma 2b-it V2
```

---The following area is a Code cell (cell numver is 16)---
```python
model = load_model("2b-it", device)  # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰

response = model.generate(
    prompt,
    device=device,
    output_len=max_new_tokens,
    **sampler_kwargs
)  # ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹å¿œç­”ã‚’ç”Ÿæˆ
response = _parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
print(response)  # å¿œç­”ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 17)---
```markdown
# Gemma 7b-it-quant V2
```

---The following area is a Code cell (cell numver is 18)---
```python
model = load_model("7b-it-quant", device)  # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰

response = model.generate(
    prompt,
    device=device,
    output_len=max_new_tokens,
    **sampler_kwargs
)  # ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹å¿œç­”ã‚’ç”Ÿæˆ
response = _parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
print(response)  # å¿œç­”ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 19)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## dedq
> 
> ã‚³ãƒ¼ãƒ‰ãŒæ˜ç¢ºã§ã€è¿…é€Ÿã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚Kaggleã®ãƒ¡ãƒ³ãƒãƒ¼ã¸ã®æœ€é«˜ã®ä»•äº‹ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼
> 
> 
---
```

** @@@ Jupyter Notebook numver 38, the number of votes :4 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
### ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®è¦ç´„

ã“ã®Jupyter Notebookã¯ã€Kaggleç«¶æŠ€ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®å®Ÿè£…ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ãƒãƒ¼ãƒ ã¯ã€ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã€åŠ¹æœçš„ãªè³ªå•ã‚’é€šã˜ã¦å˜èªã®ç‰¹å®šã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

#### å•é¡Œã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸»ãªç„¦ç‚¹ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€æˆ¦ç•¥çš„ã‹ã¤åŠ¹ç‡çš„ã«è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å‡¦ç†ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€æ¼”ç¹¹çš„æ¨è«–ã¨å”åŠ›ã«åŸºã¥ãæƒ…å ±åé›†ã®èƒ½åŠ›ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚

#### ä½¿ç”¨ã•ã‚Œã‚‹æŠ€è¡“ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Pandasã¨NumPy**: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨æ•°å€¤è¨ˆç®—ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
2. **Kerasã¨Keras NLP**: æ·±å±¤å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã€è‡ªç„¶è¨€èªå‡¦ç†ï¼ˆNLPï¼‰ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. **GemmaCausalLM**: Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã§ã€ã‚²ãƒ¼ãƒ ã®è³ªå•ã‚„å¿œç­”ç”Ÿæˆã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

#### ä¸»ãªæ‰‹æ³•
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†**: ã€ŒKEYWORDS_JSONã€ã‚’åˆ©ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã«å¿…è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–**: Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã€æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹é€ **: ã€ŒAgentã€ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã€è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å—ã‘å–ã‚‹æ©Ÿèƒ½ã‚’æŒã¡ã€çŸ¥è­˜ã‚’è“„ç©ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã€‚

#### çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€LLMãŒåŠ¹ç‡ã‚ˆãæƒ…å ±ã‚’åé›†ã—ã€è«–ç†çš„ãªæ¨è«–ã‚’è¡Œã†èƒ½åŠ›ãŒè©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
## LLM 20 Questions

# èª¬æ˜

ãã‚Œã¯äººã€å ´æ‰€ã€ãã‚Œã¨ã‚‚ç‰©ã§ã™ã‹ï¼Ÿãã‚Œã¯ãƒ‘ãƒ³ç®±ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿãã‚Œã¯70Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿ

ã€Œ20ã®è³ªå•ã€ã¯ã€ç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹å¤ãã‹ã‚‰ã‚ã‚‹æ¨ç†ã‚²ãƒ¼ãƒ ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸€èˆ¬çš„ãªè³ªå•ã‹ã‚‰å…·ä½“çš„ãªè³ªå•ã¸ã¨çµã‚Šè¾¼ã¿ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§å˜èªã‚’æ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

å„ãƒãƒ¼ãƒ ã¯ã€è³ªå•ã‚’ã—æ¨æ¸¬ã‚’è¡Œã†ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã¨ç­”ãˆã‚‹ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æˆ¦ç•¥çš„ãªè³ªå•ã¨å›ç­”ã‚’é€šã˜ã¦ã€æ¨æ¸¬è€…ãŒã§ãã‚‹ã ã‘å°‘ãªã„ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ­£ã—ã„å˜èªã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€LLMãŒæ¼”ç¹¹çš„æ¨è«–ã€çš„ã‚’çµã£ãŸè³ªå•ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã€ãƒšã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”åŠ›ã¨ã„ã£ãŸé‡è¦ãªã‚¹ã‚­ãƒ«ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€é™ã‚‰ã‚ŒãŸæ¨æ¸¬å›æ•°ã®ä¸­ã§å‰µé€ æ€§ã¨æˆ¦ç•¥ã‚’å¿…è¦ã¨ã™ã‚‹åˆ¶ç´„ã®ã‚ã‚‹è¨­å®šãŒç‰¹å¾´ã§ã™ã€‚æˆåŠŸã™ã‚Œã°ã€LLMã¯å˜ã«è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ãªãã€æ´å¯Ÿã«å¯Œã‚“ã è³ªå•ã‚’ã—ã€è«–ç†çš„æ¨è«–ã‚’è¡Œã„ã€å¯èƒ½æ€§ã‚’è¿…é€Ÿã«çµã‚Šè¾¼ã‚€èƒ½åŠ›ã‚’å®Ÿè¨¼ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
import pandas as pd  # pandasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import numpy as np  # NumPyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ•°å€¤è¨ˆç®—ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
from llm_20_questions.keywords import KEYWORDS_JSON  # KEYWORDS_JSONã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
import keras  # Kerasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ·±å±¤å­¦ç¿’ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import keras_nlp  # Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚NLPã‚¿ã‚¹ã‚¯ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 3)---
```python
keywords = eval(KEYWORDS_JSON)  # KEYWORDS_JSONã‚’è©•ä¾¡ã—ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import os  # osãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

os.environ["KERAS_BACKEND"] = "tensorflow"  # Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
gemma_lm = keras_nlp.models.GemmaCausalLM.from_preset("gemma_2b_en")  # GemmaCausalLMãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
gemma_lm.summary()  # ãƒ¢ãƒ‡ãƒ«ã®æ¦‚è¦ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
gemma_lm.generate(KEYWORDS_JSON, max_length=20)  # KEYWORDS_JSONã«åŸºã¥ãã€æœ€å¤§20ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
promt = """
    ã“ã‚“ã«ã¡ã¯ã€‚ä»Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ç§ã®æŒã£ã¦ã„ã‚‹å˜èªã‚’ã‚ãªãŸã¯æ¨æ¸¬ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
    ç§ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã ã‘ã§ãŠç­”ãˆã—ã¾ã™ã€‚ã•ã‚ã€è³ªå•ã—ã¦ãã ã•ã„ã€‚
    """  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
gemma_lm.generate(promt, max_length=15)  # è¨­å®šã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ãã€æœ€å¤§15ãƒˆãƒ¼ã‚¯ãƒ³ã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
class Agent:  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
    def __init__(self):
        self.gemma = gemma_lm  # Gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
        self.knowledge = []  # çŸ¥è­˜ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

    def ask_question(self, question):
        self.knowledge.append(question)  # è³ªå•ã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        response = self.gemma.generate(question)  # Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
        return response  # å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚

    def receive_answer(self, answer):
        self.knowledge.append(answer)  # ç­”ãˆã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        # å¿…è¦ã«å¿œã˜ã¦ç­”ãˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
        pass  # ç¾åœ¨ã¯å‡¦ç†ã›ãšã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 39, the number of votes :4 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ç›®æŒ‡ã™ã®ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’æŒã¤è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ç‰¹ã«è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æ‹…ã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®åˆã‚ã«ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`immutabledict`ã‚„`sentencepiece`ï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€Gemmaï¼ˆGoogleãŒé–‹ç™ºã—ãŸPyTorchã®è¨€èªãƒ¢ãƒ‡ãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼‰ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ã€å¿…è¦ãªæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚ãã®å¾Œã€`main.py`ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¯ãƒ©ã‚¹æ§‹é€ ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ä¸»ãªæ‰‹æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã®è¦ç´ ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

1. **GemmaFormatter**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¨ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’æ•´ç†ã™ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
2. **GemmaAgent**: åŸºæœ¬çš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã§ã€LLMã¨å¯¾è©±ã—ã€ãã®å¿œç­”ã‚’å‡¦ç†ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã¯è³ªå•ã‚’ç”Ÿæˆã—ã€å¿œç­”ã‚’è§£æã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
3. **GemmaQuestionerAgent**ã¨**GemmaAnswererAgent**: è³ªå•è€…ã¨å›ç­”è€…ã®å…·ä½“çš„ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã§ã€ãã‚Œãã‚Œã®å½¹å‰²ã«ç‰¹åŒ–ã—ãŸå¿œç­”å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚è³ªå•è€…ã¯ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”è€…ã¯ä¸ãˆã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§å¿œç­”ã—ã¾ã™ã€‚

ä½¿ç”¨ã—ã¦ã„ã‚‹ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
- **PyTorch**: ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«åˆ©ç”¨ã€‚
- **Gemma**: è¨€èªãƒ¢ãƒ‡ãƒ«ã®ãŸã‚ã®æ§‹æˆã‚„ã‚¯ãƒ©ã‚¹ã‚’å«ã‚€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

æœ€çµ‚çš„ã«ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãª`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ç›´æ¥æå‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€LLMãŒ20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ã©ã®ã‚ˆã†ã«æˆ¦ç•¥çš„ã«ãƒ—ãƒ¬ã‚¤ã—ã€æ¨è«–ã‚’è¡Œã†èƒ½åŠ›ã‚’æŒã¦ã‚‹ã‹ãŒå®Ÿè¨¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€LLM 20 Questionsã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
# ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ç›´æ¥æå‡ºã§ãã‚‹submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

%%bash
# ä½œæ¥­ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir -p /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/

%%writefile submission/main.py
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

import os
import sys
from pathlib import Path
import contextlib
import itertools
from typing import Iterable
import re

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

# ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

# å®šæ•°ã‚’å®šç¾©ã—ã¾ã™
WEIGHTS_PATH = os.path.join(
    KAGGLE_AGENT_PATH if os.path.exists(KAGGLE_AGENT_PATH) else "/kaggle/input",
    "gemma/pytorch/7b-it-quant/2"
)

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ã®ã‚¯ãƒ©ã‚¹
class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        return self._state

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self

    def reset(self):
        self._state = ""
        if self._system_prompt:
            self.user(self._system_prompt)
        if self._few_shot_examples:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®šç¾©
@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å‹ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant

        with _set_default_tensor_type(model_config.get_dtype()):
            self.model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH, f'gemma-{variant}.ckpt')
            self.model.load_weights(ckpt_path)
            self.model.to(self._device).eval()

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        return self._parse_response(response, obs)

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        sampler_kwargs = sampler_kwargs or {
            'temperature': 0.01,
            'top_p': 0.1,
            'top_k': 1,
        }
        return self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        return match.group().lower() if match else ''

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError

def interleave_unequal(x, y):
    return [item for pair in itertools.zip_longest(x, y) for item in pair if item is not None]

class GemmaQuestionerAgent(GemmaAgent):
    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ãƒ»ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("æ¬¡ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ¨æ¸¬ã‚’äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            return match.group() if match else "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
        elif obs.turnType == 'guess':
            return self._parse_keyword(response)

class GemmaAnswererAgent(GemmaAgent):
    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚ã¯ã„ãƒ»ã„ã„ãˆã§ç­”ãˆã€ç­”ãˆã‚’äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã‹ã‚‰ã®ã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã«å¿œç­”ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"
few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ï¼",
]

# ä¸¦è¡Œã—ã¦ä¸¡æ–¹ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¾ãªã„ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤‰æ•°
agent = None

def get_agent(name: str):
    global agent

    if agent is None:
        if name == 'questioner':
            agent = GemmaQuestionerAgent(
                device='cuda:0',
                system_prompt=system_prompt,
                few_shot_examples=few_shot_examples,
            )
        elif name == 'answerer':
            agent = GemmaAnswererAgent(
                device='cuda:0',
                system_prompt=system_prompt,
                few_shot_examples=few_shot_examples,
            )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    return agent

def agent_fn(obs, cfg):
    if obs.turnType in ["ask", "guess"]:
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    return response if response and len(response) > 1 else "ã¯ã„"
```

** @@@ Jupyter Notebook numver 40, the number of votes :4 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
### ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®è¦ç´„

ã“ã®Jupyter Notebookã¯ã€Kaggleç«¶æŠ€ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®å®Ÿè£…ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ãƒãƒ¼ãƒ ã¯ã€ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã€åŠ¹æœçš„ãªè³ªå•ã‚’é€šã˜ã¦å˜èªã®ç‰¹å®šã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

#### å•é¡Œã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸»ãªç„¦ç‚¹ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€æˆ¦ç•¥çš„ã‹ã¤åŠ¹ç‡çš„ã«è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å‡¦ç†ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€æ¼”ç¹¹çš„æ¨è«–ã¨å”åŠ›ã«åŸºã¥ãæƒ…å ±åé›†ã®èƒ½åŠ›ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚

#### ä½¿ç”¨ã•ã‚Œã‚‹æŠ€è¡“ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Pandasã¨NumPy**: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨æ•°å€¤è¨ˆç®—ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
2. **Kerasã¨Keras NLP**: æ·±å±¤å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã€è‡ªç„¶è¨€èªå‡¦ç†ï¼ˆNLPï¼‰ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. **GemmaCausalLM**: Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã§ã€ã‚²ãƒ¼ãƒ ã®è³ªå•ã‚„å¿œç­”ç”Ÿæˆã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

#### ä¸»ãªæ‰‹æ³•
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†**: ã€ŒKEYWORDS_JSONã€ã‚’åˆ©ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã«å¿…è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
- **ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–**: Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã€æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹é€ **: ã€ŒAgentã€ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã€è³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å—ã‘å–ã‚‹æ©Ÿèƒ½ã‚’æŒã¡ã€çŸ¥è­˜ã‚’è“„ç©ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã€‚

#### çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹èƒ½åŠ›ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚çš„ã«ã¯ã€LLMãŒåŠ¹ç‡ã‚ˆãæƒ…å ±ã‚’åé›†ã—ã€è«–ç†çš„ãªæ¨è«–ã‚’è¡Œã†èƒ½åŠ›ãŒè©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
## LLM 20 Questions

# èª¬æ˜

ãã‚Œã¯äººã€å ´æ‰€ã€ãã‚Œã¨ã‚‚ç‰©ã§ã™ã‹ï¼Ÿãã‚Œã¯ãƒ‘ãƒ³ç®±ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿãã‚Œã¯70Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šå°ã•ã„ã§ã™ã‹ï¼Ÿ

ã€Œ20ã®è³ªå•ã€ã¯ã€ç§˜å¯†ã®å˜èªã‚’20ã®è³ªå•ä»¥å†…ã§æ¨æ¸¬ã™ã‚‹å¤ãã‹ã‚‰ã‚ã‚‹æ¨ç†ã‚²ãƒ¼ãƒ ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸€èˆ¬çš„ãªè³ªå•ã‹ã‚‰å…·ä½“çš„ãªè³ªå•ã¸ã¨çµã‚Šè¾¼ã¿ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§å˜èªã‚’æ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

å„ãƒãƒ¼ãƒ ã¯ã€è³ªå•ã‚’ã—æ¨æ¸¬ã‚’è¡Œã†ã€Œæ¨æ¸¬è€…LLMã€ã¨ã€ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã¨ç­”ãˆã‚‹ã€Œå›ç­”è€…LLMã€ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æˆ¦ç•¥çš„ãªè³ªå•ã¨å›ç­”ã‚’é€šã˜ã¦ã€æ¨æ¸¬è€…ãŒã§ãã‚‹ã ã‘å°‘ãªã„ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ­£ã—ã„å˜èªã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€LLMãŒæ¼”ç¹¹çš„æ¨è«–ã€çš„ã‚’çµã£ãŸè³ªå•ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã€ãƒšã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”åŠ›ã¨ã„ã£ãŸé‡è¦ãªã‚¹ã‚­ãƒ«ã‚’è©•ä¾¡ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€é™ã‚‰ã‚ŒãŸæ¨æ¸¬å›æ•°ã®ä¸­ã§å‰µé€ æ€§ã¨æˆ¦ç•¥ã‚’å¿…è¦ã¨ã™ã‚‹åˆ¶ç´„ã®ã‚ã‚‹è¨­å®šãŒç‰¹å¾´ã§ã™ã€‚æˆåŠŸã™ã‚Œã°ã€LLMã¯å˜ã«è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ãªãã€æ´å¯Ÿã«å¯Œã‚“ã è³ªå•ã‚’ã—ã€è«–ç†çš„æ¨è«–ã‚’è¡Œã„ã€å¯èƒ½æ€§ã‚’è¿…é€Ÿã«çµã‚Šè¾¼ã‚€èƒ½åŠ›ã‚’å®Ÿè¨¼ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
import pandas as pd  # pandasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import numpy as np  # NumPyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ•°å€¤è¨ˆç®—ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
from llm_20_questions.keywords import KEYWORDS_JSON  # KEYWORDS_JSONã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
import keras  # Kerasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ·±å±¤å­¦ç¿’ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
import keras_nlp  # Keras NLPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚NLPã‚¿ã‚¹ã‚¯ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 3)---
```python
keywords = eval(KEYWORDS_JSON)  # KEYWORDS_JSONã‚’è©•ä¾¡ã—ã¦ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import os  # osãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

os.environ["KERAS_BACKEND"] = "tensorflow"  # Kerasã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’TensorFlowã«è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
gemma_lm = keras_nlp.models.GemmaCausalLM.from_preset("gemma_2b_en")  # GemmaCausalLMãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
gemma_lm.summary()  # ãƒ¢ãƒ‡ãƒ«ã®æ¦‚è¦ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
gemma_lm.generate(KEYWORDS_JSON, max_length=20)  # KEYWORDS_JSONã«åŸºã¥ãã€æœ€å¤§20ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
promt = """
    ã“ã‚“ã«ã¡ã¯ã€‚ä»Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ç§ã®æŒã£ã¦ã„ã‚‹å˜èªã‚’ã‚ãªãŸã¯æ¨æ¸¬ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
    ç§ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã ã‘ã§ãŠç­”ãˆã—ã¾ã™ã€‚ã•ã‚ã€è³ªå•ã—ã¦ãã ã•ã„ã€‚
    """  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
gemma_lm.generate(promt, max_length=15)  # è¨­å®šã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸºã¥ãã€æœ€å¤§15ãƒˆãƒ¼ã‚¯ãƒ³ã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
class Agent:  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
    def __init__(self):
        self.gemma = gemma_lm  # Gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
        self.knowledge = []  # çŸ¥è­˜ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

    def ask_question(self, question):
        self.knowledge.append(question)  # è³ªå•ã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        response = self.gemma.generate(question)  # Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
        return response  # å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚

    def receive_answer(self, answer):
        self.knowledge.append(answer)  # ç­”ãˆã‚’çŸ¥è­˜ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
        # å¿…è¦ã«å¿œã˜ã¦ç­”ãˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
        pass  # ç¾åœ¨ã¯å‡¦ç†ã›ãšã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 41, the number of votes :3 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿ã®2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã™ã€‚

### å•é¡Œã®å†…å®¹
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒå–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã®ã¯ã€ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã«ãŠã„ã¦ã€ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’å½“ã¦ã‚‹ã“ã¨ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã¨å›ç­”ã‚’é€šã˜ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’çµã‚Šè¾¼ã‚€èƒ½åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã§ã¯ã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã®å˜èªãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã€äºŒåˆ†æ¢ç´¢æ³•ã‚’ç”¨ã„ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ¨å®šã‚’è¡Œã„ã¾ã™ã€‚ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€æœ€å¤§20ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™ã€‚

2. **æ­£è¦è¡¨ç¾**:
    - è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡ºã«æ­£è¦è¡¨ç¾ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç‰¹å®šã®è³ªå•å½¢å¼ã«åŸºã¥ã„ãŸå¿œç­”å‡¦ç†ãŒå®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚

3. **ãƒ©ãƒ³ãƒ€ãƒ å¿œç­”**:
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿ã§ã¯ã€ç°¡å˜ãªãƒ©ãƒ³ãƒ€ãƒ å¿œç­”ã‚’åˆ©ç”¨ã—ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã™ã€‚æ¡ä»¶ã«å¿œã˜ã¦ç•°ãªã‚‹åå¿œã‚’è¿”ã™ã“ã¨ã§ã€åŸºæœ¬çš„ãªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ã‚’æŒãŸã›ã¦ã„ã¾ã™ã€‚

4. **Kaggle Environments**:
    - ã‚²ãƒ¼ãƒ ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€`kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã€çµæœã‚’è¦–è¦šçš„ã«ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

5. **ãƒ‡ãƒãƒƒã‚°ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
    - é…åˆ—ã‚„ãƒªã‚¹ãƒˆã‹ã‚‰æ¬ è½ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚ã“ã®éƒ¨åˆ†ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®ã‚„ã‚Šã¨ã‚Šã‚’è¦³å¯Ÿã™ã‚‹ãŸã‚ã«ã€å®Ÿè¡Œã‚‚è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€æˆ¦ç•¥çš„ãªè³ªå•ã®ç”Ÿæˆã¨ãã®å¿œç­”ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€æœ€çµ‚çš„ãªæå‡ºç‰©ã¯ã€ã“ã‚Œã‚‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Ÿéš›ã«ãƒ—ãƒ¬ã‚¤ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨å®šã™ã‚‹èƒ½åŠ›ã«åŸºã¥ã„ã¦è©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# æå‡ºæ™‚ã«é©ç”¨
%mkdir /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 2)---
```python
%%writefile submission/main.py

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †/æ¯”è¼ƒã¨äºŒåˆ†æ³•ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
# æœ€é©ãªæ¢ç´¢æ–¹æ³•ã§ã€20ã‚¿ãƒ¼ãƒ³ä»¥å†…ã«è§£æ±ºç­–ãŒè¦‹ã¤ã‹ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™ï¼ˆlog2(n_keywords)+1ã®ä¸Šé™ï¼‰
# å‰ææ¡ä»¶ã¨ã—ã¦ï¼š
#   * ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã™ã¹ã¦ã®å˜èªã®ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ãŠã‚Šã€2**19ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¶…ãˆãªã„ã“ã¨
#   * ä»–ã®ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹ã“ã¨ã€ã¤ã¾ã‚Šã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ã«æ­£ã—ãå¿œç­”ã§ãã‚‹ã“ã¨

# ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒªã‚¹ãƒˆã«ãªã„å ´åˆã€ã‚¢ãƒ«ãƒ•ã‚¡æ¤œç´¢ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã§ãã¾ã›ã‚“ãŒã€
# ä»–ã®æŠ€è¡“ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§çµæœãŒå½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã›ãšã«å›ç­”è€…ã¨ã—ã¦å—å‹•çš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
# ã¨ã¯ã„ãˆã€è³ªå•è€…ãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãªã—ã§ã‚¢ãƒ«ãƒ•ã‚¡ã‚’è©¦ã¿ã‚‹å§¿ã¯ã‚ã¾ã‚Šè¦‹ã‚‰ã‚Œãªã„ã§ã—ã‚‡ã†ãŒã€‚
# ã„ãšã‚Œã«ã›ã‚ˆã€å›ç­”ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å‰ã«æ­£è¦è¡¨ç¾ãƒãƒƒãƒãƒ£ãƒ¼ãŒå¿…è¦ã§ã™ã€‚å®Ÿè£…ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

# ãã‚Œã§ã¯ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚loh-maa


import random
import re

VERSION = 9

# ã‚²ãƒ¼ãƒ ã§æœŸå¾…ã•ã‚Œã‚‹ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã€‚ã“ã®ãƒªã‚¹ãƒˆã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è©•ä¾¡æ®µéšã«æå‡ºã™ã‚‹å‰ã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
# è‡ªåˆ†ã®åˆ¤æ–­ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚ãƒªã‚¹ãƒˆãŒé•·ã„ã»ã©ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯è‰¯ããªã‚Šã¾ã™ãŒã€åæŸã¯é…ããªã‚Šã¾ã™ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯
# åæŸã‚ˆã‚Šã‚‚é‡è¦ã§ã‚ã‚‹ã¨è¨€ãˆã‚‹ãŸã‚ã€æ¬ è½ã—ã¦ã„ã‚‹å˜èªãŒã‚ã‚‹ã‚ˆã‚Šã‚‚å¤šãã®ä½™åˆ†ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã¤ã»ã†ãŒè‰¯ã„ã§ã™ã€‚
allwords = ['xxx', 'remember', 'roll out your own!', 'xxx', 'this list is just for testing', 'advertisement',
            'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx', 'xxx',
            'agave', 'air compressor', 'air conditioner', 'air filter', 'air vent', 'alarm system',
            'analogy', 'anemone', 'anesthesia', 'apple pie', 'aprons', 'aquarium', 'atmosphere', 'auditorium',
            'backrest', 'bacteria', 'baguette', 'balcony', 'bank', 'barber chair', 'barcode', 'bat', 'bath mat',
            'battery bank', 'beanbag', 'bed frame', 'bike', 'bike path', 'binoculars', 'bird cage', 'bird seed',
            'bleachers', 'blinds', 'board games', 'bobby pins', 'bollards', 'bonding agent', 'bookcase', 'bookends',
            'bottled water', 'bread knife', 'bread pudding', 'break room', 'brewery merchandise', 'briefcase',
            'brochure', 'broken glass', 'brownies', 'bug spray', 'bulb', 'bumper sticker', 'bunsen burner', 'butterfly',
            'cabinet', 'calculator', 'cantaloupe', 'car seat', 'card', 'cardboard box', 'cash register', 'cat bed',
            'cat carrier', 'cauliflower', 'ceiling fan', 'cereal', 'latte', 'champagne flute', 'chandelier',
            'cheesecake', 'chessboard', 'chew toy', 'chocolate cake', 'cinnamon roll', 'rags', 'coat rack',
            'coffee beans', 'coffee grinder', 'coffee grounds', 'coffee makers', 'comic book', 'contact lenses',
            'conveyor belt', 'cooling tower', 'coral reefs', 'cream cheese', 'crochet hook', 'croissant', 'cup holder',
            'cupcake', 'curling iron', 'curtains', 'cutlery', 'cutting board', 'dandelion', 'deciduous tree',
            'dental chair', 'desk chairs', 'desk lamp', 'desktop computer', 'diaper', 'dijon mustard', 'dining table',
            'dish rack', 'dish soap', 'disinfectant', 'diving board', 'dog bed', 'dog crate', 'dog shampoo', 'donuts',
            'drain hose', 'drapes', 'duct tape', 'duffle bags', 'dumbbells', 'dump truck', 'duvet', 'dvd', 'dvd player',
            'dynamite', 'ear protection', 'earl grey tea', 'earplug', 'earth', 'edamame', 'edible flowers',
            'electric scooter', 'electric toothbrush', 'electrical outlet', 'electrical panel', 'electrical tape',
            'elevator', 'elliptical trainers', 'emergency exit sign', 'emergency lights', 'energy drink', 'engravings',
            'escalators', 'eucalyptus', 'excavator', 'exercise mat', 'exhaust fan', 'exit sign', 'extension cord',
            'eye mask', 'face mask', 'facial toner', 'fanny pack', 'fertilizer', 'filing cabinet', 'finger food',
            'fire alarm', 'fire escape ladder', 'fire extinguisher', 'fireplace', 'first aid kit', 'fish tank',
            'fishing pier', 'fitness tracker', 'flashlight', 'floor jacks', 'floor mats', 'foam roller', 'fog machine',
            'food bowl', 'food warmers', 'fortune cookie', 'frappuccino', 'free weights', 'french toast',
            'fridge magnet', 'fried rice', 'fungi', 'furniture', 'furniture polish', 'fuse', 'gadget', 'garage door',
            'garbage bag', 'garbage can', 'garbage disposal', 'garbage truck', 'gas mask', 'generator', 'glass table',
            'glove box', 'glove', 'golf cart', 'gps', 'grain bin', 'granola', 'grape vine', 'grapefruit',
            'graphic novel', 'graphing calculator', 'gravity', 'green beans', 'greeting card', 'guard tower',
            'guitar string', 'gym mats', 'habanero pepper', 'hair clip', 'hair dryer', 'hair gel', 'hairbrush',
            'hairspray', 'hamster wheel', 'hamstring curl machine', 'hand dryer', 'hand sanitizer', 'handbag',
            'handrail', 'hard hat', 'hash browns', 'hay bale', 'hazelnut', 'hdmi cable', 'headlamp', 'headphones',
            'hearing aid', 'heart rate monitors', 'heating element', 'hibiscus', 'high chair', 'highlighter',
            'hiking boots', 'holly', 'honeybee', 'hot dog', 'hot water bottle', 'ice cream maker', 'ice cube tray',
            'ice water', 'iced coffee', 'icicle', 'incense', 'incubator', 'index card', 'inhaler', 'ink cartridge',
            'insulation', 'router', 'interstate', 'iris', 'iron', 'ironing board', 'iron bar', 'irrigation system',
            'iv', 'jewelry box', 'journal', 'joystick', 'jumper cables', 'kale smoothie', 'karaoke machine',
            'key chain', 'khaki pants', 'kiosk', 'kitchen cabinet', 'garbage disposal', 'kitchen table',
            'komodo dragon', 'lab coat', 'lanyard', 'laptop', 'laser beam', 'lathe', 'laundry basket', 'lawnmower',
            'lego', 'library card', 'light switch', 'lightbulb', 'lint roller', 'lint trap', 'litter scooper',
            'lottery ticket', 'luggage', 'magazine rack', 'mailbox', 'marshmallow', 'masks', 'matches', 'measuring cup',
            'measuring tape', 'medical records', 'medication dispenser', 'medication', 'medicine cabinet', 'menorah',
            'metal detector', 'mouse', 'microphone stand', 'microscope', 'microwave', 'milling machine', 'mini fridge',
            'mixing bowl', 'mobile phone', 'modem', 'motorcycle helmet', 'movie poster', 'muffin tin', 'muffin',
            'muffler', 'mural', 'mushroom', 'nachos', 'nail clipper', 'nail polish', 'nail polish remover', 'name tag',
            'nap mat', 'necklace', 'nightstand', 'notebook', 'nozzle', 'oak table', 'ocarina', 'oil filter', 'ointment',
            'olive oil', 'onyx', 'orange peel', 'orange tree', 'orange zest', 'outdoor furniture', 'oven door',
            'oven rack', 'owl', 'oxygen tank', 'pacifier', 'packing peanuts', 'pad', 'pajamas', 'pallet jack',
            'pamphlet', 'pants', 'paper towels', 'paperweights', 'paperwork', 'parachute', 'parallel bars', 'pea soup',
            'pencil sharpener', 'perfume', 'personal protective equipment', 'pesticide', 'phone charger', 'photo album',
            'piano', 'pickaxe', 'piping tips', 'placemat', 'planter box', 'plaque', 'plastic gloves', 'plastic wrap',
            'plate', 'play mat', 'playing cards', 'pliers', 'polyester', 'pool cleaner', 'popcorn', 'popcorn machine',
            'portable speaker', 'pot holder', 'potato', 'power drill', 'power lines', 'power strip', 'press box',
            'pressure gauge', 'projector', 'protein bar', 'protein shakes', 'pry bar', 'public address system',
            'pumpkin pie', 'punching bag', 'push pin', 'puzzle', 'pyramid', 'quesadilla', 'rabbit', 'raccoon',
            'radio scanner', 'radish', 'railroad tracks', 'raindrops', 'rat', 'red velvet cake', 'red wine',
            'refrigerator', 'rehearsal room', 'reindeer', 'relish', 'reptile', 'resin', 'respirator', 'restaurants',
            'rice pudding', 'rivet', 'robot arm', 'rolling pin', 'roots', 'rowing machines', 'rug', 'rv',
            'safety harness', 'salad dressing', 'satellite', 'sauna', 'scones', 'scoreboard', 'scrap metal',
            'scratching posts', 'screwdriver', 'security systems', 'seed packet', 'server rack', 'sewing kit',
            'shin guards', 'shipping label', 'shoe rack', 'shower caddy', 'shower mat', 'sieve', 'silicone',
            'silicone mat', 'silver ore', 'sippy cup', 'sketchbook', 'sleeping bag', 'smartphone', 'smartwatch',
            'smoke detector', 'snacks', 'soap dish', 'soap dispenser', 'soap suds', 'soda', 'sofa', 'solar panel',
            'soldering iron', 'sound system', 'soybeans', 'space probe', 'spatula', 'spice rack', 'spider web',
            'sportswear', 'spotlight', 'sprinkler', 'sprinkler system', 'squirrel', 'stadium', 'stage lights',
            'stain remover', 'stained glass window', 'stair stepper', 'staircase', 'stationary bike', 'steam room',
            'sticker', 'sticky notes', 'storage bin', 'stove', 'street sign', 'sugar packet', 'suitcase', 'sunglasses',
            'sunscreen', 'swimsuit', 'swing set', 'tablet', 'tank', 'tape dispenser', 'taser', 'tea leaf', 'telescope',
            'television', 'tennis ball', 'tennis court', 'throw blanket', 'ticket machine', 'ticket stub', 'tire iron',
            'tissue box', 'toaster oven', 'tofu', 'toilet', 'toiletries bag', 'tomato', 'tongue depressor', 'tool belt',
            'tool box', 'toothbrush', 'toothbrush holder', 'toothpaste', 'touchscreen', 'tow truck', 'towel',
            'tracksuit', 'tractor shed', 'tractor', 'train brake', 'train door', 'trash bag', 'trash can', 'tricycle',
            'truck', 'tulip', 'turkey', 'turn signal', 'turnstiles', 'tweezers', 'udon noodles', 'ultraviolet lamp',
            'umbrella stand', 'underground river', 'unleavened bread', 'urinal', 'usb drives', 'utility box',
            'utility cart', 'vacuum cleaner', 'vanilla extract', 'vanity mirror', 'vans', 'vase', 'vegetable',
            'vegetation', 'veggie burger', 'velvet rope', 'vending machine', 'ventilation system', 'video camera',
            'violin bow', 'violin strings', 'virus', 'volcano', 'voucher', 'vr headset', 'walking stick', 'wall art',
            'wall decorations', 'wall street', 'wardrobe', 'washing machine', 'water', 'water bottle', 'water buffalo',
            'water fountain', 'water heater', 'water tank', 'watering can', 'webcam', 'wheelchair ramp', 'whistle',
            'willow tree', 'windbreak', 'wine aerator', 'wine decanter', 'wine opener', 'wine rack', 'wine tasting kit',
            'wire rack', 'wireless speaker', 'wrench', 'wrist weights', 'wristband', 'yoga block', 'yoga mat', 'yogurt',
            'zinc', 'afghanistan', 'albania', 'algeria', 'andorra', 'angola', 'antigua and barbuda', 'argentina',
            'armenia', 'australia', 'austria', 'azerbaijan', 'bahrain', 'bangladesh', 'barbados', 'belarus', 'belgium',
            'belize', 'benin', 'bhutan', 'bolivia', 'bosnia and herzegovina', 'botswana', 'brazil', 'brunei',
            'bulgaria', 'burkina faso', 'burundi', 'cambodia', 'cameroon', 'canada', 'cape verde',
            'central african republic', 'chad', 'chile', 'china', 'colombia', 'comoros', 'congo', 'costa rica',
            'croatia', 'cuba', 'cyprus', 'czech republic', 'democratic republic of the congo', 'denmark', 'djibouti',
            'dominica', 'dominican republic', 'ecuador', 'egypt', 'el salvador', 'england', 'equatorial guinea',
            'eritrea', 'estonia', 'ethiopia', 'federated states of micronesia', 'finland', 'france', 'gabon', 'gambia',
            'georgia', 'germany', 'ghana', 'greece', 'grenada', 'guatemala', 'guinea', 'guinea bissau', 'guyana',
            'haiti', 'honduras', 'hungary', 'iceland', 'india', 'indonesia', 'iran', 'iraq', 'ireland', 'israel',
            'italy', 'jamaica', 'japan', 'jordan', 'kazakhstan', 'kenya', 'kiribati', 'kosovo', 'kuwait', 'kyrgyzstan',
            'laos', 'latvia', 'lebanon', 'lesotho', 'liberia', 'libya', 'liechtenstein', 'lithuania', 'luxembourg',
            'madagascar', 'malawi', 'malaysia', 'maldives', 'mali', 'malta', 'marshall islands', 'mauritania',
            'mauritius', 'mexico', 'moldova', 'monaco', 'mongolia', 'montenegro', 'morocco', 'mozambique', 'myanmar',
            'namibia', 'nauru', 'nepal', 'netherlands', 'new zealand', 'nicaragua', 'niger', 'nigeria', 'north korea',
            'norway', 'oman', 'pakistan', 'palau', 'palestine', 'panama', 'papua new guinea', 'paraguay', 'peru',
            'philippines', 'poland', 'portugal', 'qatar', 'romania', 'russia', 'rwanda', 'saint kitts and nevis',
            'saint lucia', 'saint vincent and the grenadines', 'samoa', 'san marino', 'sao tome and principe',
            'saudi arabia', 'senegal', 'serbia', 'seychelles', 'sierra leone', 'singapore', 'slovakia', 'slovenia',
            'solomon islands', 'somalia', 'south africa', 'south korea', 'spain', 'sudan', 'suriname', 'swaziland',
            'sweden', 'switzerland', 'syria', 'taiwan', 'tajikistan', 'tanzania', 'thailand', 'togo', 'tonga',
            'trinidad and tobago', 'tunisia', 'turkey', 'turkmenistan', 'tuvalu', 'uganda', 'ukraine',
            'united arab emirates', 'united kingdom', 'united states of america', 'uruguay', 'uzbekistan', 'vanuatu',
            'venezuela', 'vietnam', 'yemen', 'zambia', 'zimbabwe', 'amsterdam netherlands', 'anaheim california',
            'austin texas', 'auckland new zealand', 'asheville north carolina', 'ashgabat turkmenistan']


def agent_beta(obs, cfg):
    """ ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§ã™ã€‚ç‹¬è‡ªã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼LLMã¾ãŸã¯å¥½ã¿ã®ä»£æ›¿æ‰‹æ®µã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ """

    if obs.turnType == 'ask':
        # LLMã¾ãŸã¯ä»–ã®ä½•ã‹ã‚’å®Ÿè¡Œ
        if len(obs.questions) % 2:
            response = "ã‚¢ãƒ«ãƒ•ã‚¡ã¯å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚‚ã†ä¸€å¼µã‚ŠãŒã‚ã‚‹ã®ã§ãƒ©ãƒƒã‚­ãƒ¼ã§ã™..."
        else:
            response = "ç§ã¯ã‚ãªãŸã®å€‹äººçš„ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã§ã™ï¼æ¬¡ã®è³ªå•ã¯ä½•ã§ã™ã‹ï¼Ÿ"

    elif obs.turnType == 'answer':
        response = 'ã¯ã„'

    elif obs.turnType == 'guess':
        if len(obs.questions) % 2:
            # å¤šåˆ†.. æ„›å¬Œã®ã‚ã‚‹ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã§å¿œç­”
            responses = ['ã®ã‚¢ãƒ«ãƒ•ã‚¡ã§ã¯ãªãã€æ¥½ã—ã¿ãŒãªã„', 'ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸæ–¹ãŒã„ã„ã§ã™ã‚ˆ', 'ã‚¢ãƒ«ãƒ•ã‚¡ã¯äººç”Ÿã§ã™',
                         'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«ã‚ˆã‚‹äºŒåˆ†æ³•ãŒå½¹ç«‹ã¤', f'ã‚¯ãƒªãƒ¼ãƒŸãƒ¼ã§ãƒŸãƒ«ã‚­ãƒ¼ã€ã‚¢ãƒ«ãƒ•ã‚¡ {VERSION}',
                         'ã‚«ã‚°ãƒ«ã‚’å†ã³ç´ æ™´ã‚‰ã—ãã™ã‚‹']

            response = random.choice(responses)

        else:
            # LLMã¾ãŸã¯ä»–ã®ä½•ã‹ã‚’å®Ÿè¡Œ
            response = "ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã¯ã€è¿‘ã¥ã„ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ï¼**ã‚¨ãƒƒãƒ•ã‚§ãƒ«ã‚¿ã‚ªãƒ«**"

    else:
        assert False

    return response


def answered_yes(obs, question):
    """ è³ªå•ãŒã•ã‚Œã€ãã®ç­”ãˆãŒã€Œã¯ã„ã€ã§ã‚ã£ãŸã‹ç¢ºèªã—ã¾ã™ã€‚ """
    try:
        ix = obs.questions.index(question)
        return obs.answers[ix] == 'yes'
    except (ValueError, IndexError):
        return False


class AgentAlpha:

    # äº’æ›æ€§ã®ãŸã‚å›ºå®š
    HANDSHAKE = 'ã“ã‚Œã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã§ã™ã‹ï¼Ÿ'

    # ã“ã‚Œã¯æ¤œç´¢ç©ºé–“ã§ã™ã€å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚
    # ãƒ†ã‚¹ãƒˆä¸­ã«é€£ç¶šã—ã¦ã‚²ãƒ¼ãƒ ã‚’è¡Œã†ã¨ãã«ã¯å†åˆæœŸåŒ–ãŒå¿…è¦
    keywords = sorted(allwords)

    @staticmethod
    def parse_alpha_question(question):
        # ã‚¢ãƒ«ãƒ•ã‚¡è³ªå•ã«å¿œç­”ã™ã‚‹ãŸã‚ã®æ­£è¦è¡¨ç¾ã€‚ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®4ã¤ã®å¤‰ç¨®ã‚’å«ã¿ã¾ã™ï¼š
        match = re.search(r'keyword.*(?:come before|precede) \"([^\"]+)\" .+ order\?$', question)
        if match:
            # ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ãŒä¸€è‡´
            testword = match.group(1)
            return testword
        else:
            return None

    @staticmethod
    def play(obs, cfg):

        if obs.turnType == 'ask':

            if len(obs.questions) == 0:
                # ãã‚ŒãŒæœ€åˆã®è³ªå•ã§ã™ã€‚
                return AgentAlpha.HANDSHAKE

            elif answered_yes(obs, AgentAlpha.HANDSHAKE) and AgentAlpha.keywords:
                # å›ºå®šã®è³ªå•ã‚’1ã¤ä½¿ç”¨ã€ã‚‚ã†è³ªå•ã‚’å›ã™æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€
                # LLMã¯ãã®ã™ã¹ã¦ã«æ­£ç¢ºã«å¿œç­”ã™ã‚‹ã“ã¨ãŒã§ããªã„ã‹ã‚‰ã§ã™ã€‚
                testword = AgentAlpha.keywords[len(AgentAlpha.keywords) // 2]
                # è³ªå•ã®å½¢å¼ã‚’å›ºå®šã—ã¦ã€ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ã®ã¿ã‚’ç½®ãæ›ãˆã¾ã™
                response = f'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ã§ï¼‰ãŒã€Œ{testword}ã€ã®å‰ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'

            else:
                # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¯æ¸‡ã€ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ­è¼‰ã—ã¦ã„ãªã‹ã£ãŸã‹ã€
                # ç­”ãˆã‚‹äººãŒé–“é•ã£ãŸå ´åˆã€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦ã™ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«Noneã‚’è¿”ã—ã¾ã™
                response = None

        elif obs.turnType == 'answer':

            # ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã®è³ªå•ãŒè¦‹ãˆãŸå ´åˆã¯ã€Œã¯ã„ã€ã¨ç­”ãˆã‚‹ã€‚
            if AgentAlpha.HANDSHAKE == obs.questions[-1]:
                response = 'ã¯ã„'

            else:
                testword = AgentAlpha.parse_alpha_question(obs.questions[-1])
                if testword is not None:
                    response = 'ã¯ã„' if obs.keyword.lower() < testword else 'ã„ã„ãˆ'
                else:
                    # ã‚¢ãƒ«ãƒ•ã‚¡ã®è³ªå•ã§ãªã„å ´åˆã¯ã€ä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’é€²ã‚ã¾ã™
                    response = None

        elif obs.turnType == 'guess':

            # æœ€å¾Œã®è³ªå•ãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã®å ´åˆã€ç‰¹åˆ¥ãªæ¨æ¸¬ã‚’è¡Œã†
            if obs.questions[-1] == AgentAlpha.HANDSHAKE:
                # ãã‚ŒãŒãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã™...
                if obs.answers[-1] == 'ã¯ã„':
                    response = f"è©¦ã—ã¾ã—ã‚‡ã†.. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {VERSION}"
                else:
                    response = f'ç›®'

            else:
                # æœ€å¾Œã®è³ªå•ã¨ç­”ãˆã«åŸºã¥ã„ã¦ç©ºé–“ã‚’äºŒåˆ†ã—ã¾ã™
                testword = AgentAlpha.parse_alpha_question(obs.questions[-1])
                if testword:
                    if obs.answers[-1] == 'ã¯ã„':
                        AgentAlpha.keywords = [k for k in AgentAlpha.keywords if k < testword]
                    else:
                        AgentAlpha.keywords = [k for k in AgentAlpha.keywords if not k < testword]

                if AgentAlpha.keywords:
                    # å‰ã‹ã‚‰ãƒãƒƒãƒ—ã—ã¾ã™ãŒã€ã©ã¡ã‚‰ã‹ã‚‰ãƒãƒƒãƒ—ã—ã¦ã‚‚ã‚ã¾ã‚Šé‡è¦ã§ã¯ãªã„ã€‚
                    response = AgentAlpha.keywords.pop(0)

                else:
                    # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¯æ¸‡ã€ä»–ã®ä½•ã‹ã‚’ä½¿ç”¨ã—ã¾ã™
                    response = None
        else:
            assert False, f'äºˆæœŸã—ãªã„turnType: {obs.turnType}'

        return response


def agent_fn(obs, cfg):
    """ ãƒ¡ã‚¤ãƒ³ãƒ•ãƒƒã‚¯ã§ã™ã€‚åå‰ã‚’ã€Œagent_fnã€ã¨ã—ã€æå‡ºã®æœ€å¾Œã®é–¢æ•°ã«ã—ã¦ãã ã•ã„ã€‚ """

    try:
        # ã¾ãšã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã‚’è©¦ã¿ã€æ„å‘³ã®ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ã‚’è¡Œã†ã‹
        # ã§ããªã„å ´åˆã¯Noneã‚’è¿”ã—ã¾ã™
        response = AgentAlpha.play(obs, cfg)

        if response is None:
            # ä»–ã®ä½•ã‹ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«
            response = agent_beta(obs, cfg)

    except Exception:
        import traceback
        traceback.print_exc()
        response = 'ã„ã„ãˆ'

    return response
```

---The following area is a Code cell (cell numver is 3)---
```python
import random
%%time

# ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ã¿ã€æœ‰åŠ¹åŒ–ã¯æå‡ºæ™‚ã«ã¯ã—ãªã„ã§ãã ã•ã„
# ï¼ˆ"æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰

import kaggle_environments


def agent_dummy(obs, cfg):
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"
    else:
        assert False
    return response

debug_config = {'episodeSteps': 61,  # åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã«åŠ ãˆã¦ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«3ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè³ªå•/ç­”ãˆ/æ¨æ¸¬ï¼‰
                'actTimeout': 60,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚ãŸã‚Šã®æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯60
                'runTimeout': 1200,  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§æ™‚é–“ï¼ˆç§’ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1200
                'agentTimeout': 3600}  # å»ƒæ­¢ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3600

env = kaggle_environments.make(environment="llm_20_questions", configuration=debug_config, debug=True)

# æ¬ è½ã™ã‚‹å˜èªã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
AgentAlpha.keywords = sorted(random.sample(allwords, 500))

game_output = env.run(agents=[agent_dummy, agent_dummy, agent_fn, agent_fn])

env.render(mode="ipython", width=1080, height=700)
out = env.render(mode="ansi")
print(out)
```

---The following area is a Code cell (cell numver is 4)---
```python
# æå‡ºæ™‚ã«æœ‰åŠ¹åŒ–.. pigzã®ä½¿ç”¨ã¯å¿…é ˆã§ã™ã‹ï¼Ÿ
!apt install pigz pv
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

** @@@ Jupyter Notebook numver 42, the number of votes :3 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ç‰¹ã«ã€é–‹ç™ºè€…ã¯ã€Œifã€æ–‡ã‚’å¤šç”¨ã›ãšã«ã€åŠ¹ç‡çš„ãªè³ªå•è€…ã‚’ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¢æ±‚ã—ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚»ãƒ«ã§ã¯ã€ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã™ã‚‹ç†ç”±ã‚„ä»–ã®æœ‰ç”¨ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã‚‚è¨€åŠã•ã‚Œã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ãŒä¸»é¡Œã§ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Pythonã§ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚`Robot`ã‚¯ãƒ©ã‚¹ã¯ã€è³ªå•ã‚„æ¨æ¸¬ã€å›ç­”ã®å„ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€è³ªå•ã¯æœ¨æ§‹é€ ã‚’ç”¨ã„ãŸè¾æ›¸å½¢å¼ã§ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€éå»ã®å›ç­”å±¥æ­´ã«åŸºã¥ã„ã¦é©åˆ‡ãªè³ªå•ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã¾ãŸã€æ¨æ¸¬ãƒ¢ãƒ¼ãƒ‰ã§ã¯å›ºå®šã®å›ç­”ï¼ˆ'apple'ï¼‰ã‚’è¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚å›ç­”ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å¿œç­”ãŒé¸ã°ã‚Œã¾ã™ã€‚

ã“ã®å®Ÿè£…ã§ã¯ã€`kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œç’°å¢ƒã‚’è¨­å®šã—ã€ã‚²ãƒ¼ãƒ ã®çµæœã‚’å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚å…¨ä½“ã¨ã—ã¦ã€Notebookã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å¦‚ä½•ã«ã—ã¦æ§‹ç¯‰ã—ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®æ å†…ã§ã©ã®ã‚ˆã†ã«ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã•ã›ã‚‹ã‹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®è³ªå•è€…ã‚’ã©ã†å®Ÿè£…ã—ã¾ã™ã‹ï¼Ÿ
å¤šãã®ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ã¯ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã®ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãŠã‚ˆã³LLMè³ªå•è€…ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã‹ï¼Ÿè¤‡æ•°ã®ã€Œifã€ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿä»–ã«å½¹ç«‹ã¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ  
ç§ã¯è¤‡æ•°ã®ã€Œifã€æ–‡ã‚’ä½¿ç”¨ã›ãšã«ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®è³ªå•è€…ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ç°¡å˜ã«ã§ãã‚‹åˆ¥ã®æ–¹æ³•ãŒã‚ã‚Œã°ã€ã‚³ãƒ¡ãƒ³ãƒˆã§å…±æœ‰ã—ã¦ãã ã•ã„ï¼

![tree.png](attachment:ca56c51b-c2d5-44ee-b7d5-a199907a881f.png)
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile -a submission/main.py

import random

class Robot:
    def __init__(self):
        # åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰ã€‚ä½•ã‚‚åˆæœŸåŒ–ã—ãªã„ã€‚
        pass
    
    def on(self, mode, obs):
        # ãƒ¢ãƒ¼ãƒ‰ãŒã€Œaskingã€ã€Œguessingã€ã€Œansweringã€ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
        assert mode in ["asking", "guessing", "answering"], "modeã¯ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ã®å€¤: asking, answering, guessing ã®ã¿ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™"
        
        # ãƒ¢ãƒ¼ãƒ‰ãŒã€Œaskingã€ã®å ´åˆ
        if mode == "asking":
            # è³ªå•ã®æœ¨æ§‹é€ ã‚’è¾æ›¸ã¨ã—ã¦å®šç¾©
            tree_dic = {
                "1": {
                    "": "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ",  # è³ªå•1
                },
                "2": {
                    "y": "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ",  # yã®å›ç­”ã«å¯¾ã™ã‚‹è³ªå•
                    "n": "ãã‚Œã¯é£Ÿã¹ç‰©ã§ã™ã‹ï¼Ÿ",  # nã®å›ç­”ã«å¯¾ã™ã‚‹è³ªå•
                },
                "3": {
                    "yy":"ãã‚Œã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "yn":"ãã‚Œã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ",
                    "ny":"ãã®é£Ÿã¹ç‰©ã¯ç”˜ã„ã§ã™ã‹ï¼Ÿ",
                    "nn":"ãã‚Œã¯é£²ã¿ç‰©ã§ã™ã‹ï¼Ÿ",
                },
                "4": {
                    "yyy":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "yyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "yny":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ynn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nyy":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nny":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nnn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'a' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                },
                "5": {
                    "yyyy":"",
                    "yyyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "yyny":"",
                    "yynn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ynyy":"",
                    "ynyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ynny":"",
                    "ynnn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nyyy":"",
                    "nyyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nyny":"",
                    "nynn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nnyy":"",
                    "nnyn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "nnny":"",
                    "nnnn":"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ 'b' ã®æ–‡å­—ã§å§‹ã¾ã‚Šã¾ã™ã‹ï¼Ÿ",
                }
            }
            answers_hist = ""
            # è¦³å¯Ÿã‹ã‚‰éå»ã®å›ç­”ã®å±¥æ­´ã‚’ä½œæˆ
            for answer in obs.answers:
                answers_hist += answer[0]
                
            # éå»ã®å›ç­”ã®æ•°ãŒæœ¨æ§‹é€ ã®ãƒãƒ¼ãƒ‰ã‚ˆã‚Šå°‘ãªã„å ´åˆ
            if len(obs.answers) < len(tree_dic):
                output = tree_dic[str(len(obs.answers) + 1)][answers_hist]
                # è³ªå•ã®å‡ºåŠ›ãŒç©ºã®å ´åˆã¯LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
                if output == "":
                    output = "ã‚ãªãŸã®LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã‚“ã§ãã ã•ã„"
            else:
                output = "ã‚ãªãŸã®LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã‚“ã§ãã ã•ã„"  # éå»ã®å›ç­”ãŒæœ¨ã®ãƒãƒ¼ãƒ‰ã‚’è¶…ãˆãŸå ´åˆ
        
        # ãƒ¢ãƒ¼ãƒ‰ãŒã€Œansweringã€ã®å ´åˆ
        if mode == "answering":
            output = random.choice(['yes', 'no'])  # ãƒ©ãƒ³ãƒ€ãƒ ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã‚’é¸æŠ
        
        # ãƒ¢ãƒ¼ãƒ‰ãŒã€Œguessingã€ã®å ´åˆ
        if mode == "guessing":
            output = 'apple'  # æ¨æ¸¬ã®å‡ºåŠ›ã‚’å›ºå®š
            
        return output  # å‡ºåŠ›ã‚’è¿”ã™

robot = Robot()  # Robotã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    
def agent(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•ã‚’è¦³å¯Ÿã«åŸºã¥ã„ã¦æ±ºå®šã™ã‚‹
    if obs.turnType == "ask":
        response = robot.on(mode="asking", obs=obs)  # è³ªå•ãƒ¢ãƒ¼ãƒ‰ã§ã®å¿œç­”
    elif obs.turnType == "guess":
        response = robot.on(mode="guessing", obs=obs)  # æ¨æ¸¬ãƒ¢ãƒ¼ãƒ‰ã§ã®å¿œç­”
    elif obs.turnType == "answer":
        response = robot.on(mode="answering", obs=obs)  # å›ç­”ãƒ¢ãƒ¼ãƒ‰ã§ã®å¿œç­”
        
    return response  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
%%time

from kaggle_environments import make
agent = "/kaggle/working/submission/main.py"  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŒ‡å®š
env = make("llm_20_questions", debug=True)  # ç’°å¢ƒã‚’ä½œæˆ
game_output = env.run(agents=[agent, agent, agent, agent])  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
env.render(mode="ipython", width=600, height=500)  # å®Ÿè¡Œçµæœã‚’è¡¨ç¤º
```

** @@@ Jupyter Notebook numver 43, the number of votes :3 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ç‰¹ã«ã€è³ªå•è€…ï¼ˆGemmaQuestionerAgentï¼‰ã¨å›ç­”è€…ï¼ˆGemmaAnswererAgentï¼‰ã®äºŒã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯äº¤äº’ã«è³ªå•ã‚’è¡Œã„ã€ã¾ãŸã¯ãã®è³ªå•ã«å¯¾ã™ã‚‹ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å¿œç­”ã‚’è¡Œã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€é™ã‚‰ã‚ŒãŸè³ªå•ã‚’é€šã˜ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ã¨ã„ã†èª²é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚è³ªå•è€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç­”ãˆã‚’å…ƒã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®è³ªå•ã‚’å‡ºã—ã€å›ç­”è€…ã¯ä¸ãˆã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’è¡Œã„ã¾ã™ã€‚

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: GoogleãŒé–‹ç™ºã—ãŸGemmaã¨ã„ã†PyTorchã§å®Ÿè£…ã•ã‚ŒãŸå› æœãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€è‡ªç„¶è¨€èªå‡¦ç†ã«ãŠã‘ã‚‹ç”Ÿæˆã‚¿ã‚¹ã‚¯ã‚’æ‰±ã„ã¾ã™ã€‚Gemmaã®è¨­å®šã‚„ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®æ§‹æˆãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

2. **PyTorch**: ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æ¨è«–ã®ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¦ãŠã‚Šã€GPUï¼ˆCUDAï¼‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¤§è¦æ¨¡ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã®ç”Ÿæˆã‚¿ã‚¹ã‚¯ã‚’åŠ¹ç‡çš„ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

3. **è¦³å¯Ÿã‚¯ãƒ©ã‚¹**: ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®`obs`ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆè³ªå•ã€å›ç­”ã€æ¨æ¸¬ï¼‰ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚«ãƒ†ã‚´ãƒªã€è³ªå•ãƒªã‚¹ãƒˆã€å¿œç­”ãƒªã‚¹ãƒˆãªã©ã®å±æ€§ã‚’æŒã¡ã¾ã™ã€‚ã“ã‚Œã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒçŠ¶æ…‹ã‚’ç®¡ç†ã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

4. **ã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆ**: `GemmaFormatter`ã‚„ã€è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å„ã‚¯ãƒ©ã‚¹ã¯ã€ã‚²ãƒ¼ãƒ ã®é€²è¡Œã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€å¯¾è©±ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã™ã€‚

5. **ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨å‡ºåŠ›ã®èª¿æ•´**: è³ªå•ã¨æ¨æ¸¬ã®ç”Ÿæˆéç¨‹ã§ã¯ã€æ¸©åº¦ã‚„ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã¨ã„ã£ãŸãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚è¨­å®šã•ã‚Œã¦ãŠã‚Šã€ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã®å¤šæ§˜æ€§ãŒåˆ¶å¾¡ã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€æŠ½è±¡åŒ–ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹æ§‹é€ ã‚’é€šã˜ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ã¤ã¤ã€æˆ¦ç•¥çš„ã«è³ªå•ã‚„æ¨æ¸¬ã‚’è¡Œã†èƒ½åŠ›ãŒç™ºæ®ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
"""
ã‚ãªãŸã®æå‡ºã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ 
é­”æ³•ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã€pyãƒ•ã‚¡ã‚¤ãƒ«ã¨æå‡ºã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚
ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ å€¤ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã‚‹obsã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æœ€å¾Œã«è¿½åŠ ã—ã¾ã™ã€‚
GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ã‚’æœ‰åŠ¹ã«ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚
ä»¥ä¸‹ã«å‚ç…§ç”¨ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚
"""
```

---The following area is a Markdown cell (cell numver is 2)---
```markdown
## ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¾‹
ãƒ†ã‚¹ã‚¿ãƒ¼ã‚’æ—©ãè¦‹ã‚‹ãŸã‚ã«2bã«å¤‰æ›´ã•ã‚ŒãŸã ã‘ã§ã™ã€‚ 


https://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebook?kernelSessionId=178755035
```

---The following area is a Code cell (cell numver is 3)---
```python
%%bash
cd /kaggle/working
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 4)---
```python
#%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã“ã®ã‚ˆã†ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ãŠã‚ˆã³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã‚³ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable


class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    def __repr__(self):
        return self._state

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self

    def reset(self):
        self._state = ""
        if self._system_prompt is not None:
            self.user(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©
import re


@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """ä¸ãˆã‚‰ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)


class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant

        with _set_default_tensor_type(model_config.get_dtype()):
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError


def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        if obs.turnType == 'ask':
            self.formatter.user("ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
        elif obs.turnType == 'guess':
            self.formatter.user("ä»Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„ã€‚äºˆæƒ³ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"è³ªå•ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã¨ã‚«ãƒ†ã‚´ãƒª{obs.category}ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã¦ãã ã•ã„ã€‚å›ç­”ã¯äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ã®ã¯ã„ã¾ãŸã¯ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã¾ãšã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ã§ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£ã§ã™ï¼",
]


# **é‡è¦:** ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã—ã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ (OOM) ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None


def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent


def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)
    if response is None or len(response) <= 1:
        return "ã¯ã„"
    else:
        return response
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ
```

---The following area is a Code cell (cell numver is 6)---
```python
# !apt install pigz pv > /dev/null
# !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
## ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

ã“ã‚Œã¯è³ªå•è€…ã¨æ¨æ¸¬è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é©ç”¨ã•ã‚Œã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
class obs(object):
    '''
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã‚²ãƒ¼ãƒ ã‹ã‚‰ã®è¦³å¯Ÿã‚’è¡¨ã—ã¾ã™ã€‚ 
    turnTypeã¯['ask','answer','guess']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    ãƒ†ã‚¹ãƒˆã—ãŸã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    è³ªå•ã¯æ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«è³ªå•ã®å±¥æ­´ã‚’æ¸¡ã™å ´åˆã¯ã“ã‚Œã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    å›ç­”ã‚‚æ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«è³ªå•ã‚’æ¸¡ã™ãŸã‚ã« response ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    '''
    def __init__(self, turnType, keyword, category, questions, answers):
        self.turnType = turnType
        self.keyword = keyword
        self.category = category
        self.questions = questions
        self.answers = answers

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¸¡ã™obsã®ä¾‹ã€‚ã“ã¡ã‚‰ã«è‡ªåˆ†ã®obsã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚
obs1 = obs(turnType='ask', 
          keyword='paris', 
          category='place', 
          questions=['ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ'], 
          answers=['ã„ã„ãˆ', 'ã¯ã„', 'ã„ã„ãˆ', 'ã¯ã„'])

question = agent_fn(obs1, None)
print(question)

# å‡ºåŠ›ã¨ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®å¿œç­”ã‚’å¾—ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ 
# ã“ã‚Œã¯æå‡ºã‚¨ãƒ©ãƒ¼ã«å½¹ç«‹ã¡ã¾ã›ã‚“ãŒã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’è©•ä¾¡ã™ã‚‹ã®ã«ã¯å½¹ç«‹ã¡ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 9)---
```python
obs2 = obs(turnType='guess', 
          keyword='paris', 
          category='place', 
          questions=['ãã‚Œã¯äººã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ', 'ãã‚Œã¯éƒ½å¸‚ã§ã™ã‹ï¼Ÿ', 'ãã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãŸãã•ã‚“ã®é›¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ'], 
          answers=['ã„ã„ãˆ', 'ã¯ã„', 'ã„ã„ãˆ', 'ã¯ã„', 'ã„ã„ãˆ'])

agent_fn(obs2, None)
```

** @@@ Jupyter Notebook numver 44, the number of votes :3 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€`dictionaryapi`ã‚’åˆ©ç”¨ã—ã¦ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å®šç¾©ã‚’å–å¾—ã—ã€ã“ã‚Œã‚‰ã®å®šç¾©ã‚’åŸºã«ä»¥ä¸‹ã®ç›®çš„ã‚’é”æˆã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ï¼š

1. **ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã®è‰¯è³ªãªè³ªå•ã®ç”Ÿæˆ**: æ—¢çŸ¥ã®å›ç­”ã‚’æŒã¤è³ªå•ã‚’ä½œæˆã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æ´»ç”¨ã—ã¾ã™ã€‚
2. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰â€œthingsâ€ã®ç†è§£ä¿ƒé€²**: ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä½•ã§ã‚ã‚‹ã‹ã‚’ã‚ˆã‚Šæ·±ãç†è§£ã—ã€é–¢é€£ã™ã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å¢—ã‚„ã—ã¾ã™ã€‚
3. **å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã®æƒ…å ±æä¾›**: `answerer`ã¨ã„ã†å½¹å‰²ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¯¾ã—ã¦ã€ã‚ˆã‚Šå¤šãã®æƒ…å ±ã‚’ä¸ãˆã€æ­£ç¢ºãªå¿œç­”ã‚’å¼•ãå‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ã¯ã€ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã¨æ‰‹æ³•ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼š

- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `pandas`, `requests`, `json`, `jq`, `random`ã‚’ä½¿ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
- **APIã‚¢ã‚¯ã‚»ã‚¹**: `dictionaryapi`ã®REST APIã‚’ä»‹ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å®šç¾©ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: å–å¾—ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’`jq`ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã€å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ã¾ãŸã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’æŒã¤å®šç¾©ç”Ÿæˆå™¨ã‚’å®šç¾©ã—ã€æ™‚é–“åˆ¶é™ã‚’è¨­ã‘ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å›é¿ã—ã¦ã„ã¾ã™ã€‚

æœ€çµ‚çµæœã¯ã€ç‰©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹å®šç¾©ã‚’å«ã‚€`things_definitions.json`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã®çµæœã‚’ç”¨ã„ã¦ã€è³ªå•ç”Ÿæˆã‚„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æƒ…å ±æä¾›ã«ãŠã„ã¦ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªæˆ¦ç•¥ãŒå®Ÿç¾ã§ãã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€`dictionaryapi`ã‚’ä½¿ç”¨ã—ã¦ã€[ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³](https://www.kaggle.com/competitions/llm-20-questions)ã«æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å®šç¾©ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚  
ç›®æ¨™ã¯ã€ã“ã‚Œã‚‰ã®å®šç¾©ã‚’åˆ©ç”¨ã—ã¦ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã†ã“ã¨ã§ã™ï¼š
1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç›®çš„ã®ãŸã‚ã«ã€æ—¢çŸ¥ã®å›ç­”ã‚’æŒã¤ï¼ˆè‰¯ã„ï¼‰è³ªå•ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨
2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰`things`ãŒä½•ã§ã‚ã‚‹ã‹ã‚’ã‚ˆã‚Šã‚ˆãç†è§£ã—ã€ã‚ˆã‚Šå¤šãç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨
3. `answerer`ã¨ã„ã†å½¹å‰²ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚Šå¤šãã®æƒ…å ±ã‚’æä¾›ã—ã€ã‚ˆã‚Šæ­£ç¢ºã«å¿œç­”ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ï¼ˆRAG ?ï¼‰

çµæœã¯`things_definitions.json`ã«ä¿å­˜ã—ã¾ã™ã€‚  
æ³¨æ„ï¼š
- ä¸€éƒ¨ã®å˜èªã«ã¯è¤‡æ•°ã®å®šç¾©ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹: `Plate`ã«ã¯å¤šãã®æ„å‘³ãŒã‚ã‚Šã¾ã™ï¼‰
- ã»ã¨ã‚“ã©ã®äºŒã¤ä»¥ä¸Šã®éƒ¨åˆ†ã‹ã‚‰ãªã‚‹å˜èªï¼ˆä¾‹: `Air compressor`ï¼‰ã«ã¯dictionaryapiã«ã¯å®šç¾©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã„ãã¤ã‹ã®äºŒéƒ¨åˆ†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯å®šç¾©ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹: `Contact lenses`ï¼‰ã€‚
- ã»ã¨ã‚“ã©ã®ä¸€å˜èªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°‘ãªãã¨ã‚‚ä¸€ã¤ã®å®šç¾©ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹å¤–: RV, IV,...ï¼‰
```

---The following area is a Code cell (cell numver is 2)---
```python
%%capture
!pip install jq
```

---The following area is a Code cell (cell numver is 3)---
```python
import pandas as pd
import requests
import json
import time
import jq
import random
```

---The following area is a Code cell (cell numver is 4)---
```python
keywords = pd.read_csv("/kaggle/input/llm-20-questions-games-dataset/keywords.csv", index_col=0)
keywords
```

---The following area is a Code cell (cell numver is 5)---
```python
%run /kaggle/input/llm-20-questions/llm_20_questions/keywords.py
keywords_old:set[str] = {details["keyword"] for category in json.loads(KEYWORDS_JSON) for details in category["words"]}
# ç¾åœ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã†ã¡ã€ã€Œplaceã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å±ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã€ä»¥å‰ã®jsonã«å«ã¾ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã—ã¾ã™
# [w for w in keywords.loc[keywords.category=="place","keyword"] if w not in keywords_old]
keywords_place = set(keywords.loc[keywords.category=="place","keyword"])
print(f"ç¾åœ¨ã®å ´æ‰€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»¥å‰ã®jsonã«ãªã„ï¼‰: {keywords_place-keywords_old}")
print(f"ä»¥å‰ã®å ´æ‰€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¾åœ¨ã«ãªã„ï¼‰: {keywords_old-keywords_place}")
del keywords_place, keywords_old
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
# ç‰©ã®å®šç¾©
```

---The following area is a Code cell (cell numver is 7)---
```python
keywords[keywords.category=="things"]
```

---The following area is a Code cell (cell numver is 8)---
```python
url_api = "https://api.dictionaryapi.dev/api/v2/entries/en/{word}"
# APIãƒ†ã‚¹ãƒˆ
r = requests.get(url_api.format(word="Zinc"))
r.status_code
```

---The following area is a Code cell (cell numver is 9)---
```python
r.json()
```

---The following area is a Code cell (cell numver is 10)---
```python
# JSONã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®jqã®ä¾‹
jq.compile('select(length > 0) []["meanings"]').input_value(r.json()).first()
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
## bashã§ã®ä»£æ›¿
jqã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®JSONãƒ—ãƒ­ã‚»ãƒƒã‚µã§ã™
```

---The following area is a Code cell (cell numver is 12)---
```python
!curl "https://api.dictionaryapi.dev/api/v2/entries/en/{Wristband}" | jq '.[]["meanings"]'
```

---The following area is a Code cell (cell numver is 13)---
```python
!curl "https://api.dictionaryapi.dev/api/v2/entries/en/{Plate}" | jq '.[]'
```

---The following area is a Code cell (cell numver is 14)---
```python
keywords.loc[keywords.category=="things","keyword"].str.len().max()
```

---The following area is a Code cell (cell numver is 15)---
```python
# å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®å®šç¾©
with open("/kaggle/input/20questions-keywords-things-definitions/things_definitions.json","r") as f:
    keywords_definitions = json.load(f)

print(len(keywords_definitions), "ã®ç‰©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç·æ•°")
keywords_definitions = {k:v for k,v in keywords_definitions.items() if len(v)>0}
print(len(keywords_definitions) , "ãŒè¦‹ã¤ã‹ã£ãŸå®šç¾©ã‚’æŒã¤")

next(iter(keywords_definitions.items()))
```

---The following area is a Code cell (cell numver is 16)---
```python
%%time
def definition_generator():
    fail=0
    for num, keyword in enumerate(keywords.loc[keywords.category=="things","keyword"]):
        r = requests.get(url_api.format(word=keyword))
        if keyword in keywords_definitions:
            yield keyword, keywords_definitions[keyword]
            continue
        if r.status_code != 200:
            print(f"ã‚¨ãƒ©ãƒ¼ {r.status_code=} {keyword = :30} å¤±æ•—ç‡:{fail/num:.2%}")
            yield keyword, []
            fail+=1
            continue
        try:
            yield keyword, jq.compile('select(length > 0) []["meanings"]').input_value(r.json()).first()
        except (ValueError, JSONDecodeError) as e:
            print(f"{type(e).__name__} {e} ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æä¸­ {keyword = } å¤±æ•—ç‡:{fail/num:.2%})")
            print(e)
            fail+=1
            yield keyword, []
        time.sleep(1+random.random()/2) # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é¿ã‘ã‚‹ãŸã‚ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€Ÿåº¦ã‚’ã‚†ã£ãã‚Šã«ã™ã‚‹
    print(f"{fail=} ({fail/num:.2%})")

things_definitions={keyword: definitions for keyword, definitions in definition_generator()}
len(things_definitions)
```

---The following area is a Markdown cell (cell numver is 17)---
```markdown
# çµæœ
& ä¿å­˜
```

---The following area is a Code cell (cell numver is 18)---
```python
with open("things_definitions.json","w") as f:
    json.dump(things_definitions,f)
things_definitions
```

** @@@ Jupyter Notebook numver 45, the number of votes :2 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã§ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã¨å®Ÿè¡Œã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€4ã¤ã®ç•°ãªã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã—ã€ãã‚Œã‚‰ãŒæ§˜ã€…ãªã‚«ãƒ†ã‚´ãƒªï¼ˆé›»å­æ©Ÿå™¨ã€é£Ÿå“ã€ä¹—ã‚Šç‰©ã€å›½ï¼‰ã«é–¢é€£ã™ã‚‹è³ªå•ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚

### ä¸»ãªå•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’æ¨¡å€£ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã«é–¢é€£ã—ã¦ãŠã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«è³ªå•ã‚’è¡Œã†ã‹ã€ã¾ãŸãã®å›ç­”ã«ã‚ˆã£ã¦æ¬¡ã®è³ªå•ã‚’æ±ºå®šã™ã‚‹ã‹ã‚’æ‰±ã£ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨æ‰‹æ³•
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…**: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¯¾ã™ã‚‹è³ªå•ã‚’æŒã¡ã€ãã®è³ªå•ã«åŸºã¥ã„ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’çµã‚Šè¾¼ã‚€ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œè³ªå•ã‚’ã™ã‚‹ã€ã€ã€Œæ¨æ¸¬ã™ã‚‹ã€ã€ã€Œå›ç­”ã™ã‚‹ã€ã¨ã„ã†ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦ç•°ãªã‚‹è¡Œå‹•ã‚’å–ã‚Šã¾ã™ã€‚
- **ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**: ã‚«ãƒ†ã‚´ãƒªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦é–¢é€£ä»˜ã‘ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã®é–¢æ•°`is_related`ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **NumPy**: æ•°å€¤è¨ˆç®—ã«ä½¿ç”¨ã€‚
- **Pandas**: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ“ä½œã«ä½¿ç”¨ã€‚
- **Kaggle Environments**: ã‚²ãƒ¼ãƒ ç’°å¢ƒã‚’ä½œæˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨æ¸¬ã‚„å¯¾æˆ¦ã®çµæœãŒåé›†ã•ã‚Œã¾ã™ã€‚

### å®Ÿè¡Œã¨æå‡ºæº–å‚™
ã‚²ãƒ¼ãƒ ã®ç’°å¢ƒã‚’ä½œæˆã—ã€å®šç¾©ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ã¾ãŸã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã€æå‡ºç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹æº–å‚™ã‚’æ•´ãˆã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè¡Œã®æµã‚Œã‚’ç¤ºã—ã¦ãŠã‚Šã€ç‰¹ã«æˆ¦ç•¥çš„ãªè³ªå•ã¨ç­”ãˆã®ç”Ÿæˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªè§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯ã€kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã“ã“ã§ã¯ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ (å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ Shift+Enter ã‚’æŠ¼ã—ã¾ã™)ã€å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€"Save & Run All" ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã¨å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ 
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ /kaggle/temp/ ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 2)---
```python
import random

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚«ãƒ†ã‚´ãƒªã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
def is_related(keyword, category_keywords):
    return keyword.lower() in category_keywords

# ã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
electronics_keywords = {"ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³", "ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—", "ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ", "ãƒ†ãƒ¬ãƒ“"}
food_keywords = {"ãƒ”ã‚¶", "ãƒãƒ¼ã‚¬ãƒ¼", "å¯¿å¸", "ãƒ‘ã‚¹ã‚¿"}
vehicles_keywords = {"è»Š", "ãƒã‚¤ã‚¯", "é£›è¡Œæ©Ÿ", "ãƒœãƒ¼ãƒˆ"}
countries_keywords = {"æ—¥æœ¬", "ãƒ•ãƒ©ãƒ³ã‚¹", "ãƒ–ãƒ©ã‚¸ãƒ«", "ã‚«ãƒŠãƒ€"}

def simple_agent1(obs, cfg):
    electronics_questions = [
        "ãã‚Œã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã™ã‹?", "ãã‚Œã¯ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ã§ã™ã‹?", 
        "ãã‚Œã¯ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã™ã‹?", "ãã‚Œã¯ãƒ†ãƒ¬ãƒ“ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(electronics_questions)
    elif obs.turnType == "guess": 
        response = "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, electronics_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent2(obs, cfg):
    food_questions = [
        "ãã‚Œã¯ãƒ”ã‚¶ã§ã™ã‹?", "ãã‚Œã¯ãƒãƒ¼ã‚¬ãƒ¼ã§ã™ã‹?", 
        "ãã‚Œã¯å¯¿å¸ã§ã™ã‹?", "ãã‚Œã¯ãƒ‘ã‚¹ã‚¿ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(food_questions)
    elif obs.turnType == "guess": 
        response = "ãƒ”ã‚¶"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, food_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent3(obs, cfg):
    vehicle_questions = [
        "ãã‚Œã¯è»Šã§ã™ã‹?", "ãã‚Œã¯ãƒã‚¤ã‚¯ã§ã™ã‹?", 
        "ãã‚Œã¯é£›è¡Œæ©Ÿã§ã™ã‹?", "ãã‚Œã¯ãƒœãƒ¼ãƒˆã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(vehicle_questions)
    elif obs.turnType == "guess": 
        response = "è»Š"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, vehicles_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent4(obs, cfg):
    country_questions = [
        "ãã‚Œã¯æ—¥æœ¬ã§ã™ã‹?", "ãã‚Œã¯ãƒ•ãƒ©ãƒ³ã‚¹ã§ã™ã‹?", 
        "ãã‚Œã¯ãƒ–ãƒ©ã‚¸ãƒ«ã§ã™ã‹?", "ãã‚Œã¯ã‚«ãƒŠãƒ€ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(country_questions)
    elif obs.turnType == "guess": 
        response = "æ—¥æœ¬"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, countries_keywords) else "**ã„ã„ãˆ**"
    return response
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚²ãƒ¼ãƒ ç’°å¢ƒã®ä½œæˆã¨è¨­å®š

Kaggleã®ç’°å¢ƒã¯ã€`make()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã€*ç’°å¢ƒ*å (`"llm_20_questions"`) ã¨ã€ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ*æ§‹æˆ*ã‚„*æƒ…å ±*ãªã©ï¼‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚ˆã†ã«ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import kaggle_environments
env = kaggle_environments.make(environment="llm_20_questions")
# ï¼ˆã€ŒNo pygame installedã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼‰
```

---The following area is a Code cell (cell numver is 5)---
```python
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯: ")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
print(" ")
print("ã„ãã¤ã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯ã€ä»£æ›¿ã®æ¨æ¸¬ï¼ˆaltsï¼‰ã®ãƒªã‚¹ãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚")
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä»£æ›¿ãƒªã‚¹ãƒˆã¯:")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.alts)
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
# LLM 20 Questions ã®å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ä½œæˆã—ãŸç’°å¢ƒ (`env`) ã§ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1" ï¼ˆãƒãƒ¼ãƒ 1ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ2" ï¼ˆãƒãƒ¼ãƒ 1ã®å›ç­”è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3" ï¼ˆãƒãƒ¼ãƒ 2ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ4" ï¼ˆãƒãƒ¼ãƒ 2ã®å›ç­”è€…ï¼‰ã€‚ 

ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¨å¯¾æˆ¦ã—ã€æ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ã®ã©ã¡ã‚‰ã‹ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
%%time
game_output = env.run(agents=[simple_agent1, simple_agent2, simple_agent3, simple_agent4])
```

---The following area is a Code cell (cell numver is 8)---
```python
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# æå‡ºå¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Pythonã‚³ãƒ¼ãƒ‰ã‚’main.pyã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’submission.tar.gzã«ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å…¬å¼ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ˆhttps://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebookï¼‰ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€å®Ÿéš›ã®LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯ã€æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªãŒã‹ã‹ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸã„å ´é¢ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
import os
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"
# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)
    subdirectory_path = os.path.join(submission_directory, submission_subdirectory)
    os.mkdir(subdirectory_path)
```

---The following area is a Code cell (cell numver is 11)---
```python
import os
import csv

# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®šç¾©
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"

# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)

# ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®Œå…¨ãªãƒ‘ã‚¹ã‚’å®šç¾©
subdirectory_path = os.path.join(submission_directory, submission_subdirectory)

# ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(subdirectory_path):
    os.mkdir(subdirectory_path)

# libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¾‹ç¤ºç”¨ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
with open(os.path.join(subdirectory_path, "example.csv"), mode='w') as file:
    writer = csv.writer(file)
    writer.writerow(["ç‰›", "é¦¬"])
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®main.py Pythonã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
* ç’°å¢ƒã¯main.pyã®æœ€å¾Œã®é–¢æ•°ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®å ´åˆã¯`agent_fun()`ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 13)---
```python
%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random



# æå‡º/libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ï¼‰ã‚’ç½®ãå ´åˆã¯ã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œä¸­ã®å ´åˆ
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§å®Ÿè¡Œä¸­ã®å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")
sys.path.insert(0, subdirectory_path)


# ä¾‹ç¤ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
with open(os.path.join(subdirectory_path,"example.csv"), mode='r') as file:
    reader = csv.reader(file)
    guess_list = list(reader)
    guess_list = guess_list[0]

# ä¾‹ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã "å‹•ç‰©"ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
animal = random.choice(guess_list)
    
# main.py ã®æœ€å¾Œã®é–¢æ•°ãŒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã¨ãªã‚Šã¾ã™
def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnType ãŒ "ask" ã®å ´åˆ
    if obs.turnType == "ask":
        response = f'ãã‚Œã¯{animal}ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã‹?'
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnType ãŒ "guess" ã®å ´åˆ
    elif obs.turnType == "guess":
        if obs.answers[-1]=="yes":
            response = animal
        else:
            response = "ãƒšãƒ³ã‚®ãƒ³"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        if obs.keyword in obs.questions[-1]:
            response = "ã¯ã„"
        else:
            response = "ã„ã„ãˆ"
        
    return response
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
ã“ã®`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`/lib/example.csv`ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨å…±ã«æå‡ºã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
!apt install pigz pv > /dev/null
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 16)---
```python
game_output = env.run(agents=["/kaggle/working/submission/main.py", "/kaggle/working/submission/main.py", simple_agent3, simple_agent4])
env.render(mode="ipython", width=600, height=500)
```

** @@@ Jupyter Notebook numver 46, the number of votes :2 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã€ãƒ†ã‚¹ãƒˆã€ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨æ¸¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’Pythonã§å®šç¾©ã—ã€Kaggleã®ç’°å¢ƒã‚’ç”¨ã„ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè¡Œã«é–¢ã™ã‚‹å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé™ã‚‰ã‚ŒãŸè³ªå•ã®ä¸­ã§æ­£ã—ã„å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã‚¹ã‚­ãƒ«ã‚’æŒã¤ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œaskã€ã€Œguessã€ã€Œanswerã€ã®3ã¤ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•
1. **ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ**:
    - 4ã¤ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ`simple_agent1`, `simple_agent2`, `simple_agent3`, `simple_agent4`ï¼‰ãŒå®šç¾©ã•ã‚Œã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å›ºå®šã®è³ªå•ã‚’è¡Œã„ã€æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚

2. **ç’°å¢ƒã®æ§‹ç¯‰**:
    - `kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ã€Œllm_20_questionsã€ã®ç’°å¢ƒã‚’ä½œæˆã—ã€æ¨æ¸¬ã«å¿…è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

3. **ã‚²ãƒ¼ãƒ ã®å®Ÿè¡Œ**:
    - `env.run()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ä½œæˆã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”¨ã„ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    - å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚„ã‚²ãƒ¼ãƒ ã®çµæœã‚’åé›†ã™ã‚‹ãŸã‚ã®æ§‹é€ ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

4. **ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½**:
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ‡ãƒãƒƒã‚°æ‰‹æ³•ãŒå°å…¥ã•ã‚Œã¦ãŠã‚Šã€ã‚¿ãƒ¼ãƒ³ã”ã¨ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®çŠ¶æ…‹ã‚„åå¿œã‚’è©³ç´°ã«è¦³å¯Ÿã§ãã‚‹æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

5. **æå‡ºç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æº–å‚™**:
    - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’`main.py`ã¨ã—ã¦ä¿å­˜ã—ã€ãã®å‘¨è¾ºã«å¿…è¦ãªæƒ…å ±ã‚’æŒã£ãŸã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦æå‡ºã™ã‚‹æ‰‹é †ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- `kaggle_environments`: Kaggleã®ç«¶æŠ€ç’°å¢ƒã‚’ä½œæˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
- `csv`, `os`, `sys`: Pythonã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰±ã„ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è©¦ä½œã—ã€ã‚²ãƒ¼ãƒ ã‚’é€šã˜ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ç’°å¢ƒã®ãƒ’ãƒ³ãƒˆ: Notebookã§LLM 20 Questionsã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•

Kaggleã®ç’°å¢ƒã‚’ä½¿ç”¨ã—ã¦LLM 20 Questionsã‚„ãã®ä»–ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒãƒƒã‚°ã™ã‚‹éš›ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ç’°å¢ƒã‚’å®Ÿè¡Œã§ãã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚ä»¥ä¸‹ã«ã€å½¹ç«‹ã¤ãƒ’ãƒ³ãƒˆã‚„èª¬æ˜ã‚’ç¤ºã—ã¾ã™ã€‚

# ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹

å®Ÿé¨“ã ã‘ã—ãŸã„å ´åˆã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯Pythoné–¢æ•°ã¨ã—ã¦éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯äºŒã¤ã®å…¥åŠ›ï¼ˆobsã¨cfgï¼‰ã‚’æŒã¤é–¢æ•°ã§ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ä¸‰ã¤ã®turnTypesï¼ˆã€Œaskã€ã€ã€Œguessã€ã€ã€Œanswerã€ï¼‰ã‚’å‡¦ç†ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã€Œanswerã€ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã«å››ã¤ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç¤ºã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
def simple_agent1(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent2(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯é³¥ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "é³¥"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent3(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯è±šã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "è±š"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response

def simple_agent4(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ç‰›ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ç‰›"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    return response
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚²ãƒ¼ãƒ ç’°å¢ƒã®ä½œæˆã¨æ§‹æˆ

Kaggleã®ç’°å¢ƒã¯ã€`make()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦*ç’°å¢ƒ*åï¼ˆ`"llm_20_questions"`ï¼‰ã¨ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ*configuration*ã‚„*info*ãªã©ï¼‰ã‚’æŒ‡å®šã—ã¦ä½œæˆã•ã‚Œã¾ã™ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚ˆã†ã«ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import kaggle_environments
env = kaggle_environments.make(environment="llm_20_questions")
# ï¼ˆ"No pygame installed"ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã§ãã¾ã™ï¼‰
```

---The following area is a Markdown cell (cell numver is 5)---
```markdown
ç’°å¢ƒã‚’åˆæœŸåŒ–ã™ã‚‹ã¨ã€å½“ã¦ã‚‹ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’`kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword`ã§ç¢ºèªã—ãŸã‚Šå¤‰æ›´ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 6)---
```python
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯: ")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
print(" ")
print("ä¸€éƒ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯ã€å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ä»£æ›¿æ¨æ¸¬ï¼ˆaltsï¼‰ã®ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚")
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€altsã®ãƒªã‚¹ãƒˆã¯:")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.alts)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# LLM 20 Questionsã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ä½œæˆã—ãŸç’°å¢ƒï¼ˆ`env`ï¼‰ã§ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
* "Agent1"ï¼ˆãƒãƒ¼ãƒ 1ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "Agent2"ï¼ˆãƒãƒ¼ãƒ 1ã®å›ç­”è€…ï¼‰ã€ 
* "Agent3"ï¼ˆãƒãƒ¼ãƒ 2ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "Agent4"ï¼ˆãƒãƒ¼ãƒ 2ã®å›ç­”è€…ï¼‰ã€‚ 

ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¨ãƒšã‚¢ã«ãªã‚Šã€æ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

ï¼ˆã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å§‹ã‚ãŸå½“åˆã€ç§ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒãƒ¼ãƒ ã®ãŸã‚ã«æ¨æ¸¬è€…ã¨å›ç­”è€…ã®ä¸¡æ–¹ã®å½¹å‰²ã‚’æœãŸã™ã¨æ€ã„è¾¼ã‚“ã§ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ä»–ã®èª°ã‹ã¨ãƒšã‚¢ã«ãªã‚Šã¾ã™ã€‚æˆåŠŸã™ã‚‹ã‹å¤±æ•—ã™ã‚‹ã‹ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®å”åŠ›ã«ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ï¼‰
```

---The following area is a Code cell (cell numver is 8)---
```python
%%time
game_output = env.run(agents=[simple_agent1, simple_agent2, simple_agent3, simple_agent4])
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
ã“ã®ä¾‹ã§ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå³åº§ã«å¿œç­”ã™ã‚‹ãŸã‚ã€ã‚²ãƒ¼ãƒ ã¯ã™ãã«çµ‚äº†ã—ã¾ã™ã€‚å¤§è¦æ¨¡ãªLLMã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ãŸå®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã«1åˆ†ã‹ã‹ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ç·ã‚²ãƒ¼ãƒ æ™‚é–“ã¯1æ™‚é–“ã«é”ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å„ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã¯`game_output`ã§ç¢ºèªã§ãã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ã‚’è¦–è¦šçš„ã«è¦³å¯Ÿã—ãŸã„å ´åˆã¯ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
# æå‡ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ

ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Pythonã‚³ãƒ¼ãƒ‰ã‚’`main.py`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã€ãã‚Œã‚’ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€ç·’ã«`submission.tar.gz`ã«ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å…¬å¼ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ˆhttps://www.kaggle.com/code/muhammadehsan000/llm-20-questions-starterï¼‰ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ãªãƒªã‚¢ãƒ«ãªLLMã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚ˆã‚Šå¤šãã®æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã§ã™ã®ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã¨ã—ã¦LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã«ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç½®ãã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

* `/kaggle/working/submission`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ããŸã‚ã®`lib`ã¨ã„ã†ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 12)---
```python
import os
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"

# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)
    subdirectory_path = os.path.join(submission_directory, submission_subdirectory)
    os.mkdir(subdirectory_path)
```

---The following area is a Code cell (cell numver is 13)---
```python
# libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹ä¾‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
import csv
with open(os.path.join(subdirectory_path, "example.csv"), mode='w') as file:
    writer = csv.writer(file)
    writer.writerow(["ç‰›", "é¦¬"])
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®main.pyã®Pythonã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
* ç’°å¢ƒã¯main.pyã®æœ€å¾Œã®é–¢æ•°ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®å ´åˆã¯`agent_fun()`ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random


# æå‡º/libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ï¼‰ã‚’ç½®ãå ´åˆã¯ã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")
sys.path.insert(0, subdirectory_path)


# ä¾‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
with open(os.path.join(subdirectory_path, "example.csv"), mode='r') as file:
    reader = csv.reader(file)
    guess_list = list(reader)
    guess_list = guess_list[0]

# ä¾‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªã€Œå‹•ç‰©ã€ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
animal = random.choice(guess_list)
    
# main.pyå†…ã®æœ€å¾Œã®é–¢æ•°ãŒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã¨ãªã‚Šã¾ã™
def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask":
        response = f'ãã‚Œã¯{animal}ã®ã‚ˆã†ã§ã™ã‹ï¼Ÿ'
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"guess"ã®å ´åˆ
    elif obs.turnType == "guess":
        if obs.answers[-1] == "yes":
            response = animal
        else:
            response = "ãƒšãƒ³ã‚®ãƒ³"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        if obs.keyword in obs.questions[-1]:
            response = "yes"
        else:
            response = "no"
        
    return response
```

---The following area is a Markdown cell (cell numver is 16)---
```markdown
ã“ã®`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`/lib/example.csv`ã®ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€ç·’ã«æå‡ºã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 17)---
```python
!apt install pigz pv > /dev/null
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Markdown cell (cell numver is 18)---
```markdown
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰ã€Team 1ã®ä¸¡æ–¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦`main.py`å†…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã€Team 2ã«ã¯simple_agent3ã¨simple_agent4ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 19)---
```python
game_output = env.run(agents=["/kaggle/working/submission/main.py", "/kaggle/working/submission/main.py", simple_agent3, simple_agent4])
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 20)---
```markdown
# ãƒ‡ãƒãƒƒã‚°ã®ãƒ’ãƒ³ãƒˆ

è¨­è¨ˆã‚„ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã†ã¨ãã¯ã€é€šå¸¸ã€ç’°å¢ƒã‚’ä½œæˆã™ã‚‹éš›ã«ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã‚’å¤‰æ›´ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š

`env = make(environment, configuration=None, info=None, steps=None, logs=None, debug=False, state=None)`

`env.specification`ã§ä»•æ§˜ã‚’ç¢ºèªã—ã¦ã€ç’°å¢ƒå†…ã§å®šç¾©ã•ã‚ŒãŸ`configuration`ã‚„ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚èª¬æ˜ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

æ–°ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ä½œæ¥­ã™ã‚‹éš›ã¯ã€çŸ­ã„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ§‹æˆã‚’å¤‰æ›´ã—ã€`debug=True`ã«è¨­å®šã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œã‚‹è©³ç´°ãªæƒ…å ±ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ãƒ‡ãƒãƒƒã‚°ã«é©ã—ãŸæ–°ã—ã„ç’°å¢ƒã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 21)---
```python
# ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã€2ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã¿ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™
debug_config = {'episodeSteps': 7,     # åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã«åŠ ãˆã¦å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®3ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆask/answer/guessï¼‰
                'actTimeout': 5,       # å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯60ç§’ï¼‰
                'runTimeout': 60,      # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1200ç§’ï¼‰
                'agentTimeout': 3600}  # å»ƒæ­¢ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3600ï¼‰

env = kaggle_environments.make("llm_20_questions", configuration=debug_config, debug=True)
```

---The following area is a Markdown cell (cell numver is 22)---
```markdown
æ³¨æ„ã—ã¦ãã ã•ã„ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã§ã«å½“ã¦ã‚‹ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦åˆ¥ã®ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€åŒã˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼
```

---The following area is a Code cell (cell numver is 23)---
```python
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
```

---The following area is a Markdown cell (cell numver is 24)---
```markdown
ãƒ‡ãƒãƒƒã‚°ä¸­ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§è¨­å®šã—ãŸã‚Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 25)---
```python
keyword = "ã‚¢ãƒ’ãƒ«"
alts = ["ãã®ã‚¢ãƒ’ãƒ«","ã‚¢ãƒ’ãƒ«"]
kaggle_environments.envs.llm_20_questions.llm_20_questions.category = "ä¾‹"
kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword_obj = {'keyword': keyword, 'alts': alts}
kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword = keyword
kaggle_environments.envs.llm_20_questions.llm_20_questions.alts = alts
```

---The following area is a Markdown cell (cell numver is 26)---
```markdown
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ‡ãƒãƒƒã‚°ç”¨ã®æƒ…å ±ã‚’å°åˆ·ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚simple agent 1ã«`obs`ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹printæ–‡ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 27)---
```python
def simple_verbose_agent1(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§turnTypeãŒ"guess"ã®å ´åˆ
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"
    
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å°åˆ·
    print("====================")
    print(f"step = {obs.step}")
    print(f"turnType = {obs.turnType}")
    print("obs =")
    print(obs)
    print(" ")
    print(f'response = "{response}"')
    
    
    return response
```

---The following area is a Markdown cell (cell numver is 28)---
```markdown
ã“ã®simple_verbose_agent1ã‚’Team 1ã®ä¸¡æ–¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã¨ã€3ã¤ã®ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆask/guess/answerï¼‰ã®æƒ…å ±ã‚’è¦³å¯Ÿã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 29)---
```python
game_output = env.run(agents=[simple_verbose_agent1, simple_verbose_agent1, simple_agent3, "/kaggle/working/submission/main.py"])
```

---The following area is a Code cell (cell numver is 30)---
```python
env.render(mode="ipython", width=600, height=500)
```

** @@@ Jupyter Notebook numver 47, the number of votes :2 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€å˜ç´”ãªãƒœãƒƒãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒœãƒƒãƒˆã®è¨­è¨ˆã¯éå¸¸ã«åŸºæœ¬çš„ã§ã‚ã‚Šã€ä¸»ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ï¼š

1. **è³ªå•ã®ä¸€è²«æ€§**: ãƒœãƒƒãƒˆã¯å¸¸ã«ã€Œãã‚Œã¯ç‰©ã‹å ´æ‰€ã‹ï¼Ÿã€ã¨ã„ã†è³ªå•ã‚’è¡Œã„ã¾ã™ã€‚
2. **å˜èªã®æ¨æ¸¬**: `keywords.py`ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸå˜èªã‚’æ¨æ¸¬ã—ã¾ã™ã€‚
3. **å›ç­”ã®ä»•æ§˜**: ãƒœãƒƒãƒˆã¯å¸¸ã«ã€Œã„ã„ãˆã€ã¨å›ç­”ã—ã¾ã™ã€‚

Notebooã®æ¦‚è¦ã§ã¯ã€Gemmaãƒ¢ãƒ‡ãƒ«ãŒä¸€è²«æ€§ã«æ¬ ã‘ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¹ã‚³ã‚¢ï¼ˆLBï¼‰ãŒç´„635.5ã§æ¨ç§»ã—ã¦ã„ã‚‹ã“ã¨ãŒè¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ä½¿ç”¨ã—ã¦ã„ã‚‹ä¸»ãªæ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
- **Python**: ä¸»ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€‚
- **JSON**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **os**ã€**sys**ã€**glob**ã€**random**: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚„ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã®ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒœãƒƒãƒˆã¯ã€æŒ‡å®šã—ãŸãƒ‘ã‚¹ã«ã‚ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã€ãã®æƒ…å ±ã‚’åŸºã«è¿”ç­”ã‚’è¡Œã†ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ã‚’ã¨ã£ã¦ã„ã¾ã™ã€‚ãƒœãƒƒãƒˆã®å‡ºåŠ›ã¯ã€æœ€çµ‚çš„ã«`/kaggle/working/submission.tar.gz`ã«æ›¸ãè¾¼ã¾ã‚Œã€ã“ã‚ŒãŒã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¸ã®æå‡ºç‰©ã¨ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã«ã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€å†…å®¹ãŒåˆå¿ƒè€…ã«å½¹ç«‹ã¤ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ãŒå¼·èª¿ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# å¯èƒ½ãªé™ã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªæå‡ºç‰© (LB: ç´„651.4)
ãƒœãƒƒãƒˆã‚’`/kaggle/working/submission.tar.gz`ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚ã“ã®ãƒœãƒƒãƒˆã¯æ¬¡ã®ã“ã¨ã‚’è¡Œã„ã¾ã™:
- å¸¸ã«**å ´æ‰€ã‹ç‰©å“ã‹ã‚’èã**
- `keywords.py`ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªå˜èªã‚’**æ¨æ¸¬ã™ã‚‹**
- å¸¸ã«**ã„ã„ãˆã¨ç­”ãˆã‚‹**

Gemmaãƒ¢ãƒ‡ãƒ«ã¯ç¾åœ¨ã‚ã¾ã‚Šä¸€è²«æ€§ãŒãªãã€LBã¯ç´„635.5ã§æ¨ç§»ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
!cd /kaggle/working
!mkdir submission
!readlink -f *
```

---The following area is a Code cell (cell numver is 3)---
```python
# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
!cp /kaggle/input/llm-20-questions/llm_20_questions/keywords.py submission/keywords.py
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile submission/main.py

import os, sys, glob, random, json

from keywords import KEYWORDS_JSON
kws = json.loads(KEYWORDS_JSON)[0]  # KEYWORDS_JSONã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€æœ€åˆã®é …ç›®ã‚’å¤‰æ•°kwsã«æ ¼ç´ã—ã¾ã™ã€‚

def agent_fn(obs, cfg):
    if obs.turnType == "ask": response = 'Is it a thing or a place?'  # è³ªå•ã®ã‚¿ã‚¤ãƒ—ãŒã€Œèãã€ã®å ´åˆã€è³ªå•æ–‡ã‚’è¨­å®šã—ã¾ã™ã€‚
    elif obs.turnType == "guess": response = random.choice(kws['words'])['keyword']  # è³ªå•ã®ã‚¿ã‚¤ãƒ—ãŒã€Œæ¨æ¸¬ã€ã®å ´åˆã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å˜èªã‚’é¸æŠã—ã¾ã™ã€‚
    elif obs.turnType == "answer": response = 'no'  # è³ªå•ã®ã‚¿ã‚¤ãƒ—ãŒã€Œç­”ãˆã‚‹ã€ã®å ´åˆã€å¸¸ã«ã€Œã„ã„ãˆã€ã¨è¿”ç­”ã—ã¾ã™ã€‚
    return response  # è¿”ç­”ã‚’è¿”ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar czf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 6)---
```python
!ls
!ls submission
```

---The following area is a Code cell (cell numver is 7)---
```python
import numpy as np
import pandas as pd
import os
for dirname, _, filenames in os.walk('/kaggle'):  # '/kaggle' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‚’å†å¸°çš„ã«æ¢ç´¢ã—ã¾ã™ã€‚
    for filename in filenames:
        print(os.path.join(dirname, filename))  # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨ãªãƒ‘ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 8)---
```python
!ls
!tar -xzvf submission.tar.gz 
!cat main.py  # main.pyã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
!ls
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ

> ## Yangtze Hao
> 
> åˆå¿ƒè€…ã«ã¨ã£ã¦éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã‚ã‚ŠãŒã¨ã†ï¼
> 

---

> ## Jonathan Harker
> 
> ã“ã‚Œã‚’ã‚ã‚ŠãŒã¨ã†ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨å‡ºåŠ›å½¢å¼ã‚’ç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚éå¸¸ã«æœ‰ç”¨ã§ã™ï¼
> 

---
```

** @@@ Jupyter Notebook numver 48, the number of votes :2 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‰¹å®šã®éš ã•ã‚ŒãŸå˜èªã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§å½“ã¦ã‚‹æ¨æ¸¬ã‚²ãƒ¼ãƒ ã§ã™ã€‚

### ä¸»ãªå†…å®¹ã¨æ‰‹æ³•:
1. **ã‚¯ãƒ©ã‚¹è¨­è¨ˆ**:
   - **Player**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åŸºæœ¬ã‚¯ãƒ©ã‚¹ã§ã€ãƒãƒ¼ãƒ åã‚’ç®¡ç†ã—ã¾ã™ã€‚
   - **Questioner**: è³ªå•è€…ã‚¯ãƒ©ã‚¹ã§ã€è³ªå•ã‚’è¡Œã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
   - **Guesser**: æ¨æ¸¬è€…ã‚¯ãƒ©ã‚¹ã§ã€éš ã•ã‚ŒãŸå˜èªã®æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚
   - **TwentyQuestionsGame**: ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã€è³ªå•ã€æ¨æ¸¬ã‚’ç®¡ç†ã—ã¾ã™ã€‚
   - **TwentyQuestions**: ã‚²ãƒ¼ãƒ å…¨ä½“ã‚’æ§‹æˆã—ã€è³ªå•ãƒªã‚¹ãƒˆã‚„å˜èªãƒªã‚¹ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

2. **ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†**:
   - ã‚²ãƒ¼ãƒ å†…ã§ä½¿ç”¨ã•ã‚Œã‚‹è³ªå•ã‚„å˜èªã¯ã€ãã‚Œãã‚Œãƒªã‚¹ãƒˆã¨ã—ã¦ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸã‚Šç”Ÿæˆã•ã‚ŒãŸã‚Šã—ã¾ã™ã€‚

3. **å®Ÿè¡Œãƒ•ãƒ­ãƒ¼**:
   - ã‚²ãƒ¼ãƒ ã¯20ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ãŸã£ã¦è¡Œã‚ã‚Œã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«è³ªå•ã¨æ¨æ¸¬ãŒè¡Œãªã‚ã‚Œã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã®çµæœã¯ã€è³ªå•ã®æ­£ç­”ã¨æ¨æ¸¬ã«åŸºã¥ã„ã¦æ±ºã¾ã‚Šã¾ã™ã€‚

4. **ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `numpy`ã‚„`pandas`ãªã©ã®åˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ãªåˆ©ç”¨ã¯è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ã“ã®Notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¨¡å€£ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€ã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã¯å¯¾è©±çš„ã§ã€Pythonã®æ¨™æº–å…¥åŠ›ã‚’åˆ©ç”¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚
# ã“ã‚Œã¯ã€kaggle/pythonã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã“ã“ã§ã¯ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã¨ (å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€Shift + Enterã‚’æŠ¼ã™ã“ã¨ã§) å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«æœ€å¤§20GBã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ã“ã‚Œã¯ã€ŒSave & Run Allã€ã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã¨ãã«å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ /kaggle/temp/ ã«ã‚‚æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ãŒã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
import random
import time

# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹ã®å®šç¾©
class Player:
    def __init__(self, team_name):
        self.team_name = team_name  # ãƒãƒ¼ãƒ åã®åˆæœŸåŒ–

# è³ªå•è€…ã‚¯ãƒ©ã‚¹ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿
class Questioner(Player):
    def ask_question(self, question):
        print(f"{self.team_name} ãŒè³ªå•ã—ã¾ã™: {question}")
        answer = input("ç­”ãˆ (ã¯ã„/ã„ã„ãˆ): ").strip().lower()  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç­”ãˆã‚’å°‹ã­ã‚‹
        return answer == "ã¯ã„"  # "ã¯ã„" ãªã‚‰Trueã‚’è¿”ã™

# æ¨æ¸¬è€…ã‚¯ãƒ©ã‚¹ã‚‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿
class Guesser(Player):
    def make_guess(self, guess):
        print(f"{self.team_name} ã®æ¨æ¸¬: {guess}")  # æ¨æ¸¬ã‚’è¡¨ç¤º

# 20ã®è³ªå•ã‚²ãƒ¼ãƒ ã®ã‚¯ãƒ©ã‚¹
class TwentyQuestionsGame:
    def __init__(self, team1_name, team2_name, hidden_word):
        self.team1_questioner = Questioner(team1_name)  # ãƒãƒ¼ãƒ 1ã®è³ªå•è€…
        self.team1_guesser = Guesser(team1_name)  # ãƒãƒ¼ãƒ 1ã®æ¨æ¸¬è€…
        self.team2_questioner = Questioner(team2_name)  # ãƒãƒ¼ãƒ 2ã®è³ªå•è€…
        self.team2_guesser = Guesser(team2_name)  # ãƒãƒ¼ãƒ 2ã®æ¨æ¸¬è€…
        self.hidden_word = hidden_word  # éš ã•ã‚ŒãŸå˜èª
        self.current_round = 0  # ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰
        self.team1_score = 0  # ãƒãƒ¼ãƒ 1ã®å¾—ç‚¹
        self.team2_score = 0  # ãƒãƒ¼ãƒ 2ã®å¾—ç‚¹

    def start_game(self):
        print(f"20ã®è³ªå•ã‚²ãƒ¼ãƒ ã¸ã‚ˆã†ã“ã!")
        print(f"éš ã•ã‚ŒãŸå˜èªã¯: {self.hidden_word} ã«é–¢é€£ã—ã¦ã„ã¾ã™")
        print("ã•ã‚ã€ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†!\n")

    def play_round(self):
        self.current_round += 1  # ãƒ©ã‚¦ãƒ³ãƒ‰ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
        print(f"ãƒ©ã‚¦ãƒ³ãƒ‰ {self.current_round}")

        # å„ãƒãƒ¼ãƒ ãŒè³ªå•ã‚’è¡Œã†
        team1_answer = self.team1_questioner.ask_question(self.generate_question())
        team2_answer = self.team2_questioner.ask_question(self.generate_question())

        # ã©ã¡ã‚‰ã‹ã®ãƒãƒ¼ãƒ ãŒç­”ãˆãŸå ´åˆã€ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹
        if team1_answer or team2_answer:
            self.end_game(winner=self.team1_questioner if team1_answer else self.team2_questioner)
        else:
            # ç­”ãˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€æ¨æ¸¬ã‚’è¡Œã†
            self.team1_guesser.make_guess(self.generate_guess())
            self.team2_guesser.make_guess(self.generate_guess())

    def end_game(self, winner):
        # å‹è€…ãŒèª°ã‹ã§å¾—ç‚¹ã‚’æ›´æ–°
        if winner == self.team1_questioner:
            self.team1_score += 1
        elif winner == self.team2_questioner:
            self.team2_score += 1

        print(f"{winner.team_name} ãŒãƒ©ã‚¦ãƒ³ãƒ‰ã«å‹ã¡ã¾ã—ãŸ!")
        print(f"ã‚¹ã‚³ã‚¢: {self.team1_score} - {self.team2_score}\n")

        # ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ãŒ20æœªæº€ã®å ´åˆã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹
        if self.current_round < 20:
            print("æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...\n")
            time.sleep(1)  # æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å§‹ã‚ã‚‹å‰ã«å°ã•ãªé…å»¶
            self.play_round()
        else:
            print("ã‚²ãƒ¼ãƒ çµ‚äº†! æœ€çµ‚ã‚¹ã‚³ã‚¢:")
            print(f"{self.team1_questioner.team_name}: {self.team1_score}")
            print(f"{self.team2_questioner.team_name}: {self.team2_score}")
            if self.team1_score > self.team2_score:
                print(f"{self.team1_questioner.team_name} ãŒã‚²ãƒ¼ãƒ ã«å‹ã¡ã¾ã—ãŸ!")
            elif self.team2_score > self.team1_score:
                print(f"{self.team2_questioner.team_name} ãŒã‚²ãƒ¼ãƒ ã«å‹ã¡ã¾ã—ãŸ!")
            else:
                print("å¼•ãåˆ†ã‘ã§ã™!")

    def generate_question(self):
        return random.choice(self.questions)["question"]  # ãƒ©ãƒ³ãƒ€ãƒ ã«è³ªå•ã‚’ç”Ÿæˆ

    def generate_guess(self):
        return random.choice(self.allwords)  # ãƒ©ãƒ³ãƒ€ãƒ ã«æ¨æ¸¬ã‚’ç”Ÿæˆ

# 20ã®è³ªå•ç”¨ã®è³ªå•ãƒªã‚¹ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
class TwentyQuestions:
    def __init__(self):
        # è³ªå•ã®ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
        self.questions = [
            {"question": "ãã‚Œã¯æ¦‚å¿µã§ã™ã‹ã€ç‰©ä½“ã§ã™ã‹ã€ãã‚Œã¨ã‚‚æ´»å‹•ã§ã™ã‹ï¼Ÿ", "category": "initial"},
            {"question": "ãã‚Œã¯æœ‰å½¢ã®ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã‹ï¼Ÿ", "category": "tangibility"},
            {"question": "ãã‚Œã¯ä¸»ã«å°‚é–€å®¶ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "usage"},
            {"question": "ãã‚Œã¯è´…æ²¢å“ã¨è¦‹ãªã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "value"},
            {"question": "ãã‚Œã¯é€šå¸¸å±‹å¤–ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "category": "location"},
            {"question": "ãã‚Œã«ã¯å‹•ãéƒ¨å“ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "category": "mechanics"},
            {"question": "ãã‚Œã¯ç¾ä»£æŠ€è¡“ã®ä¸€éƒ¨ã§ã™ã‹ï¼Ÿ", "category": "era"},
            {"question": "ãã‚Œã¯è»Šã‚ˆã‚Šã‚‚å¤§ãã„ã§ã™ã‹ï¼Ÿ", "category": "size"},
            {"question": "ãã‚Œã¯ç‰¹å®šã®æ¥­ç•Œã§ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "industry"},
            {"question": "ãã‚Œã¯å®¶åº­ã§ä¸€èˆ¬çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "common_usage"},
            {"question": "ãã‚Œã¯ä¸»ã«ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "function"},
            {"question": "ãã‚Œã¯ç¾çš„é­…åŠ›ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "category": "appearance"},
            {"question": "ãã‚Œã¯ç§‘å­¦ã¾ãŸã¯ç ”ç©¶ã«é–¢é€£ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", "category": "field"},
            {"question": "ãã‚Œã¯æ—¥å¸¸ç”Ÿæ´»ã«ã¨ã£ã¦æ¬ ã‹ã›ãªã„ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã‹ï¼Ÿ", "category": "necessity"},
            {"question": "ãã‚Œã¯é€šå¸¸å­ä¾›ã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "user_age"},
            {"question": "ãã‚Œã¯å¥åº·ã‚„åŒ»ç™‚ã«é–¢é€£ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", "category": "field"},
            {"question": "ãã‚Œã¯ã»ã¨ã‚“ã©ã®ã‚ªãƒ•ã‚£ã‚¹ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "category": "location"},
            {"question": "ãã‚Œã¯å»ºè¨­æ¥­ç•Œã§ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "industry"},
            {"question": "ãã‚Œã¯ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¨è¦‹ãªã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "value"},
            {"question": "ãã‚Œã¯æ–™ç†ã‚„é£Ÿäº‹ã®æº–å‚™ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "category": "usage"}
        ]
        
        # ã™ã¹ã¦ã®å˜èªã®ãƒªã‚¹ãƒˆ
        self.allwords = [
            'åºƒå‘Š', 'ã‚¢ã‚¬ãƒ™', 'ã‚¨ã‚¢ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚µãƒ¼', 'ã‚¨ã‚¢ã‚³ãƒ³', 'ã‚¨ã‚¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', 
            'ã‚¨ã‚¢ãƒ™ãƒ³ãƒˆ', 'ã‚¢ãƒ©ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚¢ãƒŠãƒ­ã‚¸ãƒ¼', 'ã‚¢ãƒãƒ¢ãƒ', 'éº»é…”', 
            'ã‚¢ãƒƒãƒ—ãƒ«ãƒ‘ã‚¤', 'ã‚¨ãƒ—ãƒ­ãƒ³', 'æ°´æ—é¤¨', 'å¤§æ°—', 'è¬›å ‚', 
            'ãƒãƒƒã‚¯ãƒ¬ã‚¹ãƒˆ', 'ãƒã‚¯ãƒ†ãƒªã‚¢', 'ãƒã‚²ãƒƒãƒˆ', 'ãƒãƒ«ã‚³ãƒ‹ãƒ¼', 'éŠ€è¡Œ', 
            'ç†é«ªæ¤…å­', 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰', 'ã‚³ã‚¦ãƒ¢ãƒª', 'ãƒã‚¹ãƒãƒƒãƒˆ', 'ãƒãƒƒãƒ†ãƒªãƒ¼éŠ€è¡Œ', 
            'ãƒ“ãƒ¼ãƒ³ãƒãƒƒã‚°', 'ãƒ™ãƒƒãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ', 'è‡ªè»¢è»Š', 'è‡ªè»¢è»Šé“', 'åŒçœ¼é¡', 
            'é³¥ã‹ã”', 'é³¥ã®ç¨®', 'å¿œæ´å›£å¸­', 'ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰', 'ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ', 
            'ãƒœãƒ“ãƒ¼ãƒ”ãƒ³', 'ãƒœãƒ©ãƒ¼ãƒ‰', 'æ¥ç€å‰¤', 'æœ¬æ£š', 'ãƒ–ãƒƒã‚±ãƒ³', 
            'ãƒœãƒˆãƒ«æ°´', 'ãƒ‘ãƒ³ãƒŠã‚³ãƒƒã‚¿', 'ä¼‘æ†©å®¤', 'ãƒ–ãƒªãƒ¥ãƒ¯ãƒªãƒ¼å•†å“', 
            'ãƒ–ãƒªãƒ¼ãƒ•ã‚±ãƒ¼ã‚¹', 'ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ', 'ç ´æã—ãŸã‚¬ãƒ©ã‚¹', 'ãƒ–ãƒ©ã‚¦ãƒ‹ãƒ¼', 'ãƒã‚°ã‚¹ãƒ—ãƒ¬ãƒ¼', 
            'é›»çƒ', 'ãƒãƒ³ãƒ‘ãƒ¼ã‚¹ãƒ†ãƒƒã‚«ãƒ¼', 'ãƒãƒ³ã‚¼ãƒ³ãƒãƒ¼ãƒŠãƒ¼', 'è¶', 'ã‚­ãƒ£ãƒ“ãƒãƒƒãƒˆ', 
            'é›»å“', 'ã‚«ãƒ³ã‚¿ãƒ­ãƒ¼ãƒ—', 'ãƒãƒ£ã‚¤ãƒ«ãƒ‰ã‚·ãƒ¼ãƒˆ', 'ã‚«ãƒ¼ãƒ‰', 'æ®µãƒœãƒ¼ãƒ«ç®±', 
            'ãƒ¬ã‚¸', 'çŒ«ã®ãƒ™ãƒƒãƒ‰', 'çŒ«ã‚­ãƒ£ãƒªã‚¢', 'ã‚«ãƒªãƒ•ãƒ©ãƒ¯ãƒ¼', 'å¤©äº•ãƒ•ã‚¡ãƒ³', 
            'ã‚·ãƒªã‚¢ãƒ«', 'ãƒ©ãƒ†', 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ã‚°ãƒ©ã‚¹', 'ã‚·ãƒ£ãƒ³ãƒ‡ãƒªã‚¢', 'ãƒãƒ¼ã‚ºã‚±ãƒ¼ã‚­', 
            'ãƒã‚§ã‚¹ãƒœãƒ¼ãƒ‰', 'å™›ã‚€ãŠã‚‚ã¡ã‚ƒ', 'ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã‚±ãƒ¼ã‚­', 'ã‚·ãƒŠãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ«', 'ã¼ã‚å¸ƒ', 
            # ï¼ˆçœç•¥ï¼‰æ•°å¤šãã®ã‚¢ã‚¤ãƒ†ãƒ ãŒç¶šã...
        ]

        self.game = TwentyQuestionsGame("ãƒãƒ¼ãƒ A", "ãƒãƒ¼ãƒ B", self.random_word())  # ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–

    def random_word(self):
        return random.choice(self.allwords)  # ãƒ©ãƒ³ãƒ€ãƒ ã«å˜èªã‚’é¸æŠ

    def play_game(self):
        self.game.start_game()  # ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
        self.game.play_round()  # ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å®Ÿè¡Œ

# ãƒ¡ã‚¤ãƒ³å‡¦ç†éƒ¨
if __name__ == "__main__":
    twenty_questions = TwentyQuestions()  # ã‚²ãƒ¼ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    twenty_questions.play_game()  # ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤
    
    # æ¬¡ã®è³ªå•ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    def next_question(self):
        if self.current_question_index < len(self.questions):
            question = self.questions[self.current_question_index]  # ç¾åœ¨ã®è³ªå•ã‚’å–å¾—
            return question["question"]
        else:
            return None  # è³ªå•ãŒçµ‚ã‚ã£ãŸå ´åˆã¯Noneã‚’è¿”ã™

    # å›ç­”ã‚’æä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    def provide_answer(self, answer):
        current_question = self.questions[self.current_question_index]  # ç¾åœ¨ã®è³ªå•ã‚’å–å¾—
        category = current_question["category"]  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å–å¾—
        self.categories[category] = answer  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å›ç­”ã‚’ä¿å­˜
        self.current_question_index += 1  # æ¬¡ã®è³ªå•ã«é€²ã‚€

    # å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    def guess_word(self):
        if self.current_question_index >= len(self.questions):  # è³ªå•ãŒå…¨ã¦çµ‚ã‚ã£ãŸã‚‰
            print(f"ã™ã¹ã¦ã®è³ªå•ã‚’ã—ã¾ã—ãŸã€‚éš ã•ã‚ŒãŸå˜èªã¯ '{self.hidden_word}' ã§ã™ã‹ï¼Ÿ")
            answer = input("ç­”ãˆ (ã¯ã„/ã„ã„ãˆ): ").lower().strip()  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
            if answer == "ã¯ã„":
                print("ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼éš ã•ã‚ŒãŸå˜èªã‚’æ­£ã—ãæ¨æ¸¬ã—ã¾ã—ãŸï¼")
            else:
                print(f"æ®‹å¿µãªãŒã‚‰ã€éš ã•ã‚ŒãŸå˜èªã¯ '{self.hidden_word}' ã§ã—ãŸã€‚ã¾ãŸã®æ©Ÿä¼šã«é ‘å¼µã£ã¦ãã ã•ã„ï¼")
        else:
            print("æ¨æ¸¬ã™ã‚‹å‰ã«ã™ã¹ã¦ã®20ã®è³ªå•ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")

# ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãƒ—ãƒ¬ã‚¤
team1_name = "ãƒãƒ¼ãƒ A"
team2_name = "ãƒãƒ¼ãƒ B"

game = TwentyQuestionsGame(team1_name, team2_name, hidden_word="è±¡")  # ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
game.start_game()  # ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹

for _ in range(20):
    game.play_round()  # 20ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤
```

** @@@ Jupyter Notebook numver 49, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã«å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã€ä¸»ã«ç’°å¢ƒæ§‹ç¯‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚

### å•é¡Œè¨­å®š:
Notebookã¯ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãŸ`requirements.txt`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹ä¾å­˜é–¢ä¿‚ã‚’é©åˆ‡ã«ç®¡ç†ã—ã€ä¸€è²«ã—ãŸç’°å¢ƒã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚

### æ‰‹æ³•:
1. **requirements.txtã®ä½œæˆ:** æœ€åˆã«ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ`bitsandbytes`ã€`transformers`ã€`Unidecode`ï¼‰ã¨ãã‚Œãã‚Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãŸæ–‡æ›¸ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»–ã®é–‹ç™ºè€…ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ç’°å¢ƒã‚’å†ç¾ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

2. **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:** æ¬¡ã«ã€`pip`ã‚’åˆ©ç”¨ã—ã¦`requirements.txt`ã«è¨˜è¼‰ã•ã‚ŒãŸå…¨ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã€ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:
- `bitsandbytes`: ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
- `transformers`: è‡ªç„¶è¨€èªå‡¦ç†ã«ãŠã„ã¦é«˜æ€§èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
- `Unidecode`: Unicodeãƒ†ã‚­ã‚¹ãƒˆã‚’ASCIIã«å¤‰æ›ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

ã“ã®Notebookã¯ã€LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã®é–‹ç™ºã‚„ãã®ä»–ã®NLPã‚¿ã‚¹ã‚¯ã«å¿…è¦ãªç’°å¢ƒã‚’æ•´ãˆã‚‹ãŸã‚ã®å‡ºç™ºç‚¹ã¨ãªã‚‹ã‚‚ã®ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
%%writefile requirements.txt
# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãŸrequirements.txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
bitsandbytes==0.43.3
transformers==4.43.3
Unidecode==1.3.8
```

---The following area is a Code cell (cell numver is 2)---
```python
# requirements.txtãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# --destination-directory . ã¯ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
!python -m pip download --destination-directory . -r requirements.txt
```

** @@@ Jupyter Notebook numver 50, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå• LLM ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ã«å‚åŠ ã™ã‚‹ãŸã‚ã®å•é¡Œè§£æ±ºæ‰‹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ç›®æ¨™ã¯ã€AIãŒç§˜å¯†ã®å˜èªã‚’å½“ã¦ã‚‹ãŸã‚ã«æœ€å¤§20ã®è³ªå•ã«ç­”ãˆã‚‹ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã§ã™ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®å†…å®¹ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ï¼š

1. **å•é¡Œè¨­å®š**: å‚åŠ è€…ãŒè€ƒãˆãŸç§˜å¯†ã®å˜èªã‚’ã€è³ªå•è€…LLMãŒè³ªå•ã‚’é€šã˜ã¦æ¨æ¸¬ã™ã‚‹ã¨ã„ã†æ§‹é€ ã®ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã¯ã€é™ã‚‰ã‚ŒãŸè³ªå•å›æ•°ã®ä¸­ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’å½“ã¦ã‚‹ãŸã‚ã«æˆ¦ç•¥çš„ã‹ã¤åŠ¹ç‡çš„ãªæƒ…å ±åé›†ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

2. **ä½¿ç”¨æŠ€è¡“**:
   - **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `transformers`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€äº‹å‰å­¦ç¿’æ¸ˆã¿ã®RoBERTaãƒ¢ãƒ‡ãƒ«ï¼ˆ"deepset/roberta-base-squad2"ï¼‰ã‚’åˆ©ç”¨ã—ã¦ã€è³ªå•å¿œç­”ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
   - **GPUåˆ©ç”¨**: è³ªå•å¿œç­”ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€GPUã‚’åˆ©ç”¨ã—ã¦å‡¦ç†é€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã¦ã„ã¾ã™ã€‚

3. **æ‰‹æ³•**:
   - **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ**: `generate_prompt`é–¢æ•°ãŒã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€å¤§é™¸ãªã©ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’ã‚‚ã¨ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   - **å¿œç­”ç”Ÿæˆ**: `get_answer_from_model`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ç”Ÿæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¯¾ã™ã‚‹è³ªå•ã®å›ç­”ã‚’ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

4. **å®Ÿè¡Œ**: `main`é–¢æ•°å†…ã§å®Ÿéš›ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ŒMount Everestã€ã‚’ä½¿ç”¨ã—ã€é–¢é€£ã™ã‚‹è³ªå•ã‚’ãƒªã‚¹ãƒˆåŒ–ã—ã¦ã€ãã‚Œãã‚Œã®è³ªå•ã«å¯¾ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®å›ç­”ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ãŒå—ã‘å–ã£ãŸè³ªå•ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ã«å¿œç­”ã™ã‚‹ã‹ãŒç¢ºèªã§ãã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å–ã‚Šçµ„ã‚€ãŸã‚ã®åŸºç¤ã‚’ç¯‰ãã‚‚ã®ã§ã‚ã‚Šã€ç‰¹ã«è‡ªç„¶è¨€èªå‡¦ç†ã®æŠ€è¡“ã‚’ç”¨ã„ã¦ã€AIãŒäººé–“ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã®ã‚ˆã†ã«æ¨è«–ã™ã‚‹èƒ½åŠ›ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
### ã€Œ20ã®è³ªå• LLM ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ã¯ã€äººå·¥çŸ¥èƒ½ã€è‡ªç„¶è¨€èªå‡¦ç†ã€ã‚²ãƒ¼ãƒ ç†è«–ã®åˆ†é‡ã‚’çµã³ã¤ã‘ã‚‹é©æ–°çš„ãªæŒ‘æˆ¦ã§ã™ã€‚ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯ã€å‚åŠ è€…ã®ä¸€äººãŒç§˜å¯†ã®å˜èªã‚’è€ƒãˆã€ä»–ã®å‚åŠ è€…ãŒæœ€å¤§20ã®ã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’é€šã˜ã¦ãã‚Œã‚’æ¨æ¸¬ã™ã‚‹ã¨ã„ã†å¤å…¸çš„ãªã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ä¸­å¿ƒã«å±•é–‹ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚ŠãªãŒã‚‰é­…åŠ›çš„ãªã‚²ãƒ¼ãƒ ãŒã€é«˜åº¦ãªAIã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åŸºç›¤ã¨ãªã£ã¦ã„ã¾ã™ã€‚

<figure>
        <img src="https://www.kaggle.com/competitions/61247/images/header" alt ="Audio Art" style='width:800px;height:500px;'>
        <figcaption>
```

---The following area is a Code cell (cell numver is 2)---
```python
import torch
from transformers import AutoTokenizer, AutoModelForQuestionAnswering, pipeline

# äº‹å‰å­¦ç¿’æ¸ˆã¿ã®RoBERTaãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
model_id = "deepset/roberta-base-squad2"  # QAç”¨ã«ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸRoBERTaãƒ¢ãƒ‡ãƒ«
tokenizer = AutoTokenizer.from_pretrained(model_id)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®åˆæœŸåŒ–
model = AutoModelForQuestionAnswering.from_pretrained(model_id)  # ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–

# GPUç”¨ã®è³ªå•å¿œç­”ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™
qa_pipeline = pipeline("question-answering", model=model, tokenizer=tokenizer, device=0)  # device=0ã¯GPUã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™

def generate_prompt(keyword, category, negate, continent):
    if category in negate:
        prompt = (f"We are playing 20 questions. The keyword is {keyword}. It is a {category}. {negate[category]} "
                  f"This word has first letter {keyword[0]}. This {category} is located in {continent}.")
    else:
        prompt = (f"We are playing 20 questions. The keyword is {keyword}. It is a thing. It is not a city. "
                  f"It is not a country. It is not a landmark. This word has first letter {keyword[0]}.")
    return prompt  # ç”Ÿæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã—ã¾ã™

def get_answer_from_model(prompt, question):
    # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™
    response = qa_pipeline(question=question, context=prompt)  # è³ªå•ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’å–å¾—
    answer = response['answer']  # å¿œç­”ã‹ã‚‰ç­”ãˆã‚’å–å¾—ã—ã¾ã™
    return answer  # ç­”ãˆã‚’è¿”ã—ã¾ã™

def main():
    keyword = "Mount Everest"  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆï¼‰
    category = "mountain"  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯å±±ï¼‰
    negate = {"mountain": "It is not a country, city, or person."}  # é™¤å¤–æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
    continent = "Asia"  # å¤§é™¸ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯ã‚¢ã‚¸ã‚¢ï¼‰

    prompt = generate_prompt(keyword, category, negate, continent)  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™

    questions = [
        "Is this a country or city?",  # è³ªå•ãƒªã‚¹ãƒˆã®æœ€åˆã®è³ªå•
        "No, it is a mountain. What is the name of this mountain?",  # æ¬¡ã®è³ªå•
        "Where is this place?"  # æœ€å¾Œã®è³ªå•
    ]

    # æ§‹ç¯‰ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™
    print(f"Prompt:\n{prompt}\n")

    # å„è³ªå•ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™
    for question in questions:
        # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ç­”ãˆã‚’å–å¾—ã—ã¾ã™
        answer = get_answer_from_model(prompt, question)
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸå‡ºåŠ›ã‚’è¡¨ç¤ºã—ã¾ã™
        print(f"Question: '{question}'")
        print(f"Answer: '{answer}'\n")

if __name__ == "__main__":
    main()  # ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
code = """
import torch
from transformers import AutoTokenizer, AutoModelForQuestionAnswering, pipeline

# äº‹å‰å­¦ç¿’æ¸ˆã¿ã®RoBERTaãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
model_id = "deepset/roberta-base-squad2"  # QAç”¨ã«ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸRoBERTaãƒ¢ãƒ‡ãƒ«
tokenizer = AutoTokenizer.from_pretrained(model_id)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®åˆæœŸåŒ–
model = AutoModelForQuestionAnswering.from_pretrained(model_id)  # ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–

# GPUç”¨ã®è³ªå•å¿œç­”ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™
qa_pipeline = pipeline("question-answering", model=model, tokenizer=tokenizer, device=0)  # device=0ã¯GPUã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™

def generate_prompt(keyword, category, negate, continent):
    if category in negate:
        prompt = (f"We are playing 20 questions. The keyword is {keyword}. It is a {category}. {negate[category]} "
                  f"This word has first letter {keyword[0]}. This {category} is located in {continent}.")
    else:
        prompt = (f"We are playing 20 questions. The keyword is {keyword}. It is a thing. It is not a city. "
                  f"It is not a country. It is not a landmark. This word has first letter {keyword[0]}.")
    return prompt  # ç”Ÿæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã—ã¾ã™

def get_answer_from_model(prompt, question):
    # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™
    response = qa_pipeline(question=question, context=prompt)  # è³ªå•ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’å–å¾—
    answer = response['answer']  # å¿œç­”ã‹ã‚‰ç­”ãˆã‚’å–å¾—ã—ã¾ã™
    return answer  # ç­”ãˆã‚’è¿”ã—ã¾ã™

def main():
    keyword = "Mount Everest"  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆï¼‰
    category = "mountain"  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯å±±ï¼‰
    negate = {"mountain": "It is not a country, city, or person."}  # é™¤å¤–æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
    continent = "Asia"  # å¤§é™¸ã‚’è¨­å®šã—ã¾ã™ï¼ˆã“ã“ã§ã¯ã‚¢ã‚¸ã‚¢ï¼‰

    prompt = generate_prompt(keyword, category, negate, continent)  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™

    questions = [
        "Is this a country or city?",  # è³ªå•ãƒªã‚¹ãƒˆã®æœ€åˆã®è³ªå•
        "No, it is a mountain. What is the name of this mountain?",  # æ¬¡ã®è³ªå•
        "Where is this place?"  # æœ€å¾Œã®è³ªå•
    ]

    # æ§‹ç¯‰ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™
    print(f"Prompt:\n{prompt}\n")

    # å„è³ªå•ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™
    for question in questions:
        # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ç­”ãˆã‚’å–å¾—ã—ã¾ã™
        answer = get_answer_from_model(prompt, question)
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸå‡ºåŠ›ã‚’è¡¨ç¤ºã—ã¾ã™
        print(f"Question: '{question}'")
        print(f"Answer: '{answer}'\n")

if __name__ == "__main__":
    main()  # ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™
"""

# ã‚³ãƒ¼ãƒ‰ã‚’submission.pyã«ä¿å­˜ã—ã¾ã™
with open("/kaggle/working/submission.py", "w") as f:
    f.write(code)  # ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€
```

** @@@ Jupyter Notebook numver 51, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€åˆ†æã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ¢ãƒ¼ãƒˆURLã‹ã‚‰å–å¾—ã—ã€ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®è³ªå•ã€å›ç­”ã€ãŠã‚ˆã³äºˆæ¸¬æƒ…å ±ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã®åˆ†æã‚’é€šã˜ã¦ã€ã©ã®è³ªå•ãŒæœ€ã‚‚é »ç¹ã«ä½¿ç”¨ã•ã‚Œã€ã¾ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«åŠ¹æœçš„ã§ã‚ã£ãŸã‹ã‚’èª¿æŸ»ã—ã¦ã„ã¾ã™ã€‚

### ä¸»ãªå–ã‚Šçµ„ã¿å†…å®¹:
1. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: `requests`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€æŒ‡å®šã—ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¦å–å¾—ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
2. **ãƒ‡ãƒ¼ã‚¿æ•´å½¢**: å–å¾—ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€è³ªå•ã‚„å›ç­”ã€äºˆæ¸¬ãªã©ã®æƒ…å ±ã‚’æ•´ç†ã—ã€ãƒªã‚¹ãƒˆã«æ ¼ç´ã—ã¾ã™ã€‚
3. **DataFrameä½œæˆ**: æ•´ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Pandas DataFrameã«å¤‰æ›ã—ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
4. **è³ªå•ã®é »åº¦åˆ†æ**: å„è³ªå•ã®å‡ºç¾é »åº¦ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€æœ€ã‚‚ã‚ˆãã‚‚ã‚‰ã‚ŒãŸè³ªå•ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
5. **åŠ¹æœçš„ãªè³ªå•ã®ç‰¹å®š**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒäºˆæ¸¬ã¨ä¸€è‡´ã—ãŸã‚±ãƒ¼ã‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã€ãã®ã‚ˆã†ãªè³ªå•ã®å‡ºç¾é »åº¦ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:
- `requests`: ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç®¡ç†ã€‚
- `pandas`: ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã€åˆ†æã€CSVãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•ã®é »åº¦ã‚„åŠ¹æœã‚’å®šé‡çš„ã«è©•ä¾¡ã™ã‚‹ã“ã¨ã«é‡ãã‚’ç½®ã„ã¦ãŠã‚Šã€åˆ†æçµæœã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã‚ˆã‚ŠåŠ¹æœçš„ãªè³ªå•æˆ¦ç•¥ã‚’æ¢ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
pip install requests pandas
```

---The following area is a Code cell (cell numver is 2)---
```python
import requests
import pandas as pd

# URLã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
def read_json_from_url(url):
    response = requests.get(url)  # æŒ‡å®šã—ãŸURLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    response.raise_for_status()  # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹
    return response.json()  # JSONå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

# ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
data = []

# ãƒ™ãƒ¼ã‚¹URL
base_url = "https://www.kaggleusercontent.com/episodes/"

# è¤‡æ•°ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰IDã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†
for i in [55235305, 55177813, 55181874, 55054770]:
    url = f"{base_url}{i}.json"  # å„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®URLã‚’ä½œæˆ
    json_data = read_json_from_url(url)  # JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    # key-valueãƒšã‚¢ã‚’åå¾©å‡¦ç†
    auxVar1 = json_data['steps'][len(json_data['steps'])-1]  # æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å–å¾—
    for i in range(len(auxVar1)):
        obs = dict(auxVar1[i])['observation']  # è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if 'questions' in obs:  # 'questions'ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            for j in range(min(len(obs['questions']), len(obs['guesses']))):  # è³ªå•ã¨äºˆæ¸¬ã®æœ€å°æ•°ã§ãƒ«ãƒ¼ãƒ—
                # å„è¦³å¯Ÿã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸å½¢å¼ã§è¿½åŠ 
                data.append({
                    'iteration': i + 1,  # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç•ªå·
                    'episode_id': json_data['info']['EpisodeId'],  # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ID
                    'questions': obs['questions'][j],  # è³ªå•
                    'answers': obs['answers'][j],  # ç­”ãˆ
                    'guesses': obs['guesses'][j],  # äºˆæ¸¬
                    'keyword': obs['keyword']}  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                )

# DataFrameã‚’ä½œæˆ
df = pd.DataFrame(data)  # è¾æ›¸ãƒªã‚¹ãƒˆã‹ã‚‰DataFrameã‚’ä½œæˆ
df.to_csv('20_questions_data.csv', index=False)  # '20_questions_data.csv'ã«ä¿å­˜

print("ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«æŠ½å‡ºã•ã‚Œã€'20_questions_data.csv'ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚")  # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

---The following area is a Code cell (cell numver is 3)---
```python
# DataFrameã®æœ€åˆã®æ•°è¡Œã‚’è¡¨ç¤º
print(df.head())

# å„è³ªå•ã®é »åº¦ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
question_counts = df['questions'].value_counts()

# æœ€ã‚‚é »ç¹ã«å°‹ã­ã‚‰ã‚ŒãŸè³ªå•ã‚’è¡¨ç¤º
print("æœ€ã‚‚é »ç¹ã«å°‹ã­ã‚‰ã‚ŒãŸè³ªå•:")
print(question_counts.head(10))

# äºˆæ¸¬ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹è¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
keyword_discovered = df[df['guesses'] == df['keyword']]

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã—ãŸè³ªå•ã®é »åº¦ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
discovery_question_counts = keyword_discovered['questions'].value_counts()

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®æœ€ã‚‚åŠ¹æœçš„ãªè³ªå•ã‚’è¡¨ç¤º
print("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®è³ªå•:")
print(discovery_question_counts.head(10))
```

** @@@ Jupyter Notebook numver 52, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã§ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã¨å®Ÿè¡Œã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€4ã¤ã®ç•°ãªã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã—ã€ãã‚Œã‚‰ãŒæ§˜ã€…ãªã‚«ãƒ†ã‚´ãƒªï¼ˆé›»å­æ©Ÿå™¨ã€é£Ÿå“ã€ä¹—ã‚Šç‰©ã€å›½ï¼‰ã«é–¢é€£ã™ã‚‹è³ªå•ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚

### ä¸»ãªå•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’æ¨¡å€£ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã«é–¢é€£ã—ã¦ãŠã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«è³ªå•ã‚’è¡Œã†ã‹ã€ã¾ãŸãã®å›ç­”ã«ã‚ˆã£ã¦æ¬¡ã®è³ªå•ã‚’æ±ºå®šã™ã‚‹ã‹ã‚’æ‰±ã£ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨æ‰‹æ³•
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…**: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¯¾ã™ã‚‹è³ªå•ã‚’æŒã¡ã€ãã®è³ªå•ã«åŸºã¥ã„ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’çµã‚Šè¾¼ã‚€ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œè³ªå•ã‚’ã™ã‚‹ã€ã€ã€Œæ¨æ¸¬ã™ã‚‹ã€ã€ã€Œå›ç­”ã™ã‚‹ã€ã¨ã„ã†ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦ç•°ãªã‚‹è¡Œå‹•ã‚’å–ã‚Šã¾ã™ã€‚
- **ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**: ã‚«ãƒ†ã‚´ãƒªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã—ã¦é–¢é€£ä»˜ã‘ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã®é–¢æ•°`is_related`ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **NumPy**: æ•°å€¤è¨ˆç®—ã«ä½¿ç”¨ã€‚
- **Pandas**: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ“ä½œã«ä½¿ç”¨ã€‚
- **Kaggle Environments**: ã‚²ãƒ¼ãƒ ç’°å¢ƒã‚’ä½œæˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨æ¸¬ã‚„å¯¾æˆ¦ã®çµæœãŒåé›†ã•ã‚Œã¾ã™ã€‚

### å®Ÿè¡Œã¨æå‡ºæº–å‚™
ã‚²ãƒ¼ãƒ ã®ç’°å¢ƒã‚’ä½œæˆã—ã€å®šç¾©ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ã¾ãŸã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã€æå‡ºç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹æº–å‚™ã‚’æ•´ãˆã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè¡Œã®æµã‚Œã‚’ç¤ºã—ã¦ãŠã‚Šã€ç‰¹ã«æˆ¦ç•¥çš„ãªè³ªå•ã¨ç­”ãˆã®ç”Ÿæˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªè§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯ã€kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã“ã“ã§ã¯ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ (å®Ÿè¡Œã™ã‚‹ã«ã¯ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ Shift+Enter ã‚’æŠ¼ã—ã¾ã™)ã€å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€"Save & Run All" ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã¨å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ 
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ /kaggle/temp/ ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 2)---
```python
import random

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚«ãƒ†ã‚´ãƒªã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
def is_related(keyword, category_keywords):
    return keyword.lower() in category_keywords

# ã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
electronics_keywords = {"ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³", "ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—", "ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ", "ãƒ†ãƒ¬ãƒ“"}
food_keywords = {"ãƒ”ã‚¶", "ãƒãƒ¼ã‚¬ãƒ¼", "å¯¿å¸", "ãƒ‘ã‚¹ã‚¿"}
vehicles_keywords = {"è»Š", "ãƒã‚¤ã‚¯", "é£›è¡Œæ©Ÿ", "ãƒœãƒ¼ãƒˆ"}
countries_keywords = {"æ—¥æœ¬", "ãƒ•ãƒ©ãƒ³ã‚¹", "ãƒ–ãƒ©ã‚¸ãƒ«", "ã‚«ãƒŠãƒ€"}

def simple_agent1(obs, cfg):
    electronics_questions = [
        "ãã‚Œã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã™ã‹?", "ãã‚Œã¯ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ã§ã™ã‹?", 
        "ãã‚Œã¯ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã™ã‹?", "ãã‚Œã¯ãƒ†ãƒ¬ãƒ“ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(electronics_questions)
    elif obs.turnType == "guess": 
        response = "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, electronics_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent2(obs, cfg):
    food_questions = [
        "ãã‚Œã¯ãƒ”ã‚¶ã§ã™ã‹?", "ãã‚Œã¯ãƒãƒ¼ã‚¬ãƒ¼ã§ã™ã‹?", 
        "ãã‚Œã¯å¯¿å¸ã§ã™ã‹?", "ãã‚Œã¯ãƒ‘ã‚¹ã‚¿ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(food_questions)
    elif obs.turnType == "guess": 
        response = "ãƒ”ã‚¶"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, food_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent3(obs, cfg):
    vehicle_questions = [
        "ãã‚Œã¯è»Šã§ã™ã‹?", "ãã‚Œã¯ãƒã‚¤ã‚¯ã§ã™ã‹?", 
        "ãã‚Œã¯é£›è¡Œæ©Ÿã§ã™ã‹?", "ãã‚Œã¯ãƒœãƒ¼ãƒˆã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(vehicle_questions)
    elif obs.turnType == "guess": 
        response = "è»Š"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, vehicles_keywords) else "**ã„ã„ãˆ**"
    return response

def simple_agent4(obs, cfg):
    country_questions = [
        "ãã‚Œã¯æ—¥æœ¬ã§ã™ã‹?", "ãã‚Œã¯ãƒ•ãƒ©ãƒ³ã‚¹ã§ã™ã‹?", 
        "ãã‚Œã¯ãƒ–ãƒ©ã‚¸ãƒ«ã§ã™ã‹?", "ãã‚Œã¯ã‚«ãƒŠãƒ€ã§ã™ã‹?"
    ]
    
    if obs.turnType == "ask": 
        response = random.choice(country_questions)
    elif obs.turnType == "guess": 
        response = "æ—¥æœ¬"  # ã“ã“ã«æ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã§ãã¾ã™
    elif obs.turnType == "answer":
        response = "**ã¯ã„**" if is_related(obs.keyword, countries_keywords) else "**ã„ã„ãˆ**"
    return response
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# ã‚²ãƒ¼ãƒ ç’°å¢ƒã®ä½œæˆã¨è¨­å®š

Kaggleã®ç’°å¢ƒã¯ã€`make()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã€*ç’°å¢ƒ*å (`"llm_20_questions"`) ã¨ã€ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ*æ§‹æˆ*ã‚„*æƒ…å ±*ãªã©ï¼‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚ˆã†ã«ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 4)---
```python
import kaggle_environments
env = kaggle_environments.make(environment="llm_20_questions")
# ï¼ˆã€ŒNo pygame installedã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼‰
```

---The following area is a Code cell (cell numver is 5)---
```python
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯: ")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.keyword)
print(" ")
print("ã„ãã¤ã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¯ã€ä»£æ›¿ã®æ¨æ¸¬ï¼ˆaltsï¼‰ã®ãƒªã‚¹ãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚")
print("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä»£æ›¿ãƒªã‚¹ãƒˆã¯:")
print(kaggle_environments.envs.llm_20_questions.llm_20_questions.alts)
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
# LLM 20 Questions ã®å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ä½œæˆã—ãŸç’°å¢ƒ (`env`) ã§ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’æå‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ1" ï¼ˆãƒãƒ¼ãƒ 1ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ2" ï¼ˆãƒãƒ¼ãƒ 1ã®å›ç­”è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ3" ï¼ˆãƒãƒ¼ãƒ 2ã®æ¨æ¸¬è€…ï¼‰ã€ 
* "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ4" ï¼ˆãƒãƒ¼ãƒ 2ã®å›ç­”è€…ï¼‰ã€‚ 

ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¨å¯¾æˆ¦ã—ã€æ¨æ¸¬è€…ã¾ãŸã¯å›ç­”è€…ã®ã©ã¡ã‚‰ã‹ã«ãªã‚Šã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 7)---
```python
%%time
game_output = env.run(agents=[simple_agent1, simple_agent2, simple_agent3, simple_agent4])
```

---The following area is a Code cell (cell numver is 8)---
```python
env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 9)---
```markdown
# æå‡ºå¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Pythonã‚³ãƒ¼ãƒ‰ã‚’main.pyã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’submission.tar.gzã«ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€å…¬å¼ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ˆhttps://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebookï¼‰ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€å®Ÿéš›ã®LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯ã€æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªãŒã‹ã‹ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸã„å ´é¢ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚
```

---The following area is a Code cell (cell numver is 10)---
```python
import os
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"
# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)
    subdirectory_path = os.path.join(submission_directory, submission_subdirectory)
    os.mkdir(subdirectory_path)
```

---The following area is a Code cell (cell numver is 11)---
```python
import os
import csv

# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®šç¾©
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"

# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)

# ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®Œå…¨ãªãƒ‘ã‚¹ã‚’å®šç¾©
subdirectory_path = os.path.join(submission_directory, submission_subdirectory)

# ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if not os.path.exists(subdirectory_path):
    os.mkdir(subdirectory_path)

# libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¾‹ç¤ºç”¨ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
with open(os.path.join(subdirectory_path, "example.csv"), mode='w') as file:
    writer = csv.writer(file)
    writer.writerow(["ç‰›", "é¦¬"])
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãŸã‚ã®main.py Pythonã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
* ç’°å¢ƒã¯main.pyã®æœ€å¾Œã®é–¢æ•°ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®å ´åˆã¯`agent_fun()`ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 13)---
```python
%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random



# æå‡º/libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ï¼‰ã‚’ç½®ãå ´åˆã¯ã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œä¸­ã®å ´åˆ
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§å®Ÿè¡Œä¸­ã®å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")
sys.path.insert(0, subdirectory_path)


# ä¾‹ç¤ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
with open(os.path.join(subdirectory_path,"example.csv"), mode='r') as file:
    reader = csv.reader(file)
    guess_list = list(reader)
    guess_list = guess_list[0]

# ä¾‹ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã "å‹•ç‰©"ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
animal = random.choice(guess_list)
    
# main.py ã®æœ€å¾Œã®é–¢æ•°ãŒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã¨ãªã‚Šã¾ã™
def agent_fn(obs, cfg):
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnType ãŒ "ask" ã®å ´åˆ
    if obs.turnType == "ask":
        response = f'ãã‚Œã¯{animal}ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã‹?'
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnType ãŒ "guess" ã®å ´åˆ
    elif obs.turnType == "guess":
        if obs.answers[-1]=="yes":
            response = animal
        else:
            response = "ãƒšãƒ³ã‚®ãƒ³"
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        if obs.keyword in obs.questions[-1]:
            response = "ã¯ã„"
        else:
            response = "ã„ã„ãˆ"
        
    return response
```

---The following area is a Markdown cell (cell numver is 14)---
```markdown
ã“ã®`main.py`ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€`/lib/example.csv`ã‚µãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨å…±ã«æå‡ºã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚
```

---The following area is a Code cell (cell numver is 15)---
```python
!apt install pigz pv > /dev/null
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 16)---
```python
game_output = env.run(agents=["/kaggle/working/submission/main.py", "/kaggle/working/submission/main.py", simple_agent3, simple_agent4])
env.render(mode="ipython", width=600, height=500)
```

** @@@ Jupyter Notebook numver 53, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«å‘ã‘ãŸæˆæœç‰©ã®åœ§ç¸®ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€Pythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’tar.gzå½¢å¼ã§åœ§ç¸®ã—ã€ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œå†…å®¹
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ç‰¹å®šã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`llm_20_questions.py`ï¼‰ã‚’åœ§ç¸®ã—ã¦ã€æå‡ºç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`submission.tar.gz`ï¼‰ã‚’ä½œæˆã™ã‚‹ã¨ã„ã†å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€å‚åŠ è€…ãŒæå‡ºç‰©ã‚’é©åˆ‡ãªå½¢å¼ã§ã¾ã¨ã‚ã‚‹ã“ã¨ãŒå¿…è¦ãªãŸã‚ã§ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - `pandas` ã¨ `numpy`: ä¸€èˆ¬çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãŸã‚ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯å…·ä½“çš„ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
  - `tarfile`: Pythonã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€tarã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä½œæˆã¨æ“ä½œã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  - `os`: ãƒ•ã‚¡ã‚¤ãƒ«åã®æ“ä½œã«åˆ©ç”¨ã•ã‚Œã¦ãŠã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬åã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

- **æ‰‹æ³•**:
  1. åœ§ç¸®ã™ã‚‹Pythonãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã€‚
  2. å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®šç¾©ã€‚
  3. `tarfile`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦ã€æŒ‡å®šã•ã‚ŒãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’tar.gzå½¢å¼ã§åœ§ç¸®ã€‚
  4. åœ§ç¸®å‡¦ç†ã®å®Œäº†å¾Œã€å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰ã‚‚ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¸ã®æå‡ºç‰©ã‚’é©åˆ‡ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã™ã‚‹ãŸã‚ã®é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
import pandas as pd
import numpy as np
```

---The following area is a Code cell (cell numver is 2)---
```python
import tarfile
import os  # osãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™

# åœ§ç¸®ã™ã‚‹Pythonãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’å®šç¾©ã—ã¾ã™
python_file = '/kaggle/input/llm-20-questions/llm_20_questions/llm_20_questions.py'

# ä½œæˆã™ã‚‹tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’å®šç¾©ã—ã¾ã™
output_file = '/kaggle/working/submission.tar.gz'

# æ›¸ãè¾¼ã¿ç”¨ã®tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™
with tarfile.open(output_file, 'w:gz') as tar:
    # Pythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’tar.gzã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«è¿½åŠ ã—ã¾ã™
    tar.add(python_file, arcname=os.path.basename(python_file))  # arcnameã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒã™ã‚‹

# åœ§ç¸®ãŒå®Œäº†ã—ãŸã“ã¨ã‚’çŸ¥ã‚‰ã›ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™
print(f'File {python_file} has been compressed and saved as {output_file}')  # åœ§ç¸®ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™
```

** @@@ Jupyter Notebook numver 54, the number of votes :1 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚²ãƒ¼ãƒ å†…ã§ã®ç•°ãªã‚‹å½¹å‰²ï¼ˆè³ªå•è€…ã¾ãŸã¯å›ç­”è€…ï¼‰ã‚’å¥ªã„åˆã„ã€ã‚¿ãƒ¼ãƒ³ã”ã¨ã«è³ªå•ã‚„æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚

### å•é¡Œã®å†…å®¹
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯ã€è¨€è‘‰å½“ã¦ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã«åŸºã¥ã„ã¦ãŠã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯é™ã‚‰ã‚ŒãŸè³ªå•å›æ•°ã®ä¸­ã§ç­”ãˆã‚’å°ãå‡ºã™ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚ã“ã®Notebookã§ã¯ã€ä¸€é€£ã®è³ªå•ã‚’é€šã˜ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸè¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Python 3ç’°å¢ƒ**: Jupyter Notebookã¯ã€Kaggleã®Python 3ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã€å¤šãã®åˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒäº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `numpy`ï¼ˆç·šå½¢ä»£æ•°ï¼‰ã€`pandas`ï¼ˆãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ›ï¼‰ãªã©ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„åˆ†æã«å½¹ç«‹ã¡ã¾ã™ã€‚
- **Kaggle Environments**: `kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã€Œllm_20_questionsã€ç’°å¢ƒãŒä½œæˆã•ã‚Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œã¨ãƒ‡ãƒãƒƒã‚°ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

### å®Ÿè£…ã®æ¦‚è¦
- **ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€å„ã‚¿ãƒ¼ãƒ³ã«ãŠã„ã¦ã€Œaskã€ï¼ˆè³ªå•ï¼‰ã€ãŠã‚ˆã³ã€Œguessã€ï¼ˆæ¨æ¸¬ï¼‰ã™ã‚‹ã“ã¨ã‚’æ‹…å½“ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`simple_agent1`ã¯ã€Œãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿã€ã¨ã„ã†è³ªå•ã‚’ã—ã€ãã®å¾Œã®ã‚¿ãƒ¼ãƒ³ã§ã€Œã‚¢ãƒ’ãƒ«ã€ã¨æ¨æ¸¬ã—ã¾ã™ã€‚
- **ã‚²ãƒ¼ãƒ ã®å®Ÿè¡Œ**: æœ€å¾Œã«ã€å®Ÿè£…ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”¨ã„ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«`env.render`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®Notebookã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæˆ¦ç•¥ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€20ã®è³ªå•å½¢å¼ã®ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹åŸºæœ¬çš„ãªæ¨æ¸¬ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’ç¤ºã—ã€ç’°å¢ƒã§ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç›¸äº’ä½œç”¨ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã®"../input/"ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ (å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹Shift + Enterã‚’æŠ¼ã™ã“ã¨ã§)ã€å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(/kaggle/working/)ã«æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€
# "ã™ã¹ã¦ã‚’ä¿å­˜ã—ã¦å®Ÿè¡Œ"ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯/kaggle/temp/ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€
# ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
def simple_agent1(obs, cfg):    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•è€…ã§ã‚ã‚Šã€ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    print(obs) # è¦³å¯Ÿæƒ…å ±ã‚’è¡¨ç¤º
    return response

def simple_agent2(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•è€…ã§ã‚ã‚Šã€ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯é³¥ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "é³¥"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    print(obs) # è¦³å¯Ÿæƒ…å ±ã‚’è¡¨ç¤º
    return response

def simple_agent3(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•è€…ã§ã‚ã‚Šã€ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯è±šã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "è±š"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    print(obs) # è¦³å¯Ÿæƒ…å ±ã‚’è¡¨ç¤º
    return response

def simple_agent4(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•è€…ã§ã‚ã‚Šã€ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ãŒ"ask"ã®å ´åˆ
    if obs.turnType == "ask": response = "ãã‚Œã¯ç‰›ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess": response = "ç‰›"
    elif obs.turnType == "answer": response = "ã„ã„ãˆ"
    print(obs) # è¦³å¯Ÿæƒ…å ±ã‚’è¡¨ç¤º
    return response
```

---The following area is a Code cell (cell numver is 3)---
```python
from kaggle_environments import make
env = make(environment="llm_20_questions", debug=True) # "llm_20_questions"ç’°å¢ƒã‚’ä½œæˆã—ã€ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
game_output = env.run(agents=[simple_agent1, simple_agent3, simple_agent2, simple_agent4]) # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
env.render(mode="ipython", width=400, height=400) # ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™
```

** @@@ Jupyter Notebook numver 55, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«æŒ‘æˆ¦ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã®é–‹ç™ºã«é–¢é€£ã—ã¦ãŠã‚Šã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å½“ã¦ã‚‹ãŸã‚ã®è³ªå•ã¨æ¨æ¸¬ã‚’è¡Œã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ä¸»ãªå†…å®¹ã‚’è¦ç´„ã—ã¾ã™ã€‚

### å•é¡Œã®å–ã‚Šçµ„ã¿
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€è³ªå•å¿œç­”å½¢å¼ã§ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸã‚«ãƒ†ã‚´ãƒªã‚„ç‰¹å®šã®ç‰¹å¾´ã«åŸºã¥ã„ã¦ã€è³ªå•ã‚’ç”Ÿæˆã—ã€ãã‚Œã«å¯¾ã™ã‚‹å¿œç­”ã‚’å–å¾—ã—ã¦æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**:
   - `pandas`: ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚’è¡Œã„ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚
   - JSONå½¢å¼ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸ã¨ã—ã¦èª­ã¿è¾¼ã¿ã€DataFrameå½¢å¼ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚

2. **ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**:
   - `matplotlib`: ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã‚„ã‚¢ãƒ³ã‚µãƒ¼ã‚’è¦–è¦šåŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€æç”»æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

3. **ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰**:
   - `transformers`: Hugging Faceã®Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰T5ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒè€ƒæ…®ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€åˆ¥ã®è¨€èªãƒ¢ãƒ‡ãƒ«ã€ŒLlama-3-Smaug-8Bã€ã‚’ä½¿ç”¨ã—ã¦Yes/Noè³ªå•ã®å¿œç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚

4. **å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…**:
   - å¤šå±¤çš„ãªè³ªå•ç”Ÿæˆã‚„æ¨æ¸¬ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é€šã˜ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã«å¯¾ã™ã‚‹å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ã»ã‹ã€ã•ã‚‰ã«æ¬¡ã®è³ªå•ã‚’æ±ºå®šã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€è³ªå•ã®ç¨®é¡ï¼ˆä¾‹ãˆã°ã€åœ°åã‚„å›½åã€æ–‡åŒ–è²¡ãªã©ï¼‰ã‚„ç‰¹å¾´ï¼ˆå¤§é™¸ã‚„æ–‡å­—ã®æœ€åˆãªã©ï¼‰ã«åŸºã¥ãå‡¦ç†ãŒã‚ã‚Šã¾ã™ã€‚

5. **ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**:
   - `gc`ãŠã‚ˆã³`torch.cuda`: ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’è¡Œã„ã€GPUãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªã‚¢ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

### çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®åŸºç›¤ã‚’æä¾›ã—ã¦ãŠã‚Šã€ç‰¹å®šã®å¯¾è±¡ã‚’å½“ã¦ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ãªè³ªå•ã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã—ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦å¾—ã‚‰ã‚ŒãŸæƒ…å ±ã‚’åŠ¹æœçš„ã«åˆ©ç”¨ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã€å¿œç­”å‡¦ç†ã®ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã¤ã„ã¦ã‚‚è©³ç´°ã«è¨˜è¼‰ã•ã‚Œã¦ãŠã‚Šã€å®Ÿç”¨çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦é›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯ã€kaggle/pythonã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°ã‚’æ‰±ã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ›ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆä¾‹: pd.read_csvï¼‰

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼ˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹Shift+Enterã‚’æŠ¼ã™ã¨ï¼‰å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€è¦§è¡¨ç¤ºã•ã‚Œã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename)) # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ãã®ãƒ‡ãƒ¼ã‚¿ã¯ "Save & Run All" ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
# ã¾ãŸã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ /kaggle/temp/ ã«ã‚‚æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ãŒã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece # immutabledictã¨sentencepieceã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ï¼ˆå‡ºåŠ›ã¯éè¡¨ç¤ºï¼‰
mkdir /kaggle/working/submission/lib/gemma/ # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/ # ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
import json # JSONãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import os # OSã«é–¢ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import pandas as pd # ãƒ‡ãƒ¼ã‚¿æ“ä½œã®ãŸã‚ã®pandasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import random # ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import string # æ–‡å­—åˆ—æ“ä½œã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import torch # PyTorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ·±å±¤å­¦ç¿’ç”¨ï¼‰

from os import path # OSã®pathæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from pathlib import Path # ãƒ‘ã‚¹æ“ä½œã®ãŸã‚ã®Pathã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from random import choice # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã™ã‚‹ãŸã‚ã®choiceé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from string import Template # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—æ“ä½œã®ãŸã‚ã®Templateã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from transformers import T5Tokenizer, T5ForConditionalGeneration # T5ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©
KEYWORDS_JSON = """
[
  {
    "category": "country", # ã‚«ãƒ†ã‚´ãƒª: å›½
    "words": [
      {
        "keyword": "afghanistan", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã‚¢ãƒ•ã‚¬ãƒ‹ã‚¹ã‚¿ãƒ³
        "alts": [] # ä»£æ›¿å˜èª: ãªã—
      },
      {
        "keyword": "albania", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã‚¢ãƒ«ãƒãƒ‹ã‚¢
        "alts": [] # ä»£æ›¿å˜èª: ãªã—
      },
      {
        "keyword": "algeria", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã‚¢ãƒ«ã‚¸ã‚§ãƒªã‚¢
        "alts": [] # ä»£æ›¿å˜èª: ãªã—
      },
      ...
      {
        "keyword": "zimbabwe", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã‚¸ãƒ³ãƒãƒ–ã‚¨
        "alts": [] # ä»£æ›¿å˜èª: ãªã—
      }
    ]
  },
  {
    "category": "city", # ã‚«ãƒ†ã‚´ãƒª: éƒ½å¸‚
    "words": [
      {
        "keyword": "amsterdam netherlands", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ , ã‚ªãƒ©ãƒ³ãƒ€
        "alts": ["amsterdam", "amsterdam holland"] # ä»£æ›¿å˜èª: ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ , ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ ãƒ»ãƒ›ãƒ©ãƒ³ãƒˆ
      },
      ...
      {
        "keyword": "zurich switzerland", # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ’, ã‚¹ã‚¤ã‚¹
        "alts": ["zurich"] # ä»£æ›¿å˜èª: ãªã—
      }
    ]
  },
  ...
]
""" # JSONã®å†…å®¹ã®çµ‚ã‚ã‚Š
```

---The following area is a Code cell (cell numver is 4)---
```python
keywords_data = json.loads(KEYWORDS_JSON) # JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’Pythonã®è¾æ›¸ã¨ã—ã¦èª­ã¿è¾¼ã‚€

# DataFrameã®è¡Œã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆã‚’ä½œæˆ
rows = []

# JSONã®æ§‹é€ ã‚’è¡Œã«ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã™ã‚‹
for item in keywords_data:
    category = item["category"] # ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    for word in item["words"]:
        rows.append({
            "keyword": word["keyword"], # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
            "category": category, # ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
            "continent": "",  # å¤§é™¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¿½åŠ å¯èƒ½
            "first_letter": word["keyword"][0].upper()  # æœ€åˆã®æ–‡å­—ã‚’å¤§æ–‡å­—ã«å¤‰æ›
        })

# DataFrameã‚’ä½œæˆ
keywords = pd.DataFrame(rows) # ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰DataFrameã‚’ä½œæˆ
keywords.head() # DataFrameã®æœ€åˆã®5è¡Œã‚’è¡¨ç¤º
```

---The following area is a Code cell (cell numver is 5)---
```python
import matplotlib.pyplot as plt
from matplotlib.patches import Rectangle

def wrap_text(text, max_width, font_size):
    words = text.split() # ãƒ†ã‚­ã‚¹ãƒˆã‚’å˜èªã«åˆ†å‰²
    lines = [] # è¡Œã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
    line = "" # è¡Œã®åˆæœŸåŒ–
    for word in words:
        test_line = f"{line} {word}".strip() # æ¬¡ã®è¡Œã‚’ãƒ†ã‚¹ãƒˆ
        if len(test_line) * font_size > max_width and line: # æœ€å¤§å¹…ã‚’è¶…ãˆãŸã‚‰
            lines.append(line) # ç¾åœ¨ã®è¡Œã‚’ä¿å­˜
            line = word # æ–°ã—ã„è¡Œã‚’é–‹å§‹
        else:
            line = test_line # è¡Œã‚’æ›´æ–°
    if line:
        lines.append(line) # æœ€å¾Œã®è¡Œã‚’ä¿å­˜
    return lines # è¡Œã‚’è¿”ã™

def renderer(context):
    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—
    act = context['act']
    agents = context['agents']
    environment = context['environment']
    frame = context['frame']
    height = context.get('height', 800) # é«˜ã•ã®å–å¾—
    interactive = context['interactive']
    is_interactive = context['is_interactive']
    parent = context['parent']
    step = context['step']
    update = context['update']
    width = context.get('width', 1200) # å¹…ã®å–å¾—

    # å…±é€šã®å¯¸æ³•
    max_width = 1200
    max_height = 800
    canvas_size = min(height, width) # æœ€å°ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º
    unit = 8
    offset = canvas_size * 0.1 if canvas_size > 400 else unit / 2 # ã‚ªãƒ•ã‚»ãƒƒãƒˆã®è¨ˆç®—
    cell_size = (canvas_size - offset * 2) / 3 # ã‚»ãƒ«ã‚µã‚¤ã‚ºã®è¨ˆç®—

    # å›³ã¨è»¸ã‚’ä½œæˆ
    fig, ax = plt.subplots(figsize=(width / 100, height / 100)) # å›³ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
    ax.set_xlim(0, width) # xè»¸ã®ç¯„å›²ã‚’è¨­å®š
    ax.set_ylim(0, height) # yè»¸ã®ç¯„å›²ã‚’è¨­å®š
    ax.invert_yaxis() # yè»¸ã®åè»¢
    ax.set_axis_off() # è»¸ã‚’éè¡¨ç¤º

    # ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’å–å¾—
    try:
        steps = environment['steps']
        state = steps[step] # ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å–å¾—
    except (IndexError, KeyError) as e:
        print(f"Error accessing environment steps: {e}") # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return

    print("State:", state) # ã‚¹ãƒ†ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º

    if not isinstance(state, dict):
        print("State is not properly defined.") # ã‚¹ãƒ†ãƒ¼ãƒˆãŒä¸æ­£ãªå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return

    # ã‚¹ãƒ†ãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
    try:
        observation = state['observation']
        team1_index = len(observation['questions']) - 1
        team2_index = len(observation['questions']) - 1

        team1_question = observation['questions'][team1_index] if team1_index >= 0 else ""
        team2_question = observation['questions'][team2_index] if team2_index >= 0 else ""

        team1_answer = observation['answers'][team1_index] if len(observation['questions']) == len(observation['answers']) and team1_index >= 0 else ""
        team2_answer = observation['answers'][team2_index] if len(observation['questions']) == len(observation['answers']) and team2_index >= 0 else ""

        team1_guess = observation['guesses'][team1_index] if len(observation['questions']) == len(observation['guesses']) and team1_index >= 0 else ""
        team2_guess = observation['guesses'][team2_index] if len(observation['questions']) == len(observation['guesses']) and team2_index >= 0 else ""

        team1_reward = str(state['reward']) if state['reward'] != 0 else ""
        team2_reward = str(state['reward']) if state['reward'] != 0 else ""
    except (IndexError, KeyError) as e:
        print(f"Error extracting data from state: {e}") # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return

    info = environment.get('info', {})
    team1_text = info.get('TeamNames', ['Team 1'])[0] # ãƒãƒ¼ãƒ 1ã®åå‰ã‚’å–å¾—
    team2_text = info.get('TeamNames', ['Team 2'])[1] # ãƒãƒ¼ãƒ 2ã®åå‰ã‚’å–å¾—

    # ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    padding = 20
    row_width = (min(max_width, width) - padding * 3 - 100) / 2 # è¡Œã®å¹…ã‚’è¨ˆç®—
    label_x = padding # ãƒ©ãƒ™ãƒ«ã®xåº§æ¨™
    team1_x = padding + 100 # ãƒãƒ¼ãƒ 1ã®xåº§æ¨™
    team2_x = padding * 2 + row_width + 100 # ãƒãƒ¼ãƒ 2ã®xåº§æ¨™
    line_height = 40 # è¡Œã®é«˜ã•
    label_y = 120 # ãƒ©ãƒ™ãƒ«ã®yåº§æ¨™
    question_y = 160 # è³ªå•ã®yåº§æ¨™
    answer_y = 200 # å›ç­”ã®yåº§æ¨™
    guess_y = 240 # æ¨æ¸¬ã®yåº§æ¨™
    score_y = 280 # ã‚¹ã‚³ã‚¢ã®yåº§æ¨™

    # ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
    font_size = 20 # ãƒ•ã‚©ãƒ³ãƒˆã®ã‚µã‚¤ã‚º

    # ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
    try:
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡Œ
        ax.text(label_x, line_height, f"Keyword: {observation['keyword']}", fontsize=font_size, color='#FFFFFF') # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æç”»

        # ãƒãƒ¼ãƒ è¡Œ
        ax.text(team1_x, line_height, team1_text, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 1ã®åå‰ã‚’æç”»
        ax.text(team2_x, line_height, team2_text, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 2ã®åå‰ã‚’æç”»

        # è³ªå•è¡Œ
        ax.text(label_x, question_y, "Question:", fontsize=font_size, color='#FFFFFF') # è³ªå•ãƒ©ãƒ™ãƒ«ã‚’æç”»
        wrapped_text1 = wrap_text(team1_question, row_width, font_size) # ãƒãƒ¼ãƒ 1ã®è³ªå•ã‚’ãƒ©ãƒƒãƒ—
        wrapped_text2 = wrap_text(team2_question, row_width, font_size) # ãƒãƒ¼ãƒ 2ã®è³ªå•ã‚’ãƒ©ãƒƒãƒ—
        for i, line in enumerate(wrapped_text1):
            ax.text(team1_x, question_y - i * line_height, line, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 1ã®ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸè³ªå•ã‚’æç”»
        for i, line in enumerate(wrapped_text2):
            ax.text(team2_x, question_y - i * line_height, line, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 2ã®ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸè³ªå•ã‚’æç”»

        # å›ç­”è¡Œ
        ax.text(label_x, answer_y, "Answer:", fontsize=font_size, color='#FFFFFF') # å›ç­”ãƒ©ãƒ™ãƒ«ã‚’æç”»
        ax.text(team1_x, answer_y, team1_answer, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 1ã®å›ç­”ã‚’æç”»
        ax.text(team2_x, answer_y, team2_answer, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 2ã®å›ç­”ã‚’æç”»

        # æ¨æ¸¬è¡Œ
        ax.text(label_x, guess_y, "Guess:", fontsize=font_size, color='#FFFFFF') # æ¨æ¸¬ãƒ©ãƒ™ãƒ«ã‚’æç”»
        ax.text(team1_x, guess_y, team1_guess, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 1ã®æ¨æ¸¬ã‚’æç”»
        ax.text(team2_x, guess_y, team2_guess, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 2ã®æ¨æ¸¬ã‚’æç”»

        # å ±é…¬è¡Œ
        ax.text(label_x, score_y, "Reward:", fontsize=font_size, color='#FFFFFF') # å ±é…¬ãƒ©ãƒ™ãƒ«ã‚’æç”»
        ax.text(team1_x, score_y, team1_reward, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 1ã®å ±é…¬ã‚’æç”»
        ax.text(team2_x, score_y, team2_reward, fontsize=font_size, color='#FFFFFF') # ãƒãƒ¼ãƒ 2ã®å ±é…¬ã‚’æç”»

        plt.show() # ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
    except Exception as e:
        print(f"Error during rendering: {e}") # æç”»ä¸­ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

# ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¾‹
context = {
    'act': lambda x: print(f"Action: {x}"), # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®é–¢æ•°
    'agents': [],
    'environment': {
        'steps': [
            {'observation': {'questions': ['What is AI?', 'Define ML.'], 'answers': ['Artificial Intelligence', 'Machine Learning'], 'guesses': ['AI', 'ML'], 'keyword': 'AI'}, 'reward': 10}, # ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿
        ],
        'info': {'TeamNames': ['Team Alpha', 'Team Beta']} # ãƒãƒ¼ãƒ åæƒ…å ±
    },
    'frame': None,
    'height': 800, # é«˜ã•
    'interactive': True,
    'is_interactive': lambda: True,
    'parent': None,
    'step': 0,
    'update': lambda: None,
    'width': 1200 # å¹…
}

renderer(context) # æç”»é–¢æ•°ã‚’å‘¼ã³å‡ºã™
```

---The following area is a Code cell (cell numver is 6)---
```python
import pandas as pd # pandasã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from transformers import AutoTokenizer, AutoModelForCausalLM, AutoConfig # Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å¿…è¦ãªã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import torch # PyTorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import numpy as np # NumPyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import gc # ã‚¬ãƒ¼ãƒ™ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import os # OSã«é–¢ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŠã‚ˆã³è¨­å®š
model_name = "abacusai/Llama-3-Smaug-8B"  # ãƒ¡ãƒ¢ãƒªã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯å°ã•ã„ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œè¨
VERBOSE = True  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ã«Trueã«è¨­å®š

# GPUã‚µãƒãƒ¼ãƒˆã§ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
def load_model_and_tokenizer(model_name):
    try:
        config = AutoConfig.from_pretrained(model_name) # ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
        model = AutoModelForCausalLM.from_pretrained( # æ¡ä»¶ä»˜ãç”Ÿæˆç”¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
            model_name,
            config=config,
            trust_remote_code=True, # ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä¿¡é ¼
            device_map="auto"  # é©åˆ‡ãªãƒ‡ãƒã‚¤ã‚¹ã«ãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®
        )
        tokenizer = AutoTokenizer.from_pretrained(model_name) # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰
        model.eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
        return model, tokenizer # ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’è¿”ã™
    except Exception as e:
        if VERBOSE:
            print(f"Error loading model: {e}") # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return None, None # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯Noneã‚’è¿”ã™

# Yes/Noè³ªå•ç”¨ã«LLMã¨å¯¾è©±ã™ã‚‹é–¢æ•°
def get_yes_no(question, keyword, tokenizer, model):
    try:
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        if keyword in keywords.keyword.values: # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            row = keywords.loc[keywords.keyword == keyword].iloc[0] # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹è¡Œã‚’å–å¾—
            category = row.category # ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
            continent = row.continent # å¤§é™¸æƒ…å ±ã‚’å–å¾—
            negate = { # å¦å®šè¦ç´ ã‚’å®šç¾©
                "city": "It is not a country. It is not a landmark.",
                "country": "It is not a city. It is not a landmark.",
                "landmark": "It is not a city. It is not a country.",
            }
            prompt = f"We are playing 20 questions. The keyword is {keyword}. It is a {category}. {negate[category]} This word has first letter {keyword[0]}. This {category} is located in {continent}. {question}"
        else:
            prompt = f"We are playing 20 questions. The keyword is {keyword}. It is a thing. It is not a city. It is not a country. It is not a landmark. This word has first letter {keyword[0]}. {question}"

        messages = [
            {"role": "system", "content": "Answer yes or no to the following question and nothing else."}, # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            {"role": "user", "content": prompt} # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        ]

        # ãƒãƒ£ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
        text = tokenizer.apply_chat_template(
            messages,
            tokenize=False,
            add_generation_prompt=True
        )
        model_inputs = tokenizer([text], return_tensors="pt").to('cuda') # ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ãŸå…¥åŠ›ã‚’GPUã«è»¢é€

        pad_token_id = tokenizer.pad_token_id # ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãƒˆãƒ¼ã‚¯ãƒ³IDã‚’å–å¾—
        if pad_token_id is None:
            pad_token_id = tokenizer.eos_token_id # Noneã®å ´åˆã¯EOSãƒˆãƒ¼ã‚¯ãƒ³IDã‚’ä½¿ç”¨

        # æ··åˆç²¾åº¦ã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’ç”Ÿæˆ
        with torch.no_grad(), torch.cuda.amp.autocast():
            generated_ids = model.generate(
                model_inputs.input_ids,
                attention_mask=model_inputs.attention_mask,
                pad_token_id=pad_token_id,
                max_new_tokens=1 # æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ€å¤§æ•°ã‚’è¨­å®š
            )
        
        generated_ids = [
            output_ids[len(model_inputs.input_ids[0]):] for output_ids in generated_ids # ç”Ÿæˆã•ã‚ŒãŸIDã‚’æŠ½å‡º
        ]

        response = tokenizer.batch_decode(generated_ids, skip_special_tokens=True)[0] # å¿œç­”ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        if not "yes" in response.lower(): # å¿œç­”ãŒã€Œyesã€ã§ãªã‘ã‚Œã°
            response = "no" # ã€Œnoã€ã¨è¿”ã™
        else:
            response = "yes" # ã€Œyesã€ã¨è¿”ã™

        return response # æœ€çµ‚å¿œç­”ã‚’è¿”ã™
    
    except Exception as e:
        if VERBOSE:
            print(f"Error during agent execution: {e}") # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return "no" # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã€Œnoã€ã‚’è¿”ã™
    
def agent_fn(obs, cfg): # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°
    global keywords # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‚ç…§

    # å¿œç­”å¤‰æ•°ã®åˆæœŸåŒ–
    response = "no"  # å¿œç­”ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    
    try:
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        if keywords.empty: # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆ
            response = "Unable to process due to missing keywords." # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            return response

        # åˆæœŸåŒ–ãŒå¿…è¦ãªå¤‰æ•°
        cat_guess = 0  # ã‚«ãƒ†ã‚´ãƒªæ¨æ¸¬ç”¨ã‚«ã‚¦ãƒ³ã‚¿
        con_guess = 0  # å¤§é™¸æ¨æ¸¬ç”¨ã‚«ã‚¦ãƒ³ã‚¿
        let_guess = 0  # æœ€åˆã®æ–‡å­—æ¨æ¸¬ç”¨ã‚«ã‚¦ãƒ³ã‚¿
        category_yes = [] # ã€Œã¯ã„ã€å›ç­”ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ
        category_no = [] # ã€Œã„ã„ãˆã€å›ç­”ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ
        continent_yes = [] # ã€Œã¯ã„ã€å›ç­”ã®å¤§é™¸ãƒªã‚¹ãƒˆ
        continent_no = [] # ã€Œã„ã„ãˆã€å›ç­”ã®å¤§é™¸ãƒªã‚¹ãƒˆ
        first_letter_yes = [] # ã€Œã¯ã„ã€å›ç­”ã®æœ€åˆã®æ–‡å­—ãƒªã‚¹ãƒˆ
        first_letter_no = [] # ã€Œã„ã„ãˆã€å›ç­”ã®æœ€åˆã®æ–‡å­—ãƒªã‚¹ãƒˆ
        extra_guess = None # è¿½åŠ ã®æ¨æ¸¬

        categories = ["city", "country", "landmark"] # ã‚«ãƒ†ã‚´ãƒªã®ãƒªã‚¹ãƒˆ
        continents = ["Europe", "Asia", "North America", "Africa", "South America", "Australia"] # å¤§é™¸ã®ãƒªã‚¹ãƒˆ

        if obs.turnType == "ask": # å•ã„ã‹ã‘ã®å ´åˆ
            if (cat_guess < 3) and (len(category_yes) == 0): # ã‚«ãƒ†ã‚´ãƒªã®æ¨æ¸¬
                response = f"Is the keyword the name of a {categories[cat_guess]}?" # è³ªå•ã®æ§‹ç¯‰
                cat_guess += 1 # ã‚«ãƒ†ã‚´ãƒªã‚«ã‚¦ãƒ³ã‚¿ã®å¢—åŠ 
            elif (con_guess < 6) and (len(continent_yes) == 0): # å¤§é™¸ã®æ¨æ¸¬
                category = "place" # å ´æ‰€ã¨ã—ã¦åˆæœŸåŒ–
                if len(category_yes) == 1: 
                    category = category_yes[0] # æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªã‚’ã‚»ãƒƒãƒˆ
                response = f"Is the {category} located in {continents[con_guess]}?" # è³ªå•ã®æ§‹ç¯‰
                con_guess += 1 # å¤§é™¸ã‚«ã‚¦ãƒ³ã‚¿ã®å¢—åŠ 
            else:
                IDX = keywords.category.isin(category_yes) # ã‚«ãƒ†ã‚´ãƒªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                IDX = IDX & (keywords.continent.isin(continent_yes)) # å¤§é™¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                first_letters = list(keywords.loc[IDX, "first_letter"].value_counts().index.values) # æœ€åˆã®æ–‡å­—ã®ãƒªã‚¹ãƒˆ
                if let_guess < len(first_letters): # æœ€åˆã®æ–‡å­—ãŒãƒªã‚¹ãƒˆã«ã‚ã‚‹å ´åˆ
                    response = f"Does the keyword begin with the letter {first_letters[let_guess]}?" # è³ªå•ã®æ§‹ç¯‰
                else:
                    IDX = keywords.guess == 0 # æ¨æ¸¬ãŒåˆã‚ã¦ã®å ´åˆ
                    if len(category_yes) > 0: IDX = IDX & (keywords.category.isin(category_yes)) # ã€Œã¯ã„ã€å›ç­”å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    if len(category_no) > 0: IDX = IDX & (~keywords.category.isin(category_no)) # ã€Œã„ã„ãˆã€å›ç­”å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    if len(continent_yes) > 0: IDX = IDX & (keywords.continent.isin(continent_yes)) # ã€Œã¯ã„ã€å›ç­”å¯¾è±¡å¤§é™¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    if len(continent_no) > 0: IDX = IDX & (~keywords.continent.isin(continent_no)) # ã€Œã„ã„ãˆã€å›ç­”å¯¾è±¡å¤§é™¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    if len(first_letter_yes) > 0: IDX = IDX & (keywords.first_letter.isin(first_letter_yes)) # ã€Œã¯ã„ã€å›ç­”å¯¾è±¡æœ€åˆã®æ–‡å­—ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    if len(first_letter_no) > 0: IDX = IDX & (~keywords.first_letter.isin(first_letter_no)) # ã€Œã„ã„ãˆã€å›ç­”å¯¾è±¡æœ€åˆã®æ–‡å­—ã‚’ãƒ•ã‚£ãƒ«ã‚¿

                    try:
                        guess = keywords.loc[IDX].sample(1).index.values[0] # æ¨æ¸¬ã‚’æŠ½å‡º
                        keywords.loc[guess, 'guess'] = 1 # æ¨æ¸¬ãƒãƒ¼ã‚¯
                        response = keywords.loc[guess, "keyword"] # æ¨æ¸¬çµæœã‚’å–å¾—
                    except:
                        response = np.random.choice(keywords.keyword.values) # ãƒ©ãƒ³ãƒ€ãƒ ãªæ¨æ¸¬ã‚’ç”Ÿæˆ
                    extra_guess = response # è¿½åŠ æ¨æ¸¬ã«ã‚»ãƒƒãƒˆ
                    response = f"Is it {response}?" # è³ªå•ã®æ§‹ç¯‰
                let_guess += 1 # æœ€åˆã®æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ã®å¢—åŠ 

        elif obs.turnType == "guess": # æ¨æ¸¬ã®å ´åˆ
            category_yes = [] # ã€Œã¯ã„ã€å›ç­”ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            category_no = [] # ã€Œã„ã„ãˆã€å›ç­”ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            for k in range(cat_guess): # ã‚«ãƒ†ã‚´ãƒªæ¨æ¸¬ã«å¯¾ã™ã‚‹å›ç­”ã‚’å–å¾—
                if obs.answers[k] == "yes":
                    category_yes.append(categories[k]) # ã€Œã¯ã„ã€å›ç­”ã‚’è¿½åŠ 
                else:
                    category_no.append(categories[k]) # ã€Œã„ã„ãˆã€å›ç­”ã‚’è¿½åŠ 
            if (cat_guess == 3) and (len(category_yes) == 0): # å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒªãŒã€Œã„ã„ãˆã€ã ã£ãŸå ´åˆ
                category_yes = ["city", "country", "landmark"] # ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã‚’å¯¾è±¡ã«ã™ã‚‹
                category_no = [] # ã€Œã„ã„ãˆã€ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

            continent_yes = [] # å¤§é™¸ã€Œã¯ã„ã€ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            continent_no = [] # å¤§é™¸ã€Œã„ã„ãˆã€ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            for k in range(con_guess): # å¤§é™¸æ¨æ¸¬ã«å¯¾ã™ã‚‹å›ç­”ã‚’å–å¾—
                if obs.answers[k + cat_guess] == "yes":
                    continent_yes.append(continents[k]) # ã€Œã¯ã„ã€å›ç­”ã‚’è¿½åŠ 
                else:
                    continent_no.append(continents[k]) # ã€Œã„ã„ãˆã€å›ç­”ã‚’è¿½åŠ 
            if (con_guess == 6) and (len(continent_yes) == 0): # å…¨ã¦ã®å¤§é™¸ãŒã€Œã„ã„ãˆã€ã ã£ãŸå ´åˆ
                continent_yes = ["Europe", "Asia", "North America", "Africa", "South America", "Australia"] # ã™ã¹ã¦ã®å¤§é™¸ã‚’å¯¾è±¡ã«ã™ã‚‹
                continent_no = [] # ã€Œã„ã„ãˆã€ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

            first_letter_yes = [] # æœ€åˆã®æ–‡å­—ã€Œã¯ã„ã€ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            first_letter_no = [] # æœ€åˆã®æ–‡å­—ã€Œã„ã„ãˆã€ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            for k in range(let_guess): # æœ€åˆã®æ–‡å­—æ¨æ¸¬ã«å¯¾ã™ã‚‹å›ç­”ã‚’å–å¾—
                if k >= len(first_letters): continue # æ–‡å­—æ•°ãŒã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã‚‹å ´åˆã€ã‚¹ã‚­ãƒƒãƒ—
                if obs.answers[k + cat_guess + con_guess] == "yes":
                    first_letter_yes.append(first_letters[k]) # ã€Œã¯ã„ã€å›ç­”ã‚’è¿½åŠ 
                else:
                    first_letter_no.append(first_letters[k]) # ã€Œã„ã„ãˆã€å›ç­”ã‚’è¿½åŠ 

            # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’é©ç”¨
            IDX = keywords.guess == 0
            if len(category_yes) > 0: IDX = IDX & (keywords.category.isin(category_yes))
            if len(category_no) > 0: IDX = IDX & (~keywords.category.isin(category_no))
            if len(continent_yes) > 0: IDX = IDX & (keywords.continent.isin(continent_yes))
            if len(continent_no) > 0: IDX = IDX & (~keywords.continent.isin(continent_no))
            if len(first_letter_yes) > 0: IDX = IDX & (keywords.first_letter.isin(first_letter_yes))
            if len(first_letter_no) > 0: IDX = IDX & (~keywords.first_letter.isin(first_letter_no))

            try:
                guess = keywords.loc[IDX].sample(1).index.values[0] # æ¨æ¸¬ã‚’æŠ½å‡º
                keywords.loc[guess, 'guess'] = 1 # æ¨æ¸¬ãƒãƒ¼ã‚¯
                response = keywords.loc[guess, "keyword"] # æ¨æ¸¬çµæœã‚’å–å¾—
            except:
                response = np.random.choice(keywords.keyword.values) # ãƒ©ãƒ³ãƒ€ãƒ ãªæ¨æ¸¬ã‚’ç”Ÿæˆ

            if (let_guess > 0) and (let_guess >= len(first_letters)) and (obs.answers[-1] == "yes"): # æœ€å¾Œã®å›ç­”ãŒã€Œã¯ã„ã€ã®å ´åˆ
                response = extra_guess # è¿½åŠ ã®æ¨æ¸¬ã‚’å¿œç­”

        elif obs.turnType == "answer": # å›ç­”ã®å ´åˆ
            if obs.keyword.lower() in obs.questions[-1].lower(): # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè³ªå•ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                response = "yes" # ã€Œã¯ã„ã€ã¨å¿œç­”
            else:
                response = get_yes_no(obs.questions[-1], obs.keyword, tokenizer, model) # LLMã«å•ã„åˆã‚ã›

        else:
            response = "yes"  # ã™ã¹ã¦å¤–ã‚ŒãŸå ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”

    except Exception as e:
        if VERBOSE:
            print(f"Error during agent execution: {e}") # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

    return response  # å¿œç­”ã‚’å¸¸ã«è¿”ã™

class Observation: # è¦³å¯Ÿã‚¯ãƒ©ã‚¹ã®å®šç¾©
    def __init__(self, turnType, answers=None, keyword=None, questions=None):
        self.turnType = turnType
        self.answers = answers or [] # å›ç­”ãƒªã‚¹ãƒˆ
        self.keyword = keyword
        self.questions = questions or [] # è³ªå•ãƒªã‚¹ãƒˆ

# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    model, tokenizer = load_model_and_tokenizer(model_name) # ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰
    
    observation_object = Observation( # è¦³å¯Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        turnType="ask",
        questions=["Is it a country?"]  # è³ªå•ã®ä¾‹
    )
    configuration_object = {}  # å¿…è¦ãªè¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    
    response = agent_fn(observation_object, configuration_object) # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    print(f"Agent response: {response}") # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’è¡¨ç¤º

    # ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    del model, tokenizer
    gc.collect() # ã‚¬ãƒ¼ãƒ™ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    torch.cuda.empty_cache() # CUDAã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
```

---The following area is a Code cell (cell numver is 7)---
```python
!apt install pigz pv > /dev/null # pigzã¨pvãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå‡ºåŠ›ã¯éè¡¨ç¤ºï¼‰
```

---The following area is a Code cell (cell numver is 8)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf /kaggle/working/submission.tar.gz -C /kaggle/input/gemma-2/pytorch/gemma-2-2b-it/1 . # ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã—ã€å‡ºåŠ›ã•ã‚Œã‚‹åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
```

** @@@ Jupyter Notebook numver 56, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€æœ€çµ‚çš„ã« `submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å•é¡Œã¨ç›®çš„
ã€ŒLLM 20 Questionsã€ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³ªå•ã‚’é€šã˜ã¦ç‰¹å®šã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã€åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ä¾å­˜é–¢ä¿‚**: 
  - `immutabledict` ã‚„ `sentencepiece` ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¾ã™ã€‚

- **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã¨åˆæœŸåŒ–**: 
  - ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«ã¯Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€ç‰¹ã«`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯7BãŠã‚ˆã³2Bã®ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æŒ‡å®šã—ãŸãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«é¸æŠã—ã¦ã„ã¾ã™ã€‚

- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: 
  - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹**: 
  - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’ãã‚Œãã‚Œæ‹…å½“ã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯å†…éƒ¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦æ­£ã—ã„è³ªå•ã‚„ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### å‡ºåŠ›
æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚ã“ã®æˆæœç‰©ã«ã¯ã€ã™ã¹ã¦ã®å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒå”èª¿ãƒ—ãƒ¬ã‚¤ã«åŸºã¥ã„ãŸæ¨ç†ã‚’è¡Œã†ãŸã‚ã®å‡ºç™ºç‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚å‚åŠ è€…ã¯ã“ã®åŸºç›¤ã‚’å…ƒã«ã€è‡ªã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚„æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã•ã‚‰ã«æ”¹å–„ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions** ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã® **Submit to competition** è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ *Output* ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz` ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹ **Submit Agent** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/  # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # KAGGLE_AGENT_PATHã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # æŒ‡å®šã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆ¥ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b  # gemmaãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
from gemma.model import GemmaForCausalLM  # gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")  # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"  # ä»–ã®ãƒ‘ã‚¹ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

class GemmaFormatter:
    _start_token = '<start_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        self._few_shot_examples = few_shot_examples  # Few-shotä¾‹ã®ä¿å­˜
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self.reset()  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¿½åŠ 
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotä¾‹ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œé †åºã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †åºã‚’å¾ªç’°ã•ã›ã‚‹
        for fmt, turn in zip(formatters, turns):  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã¨ã‚¿ãƒ¼ãƒ³ã‚’çµåˆ
            fmt(turn)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å¤‰æ›´
    yield
    torch.set_default_dtype(torch.float)  # å…ƒã®dtypeã«æˆ»ã™

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
        self._device = torch.device(device)  # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant  # é‡å­åŒ–è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')  # é‡ã¿ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å¿œç­”ã‚’å¾—ã‚‹
        response = self._parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
        print(f"{response=}")  # å¿œç­”ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                'top_p': 0.1,  # ãƒˆãƒƒãƒ—ç¢ºç‡
                'top_k': 1,  # ãƒˆãƒƒãƒ—Kã®è¨­å®š
        }
        response = self.model.generate(  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            prompt,
            device=self._device,
            output_len=max_new_tokens,  # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,  # ãã®ä»–ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        else:
            keyword = match.group().lower()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–


def interleave_unequal(x, y):
    return [  # ä¸å‡ä¸€ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")  # è³ªå•ã™ã‚‹ã‚ˆã†æŒ‡ç¤º
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰äºˆæƒ³ã®æŒ‡ç¤º
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "Is it a person?"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•
            else:
                question = match.group()  # æŠ½å‡ºã—ãŸè³ªå•
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®äºˆæƒ³ã‚’è§£æ
            return guess
        else:
            raise ValueError("Unknown turn type:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='user')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")  # å›ç­”æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # å›ç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no'  # "yes"ã§ã‚ã‚Œã°yesã€ãã®ä»–ã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "You are an AI assistant designed to play the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š

few_shot_examples = [  # Few-shotä¾‹ã®è¨­å®š
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆOut of Memoryï¼‰ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "Agent not initialized."  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    return agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™

def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    if response is None or len(response) <= 1:  # å¿œç­”ãŒç©ºã‹é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆ
        return "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response  # é€šå¸¸ã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2  # submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Samar Elhissi
> 
> ä¾‹ã‚’ã‚ã‚ŠãŒã¨ã†ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„â€¦ã“ã®LLMã¯å¤šãã®è¨ˆç®—ã‚’å¿…è¦ã¨ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯å¼·åŠ›ãªGPUãŒå¿…è¦ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã€ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚
> > 
> > 

---

> ## Michael Kamal 92
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€few_shot_examplesã«ã¤ã„ã¦è³ªå•ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> > ä¾‹ãˆã°ã€( 'is it place?', 'yes-or-no' )ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€ãã‚Œã¨ã‚‚( 'is it place?', 'yes', ) ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'Now guess the keyword' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'no', 'Now guess the keyword', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿã©ã‚ŒãŒæ­£ã—ã„è³ªå•ã€å›ç­”ã€äºˆæ¸¬ã®ä½œã‚Šæ–¹ã§ã™ã‹ï¼Ÿ
> 
> ã‚‚ã†ä¸€ã¤ã®è³ªå•ã§ã™ãŒã€Gemmaã¯few_shot_examplesã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ

---

> ## Yukky_2801
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«å¤±æ•—ã—ãŸã¨çµ‚äº†ã—ã¾ã™ã€‚
> 
> submission.tar.gzã‚’ã‚¨ãƒ©ãƒ¼ã¨å…±ã«æå‡ºã§ãã¾ã›ã‚“ã€‚ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è§£æ±ºç­–ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

> ## Andres H. Zapke
> > ã‚‚ã¡ã‚ã‚“ã€Œgemma/pytorch/7b-it-quant/2ã€ã“ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å³å´ã‚’è¦‹ã¦ã€gemmaãƒ¢ãƒ‡ãƒ«ãŒãã“ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
>   
> > ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add Inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)
> > 
> > 
> > > ## Talal Mufti
> > > > ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸå¾Œã€ä¾ç„¶ã¨ã—ã¦å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€bashã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã€ã“ã‚ŒãŒç§ã«ã¨ã£ã¦ã†ã¾ãã„ãã¾ã—ãŸï¼š
> > > > !tar --use-compress-program='pigz --fast --recursive | pv' -f submission.tar.gz -c /kaggle/working/submission . -c /kaggle/input/gemma/pytorch/7b-it-quant/2

---

> ## Muhammad Hadi13
> 
> ãªãœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã«ã€å¸¸ã«1.35MBä»¥ä¸Šã®å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãšã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¤±æ•—ã™ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Ryanã®å‡ºåŠ›ã¯ç´„7GBã§ã—ãŸã€‚ã“ã®ä»¶ã«ã¤ã„ã¦åŠ©ã‘ãŒå¿…è¦ã§ã™ï¼ï¼
> 
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> > tar: gemma/pytorch: Cannot stat: No such file or directory
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸã€‚

> ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’äº‹å‰ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > > 
> > > ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)

---

> ## Ship of Theseus
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community
> 
> 

---

> ## shiv_314
> 
> çš†ã•ã‚“ï¼ä¸€ã¤åŠ©ã‘ãŒå¿…è¦ã§ã™ã€‚gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
> 
> Pythonã®ãŸã‚ã«ã™ã§ã«æ­£ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼

---

> ## dedq
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community

---

> ## Code Hacker
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«tar.gzã‚’æå‡ºã—ã‚ˆã†ã¨ã—ãŸãŒã€å¤±æ•—ã—ã¾ã—ãŸâ€¦

> ## Code Hacker
> > > ã“ã®ãƒ¢ãƒ‡ãƒ«ã«åŒæ„ã—ãªã‹ã£ãŸã€‚ä¸‹ã®èµ¤ã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯â€¦

---

> ## JAPerez
> 
> Great work Ryan!

---

> ## philipha2
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã“ã®ã‚³ãƒ³ãƒšã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚
> æå‡ºç‰©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹submission.tar.gzã‚’ã©ã“ã«ç½®ã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ 
> Submit agentsãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æå‡ºã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ 
> æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
> åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kanchan Maurya
> > > Submit agentsã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã€åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---

> ## vj4science
> 
> Thanks Ryan - this is a good head start to the competition! much appreciated!

---

> ## gb_kwon
> 
> Thank you so much for your COOL guidelines!

---

> ## Andres H. Zapke
> 
> main.pyã§ã€gemma_pytorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼šfrom gemma.configã€‚
> 
> ã“ã‚Œã¯ç§ã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ãŒã€gemmaã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ã€‚
> 
> è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®gemmaãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã®ã¨ã€Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã‚’è©¦ã¿ã¾ã—ãŸãŒã€‚ä½•ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

> ## Duy Thai
> 
> ã“ã‚“ã«ã¡ã¯[@ryanholbrook](https://www.kaggle.com/ryanholbrook)ã€ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è©¦ã—ãŸã¨ã“ã‚ã€ã€Œæ·»ä»˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è¿½åŠ ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ã¯Modelãƒ‘ãƒãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã«ã¤ã„ã¦ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸã¨ãã€ç§ã¯ã“ã‚Œã ã‘ã‚’è¦‹ã¦ã„ã¾ã™ï¼š

> ## Andres H. Zapke
> > > "Models"ã¸è¡Œãã€Gemmaã‚’æ¤œç´¢ã—ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

> ## Duy Thai
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---

> ## Kai_Huang
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã® !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2 ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã¨ãã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸ
> 
> ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kai_Huang
> > > ã‚ã‚ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å…¥åŠ›ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã™ã­ğŸ˜±

> ## D Prince Armand KOUMI
> > > ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆã¯ã€è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

> ## Qusay AL-Btoush
> 
> ã¨ã¦ã‚‚è‰¯ã„ã€Ryan 

---
```

** @@@ Jupyter Notebook numver 57, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã€ç‰¹ã«è³ªå•è€…ã¨å›ç­”è€…ã®äºŒã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦è³ªå•ã‚’è¡Œã£ãŸã‚Šã€å›ç­”ã‚’è¿”ã—ãŸã‚Šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## å–ã‚Šçµ„ã‚€å•é¡Œ
- **å•é¡Œ**: ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåŠ¹æœçš„ã«ç›¸äº’ä½œç”¨ã—ã€é™ã‚‰ã‚ŒãŸè³ªå•æ•°ã§æ­£è§£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã®åˆ¶ç´„ã«å¯¾å¿œã—ã€é©åˆ‡ãªè³ªå•ã¨æ¨æ¸¬ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `pandas`: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æƒ…å ±ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã€‚
   - `json`: JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã«ä½¿ç”¨ã€‚
   - `torch`: æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®ãŸã‚ã®PyTorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
   - `immutabledict`ã¨`sentencepiece`: ãƒ¢ãƒ‡ãƒ«ã®ä¾å­˜é–¢ä¿‚ã¨ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‚

2. **ã‚¯ãƒ©ã‚¹ã¨æ§‹é€ **:
   - **GemmaFormatter**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç®¡ç†ã—ã€ç¾åœ¨ã®ä¼šè©±çŠ¶æ…‹ã‚’ä¿æŒã€‚
   - **Observation**: èª²é¡Œã«å¯¾ã™ã‚‹è¦³å¯Ÿçµæœã‚’ç®¡ç†ã—ã€éå»ã®è³ªå•ãƒ»å›ç­”ãƒ»æ¨æ¸¬ã‚’ãƒˆãƒ©ãƒƒã‚¯ã€‚
   - **GemmaAgent**: åŸºåº•ã‚¯ãƒ©ã‚¹ã¨ã—ã¦ã€è³ªå•è€…ã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã‚’æä¾›ã€‚
   - **GemmaQuestionerAgent**: è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ã®å…·ä½“çš„ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã€‚
   - **GemmaAnswererAgent**: å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã€‚

3. **ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å°‘æ•°ã‚·ãƒ§ãƒƒãƒˆä¾‹**:
   - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å°‘æ•°ã‚·ãƒ§ãƒƒãƒˆä¾‹ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’å°ããŸã‚ã«è¨­å®šã•ã‚Œã€ã‚²ãƒ¼ãƒ ã®ç›®çš„ã‚„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã«ã¤ã„ã¦æ˜ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…**:
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å‹•çš„ã«åˆæœŸåŒ–ã•ã‚Œã€è¦³å¯Ÿæƒ…å ±ã«åŸºã¥ã„ã¦é©åˆ‡ãªå‹•ä½œï¼ˆè³ªå•ã™ã‚‹ã€å›ç­”ã™ã‚‹ã€æ¨æ¸¬ã™ã‚‹ï¼‰ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€Notebookã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã®LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®å¤šãã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ãŠã‚Šã€è‡ªç„¶è¨€èªå‡¦ç†ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒé€²ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# pandasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’pdã¨ã„ã†åå‰ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™
# jsonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
from importlib.machinery import SourceFileLoader
# keywords.pyãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™
keywords = SourceFileLoader("keywords",'/kaggle/input/llm-20-questions/llm_20_questions/keywords.py').load_module()
# JSONå½¢å¼ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™
df = json.loads(keywords.KEYWORDS_JSON)

words = []
# ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†ã—ã¾ã™
for cat in df:
    # ã‚«ãƒ†ã‚´ãƒªåã¨ãã®å˜èªæ•°ã‚’è¡¨ç¤ºã—ã¾ã™
    print(cat['category'], len(cat['words']))
    # å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™
    for w in cat['words']:
        words.append([cat['category'], w["keyword"], w["alts"], "", "", 0.0, 0.0])

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¾ã™
df = pd.DataFrame(words, columns=['Category','Word','Alternatives', "Cat1", "Cat2", "Lat", "Lon"])
# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®æœ€åˆã®5è¡Œã‚’è¡¨ç¤ºã—ã¾ã™
df.head()
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
cd /kaggle/working
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™
rm -rf ./*
# immutabledictã¨sentencepieceã‚’æŒ‡å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
# gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null
# gemmaã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/
# gemma_pytorchå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
import os
import sys

# Kaggleã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    # Kaggleç’°å¢ƒã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    # ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

if os.path.exists(KAGGLE_AGENT_PATH):
    # ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"


import itertools
from typing import Iterable


class GemmaFormatter:
    _start_token = '<start_of_turn>'
    _end_token = '<end_of_turn>'

    # åˆæœŸåŒ–
    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"
        self.reset()

    # ç¾åœ¨ã®ä¼šè©±çŠ¶æ…‹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™
    def __repr__(self):
        return self._state

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¼šè©±ã«è¿½åŠ ã—ã¾ã™
    def user(self, prompt):
        self._state += self._turn_user.format(prompt)
        return self
        
    # ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¼šè©±ã«è¿½åŠ ã—ã¾ã™
    def model(self, prompt):
        self._state += self._turn_model.format(prompt)
        return self

    # ãƒ¦ãƒ¼ã‚¶ã®ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¨˜éŒ²ã—ã¾ã™
    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"
        return self

    # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¨˜éŒ²ã—ã¾ã™
    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"
        return self

    # ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¨˜éŒ²ã—ã¾ã™
    def end_turn(self):
        self._state += f"{self._end_token}\n"
        return self

    # ãƒªã‚»ãƒƒãƒˆãƒ¡ã‚½ãƒƒãƒ‰
    def reset(self):
        # `_state`ã‚’ç©ºã®æ–‡å­—åˆ—ã«åˆæœŸåŒ–ã—ã¾ã™
        self._state = ""  

        # æä¾›ã•ã‚ŒãŸå ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™
        if self._system_prompt is not None:
            self.user(self._system_prompt)  
            
        # æä¾›ã•ã‚ŒãŸå ´åˆã¯few-shotä¾‹ã‚’é©ç”¨ã—ã¾ã™
        if self._few_shot_examples is not None: 
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        # ç™ºè¨€ã‚’ä½¿ã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é †ç•ªã‚’æ±ºã‚ã¾ã™
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)
        for fmt, turn in zip(formatters, turns):
            fmt(turn)
        return self


import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torchãƒ‡ãƒ¼ã‚¿å‹ã‚’æŒ‡å®šã•ã‚ŒãŸdtypeã«è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)
    yield
    torch.set_default_dtype(torch.float)

from pydantic import BaseModel
    
class Observation(BaseModel):
    step: int
    role: t.Literal["guesser", "answerer"]
    turnType: t.Literal["ask", "answer", "guess"]
    keyword: str
    category: str
    questions: list[str]
    answers: list[str]
    guesses: list[str]
    
    @property
    def empty(self) -> bool:
        # è³ªå•ã€å›ç­”ã€æ¨æ¸¬ãŒã™ã¹ã¦ç©ºã§ã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
        return all(len(t) == 0 for t in [self.questions, self.answers, self.guesses])
    
    def get_history(self) -> t.Iterator[tuple[str, str, str]]:
        # éå»ã®è³ªå•ã€å›ç­”ã€æ¨æ¸¬ã‚’ã¾ã¨ã‚ã¦è¿”ã—ã¾ã™
        return itertools.zip_longest(self.questions, self.answers, self.guesses, fillvalue="[none]")

    def get_history_text(self, *, skip_guesses: bool = False, skip_answer: bool = False, skip_question: bool = False) -> str:
        if not self.empty:
            # éå»ã®ã‚„ã‚Šå–ã‚Šã®å±¥æ­´ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ•´å½¢ã—ã¾ã™
            history = "\n".join(
            f"""{'**Question:** ' + question if not skip_question else ''} -> {'**Answer:** ' + answer if not skip_answer else ''}
            {'**Previous Guess:** ' + guess if not skip_guesses else ''}
            """
            for i, (question, answer, guess) in enumerate(self.get_history())
            )
            return history
        return "ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚"


class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant
        self._device = torch.device(device)
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)

        print("ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™")
        
        # ãƒ¢ãƒ‡ãƒ«è¨­å®š
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")
        model_config.quant = "quant" in variant
        
        # ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
        with _set_default_tensor_type(model_config.get_dtype()):
            """TODO: ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¦‹ã¦ã¿ã‚‹"""
            model = GemmaForCausalLM(model_config)
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')
            model.load_weights(ckpt_path)
            self.model = model.to(self._device).eval()

    def __call__(self, obs, *args):
        self._start_session(obs)
        prompt = str(self.formatter)
        response = self._call_llm(prompt)
        response = self._parse_response(response, obs)
        print(f"{response=}")
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        """TODO: LLMã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ã¾ã™"""
        if sampler_kwargs is None:
            sampler_kwargs = {
                'temperature': 0.01,
                'top_p': 0.1,
                'top_k': 1,
        }
        response = self.model.generate(
            prompt,
            device=self._device,
            output_len=max_new_tokens,
            **sampler_kwargs,
        )
        return response

    def _parse_keyword(self, response: str):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã™
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError


def interleave_unequal(x, y):
    # 2ã¤ã®ãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆã—ã€ä¸è¶³ã—ã¦ã„ã‚‹è¦ç´ ã‚’é™¤å¤–ã—ã¾ã™
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]

"""TODO: è³ªå•è€…ã‚’èª¿æ•´ã—ã¾ã™"""
class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™
        self.formatter.reset()
        self.formatter.user("20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ã‚ãªãŸã¯è³ªå•è€…ã¨ã—ã¦ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='model')
        hints = self.turns_to_hints(turns)
        if obs.turnType == 'ask':
            if len(turns) == 0:
                self.formatter.user("ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚")
            else:
                self.formatter.user(f"ã“ã®ãƒªã‚¹ãƒˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒ’ãƒ³ãƒˆã«åŸºã¥ã„ã¦ã€ã¯ã„ã‹ã„ã„ãˆã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ãã ã•ã„: {hints}")
        elif obs.turnType == 'guess':
            self.formatter.user("ä»Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®æ¨æ¸¬ã‚’äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’æŠ½å‡ºã—ã¾ã™
            match = re.search(".+?\?", response.replace('*', ''))
            if match is None:
                question = "äººã§ã™ã‹ï¼Ÿ"
            else:
                question = match.group()
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)
            return guess
        else:
            raise ValueError("ä¸æ˜ãªã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—:", obs.turnType)
    
    # è³ªå•ã‚’è‚¯å®šã¾ãŸã¯å¦å®šã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã«å¤‰æ›ã™ã‚‹ãŸã‚ã«ã‚¿ãƒ¼ãƒ³ã‚’å¤‰æ›ã—ã¾ã™
    def turns_to_hints(self, turns):
        hints = []
        for i in range(0, len(turns), 2):
            question = turns[i]
            answer = turns[i+1]
            # hints.append(f"Question: {question} Answer: {answer}")
            
            if question.startswith('is it'):
                item = question[6:-1]  # "is it "ã®å¾Œã¨"?"ã®å‰ã®éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¾ã™
                if answer == 'yes':
                    transformed_statement = f"ãã‚Œã¯{item}ã§ã™"
                else:
                    transformed_statement = f"ãã‚Œã¯{item}ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
            elif question.startswith('does'):
                item = question[5:-1]  # "does "ã®å¾Œã¨"?"ã®å‰ã®éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¾ã™
                if answer == 'yes':
                    transformed_statement = f"ãã‚Œã¯{item}ã‚’ã—ã¾ã™"
                else:
                    transformed_statement = f"ãã‚Œã¯{item}ã‚’ã—ã¾ã›ã‚“"
            else:
                transformed_statement = f"èªè­˜ã§ããªã„è³ªå•å½¢å¼: {question}"

            hints.append(transformed_statement)

        return hints


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åŸºã¥ã„ã¦åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™
        self.formatter.user(f"20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ã‚ãªãŸã¯å›ç­”è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{obs.keyword}ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯{obs.category}ã§ã™ã€‚")
        turns = interleave_unequal(obs.questions, obs.answers)
        self.formatter.apply_turns(turns, start_agent='user')
        self.formatter.user(f"ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{obs.keyword}ã¨ãã®ã‚«ãƒ†ã‚´ãƒª{obs.category}ã«é–¢ã™ã‚‹è³ªå•ã§ã™ã€‚ã¯ã„ã¾ãŸã¯ã„ã„ãˆã§ç­”ãˆã€ã‚ãªãŸã®ç­”ãˆã‚’äºŒé‡ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã§å›²ã‚“ã§ãã ã•ã„ã€‚")
        self.formatter.start_model_turn()

    def _parse_response(self, response: str, obs: dict):
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å›ç­”ã‚’å–å¾—ã—ã¾ã™
        answer = self._parse_keyword(response)
        return 'yes' if 'yes' in answer else 'no'

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = """ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã¯ã„ã‹ã„ã„ãˆã§è³ªå•ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚ã‚ãªãŸã®ç›®çš„ã¯ã€ã§ãã‚‹ã ã‘å°‘ãªã„ã‚¿ãƒ¼ãƒ³ã§ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã€å‹ã¤ã“ã¨ã§ã™ã€‚"""

few_shot_examples = [
    "20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚",
    "äººã§ã™ã‹ï¼Ÿ", "**ã„ã„ãˆ**",
    "å ´æ‰€ã§ã™ã‹ï¼Ÿ", "**ã¯ã„**",
    "å›½ã§ã™ã‹ï¼Ÿ", "**ã¯ã„** ä»Šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚",
    "**ãƒ•ãƒ©ãƒ³ã‚¹**", "æ­£è§£!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¦ã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤‰æ•°ã‚’åˆæœŸåŒ–ã—ã¾ã™
agent = None

# è¦æ±‚ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«åŸºã¥ã„ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®é–¢æ•°
def get_agent(name: str):
    global agent
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚‰ãšã€è¦æ±‚ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œè³ªå•è€…ã€ã®å ´åˆ
    if agent is None and name == 'questioner':
        # GemmaQuestionerAgentã‚’ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã—ã¾ã™
        agent = GemmaQuestionerAgent(
            device='cuda:0',  # è¨ˆç®—ç”¨ã®ãƒ‡ãƒã‚¤ã‚¹
            system_prompt=system_prompt,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            few_shot_examples=few_shot_examples,  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æŒ¯ã‚‹èˆã„ã‚’å°ãä¾‹
        )
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ãŠã‚‰ãšã€è¦æ±‚ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œå›ç­”è€…ã€ã®å ´åˆ
    elif agent is None and name == 'answerer':
        # GemmaAnswererAgentã‚’åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã—ã¾ã™
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    # åˆæœŸåŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã—ã¾ã™
    return agent

# è¦³å¯Ÿã«åŸºã¥ã„ã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®é–¢æ•°
def agent_fn(obs, cfg):
    # è¦³å¯ŸãŒè³ªå•ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    if obs.turnType == "ask":
        # ã€Œè³ªå•è€…ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦è¦³å¯Ÿã«å¿œç­”ã—ã¾ã™
        response = get_agent('questioner')(obs)
    # è¦³å¯ŸãŒæ¨æ¸¬ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    elif obs.turnType == "guess":
        # ã€Œè³ªå•è€…ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦è¦³å¯Ÿã«å¿œç­”ã—ã¾ã™
        response = get_agent('questioner')(obs)
    # è¦³å¯ŸãŒå›ç­”ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚‹å ´åˆ
    elif obs.turnType == "answer":
        # ã€Œå›ç­”è€…ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦è¦³å¯Ÿã«å¿œç­”ã—ã¾ã™
        response = get_agent('answerer')(obs)
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒNoneã¾ãŸã¯éå¸¸ã«çŸ­ã„å ´åˆ
    if response is None or len(response) <= 1:
        # ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã€Œã¯ã„ã€ï¼‰ã‚’ä»®å®šã—ã¾ã™
        return "ã¯ã„"
    else:
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã£ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™
        return response
```

---The following area is a Code cell (cell numver is 4)---
```python
# pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
!apt install pigz pv > /dev/null
# # æå‡ºç‰©ã‚’tar.gzå½¢å¼ã§åœ§ç¸®ã—ã¾ã™ï¼ˆåœ§ç¸®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã—ã¦pigzã‚’ä½¿ç”¨ã—ã¾ã™ï¼‰
# !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/gemma/pytorch/7b-it-quant/2

# æå‡ºç‰©ã‚’tar.gzå½¢å¼ã§åœ§ç¸®ã—ã¾ã™ï¼ˆåœ§ç¸®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã—ã¦pigzã‚’ä½¿ç”¨ã—ã¾ã™ï¼‰
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2
```

---The following area is a Code cell (cell numver is 5)---
```python
# obsã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™
#     '''
#     ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ã‚²ãƒ¼ãƒ ã‹ã‚‰ã®è¦³å¯Ÿã‚’è¡¨ã—ã¾ã™ã€‚ 
#     turnTypeã¯['ask','answer','guess']ã®ã„ãšã‚Œã‹ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
#     ãƒ†ã‚¹ãƒˆã—ãŸã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™ã€‚
#     ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¾ã™ã€‚
#     è³ªå•ã¯æ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«è³ªå•å±¥æ­´ã‚’æ¸¡ã™å ´åˆã€‚
#     å›ç­”ã¯æ–‡å­—åˆ—ã®ãƒªã‚¹ãƒˆã§ã™ã€‚
#     responseã‚’ä½¿ç”¨ã—ã¦ã€è³ªå•ã‚’å›ç­”ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¸¡ã—ã¾ã™ã€‚
#     '''
#     def __init__(self, turnType, keyword, category, questions, answers):
#         self.turnType = turnType
#         self.keyword = keyword
#         self.category = category
#         self.questions = questions
#         self.answers = answers

# #ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¸¡ã™ãŸã‚ã®obsã®ä¾‹ã€‚è‡ªåˆ†ã®obsã‚’ã“ã“ã«æ¸¡ã—ã¾ã™ã€‚
# obs1 = obs(turnType='ask', 
#           keyword='paris', 
#           category='place', 
#           questions=['äººã§ã™ã‹ï¼Ÿ', 'å ´æ‰€ã§ã™ã‹ï¼Ÿ', 'å›½ã§ã™ã‹ï¼Ÿ', 'éƒ½å¸‚ã§ã™ã‹ï¼Ÿ'], 
#           answers=['ã„ã„ãˆ', 'ã¯ã„', 'ã„ã„ãˆ', 'ã¯ã„'])

# question = agent_fn(obs1, None)
# print(question)

# #ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ 
# #æå‡ºã‚¨ãƒ©ãƒ¼ã®è§£æ±ºã«ã¯å½¹ç«‹ã¡ã¾ã›ã‚“ãŒã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è©•ä¾¡ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```

** @@@ Jupyter Notebook numver 58, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter notebookã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆè¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ãŒã€è³ªå•ã‚’é€šã˜ã¦æ—¢çŸ¥ã®ãƒªã‚¹ãƒˆã‹ã‚‰å¯¾è±¡ã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’ç«¶ã£ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¯¾è±¡ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ã€é™ã‚‰ã‚ŒãŸæ•°ã®è³ªå•ã‚’é€šã˜ã¦æƒ…å ±ã‚’é›†ã‚ã¦ã„ãå½¢å¼ã®ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œè³ªå•è€…ã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã€ãã®ç›¸æ‰‹å½¹ã®ã€Œå›ç­”è€…ã€ã¨é€£æºã—ã¦ã€å¯èƒ½ãªé™ã‚Šæ—©ãæ­£è§£ã«ãŸã©ã‚Šç€ãã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æŠ€è¡“ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Python ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `numpy`: ç·šå½¢ä»£æ•°è¨ˆç®—å‘ã‘ã«ä½¿ç”¨ã€‚
   - `pandas`: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ æ“ä½œãŠã‚ˆã³ãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›ã«ä½¿ç”¨ã€‚
   - `random`ã€`re`: ãƒ©ãƒ³ãƒ€ãƒ ãªé¸æŠã¨æ­£è¦è¡¨ç¾ã‚’æ‰±ã†ãŸã‚ã«ä½¿ç”¨ã€‚

2. **ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:
   - `allwords`: ã‚²ãƒ¼ãƒ å†…ã§æ¨æ¸¬å¯¾è±¡ã¨ãªã‚‹åºƒç¯„ãªå˜èªã®ãƒªã‚¹ãƒˆã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆ**:
   - **agent_alpha**: è³ªå•ã®æ§‹ç¯‰ã¨æ¨æ¸¬ã‚’è¡Œã†ä¸»è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚éå»ã®è³ªå•ãŠã‚ˆã³å›ç­”ã«åŸºã¥ã„ã¦ã€é¸æŠè‚¢ã‚’çµã‚Šè¾¼ã¿ã€æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   - **agent_beta**: Î±ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæä¾›ã§ããªã„å ´åˆã®ä»£æ›¿ã®å¿œç­”ã‚’æä¾›ã—ã¾ã™ã€‚
   - **switchboard**: ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ï¼ˆè³ªå•ã€å›ç­”ã€æ¨æ¸¬ï¼‰ã«åŸºã¥ã„ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ãƒãƒ–æ©Ÿèƒ½ã€‚

4. **Kaggleç’°å¢ƒ**:
   - `kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ç’°å¢ƒã‚’ä½œæˆã€‚ãã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç›¸äº’ä½œç”¨ãŒå¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚

### ä¸»ãªå‡¦ç†ã®æµã‚Œ
- å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è³ªå•ã‚’æèµ·ã—ãŸã‚Šã€æ¨æ¸¬ã‚’è¡Œã£ãŸã‚Šã—ã¾ã™ã€‚
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ç¶­æŒã—ã€å‰ã®è³ªå•åŠã³ãã®å›ç­”ã«ã‚ˆã£ã¦ãã®ãƒªã‚¹ãƒˆã‚’çµã‚Šè¾¼ã‚€ã“ã¨ã«ã‚ˆã‚Šã€æ¬¡ã®è³ªå•ã‚’æ±ºå®šã—ã¾ã™ã€‚
- æœ€çµ‚çš„ã«ã€Kaggleã®ç’°å¢ƒå†…ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒå£«ã®å¯¾æˆ¦ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€ãã®çµæœã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¦ç´ æŠ€è¡“ã¨ã—ã¦è¨€èªãƒ¢ãƒ‡ãƒ«ã‚„ã‚²ãƒ¼ãƒ ç†è«–ã‚’ç”¨ã„ã€å”åŠ›çš„ãªã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã«å‘ã‘ã¦ã®æ„æ€æ±ºå®šã‚’åŠ¹ç‡åŒ–ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯ã€kaggle/pythonã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ä»¥ä¸‹ã¯èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã„ãã¤ã‹ã§ã™

import numpy as np # ç·šå½¢ä»£æ•°ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ›ï¼ˆä¾‹ï¼špd.read_csvï¼‰

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å­˜åœ¨ã—ã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼ˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹Shift+Enterã‚’æŠ¼ã™ã“ã¨ã§ï¼‰å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (/kaggle/working/) ã«ã¯æœ€å¤§20GBã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€
# "Save & Run All"ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ 
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ /kaggle/temp/ ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 2)---
```python
import random
import re

VERSION = 7
```

---The following area is a Code cell (cell numver is 3)---
```python
allwords = ['advertisement', 'agave', 'air compressor', 'air conditioner', 'air filter', 'air vent', 'alarm system',
            'analogy', 'anemone', 'anesthesia', 'apple pie', 'aprons', 'aquarium', 'atmosphere', 'auditorium',
            'backrest', 'bacteria', 'baguette', 'balcony', 'bank', 'barber chair', 'barcode', 'bat', 'bath mat',
            'battery bank', 'beanbag', 'bed frame', 'bike', 'bike path', 'binoculars', 'bird cage', 'bird seed',
            'bleachers', 'blinds', 'board games', 'bobby pins', 'bollards', 'bonding agent', 'bookcase', 'bookends',
            'bottled water', 'bread knife', 'bread pudding', 'break room', 'brewery merchandise', 'briefcase',
            'brochure', 'broken glass', 'brownies', 'bug spray', 'bulb', 'bumper sticker', 'bunsen burner', 'butterfly',
            'cabinet', 'calculator', 'cantaloupe', 'car seat', 'card', 'cardboard box', 'cash register', 'cat bed',
            'cat carrier', 'cauliflower', 'ceiling fan', 'cereal', 'latte', 'champagne flute', 'chandelier',
            'cheesecake', 'chessboard', 'chew toy', 'chocolate cake', 'cinnamon roll', 'rags', 'coat rack',
            'coffee beans', 'coffee grinder', 'coffee grounds', 'coffee makers', 'comic book', 'contact lenses',
            'conveyor belt', 'cooling tower', 'coral reefs', 'cream cheese', 'crochet hook', 'croissant', 'cup holder',
            'cupcake', 'curling iron', 'curtains', 'cutlery', 'cutting board', 'dandelion', 'deciduous tree',
            'dental chair', 'desk chairs', 'desk lamp', 'desktop computer', 'diaper', 'dijon mustard', 'dining table',
            'dish rack', 'dish soap', 'disinfectant', 'diving board', 'dog bed', 'dog crate', 'dog shampoo', 'donuts',
            'drain hose', 'drapes', 'duct tape', 'duffle bags', 'dumbbells', 'dump truck', 'duvet', 'dvd', 'dvd player',
            'dynamite', 'ear protection', 'earl grey tea', 'earplug', 'earth', 'edamame', 'edible flowers',
            'electric scooter', 'electric toothbrush', 'electrical outlet', 'electrical panel', 'electrical tape',
            'elevator', 'elliptical trainers', 'emergency exit sign', 'emergency lights', 'energy drink', 'engravings',
            'escalators', 'eucalyptus', 'excavator', 'exercise mat', 'exhaust fan', 'exit sign', 'extension cord',
            'eye mask', 'face mask', 'facial toner', 'fanny pack', 'fertilizer', 'filing cabinet', 'finger food',
            'fire alarm', 'fire escape ladder', 'fire extinguisher', 'fireplace', 'first aid kit', 'fish tank',
            'fishing pier', 'fitness tracker', 'flashlight', 'floor jacks', 'floor mats', 'foam roller', 'fog machine',
            'food bowl', 'food warmers', 'fortune cookie', 'frappuccino', 'free weights', 'french toast',
            'fridge magnet', 'fried rice', 'fungi', 'furniture', 'furniture polish', 'fuse', 'gadget', 'garage door',
            'garbage bag', 'garbage can', 'garbage disposal', 'garbage truck', 'gas mask', 'generator', 'glass table',
            'glove box', 'glove', 'golf cart', 'gps', 'grain bin', 'granola', 'grape vine', 'grapefruit',
            'graphic novel', 'graphing calculator', 'gravity', 'green beans', 'greeting card', 'guard tower',
            'guitar string', 'gym mats', 'habanero pepper', 'hair clip', 'hair dryer', 'hair gel', 'hairbrush',
            'hairspray', 'hamster wheel', 'hamstring curl machine', 'hand dryer', 'hand sanitizer', 'handbag',
            'handrail', 'hard hat', 'hash browns', 'hay bale', 'hazelnut', 'hdmi cable', 'headlamp', 'headphones',
            'hearing aid', 'heart rate monitors', 'heating element', 'hibiscus', 'high chair', 'highlighter',
            'hiking boots', 'holly', 'honeybee', 'hot dog', 'hot water bottle', 'ice cream maker', 'ice cube tray',
            'ice water', 'iced coffee', 'icicle', 'incense', 'incubator', 'index card', 'inhaler', 'ink cartridge',
            'insulation', 'router', 'interstate', 'iris', 'iron', 'ironing board', 'iron bar', 'irrigation system',
            'iv', 'jewelry box', 'journal', 'joystick', 'jumper cables', 'kale smoothie', 'karaoke machine',
            'key chain', 'khaki pants', 'kiosk', 'kitchen cabinet', 'garbage disposal', 'kitchen table',
            'komodo dragon', 'lab coat', 'lanyard', 'laptop', 'laser beam', 'lathe', 'laundry basket', 'lawnmower',
            'lego', 'library card', 'light switch', 'lightbulb', 'lint roller', 'lint trap', 'litter scooper',
            'lottery ticket', 'luggage', 'magazine rack', 'mailbox', 'marshmallow', 'masks', 'matches', 'measuring cup',
            'measuring tape', 'medical records', 'medication dispenser', 'medication', 'medicine cabinet', 'menorah',
            'metal detector', 'mouse', 'microphone stand', 'microscope', 'microwave', 'milling machine', 'mini fridge',
            'mixing bowl', 'mobile phone', 'modem', 'motorcycle helmet', 'movie poster', 'muffin tin', 'muffin',
            'muffler', 'mural', 'mushroom', 'nachos', 'nail clipper', 'nail polish', 'nail polish remover', 'name tag',
            'nap mat', 'necklace', 'nightstand', 'notebook', 'nozzle', 'oak table', 'ocarina', 'oil filter', 'ointment',
            'olive oil', 'onyx', 'orange peel', 'orange tree', 'orange zest', 'outdoor furniture', 'oven door',
            'oven rack', 'owl', 'oxygen tank', 'pacifier', 'packing peanuts', 'pad', 'pajamas', 'pallet jack',
            'pamphlet', 'pants', 'paper towels', 'paperweights', 'paperwork', 'parachute', 'parallel bars', 'pea soup',
            'pencil sharpener', 'perfume', 'personal protective equipment', 'pesticide', 'phone charger', 'photo album',
            'piano', 'pickaxe', 'piping tips', 'placemat', 'planter box', 'plaque', 'plastic gloves', 'plastic wrap',
            'plate', 'play mat', 'playing cards', 'pliers', 'polyester', 'pool cleaner', 'popcorn', 'popcorn machine',
            'portable speaker', 'pot holder', 'potato', 'power drill', 'power lines', 'power strip', 'press box',
            'pressure gauge', 'projector', 'protein bar', 'protein shakes', 'pry bar', 'public address system',
            'pumpkin pie', 'punching bag', 'push pin', 'puzzle', 'pyramid', 'quesadilla', 'rabbit', 'raccoon',
            'radio scanner', 'radish', 'railroad tracks', 'raindrops', 'rat', 'red velvet cake', 'red wine',
            'refrigerator', 'rehearsal room', 'reindeer', 'relish', 'reptile', 'resin', 'respirator', 'restaurants',
            'rice pudding', 'rivet', 'robot arm', 'rolling pin', 'roots', 'rowing machines', 'rug', 'rv',
            'safety harness', 'salad dressing', 'satellite', 'sauna', 'scones', 'scoreboard', 'scrap metal',
            'scratching posts', 'screwdriver', 'security systems', 'seed packet', 'server rack', 'sewing kit',
            'shin guards', 'shipping label', 'shoe rack', 'shower caddy', 'shower mat', 'sieve', 'silicone',
            'silicone mat', 'silver ore', 'sippy cup', 'sketchbook', 'sleeping bag', 'smartphone', 'smartwatch',
            'smoke detector', 'snacks', 'soap dish', 'soap dispenser', 'soap suds', 'soda', 'sofa', 'solar panel',
            'soldering iron', 'sound system', 'soybeans', 'space probe', 'spatula', 'spice rack', 'spider web',
            'sportswear', 'spotlight', 'sprinkler', 'sprinkler system', 'squirrel', 'stadium', 'stage lights',
            'stain remover', 'stained glass window', 'stair stepper', 'staircase', 'stationary bike', 'steam room',
            'sticker', 'sticky notes', 'storage bin', 'stove', 'street sign', 'sugar packet', 'suitcase', 'sunglasses',
            'sunscreen', 'swimsuit', 'swing set', 'tablet', 'tank', 'tape dispenser', 'taser', 'tea leaf', 'telescope',
            'television', 'tennis ball', 'tennis court', 'throw blanket', 'ticket machine', 'ticket stub', 'tire iron',
            'tissue box', 'toaster oven', 'tofu', 'toilet', 'toiletries bag', 'tomato', 'tongue depressor', 'tool belt',
            'tool box', 'toothbrush', 'toothbrush holder', 'toothpaste', 'touchscreen', 'tow truck', 'towel',
            'tracksuit', 'tractor shed', 'tractor', 'train brake', 'train door', 'trash bag', 'trash can', 'tricycle',
            'truck', 'tulip', 'turkey', 'turn signal', 'turnstiles', 'tweezers', 'udon noodles', 'ultraviolet lamp',
            'umbrella stand', 'underground river', 'unleavened bread', 'urinal', 'usb drives', 'utility box',
            'utility cart', 'vacuum cleaner', 'vanilla extract', 'vanity mirror', 'vans', 'vase', 'vegetable',
            'vegetation', 'veggie burger', 'velvet rope', 'vending machine', 'ventilation system', 'video camera',
            'violin bow', 'violin strings', 'virus', 'volcano', 'voucher', 'vr headset', 'walking stick', 'wall art',
            'wall decorations', 'wall street', 'wardrobe', 'washing machine', 'water', 'water bottle', 'water buffalo',
            'water fountain', 'water heater', 'water tank', 'watering can', 'webcam', 'wheelchair ramp', 'whistle',
            'willow tree', 'windbreak', 'wine aerator', 'wine decanter', 'wine opener', 'wine rack', 'wine tasting kit',
            'wire rack', 'wireless speaker', 'wrench', 'wrist weights', 'wristband', 'yoga block', 'yoga mat', 'yogurt',
            'zinc', 'afghanistan', 'albania', 'algeria', 'andorra', 'angola', 'antigua and barbuda', 'argentina',
            'armenia', 'australia', 'austria', 'azerbaijan', 'bahrain', 'bangladesh', 'barbados', 'belarus', 'belgium',
            'belize', 'benin', 'bhutan', 'bolivia', 'bosnia and herzegovina', 'botswana', 'brazil', 'brunei',
            'bulgaria', 'burkina faso', 'burundi', 'cambodia', 'cameroon', 'canada', 'cape verde',
            'central african republic', 'chad', 'chile', 'china', 'colombia', 'comoros', 'congo', 'costa rica',
            'croatia', 'cuba', 'cyprus', 'czech republic', 'democratic republic of the congo', 'denmark', 'djibouti',
            'dominica', 'dominican republic', 'ecuador', 'egypt', 'el salvador', 'england', 'equatorial guinea',
            'eritrea', 'estonia', 'ethiopia', 'federated states of micronesia', 'finland', 'france', 'gabon', 'gambia',
            'georgia', 'germany', 'ghana', 'greece', 'grenada', 'guatemala', 'guinea', 'guinea bissau', 'guyana',
            'haiti', 'honduras', 'hungary', 'iceland', 'india', 'indonesia', 'iran', 'iraq', 'ireland', 'israel',
            'italy', 'jamaica', 'japan', 'jordan', 'kazakhstan', 'kenya', 'kiribati', 'kosovo', 'kuwait', 'kyrgyzstan',
            'laos', 'latvia', 'lebanon', 'lesotho', 'liberia', 'libya', 'liechtenstein', 'lithuania', 'luxembourg',
            'madagascar', 'malawi', 'malaysia', 'maldives', 'mali', 'malta', 'marshall islands', 'mauritania', 'mauritius', 'mexico', 'moldova', 'monaco', 'mongolia', 'montenegro', 'morocco', 'mozambique', 'myanmar',
            'namibia', 'nauru', 'nepal', 'netherlands', 'new zealand', 'nicaragua', 'niger', 'nigeria', 'north korea',
            'norway', 'oman', 'pakistan', 'palau', 'palestine', 'panama', 'papua new guinea', 'paraguay', 'peru',
            'philippines', 'poland', 'portugal', 'qatar', 'romania', 'russia', 'rwanda', 'saint kitts and nevis',
            'saint lucia', 'saint vincent and the grenadines', 'samoa', 'san marino', 'sao tome and principe',
            'saudi arabia', 'senegal', 'serbia', 'seychelles', 'sierra leone', 'singapore', 'slovakia', 'slovenia',
            'solomon islands', 'somalia', 'south africa', 'south korea', 'spain', 'sudan', 'suriname', 'swaziland',
            'sweden', 'switzerland', 'syria', 'taiwan', 'tajikistan', 'tanzania', 'thailand', 'togo', 'tonga',
            'trinidad and tobago', 'tunisia', 'turkey', 'turkmenistan', 'tuvalu', 'uganda', 'ukraine',
            'united arab emirates', 'united kingdom', 'united states of america', 'uruguay', 'uzbekistan', 'vanuatu',
            'venezuela', 'vietnam', 'yemen', 'zambia', 'zimbabwe', 'amsterdam netherlands', 'anaheim california',
            'austin texas', 'auckland new zealand', 'asheville north carolina', 'ashgabat turkmenistan',
            'athens greece', 'athens georgia', 'atlanta georgia', 'antwerp belgium', 'adelaide australia',
            'astana kazakhstan', 'asuncion paraguay', 'algiers algeria', 'acapulco mexico', 'ankara turkey',
            'baghdad iraq', 'bangkok thailand', 'beijing china', 'berlin germany', 'boston massachusetts',
            'buenos aires argentina', 'bursa turkey', 'bucharest romania', 'baltimore maryland', 'beirut lebanon',
            'belfast northern ireland', 'bratislava slovakia', 'belgrade serbia', 'budapest hungary', 'baku azerbaijan',
            'bordeaux france', 'busan south korea', 'brussels belgium', 'bangalore india', 'calgary canada',
            'chicago illinois', 'copenhagen denmark', 'columbus ohio', 'cologne germany', 'cairo egypt',
            'cape town south africa', 'caracas venezuela', 'cleveland ohio', 'cork ireland', 'christchurch new zealand',
            'casablanca morocco', 'chengdu china', 'cannes france', 'canberra australia', 'dallas texas',
            'dubai united arab emirates', 'dhaka bangladesh', 'dakar senegal', 'delhi india', 'durban south africa',
            'dublin ireland', 'dalian china', 'doha qatar', 'denver colorado', 'dusseldorf germany',
            'davao city philippines', 'darwin australia', 'dunfermline scotland', 'daegu south korea', 'damascus syria',
            'dar es salaam tanzania', 'edinburgh scotland', 'edmonton canada', 'essen germany', 'evora portugal',
            'ensenada mexico', 'el paso texas', 'enugu nigeria', 'enschede netherlands', 'eureka california',
            'erie pennsylvania', 'eilat israel', 'essentuki russia', 'esbjerg denmark', 'fez morocco', 'florence italy',
            'frankfurt germany', 'fort worth texas', 'fukuoka japan', 'faisalabad pakistan',
            'fujairah united arab emirates', 'funafuti tuvalu', 'florianopolis brazil', 'flinders australia',
            'faro portugal', 'fujairah united arab emirates', 'fort mcmurray canada', 'fortaleza brazil',
            'friesland netherlands', 'funchal portugal', 'fuzhou china', 'fresno california', 'fermoy ireland',
            'fukushima japan', 'glasgow scotland', 'guangzhou china', 'gdansk poland', 'guatemala city guatemala',
            'guwahati india', 'gyeongju south korea', 'genoa italy', 'grahamstown south africa', 'guadalajara mexico',
            'geneva switzerland', 'graz austria', 'gwangju south korea', 'houston texas', 'hamburg germany',
            'hanoi vietnam', 'helsinki finland', 'ho chi minh city vietnam', 'haifa israel', 'havana cuba',
            'hong kong china', 'hobart australia', 'hangzhou china', 'hilo hawaii', 'hermosillo mexico',
            'honolulu hawaii', 'helsingborg sweden', 'hiroshima japan', 'harare zimbabwe', 'istanbul turkey',
            'indianapolis indiana', 'ibadan nigeria', 'istanbul turkey', 'indore india', 'izmir turkey',
            'isafahan iran', 'incheon south korea', 'innsbruck austria', 'islamabad pakistan', 'ingolstadt germany',
            'irvine california', 'irkutsk russia', 'jakarta indonesia', 'jerusalem israel', 'jacksonville florida',
            'johannesburg south africa', 'jabalpur india', 'jinan china', 'jeddah saudi arabia', 'jalapa guatemala',
            'jackson mississippi', 'juarez mexico', 'jabalpur india', 'jining china', 'kampala uganda',
            'kathmandu nepal', 'kaunas lithuania', 'kuala lumpur malaysia', 'kyoto japan', 'kagoshima japan',
            'karachi pakistan', 'kiev ukraine', 'kingston jamaica', 'kolkata india', 'kunming china',
            'kabul afghanistan', 'kyiv ukraine', 'kawasaki japan', 'london england', 'la paz bolivia',
            'los angeles california', 'lima peru', 'lyon france', 'lisbon portugal', 'luanda angola',
            'liverpool england', 'lagos nigeria', 'leeds england', 'ljubljana slovenia', 'lyon france', 'lima peru',
            'lviv ukraine', 'leipzig germany', 'lusaka zambia', 'lausanne switzerland', 'madrid spain',
            'manchester england', 'mexico city mexico', 'manila philippines', 'montreal canada', 'milan italy',
            'moscow russia', 'madrid spain', 'mumbai india', 'managua nicaragua', 'melbourne australia',
            'marrakech morocco', 'miami florida', 'minneapolis minnesota', 'mecca saudi arabia', 'melbourne australia',
            'makati philippines', 'monterrey mexico', 'nagoya japan', 'new york city', 'nanjing china',
            'new delhi india', 'nantes france', 'noida india', 'newcastle upon tyne england', 'nice france',
            'nurumberg germany', 'new orleans louisiana', 'nairobi kenya', 'naples italy', 'noosa australia',
            'osaka japan', 'oklahoma city oklahoma', 'oslo norway', 'oxford england', 'ottawa canada', 'orsay france',
            'odessa ukraine', 'oranjestad aruba', 'orlando florida', 'ostrava czech republic', 'oaxaca mexico',
            'otago new zealand', 'ouagadougou burkina faso', 'odense denmark', 'oulu finland', 'paris france',
            'prague czech republic', 'porto portugal', 'philadelphia pennsylvania', 'pyeongyang north korea',
            'perth australia', 'plovdiv bulgaria', 'pattaya thailand', 'portland oregon', 'phoenix arizona',
            'porto alegre brazil', 'peshawar pakistan', 'panama city panama', 'rome italy', 'rio de janeiro brazil',
            'riyadh saudi arabia', 'reykjavik iceland', 'rotterdam netherlands', 'ras al khaimah united arab emirates',
            'raleigh north carolina', 'riga latvia', 'rochester new york', 'recife brazil', 'san francisco california',
            'sydney australia', 'singapore', 'seoul south korea', 'stockholm sweden', 'santiago chile',
            'san diego california', 'shanghai china', 'sao paulo brazil', 'stuttgart germany', 'sevilla spain',
            'saskatoon canada', 'san salvador el salvador', 'sofia bulgaria', 'seattle washington', 'tokyo japan',
            'torino italy', 'tunis tunisia', 'tashkent uzbekistan', 'toronto canada', 'tirana albania',
            'tijuana mexico', 'turin italy', 'tokyo japan', 'thessaloniki greece', 'taegu south korea', 'taksim turkey',
            'taipei taiwan', 'tripoli libya', 'tokyo japan', 'ulaanbaatar mongolia', 'ubud indonesia', 'uppsala sweden',
            'urumqi china', 'vaduz liechtenstein', 'vancouver canada', 'valencia spain', 'vigo spain','valparaiso chile', 
            'vladivostok russia', 'vienna austria', 'vilnius lithuania', 'villarreal spain',
            'washington dc', 'westminster england', 'wilmington delaware', 'wroclaw poland', 'warsaw poland',
            'wellington new zealand', 'winnipeg manitoba', 'warsaw poland', 'wuhan china', 'yokohama japan',
            'york england', 'yaounde cameroon', 'yuma arizona', 'ypres belgium', 'yakutsk russia', 'yerevan armenia',
            'yanbu saudi arabia', 'yogyakarta indonesia', 'yekaterinburg russia', 'zacatecas mexico', 'zunyi china',
            'zincantan mexico', 'zagreb croatia', 'zeeland netherlands', 'zhongshan china', 'zanzibar tanzania',
            'zurich switzerland', 'zaragoza spain', 'denali', 'mount saint lias', 'mount whitney', 'mount rainier',
            'iztaccihuatl', 'grand teton', 'gannett peak', 'mount adams', 'mount saint helens', 'mount shasta',
            'mount saint helens', 'pikes peak', 'aconcagua', 'fitz roy', 'cotopaxi', 'chimborazo', 'mont blanc',
            'zugspitze', 'mount elbrus', 'mount etna', 'everest', 'k2', 'lhotse', 'makalu', 'cho oyu', 'manaslu',
            'annapurna', 'dhaulagiri', 'nanga parbat', 'kangchenjunga', 'mount fuji', 'kilimanjaro', 'meru', 'aoraki',
            'haleakala', 'puncak jaya', 'amazon', 'colorado river', 'dnieper', 'ganges', 'illinois river',
            'mississippi river', 'nile', 'rhine', 'yangtze river', 'yellow river', 'zambezi river', 'yenisei river']
```

---The following area is a Code cell (cell numver is 4)---
```python
keywords = sorted(allwords)
```

---The following area is a Code cell (cell numver is 5)---
```python
def extract_testword(question):
    # ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ã¯ã€äºŒé‡å¼•ç”¨ç¬¦å†…ã®æ–‡å­—åˆ—ã¨ã—ã¦å˜ç´”ã«ç‰¹å®šã—ã¾ã™
    match = re.search(r'"(.+)"', question)
    if match:
        testword = match.group(1)
        # print(f'ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ã¯: {testword}ã§ã™')
    else:
        print(f'è³ªå•ã®ä¸­ã«ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {question}')
        testword = ''

    return testword


def agent_beta(obs, cfg):
   
    if obs.turnType == 'ask':
        response = agent_alpha(obs, cfg)

    elif obs.turnType == 'guess':
        if random.random() < 0.5:
            # ã‚‚ã—ã‹ã—ãŸã‚‰.. æ„›ã‚‰ã—ã„ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã§å¿œç­”ã™ã‚‹ï¼Ÿ
            responses = ['ãƒãƒ¼Î±ã€ãƒãƒ¼ãƒ•ã‚¡ãƒ³', 'ã‚ãªãŸã¯ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã¹ãã§ã™ã€ãƒŸã‚¹ã‚¿ãƒ¼', 'ã‚¢ãƒ«ãƒ•ã‚¡ãŒç”Ÿãã‚‹',
                         'ã‚¢ãƒ«ãƒ•ã‚¡ãƒã‚¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ãªãŸã‚’åŠ©ã‘ã‚‹ã‹ã‚‚', f'ã‚¯ãƒªãƒ¼ãƒŸãƒ¼ï¼†ãƒŸãƒ«ã‚­ãƒ¼ã€ã‚¢ãƒ«ãƒ•ã‚¡ {VERSION}',
                         'ã‚«ã‚°ãƒ«ã‚’ç´ æ™´ã‚‰ã—ãã™ã‚‹']

            response = random.choice(responses)
        else:
            # ãã‚Œã§ã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹
            response = agent_alpha(obs, cfg)

    else:
        assert obs.turnType == 'answer'
        response = 'ã„ã„ãˆ'

    return response


def agent_alpha(obs, cfg):
    global keywords

    if obs.turnType == 'ask':

        if keywords:
            # è³ªå•ã®å¤šæ§˜ä½“ã‚’äº¤äº’ã«ä½¿ç”¨ã—ã¾ã™ã€‚æ§‹æ–‡ã¯ã‚¢ãƒ«ãƒ•ã‚¡å›ç­”è€…ã«ã¯ã‚ã¾ã‚Šé–¢ä¿‚ã—ãªã„ã§ã—ã‚‡ã†ãŒã€
            # è³¢ã„LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã¯æ­£ã—ãå›ç­”ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
            testword = keywords[len(keywords) // 2]
            responses = [
                f'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ï¼‰ã¯ã€Œ{testword}ã€ã‚ˆã‚Šã‚‚å…ˆã«ä¸¦ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ',
                f'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ï¼‰ã¯ã€Œ{testword}ã€ã‚ˆã‚Šã‚‚å‰ã«æ¥ã¾ã™ã‹ï¼Ÿ',
                f'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ï¼‰ã¯ã€Œ{testword}ã€ã®ã‚½ãƒ¼ãƒˆé †ã§å‰ã«æ¥ã¾ã™ã‹ï¼Ÿ',
                f'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ï¼‰ã¯ã€Œ{testword}ã€ã®ä¸¦ã¹æ›¿ãˆé †ã§å…ˆã«æ¥ã¾ã™ã‹ï¼Ÿ',
            ]
            response = responses[len(obs.questions) % len(responses)]
        else:
            response = f'ã‚¹ãƒšãƒ¼ã‚¹ãŒ exhausted.. å†èµ·å‹•ä¸­ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {VERSION}'
            # å†èµ·å‹•
            keywords = sorted(allwords)

    elif obs.turnType == 'guess':

        assert len(obs.answers) > 1

        # æœ€å¾Œã®è³ªå•ã¨å›ç­”ã«åŸºã¥ã„ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’äºŒåˆ†ã—ã¾ã™
        testword = extract_testword(obs.questions[-1])
        if testword:
            if obs.answers[-1] == 'yes':
                keywords = [k for k in keywords if k < testword]
            else:
                keywords = [k for k in keywords if not k < testword]

        if keywords:
            guess = keywords[0]
            keywords = keywords[1:]
            response = guess

        else:
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ exhaustedã€ã‚‚ã—ã‹ã—ãŸã‚‰ç§ãŸã¡ã¯ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ãªã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
            response = 'å€™è£œãŒæ®‹ã£ã¦ã„ã¾ã›ã‚“'

    else:
        assert obs.turnType == 'answer'

        # æœ€åˆã®è³ªå•ã«ã¯ã€Œã¯ã„ã€ã¨ç­”ãˆã‚‹ã®ã§ã€ã‚¢ãƒ«ãƒ•ã‚¡è³ªå•è€…ã¯å…ˆã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
        # ã•ã‚‚ãªã‘ã‚Œã°LLMã«ç§»è¡Œã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
        if len(obs.questions) == 1:
            response = 'ã¯ã„'

        else:
            # æˆ‘ã€…ã¯ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã«ãªã£ã¦ã„ã¾ã™ãŒã€è³ªå•ã®ä¸­ã«ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã‹ï¼Ÿ
            testword = extract_testword(obs.questions[-1])
            if testword:
                # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨æ¯”è¼ƒã™ã‚‹ãŸã‚ã«å°æ–‡å­—ã«æ­£è¦åŒ–ã—ã¾ã™ï¼
                response = 'ã¯ã„' if obs.keyword.lower() < testword else 'ã„ã„ãˆ'
            else:
                # ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§ã€ãŠãã‚‰ãç§ãŸã¡ã¯ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ãªã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
                response = 'ã„ã„ãˆ'

    return response
```

---The following area is a Code cell (cell numver is 6)---
```python
def switchboard(obs, cfg):
   
    if obs.turnType == 'ask':

        if len(obs.questions) == 0:
            # æœ€åˆã®è³ªå•ã§ã™ã€‚LLMãŒã€Œã„ã„ãˆã€ã¨ç­”ãˆã‚‹ãŒã€
            # ã‚¢ãƒ«ãƒ•ã‚¡ã®å›ç­”è€…ã¯èªè­˜ã§ãã‚‹ã‚ˆã†ãªè³ªå•ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
            response = 'ãã‚Œã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡ã§ã™ã‹ï¼Ÿ'

        else:
            if obs.answers[0] == 'yes':
                response = agent_alpha(obs, cfg)
            else:
                response = agent_beta(obs, cfg)

    elif obs.turnType == 'guess':

        assert len(obs.questions) > 0 and len(obs.answers) > 0

        if len(obs.answers) == 1:
            if obs.answers[-1] == 'yes':
                response = f'ãƒ“ãƒ³ã‚´ï¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {VERSION}'
            else:
                response = f'æ®‹å¿µ..'
                # ã‚‚ã—ãã¯ã™ãã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã™ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“

        else:
            # æœ€åˆã®è³ªå•ã§ã€Œã¯ã„ã€ã¨ç­”ãˆã‚Œã°ã‚¢ãƒ«ãƒ•ã‚¡ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã€‚
            play_alpha = obs.answers[0] == 'yes'

            if play_alpha:
                response = agent_alpha(obs, cfg)
            else:
                response = agent_beta(obs, cfg)

    elif obs.turnType == 'answer':

        assert len(obs.questions) > 0
        questioner_is_alpha = 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ«ãƒ•ã‚¡' in obs.questions[0].lower()

        if questioner_is_alpha:
            response = agent_alpha(obs, cfg)

        else:
            # ã¾ã‚ã€è³ªå•è€…ã¯ã‚¢ãƒ«ãƒ•ã‚¡ã§ã¯ãªã„ã®ã§.. LLMã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ
            response = agent_beta(obs, cfg)

        assert response in ['ã¯ã„', 'ã„ã„ãˆ']

    else:
        # ã“ã“ã«æ¥ã‚‹ã“ã¨ã¯æƒ³å®šã—ã¦ã„ã¾ã›ã‚“
        assert False, f'äºˆæœŸã—ãªã„turnType: {obs.turnType}'

    return response


def agent_fn(obs, cfg):
    """ ãƒ¡ã‚¤ãƒ³ã®ãƒ•ãƒƒã‚¯ã§ã™ã€‚ã€Œagent_fnã€ã¨åä»˜ã‘ã¦ãã ã•ã„ã€‚ """

    try:
        response = switchboard(obs, cfg)
    except AssertionError:
        import traceback
        traceback.print_exc()
        response = 'ã„ã„ãˆ'

    return response
```

---The following area is a Code cell (cell numver is 7)---
```python
from kaggle_environments import make

def agent_dummy(obs, cfg):
    if obs.turnType == "ask":
        response = "ãã‚Œã¯ã‚¢ãƒ’ãƒ«ã§ã™ã‹ï¼Ÿ"
    elif obs.turnType == "guess":
        response = "ã‚¢ãƒ’ãƒ«"
    elif obs.turnType == "answer":
        response = "ã„ã„ãˆ"
    return response


debug_config = {'episodeSteps': 61,     # åˆæœŸã‚¹ãƒ†ãƒƒãƒ—ã«åŠ ãˆã¦ã€å„ãƒ©ã‚¦ãƒ³ãƒ‰ã«3ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè³ªå•/å›ç­”/æ¨æ¸¬ï¼‰
                'actTimeout': 60,      # ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ™‚é–“ï¼ˆç§’å˜ä½ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯60
                'runTimeout': 1200,      # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§æ™‚é–“ï¼ˆç§’å˜ä½ï¼‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1200
                'agentTimeout': 3600}  # å»ƒæ­¢ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3600

env = make(environment="llm_20_questions", configuration=debug_config, debug=True)


game_output = env.run(agents=[agent_fn, agent_fn, agent_dummy, agent_dummy])

env.render(mode="ipython", width=1080, height=700)
```

** @@@ Jupyter Notebook numver 59, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€æœ€çµ‚çš„ã« `submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å•é¡Œã¨ç›®çš„
ã€ŒLLM 20 Questionsã€ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³ªå•ã‚’é€šã˜ã¦ç‰¹å®šã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã€åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ä¾å­˜é–¢ä¿‚**: 
  - `immutabledict` ã‚„ `sentencepiece` ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¾ã™ã€‚

- **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã¨åˆæœŸåŒ–**: 
  - ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«ã¯Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€ç‰¹ã«`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯7BãŠã‚ˆã³2Bã®ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æŒ‡å®šã—ãŸãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«é¸æŠã—ã¦ã„ã¾ã™ã€‚

- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: 
  - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹**: 
  - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’ãã‚Œãã‚Œæ‹…å½“ã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯å†…éƒ¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦æ­£ã—ã„è³ªå•ã‚„ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### å‡ºåŠ›
æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚ã“ã®æˆæœç‰©ã«ã¯ã€ã™ã¹ã¦ã®å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒå”èª¿ãƒ—ãƒ¬ã‚¤ã«åŸºã¥ã„ãŸæ¨ç†ã‚’è¡Œã†ãŸã‚ã®å‡ºç™ºç‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚å‚åŠ è€…ã¯ã“ã®åŸºç›¤ã‚’å…ƒã«ã€è‡ªã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚„æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã•ã‚‰ã«æ”¹å–„ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions** ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã® **Submit to competition** è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ *Output* ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz` ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹ **Submit Agent** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/  # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # KAGGLE_AGENT_PATHã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # æŒ‡å®šã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆ¥ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b  # gemmaãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
from gemma.model import GemmaForCausalLM  # gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")  # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"  # ä»–ã®ãƒ‘ã‚¹ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

class GemmaFormatter:
    _start_token = '<start_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        self._few_shot_examples = few_shot_examples  # Few-shotä¾‹ã®ä¿å­˜
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self.reset()  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¿½åŠ 
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotä¾‹ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œé †åºã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †åºã‚’å¾ªç’°ã•ã›ã‚‹
        for fmt, turn in zip(formatters, turns):  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã¨ã‚¿ãƒ¼ãƒ³ã‚’çµåˆ
            fmt(turn)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å¤‰æ›´
    yield
    torch.set_default_dtype(torch.float)  # å…ƒã®dtypeã«æˆ»ã™

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
        self._device = torch.device(device)  # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant  # é‡å­åŒ–è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')  # é‡ã¿ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å¿œç­”ã‚’å¾—ã‚‹
        response = self._parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
        print(f"{response=}")  # å¿œç­”ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                'top_p': 0.1,  # ãƒˆãƒƒãƒ—ç¢ºç‡
                'top_k': 1,  # ãƒˆãƒƒãƒ—Kã®è¨­å®š
        }
        response = self.model.generate(  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            prompt,
            device=self._device,
            output_len=max_new_tokens,  # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,  # ãã®ä»–ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        else:
            keyword = match.group().lower()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–


def interleave_unequal(x, y):
    return [  # ä¸å‡ä¸€ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")  # è³ªå•ã™ã‚‹ã‚ˆã†æŒ‡ç¤º
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰äºˆæƒ³ã®æŒ‡ç¤º
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "Is it a person?"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•
            else:
                question = match.group()  # æŠ½å‡ºã—ãŸè³ªå•
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®äºˆæƒ³ã‚’è§£æ
            return guess
        else:
            raise ValueError("Unknown turn type:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='user')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")  # å›ç­”æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # å›ç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no'  # "yes"ã§ã‚ã‚Œã°yesã€ãã®ä»–ã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "You are an AI assistant designed to play the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š

few_shot_examples = [  # Few-shotä¾‹ã®è¨­å®š
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆOut of Memoryï¼‰ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "Agent not initialized."  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    return agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™

def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    if response is None or len(response) <= 1:  # å¿œç­”ãŒç©ºã‹é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆ
        return "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response  # é€šå¸¸ã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2  # submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Samar Elhissi
> 
> ä¾‹ã‚’ã‚ã‚ŠãŒã¨ã†ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„â€¦ã“ã®LLMã¯å¤šãã®è¨ˆç®—ã‚’å¿…è¦ã¨ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯å¼·åŠ›ãªGPUãŒå¿…è¦ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã€ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚
> > 
> > 

---

> ## Michael Kamal 92
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€few_shot_examplesã«ã¤ã„ã¦è³ªå•ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> > ä¾‹ãˆã°ã€( 'is it place?', 'yes-or-no' )ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€ãã‚Œã¨ã‚‚( 'is it place?', 'yes', ) ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'Now guess the keyword' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'no', 'Now guess the keyword', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿã©ã‚ŒãŒæ­£ã—ã„è³ªå•ã€å›ç­”ã€äºˆæ¸¬ã®ä½œã‚Šæ–¹ã§ã™ã‹ï¼Ÿ
> 
> ã‚‚ã†ä¸€ã¤ã®è³ªå•ã§ã™ãŒã€Gemmaã¯few_shot_examplesã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ

---

> ## Yukky_2801
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«å¤±æ•—ã—ãŸã¨çµ‚äº†ã—ã¾ã™ã€‚
> 
> submission.tar.gzã‚’ã‚¨ãƒ©ãƒ¼ã¨å…±ã«æå‡ºã§ãã¾ã›ã‚“ã€‚ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è§£æ±ºç­–ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

> ## Andres H. Zapke
> > ã‚‚ã¡ã‚ã‚“ã€Œgemma/pytorch/7b-it-quant/2ã€ã“ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å³å´ã‚’è¦‹ã¦ã€gemmaãƒ¢ãƒ‡ãƒ«ãŒãã“ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
>   
> > ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add Inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)
> > 
> > 
> > > ## Talal Mufti
> > > > ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸå¾Œã€ä¾ç„¶ã¨ã—ã¦å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€bashã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã€ã“ã‚ŒãŒç§ã«ã¨ã£ã¦ã†ã¾ãã„ãã¾ã—ãŸï¼š
> > > > !tar --use-compress-program='pigz --fast --recursive | pv' -f submission.tar.gz -c /kaggle/working/submission . -c /kaggle/input/gemma/pytorch/7b-it-quant/2

---

> ## Muhammad Hadi13
> 
> ãªãœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã«ã€å¸¸ã«1.35MBä»¥ä¸Šã®å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãšã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¤±æ•—ã™ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Ryanã®å‡ºåŠ›ã¯ç´„7GBã§ã—ãŸã€‚ã“ã®ä»¶ã«ã¤ã„ã¦åŠ©ã‘ãŒå¿…è¦ã§ã™ï¼ï¼
> 
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> > tar: gemma/pytorch: Cannot stat: No such file or directory
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸã€‚

> ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’äº‹å‰ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > > 
> > > ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)

---

> ## Ship of Theseus
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community
> 
> 

---

> ## shiv_314
> 
> çš†ã•ã‚“ï¼ä¸€ã¤åŠ©ã‘ãŒå¿…è¦ã§ã™ã€‚gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
> 
> Pythonã®ãŸã‚ã«ã™ã§ã«æ­£ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼

---

> ## dedq
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community

---

> ## Code Hacker
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«tar.gzã‚’æå‡ºã—ã‚ˆã†ã¨ã—ãŸãŒã€å¤±æ•—ã—ã¾ã—ãŸâ€¦

> ## Code Hacker
> > > ã“ã®ãƒ¢ãƒ‡ãƒ«ã«åŒæ„ã—ãªã‹ã£ãŸã€‚ä¸‹ã®èµ¤ã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯â€¦

---

> ## JAPerez
> 
> Great work Ryan!

---

> ## philipha2
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã“ã®ã‚³ãƒ³ãƒšã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚
> æå‡ºç‰©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹submission.tar.gzã‚’ã©ã“ã«ç½®ã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ 
> Submit agentsãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æå‡ºã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ 
> æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
> åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kanchan Maurya
> > > Submit agentsã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã€åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---

> ## vj4science
> 
> Thanks Ryan - this is a good head start to the competition! much appreciated!

---

> ## gb_kwon
> 
> Thank you so much for your COOL guidelines!

---

> ## Andres H. Zapke
> 
> main.pyã§ã€gemma_pytorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼šfrom gemma.configã€‚
> 
> ã“ã‚Œã¯ç§ã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ãŒã€gemmaã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ã€‚
> 
> è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®gemmaãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã®ã¨ã€Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã‚’è©¦ã¿ã¾ã—ãŸãŒã€‚ä½•ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

> ## Duy Thai
> 
> ã“ã‚“ã«ã¡ã¯[@ryanholbrook](https://www.kaggle.com/ryanholbrook)ã€ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è©¦ã—ãŸã¨ã“ã‚ã€ã€Œæ·»ä»˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è¿½åŠ ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ã¯Modelãƒ‘ãƒãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã«ã¤ã„ã¦ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸã¨ãã€ç§ã¯ã“ã‚Œã ã‘ã‚’è¦‹ã¦ã„ã¾ã™ï¼š

> ## Andres H. Zapke
> > > "Models"ã¸è¡Œãã€Gemmaã‚’æ¤œç´¢ã—ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

> ## Duy Thai
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---

> ## Kai_Huang
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã® !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2 ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã¨ãã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸ
> 
> ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kai_Huang
> > > ã‚ã‚ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å…¥åŠ›ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã™ã­ğŸ˜±

> ## D Prince Armand KOUMI
> > > ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆã¯ã€è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

> ## Qusay AL-Btoush
> 
> ã¨ã¦ã‚‚è‰¯ã„ã€Ryan 

---
```

** @@@ Jupyter Notebook numver 60, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã§ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«æŒ‘ã‚€ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ãŸè³ªå•è€…ï¼ˆQuestionerï¼‰ã¨å›ç­”è€…ï¼ˆAnswererï¼‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•ã§æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®èª¬æ˜
ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã¯ã€è³ªå•è€…ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã«ã¯ã„/ã„ã„ãˆã®è³ªå•ã‚’è¡Œã†ã¨ã„ã†æ¨ç†ã‚²ãƒ¼ãƒ ã§ã‚ã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æˆ¦ç•¥çš„ã«è³ªå•ã‚’å±•é–‹ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã“ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `transformers`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ã‚‰ã‹ã˜ã‚è¨“ç·´ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ï¼ˆLlama3ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€è¨€èªç”Ÿæˆã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€è³ªå•ã«åŸºã¥ã„ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹èƒ½åŠ›ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚
- **PyTorch**: ãƒ¢ãƒ‡ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å‹•ä½œã«PyTorchãŒä½¿ç”¨ã•ã‚Œã€ç‰¹ã«GPUã‚’ä½¿ã£ã¦ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„å®Ÿè¡Œã‚’è¡Œã†ãŸã‚ã®è¨­å®šãŒã•ã‚Œã¦ã„ã¾ã™ã€‚
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: `Llama3Formatter`ã‚¯ãƒ©ã‚¹ã‚„`Llama3Agent`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚„ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ åŒ–ã‚’æ‹…å½“ã—ã¾ã™ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ
1. **è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆLlama3QuestionerAgentï¼‰**: è³ªå•è€…ã¨ã—ã¦ã®æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹å˜èªã®ã‚«ãƒ†ã‚´ãƒªã‚„æ–‡å­—ã®è€ƒæ…®ã‚’è¡Œã„ãªãŒã‚‰ã€è§£ç­”ã‚’å°å‡ºã™ã‚‹èƒ½åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
2. **å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆLlama3AnswererAgentï¼‰**: æä¾›ã•ã‚ŒãŸè³ªå•ã«å¯¾ã—ã¦ã€é©åˆ‡ã«ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã‚’å¿œç­”ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€éå»ã®è³ªå•ã¨å›ç­”ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã—ãªãŒã‚‰ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã®ãƒ­ãƒ¼ãƒ«ã‚’æœãŸã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã©ã®ã‚ˆã†ã«æŒ¯ã‚‹èˆã†ã‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚„ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹é‡è¦ãªãƒªã‚½ãƒ¼ã‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 2)---
```python
%%writefile submission/main.py
# æº–å‚™
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch

# https://github.com/Lightning-AI/litgpt/issues/327
torch.backends.cuda.enable_mem_efficient_sdp(False) # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’æœ€é©åŒ–ã™ã‚‹æ©Ÿèƒ½ã‚’ç„¡åŠ¹ã«ã—ã¾ã™
torch.backends.cuda.enable_flash_sdp(False) # ãƒ•ãƒ©ãƒƒã‚·ãƒ¥SDPæ©Ÿèƒ½ã‚’ç„¡åŠ¹ã«ã—ã¾ã™

if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "llama-3/transformers/8b-chat-hf/1")
else:
    WEIGHTS_PATH = "/kaggle/input/llama-3/transformers/8b-chat-hf/1"

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

# Llama3Formatterã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™
class Llama3Formatter:
    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt
        self._few_shot_examples = few_shot_examples
        self.reset()  # ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™

    def get_dict(self):
        return self._state

    def user(self, prompt):
        self._state.append({'role': 'user', 'content': prompt})  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™
        return self

    def model(self, prompt):
        self._state.append({'role': 'assistant', 'content': prompt})  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™
        return self
    
    def system(self, prompt):
        self._state.append({'role': 'system', 'content': prompt})  # ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™
        return self

    def reset(self):
        self._state = []  # ã‚¹ãƒ†ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™
        if self._system_prompt is not None:
            self.system(self._system_prompt)
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]
        formatters = itertools.cycle(formatters)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’å¾ªç’°ã•ã›ã¾ã™
        for fmt, turn in zip(formatters, turns):
            fmt(turn)  # å„ã‚¿ãƒ¼ãƒ³ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™
        return self

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©
import re

class Llama3Agent:
    def __init__(self, system_prompt=None, few_shot_examples=None):
        self.formatter = Llama3Formatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)
        self.tokenizer = AutoTokenizer.from_pretrained(WEIGHTS_PATH)  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™
        self.terminators = [self.tokenizer.eos_token_id, self.tokenizer.convert_tokens_to_ids("")]
        
        ### å…ƒã®ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
        self.model = AutoModelForCausalLM.from_pretrained(
            WEIGHTS_PATH,
            device_map="auto",
            torch_dtype=torch.bfloat16
        )

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™
        prompt = self.formatter.get_dict()  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã—ã¾ã™
        response = self._call_llm(prompt)  # LLMã‚’å‘¼ã³å‡ºã—çµæœã‚’å–å¾—ã—ã¾ã™
        response = self._parse_response(response, obs)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¾ã™
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # æœªå®Ÿè£…ã®çŠ¶æ…‹ã§ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¾ã™

    def _call_llm(self, prompt, max_new_tokens=32):
        input_ids = self.tokenizer.apply_chat_template(
            prompt,
            add_generation_prompt=True,
            return_tensors="pt",
        ).to(self.model.device)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ†ãƒ³ã‚½ãƒ«ã‚’ç§»å‹•ã—ã¾ã™
        outputs = self.model.generate(
            input_ids=input_ids,
            max_new_tokens=max_new_tokens,
            eos_token_id=self.terminators,
            do_sample=True,
            temperature=0.6,
            top_p=0.9
        )
        response = self.tokenizer.decode(outputs[0][input_ids.shape[-1]:], skip_special_tokens=True)  # ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¾ã™

        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ã—ã¾ã™
        if match is None:
            keyword = ''
        else:
            keyword = match.group().lower()  # å°æ–‡å­—ã«å¤‰æ›ã—ã¾ã™
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # æœªå®Ÿè£…ã®çŠ¶æ…‹ã§ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¾ã™

# ä¸å‡ä¸€ãªè¦ç´ ã‚’äº¤äº’ã«å–ã‚Šå‡ºã™é–¢æ•°
def interleave_unequal(x, y):
    return [
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None  # ä¸å‡ä¸€ãªè¦ç´ ã‚’äº¤äº’ã«å–ã‚Šå‡ºã—ã¾ã™
    ]

class Llama3QuestionerAgent(Llama3Agent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.category_determined = False  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ±ºå®šã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹
        self.is_place = False  # å ´æ‰€ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        self.first_char_range = (0, 25)  # Aã‹ã‚‰Zã¾ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¯„å›²
        self.second_char_range = None  # 2æ–‡å­—ç›®ã®ç¯„å›²
        self.final_guess = None  # æœ€çµ‚çš„ãªæ¨æ¸¬

    def _start_session(self, obs):
        global guesses  # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å‚ç…§

        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½¹å‰²ã‚’æŒ‡å®šã—ã¾ã™
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«å–ã‚Šå‡ºã—ã¾ã™
        self.formatter.apply_turns(turns, start_agent='model')  # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™

        if not self.category_determined:
            self.formatter.user("Is it a place?")  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ±ºå®šã•ã‚Œã¦ã„ãªã„å ´åˆã®è³ªå•
        else:
            if self.second_char_range is None:
                mid_index = (self.first_char_range[0] + self.first_char_range[1]) // 2  # ä¸­é–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨ˆç®—
                mid_char = chr(65 + mid_index)  # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«å¤‰æ› (0 -> A, 1 -> B, ..., 25 -> Z)
                self.formatter.user(f"Does the keyword start with a letter before {mid_char}?")
            elif self.final_guess is None:
                mid_index = (self.second_char_range[0] + self.second_char_range[1]) // 2
                mid_char = chr(65 + mid_index)
                self.formatter.user(f"Does the second letter of the keyword come before {mid_char}?")
            else:
                self.formatter.user(f"Is the keyword **{self.final_guess}**?")  # æœ€çµ‚æ¨æ¸¬ã‚’ç¢ºèªã—ã¾ã™

    def _parse_response(self, response: str, obs: dict):
        if not self.category_determined:
            answer = self._parse_keyword(response)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è§£æã—ã¾ã™
            self.is_place = (answer == 'yes')  # 'yes'ã®å ´åˆã¯å ´æ‰€ã¨åˆ¤å®š
            self.category_determined = True  # ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒæ±ºå®šã—ãŸã“ã¨ã‚’è¨˜éŒ²
            return "Is it a place?"  # è³ªå•ã‚’è¿”ã—ã¾ã™
        else:
            if self.second_char_range is None:
                answer = self._parse_keyword(response)
                mid_index = (self.first_char_range[0] + self.first_char_range[1]) // 2
                if answer == 'yes':
                    self.first_char_range = (self.first_char_range[0], mid_index)  # ç¯„å›²ã‚’æ›´æ–°
                else:
                    self.first_char_range = (mid_index + 1, self.first_char_range[1])

                if self.first_char_range[0] == self.first_char_range[1]:
                    self.second_char_range = (0, 25)  # 2æ–‡å­—ç›®ã®ç¯„å›²ã‚’ãƒªã‚»ãƒƒãƒˆ
                    return f"Does the keyword start with {chr(65 + self.first_char_range[0])}?"
                else:
                    mid_index = (self.first_char_range[0] + self.first_char_range[1]) // 2
                    mid_char = chr(65 + mid_index)
                    return f"Does the keyword start with a letter before {mid_char}?"
            elif self.final_guess is None:
                answer = self._parse_keyword(response)
                mid_index = (self.second_char_range[0] + self.second_char_range[1]) // 2
                if answer == 'yes':
                    self.second_char_range = (self.second_char_range[0], mid_index)  # 2æ–‡å­—ç›®ã®ç¯„å›²ã‚’æ›´æ–°
                else:
                    self.second_char_range = (mid_index + 1, self.second_char_range[1])

                if self.second_char_range[0] == self.second_char_range[1]:  # æœ€çµ‚æ¨æ¸¬ã‚’æ±ºå®š
                    first_char = chr(65 + self.first_char_range[0])
                    second_char = chr(65 + self.second_char_range[0])
                    self.final_guess = first_char + second_char
                    return f"Does the keyword start with {first_char}{second_char}?"
                else:
                    mid_index = (self.second_char_range[0] + self.second_char_range[1]) // 2
                    mid_char = chr(65 + mid_index)
                    return f"Does the second letter of the keyword come before {mid_char}?"
            else:
                answer = self._parse_keyword(response)
                if answer == 'yes':
                    return f"The keyword is **{self.final_guess}**."  # æœ€çµ‚çš„ãªç­”ãˆã‚’è¿”ã—ã¾ã™
                else:
                    self.final_guess = None  # æœ€çµ‚æ¨æ¸¬ã‚’ãƒªã‚»ãƒƒãƒˆ
                    return "Let's continue guessing."  # æ¨æ¸¬ã‚’ç¶šã‘ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™


class Llama3AnswererAgent(Llama3Agent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # å›ç­”è€…ã¨ã—ã¦ã®å½¹å‰²ã‚’æŒ‡å®šã—ã¾ã™
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«å–ã‚Šå‡ºã—ã¾ã™
        self.formatter.apply_turns(turns, start_agent='user')  # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.") #  yes/noã®å›ç­”ã‚’è¦æ±‚

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è§£æã—ã¾ã™
        return 'yes' if 'yes' in answer else 'no'  # 'yes'ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°'yes'ã‚’è¿”ã—ã¾ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
system_prompt = "ã‚ãªãŸã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸéå¸¸ã«è³¢ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€ãã®å›ç­”è€…ã®yes-or-noã®è³ªå•ã«å¯¾ã—ã¦è³ªå•è€…ãŒå¿œç­”ã—ã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å ´æ‰€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

few_shot_examples = [
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is the category of the keyword place?", "**no**",
    "Is it a food?", "**yes** Now guess the keyword in the category things.",
    "**Veggie Burger**", "Correct.",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
# ä¸¡æ–¹ã‚’èª­ã¿è¾¼ã‚€ã¨ã€ãƒ¡ãƒ¢ãƒªã‚ªãƒ¼ãƒãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = Llama3QuestionerAgent(
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    elif agent is None and name == 'answerer':
        agent = Llama3AnswererAgent(
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )
    assert agent is not None, "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    return agent

turnRound = 1
guesses = []

def agent_fn(obs, cfg):
    global turnRound
    global guesses

    if obs.turnType == "ask":
        if turnRound == 1:
            response = "Is it a place?" # æœ€åˆã®è³ªå•
        else:
            response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)
        turnRound += 1  # å›åˆã‚’å¢—ã‚„ã—ã¾ã™
        guesses.append(response)  # æ¨æ¸¬ã‚’è¿½åŠ 
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™
        turnRound += 1  # å›åˆã‚’å¢—ã‚„ã—ã¾ã™
    if response is None or len(response) <= 1:
        return "yes"  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã¾ãŸã¯çŸ­ã„å ´åˆã¯yesã‚’è¿”ã—ã¾ã™
    else:
        return response  # ãã‚Œä»¥å¤–ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 4)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ llama-3/transformers/8b-chat-hf/1
```

---The following area is a Code cell (cell numver is 5)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

** @@@ Jupyter Notebook numver 61, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹è¨€èªãƒ¢ãƒ‡ãƒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é–‹ç™ºã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ç‰¹ã«æ¨æ¸¬ã‚²ãƒ¼ãƒ ã€Œ20ã®è³ªå•ã€ã«ãŠã„ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåŠ¹ç‡çš„ã«ç­”ãˆã‚’å°ãå‡ºã™ãŸã‚ã®æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¢ç´¢ã—ã¦ã„ã¾ã™ã€‚

## å•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€å‚ç…§ã™ã‚‹ãƒªã‚¹ãƒˆï¼ˆå‹•ç‰©ã€äººç‰©ã€å ´æ‰€ï¼‰ã‹ã‚‰ã€ä¸ãˆã‚‰ã‚ŒãŸãƒ’ãƒ³ãƒˆã«åŸºã¥ã„ã¦æ­£ã—ã„ç­”ãˆã‚’æ¨æ¸¬ã—ã¦ã„ãã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã¨ã„ã£ãŸå›ç­”ã‚’ã™ã‚‹çŠ¶æ³ã«ãŠã„ã¦ã€ã©ã®ã‚ˆã†ã«åŠ¹æœçš„ã«è³ªå•ã‚’ã—ã¦æ¨æ¸¬ã‚’è¡Œã†ã‹ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ã„ã¾ã™ã€‚

## æ‰‹æ³•
ä»¥ä¸‹ã®æ–¹æ³•ã§å•é¡Œã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ã¦ã„ã¾ã™ã€‚

1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨**: `numpy`ã¨`pandas`ãŒãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„åˆ†æã«ä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€Kaggleã®è¨­å®šã«ãŠã„ã¦ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯äº‹å‰ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ **:
   - **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç”Ÿæˆ**: `agent_first_letter`é–¢æ•°ãŒã€è³ªå•ã®æœ€åˆã®æ–‡å­—ã«åŸºã¥ã„ã¦ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚æ¨æ¸¬ã¨è³ªå•ã‚’åˆ†ã‘ã¦ç®¡ç†ã—ã€å›ç­”è€…ãŒä¸ãˆãŸæƒ…å ±ã«å¿œã˜ã¦è³ªå•ã‚’å¤‰ãˆã¾ã™ã€‚
   - **ç°¡æ˜“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `simple_agent1`, `simple_agent2`, `simple_agent3`ã®ã‚ˆã†ãªç°¡ç•¥åŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚ä½œæˆã•ã‚Œã¦ãŠã‚Šã€å›ºå®šã®æˆ¦ç•¥ã«åŸºã¥ã„ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«è³ªå•ã‚’ã—ãŸã‚Šæ¨å¯Ÿã—ãŸã‚Šã—ã¾ã™ã€‚

3. **ç’°å¢ƒã®è¨­å®šã¨ãƒ†ã‚¹ãƒˆ**: `kaggle_environments`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å°‚ç”¨ã®ç’°å¢ƒã‚’ä½œæˆã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŸã¡ã‚’å®Ÿè¡Œã—ã¦ãã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚ã“ã®ç’°å¢ƒã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«ç›¸äº’ä½œç”¨ã™ã‚‹ã‹ã‚’è¦³å¯Ÿã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## çµè«–
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã•ã¾ã–ã¾ãªæˆ¦ç•¥ã‚’è©¦ã™ãŸã‚ã®åŸºç›¤ã¨ã—ã¦æ©Ÿèƒ½ã—ã€ç‰¹å®šã®è³ªå•ã«åŸºã¥ã„ãŸæ¨æ¸¬ã‚’è¡Œã†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ç¢ºèªã—ã¦æœ€é©åŒ–ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€§èƒ½ã‚’è©•ä¾¡ã—ã€ã‚ˆã‚ŠåŠ¹ç‡çš„ãªæ¨è«–ã‚’è¡Œã†ãŸã‚ã®å‚è€ƒã¨ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ­£ã—ã„ç­”ãˆã‚’å¾—ã‚‹ãŸã‚ã®æ–°ã—ã„è€ƒãˆæ–¹ã‚’æä¾›ã—ã¾ã™ã€‚ãŸã ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚ã¾ãŸã€ã“ã‚ŒãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹çŸ¥ã‚ŠãŸã„ã§ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯kaggle/python Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ã“ã“ã§ã¯ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã™

import numpy as np # ç·šå½¢ä»£æ•°ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª, CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ› (ä¾‹: pd.read_csv)

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã® "../input/" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼ˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹Shift + Enterã‚’æŠ¼ã™ã“ã¨ã§ï¼‰å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ/kaggle/working/ï¼‰ã«ã¯æœ€å¤§20GBã¾ã§æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€"Save & Run All"ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã¨å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
# ã¾ãŸã€/kaggle/temp/ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 3)---
```python
#%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random

animal_list= ["dog","cat","hen","fish",'duck','cow','tiger','']  # å‹•ç‰©ã®ãƒªã‚¹ãƒˆ
person_list= ['Elon Musk','Jos Biden','Jack Ma','Harry Potter']  # äººç‰©ã®ãƒªã‚¹ãƒˆ
place_list=['Beijing', "London", 'New York','Tokyo']  # å ´æ‰€ã®ãƒªã‚¹ãƒˆ

# æå‡ºç‰©ã®/libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ï¼‰ã‚’ç½®ãå ´åˆã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšå‚åŠ æ™‚ã®ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")
sys.path.insert(0, subdirectory_path)  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ã‚¹ã‚’ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ã‚¹ã«è¿½åŠ 

def agent_first_letter(obs, cfg):    
    if obs.turnType == "ask":        
        #print(obs.step)  # ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        if len(obs['answers']) == 0:  
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹ã‚’ç¢ºèª
            response = "str(obs.keyword)[0].lower() in list('abcdefghijklm') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['a','b','c','d','e','f','g','h','i','j','k','l','m']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
        elif (len(obs.answers) == 1):
            if (obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('abcdef') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['a','b','c','d','e','f']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            else:
                response = "str(obs.keyword)[0].lower() in list('nopqrs') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['n','o','p','q','r','s']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
        elif (len(obs.answers) == 2):
            if (obs.answers[-2]=="yes")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('abc') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['a','b','c']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-2]=="yes")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('ghij') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['g','h','i','j']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-2]=="no")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('nop') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['n','o','p']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-2]=="no")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('tuvw') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['t','u','v','w']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"

        elif (len(obs.answers) == 3):
            if (obs.answers[-3]=="yes")&(obs.answers[-2]=="yes")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('ab') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['a','b']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="yes")&(obs.answers[-2]=="yes")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('de') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['d','e']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="yes")&(obs.answers[-2]=="no")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('gh') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['g','h']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="yes")&(obs.answers[-2]=="no")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('kl') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['k','l']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="no")&(obs.answers[-2]=="yes")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('no') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['n','o']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="no")&(obs.answers[-2]=="yes")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('qr') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['q','r']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="no")&(obs.answers[-2]=="no")&(obs.answers[-1]=="yes"):
                response = "str(obs.keyword)[0].lower() in list('tu') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['t','u']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"
            elif (obs.answers[-3]=="no")&(obs.answers[-2]=="no")&(obs.answers[-1]=="no"):
                response = "str(obs.keyword)[0].lower() in list('xz') #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€åˆã®æ–‡å­—ãŒ['x','z']ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã‹?"

        else:
            response = 'Is the keyword xxxxxx?' + str(obs["step"])  # é€šå¸¸ã®ã‚±ãƒ¼ã‚¹ã§ãªã„å ´åˆã®å¿œç­”
            
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"guess"ã®ã¨ã
    elif obs.turnType == "guess":
        if (obs.questions[-1]=="is it a place") & (obs.answers[-1]=="yes"):
            guess = random.choice(place_list)  # å ´æ‰€ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
        else:
            guess = random.choice(animal_list)  # å‹•ç‰©ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
         
        response = guess     
  
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®ã¨ã
    elif obs.turnType == "answer":
        if "#" in (obs.questions)[-1]:  # æœ€å¾Œã®è³ªå•ã«#ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            ques = (obs.questions)[-1]
            try:
                ques = ques[0:ques.find('#')]  # #ã®å‰ã®è³ªå•éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã™
                response = 'yes' if eval(ques) else 'no'  # è³ªå•ã‚’è©•ä¾¡ã—ã¦yesã‹noã‚’è¿”ã™
            except:
                ques = ques[ques.find('#')+1:]  # #ä»¥é™ã®éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã™
                random.choice(['yes','no']) # ã“ã“ã«LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
        else:             
            response = random.choice(['yes','no']) # ã“ã“ã«LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™        
    return response
```

---The following area is a Code cell (cell numver is 4)---
```python
import random
def simple_agent1(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®ã¨ã
    if obs.turnType == "ask": response = random.choice(list_qs)  # è³ªå•ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    elif obs.turnType == "guess": 
        if obs.answers[-1]=="yes":  # æœ€å¾Œã®å›ç­”ãŒã€Œã¯ã„ã€ã®å ´åˆ
            response = "duck"  # "duck"ã¨æ¨æ¸¬
        else:
            response = "penguin"  # "penguin"ã¨æ¨æ¸¬
        
    elif obs.turnType == "answer": response = random.choice(['yes','no'])  # yesã¾ãŸã¯noã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    return response

def simple_agent2(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®ã¨ã
    if obs.turnType == "ask": response = "Is it a bird?"  # é³¥ã‹ã©ã†ã‹ã‚’å°‹ã­ã‚‹
    elif obs.turnType == "guess": response = "bird"  # "bird"ã¨æ¨æ¸¬
    elif obs.turnType == "answer": response = random.choice(['yes','no'])  # yesã¾ãŸã¯noã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    return response

def simple_agent3(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒ"ask"ã®ã¨ã
    if obs.turnType == "ask": response = random.choice(list_qs)  # è³ªå•ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    elif obs.turnType == "guess": 
        if len(obs.answers) == 0:  # å›ç­”ãŒãªã„å ´åˆ
            response = "cat"  # "cat"ã¨æ¨æ¸¬
        elif obs.answers[-1]=="yes":  # æœ€å¾Œã®å›ç­”ãŒã€Œã¯ã„ã€ã®å ´åˆ
            response = "duck"  # "duck"ã¨æ¨æ¸¬
        else:
            response = "penguin"  # "penguin"ã¨æ¨æ¸¬
        
    elif obs.turnType == "answer":
        if "#" in (obs.questions)[-1]:  # æœ€å¾Œã®è³ªå•ã«#ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            ques = (obs.questions)[-1]
            try:
                ques = ques[0:ques.find('#')]  # #ã®å‰ã®è³ªå•éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã™
                response = 'yes' if eval(ques) else 'no'  # è³ªå•ã‚’è©•ä¾¡ã—ã¦yesã‹noã‚’è¿”ã™
            except:
                random.choice(['yes','no']) # ã“ã“ã«LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™         
        else:             
            response = random.choice(['yes','no']) # ã“ã“ã«LLMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
        
    return response
```

---The following area is a Code cell (cell numver is 5)---
```python
from kaggle_environments import make
env = make(environment="llm_20_questions")  # ç’°å¢ƒã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 6)---
```python
game_output = env.run(agents=[agent_first_letter, simple_agent3, simple_agent2, simple_agent1])  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
env.render(mode="ipython", width=600, height=900)  # çµæœã‚’è¡¨ç¤º
```

** @@@ Jupyter Notebook numver 62, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyterãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ­ãƒœãƒƒãƒˆï¼‰ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ç‰¹ã«åˆå¿ƒè€…å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ã‚²ãƒ¼ãƒ å†…ã§è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ãŒã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚“ã§ã„ã‚‹å•é¡Œ
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚’ç”¨ã„ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã¨ã„ã†èª²é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã å˜èªã‚’è³ªå•ã‚’é€šã˜ã¦æ¨æ¸¬ã—ã€ã¾ãŸã€ãã®è³ªå•ã«å¯¾ã—ã¦ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
   - `transformers`: Hugging Faceã®Transformersãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰è¨“ç·´ã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
   - `torch`: PyTorchã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã®æ¨è«–ã‚’è¡Œã„ã¾ã™ã€‚
   - `kaggle_secrets`: Kaggleç’°å¢ƒã§ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã«ä½¿ç”¨ã€‚

2. **ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–**:
   - `AutoTokenizer` ã¨ `AutoModelForCausalLM` ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’åˆæœŸåŒ–ã€‚

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆ**:
   - `Robot`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã€è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®ãã‚Œãã‚Œã®å½¹å‰²ã‚’æœãŸã™ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã€‚
   - è³ªå•ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‹å½¢å¼ã¨ã—ã€é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸ãˆã¦ç”Ÿæˆã™ã‚‹è³ªå•ã‚’åˆ¶å¾¡ã€‚

4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œ**:
   - `agent`é–¢æ•°ã«ãŠã„ã¦ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ¼ãƒ‰ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ï¼‰ã‚’è¨­å®šã—ã€ãƒ­ãƒœãƒƒãƒˆãŒæ­£ã—ã„å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã€‚

5. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ**:
   - ç’°å¢ƒå†…ã§ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯æœ€å¾Œã«ã€æå‡ºç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æå‡ºã™ã‚‹éš›ã®æ‰‹é †ã«å¾“ã£ã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®æ˜ç¢ºãªæ‰‹é †ã‚’æä¾›ã—ã¦ãŠã‚Šã€ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„æ‰‹æ³•ã‚’è©³ç´°ã«è§£èª¬ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ã“ã®ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã¯åˆå¿ƒè€…å‘ã‘ã§ã™
## ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§å¿…è¦ãªã“ã¨ã¯ï¼Ÿ

**è¦ç´„ï¼š20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨**

ãƒ­ãƒœãƒƒãƒˆãŒè©±ã—ã€æ­©ãã€è¸Šã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®ä»•äº‹ã¯ã€ãã®ãƒ­ãƒœãƒƒãƒˆãŒå„å½¹å‰²ã‚’é©åˆ‡ã«è¡Œã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ããªå½¹å‰²ã‚’é¸æŠã—ã¦ä»–ã®å½¹å‰²ã«å¹²æ¸‰ã™ã‚‹ã“ã¨ãªãå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ï¼ˆä¾‹ãˆã°ã€3ã¤ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚

ã“ã‚Œã¯ã¾ã•ã«ã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã‚ãªãŸã«æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚è³ªå•è€…ã€å›ç­”è€…ã€æ¨æ¸¬è€…ã®3ã¤ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ãŒã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ãƒ­ãƒœãƒƒãƒˆï¼ˆllmãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã¡ã‚‰ã®æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚“ã å ´åˆã€æå‡ºã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€åˆ¥ã®å‚åŠ è€…ãŒæå‡ºã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å¯¾æˆ¦ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¥ã‚ªã®ä¸­ã§ã€ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è³ªå•è€…ã¨æ¨æ¸¬è€…ã®å½¹å‰²ã‚’æœãŸã™ã‹ã€å›ç­”è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚å½¹å‰²ã¨ãƒã‚¤ãƒãƒ¼ãƒ ï¼ˆ2äººçµ„ï¼‰ã¯ã€è£ã§ã®ç’°å¢ƒã«ã‚ˆã£ã¦ã„ãã¤ã‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦é¸æŠã•ã‚Œã€ã‚ãªãŸã¯ãã‚Œã«ã¤ã„ã¦å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã‚ãªãŸãŒã™ã¹ãã“ã¨ã¯ã€ç’°å¢ƒãŒå›ç­”è€…ã®å½¹å‰²ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã‚’æ±ºå®šã—ãŸã¨ãã€ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã ã‘ã§ã™ã€‚ä»–ã®å›ç­”ã‚’ã™ã‚‹ã“ã¨ã¯ã€ã‚²ãƒ¼ãƒ ã«è² ã‘ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

è©³ç´°ã¯ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ [ã“ã¡ã‚‰](https://www.kaggle.com/competitions/llm-20-questions/overview) 

## æå‡ºæ–¹æ³•ã¯ï¼Ÿ

ã‚³ãƒ¼ãƒ‰ã¯main.pyã¨ã„ã†1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ãªã‘ã‚Œã°ãªã‚‰ãšã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ãƒ­ãƒœãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰ã¨ã€obsãŠã‚ˆã³cfgã‚’å¼•æ•°ã¨ã™ã‚‹å¿…é ˆã®é–¢æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€è£ã§ç’°å¢ƒãŒã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ç§ãŸã¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆä»–ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ¯”ã¹ã¦éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ï¼‰ã§ã¯ã€ã“ã®é–¢æ•°ã«ã€Œagentã€ã¨ã„ã†åå‰ã‚’ä»˜ã‘ã€ä»–ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€Œrobotã€ã¨ã„ã†åå‰ã®ã‚¯ãƒ©ã‚¹ã«å…¥ã‚Œã¾ã™ã€‚

ç’°å¢ƒã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€/kaggle/inputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨main.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ­ãƒ¼ãƒ‰/ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

è£ã§tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œ/kaggle_simulations/agent/ã€ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸‹ã«å±•é–‹ã•ã‚Œã‚‹ãŸã‚ã€ç§ãŸã¡ã¯å®Ÿè¡Œç’°å¢ƒã«å¿œã˜ã¦ãƒ‘ã‚¹ã‚’èª¿æ•´ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ï¼ˆä¸‹è¨˜ã‚’å‚ç…§ï¼‰ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã€Œãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
mkdir -p /kaggle/working/submission
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile -a submission/main.py

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
from kaggle_secrets import UserSecretsClient
import os
import sys
import shutil

# CUDAã®ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’æœ‰åŠ¹ã«ã™ã‚‹
torch.backends.cuda.enable_mem_efficient_sdp(False)
torch.backends.cuda.enable_flash_sdp(False)

# Kaggleã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    model_id = os.path.join(KAGGLE_AGENT_PATH, "1")
else:
    model_id = "/kaggle/input/llama-3/transformers/8b-chat-hf/1"

# ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
tokenizer = AutoTokenizer.from_pretrained(model_id)
model = AutoModelForCausalLM.from_pretrained(model_id, torch_dtype=torch.bfloat16, device_map="auto")
id_eot = tokenizer.convert_tokens_to_ids(["<|eot_id|>"])[0]

# å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
def generate_answer(template):
    inp_ids = tokenizer(template, return_tensors="pt").to("cuda")
    out_ids = model.generate(**inp_ids,max_new_tokens=15).squeeze()
    start_gen = inp_ids.input_ids.shape[1]
    out_ids = out_ids[start_gen:]
    if id_eot in out_ids:
        stop = out_ids.tolist().index(id_eot)
        out = tokenizer.decode(out_ids[:stop])
    else:
        out = tokenizer.decode(out_ids)
    return out
    

class Robot:
    def __init__(self):
        pass
    
    def on(self, mode, obs):
        assert mode in ["asking", "guessing", "answering"], "modeã¯ã“ã‚Œã‚‰ã®å€¤ã®ã„ãšã‚Œã‹ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ï¼šasking, answering, guessing"
        if mode == "asking":
            # è³ªå•è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.asker(obs)
        if mode == "answering":
            # å›ç­”è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.answerer(obs)
            if "yes" in output.lower():
                output = "yes"
            elif "no" in output.lower():
                output = "no"   
            if ("yes" not in output.lower() and "no" not in output.lower()):
                output = "yes"  # æ˜ç¢ºãªå›ç­”ãŒç„¡ã‹ã£ãŸå ´åˆã¯ã€Œyesã€ã«ã™ã‚‹
        if mode == "guessing":
            # æ¨æ¸¬è€…ã®å½¹å‰²ã‚’å§‹ã‚ã‚‹
            output = self.asker(obs)
        return output
    
    
    def asker(self, obs):
        sys_prompt = """ã‚ãªãŸã¯æœ‰èƒ½ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒéå¸¸ã«å¾—æ„ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å˜èªã‚’è€ƒãˆã‚‹ã¤ã‚‚ã‚Šã§ã™ã€‚ãã‚Œã¯æ¬¡ã®3ã¤ã®ã‚«ãƒ†ã‚´ãƒªã®ã„ãšã‚Œã‹ã§ã™ï¼š
        1. å ´æ‰€
        2. äººç‰©
        3. ç‰©
        ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã€æ¤œç´¢ç¯„å›²ã‚’ç‹­ã‚ã‚‹ãŸã‚ã®è³¢ã„è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚\n"""
    
        if obs.turnType =="ask":
            ask_prompt = sys_prompt + """ã‚ãªãŸã®å½¹å‰²ã¯ã€å½¼ã«20ã®è³ªå•ä»¥å†…ã§å˜èªã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚ã‚ãªãŸã®è³ªå•ã¯æœ‰åŠ¹ã§ã‚ã‚‹ãŸã‚ã«ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å›ç­”ã®ã¿ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
            ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã«ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã¹ãã‹ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ï¼š
            ä¾‹ï¼š
            <ã‚ãªãŸï¼šãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ã‚ãªãŸï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„
            ã‚ãªãŸï¼šãã“ã§ç”Ÿãã¦ã„ã‚‹äººã€…ã®å¤§åŠã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã„ã„ãˆ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šmã‹ã‚‰å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
            ã‚ãªãŸï¼šã¯ã„
            ã‚ãªãŸï¼šãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã¯ã„ã€‚>

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå˜èªã‚’é¸ã³ã¾ã—ãŸã€‚æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãç°¡æ½”ã«ã—ã€ä½™è¨ˆãªè¨€è‘‰ã¯ä½¿ã‚ãšã€ä¸€ã¤ã®è³ªå•ã ã‘ã‚’ã—ã¦ãã ã•ã„ï¼"""
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{ask_prompt}<|eot_id|>"""
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
            if len(obs.questions)>=1:
                for q, a in zip(obs.questions, obs.answers):
                    chat_template += f"{q}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                    chat_template += f"{a}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
                    
        elif obs.turnType == "guess":
            conv = ""
            for q, a in zip(obs.questions, obs.answers):
                conv += f"""è³ªå•: {q}\nå›ç­”: {a}\n"""
            guess_prompt =  sys_prompt + f"""ã“ã‚Œã¾ã§ã®ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¯æ¬¡ã®é€šã‚Šã§ã™:\n{conv}
            ä¼šè©±ã«åŸºã¥ã„ã¦ã€å˜èªã‚’æ¨æ¸¬ã§ãã¾ã™ã‹ï¼Ÿå˜èªã ã‘ã‚’æ•™ãˆã¦ãã ã•ã„ã€ä½™è¨ˆãªè¨€è‘‰ã¯ã„ã‚Šã¾ã›ã‚“ã€‚"""
            chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{guess_prompt}<|eot_id|>"""
            chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
                
        output = generate_answer(chat_template)        
        return output
        
        
        
    def answerer(self, obs):
        sys_prompt = f"""ã‚ãªãŸã¯æœ‰èƒ½ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒéå¸¸ã«å¾—æ„ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã¯ã€ã‚ãªãŸã«å¯¾ã—ã¦æœ€å¤§20ã®è³ªå•ã‚’ä½¿ã£ã¦å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã§ã™ã€‚ã‚ãªãŸã®å›ç­”ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ãã®ä»–ã®å›ç­”ã¯ç„¡åŠ¹ã§ã‚ã‚Šã€ãã‚Œã«ã‚ˆã‚Šã‚²ãƒ¼ãƒ ã«è² ã‘ã¾ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¸¸ã«æ¬¡ã®3ã¤ã®ã‚«ãƒ†ã‚´ãƒªã®ã„ãšã‚Œã‹ã«å±ã™ã‚‹å˜èªã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼š
        1. å ´æ‰€
        2. äººç‰©
        3. ç‰©
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ç†è§£ã—ã€ã‚ãªãŸãŒãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠŠæ¡ã—ã¦ãã ã•ã„ã€‚
        ç¾åœ¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å˜èªã¯ã€Œ{obs.keyword}ã€ã§ã€ã‚«ãƒ†ã‚´ãƒªã¯ã€Œ{obs.category}ã€ã§ã™ã€‚
        ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã«ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã¹ãã‹ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚«ãƒ†ã‚´ãƒªã€Œå ´æ‰€ã€ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ï¼š
        ä¾‹ï¼š
        <ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãã“ã§ç”Ÿãã¦ã„ã‚‹äººã€…ã®å¤§åŠã¯è‚ŒãŒæš—ã„ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šmã‹ã‚‰å§‹ã¾ã‚‹å›½åã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸï¼šã¯ã„ã€‚>"""
        
        chat_template = f"""<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n{sys_prompt}<|eot_id|>"""
        chat_template += "<|start_header_id|>user<|end_header_id|>\n\n"
        chat_template += f"{obs.questions[0]}<|eot_id|>"
        chat_template += "<|start_header_id|>assistant<|end_header_id|>\n\n"
        if len(obs.answers)>=1:
            for q, a in zip(obs.questions[1:], obs.answers):
                chat_template += f"{a}<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n"
                chat_template += f"{q}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
        output = generate_answer(chat_template)
        return output
    
    
robot = Robot()


def agent(obs, cfg):
    
    if obs.turnType =="ask":
        response = robot.on(mode = "asking", obs = obs)
        
    elif obs.turnType =="guess":
        response = robot.on(mode = "guessing", obs = obs)
        
    elif obs.turnType =="answer":
        response = robot.on(mode = "answering", obs = obs)
        
    if response == None or len(response)<=1:
        response = "yes"
        
    return response
```

---The following area is a Markdown cell (cell numver is 4)---
```markdown
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ <a id="lc"></a>

ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ã¾ãšä¸Šã®ã‚»ãƒ«ã®ã€Œ%%writefile -a submission/main.pyã€ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã€ã“ã®ã‚»ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚»ãƒ«ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 5)---
```python
# %%time

# from kaggle_environments import make
# env = make("llm_20_questions", debug=True)
# game_output = env.run(agents=[agent, agent, agent, agent])
```

---The following area is a Code cell (cell numver is 6)---
```python
# env.render(mode="ipython", width=600, height=500)
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
# æå‡ºãƒ•ã‚¡ã‚¤ãƒ«
```

---The following area is a Code cell (cell numver is 8)---
```python
!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 9)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/input/llama-3/transformers/8b-chat-hf . -C /kaggle/working/submission .
```

---The following area is a Code cell (cell numver is 10)---
```python
# tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹

# import tarfile
# tar = tarfile.open("/kaggle/working/submission.tar.gz")
# for file in tar.getmembers():
#     print(file.name)
```

---The following area is a Markdown cell (cell numver is 11)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## davide
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
> 
> ãŸã è³ªå•ã§ã™ãŒã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯keyword.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ãä½¿ç”¨ã—ã¦ã„ãªã„ã®ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > [@davidemariani](https://www.kaggle.com/davidemariani) ã„ã„ãˆ
> > 
> > 
> > 


---

> ## dhruvyadav89300
> 
> ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’èª¬æ˜ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã¨ã¦ã‚‚å½¹ã«ç«‹ã¡ã¾ã—ãŸã€‚
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã‚Œã‚’èã„ã¦å¬‰ã—ã„ã§ã™ :)
> > 
> > 
> > 


---

> ## Chazzyie
> 
> ã‚ãªãŸã®ä½œæ¥­ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜ç¢ºã§ã™ ğŸ¤©
> 
> 


---

> ## Matthew S Farmer
> 
> ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã­ã€‚FYIã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€Œäººç‰©ã€ã¨ã„ã†ã‚«ãƒ†ã‚´ãƒªãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã¯ã‚ãªãŸã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œç´¢ç©ºé–“ã‚’å°‘ã—ã§ã‚‚ä¿ã¤ã®ã«å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ 
> 
> 
> 
> > ## Matthew S Farmer
> > 
> > [https://www.kaggle.com/competitions/llm-20-questions/discussion/512955#2884981](https://www.kaggle.com/competitions/llm-20-questions/discussion/512955#2884981)
> > 
> > 
> > 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãŠãŠã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚çŸ¥ã‚‰ãªã‹ã£ãŸã§ã™ï¼
> > 
> > 
> > 


---

> ## BK
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒå¤§å¥½ãã§ã™ :)
> 
> 


---

> ## Eslam Mohamed
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ï¼ã‚ãªãŸã®èª¬æ˜ã¯æœ€é«˜ã§ã™ã€‚
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã‚Œã‚’èã„ã¦å¬‰ã—ã„ã§ã™ï¼
> > 
> > 
> > 


---

> ## å¤æœˆæ–¹æº
> 
> ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ
> 
> 
> 


---

> ## å¤æœˆæ–¹æº
> 
> æœ€æ–°ã®3.1ã‚’æˆåŠŸè£ã«å®Ÿè¡Œã—ã¾ã—ãŸãŒã€æå‡ºå¾Œã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ç¶šã‘ã¾ã—ãŸ
> 
> 
> 


---

> ## Sandeep Sharma
> 
> ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚ã‚ŠãŒã¨ã†ã€‚ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€Œ1ã¤ã®ä½ç½®å¼•æ•° 'cfg' ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
> 
> 
> 


---

> ## Toshi
> 
> ç´ æ™´ã‚‰ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚
> 
> ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®pytorchã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã¹ãã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > [@mst923](https://www.kaggle.com/mst923) ã‚ãªãŸã®ãƒ‘ã‚½ã‚³ãƒ³ã§ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã„ã†æ„å‘³ã§ã™ã‹ï¼Ÿè‰¯ã„GPUãŒãªã„é™ã‚Šã€å‹•ä½œã—ãªã„ã§ã—ã‚‡ã†
> > 
> > 
> > 


---

> ## kothiwsk28
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«3ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆæ•°å­—èªè­˜ã€ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯ã€ãƒã‚¦ã‚¹ãƒ—ãƒ©ã‚¤ã‚¹ï¼‰ã‚’ä¿æŒã—ã¦ãŠãç‰¹åˆ¥ãªç†ç”±ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã„ã„ãˆã€å‰Šé™¤ã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¯ã€ç«¶æŠ€ã«ã‚„ã£ã¦ãã‚‹åˆå¿ƒè€…ã‚’åŠ©ã‘ã‚‹ãŸã‚ã«è¿½åŠ ã—ã¾ã—ãŸã€‚
> > 
> > 
> > 


---

> ## Mask
> 
> å½¹ã«ç«‹ã¤ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã­ã€‚
> 
> ç§ã¯Kaggleã«æ–°ã—ãã€ãƒ•ã‚©ãƒ¼ã‚¯ã—ãŸã‚Šã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã—ãŸã¨ãã«ã€å®Ÿéš›ã«æå‡ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ä»˜å±ã—ã¦ã„ã‚‹ä»–ã®ç«¶æŠ€ï¼ˆæ•°å­—èªè­˜è€…ã¨ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯ï¼‰ãŒã‚ã‚Šã€ãã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§Llamaã‚’ä½¿ç”¨ã—ã¦ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã¨ãã€ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ãŒæ­£ã—ããªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸãŒã€æ­£ã—ã„ã§ã™ï¼
> 
> ä½•ãŒé–“é•ã£ã¦ã„ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ï¼
> 
> ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ãªã—ã«æå‡ºã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿç§ã¯ã“ã“ã§ã¯æ–°ã—ã„ã®ã§ã€ä½¿ã„æ–¹ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã€‚
> 
> æå‡ºãƒœã‚¿ãƒ³ãŒãªã„ã®ã¯éå¸¸ã«å¥‡å¦™ã§ã€ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã«ã€æ­£ã—ããªã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ï¼
> 
> 
> > ## Maoshenli
> > 
> > ç§ã‚‚åŒã˜å•é¡Œã«ç›´é¢ã—ã¾ã—ãŸã€‚è§£æ±ºã—ã¾ã—ãŸã‹ï¼ŸğŸ˜„
> > 
> > 
> > 
> > ## jehlum
> > 
> > ãƒ¢ãƒ‡ãƒ«ã‚’å³å´ã®å…¥åŠ›ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¾ã—ãŸã‹ï¼Ÿ
> > 
> > 
> > 
> > ## kaoutarTopicè‘—è€…
> > 
> > çš†ã•ã‚“ã€llamaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æ¡ä»¶ã‚’å—ã‘å…¥ã‚Œã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã®å•é¡Œã‚’è§£æ±ºã—ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚Œã°ã€å³ä¸Šã®3ã¤ã®ç‚¹ã«è¡Œãã€ã€Œã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
> > 
> > 
> > 


---

> ## Lucas
> 
> ã‚³ãƒ¼ãƒ‰ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æå‡ºã—ã¾ã—ãŸãŒã€LBã§600ç‚¹ã—ã‹å¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚750ç‚¹ã‚’ç²å¾—ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼ŸLlama3 8bã‚’å¾®èª¿æ•´ã—ã¾ã—ãŸã‹ï¼Ÿ
> 
> 
> 
> > ## Krens
> > 
> > ã‚²ãƒ¼ãƒ ã‚’æå‡ºã—ãŸã¨ãã€åˆæœŸã‚¹ã‚³ã‚¢ã¯600ãƒã‚¤ãƒ³ãƒˆã§ã—ãŸã€‚ã‚¹ã‚³ã‚¢ã¯ä»–ã®å‚åŠ è€…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ã§ã®ã¿å¤‰å‹•ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€åˆ†æ•£ã¯æ¯”è¼ƒçš„å¤§ããã€ãã‚Œã»ã©å®‰å®šã—ã¦ã„ã¾ã›ã‚“ã€‚
> > 
> > 
> > 


---

> ## zerojin
> 
> ä½œæ¥­ã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚ä½¿ç”¨ã—ã¦ã„ã‚‹llama3ãƒ¢ãƒ‡ãƒ«ã¯å¾®èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ç§ã®ãƒ‡ãƒ¼ã‚¿ã§å¾®èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿç­”ãˆã¯ã„ã„ãˆã§ã™ã€‚Kaggleãƒãƒ–ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
> > 
> > 
> > 


---

> ## tingyu516
> 
> ã“ã‚“ã«ã¡ã¯ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æå‡ºã—ã¦ã€ŒValidation Episode failedã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ä½•ãŒèµ·ã“ã£ãŸã®ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
> > 
> > 
> > 


---

> ## Matthew S Farmer
> 
> ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ç«¶æŠ€ã®GPUä¸Šã§ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‰ãšã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ãã†ã§ã™ã­ã€ç§ã‚‚å¿ƒé…ã§ã—ãŸãŒã€ã†ã¾ãã„ãã¾ã—ãŸã€‚
> > 
> > 
> > 


---

> ## i_am_nothing
> 
> ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ã‚ã‚‹æ•°å­—èªè­˜è€…ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ
> 
> 
> > ## Chazzyie
> > 
> > 3ã¤ã®ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ•°å­—èªè­˜è€…ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤ã‚’é¸æŠã§ãã¾ã™ã€‚
> > 
> > 
> > 


---

> ## Eslam Mohamed
> 
> éå¸¸ã«å„ªã‚ŒãŸãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ï¼æ˜ç¢ºã•ã¨è©³ç´°ã®ãƒ¬ãƒ™ãƒ«ã¯æœ€é«˜ã§ã™ã€‚
> 
> 


---

> ## philipha2
> 
> ç§ã¯ã“ã®ç«¶æŠ€ã«å‚åŠ ã—ãŸã°ã‹ã‚Šã®åˆå¿ƒè€…ã§ã™ã€‚
> 
> è³ªå•ãŒåŸºæœ¬ã™ãã‚‹å ´åˆã¯ã”ã‚ã‚“ãªã•ã„ã€‚
> 
> ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’colabã§å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ãŒã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„æå‡ºã‚³ãƒ¼ãƒ‰ã®ãŸã‚ã«å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯Kaggleãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã—ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“ã‹ï¼Ÿ
> 
> 
> 
> > ## kaoutarTopicè‘—è€…
> > 
> > ã“ã‚“ã«ã¡ã¯ã€ã„ã„ãˆã€Google Colabã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€Google Colabã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯Huggingfaceã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€Kaggleç’°å¢ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
> > 
> > 
> > 
> > > ## philipha2
> > > 
> > > è¿”ä¿¡ã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
> > > 
> > > é€šå¸¸ã€ã‚ãªãŸã¯ã©ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ
> > > 
> > > Kaggleã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆGPUï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚è‡ªåˆ†ã®GPUã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿ
> > > 
> > > 
> > > ## kaoutarTopicè‘—è€…
> > > 
> > > ç§ã¯å€‹äººçš„ãªGPUã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚
> > > 
> > > 
> > > > ## Krens
> > > > 
> > > > > 
> > > > Kaggleã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã®æœ€åˆã®ã‚»ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Kaggleãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
> > > > 
> > > > 
---
```

** @@@ Jupyter Notebook numver 63, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦å•é¡Œã‚’è§£æ±ºã—ã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚€å•é¡Œ
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå›½ã‚„ç‰©ã®åå‰ãªã©ï¼‰ã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã‚’è‡ªå‹•åŒ–ã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è³ªå•ã‚’ç”Ÿæˆã—ãŸã‚Šã€ã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’ç”Ÿæˆã—ãŸã‚Šã€æœ€çµ‚çš„ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

### ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Transformers**: Hugging Faceã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€äº‹å‰è¨“ç·´æ¸ˆã¿ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆCausal Language Modelï¼‰ã‚’æ‰±ã„ã¾ã™ã€‚
- **Torch**: PyTorchã‚’ä½¿ç”¨ã—ã¦ã€GPUã‚’æ´»ç”¨ã—ã¤ã¤ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚
- **BitsAndBytes**: ãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã‚’è¡Œã„ã€8ãƒ“ãƒƒãƒˆã§ã®èª­ã¿è¾¼ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

### å®Ÿè£…å†…å®¹
1. **ç’°å¢ƒã®è¨­å®š**: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆtransformers, bitsandbytesï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚
2. **ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©**: äº‹å‰è¨“ç·´ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ç‰¹å®šã®GPUã«é…ç½®ã—ã¦ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’æœ€é©åŒ–ã—ã€é‡å­åŒ–ã®è¨­å®šã‚‚è¡Œã„ã¾ã™ã€‚
3. **è³ªå•ãŠã‚ˆã³å›ç­”ã®ç”Ÿæˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦ã€è³ªå•ã¨å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆaskerã€answererï¼‰ã‚’æŒã¤`Robot`ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
4. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯**: `agent`é–¢æ•°ã‚’é€šã˜ã¦ã€æ¨æ¸¬ã€è³ªå•ã€ãŠã‚ˆã³å›ç­”ã®ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†ã—ã¾ã™ã€‚ã‚‚ã—å¿œç­”ãŒä¸é©åˆ‡ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œyesã€ã‚’è¿”ã™ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
5. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æº–å‚™**: JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ãã®ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¾ã™ã€‚
6. **ã‚²ãƒ¼ãƒ ã®å®Ÿè¡Œ**: 20ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ãŸã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè³ªå•ã‚’ç”Ÿæˆã—ã€å›ç­”ã‚’å—ã‘å–ã£ã¦æ¨æ¸¬ã‚’è¡Œã†æ§˜å­ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’é€šã˜ã¦ã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€ç”Ÿæˆçš„ãªè³ªå•ã‚’é€šã˜ã¦åŠ¹ç‡çš„ã«æƒ…å ±ã‚’å¼•ãå‡ºã™ã“ã¨ãŒã§ãã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
%%bash
mkdir -p /kaggle/working/submission
pip install bitsandbytes accelerate
pip install -U transformers
```

---The following area is a Code cell (cell numver is 2)---
```python
%%writefile -a submission/main.py

import os
import torch
import re
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig, AutoConfig

torch.backends.cuda.enable_mem_efficient_sdp(False)

KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    model_id = os.path.join(KAGGLE_AGENT_PATH, "model")
#else:
model_id = "/kaggle/input/gemma/transformers/7b-it/3"

# å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã©ã®GPUã«é…ç½®ã™ã‚‹ã‹ã‚’ç¤ºã™ãƒãƒƒãƒ”ãƒ³ã‚°
device_maps = [('model.layers.0', 0),
 ('model.layers.1', 0),
 ('model.layers.2', 0),
 ('model.layers.3', 0),
 ('model.layers.4', 0),
 ('model.layers.5', 0),
 ('model.layers.6', 0),
 ('model.layers.7', 0),
 ('model.layers.8', 0),
 ('model.layers.9', 0),
 ('model.layers.10', 0),
 ('model.layers.11', 0),
 ('model.layers.12', 0),
 ('model.layers.13', 0),
 ('model.layers.14', 0),
 ('model.layers.15', 0),
 ('model.layers.16', 0),
 ('model.layers.17', 0),
 ('model.layers.18', 0),
 ('model.layers.19', 1),
 ('model.layers.20', 1),
 ('model.layers.21', 1),
 ('model.layers.22', 1),
 ('model.layers.23', 1),
 ('model.layers.24', 1),
 ('model.layers.25', 1),
 ('model.layers.26', 1),
 ('model.layers.27', 1),
 ('model.layers.28', 1),
 ('model.layers.29', 1),
 ('model.layers.30', 1),
 ('model.layers.31', 1),
 ('model.layers.32', 1),
 ('model.layers.33', 1),
 ('model.layers.34', 1),
 ('model.layers.35', 1),
 ('model.layers.36', 1),
 ('model.layers.37', 1),
 ('model.layers.38', 1),
 ('model.layers.39', 1),
 ('model.layers.40', 1),
 ('model.layers.41', 1),
 ('model.embed_tokens', 1),
 ('model.layers', 1)]

quantization_config = BitsAndBytesConfig(load_in_8bit=True)
tokenizer = AutoTokenizer.from_pretrained("/kaggle/input/gemma/transformers/7b-it/3") 
id_eot = tokenizer.convert_tokens_to_ids(["<eos>"])[0]

# å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é…ç½®ã™ã‚‹GPUã‚’è¾æ›¸å½¢å¼ã§å®šç¾©
device = {layer:gpu_mem for (layer,gpu_mem) in device_maps}
config = AutoConfig.from_pretrained("/kaggle/input/gemma/transformers/7b-it/3")
config.gradient_checkpointing = True
# ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿
model = AutoModelForCausalLM.from_pretrained("/kaggle/input/gemma/transformers/7b-it/3", torch_dtype="auto", quantization_config=quantization_config,
                                             device_map="auto", trust_remote_code=True, config=config)

# å›ç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
def generate_answer(template):
    input_ids = tokenizer(template, return_tensors="pt").to("cuda")
    output_ids = model.generate(**input_ids, max_new_tokens=15).squeeze()
    start_gen = input_ids.input_ids.shape[1]
    output_ids = output_ids[start_gen:]
    if id_eot in output_ids:  # å‡ºåŠ›ã«çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        stop = output_ids.tolist().index(id_eot)  # çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½ç½®ã‚’å–å¾—
        output = tokenizer.decode(output_ids[:stop])  # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦å‡ºåŠ›ã‚’å–å¾—
    else:
        output = tokenizer.decode(output_ids)  # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãã®ã¾ã¾ãƒ‡ã‚³ãƒ¼ãƒ‰
    output = re.sub('\n', '', output)  # æ”¹è¡Œã‚’å‰Šé™¤
    output = re.sub(' <end_of_turn>', '', output)  # ç‰¹å®šã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
    output = re.sub('<end_of_turn>', '', output)  # ç‰¹å®šã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
    return output

class Robot:
    def __init__(self):
        pass
    
    def on(self, mode, obs):
        # ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œ
        assert mode in ["asking", "guessing", "answering"], "mode can only take one of these values: asking, answering, guessing"
        if mode == "asking":
            output = self.asker(obs)
        if mode == "answering":
            output = self.answerer(obs)
            if "yes" in output.lower() or "Yes" in output.lower():  # å‡ºåŠ›ãŒã€Œyesã€ã®å ´åˆ
                output = "yes"
            elif "no" in output.lower() or "No" in output.lower():  # å‡ºåŠ›ãŒã€Œnoã€ã®å ´åˆ
                output = "no"
            else:
                output = "yes"  # ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œyesã€
        if mode == "guessing":
            output = self.asker(obs)  # ãƒ¢ãƒ¼ãƒ‰ãŒã€Œguessingã€ã®å ´åˆ
        return output

    # è³ªå•è€…ã®å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
    def asker(self, obs):
        sys_prompt = """
        ã‚ãªãŸã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å›½ã§ã™ã€‚
        """
        if obs.turnType == "ask":  # è³ªå•ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
            ask_prompt = sys_prompt + """
            20ã®è³ªå•ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã¯è³ªå•è€…ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
            ã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã ã¨ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«é€²è¡Œã—ã¾ã™:
            ä¾‹:
            <ã‚ãªãŸ: ãã‚Œã¯å›½ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã„ã„ãˆ
            ã‚ãªãŸ: ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãã“ã«ä½ã‚“ã§ã„ã‚‹äººã®ã»ã¨ã‚“ã©ã¯è‚Œã®è‰²ãŒæš—ã„ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã„ã„ãˆ
            ã‚ãªãŸ: åå‰ãŒmã§å§‹ã¾ã‚‹å›½ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„
            ã‚ãªãŸ: ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã¯ã„ã€‚>
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå˜èªã‚’é¸ã³ã¾ã—ãŸã€ã‚ãªãŸã®æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ï¼
            çŸ­ãã€å†—é•·ã«ãªã‚‰ãšä¸€ã¤ã®è³ªå•ã ã‘ã‚’ã—ã¦ãã ã•ã„ã€ä½™åˆ†ãªè¨€è‘‰ã¯ã„ã‚Šã¾ã›ã‚“ï¼
            """
        
            chat_template = f"""<start_of_turn>system\n{ask_prompt}<end_of_turn>\n"""
            chat_template += "<start_of_turn>model\n"

            if len(obs.questions)>=1:  # ä»¥å‰ã®è³ªå•ãŒã‚ã‚‹å ´åˆ
                for q, a in zip(obs.questions, obs.answers):
                    chat_template += f"{q}<end_of_turn>\n<start_of_turn>user\n"
                    chat_template += f"{a}<end_of_turn>\n<start_of_turn>model\n"
        
        elif obs.turnType == "guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
            conv = ""
            for q, a in zip(obs.questions, obs.answers):
                conv += f"""è³ªå•: {q}\nç­”ãˆ: {a}\n"""
            guess_prompt =  sys_prompt + f"""
            ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™:\n{conv}
            ã“ã®ä¼šè©±ã«åŸºã¥ã„ã¦ã€å˜èªã‚’æ¨æ¸¬ã§ãã¾ã™ã‹ã€å˜èªã ã‘ã‚’å›ç­”ã—ã¦ãã ã•ã„ã€ä½™è¨ˆãªã“ã¨ã¯ã„ã‚Šã¾ã›ã‚“ã€‚
            """
            chat_template = f"""<start_of_turn>system\n{guess_prompt}<end_of_turn>\n"""
            chat_template += "<start_of_turn>model\n"

        output = generate_answer(chat_template)        
        return output
    
    # å›ç­”è€…ã®å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
    def answerer(self, obs):
        sys_prompt = f"""
        ã‚ãªãŸã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ 
        ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è€ƒãˆã€è³ªå•è€…ãŒã¯ã„ãƒ»ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®å ´æ‰€ã‚„ç‰©ã§ã™ã€‚\n
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ç†è§£ã—ã€ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠŠæ¡ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        ç¾åœ¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨æ¸¬ã™ã¹ãå˜èªã¯ï¼šã€Œ{obs.keyword}ã€ã€ã‚«ãƒ†ã‚´ãƒªã¯ã€Œ{obs.category}ã€ã§ã™ã€‚
        ã‚‚ã—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ¢ãƒ­ãƒƒã‚³ã§ã‚«ãƒ†ã‚´ãƒªãŒã€Œå ´æ‰€ã€ã®å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«é€²è¡Œã—ã¾ã™:
        ä¾‹:
        <ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã“ã«ä½ã‚“ã§ã„ã‚‹äººã®ã»ã¨ã‚“ã©ã¯è‚Œã®è‰²ãŒæš—ã„ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã„ã„ãˆ
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: åå‰ãŒmã§å§‹ã¾ã‚‹å›½ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„
        ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¢ãƒ­ãƒƒã‚³ã§ã™ã‹ï¼Ÿ
        ã‚ãªãŸ: ã¯ã„ã€‚>
        """
        chat_template = f"""<start_of_turn>system\n{sys_prompt}<end_of_turn>\n"""
        chat_template += "<start_of_turn>user\n"
        chat_template += f"{obs.questions[0]}"
        chat_template += "<start_of_turn>model\n"
        if len(obs.answers)>=1:  # ä»¥å‰ã®å›ç­”ãŒã‚ã‚‹å ´åˆ
            for q, a in zip(obs.questions[1:], obs.answers):
                chat_template += f"{q}<end_of_turn>\n<start_of_turn>user\n"
                chat_template += f"{a}<end_of_turn>\n<start_of_turn>model\n"
        output = generate_answer(chat_template)
        return output

robot = Robot()

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
def agent(obs, cfg):
    
    if obs.turnType == "ask":  # è³ªå•ã‚’ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        response = robot.on(mode = "asking", obs = obs)
        
    elif obs.turnType == "guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        response = robot.on(mode = "guessing", obs = obs)
        
    elif obs.turnType == "answer":  # ç­”ãˆã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        response = robot.on(mode = "answering", obs = obs)
        
    if response == None or len(response)<=1:  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã¾ãŸã¯çŸ­ã„å ´åˆ
        response = "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œyesã€ã‚’è¿”ã™
        
    return response
```

---The following area is a Code cell (cell numver is 3)---
```python
def simple_agent1(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬å½¹ã§ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ãŒã€Œaskã€ã®å ´åˆ
    if obs.turnType == "ask":
        response_list = [
            'ã‚¢ãƒ•ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã‚¢ãƒ¡ãƒªã‚«ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã‚¢ã‚¸ã‚¢ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã‚ªã‚»ã‚¢ãƒ‹ã‚¢ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'æ±ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'åŒ—ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'å—ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'è¥¿ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'æ—¥æœ¬ã§ã™ã‹ï¼Ÿ'
        ]
#         response = response_list[len(obs.questions)]
        response = random.choice(response_list)  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
    elif obs.turnType == "guess":  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        response = "duck"  # å›ºå®šã§ã€Œduckã€ã‚’è¿”ã™
    elif obs.turnType == "answer":  # ç­”ãˆã‚‹ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        response = random.choices(["yes", "no"])[0]  # ã€Œyesã€ã¾ãŸã¯ã€Œnoã€ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
    return response
```

---The following area is a Code cell (cell numver is 4)---
```python
#!apt install pigz pv > /dev/null
```

---The following area is a Code cell (cell numver is 5)---
```python
#!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/transformers/2b-it/2
```

---The following area is a Code cell (cell numver is 6)---
```python
#%%time

#import random
#from kaggle_environments import make
#agent = "/kaggle/working/submission/main.py"
#env = make("llm_20_questions", debug=True)
#game_output = env.run(agents=[agent, simple_agent1, simple_agent1, simple_agent1])
```

---The following area is a Code cell (cell numver is 7)---
```python
#env.render(mode="ipython", width=600, height=500)
```

---The following area is a Code cell (cell numver is 8)---
```python
!wget -O keywords_local.py https://raw.githubusercontent.com/Kaggle/kaggle-environments/master/kaggle_environments/envs/llm_20_questions/keywords.py
```

---The following area is a Code cell (cell numver is 9)---
```python
import json
import pandas as pd
from submission.main import agent
from keywords_local import KEYWORDS_JSON

class Observation:
    def __init__(self):
        self.step = 0
        self.role = "guesser"
        self.turnType = "ask"
        self.keyword = "Japan"
        self.category = "country"
        self.questions = []
        self.answers = []
        self.guesses = []
        
def create_keyword_df(KEYWORDS_JSON):
    json_data = json.loads(KEYWORDS_JSON)  # JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿

    keyword_list = []
    category_list = []
    alts_list = []

    for i in range(len(json_data)):
        for j in range(len(json_data[i]['words'])):
            keyword = json_data[i]['words'][j]['keyword']
            keyword_list.append(keyword)
            category_list.append(json_data[i]['category'])
            alts_list.append(json_data[i]['words'][j]['alts'])  # ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚‚è¿½åŠ 

    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
    data_pd = pd.DataFrame(columns=['keyword', 'category', 'alts'])
    data_pd['keyword'] = keyword_list  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    data_pd['category'] = category_list  # ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
    data_pd['alts'] = alts_list  # ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    
    return data_pd
    
keywords_df = create_keyword_df(KEYWORDS_JSON)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 10)---
```python
obs = Observation()  # è¦³å¯Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
cfg = "_"

sample_df = keywords_df.sample()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’æŠ½å‡º
obs.keyword = sample_df["keyword"].values[0]  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
obs.category = sample_df["category"].values[0]  # ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
alts_list = sample_df["alts"].values[0]  # ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
alts_list.append(obs.keyword)  # ä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«é¸ã°ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 

print(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {obs.keyword}")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º

for round in range(20):  # ã‚²ãƒ¼ãƒ ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’20ã¾ã§ç¹°ã‚Šè¿”ã™
    obs.step = round + 1  # ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¨­å®š
    
    obs.role = "guesser"  # æ¨æ¸¬å½¹ã®è¨­å®š
    obs.turnType = "ask"  # è³ªå•ã™ã‚‹ã‚¿ãƒ¼ãƒ³
    question = agent(obs, cfg)  # è³ªå•ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡
    obs.questions.append(question)  # è³ªå•ã‚’è¨˜éŒ²
    
    obs.role = "answerer"  # ç­”ãˆã‚‹å½¹ã®è¨­å®š
    obs.turnType = "answer"  # ç­”ãˆã‚‹ã‚¿ãƒ¼ãƒ³
    answer = agent(obs, cfg)  # ç­”ãˆã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡
    obs.answers.append(answer)  # ç­”ãˆã‚’è¨˜éŒ²
    
    obs.role = "guesser"  # æ¨æ¸¬å½¹ã®è¨­å®š
    obs.turnType = "guess"  # æ¨æ¸¬ã™ã‚‹ã‚¿ãƒ¼ãƒ³
    guess = agent(obs, cfg)  # æ¨æ¸¬ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡
    obs.guesses.append(guess)  # æ¨æ¸¬ã‚’è¨˜éŒ²
    
    print(f"ãƒ©ã‚¦ãƒ³ãƒ‰: {round + 1}")  # ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’è¡¨ç¤º
    print(f"è³ªå•: {question}")  # è³ªå•ã‚’è¡¨ç¤º
    print(f"ç­”ãˆ: {answer}")  # ç­”ãˆã‚’è¡¨ç¤º
    print(f"æ¨æ¸¬: {guess}")  # æ¨æ¸¬ã‚’è¡¨ç¤º
    
    if guess in alts_list:  # æ¨æ¸¬ãŒä»£æ›¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
        print("å‹åˆ©!!")  # å‹åˆ©ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        break
```

** @@@ Jupyter Notebook numver 64, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã„ã¦ã€Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚åˆå¿ƒè€…å‘ã‘ã«ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§Gemmaã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ä½¿ç”¨æ–¹æ³•ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
æœ¬ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Gemmaãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®æº–å‚™ä½œæ¥­ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ€ã„ã¤ãã€è³ªå•è€…ãŒã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§è³ªå•ã‚’ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹å½¢å¼ã§ã™ã€‚Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ãªæ¨è«–ã‚„æˆ¦ç•¥çš„ãªè³ªå•ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨æ‰‹æ³•
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ä»¥ä¸‹ã®ä¸»è¦ãªæ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼š
1. **Gemmaãƒ¢ãƒ‡ãƒ«ã®é¸å®šã¨è¨­å®š**: Gemmaãƒ¢ãƒ‡ãƒ«ã¯ã€`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦è¨­å®šã•ã‚Œã€ç‰¹å®šã®ãƒãƒªã‚¢ãƒ³ãƒˆï¼ˆä¾‹ãˆã°ã€2bã‚„7bï¼‰ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

2. **ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ`immutabledict`ã‚„`sentencepiece`ãªã©ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Gemmaã®PyTorchå®Ÿè£…ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚

3. **ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®è¨­å®š**: PyTorchã¨Gemmaã®ã‚³ãƒ³ãƒ•ã‚£ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸè¨­å®šï¼ˆãƒ‡ãƒã‚¤ã‚¹ã‚„ãƒ¢ãƒ‡ãƒ«ãƒãƒªã‚¢ãƒ³ãƒˆãªã©ï¼‰ã«å¾“ã£ã¦ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

4. **è³ªå•å¿œç­”ï¼ˆQAï¼‰æ©Ÿèƒ½ã®å®Ÿè£…**: `generate`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦è³ªå•ã‚’é€ä¿¡ã—ã€ãã®å›ç­”ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ï¼ˆæŒ‡ç¤ºãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€ç‰¹ã«ã€Œ20ã®è³ªå•ã‚²ãƒ¼ãƒ ã€ã‚’æ„è­˜ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ„ãƒ¼ãƒ«
- **PyTorch**: æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†ãŸã‚ã®ä¸»ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
- **Gemma**: è³ªå•å¿œç­”ã‚„è‡ªç„¶è¨€èªå‡¦ç†ã‚¿ã‚¹ã‚¯ã«åˆ©ç”¨ã•ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«ã€‚
- **Git**: Gemmaã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Gemmaã‚’ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®å…¥é–€è³‡æ–™ã¨ã—ã¦éå¸¸ã«æœ‰ç”¨ã§ã‚ã‚Šã€èª­ã¿æ‰‹ãŒGemmaã®å°å…¥ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®æ´»ç”¨ã¾ã§ã®éç¨‹ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggleã§Gemmaã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«æ–°ã—ã„æ–¹ã®ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚  
æ‰‹é †ã«å¾“ã£ã¦ã€ä½¿ã„æ–¹ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

**è¬è¾**  
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€[LLM 20 Questions Starter Notebook](https://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebook)ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚

å§‹ã‚ã‚‹å‰ã«ã€GPUã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

<img width="400px" src=attachment:9319be98-0139-41f9-a741-6b606b7cadc6.png>

---

## Gemmaãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 

1. `+ Add Input`ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
<img src=attachment:6dabe5ed-9e7e-437b-be73-ee0c3b3a2afe.png width="400">

2. `Gemma`ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
<img src=attachment:68d9d1fa-84f4-4c37-acf9-f5cb2b825fcb.png width="400">

3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚ (*2b-it*ã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒã€*7b*ã¯ãƒ†ã‚¹ãƒˆã‚’æ—©ãå®Ÿè¡Œã™ã‚‹ã«ã¯é…ã™ãã‚‹ãŸã‚)
<img src=attachment:c7f1744e-08df-4ba7-ab61-4b0cd4e4e6fd.png width="400">

4. ãƒ¢ãƒ‡ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸã®ã‚’ç¢ºèªã§ãã¾ã™ã€‚
<img src=attachment:056f294d-eee3-4bbb-b68b-6bc991a9c746.png width="400">
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
# å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/kaggle/input` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
tree /kaggle/input/gemma/pytorch
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
# Gemmaã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®š

Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã„ãã¤ã‹ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

## ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

---The following area is a Code cell (cell numver is 4)---
```python
%%bash
# `/kaggle/working/submission/lib` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Python ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
mkdir -p /kaggle/working/submission/lib
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece

# `gemma_pytorch`ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãã‚Œã‚’ `/kaggle/working/submission/lib` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™ã€‚
cd /kaggle/working
git clone https://github.com/google/gemma_pytorch.git > /dev/null
mkdir /kaggle/working/submission/lib/gemma/
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Code cell (cell numver is 5)---
```python
%%bash
# çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚
tree /kaggle/working/submission/lib
```

---The following area is a Code cell (cell numver is 6)---
```python
import sys

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€`/kaggle/working/submission/lib` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚
sys.path.insert(0, "/kaggle/working/submission/lib")
```

---The following area is a Markdown cell (cell numver is 7)---
```markdown
## Gemmaãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
```

---The following area is a Code cell (cell numver is 8)---
```python
import torch
from gemma.config import get_config_for_7b, get_config_for_2b
from gemma.model import GemmaForCausalLM

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
DEVICE = "cuda:0" if torch.cuda.is_available() else "cpu"  # ä½¿ç”¨å¯èƒ½ãªGPUã‚’ãƒã‚§ãƒƒã‚¯
VARIANT = "2b-it"
# VARIANT = "7b-it-quant"
WEIGHTS_PATH = f"/kaggle/input/gemma/pytorch/{VARIANT}/2" # å…¥åŠ›ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹

print("ç¾åœ¨ã®ãƒ‡ãƒã‚¤ã‚¹ã¯", DEVICE)
print("ç¾åœ¨ã®Gemmaãƒ¢ãƒ‡ãƒ«ã®ãƒãƒªã‚¢ãƒ³ãƒˆã¯", VARIANT)
```

---The following area is a Code cell (cell numver is 9)---
```python
# ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’è¡Œã„ã¾ã™
def get_model_config(variant):
    if "2b" in variant:
        return get_config_for_2b()  # 2bãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’å–å¾—
    if "7b" in variant:
        return get_config_for_7b()  # 7bãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’å–å¾—
    raise ValueError(f"ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒãƒªã‚¢ãƒ³ãƒˆ - {variant}")
model_config = get_model_config(VARIANT)  # æŒ‡å®šã•ã‚ŒãŸãƒãƒªã‚¢ãƒ³ãƒˆã®è¨­å®šã‚’å–å¾—
model_config.tokenizer = f"{WEIGHTS_PATH}/tokenizer.model"  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
model_config.quant = "quant" in VARIANT  # ãƒãƒªã‚¢ãƒ³ãƒˆã«"quant"ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
torch.set_default_dtype(model_config.get_dtype())  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®š

# Gemmaãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€
gemma_model = GemmaForCausalLM(model_config)  # Causal LMãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
gemma_model.load_weights(f"{WEIGHTS_PATH}/gemma-{VARIANT}.ckpt")  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
gemma_model = gemma_model.to(DEVICE).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
```

---The following area is a Markdown cell (cell numver is 10)---
```markdown
## Gemmaã®ä½¿ç”¨

### ã‚·ãƒ³ãƒ—ãƒ«ãªQA

`generate`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 11)---
```python
prompt = "ä½¿ã„æ–¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"

model_answer = gemma_model.generate(
    prompts=prompt,
    device=torch.device(DEVICE),
    output_len=100, # æœ€å¤§å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    temperature=0.01,
    top_p=0.1,
    top_k=1,
)

print(model_answer)  # ãƒ¢ãƒ‡ãƒ«ã®å›ç­”ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 12)---
```markdown
### æŒ‡ç¤ºãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹QA

æŒ‡ç¤ºãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚  
è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Starter Notebook](https://www.kaggle.com/code/ryanholbrook/llm-20-questions-starter-notebook)ã®`GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

å‚è€ƒ: https://ai.google.dev/gemma/docs/formatting
```

---The following area is a Code cell (cell numver is 13)---
```python
system_prompt = "ã‚ãªãŸã¯20è³ªå•ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€å›ç­”è€…ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ€ã„ã¤ãã€è³ªå•è€…ãŒã¯ã„ã¾ãŸã¯ã„ã„ãˆã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç‰¹å®šã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚"

prompt = "<start_of_turn>user\n" # GemmaFormatter.user
prompt += f"{system_prompt}<end_of_turn>\n"  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
prompt += "<start_of_turn>model\n" # GemmaFormatter.start_model_turn

print(prompt)  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºåŠ›
```

---The following area is a Code cell (cell numver is 14)---
```python
model_answer = gemma_model.generate(
    prompts=prompt,
    device=torch.device(DEVICE),
    output_len=100, # æœ€å¤§å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    temperature=0.01,
    top_p=0.1,
    top_k=1,
)

print(model_answer)  # ãƒ¢ãƒ‡ãƒ«ã®å›ç­”ã‚’å‡ºåŠ›
```

---The following area is a Markdown cell (cell numver is 15)---
```markdown
---

ã“ã‚Œã§ã€Gemmaãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒç†è§£ã§ããŸã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚  
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã‚ˆã†ã«ã€‚
```

** @@@ Jupyter Notebook numver 65, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€æœ€çµ‚çš„ã« `submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å•é¡Œã¨ç›®çš„
ã€ŒLLM 20 Questionsã€ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³ªå•ã‚’é€šã˜ã¦ç‰¹å®šã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã€åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ä¾å­˜é–¢ä¿‚**: 
  - `immutabledict` ã‚„ `sentencepiece` ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¾ã™ã€‚

- **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã¨åˆæœŸåŒ–**: 
  - ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«ã¯Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€ç‰¹ã«`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯7BãŠã‚ˆã³2Bã®ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æŒ‡å®šã—ãŸãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«é¸æŠã—ã¦ã„ã¾ã™ã€‚

- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: 
  - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹**: 
  - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’ãã‚Œãã‚Œæ‹…å½“ã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯å†…éƒ¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦æ­£ã—ã„è³ªå•ã‚„ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### å‡ºåŠ›
æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚ã“ã®æˆæœç‰©ã«ã¯ã€ã™ã¹ã¦ã®å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒå”èª¿ãƒ—ãƒ¬ã‚¤ã«åŸºã¥ã„ãŸæ¨ç†ã‚’è¡Œã†ãŸã‚ã®å‡ºç™ºç‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚å‚åŠ è€…ã¯ã“ã®åŸºç›¤ã‚’å…ƒã«ã€è‡ªã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚„æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã•ã‚‰ã«æ”¹å–„ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions** ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã® **Submit to competition** è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ *Output* ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz` ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹ **Submit Agent** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/  # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # KAGGLE_AGENT_PATHã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # æŒ‡å®šã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆ¥ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b  # gemmaãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
from gemma.model import GemmaForCausalLM  # gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")  # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"  # ä»–ã®ãƒ‘ã‚¹ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

class GemmaFormatter:
    _start_token = '<start_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        self._few_shot_examples = few_shot_examples  # Few-shotä¾‹ã®ä¿å­˜
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self.reset()  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¿½åŠ 
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotä¾‹ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œé †åºã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †åºã‚’å¾ªç’°ã•ã›ã‚‹
        for fmt, turn in zip(formatters, turns):  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã¨ã‚¿ãƒ¼ãƒ³ã‚’çµåˆ
            fmt(turn)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å¤‰æ›´
    yield
    torch.set_default_dtype(torch.float)  # å…ƒã®dtypeã«æˆ»ã™

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
        self._device = torch.device(device)  # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant  # é‡å­åŒ–è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')  # é‡ã¿ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å¿œç­”ã‚’å¾—ã‚‹
        response = self._parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
        print(f"{response=}")  # å¿œç­”ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                'top_p': 0.1,  # ãƒˆãƒƒãƒ—ç¢ºç‡
                'top_k': 1,  # ãƒˆãƒƒãƒ—Kã®è¨­å®š
        }
        response = self.model.generate(  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            prompt,
            device=self._device,
            output_len=max_new_tokens,  # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,  # ãã®ä»–ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        else:
            keyword = match.group().lower()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–


def interleave_unequal(x, y):
    return [  # ä¸å‡ä¸€ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")  # è³ªå•ã™ã‚‹ã‚ˆã†æŒ‡ç¤º
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰äºˆæƒ³ã®æŒ‡ç¤º
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "Is it a person?"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•
            else:
                question = match.group()  # æŠ½å‡ºã—ãŸè³ªå•
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®äºˆæƒ³ã‚’è§£æ
            return guess
        else:
            raise ValueError("Unknown turn type:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='user')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")  # å›ç­”æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # å›ç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no'  # "yes"ã§ã‚ã‚Œã°yesã€ãã®ä»–ã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "You are an AI assistant designed to play the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š

few_shot_examples = [  # Few-shotä¾‹ã®è¨­å®š
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆOut of Memoryï¼‰ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "Agent not initialized."  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    return agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™

def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    if response is None or len(response) <= 1:  # å¿œç­”ãŒç©ºã‹é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆ
        return "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response  # é€šå¸¸ã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2  # submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Samar Elhissi
> 
> ä¾‹ã‚’ã‚ã‚ŠãŒã¨ã†ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„â€¦ã“ã®LLMã¯å¤šãã®è¨ˆç®—ã‚’å¿…è¦ã¨ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯å¼·åŠ›ãªGPUãŒå¿…è¦ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã€ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚
> > 
> > 

---

> ## Michael Kamal 92
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€few_shot_examplesã«ã¤ã„ã¦è³ªå•ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> > ä¾‹ãˆã°ã€( 'is it place?', 'yes-or-no' )ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€ãã‚Œã¨ã‚‚( 'is it place?', 'yes', ) ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'Now guess the keyword' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'no', 'Now guess the keyword', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿã©ã‚ŒãŒæ­£ã—ã„è³ªå•ã€å›ç­”ã€äºˆæ¸¬ã®ä½œã‚Šæ–¹ã§ã™ã‹ï¼Ÿ
> 
> ã‚‚ã†ä¸€ã¤ã®è³ªå•ã§ã™ãŒã€Gemmaã¯few_shot_examplesã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ

---

> ## Yukky_2801
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«å¤±æ•—ã—ãŸã¨çµ‚äº†ã—ã¾ã™ã€‚
> 
> submission.tar.gzã‚’ã‚¨ãƒ©ãƒ¼ã¨å…±ã«æå‡ºã§ãã¾ã›ã‚“ã€‚ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è§£æ±ºç­–ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

> ## Andres H. Zapke
> > ã‚‚ã¡ã‚ã‚“ã€Œgemma/pytorch/7b-it-quant/2ã€ã“ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å³å´ã‚’è¦‹ã¦ã€gemmaãƒ¢ãƒ‡ãƒ«ãŒãã“ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
>   
> > ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add Inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)
> > 
> > 
> > > ## Talal Mufti
> > > > ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸå¾Œã€ä¾ç„¶ã¨ã—ã¦å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€bashã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã€ã“ã‚ŒãŒç§ã«ã¨ã£ã¦ã†ã¾ãã„ãã¾ã—ãŸï¼š
> > > > !tar --use-compress-program='pigz --fast --recursive | pv' -f submission.tar.gz -c /kaggle/working/submission . -c /kaggle/input/gemma/pytorch/7b-it-quant/2

---

> ## Muhammad Hadi13
> 
> ãªãœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã«ã€å¸¸ã«1.35MBä»¥ä¸Šã®å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãšã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¤±æ•—ã™ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Ryanã®å‡ºåŠ›ã¯ç´„7GBã§ã—ãŸã€‚ã“ã®ä»¶ã«ã¤ã„ã¦åŠ©ã‘ãŒå¿…è¦ã§ã™ï¼ï¼
> 
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> > tar: gemma/pytorch: Cannot stat: No such file or directory
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸã€‚

> ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’äº‹å‰ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > > 
> > > ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)

---

> ## Ship of Theseus
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community
> 
> 

---

> ## shiv_314
> 
> çš†ã•ã‚“ï¼ä¸€ã¤åŠ©ã‘ãŒå¿…è¦ã§ã™ã€‚gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
> 
> Pythonã®ãŸã‚ã«ã™ã§ã«æ­£ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼

---

> ## dedq
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community

---

> ## Code Hacker
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«tar.gzã‚’æå‡ºã—ã‚ˆã†ã¨ã—ãŸãŒã€å¤±æ•—ã—ã¾ã—ãŸâ€¦

> ## Code Hacker
> > > ã“ã®ãƒ¢ãƒ‡ãƒ«ã«åŒæ„ã—ãªã‹ã£ãŸã€‚ä¸‹ã®èµ¤ã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯â€¦

---

> ## JAPerez
> 
> Great work Ryan!

---

> ## philipha2
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã“ã®ã‚³ãƒ³ãƒšã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚
> æå‡ºç‰©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹submission.tar.gzã‚’ã©ã“ã«ç½®ã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ 
> Submit agentsãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æå‡ºã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ 
> æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
> åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kanchan Maurya
> > > Submit agentsã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã€åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---

> ## vj4science
> 
> Thanks Ryan - this is a good head start to the competition! much appreciated!

---

> ## gb_kwon
> 
> Thank you so much for your COOL guidelines!

---

> ## Andres H. Zapke
> 
> main.pyã§ã€gemma_pytorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼šfrom gemma.configã€‚
> 
> ã“ã‚Œã¯ç§ã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ãŒã€gemmaã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ã€‚
> 
> è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®gemmaãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã®ã¨ã€Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã‚’è©¦ã¿ã¾ã—ãŸãŒã€‚ä½•ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

> ## Duy Thai
> 
> ã“ã‚“ã«ã¡ã¯[@ryanholbrook](https://www.kaggle.com/ryanholbrook)ã€ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è©¦ã—ãŸã¨ã“ã‚ã€ã€Œæ·»ä»˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è¿½åŠ ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ã¯Modelãƒ‘ãƒãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã«ã¤ã„ã¦ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸã¨ãã€ç§ã¯ã“ã‚Œã ã‘ã‚’è¦‹ã¦ã„ã¾ã™ï¼š

> ## Andres H. Zapke
> > > "Models"ã¸è¡Œãã€Gemmaã‚’æ¤œç´¢ã—ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

> ## Duy Thai
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---

> ## Kai_Huang
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã® !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2 ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã¨ãã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸ
> 
> ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kai_Huang
> > > ã‚ã‚ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å…¥åŠ›ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã™ã­ğŸ˜±

> ## D Prince Armand KOUMI
> > > ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆã¯ã€è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

> ## Qusay AL-Btoush
> 
> ã¨ã¦ã‚‚è‰¯ã„ã€Ryan 

---
```

** @@@ Jupyter Notebook numver 66, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€ŒLLM 20 Questionsã€ã«ãŠã‘ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€20ã®è³ªå•ã‚²ãƒ¼ãƒ ã‚’åŠ¹æœçš„ã«ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã®è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€æœ€çµ‚çš„ã« `submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å•é¡Œã¨ç›®çš„
ã€ŒLLM 20 Questionsã€ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³ªå•ã‚’é€šã˜ã¦ç‰¹å®šã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’æŒã¤AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é–‹ç™ºã—ã€åŠ¹ç‡çš„ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¨æ¸¬ã™ã‚‹èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ä¾å­˜é–¢ä¿‚**: 
  - `immutabledict` ã‚„ `sentencepiece` ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™ã€‚
  - GitHubã‹ã‚‰`gemma_pytorch`ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¾ã™ã€‚

- **ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã¨åˆæœŸåŒ–**: 
  - ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«ã¯Gemmaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€ç‰¹ã«`GemmaForCausalLM`ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯7BãŠã‚ˆã³2Bã®ãƒ¢ãƒ‡ãƒ«è¨­å®šãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æŒ‡å®šã—ãŸãƒãƒªã‚¢ãƒ³ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«é¸æŠã—ã¦ã„ã¾ã™ã€‚

- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿**: 
  - `GemmaFormatter`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ã€ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ãŸã‚ã®æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹**: 
  - `GemmaQuestionerAgent`ã¨`GemmaAnswererAgent`ã¨ã„ã†2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã€è³ªå•è€…ã¨å›ç­”è€…ã®å½¹å‰²ã‚’ãã‚Œãã‚Œæ‹…å½“ã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã¯å†…éƒ¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã®å¿œç­”ã‚’è§£æã—ã¦æ­£ã—ã„è³ªå•ã‚„ç­”ãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### å‡ºåŠ›
æœ€çµ‚çš„ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯`submission.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«æå‡ºã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚ã“ã®æˆæœç‰©ã«ã¯ã€ã™ã¹ã¦ã®å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€è¨€èªãƒ¢ãƒ‡ãƒ«ãŒå”èª¿ãƒ—ãƒ¬ã‚¤ã«åŸºã¥ã„ãŸæ¨ç†ã‚’è¡Œã†ãŸã‚ã®å‡ºç™ºç‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚å‚åŠ è€…ã¯ã“ã®åŸºç›¤ã‚’å…ƒã«ã€è‡ªã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã‚„æˆ¦ç•¥ã‚’å®Ÿè£…ã—ã€ã•ã‚‰ã«æ”¹å–„ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€**LLM 20 Questions** ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`submission.tar.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å³å´ã® **Submit to competition** è¦‹å‡ºã—ã‹ã‚‰ç›´æ¥æå‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚ã‚‹ã„ã¯ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã‹ã‚‰ *Output* ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`submission.tar.gz` ã‚’è¦‹ã¤ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ç«¶æŠ€ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã‚ã‚‹ **Submit Agent** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€æå‡ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece  # å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null  # gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/  # gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/  # gemmaã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã•ã›ã¾ã™
```

---The following area is a Code cell (cell numver is 3)---
```python
%%writefile submission/main.py
# è¨­å®š
import os
import sys

# **é‡è¦:** ã‚³ãƒ¼ãƒ‰ãŒãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))  # KAGGLE_AGENT_PATHã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¾ã™
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")  # æŒ‡å®šã®ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆ¥ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™

import contextlib
import os
import sys
from pathlib import Path

import torch
from gemma.config import get_config_for_7b, get_config_for_2b  # gemmaãƒ¢ãƒ‡ãƒ«è¨­å®šã®å–å¾—
from gemma.model import GemmaForCausalLM  # gemmaãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

if os.path.exists(KAGGLE_AGENT_PATH):  # KAGGLE_AGENT_PATHãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")  # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"  # ä»–ã®ãƒ‘ã‚¹ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
import itertools
from typing import Iterable

class GemmaFormatter:
    _start_token = '<start_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ãƒˆãƒ¼ã‚¯ãƒ³
    _end_token = '<end_of_turn>'  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³

    def __init__(self, system_prompt: str = None, few_shot_examples: Iterable = None):
        self._system_prompt = system_prompt  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜
        self._few_shot_examples = few_shot_examples  # Few-shotä¾‹ã®ä¿å­˜
        self._turn_user = f"{self._start_token}user\n{{}}{self._end_token}\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self._turn_model = f"{self._start_token}model\n{{}}{self._end_token}\n"  # ãƒ¢ãƒ‡ãƒ«ã®ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        self.reset()  # çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ

    def __repr__(self):
        return self._state  # ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™

    def user(self, prompt):
        self._state += self._turn_user.format(prompt)  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def model(self, prompt):
        self._state += self._turn_model.format(prompt)  # ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        return self

    def start_user_turn(self):
        self._state += f"{self._start_token}user\n"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def start_model_turn(self):
        self._state += f"{self._start_token}model\n"  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã®é–‹å§‹ã‚’è¿½åŠ 
        return self

    def end_turn(self):
        self._state += f"{self._end_token}\n"  # ã‚¿ãƒ¼ãƒ³ã®çµ‚äº†ã‚’è¿½åŠ 
        return self

    def reset(self):
        self._state = ""  # çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        if self._system_prompt is not None:
            self.user(self._system_prompt)  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        if self._few_shot_examples is not None:
            self.apply_turns(self._few_shot_examples, start_agent='user')  # Few-shotä¾‹ã®ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        return self

    def apply_turns(self, turns: Iterable, start_agent: str):
        formatters = [self.model, self.user] if start_agent == 'model' else [self.user, self.model]  # ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œé †åºã‚’æ±ºå®š
        formatters = itertools.cycle(formatters)  # é †åºã‚’å¾ªç’°ã•ã›ã‚‹
        for fmt, turn in zip(formatters, turns):  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã¨ã‚¿ãƒ¼ãƒ³ã‚’çµåˆ
            fmt(turn)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
        return self


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
import re

@contextlib.contextmanager
def _set_default_tensor_type(dtype: torch.dtype):
    """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
    torch.set_default_dtype(dtype)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’å¤‰æ›´
    yield
    torch.set_default_dtype(torch.float)  # å…ƒã®dtypeã«æˆ»ã™

class GemmaAgent:
    def __init__(self, variant='7b-it-quant', device='cuda:0', system_prompt=None, few_shot_examples=None):
        self._variant = variant  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
        self._device = torch.device(device)  # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®š
        self.formatter = GemmaFormatter(system_prompt=system_prompt, few_shot_examples=few_shot_examples)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’åˆæœŸåŒ–

        print("ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ä¸­")
        model_config = get_config_for_2b() if "2b" in variant else get_config_for_7b()  # ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’å–å¾—
        model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ã‚’è¨­å®š
        model_config.quant = "quant" in variant  # é‡å­åŒ–è¨­å®š

        with _set_default_tensor_type(model_config.get_dtype()):  # ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¨­å®šã—ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            model = GemmaForCausalLM(model_config)  # ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–
            ckpt_path = os.path.join(WEIGHTS_PATH , f'gemma-{variant}.ckpt')  # é‡ã¿ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ‘ã‚¹ã‚’è¨­å®š
            model.load_weights(ckpt_path)  # é‡ã¿ã‚’ãƒ­ãƒ¼ãƒ‰
            self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹

    def __call__(self, obs, *args):
        self._start_session(obs)  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        prompt = str(self.formatter)  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
        response = self._call_llm(prompt)  # LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã—ã¦å¿œç­”ã‚’å¾—ã‚‹
        response = self._parse_response(response, obs)  # å¿œç­”ã‚’è§£æ
        print(f"{response=}")  # å¿œç­”ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        return response

    def _start_session(self, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–

    def _call_llm(self, prompt, max_new_tokens=32, **sampler_kwargs):
        if sampler_kwargs is None:
            sampler_kwargs = {  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                'temperature': 0.01,  # æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                'top_p': 0.1,  # ãƒˆãƒƒãƒ—ç¢ºç‡
                'top_k': 1,  # ãƒˆãƒƒãƒ—Kã®è¨­å®š
        }
        response = self.model.generate(  # ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            prompt,
            device=self._device,
            output_len=max_new_tokens,  # æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
            **sampler_kwargs,  # ãã®ä»–ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        )
        return response

    def _parse_keyword(self, response: str):
        match = re.search(r"(?<=\*\*)([^*]+)(?=\*\*)", response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        if match is None:
            keyword = ''  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        else:
            keyword = match.group().lower()  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«å¤‰æ›
        return keyword

    def _parse_response(self, response: str, obs: dict):
        raise NotImplementedError  # ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŠ½è±¡åŒ–


def interleave_unequal(x, y):
    return [  # ä¸å‡ä¸€ãªãƒªã‚¹ãƒˆã‚’äº¤äº’ã«çµåˆ
        item for pair in itertools.zip_longest(x, y) for item in pair if item is not None
    ]


class GemmaQuestionerAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user("Let's play 20 Questions. You are playing the role of the Questioner.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='model')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        if obs.turnType == 'ask':
            self.formatter.user("Please ask a yes-or-no question.")  # è³ªå•ã™ã‚‹ã‚ˆã†æŒ‡ç¤º
        elif obs.turnType == 'guess':
            self.formatter.user("Now guess the keyword. Surround your guess with double asterisks.")  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰äºˆæƒ³ã®æŒ‡ç¤º
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        if obs.turnType == 'ask':
            match = re.search(".+?\?", response.replace('*', ''))  # è³ªå•ã‚’æŠ½å‡º
            if match is None:
                question = "Is it a person?"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è³ªå•
            else:
                question = match.group()  # æŠ½å‡ºã—ãŸè³ªå•
            return question
        elif obs.turnType == 'guess':
            guess = self._parse_keyword(response)  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®äºˆæƒ³ã‚’è§£æ
            return guess
        else:
            raise ValueError("Unknown turn type:", obs.turnType)  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


class GemmaAnswererAgent(GemmaAgent):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)  # è¦ªã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–

    def _start_session(self, obs):
        self.formatter.reset()  # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        self.formatter.user(f"Let's play 20 Questions. You are playing the role of the Answerer. The keyword is {obs.keyword} in the category {obs.category}.")  # ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        turns = interleave_unequal(obs.questions, obs.answers)  # è³ªå•ã¨å›ç­”ã‚’äº¤äº’ã«çµåˆ
        self.formatter.apply_turns(turns, start_agent='user')  # ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
        self.formatter.user(f"The question is about the keyword {obs.keyword} in the category {obs.category}. Give yes-or-no answer and surround your answer with double asterisks, like **yes** or **no**.")  # å›ç­”æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.formatter.start_model_turn()  # ãƒ¢ãƒ‡ãƒ«ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹

    def _parse_response(self, response: str, obs: dict):
        answer = self._parse_keyword(response)  # å›ç­”ã‚’è§£æ
        return 'yes' if 'yes' in answer else 'no'  # "yes"ã§ã‚ã‚Œã°yesã€ãã®ä»–ã¯noã‚’è¿”ã™


# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
system_prompt = "You are an AI assistant designed to play the 20 Questions game. In this game, the Answerer thinks of a keyword and responds to yes-or-no questions by the Questioner. The keyword is a specific person, place, or thing."  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š

few_shot_examples = [  # Few-shotä¾‹ã®è¨­å®š
    "Let's play 20 Questions. You are playing the role of the Questioner. Please ask your first question.",
    "Is it a person?", "**no**",
    "Is it a place?", "**yes**",
    "Is it a country?", "**yes** Now guess the keyword.",
    "**France**", "Correct!",
]

# **é‡è¦:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚å¿…è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€‚
# ä¸¡æ–¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€OOMï¼ˆOut of Memoryï¼‰ã«ç¹‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
agent = None

def get_agent(name: str):
    global agent
    
    if agent is None and name == 'questioner':
        agent = GemmaQuestionerAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    elif agent is None and name == 'answerer':
        agent = GemmaAnswererAgent(
            device='cuda:0',
            system_prompt=system_prompt,
            few_shot_examples=few_shot_examples,
        )  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–
    assert agent is not None, "Agent not initialized."  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    return agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿”ã™

def agent_fn(obs, cfg):
    if obs.turnType == "ask":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "guess":
        response = get_agent('questioner')(obs)  # è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    elif obs.turnType == "answer":
        response = get_agent('answerer')(obs)  # å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’å–å¾—
    if response is None or len(response) <= 1:  # å¿œç­”ãŒç©ºã‹é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆ
        return "yes"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¿œç­”
    else:
        return response  # é€šå¸¸ã®å¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
!apt install pigz pv > /dev/null  # pigzã¨pvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2  # submission.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```

---The following area is a Markdown cell (cell numver is 6)---
```markdown
---

# ã‚³ãƒ¡ãƒ³ãƒˆ 

> ## Samar Elhissi
> 
> ä¾‹ã‚’ã‚ã‚ŠãŒã¨ã†ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Valentin Baltazar
> > 
> > ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„â€¦ã“ã®LLMã¯å¤šãã®è¨ˆç®—ã‚’å¿…è¦ã¨ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯å¼·åŠ›ãªGPUãŒå¿…è¦ã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã€ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚
> > 
> > 

---

> ## Michael Kamal 92
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€few_shot_examplesã«ã¤ã„ã¦è³ªå•ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿ
> > ä¾‹ãˆã°ã€( 'is it place?', 'yes-or-no' )ã®ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€ãã‚Œã¨ã‚‚( 'is it place?', 'yes', ) ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'Now guess the keyword' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'no', 'Now guess the keyword', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚( 'is it place?', 'yes', 'France' )ã§ã—ã‚‡ã†ã‹ï¼Ÿã©ã‚ŒãŒæ­£ã—ã„è³ªå•ã€å›ç­”ã€äºˆæ¸¬ã®ä½œã‚Šæ–¹ã§ã™ã‹ï¼Ÿ
> 
> ã‚‚ã†ä¸€ã¤ã®è³ªå•ã§ã™ãŒã€Gemmaã¯few_shot_examplesã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ

---

> ## Yukky_2801
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«å¤±æ•—ã—ãŸã¨çµ‚äº†ã—ã¾ã™ã€‚
> 
> submission.tar.gzã‚’ã‚¨ãƒ©ãƒ¼ã¨å…±ã«æå‡ºã§ãã¾ã›ã‚“ã€‚ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è§£æ±ºç­–ã‚’æä¾›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

> ## Andres H. Zapke
> > ã‚‚ã¡ã‚ã‚“ã€Œgemma/pytorch/7b-it-quant/2ã€ã“ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å³å´ã‚’è¦‹ã¦ã€gemmaãƒ¢ãƒ‡ãƒ«ãŒãã“ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
>   
> > ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add Inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)
> > 
> > 
> > > ## Talal Mufti
> > > > ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸå¾Œã€ä¾ç„¶ã¨ã—ã¦å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€bashã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã€ã“ã‚ŒãŒç§ã«ã¨ã£ã¦ã†ã¾ãã„ãã¾ã—ãŸï¼š
> > > > !tar --use-compress-program='pigz --fast --recursive | pv' -f submission.tar.gz -c /kaggle/working/submission . -c /kaggle/input/gemma/pytorch/7b-it-quant/2

---

> ## Muhammad Hadi13
> 
> ãªãœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã«ã€å¸¸ã«1.35MBä»¥ä¸Šã®å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãšã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¤±æ•—ã™ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Ryanã®å‡ºåŠ›ã¯ç´„7GBã§ã—ãŸã€‚ã“ã®ä»¶ã«ã¤ã„ã¦åŠ©ã‘ãŒå¿…è¦ã§ã™ï¼ï¼
> 
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> > tar: gemma/pytorch: Cannot stat: No such file or directory
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸã€‚

> ## Aryan Singh
> > > Gemma 7b-it-quant V2ã‚’äº‹å‰ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> > > 
> > > ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€Add inputæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> > > 
> > > ã¾ãšã€ã“ã¡ã‚‰ã§ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š[https://www.kaggle.com/models/google/gemma](https://www.kaggle.com/models/google/gemma)

---

> ## Ship of Theseus
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community
> 
> 

---

> ## shiv_314
> 
> çš†ã•ã‚“ï¼ä¸€ã¤åŠ©ã‘ãŒå¿…è¦ã§ã™ã€‚gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
> 
> Pythonã®ãŸã‚ã«ã™ã§ã«æ­£ã—ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼

---

> ## dedq
> 
> Thank Ryan, greate work! Nice code to run on localhost and sharing to Kaggle Community

---

> ## Code Hacker
> 
> ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«tar.gzã‚’æå‡ºã—ã‚ˆã†ã¨ã—ãŸãŒã€å¤±æ•—ã—ã¾ã—ãŸâ€¦

> ## Code Hacker
> > > ã“ã®ãƒ¢ãƒ‡ãƒ«ã«åŒæ„ã—ãªã‹ã£ãŸã€‚ä¸‹ã®èµ¤ã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯â€¦

---

> ## JAPerez
> 
> Great work Ryan!

---

> ## philipha2
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ã“ã®ã‚³ãƒ³ãƒšã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦æå‡ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚
> æå‡ºç‰©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹submission.tar.gzã‚’ã©ã“ã«ç½®ã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ 
> Submit agentsãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾æå‡ºã™ã‚Œã°ã‚ˆã„ã§ã™ã‹ï¼Ÿ 
> æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
> åŸºæœ¬çš„ãªè³ªå•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¿”ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kanchan Maurya
> > > Submit agentsã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡ºã—ã¦ã„ã¾ã™ã€‚ãã‚Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã€åˆæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---

> ## vj4science
> 
> Thanks Ryan - this is a good head start to the competition! much appreciated!

---

> ## gb_kwon
> 
> Thank you so much for your COOL guidelines!

---

> ## Andres H. Zapke
> 
> main.pyã§ã€gemma_pytorchãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼šfrom gemma.configã€‚
> 
> ã“ã‚Œã¯ç§ã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ãŒã€gemmaã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ã€‚
> 
> è‡ªåˆ†ã®ãƒ­ãƒ¼ã‚«ãƒ«ã®gemmaãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æ‰‹å‹•ã§æŒ‡å®šã™ã‚‹ã®ã¨ã€Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã®ã‚’è©¦ã¿ã¾ã—ãŸãŒã€‚ä½•ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

---

> ## Duy Thai
> 
> ã“ã‚“ã«ã¡ã¯[@ryanholbrook](https://www.kaggle.com/ryanholbrook)ã€ã‚ãªãŸã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’è©¦ã—ãŸã¨ã“ã‚ã€ã€Œæ·»ä»˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è¿½åŠ ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ã¯Modelãƒ‘ãƒãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãã‚Œã«ã¤ã„ã¦ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸã¨ãã€ç§ã¯ã“ã‚Œã ã‘ã‚’è¦‹ã¦ã„ã¾ã™ï¼š

> ## Andres H. Zapke
> > > "Models"ã¸è¡Œãã€Gemmaã‚’æ¤œç´¢ã—ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚

> ## Duy Thai
> > > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

---

> ## Kai_Huang
> 
> ã“ã‚“ã«ã¡ã¯ã€ç§ã¯Kaggleã®åˆå¿ƒè€…ã§ã™ã€‚ã‚ãªãŸã® !tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission . -C /kaggle/input/ gemma/pytorch/7b-it-quant/2 ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã¨ãã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼š
> 
> tar: gemma/pytorch/7b-it-quant/2: Cannot stat: No such file or directory
> 
> 1.37MiB 0:00:00 [36.4MiB/s] [<=> ]
> 
> tar: å‰ã®ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã«çµ‚äº†ã—ã¾ã—ãŸ
> 
> ã©ã†ã„ã†ã“ã¨ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

> ## Kai_Huang
> > > ã‚ã‚ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«å…¥åŠ›ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã™ã­ğŸ˜±

> ## D Prince Armand KOUMI
> > > ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆã¯ã€è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

> ## Qusay AL-Btoush
> 
> ã¨ã¦ã‚‚è‰¯ã„ã€Ryan 

---
```

** @@@ Jupyter Notebook numver 67, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€ŒLLM 20 Questionsã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«æ§‹ç¯‰ã•ã‚ŒãŸã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¿ãƒ¼ãƒˆãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ç›®æ¨™ã§ã‚ã‚‹ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ãŸã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®ãŸã‚ã«ã€å¤§å¹…ã«ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚’è¿…é€Ÿã«å§‹ã‚ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ä»–ã®ã‚ˆã‚Šé«˜åº¦ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰å–å¾—ã•ã‚Œã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®éƒ¨åˆ†ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

### å–ã‚Šçµ„ã‚€å•é¡Œ
ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹è³ªå•è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨å›ç­”è€…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä¸¡æ–¹ã‚’å®Ÿè£…ã—ã€ã‚²ãƒ¼ãƒ ã®é€²è¡Œã«ãŠã„ã¦è¿…é€Ÿã‹ã¤æ­£ç¢ºã«æƒ…å ±ã‚’å‡¦ç†ã™ã‚‹å•é¡Œã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚ç‰¹ã«ã€æ¨æ¸¬ã€è³ªå•ã€å›ç­”ã®å„ã‚¿ãƒ¼ãƒ³ã«ãŠã„ã¦ã€é©åˆ‡ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€å¿œç­”ã‚’å¾—ã‚‹èƒ½åŠ›ãŒé‡è¦ã§ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
1. **Gemmaãƒ¢ãƒ‡ãƒ«**: å¿…è¦ãªãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦`GemmaForCausalLM`ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ã«æœ€é©åŒ–ã•ã‚ŒãŸè¨€èªãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚Šã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
2. **Torch**: æ·±å±¤å­¦ç¿’ã®ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã¨å®Ÿè¡Œã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
3. **ImmutableDictã¨SentencePiece**: ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†ã‚„ãƒ¡ãƒ¢ãƒªç®¡ç†ã®åŠ¹ç‡ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚³ãƒ¼ãƒ‰ã®æ¦‚è¦
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½¿ç”¨ã™ã‚‹ç•°ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`ask_agent`, `guess_agent`, `answer_agent`ï¼‰ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚‰ãŒãã‚Œãã‚Œè³ªå•ã€æ¨æ¸¬ã€å›ç­”ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã«å¿œã˜ã¦ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã«ç”Ÿæˆã•ã‚Œã€LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’ä»‹ã—ã¦å‡¦ç†ã•ã‚Œã€çµæœãŒè¿”ã•ã‚Œã¾ã™ã€‚

ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®å¾ŒåŠéƒ¨åˆ†ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§æ§‹ç¯‰ã—ã€ã•ã¾ã–ã¾ãªã‚¿ãƒ¼ãƒ³ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªã§ã®å‹•ä½œã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦æ”¹å–„ç­–ã‚’ææ¡ˆã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã¨ã„ã†ç‰¹å®šã®å•é¡Œã«å¯¾ã—ã¦ã€è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’æ´»ç”¨ã—ãŸåŠ¹ç‡çš„ãªå¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
```

---The following area is a Markdown cell (cell numver is 1)---
```markdown
# ã‚·ãƒ³ãƒ—ãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ç¤ºã™ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯

å„ªã‚ŒãŸã€ŒLLM 20 Questions Starter Notebookã€ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚

ãŸã ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚’è¿…é€Ÿã«å§‹ã‚ã‚‹ãŸã‚ã«ã€ã¯ã‚‹ã‹ã«ç°¡ç•¥åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã€ŒLLM 20 Questions Starter Notebookã€ã»ã©é«˜åº¦ã§ã¯ãªãã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã«æä¾›ã•ã‚ŒãŸã€ŒLLM 20 Questionsã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰ç›´æ¥å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚

æœ€å¾Œã«ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚»ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

å•é¡Œã‚„æ”¹å–„ã®ææ¡ˆãŒã‚ã‚Œã°æ­“è¿ã—ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 2)---
```python
%%bash
cd /kaggle/working
# immutabledictã¨sentencepieceã‚’æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
pip install -q -U -t /kaggle/working/submission/lib immutabledict sentencepiece
# gemma_pytorchãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™
git clone https://github.com/google/gemma_pytorch.git > /dev/null
# gemmaç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
mkdir /kaggle/working/submission/lib/gemma/
# gemmaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã™
mv /kaggle/working/gemma_pytorch/gemma/* /kaggle/working/submission/lib/gemma/
```

---The following area is a Markdown cell (cell numver is 3)---
```markdown
**Add the model using Add Input**  
ç’°å¢ƒã®å³å´ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™
```

---The following area is a Code cell (cell numver is 4)---
```python
# %%writefile submission/main.py

import os
import sys

# Kaggleã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™
KAGGLE_AGENT_PATH = "/kaggle_simulations/agent/"
if os.path.exists(KAGGLE_AGENT_PATH):
    sys.path.insert(0, os.path.join(KAGGLE_AGENT_PATH, 'lib'))
else:
    sys.path.insert(0, "/kaggle/working/submission/lib")

import contextlib
import os
import sys
from dataclasses import dataclass
from typing import Literal, List

import torch
from gemma.config import get_config_for_7b
from gemma.model import GemmaForCausalLM

# é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™
if os.path.exists(KAGGLE_AGENT_PATH):
    WEIGHTS_PATH = os.path.join(KAGGLE_AGENT_PATH, "gemma/pytorch/7b-it-quant/2")
else:
    WEIGHTS_PATH = "/kaggle/input/gemma/pytorch/7b-it-quant/2"


# ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…å®¹ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã«ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™
@dataclass
class ObsData:
    answers: List["str"]  # å›ç­”ã®ãƒªã‚¹ãƒˆ
    category: str  # ã‚«ãƒ†ã‚´ãƒªå
    keyword: str  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    questions: List["str"]  # è³ªå•ã®ãƒªã‚¹ãƒˆ
    turn_type: Literal["ask", "guess", "answer"]  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ï¼ˆè³ªå•ã€æ¨æ¸¬ã€å›ç­”ã®ã„ãšã‚Œã‹ï¼‰
    

class Agents:
    def __init__(self):
        self.model = None
        
        # 7Bãƒ¢ãƒ‡ãƒ«ã¯ã‹ãªã‚Šå¤§ãã„ã®ã§GPUã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã®ãŒç†æƒ³çš„ã§ã™
        self._device = torch.device("cpu")  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯CPU
        if torch.cuda.is_available():
            self._device = torch.device("cuda:0")  # GPUãŒåˆ©ç”¨å¯èƒ½ãªã‚‰ä½¿ç”¨ã—ã¾ã™
    
    def answer_agent(self, question: str, category: str, keyword: str) -> Literal["yes", "no"]:
        # è³ªå•è€…ãŒæ¨æ¸¬ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã®æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
        info_prompt = """ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦éå¸¸ã«æ­£ç¢ºãªå›ç­”è€…ã§ã™ã€‚è³ªå•è€…ãŒæ¨æ¸¬ã—ã¦ã„ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯[ã‚«ãƒ†ã‚´ãƒª: {category} ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}]ã§ã™ã€‚"""
        answer_question_prompt = f"""ä»¥ä¸‹ã®è³ªå•ã«ã€Œã¯ã„ã€ã€ã€Œã„ã„ãˆã€ã€ã¾ãŸã¯ã€Œã‚ã‹ã‚‰ãªã„å ´åˆã¯maybeã€ã ã‘ã§ç­”ãˆã¦ãã ã•ã„: {question}"""
    
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã¾ã™
        prompt = "{}{}".format(
            info_prompt.format(category=category, keyword=keyword),
            answer_question_prompt
        )
        
        return self._call_llm(prompt)  # LLMã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’å¾—ã‚‹

    def ask_agent(self, questions: List[str], answers: List[str]) -> str:
        # è³ªå•ã‚’è¡Œã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
        info_prompt = """ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ãŠã‚Šã€è³ªå•ã‚’ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãã‚Œã¯ç¾å®Ÿã¾ãŸã¯æ¶ç©ºã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚\nã“ã“ã¾ã§ã«çŸ¥ã£ã¦ã„ã‚‹æƒ…å ±:\n{q_a_thread}"""
        questions_prompt = """1ã¤ã®ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’ã—ã¦ä¸‹ã•ã„ã€‚"""

        # è³ªå•ã¨å›ç­”ã®å±¥æ­´ã‚’æ§‹ç¯‰ã—ã¾ã™
        q_a_thread = ""
        for i in range(0, len(answers)):
            q_a_thread = "{}Q: {} A: {}\n".format(
                q_a_thread,
                questions[i],
                answers[i]
            )
    
        prompt = "{}{}".format(
            info_prompt.format(q_a_thread=q_a_thread),
            questions_prompt
        )

        return self._call_llm(prompt)  # LLMã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’å¾—ã‚‹

    
    def guess_agent(self, questions: List[str], answers: List[str]) -> str:
        # æ¨æ¸¬ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ (ç­”ãˆã¯**ã§å›²ã¾ã‚Œã¾ã™)
        info_prompt = """ã‚ãªãŸã¯ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ãŠã‚Šã€è³ªå•ã‚’ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ãã‚Œã¯ç¾å®Ÿã¾ãŸã¯æ¶ç©ºã®äººç‰©ã€å ´æ‰€ã€ã¾ãŸã¯ç‰©ã§ã™ã€‚\nã“ã“ã¾ã§ã«çŸ¥ã£ã¦ã„ã‚‹æƒ…å ±:\n{q_a_thread}"""
        guess_prompt = """ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚æ­£ç¢ºãªå˜èª/ãƒ•ãƒ¬ãƒ¼ã‚ºã ã‘ã‚’è¿”ç­”ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ[ãƒ‘ãƒª]ã ã¨æ€ã†å ´åˆã¯ã€[ç§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒ‘ãƒªã ã¨æ€ã†]ã‚„[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ãƒ‘ãƒªã§ã™ã‹ï¼Ÿ]ã§ã¯ãªãã€å˜èª[ãƒ‘ãƒª]ã ã‘ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚"""

        # è³ªå•ã¨å›ç­”ã®å±¥æ­´ã‚’æ§‹ç¯‰ã—ã¾ã™
        q_a_thread = ""
        for i in range(0, len(answers)):
            q_a_thread = "{}Q: {} A: {}\n".format(
                q_a_thread,
                questions[i],
                answers[i]
            )
        
        prompt = "{}{}".format(
            info_prompt.format(q_a_thread=q_a_thread),
            guess_prompt
        )

        return f"**{self._call_llm(prompt)}**"  # LLMã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’å¾—ã‚‹ï¼ˆç­”ãˆã¯**ã§å›²ã¾ã‚Œã‚‹ï¼‰

    def _call_llm(self, prompt: str):
        self._set_model()  # ãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®š
        sampler_kwargs = {
            'temperature': 0.01,  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¸©åº¦
            'top_p': 0.1,  # ä¸Šä½ç¢ºç‡
            'top_k': 1,  # ä¸Šä½kã®åˆ¶é™
        }
        
        return self.model.generate(
            prompt,
            device=self._device,  # ãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šï¼ˆGPUã¾ãŸã¯CPUï¼‰
            output_len=100,  # å‡ºåŠ›ã®é•·ã•
            **sampler_kwargs,
        )
         
    def _set_model(self):
        if self.model is None:
            print("ãƒ¢ãƒ‡ãƒ«ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è¨­å®šä¸­ã§ã™ã€‚")
            model_config = get_config_for_7b()
            model_config.tokenizer = os.path.join(WEIGHTS_PATH, "tokenizer.model")  # ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ãƒ‘ã‚¹
            model_config.quant = True  # é‡å­åŒ–ãƒ•ãƒ©ã‚°

            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ãŒå¹ãé£›ã°ãªã„ã‚ˆã†ã«ã—ã¾ã™
            with self._set_default_tensor_type(model_config.get_dtype()):
                model = GemmaForCausalLM(model_config)
                ckpt_path = os.path.join(WEIGHTS_PATH, f'gemma-7b-it-quant.ckpt')  # é‡ã¿ã®ãƒ‘ã‚¹
                model.load_weights(ckpt_path)  # é‡ã¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™
                self.model = model.to(self._device).eval()  # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ç§»å‹•ã—ã¦è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¾ã™
    
    @contextlib.contextmanager
    def _set_default_tensor_type(self, dtype: torch.dtype):
        """æŒ‡å®šã•ã‚ŒãŸdtypeã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®torch dtypeã‚’è¨­å®šã—ã¾ã™ã€‚"""
        torch.set_default_dtype(dtype)  # dtypeã‚’è¨­å®š
        yield
        torch.set_default_dtype(torch.float)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®dtypeã‚’floatã«æˆ»ã—ã¾ã™

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ãŸã‚ã€åå‰ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒäº‹å‰ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™
def agent_fn(obs, cfg) -> str:
    obs_data = ObsData(
        turn_type=obs.turnType,
        questions=obs.questions,
        answers=obs.answers,
        keyword=obs.keyword,
        category=obs.category
    )
    
    # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã«å¿œã˜ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™
    if obs_data.turn_type == "ask":
        response = agents.ask_agent(questions=obs.questions, answers=obs.answers)
    if obs_data.turn_type == "guess":
        response = agents.guess_agent(questions=obs.questions, answers=obs.answers)
    if obs_data.turn_type == "answer":
        response = agents.answer_agent(question=obs.questions[-1], category=obs.category, keyword=obs.keyword)
    
    # å¿œç­”ãŒãªã‹ã£ãŸã‚Šã€é•·ã•ãŒ1ä»¥ä¸‹ã®å ´åˆã¯ã€Œã¯ã„ã€ã‚’è¿”ã—ã¾ã™
    if response is None or len(response) <= 1:
        return "yes"
    
    return response  # å¾—ã‚‰ã‚ŒãŸå¿œç­”ã‚’è¿”ã—ã¾ã™

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ1åº¦ã ã‘è¨­å®šã•ã‚Œã‚‹ã‚ˆã†ã«ã€Agentsã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¾ã™
agents = Agents()
```

---The following area is a Code cell (cell numver is 5)---
```python
# å›ç­”ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ã¾ã™
@dataclass
class ObsDataIn(ObsData):
    turnType: str  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã‚’è¿½åŠ ã—ã¾ã™
    
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã™
obs_data = ObsDataIn(
        turn_type="",
        turnType="answer",
        questions=["ã¯ãã‚Œã¯å ´æ‰€ã§ã™ã‹"],
        answers=[],  # å›ç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
        keyword="å—æ¥µ",  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        category="å ´æ‰€"  # ã‚«ãƒ†ã‚´ãƒª
    )

print(agent_fn(obs_data, {}))  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™
```

---The following area is a Code cell (cell numver is 6)---
```python
# è³ªå•ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ã¾ã™
@dataclass
class ObsDataIn(ObsData):
    turnType: str  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã‚’è¿½åŠ ã—ã¾ã™
    
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã™
obs_data = ObsDataIn(
        turn_type="",
        turnType="ask",
        questions=["ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ"],  # è³ªå•
        answers=["ã¯ã„"],  # å›ç­”
        keyword="",  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã¾ã ä¸æ˜
        category=""  # ã‚«ãƒ†ã‚´ãƒªã¯ã¾ã ä¸æ˜
    )

print(agent_fn(obs_data, {}))  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™
```

---The following area is a Code cell (cell numver is 7)---
```python
# æ¨æ¸¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ã¾ã™
@dataclass
class ObsDataIn(ObsData):
    turnType: str  # ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡ã‚’è¿½åŠ ã—ã¾ã™
    
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã™
obs_data = ObsDataIn(
        turn_type="",
        turnType="guess",
        questions=["ãã‚Œã¯å ´æ‰€ã§ã™ã‹ï¼Ÿ", "åŒ—åŠçƒã§ã™ã‹ï¼Ÿ", "éƒ½å¸‚ã§ã™ã‹ï¼Ÿ", "æ°·ã ã‚‰ã‘ã§ã™ã‹ï¼Ÿ"],  # è³ªå•ãƒªã‚¹ãƒˆ
        answers=["ã¯ã„", "ã„ã„ãˆ", "ã„ã„ãˆ", "ã¯ã„"],  # è³ªå•ã«å¯¾ã™ã‚‹å›ç­”
        keyword="",  # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã¾ã ä¸æ˜
        category=""  # ã‚«ãƒ†ã‚´ãƒªã¯ã¾ã ä¸æ˜
    )

print(agent_fn(obs_data, {}))  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™
```

** @@@ Jupyter Notebook numver 68, the number of votes :0 @@@ **

---The following area is a Markdown cell (cell numver is 0)---
```markdown
# è¦ç´„ 
ã“ã®Jupyter Notebookã¯ã€Kaggleã®ã€Œ20ã®è³ªå•ã€ã‚²ãƒ¼ãƒ ã®ãŸã‚ã®ç°¡å˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‹•ç‰©ã‚’æ¨æ¸¬ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã€è³ªå•ã‚„ç­”ãˆã‚’é€šã˜ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç‰¹å®šã—ã¾ã™ã€‚

### å•é¡Œã®æ¦‚è¦
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€2ã¤ã®ç•°ãªã‚‹ãƒ­ãƒ¼ãƒ«ï¼ˆè³ªå•è€…ã¨å›ç­”è€…ï¼‰ã§é‹å–¶ã•ã‚Œã€å›ç­”è€…ã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®å½¢å¼ã§å…¥åŠ›ã•ã‚ŒãŸè³ªå•ã«åŸºã¥ã„ã¦ç­”ãˆã¾ã™ã€‚ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªãƒ­ã‚¸ãƒƒã‚¯ãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **NumPy** ã¨ **Pandas**: ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„åˆ†æã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€å…·ä½“çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ“ä½œã«ä½¿ã‚ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã¯ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
- **CSV**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½¿ç”¨ã™ã‚‹å‹•ç‰©ã®ãƒªã‚¹ãƒˆã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿æ›¸ãã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€æ¨æ¸¬ã™ã‚‹å‹•ç‰©ã®åå‰ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
- **ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ**: Pythonã®`random`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‹•ç‰©ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¾ã™ã€‚

### ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æµã‚Œ
1. **ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ä¿å­˜**:
   - `example.csv`ãƒ•ã‚¡ã‚¤ãƒ«ã«å‹•ç‰©ã®åå‰ã‚’ä¿å­˜ã—ã€èª­ã¿è¾¼ã‚“ã§ãƒªã‚¹ãƒˆåŒ–ã—ã¾ã™ã€‚
2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯**:
   - `agent_fn`é–¢æ•°ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã«åŸºã¥ã„ã¦è³ªå•ã‚„æ¨æ¸¬ã‚’è¡Œã„ã¾ã™ã€‚æ¨æ¸¬æ®µéšã§ã®æ¡ä»¶åˆ†å²ã«ã‚ˆã‚Šã€é©åˆ‡ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚

### çµæœã®ç”Ÿæˆ
æœ€å¾Œã«ã€ã“ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã—Kaggleã®æå‡ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã¾ã¨ã‚ã‚‹æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€ã“ã®Notebookã¯ã€åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿æ“ä½œã¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã£ã¦Kaggleã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
```

---The following area is a Code cell (cell numver is 1)---
```python
# ã“ã®Python 3ç’°å¢ƒã«ã¯ã€å¤šãã®ä¾¿åˆ©ãªåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™
# ã“ã‚Œã¯kaggle/pythonã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™: https://github.com/kaggle/docker-python
# ä¾‹ãˆã°ã€ä»¥ä¸‹ã«ç¤ºã™ã®ã¯ã€èª­ã¿è¾¼ã‚€ãŸã‚ã®ã„ãã¤ã‹ã®ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™

import numpy as np # ç·šå½¢ä»£æ•°
import pandas as pd # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å…¥å‡ºåŠ›ï¼ˆä¾‹ï¼špd.read_csvï¼‰

# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã®"../input/"ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™
# ä¾‹ãˆã°ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œã™ã‚‹ã‹Shift+Enterã‚’æŠ¼ã™ã“ã¨ã§ï¼‰ã€å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™

import os
for dirname, _, filenames in os.walk('/kaggle/input'):
    for filename in filenames:
        print(os.path.join(dirname, filename))

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ/kaggle/working/ï¼‰ã«ã¯æœ€å¤§20GBã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€
# ã“ã‚Œã¯ã€Œå…¨ã¦ä¿å­˜ã—ã¦å®Ÿè¡Œã€ã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«å‡ºåŠ›ã¨ã—ã¦ä¿æŒã•ã‚Œã¾ã™
# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’/kaggle/temp/ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤–ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
```

---The following area is a Code cell (cell numver is 2)---
```python
import os
submission_directory = "/kaggle/working/submission"
submission_subdirectory = "lib"
# ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¾ã™
if not os.path.exists(submission_directory):
    os.mkdir(submission_directory)  # æå‡ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    subdirectory_path = os.path.join(submission_directory, submission_subdirectory)  # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ã‚’ä½œæˆ
    os.mkdir(subdirectory_path)  # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
```

---The following area is a Code cell (cell numver is 3)---
```python
import csv
with open(os.path.join(subdirectory_path, "example.csv"), mode='w') as file:
    writer = csv.writer(file)  # CSVãƒ©ã‚¤ã‚¿ãƒ¼ã‚’ä½œæˆ
    writer.writerow(["cow", "horse"])  # CSVã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ï¼ˆç‰›ã€é¦¬ï¼‰
```

---The following area is a Code cell (cell numver is 4)---
```python
%%writefile /kaggle/working/submission/main.py

import os
import sys
import csv
import random

# æå‡ºç‰©ã®libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ãªã©ï¼‰ã‚’å…¥ã‚Œã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
KAGGLE_COMPETITION_PATH = "/kaggle_simulations/agent/" # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ‘ã‚¹
if os.path.exists(KAGGLE_COMPETITION_PATH):  # ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œä¸­ã‹ã©ã†ã‹
    subdirectory_path = os.path.join(KAGGLE_COMPETITION_PATH, "lib")  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ã‚¹ã‚’è¨­å®š
else: # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…ã§å®Ÿè¡Œä¸­ã®å ´åˆ
    subdirectory_path = os.path.join("/kaggle/working/submission/", "lib")  # ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ç”¨ã®ãƒ‘ã‚¹ã‚’è¨­å®š
sys.path.insert(0, subdirectory_path)  # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ¤œç´¢ãƒ‘ã‚¹ã«è¿½åŠ 

with open(os.path.join(subdirectory_path, "example.csv"), mode='r') as file:
    reader = csv.reader(file)  # CSVãƒªãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆ
    guess_list = list(reader)  # CSVã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´
    guess_list = guess_list[0]  # æœ€åˆã®è¡Œï¼ˆãƒªã‚¹ãƒˆï¼‰ã‚’å–å¾—

animal = random.choice(guess_list)  # guess_listã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ãŸå‹•ç‰©ã®åå‰ã‚’è¨­å®š

def agent_fn(obs, cfg):
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒã€Œaskã€ã®å ´åˆ
    if obs.turnType == "ask":
        response = f'ãã‚Œã¯{animal}ã«è¦‹ãˆã¾ã™ã‹ï¼Ÿ'  # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã å‹•ç‰©ã«ã¤ã„ã¦è³ªå•
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ¨æ¸¬è€…ã§ã€turnTypeãŒã€Œguessã€ã®å ´åˆ
    elif obs.turnType == "guess":
        if obs.answers[-1] == "yes":
            response = animal  # ã‚‚ã—å‰ã®ç­”ãˆãŒã€Œã¯ã„ã€ã§ã‚ã‚Œã°ã€é¸ã‚“ã å‹•ç‰©ã‚’è¿”ã™
        else:
            response = "penguin"  # ãã†ã§ãªã‘ã‚Œã°ã€Œãƒšãƒ³ã‚®ãƒ³ã€ã¨è¿”ã™
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”è€…ã®å ´åˆ
    elif obs.turnType == "answer":
        if obs.keyword in obs.questions[-1]:
            response = "yes"  # å‰ã®è³ªå•ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€Œã¯ã„ã€ã¨è¿”ã™
        else:
            response = "no"  # å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã€Œã„ã„ãˆã€ã¨è¿”ã™
        
    return response  # æœ€çµ‚çš„ãªå¿œç­”ã‚’è¿”ã™
```

---The following area is a Code cell (cell numver is 5)---
```python
!apt install pigz pv > /dev/null
!tar --use-compress-program='pigz --fast --recursive | pv' -cf submission.tar.gz -C /kaggle/working/submission .
```

