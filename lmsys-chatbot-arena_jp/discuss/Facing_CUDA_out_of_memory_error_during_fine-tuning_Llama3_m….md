# Llama3ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ã€ŒCUDA out of memoryã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**Tabassum_Nova** *2024å¹´5æœˆ31æ—¥ 18:06:44 (æ—¥æœ¬æ¨™æº–æ™‚)* (5 votes)

[fine-tune-llama-3-for-sentiment-analysis](https://www.kaggle.com/code/lucamassaron/fine-tune-llama-3-for-sentiment-analysis) ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å‚è€ƒã«ã€Llama3ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è©¦ã¿ã¾ã—ãŸã€‚ã—ã‹ã—ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 224.00 MiB. GPU 0 has a total capacty of 14.75 GiB of which 11.06 MiB is free. Process 3258 has 14.73 GiB memory in use. Of the allocated memory 14.04 GiB is allocated by PyTorch, and 509.85 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting max_split_size_mb to avoid fragmentation.  See documentation for Memory Management and PYTORCH_CUDA_ALLOC_CONF
```

[ã“ã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³](https://www.kaggle.com/discussions/getting-started/140636)ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹è§£æ±ºç­–ã‚’è©¦ã—ã¾ã—ãŸãŒã€åŠ¹æžœã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç§ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒªãƒ³ã‚¯ã¯ã“ã¡ã‚‰ã§ã™ï¼š[ç§ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯](https://www.kaggle.com/code/tabassumnova/lmsys-fine-tuning-llama3-8b/notebook)

ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’å›žé¿ã™ã‚‹ãŸã‚ã«ã€ä½•ã‹ææ¡ˆã—ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã‹ï¼Ÿ

---
# ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ

> ## Ivan Vybornov
> 
> `gradient_checkpointing` ã‚’æœ‰åŠ¹ã«ã—ã¦ã€32ãƒ“ãƒƒãƒˆç‰ˆã§ã¯ãªã `paged_adamw_8bit` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ãã‚Œã§ã‚‚ã†ã¾ãã„ã‹ãªã„å ´åˆã¯ã€`lora` ã‚’é©ç”¨ã™ã‚‹ `target_modules` ã‚’æ¸›ã‚‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ã€`["q_proj", "k_proj", "v_proj", "o_proj"]` ã ã‘ã‚’ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã‚‚æ‚ªãã‚ã‚Šã¾ã›ã‚“ã€‚
> 
> 
> 
> > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚`gradient_checkpointing` ã‚’æœ‰åŠ¹ã«ã—ãŸã‚‰ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ ðŸ˜
> > 
> > 
> > 
---
> ## Valentin Werner
> 
> ã¾ã ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’ 1 ã«ã—ã¦ãã ã•ã„ã€‚T4 x2 ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
> 
> ä¸€èˆ¬çš„ã«ã€Kaggle ã® GPU ã¯ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®é‡ã¨é•·ã•ã«å¯¾ã—ã¦é…ã™ãŽã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
> 
> 
> 
> > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚Kaggle GPU T4x2 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚Kaggle ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä»¥å¤–ã®æ–¹æ³•ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã‚’ææ¡ˆã—ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã‹ï¼Ÿå€‹äººçš„ãª GPU ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> > 
> > 
> > 
> > > ## Kishan Vavdara
> > > 
> > > å¤šãã®é¸æŠžè‚¢ãŒã‚ã‚Šã¾ã™ã€‚[Vastai](https://vast.ai/)ã€[Runpod](https://www.runpod.io/)ã€ã¾ãŸã¯ãã®ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ›ã‚¹ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ A100ã€Rtx4090ã€ã¾ãŸã¯ãã®ä»–ã® GPU ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒ¬ãƒ³ã‚¿ãƒ«ã—ã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Google Cloud ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚3 ã‹æœˆé–“ã€300 ãƒ‰ãƒ«ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒã‚‚ã‚‰ãˆã¾ã™ã€‚Colab Pro ã‚‚ A100 ã¨ V100 GPU ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚å€‹äººçš„ã«ã¯ã€Vastai ãŒæœ€ã‚‚ä¾¿åˆ©ã§å®‰ä¾¡ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚
> > > 
> > > 
> > > 
> > > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > > 
> > > ææ¡ˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
> > > 
> > > 
> > > 
> > > ## lijiang3859
> > > 
> > > ã‚µãƒ¼ãƒãƒ¼ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã—ãŸãŒã€ãã‚Œã§ã‚‚ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã§ã™ã€‚ã©ã†ã™ã‚Œã°è§£æ±ºã§ãã¾ã™ã‹ï¼Ÿ
> > > 
> > > ã“ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«æå‡ºã—ãŸå ´åˆã€ã‚³ãƒ¼ãƒ‰ã¯æŽ¨è«–ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã¨åŒã˜ãƒ‡ãƒã‚¤ã‚¹ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã‹ï¼Ÿ (æ‚²ã—ã„)
> > > 
> > > 
> > > 
---
> ## Kishan Vavdara
> 
> LoRA è¨­å®šã® `rank` ã‚’æ¸›ã‚‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸›ã‚Šã¾ã™ã€‚ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã¯ã€`rank` ã« 64 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€4ã€8ã€ã¾ãŸã¯ 16 ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã¾ãŸã€`max_length` ã‚’æ¸›ã‚‰ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
> 
> 
> 
> > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > `rank` ã‚’ 4 ã«ã€`max_seq_length` ã‚’ 512 ã«ã—ã¦è©¦ã—ã¾ã—ãŸãŒã€åŒã˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
> > 
> > 
> > 
---
> ## kartikey bartwal
> 
> Kaggle ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚„ Google Colab ä»¥å¤–ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ä½œæ¥­ã—ã¦ã„ã¾ã™ã‹ï¼ŸTPU ã‚’ä½¿ç”¨ã—ã¦ã„ã‚Œã°ã€ã“ã®ã‚ˆã†ãªå•é¡Œã¯ç™ºç”Ÿã—ãªã„ã¯ãšã§ã™ã€‚
> 
> 
> 
> > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒé…ã™ãŽã¾ã™ã€‚TPU ã¯è©¦ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é€Ÿåº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã®è§£æ±ºç­–ã‚’ææ¡ˆã—ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã‹ï¼Ÿ
> > 
> > 
> > 
> > > ## Tabassum_Novaãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > > 
> > > ã¯ã„ã€ç†è§£ã—ã¾ã—ãŸã€‚
> > > 
> > > 
> > > 
---


