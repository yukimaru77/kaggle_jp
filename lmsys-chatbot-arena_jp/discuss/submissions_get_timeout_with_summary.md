# è¦ç´„ 
ã“ã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³å‚åŠ è€…ãŒæå‡ºæ™‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ãŸå•é¡Œã«ã¤ã„ã¦è­°è«–ã—ã¦ã„ã¾ã™ã€‚

**ä¸»ãªãƒã‚¤ãƒ³ãƒˆ:**

* **å•é¡Œ:** ãƒ¦ãƒ¼ã‚¶ãƒ¼yechenzhi1ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã€Kaggleã®æå‡ºæ™‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã™ã“ã¨ã«æ‚©ã‚“ã§ã„ã¾ã—ãŸã€‚
* **åŽŸå› :** å•é¡Œã¯ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãŽã‚‹ãŸã‚ã«æŽ¨è«–æ™‚é–“ãŒé•·ããªã£ã¦ã„ãŸã“ã¨ãŒåˆ¤æ˜Žã—ã¾ã—ãŸã€‚ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’1ã«æ¸›ã‚‰ã™ã“ã¨ã§ã€å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸã€‚
* **è­¦å‘Š:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€cuDNNã€cuFFTã€cuBLASã®ç™»éŒ²ã«é–¢ã™ã‚‹è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å—ã‘å–ã£ã¦ã„ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’1ã«è¨­å®šã™ã‚‹ã“ã¨ã§è§£æ±ºã•ã‚Œã¾ã—ãŸãŒã€è­¦å‘Šè‡ªä½“ã¯ç„¡è¦–ã—ã¦ã‚‚å•é¡Œãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
* **æŽ¨è«–æ™‚é–“:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æŽ¨è«–æ™‚é–“ã®æœ€é©åŒ–ã«ã¤ã„ã¦è³ªå•ã—ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã„ãã¤ã‹ã®ãƒ’ãƒ³ãƒˆã‚’å¾—ã¾ã—ãŸã€‚ä¾‹ãˆã°ã€bf116=Trueã€autocast()ã®ä½¿ç”¨ã€ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚
* **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã¨ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ã«ã¤ã„ã¦è³ªå•ã—ã¾ã—ãŸã€‚ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå…¨ä½“ãŒä½¿ç”¨ã•ã‚Œã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®ã‚¹ã‚³ã‚¢ã¯ã‚³ãƒ³ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã«å…¬é–‹ã•ã‚Œã‚‹ã“ã¨ã‚’èª¬æ˜Žã—ã¾ã—ãŸã€‚

**çµè«–:**

ã“ã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã¯ã€Kaggleã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ä¸€èˆ¬çš„ãªå•é¡Œã¨ã€ãã®è§£æ±ºç­–ã«ã¤ã„ã¦ç¤ºã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ãƒãƒƒãƒã‚µã‚¤ã‚ºã€æŽ¨è«–æ™‚é–“ã€è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†ãªã©ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒå¼·èª¿ã•ã‚Œã¦ã„ã¾ã™ã€‚


---
# æå‡ºãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ï¼Ÿ

**yechenzhi1** *2024å¹´5æœˆ19æ—¥ 11:28:12 GMT+0900 (æ—¥æœ¬æ¨™æº–æ™‚)* (6ç¥¨)

Kaggleåˆå¿ƒè€…ã§ã™ã€‚ä½•å›žã‹æå‡ºã—ã¾ã—ãŸãŒã€ã™ã¹ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã®Kaggleç’°å¢ƒã§T4*2ã‚’ä½¿ã£ã¦å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€æŽ¨è«–æ™‚é–“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ãã—ã¦ã€ã“ã®ã‚ˆã†ãªè­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

```
2024-05-19 01:36:52.192095: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
  2024-05-19 01:36:52.192192: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
  2024-05-19 01:36:52.309490: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
```

ã—ã‹ã—ã€æŽ¨è«–ä¸­ã«GPUãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã¯ç¢ºã‹ã§ã™ã€‚

ä½•ã‹åŠ©ã‘ãŒã‚ã‚Œã°å¹¸ã„ã§ã™ã€‚

---
# ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ

> ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> 
> ã¿ã‚“ãªã®åŠ©ã‘ã«æ„Ÿè¬ã—ã¾ã™ï¼ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’1ã«è¨­å®šã—ãŸã‚‰å•é¡ŒãŒè§£æ±ºã—ã¾ã—ãŸðŸ˜ƒ
> 
> 
> 
---
> ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> 
> ã‚‚ã†ä¸€ã¤è³ªå•ã§ã™ãŒã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹å ´åˆã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯ç´„25000 * 0.3è¡Œã§ã™ã‹ï¼Ÿãã—ã¦ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€ç´„25000 * 0.7è¡Œã§ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Kishan Vavdara
> > 
> > ã¯ã„ã€ãã®é€šã‚Šã§ã™ï¼
> > 
> > 
> > 
> > ## Rich Olson
> > 
> > ã»ã¨ã‚“ã©ã®ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã¨åŒã˜ã‚ˆã†ã«ã€ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯å¸¸ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆå…¨ä½“ã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®ã‚¹ã‚³ã‚¢ã¯ã€ã‚³ãƒ³ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã«å…¬é–‹ã•ã‚Œã‚‹ã ã‘ã§ã™ã€‚
> > 
> > 
> > 
---
> ## lijiang3859
> 
> ã“ã‚“ã«ã¡ã¯ã€[@yechenzhi1](https://www.kaggle.com/yechenzhi1)ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ç§ã‚‚ã“ã®è­¦å‘Šã‚’å—ã‘ã¾ã—ãŸã€‚
> 
> ```
>   warnings.warn(
> 2024-07-06 05:05:32.818151: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
> 2024-07-06 05:05:32.818272: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
> 2024-07-06 05:05:32.956771: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
> 
> ```
> 
> ã—ã‹ã—ã€ç§ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒã‚°ã‚’èµ·ã“ã—ã¦ã„ã¾ã›ã‚“ã€‚ä½•ã‹å½±éŸ¿ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’1ã«è¨­å®šã™ã‚‹ã¨ã€è­¦å‘Šã¯æ¶ˆãˆã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã“ã®è­¦å‘Šã¯ç„¡è¦–ã§ãã¾ã™ã€‚
> > 
> > 
> > 
---
> ## lijiang3859
> 
> ç§ã‚‚model=llama3-8Bã§åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ç§ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã“ã¡ã‚‰ã§ã™ã€‚
> 
> ```
> results = []
> df = pd.read_csv(args.test_file, dtype={'prompt': str, "response_a":str, "response_b":str})
> df.fillna("''", inplace=True)
> df.replace('null', "'null'", inplace=True)
> 
> eval_dataset = Dataset.from_pandas(df)
> length =  len(eval_dataset)
> for i in tqdm(range(length)): # batch_size = 1
>     data = eval_dataset[i]
>     idx = data["id"]
>     resp_a = template.format(data['prompt'], data['response_a'])
>     resp_b = template.format(data['prompt'], data['response_b'])
>     resp_tokens = tokenizer(
>         [resp_a, resp_b],
>         max_length=args.max_total_length,
>         padding=True,
>         truncation=True,
>         return_tensors="pt",
>     )
>     # concated responses to save inference time -> batch_size =2
>     output = model(resp_tokens)
> 
> ```
> 
> æŽ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã®ä»–ã®è¨­å®šã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã€‚
> 
> ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«bf116=Trueã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> autocast()ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
> 
> æŽ¨è«–ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã®ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ25000ã‚µãƒ³ãƒ—ãƒ«ã§ãƒ†ã‚¹ãƒˆã—ã¾ã—ãŸãŒã€9æ™‚é–“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°äºˆç®—ã‚’è¶…ãˆã‚‹ã®ã¯éžå¸¸ã«å±é™ºã§ã™ã€‚
> 
> 
> 
> > ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > [https://www.kaggle.com/code/emiz6413/llama-3-8b-38-faster-inference](https://www.kaggle.com/code/emiz6413/llama-3-8b-38-faster-inference)  ã“ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒå½¹ç«‹ã¤ã‹ã©ã†ã‹ç¢ºèªã§ãã¾ã™ã€‚
> > 
> > 
> > 
---
> ## Valentin Werner
> 
> ä¸€ã¤ã ã‘æ³¨æ„ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯25000ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ã€å®Ÿè¡Œæ™‚é–“ãŒ10å€ã«ãªã‚Šã¾ã™ã€‚æŠ€è¡“çš„ã«ã¯540åˆ†æœªæº€ã§ã™ãŒã€ã‹ãªã‚Šé…ã„ã§ã™ã€‚
> 
> 
> 
> > ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã¯ã„ã€ãã®ãŸã‚äºˆæ¸¬æ™‚é–“ã¯40 * 10åˆ†ã€ã¤ã¾ã‚Šç´„7æ™‚é–“ãªã®ã§ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¯ãšã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> > 
> > 
> > 
---
> ## Rich Olson
> 
> äºˆæ¸¬ã«ä½•è¡Œãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
> 
> (ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹å ´åˆã€25,000è¡Œã«å¯¾ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™)
> 
> 
> 
> > ## yechenzhi1ãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > 2500è¡Œãƒ†ã‚¹ãƒˆã—ã¾ã—ãŸã€‚ç´„40åˆ†ã‹ã‹ã‚Šã¾ã—ãŸã€‚
> > 
> > 
> > 
> > > ## Rich Olson
> > > 
> > > ã†ãƒ¼ã‚“ã€æ˜Žã‚‰ã‹ãªã‚‚ã®ã¯æ€ã„ã¤ãã¾ã›ã‚“ã€‚æŽ¨è«–ã®å‰ã«æ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°/å‰å‡¦ç†/åŸ‹ã‚è¾¼ã¿ã®ç”Ÿæˆï¼‰ã¯ã—ã¦ã„ãªã„ã§ã™ã‚ˆã­ï¼Ÿ
> > > 
> > > ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå°½ããŸã‚‰ã€æå‡ºã«ã§ãã‚‹ã ã‘è¿‘ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¦ãã ã•ã„ã€‚
> > > 
> > > "train"ã‹ã‚‰25kè¡Œã‚’"test"ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ãƒ­ãƒ¼ãƒ‰ã—ï¼ˆåˆ—ã‚’å‰Šé™¤ã—ãŸã‚Šã—ã¦ã€ãƒ†ã‚¹ãƒˆã®ã‚ˆã†ã«ã—ã¾ã™ï¼‰ã€
> > > 
> > > ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æå‡ºã•ã‚ŒãŸã¨ãã¨åŒã˜ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
> > > 
> > > ãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆæœ€å¾Œã¾ã§å®Œäº†ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸå ´åˆã§ã‚‚ï¼‰ã€‚
> > > 
> > > ãƒ­ã‚°/ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚
> > > 
> > > 
> > > 
---

