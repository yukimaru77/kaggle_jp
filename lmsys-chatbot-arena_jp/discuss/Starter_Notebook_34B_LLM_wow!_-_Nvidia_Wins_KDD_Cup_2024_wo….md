# ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ 34B LLM ã™ã”ã„ï¼ - Nvidia ãŒ KDD Cup 2024 ã§å„ªå‹ï¼ã™ã”ã„ï¼
**Chris Deotte** *2024å¹´7æœˆ20æ—¥ åœŸæ›œæ—¥ 10:19:17 JST* (151ç¥¨)

çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚9æ™‚é–“ä»¥å†…ã«25,000ä»¶ã®ãƒ†ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«ã‚’æŽ¨è«–ã™ã‚‹ãŸã‚ã«ã€34B LLM ã‚’æŽ¨è«–ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã™ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ [ã“ã¡ã‚‰](https://www.kaggle.com/code/cdeotte/infer-34b-with-vllm)ã€‚æ®‹ã‚Š2é€±é–“åŠã—ã‹ãªã„ã®ã§ã€ã‚ã¾ã‚Šå¤šãã¯å…±æœ‰ã—ã¾ã›ã‚“ãŒã€ã„ãã¤ã‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…±æœ‰ã—ã¾ã™ã€‚

# é‡å­åŒ– 4bit AWQ ã‚’ä½¿ç”¨ã™ã‚‹
ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€2xT4 GPU 16GB VRAM ã§æŽ¨è«–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€åˆè¨ˆ32GB VRAM ãŒã‚ã‚Šã¾ã™ã€‚34B LLM ã¯ fp16 ã§ 70GB ã®ã‚µã‚¤ã‚ºã§ã™ãŒã€4bit ã‚’ä½¿ç”¨ã™ã‚‹ã¨ 20GB ã®ã‚µã‚¤ã‚ºã«ãªã‚Šã¾ã™ï¼ˆã¤ã¾ã‚Šã€X å„„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¯ 4bit ã§ 0.6X GB ã®ã‚µã‚¤ã‚ºã«ãªã‚Šã¾ã™ï¼‰ã€‚34B LLM ã‚’ 20GB ã«å‰Šæ¸›ã™ã‚‹ã¨ã€32GB VRAM ã«åŽã¾ã‚Šã¾ã™ï¼ã‚„ã£ãŸï¼

# vLLM ã‚’ä½¿ç”¨ã—ã¦æŽ¨è«–ã™ã‚‹
ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ 25,000 ä»¶ã®ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ã€é«˜é€Ÿã«æŽ¨è«–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã”ã¨ã«å¹³å‡ 1.3 ç§’ã§æŽ¨è«–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª vLLM [ã“ã¡ã‚‰](https://docs.vllm.ai/en/latest/) ã¯ã€Hugging Face ã‚„ç´”ç²‹ãª PyTorch ã‚³ãƒ¼ãƒ‰ã‚ˆã‚Šã‚‚é«˜é€Ÿã§ã™ï¼ã‚µãƒ³ãƒ—ãƒ«ã”ã¨ã« 1 ç§’ä»¥ä¸‹ã§ç°¡å˜ã«æŽ¨è«–ã§ãã¾ã™ï¼

# ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯
[ã“ã¡ã‚‰](https://www.kaggle.com/code/cdeotte/infer-34b-with-vllm) ã«ã€Kaggle ã® LMSYS ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ 34B LLM ã‚’æŽ¨è«–ã—ã¦ã€9 æ™‚é–“ä»¥å†…ã« 25,000 ä»¶ã®ãƒ†ã‚¹ãƒˆäºˆæ¸¬ã‚’å®Œäº†ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã™ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼ç§ã®ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€ã„ãã¤ã‹ã®ãƒˆãƒªãƒƒã‚¯ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

- Kaggle ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã« vLLM ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•
- ãƒ¢ãƒ‡ãƒ«ãŒ "A"ã€"B"ã€"tie" ã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã€logits ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•
- ã“ã‚Œã‚‰ã® 3 ã¤ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ç¢ºçŽ‡ã‚’æŠ½å‡ºã™ã‚‹æ–¹æ³•
- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®é•·ã•ã€å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®é•·ã•ã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•
- LLM ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ–¹æ³•

# KDD Cup 2024
ä»Šå¹´ã¯ã€KDD Cup 2024 ã§ 5 äººã® NVIDIA åŒåƒš [@aerdem4](https://www.kaggle.com/aerdem4) [@titericz](https://www.kaggle.com/titericz) [@sorokin](https://www.kaggle.com/sorokin) [@simjeg](https://www.kaggle.com/simjeg) [@benediktschifferer](https://www.kaggle.com/benediktschifferer) ã¨ãƒãƒ¼ãƒ ã‚’çµ„ã‚€æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚èª²é¡Œã¯ã€4xT4 ã‚’ä½¿ç”¨ã—ã¦æŽ¨è«–ã‚’è¡Œã„ã€2 æ™‚é–“ä»¥å†…ã« 11,000 ä»¶ã®é›»å­å•†å–å¼•ã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã‚‹ LLM ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã—ãŸã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ [ã“ã¡ã‚‰](https://www.aicrowd.com/challenges/amazon-kdd-cup-2024-multi-task-online-shopping-challenge-for-llms)ã€‚NVIDIA Kaggle ã‚°ãƒ©ãƒ³ãƒ‰ãƒžã‚¹ã‚¿ãƒ¼ï¼ˆKGMON [ã“ã¡ã‚‰](https://www.nvidia.com/en-us/ai-data-science/kaggle-grandmasters/)ï¼‰ã®åŒåƒšã‹ã‚‰å¤šãã®ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ç§ãŸã¡ã®å…±åŒã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒã€KDD Cup 2024 ã® 5 ã¤ã®ãƒˆãƒ©ãƒƒã‚¯ã™ã¹ã¦ã§ 1 ä½ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ã™ã”ã„ï¼ï¼ˆLB [ã“ã¡ã‚‰](https://www.aicrowd.com/challenges/amazon-kdd-cup-2024-multi-task-online-shopping-challenge-for-llms/leaderboards))

# ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
ç§ãŸã¡ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€æ¬¡ã® 3 ã¤ã®ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã—ãŸã€‚

- å¤šãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹
- QLoRA ã‚’ä½¿ç”¨ã—ã¦å¯èƒ½ãªé™ã‚Šæœ€å¤§ã®ãƒ¢ãƒ‡ãƒ«ã‚’å¾®èª¿æ•´ã™ã‚‹
- æ™‚é–“åˆ¶é™å†…ã§ã€é™ã‚‰ã‚ŒãŸãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§å¯èƒ½ãªé™ã‚Šé«˜é€Ÿã«æŽ¨è«–ã™ã‚‹

8 æœˆä¸‹æ—¬ã«ã¯ã€ã‚¹ãƒšã‚¤ãƒ³ã®ãƒãƒ«ã‚»ãƒ­ãƒŠã§é–‹å‚¬ã•ã‚Œã‚‹ KDD Cup 2024 ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã€KDD Cup ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ©ã‚¤ãƒ–ã§ç™ºè¡¨ã—ã€è«–æ–‡ã‚’å…¬é–‹ã—ã¾ã™ã€‚è©³ç´°ã‚’ãŠæ¥½ã—ã¿ã«ï¼

---
 # ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ
> ## Anish Vijay
> 
> ç´ æ™´ã‚‰ã—ã„ï¼
> 
> 
> 
---
> ## hwz13
> 
> ã¨ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ï¼very clear
> 
> 
> 
---
> ## kaggk
> 
> ç´ æ™´ã‚‰ã—ã„ï¼Brilliantï¼
> 
> 
> 
---
> ## Timmy Juicehouse
> 
> Chrisã€ã“ã“ã«æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ãã—ã¦ã€ã‚ãªãŸã® Nvidia ãƒãƒ¼ãƒ ã«ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ç§ãŸã¡ã®ãƒãƒ¼ãƒ ã‚‚ä¸Šä½ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ã—ã¾ã—ãŸãŒã€ã‚ãªãŸãŸã¡ã¯ç§ãŸã¡ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«å¼·ã„ã§ã™ã€‚æ¥æœˆã¯çµå©šå¼ã®æº–å‚™ãŒã‚ã‚‹ã®ã§ã€ãƒãƒ«ã‚»ãƒ­ãƒŠã«ã¯è¡Œã‘ã¾ã›ã‚“ã€‚Kdd2024 ã§ã‚ãªãŸã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚
> 
> 
> 
---
> ## Metin Meki Abullrahman
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼N!ce Work ðŸ˜
> 
> 
> 
---
> ## Cindy Y
> 
> ç´ æ™´ã‚‰ã—ã„ï¼Very good! 
> 
> 
> 
---
> ## Kid Liu
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼Nice work!
> 
> 
> 
---
> ## Sanket Pramod Bhure
> 
> ã‚ã‚ã€ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼wow Great work!
> 
> 
> 
---
> ## Liuyanfen166
> 
> ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼Nice work!
> 
> 
> 
---
> ## Rise_Hand
> 
> ã„ã¤ã‚‚ç´ æ™´ã‚‰ã—ã„ä»•äº‹ã§ã™ã­ï¼å°ã•ãªè³ªå•ãŒã‚ã‚Šã¾ã™ã€‚ç§ã®è¦‹è§£ã§ã¯ã€ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã¯ã€ãã®æ§‹é€ ã¨ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€ç•°ãªã‚‹ãƒˆãƒªãƒƒã‚¯ã‚’æŒã£ã¦ã„ã¾ã™ã€‚éŽåŽ»ã®çµŒé¨“ã‹ã‚‰ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã¤ã¾ã‚Šã€éŽåŽ»ã®çµŒé¨“ã«åŸºã¥ã„ã¦ã€æ–°ã—ã„ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ã‚³ã‚¹ãƒˆã¨æœ€é«˜ã®çµæžœã‚’ã©ã®ã‚ˆã†ã«ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> 
> 
---
> ## YingxiZhang
> 
> ã‚ã‚~~~ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼wow~~~nice work
> 
> 
> 
---
> ## Cody_Null
> 
> ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã®ã‚’è¦‹ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ã“ã®ã‚ˆã†ãªã‚‚ã®ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
> 
> ```
> %pip install -q -U ipywidgets
> %pip install -q -U transformers
> %pip install -q -U tokenizers
> %pip install -q -U bitsandbytes
> %pip install -q -U torch
> 
> import pandas as pd
> from tqdm import tqdm
> import torch
> from huggingface_hub import login
> from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig
> import random
> 
> # åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©ã™ã‚‹
> base_prompts = [
>     "è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å˜ä¸€ã®å¿œç­”ã‚’ç”Ÿæˆã—ã€è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã‚’ 1 ã‹ã‚‰ 10 ã®ã‚¹ã‚³ã‚¢ã§ç¤ºã—ã¾ã™ã€‚ä¾‹: 'ä»Šæ—¥ã¯ä½•ã‹ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ' - 10, 'ã‚ãªãŸã®åå‰ã¯ï¼Ÿ' - 10, 'ãã‚Œã«ã¤ã„ã¦ã‚‚ã£ã¨æ•™ãˆã¦ãã ã•ã„ã€‚' - 9. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: 'å¿œç­”' - ã‚¹ã‚³ã‚¢ã€‚",
>     "è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å˜ä¸€ã®å¿œç­”ã‚’ç”Ÿæˆã—ã€è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã‚’ 1 ã‹ã‚‰ 10 ã®ã‚¹ã‚³ã‚¢ã§ç¤ºã—ã¾ã™ã€‚ä¾‹: 'ã“ã‚“ã«ã¡ã¯ï¼' - 6, 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚' - 7. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: 'å¿œç­”' - ã‚¹ã‚³ã‚¢ã€‚",
>     "è¿”ä¿¡ã«å€¤ã—ãªã„å¯èƒ½æ€§ã®ã‚ã‚‹å˜ä¸€ã®å¿œç­”ã‚’ç”Ÿæˆã—ã€è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã‚’ 1 ã‹ã‚‰ 10 ã®ã‚¹ã‚³ã‚¢ã§ç¤ºã—ã¾ã™ã€‚ä¾‹: 'ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚' - 5, 'ãŸã¶ã‚“ã‚ãªãŸã¯æ­£ã—ã„ã§ã™ã€‚èª¿ã¹ã¦ã¿ã¾ã™ã€‚' - 4. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: 'å¿œç­”' - ã‚¹ã‚³ã‚¢ã€‚",
>     "è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ãŒä½Žã„å˜ä¸€ã®å¿œç­”ã‚’ç”Ÿæˆã—ã€è¿”ä¿¡ã«å€¤ã™ã‚‹å¯èƒ½æ€§ã‚’ 1 ã‹ã‚‰ 10 ã®ã‚¹ã‚³ã‚¢ã§ç¤ºã—ã¾ã™ã€‚ä¾‹: 'ã¯ã„ã€‚' - 3, 'ã„ã„ãˆã€‚' - 2, 'ã†ãƒ¼ã‚“' - 1. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: 'å¿œç­”' - ã‚¹ã‚³ã‚¢ã€‚"
> ]
> num_convos = 10000
> batch_size = 128  # GPU ãƒ¡ãƒ¢ãƒªã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹
> max_length = 512  # å¿…è¦ãªå¿œç­”ã®é•·ã•ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹
> 
> # ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®è¨­å®š
> model_name = "google/gemma-2-9b"   #"mistralai/Mistral-7B-Instruct-v0.3"  #"meta-llama/Meta-Llama-3-8B-Instruct"
> bnb_config = BitsAndBytesConfig(
>     load_in_4bit=True,
>     bnb_4bit_compute_dtype=torch.float16
> )
> 
> # Hugging Face ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
> login(token="hf_JB")
> 
> # ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
> model = AutoModelForCausalLM.from_pretrained(
>     model_name,
>     quantization_config=bnb_config,
>     device_map="auto",
>     token="hf_JB"
> )
> tokenizer = AutoTokenizer.from_pretrained(model_name, token="hf_JB")
> 
> # pad_token ã‚’ eos_token ã«è¨­å®šã™ã‚‹
> tokenizer.pad_token = tokenizer.eos_token
> 
> # ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®šã—ã€GPU ã®å¯ç”¨æ€§ã‚’ç¢ºèªã™ã‚‹
> torch.backends.cuda.enable_mem_efficient_sdp(False)
> torch.backends.cuda.enable_flash_sdp(False)
> if not torch.cuda.is_available():
>     raise EnvironmentError("ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ - GPU ãŒå¿…è¦ã§ã™ï¼")
> DEVICE = torch.device("cuda")
> 
> # ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚’æŒ‡å®šã™ã‚‹
> def extract_data(outputs, base_prompt):
>     convos = []
>     labels = []
>     for output in outputs:
>         response = tokenizer.decode(output, skip_special_tokens=True).strip()
> 
>         # å¿œç­”ã‹ã‚‰åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã™ã‚‹
>         if response.startswith(base_prompt):
>             response = response[len(base_prompt):].strip()
> 
>         # å¿œç­”ã¨ã‚¹ã‚³ã‚¢ã‚’æŠ½å‡ºã™ã‚‹
>         if " - " not in response:
>             print('å‡ºåŠ›ã« - ãŒã‚ã‚Šã¾ã›ã‚“')
>             continue
> 
>         try:
>             response_text = response.split(' - ')[0].strip().strip('"')
>             score = int(response.split(' - ')[1][:2].strip())
> 
>             # ã‚¹ã‚³ã‚¢ãŒæœŸå¾…ã•ã‚Œã‚‹ç¯„å›²å†…ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
>             if score < 1 or score > 10:
>                 print('ç„¡åŠ¹ãªã‚¹ã‚³ã‚¢')
>                 continue
> 
>         except (IndexError, ValueError):
>             print('å£Šã‚ŒãŸå‡ºåŠ›')
>             continue
> 
>         convos.append(response_text)
>         labels.append(score)
> 
>     return convos, labels
> 
> # ãƒãƒƒãƒã§ä¼šè©±å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹
> convos_df_lst = []
> labels_df_lst = []
> 
> for i in tqdm(range(0, num_convos, batch_size)):
>     # å¤šæ§˜ãªå¿œç­”ã‚’ä¿ƒã™ãŸã‚ã«ã€åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠžã™ã‚‹
>     base_prompt = random.choice(base_prompts)
>     batch_prompts = [base_prompt] * batch_size
>     encoding = tokenizer(batch_prompts, return_tensors="pt", padding=True, truncation=True, max_length=max_length)
>     input_ids = encoding["input_ids"].to(DEVICE)
>     attention_mask = encoding["attention_mask"].to(DEVICE)
> 
>     outputs = model.generate(input_ids, attention_mask=attention_mask, max_length=max_length, pad_token_id=tokenizer.eos_token_id, do_sample=True, temperature=0.7)
>     convos_batch, labels_batch = extract_data(outputs, base_prompt)
> 
>     convos_df_lst.extend(convos_batch)
>     labels_df_lst.extend(labels_batch)
> 
> # é‡è¤‡ã™ã‚‹å¿œç­”ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹
> unique_responses = list(set(zip(convos_df_lst, labels_df_lst)))
> convos_df_lst, labels_df_lst = zip(*unique_responses) if unique_responses else ([], [])
> 
> # CSV ã«ä¿å­˜ã™ã‚‹
> df = pd.DataFrame({'convo': convos_df_lst, 'label': labels_df_lst})
> df['label'] = df['label'] >= 7
> display(df)
> output_path = "/mnt/batch/tasks/shared/LS_root/mounts/clusters/cn1/code/Users/CN/Output/dataset.csv"
> df.to_csv(output_path, index=False)
> 
> print(f"ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã€{output_path} ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚")
> 
> ```
> 
> 
> 
---
> ## Waqar Ali
> 
> ãƒãƒ«ã‚»ãƒ­ãƒŠã§ã®ç™ºè¡¨ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼OAG ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§å…¨ãƒˆãƒ©ãƒƒã‚¯å„ªå‹ã§ããŸã“ã¨ã‚’å…±æœ‰ã§ãã¦å¬‰ã—ã„ã§ã™ã€‚ã‚ãªãŸã®æå‡ºã¯ã‚ãšã‹ã§ã—ãŸãŒã€ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã®ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚¯ã®æˆç¸¾ã¯æœ¬å½“ã«å°è±¡çš„ã§ã™ã€‚ã‚ãªãŸã®åŠŸç¸¾ã«æ•¬æ„ã‚’è¡¨ã—ã¾ã™ã€‚ðŸŽ
> 
> 
> 
---
> ## WoNiu666
> 
> ã‚ã‚~~~ç´ æ™´ã‚‰ã—ã„ä»•äº‹ï¼wow~~~great work
> 
> 
> 
---
> ## Yixiao Yuan
> 
> å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æŽ¨è«–ã«ãŠã‘ã‚‹é‡å­åŒ–ã«ã¤ã„ã¦è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚æŽ¨è«–ã« int4 ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã« LoRA ã§ã¯ãªã QLoRA ã‚’ä½¿ç”¨ã—ãŸæ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æŽ¨è«–ã®æ¡ä»¶ãŒã‚ˆã‚Šè‰¯ãä¸€è‡´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€QLoRA ã¯ LoRA ã»ã©æ€§èƒ½ãŒè‰¯ããªã„ã®ã§ã¯ãªã„ã‹ã¨æ‡¸å¿µã—ã¦ã„ã¾ã™ã€‚ã“ã“ã§ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¯ä½•ã§ã™ã‹ï¼Ÿ
> 
> 
> 
---
> ## sayoulala
> 
> ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒãƒ«ã‚»ãƒ­ãƒŠã§ã®ç™ºè¡¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚ç§ãŸã¡ã¯ã€åˆ¥ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆOAG-challengeï¼‰ã§ã‚‚å…¨ãƒˆãƒ©ãƒƒã‚¯å„ªå‹ã—ã¾ã—ãŸã€‚
> 
> ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§éžå¸¸ã«å°‘ãªã„ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’æå‡ºã—ãŸã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚¯ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã®ã‚’è¦‹ã¦ã€ç§ã¯ã‚ãªãŸã‚’ã¨ã¦ã‚‚å°Šæ•¬ã—ã¦ã„ã¾ã™ã€‚
> 
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã‚ã‚ŠãŒã¨ã† [@sayoulala](https://www.kaggle.com/sayoulala) ã“ã“ã§ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã‚’åŽã‚ãŸã“ã¨ã«ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
> > 
> > ç§ã¯ 1 é€±é–“å‰ã«ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã€KDD Cup 2024 ã§å­¦ã‚“ã æ´žå¯Ÿã‚’è©¦ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¾ã§ã®ã¨ã“ã‚ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã†ã¾ãç§»è¡Œã—ã€ã“ã“ã§ã†ã¾ãã„ãã®ã«å½¹ç«‹ã£ã¦ã„ã¾ã™ï¼
> > 
> > 
> > 
> > > ## sayoulala
> > > 
> > > vllm ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ç²¾åº¦ã®ä½Žä¸‹ã«ã¤ãªãŒã‚Šã¾ã™ã‹ï¼Ÿ
> > > 
> > > 
> > > 
> > > ## sayoulala
> > > 
> > > ã¨ã“ã‚ã§ã€ç§ã®å‹äºº [@chizhu2018](https://www.kaggle.com/chizhu2018) ã¯ã‚ãªãŸã®ç†±å¿ƒãªãƒ•ã‚¡ãƒ³ã§ã™ã€‚ãƒãƒ«ã‚»ãƒ­ãƒŠã® KDD ã«è¡Œããªã‚‰ã€å½¼ã®ãŸã‚ã«ã‚ãªãŸã®ã‚µã‚¤ãƒ³ã‚’ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ
> > > 
> > > 
> > > 
> > ## yechenzhi1
> > 
> > lmsys ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ 9B ã‚ˆã‚Šã‚‚å¤§ãã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
> > 
> > 
> > 
> > > ## sayoulala
> > > 
> > > ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¾ã§ã¯å…¬é–‹ã—ã¾ã›ã‚“ã€‚
> > > 
> > > 
> > > 
> > > ## yechenzhi1
> > > 
> > > å…¨ãå•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼è‡ªåˆ†ã§å¤§ããªãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã—ã¦ã¿ã¾ã™ðŸ˜ 
> > > 
> > > 
> > > 
> > > ## Ilia Zaitsev
> > > 
> > > ã“ã‚Œã¾ã§ã®ã¨ã“ã‚ã€ãƒ¢ãƒ‡ãƒ«ãŒå¤§ãã‘ã‚Œã°å¤§ãã„ã»ã©ã€æå¤±ãŒä½Žããªã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™â€¦
> > > 
> > > 
> > > 
---
> ## HinePo
> 
> ã“ã“ã«æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€[@cdeotte](https://www.kaggle.com/cdeotte)ã€‚ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ãŸã‚‰ã€ã‚ãªãŸã‹ã‚‰å†ã³å¤šãã®ã“ã¨ã‚’å­¦ã¹ã‚‹ã¨æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚
> 
> vLLM ã¯ã€ç”Ÿæˆã§ã¯ãªãã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ†é¡žã«ä½¿ç”¨ã§ãã¾ã™ã‹ï¼Ÿ
> 
> å°‘ã—æ¤œç´¢ã—ã¾ã—ãŸãŒã€ä½•ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
> 
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > vLLM ã‚’ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ†é¡žã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã¨æ€ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ç§ã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¾ãŸã¯ Llama3-8B ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ [ã“ã¡ã‚‰](https://www.kaggle.com/code/shelterw/sft-llama-3-8b-inference) ã‚’ä½¿ç”¨ã—ã¦ vLLM ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
> > 
> > 
> > 
---
> ## Valentin Werner
> 
> ã“ã‚Œã¯ã€ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å‹åˆ©ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³æŠ•ç¨¿ã®ã‚ˆã†ã«æ„Ÿã˜ã¾ã™ã€‚2 é€±é–“æ—©ã™ãŽã¾ã›ã‚“ã‹ï¼ŸKDD Cup ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ãªãŸã‹ã‚‰ã€ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«åˆã‚ã›ã¦èª¿æ•´ã•ã‚ŒãŸã€ã“ã®ã‚ˆã†ãªæŠ•ç¨¿ãŒã‚‚ã† 1 ã¤æŠ•ç¨¿ã•ã‚Œã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ ðŸ˜‰
> 
> ç·¨é›†: ã¾ãŸã€34B ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> 
> 
> 
> > ## yechenzhi1
> > 
> > 
> > 34B ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> > 
> > ãã†ã ã¨æ€ã„ã¾ã™ðŸ˜‚ ãŸã ã€ä¸Šä½ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒç¾åœ¨ã€ã‚ˆã‚Šå¤§ããªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚
> > 
> > 
> > 
> > > ## hn
> > > 
> > > ä¸€éƒ¨ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãã†ã ã¨æ€ã„ã¾ã™â€¦ç§ã®ç¾åœ¨ã® LB ã‚¹ã‚³ã‚¢ã¯ã€å®Ÿéš›ã«ã¯ã“ã‚Œã¾ã§å°ã•ãª LM ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
> > > 
> > > 
> > > 
---
> ## Rishan Hasan Tenis
> 
> ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼[@cdeotte](https://www.kaggle.com/cdeotte) 
> 
> 
> 
---
> ## S J Moudry
> 
> AWQ ã¯ qlora ã¨ä¸€ç·’ã«ä½¿ç”¨ã§ãã¾ã™ã‹ï¼Ÿç§ãŒè¦‹ãŸã¨ã“ã‚ã€SequenceClassification ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã¯ã€AutoAWQ/PEFT ã§ã¯ã¾ã ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å®Œå…¨ãªå¾®èª¿æ•´ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ AWQ ã«å¤‰æ›ã—ã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ç§ãŸã¡ã¯ã€ã‚ã‚‰ã‚†ã‚‹ç¨®é¡žã® 4bit é‡å­åŒ–ã§ QLoRA ã‚’å¾®èª¿æ•´ã—ã¾ã™ã€‚å¾®èª¿æ•´å¾Œã€LoRA ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ãƒžãƒ¼ã‚¸ã—ã€AWQ ã§é‡å­åŒ–ã—ã¾ã™ï¼ˆæŽ¨è«–ã®æº–å‚™ï¼‰ã€‚
> > 
> > 
> > 
---
> ## dexterxin
> 
> KDD Cupã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
> 

> é™ã‚‰ã‚ŒãŸãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã§æ™‚é–“åˆ¶é™å†…ã«ã€9B ä»¥ä¸Šã®äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’å¾®èª¿æ•´ã—ã¦æŽ¨è«–ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚ååˆ†ãªã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚½ãƒ¼ã‚¹ãŒãªã„å‚åŠ è€…ã«ã¨ã£ã¦ã¯æœ—å ±ã§ã™ã€‚
> 
> ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ä»Šå¾Œã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚‚æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ï¼
> 
> 
> 
---
> ## Ched Martin
> 
> ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
> 
> 
> 
---
> ## superferg
> 
> gemma2 27B ã‚’è©¦ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
> 
> 
> 
> > ## Yichuan Gao
> > 
> > æ®‹å¿µãªãŒã‚‰ã€AutoAWQ ã¯ã¾ã  Gemma-2 ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ç§ã‚‚ gemma-2 27b ã‚’è©¦ã—ãŸã‹ã£ãŸã®ã§ã™ãŒ :(
> > 
> > 
> > 
---
> ## yechenzhi1
> 
> ã™ã”ã„ã§ã™ã­ï¼ã“ã®ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯ã€9b ãŒä½¿ç”¨ã§ãã‚‹æœ€å¤§ã®ãƒ¢ãƒ‡ãƒ«ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚
> 
> 
> 
> > ## Chris Deotteãƒˆãƒ”ãƒƒã‚¯ä½œæˆè€…
> > 
> > ã„ã„ãˆã€‚Kaggle ã® 2xT4 GPU ã§ 34B ã‚’é«˜é€Ÿã«æŽ¨è«–ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦å¬‰ã—ã„ã§ã™ã€‚ãã®ãŸã‚ã€ã™ã¹ã¦ã® Kaggle ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ 34B ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚[ã“ã¡ã‚‰](https://www.kaggle.com/competitions/kaggle-llm-science-exam/discussion/440620) ã§ã‚‚ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Kaggle ã§ 70B ã‚’ä½¿ç”¨ã§ãã¾ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã«ã‚ˆã‚Šã€vLLM ã¨ 34B ã‚’ä½¿ç”¨ã—ãŸå ´åˆã‚ˆã‚Šã‚‚é…ããªã‚Šã¾ã™ã€‚ï¼ˆãã—ã¦ã€ãã®ãƒŽãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ã€Kaggle ã® LMSYS ã‚³ãƒ³ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ã¯é…ã™ãŽã¾ã™ï¼‰ã€‚
> > 
> > 
> > 
---
> ## Harshit Sharma
> 
> å°è±¡çš„ãªå‹åˆ©ã¨ã€ã“ã‚Œã‚‰ã®è²´é‡ãªæ´žå¯Ÿã‚’å…±æœ‰ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€[@cdeotte](https://www.kaggle.com/cdeotte)ï¼ã‚ãªãŸã®é©æ–°çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ãƒªã‚½ãƒ¼ã‚¹ã®åŠ¹çŽ‡çš„ãªä½¿ç”¨ã¯ã€æœ¬å½“ã«åˆºæ¿€çš„ã§ã™ã€‚ãƒãƒ«ã‚»ãƒ­ãƒŠã§ã® KDD Cup ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹ã®ãŒå¾…ã¡ãã‚Œã¾ã›ã‚“ï¼ðŸŒŸðŸš€
> 
> 
> 
---


